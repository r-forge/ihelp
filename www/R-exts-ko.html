<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html401/loose.dtd">
<html>
<!-- Created on November 24, 2013 by texi2html 1.82
texi2html was written by: 
            Lionel Cons <Lionel.Cons@cern.ch> (original author)
            Karl Berry  <karl@freefriends.org>
            Olaf Bachmann <obachman@mathematik.uni-kl.de>
            and many others.
Maintained by: Many creative people.
Send bugs and suggestions to <texi2html-bug@nongnu.org>
-->
<head>
<title>Writing R Extensions in Korean (ver.0.001 ì´ê¸°ìí ìë£)</title>

<meta name="description" content="Writing R Extensions in Korean (ver.0.001 ì´ê¸°ìí ìë£)">
<meta name="keywords" content="Writing R Extensions in Korean (ver.0.001 ì´ê¸°ìí ìë£)">
<meta name="resource-type" content="document">
<meta name="distribution" content="global">
<meta name="Generator" content="texi2html 1.82">
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
<!--
a.summary-letter {text-decoration: none}
blockquote.smallquotation {font-size: smaller}
pre.display {font-family: serif}
pre.format {font-family: serif}
pre.menu-comment {font-family: serif}
pre.menu-preformatted {font-family: serif}
pre.smalldisplay {font-family: serif; font-size: smaller}
pre.smallexample {font-size: smaller}
pre.smallformat {font-family: serif; font-size: smaller}
pre.smalllisp {font-size: smaller}
span.roman {font-family:serif; font-weight:normal;}
span.sansserif {font-family:sans-serif; font-weight:normal;}
ul.toc {list-style: none}
-->
</style>


</head>

<body lang="en" bgcolor="#FFFFFF" text="#000000" link="#0000FF" vlink="#800080" alink="#FF0000">

<a name="Top"></a>
<table cellpadding="1" cellspacing="1" border="0">
<tr><td valign="middle" align="left">[<a href="#Top" title="Cover (top) of document">Top</a>]</td>
<td valign="middle" align="left">[<a href="#SEC_Contents" title="Table of contents">Contents</a>]</td>
<td valign="middle" align="left">[<a href="#Function-and-variable-index" title="Index">Index</a>]</td>
<td valign="middle" align="left">[<a href="#SEC_About" title="About (help)"> ? </a>]</td>
</tr></table>
<a name="Writing-R-Extensions"></a>
<h1 class="settitle">Writing R Extensions</h1>

<p>This is a guide to extending R, describing the process of creating
R add-on packages, writing R documentation, R&rsquo;s system and
foreign language interfaces, and the R <acronym>API</acronym>.
</p>
<p>The current version of this document is 3.0.2 (2013-09-25).
</p>
<p>ISBN 3-900051-11-9
</p>
<p>Copyright &copy; 1999&ndash;2012 R Core Team
</p>
<p>Permission is granted to make and distribute verbatim copies of this
manual provided the copyright notice and this permission notice are
preserved on all copies.
</p>
<p>Permission is granted to copy and distribute modified versions of this
manual under the conditions for verbatim copying, provided that the
entire resulting derived work is distributed under the terms of a
permission notice identical to this one.
</p>
<p>Permission is granted to copy and distribute translations of this manual
into another language, under the above conditions for modified versions,
except that this permission notice may be stated in a translation
approved by the R Core Team.
</p>
<p>본 한국어 문서는 <strong>R Development Translation Teams</strong> (<a href="http://developer.r-project.org/TranslationTeams.html">http://developer.r-project.org/TranslationTeams.html</a>) <strong>Korean</strong> 섹션에서 진행하는 프로젝트의 일환으로 제공되어집니다.  
본 문서의 역자는 아래와 같습니다.
</p><ul>
<li> Chel Hee Lee (이철희), University of Saskatchewan, Saskatoon, Saskatchewan, Canada, <a href="mailto:gnustats@gmail.com">gnustats@gmail.com</a>, 2009 &ndash; 2013, 
</li><li> Jae Seong Yoo, (유재성), Korea University, Seoul, Korea, <a href="mailto:praster1@gmail.com">praster1@gmail.com</a>, 2013.
</li></ul>



<table class="menu" border="0" cellspacing="0">
<tr><td align="left" valign="top"><a href="#Acknowledgements">Acknowledgements</a></td><td>&nbsp;&nbsp;</td><td align="left" valign="top">            
</td></tr>
<tr><td align="left" valign="top"><a href="#Creating-R-packages">1. Creating R packages</a></td><td>&nbsp;&nbsp;</td><td align="left" valign="top">         
</td></tr>
<tr><td align="left" valign="top"><a href="#Writing-R-documentation-files">2. Writing R documentation files</a></td><td>&nbsp;&nbsp;</td><td align="left" valign="top">  
</td></tr>
<tr><td align="left" valign="top"><a href="#Tidying-and-profiling-R-code">3. Tidying and profiling R code</a></td><td>&nbsp;&nbsp;</td><td align="left" valign="top">  
</td></tr>
<tr><td align="left" valign="top"><a href="#Debugging">4. Debugging</a></td><td>&nbsp;&nbsp;</td><td align="left" valign="top">                   
</td></tr>
<tr><td align="left" valign="top"><a href="#System-and-foreign-language-interfaces">5. System and foreign language interfaces</a></td><td>&nbsp;&nbsp;</td><td align="left" valign="top">  
</td></tr>
<tr><td align="left" valign="top"><a href="#The-R-API">6. The R <acronym>API</acronym>: entry points for C code</a></td><td>&nbsp;&nbsp;</td><td align="left" valign="top">                   
</td></tr>
<tr><td align="left" valign="top"><a href="#Generic-functions-and-methods">7. Generic functions and methods</a></td><td>&nbsp;&nbsp;</td><td align="left" valign="top">  
</td></tr>
<tr><td align="left" valign="top"><a href="#Linking-GUIs-and-other-front_002dends-to-R">8. Linking GUIs and other front-ends to R</a></td><td>&nbsp;&nbsp;</td><td align="left" valign="top">  
</td></tr>
<tr><td align="left" valign="top"><a href="#Function-and-variable-index">Function and variable index</a></td><td>&nbsp;&nbsp;</td><td align="left" valign="top">  
</td></tr>
<tr><td align="left" valign="top"><a href="#Concept-index">Concept index</a></td><td>&nbsp;&nbsp;</td><td align="left" valign="top">               
</td></tr>
</table>

<hr size="1">
<a name="Acknowledgements"></a>
<table cellpadding="1" cellspacing="1" border="0">
<tr><td valign="middle" align="left">[<a href="#Top" title="Previous section in reading order"> &lt; </a>]</td>
<td valign="middle" align="left">[<a href="#Creating-R-packages" title="Next section in reading order"> &gt; </a>]</td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left">[<a href="#Top" title="Beginning of this chapter or previous chapter"> &lt;&lt; </a>]</td>
<td valign="middle" align="left">[<a href="#Top" title="Up section"> Up </a>]</td>
<td valign="middle" align="left">[<a href="#Creating-R-packages" title="Next chapter"> &gt;&gt; </a>]</td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left">[<a href="#Top" title="Cover (top) of document">Top</a>]</td>
<td valign="middle" align="left">[<a href="#SEC_Contents" title="Table of contents">Contents</a>]</td>
<td valign="middle" align="left">[<a href="#Function-and-variable-index" title="Index">Index</a>]</td>
<td valign="middle" align="left">[<a href="#SEC_About" title="About (help)"> ? </a>]</td>
</tr></table>
<a name="Acknowledgements-1"></a>
<h1 class="unnumbered">Acknowledgements</h1>


<p>The contributions of Saikat DebRoy (who wrote the first draft of a guide
to using <code>.Call</code> and <code>.External</code>) and of Adrian Trapletti (who
provided information on the C++ interface) are gratefully acknowledged.
</p>
<hr size="6">
<a name="Creating-R-packages"></a>
<table cellpadding="1" cellspacing="1" border="0">
<tr><td valign="middle" align="left">[<a href="#Acknowledgements" title="Previous section in reading order"> &lt; </a>]</td>
<td valign="middle" align="left">[<a href="#Package-structure" title="Next section in reading order"> &gt; </a>]</td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left">[<a href="#Acknowledgements" title="Beginning of this chapter or previous chapter"> &lt;&lt; </a>]</td>
<td valign="middle" align="left">[<a href="#Top" title="Up section"> Up </a>]</td>
<td valign="middle" align="left">[<a href="#Writing-R-documentation-files" title="Next chapter"> &gt;&gt; </a>]</td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left">[<a href="#Top" title="Cover (top) of document">Top</a>]</td>
<td valign="middle" align="left">[<a href="#SEC_Contents" title="Table of contents">Contents</a>]</td>
<td valign="middle" align="left">[<a href="#Function-and-variable-index" title="Index">Index</a>]</td>
<td valign="middle" align="left">[<a href="#SEC_About" title="About (help)"> ? </a>]</td>
</tr></table>
<a name="Creating-R-packages-1"></a>
<h1 class="chapter">1. Creating R packages</h1>
<a name="index-Packages"></a>
<a name="index-Creating-packages"></a>

<p>Packages provide a mechanism for loading optional code, data and
documentation as needed.  The R distribution itself includes about 30
packages.
</p>
<p>In the following, we assume that you know the <code>library()</code> command,
including its <code>lib.loc</code> argument, and we also assume basic
knowledge of the <code>R CMD INSTALL</code> utility.  Otherwise, please
look at R&rsquo;s help pages on
</p>
<table><tr><td>&nbsp;</td><td><pre class="example">?library
?INSTALL
</pre></td></tr></table>

<p>before reading on.
</p>
<p>For packages which contain code to be compiled, a computing environment
including a number of tools is assumed; the &ldquo;R Installation and
Administration&rdquo; manual describes what is needed.  Under a Unix-alike
most of the tools are likely to be present by default, but Mac OS X and
Microsoft Windows will require additional setup.
</p>
<p>Once a source package is created, it must be installed by
the command <code>R CMD INSTALL</code>.
</p>
<p>Other types of extensions are supported (but rare): See section <a href="#Package-types">Package types</a>.
</p>
<p>Some notes on terminology complete this introduction.  These will help
with the reading of this manual, and also in describing concepts
accurately when asking for help.
</p>
<p>A <em>package</em> is a directory of files which extend R, either a
<em>source package</em> (the master files of a package), or a tarball
containing the files of a source package, or an <em>installed</em>
package, the result of running <code>R CMD INSTALL</code> on a source
package.  On some platforms (notably OS X and Windows) there are also
<em>binary packages</em>, a zip file or tarball containing the files of an
installed package which can be unpacked rather than installing from
sources.
</p>
<p>A package is <strong>not</strong><a name="DOCF1" href="#FOOT1">(1)</a> a
<em>library</em>.  The latter is used in two senses in R documentation.
The first is a directory into which packages are installed, e.g.
&lsquo;<tt>/usr/lib/R/library</tt>&rsquo;: in that sense it is sometimes referred to as
a <em>library directory</em> or <em>library tree</em> (since the library is
a directory which contains packages as directories, which themselves
contain directories).  The second sense is that used by the operating
system, as a shared library or static library or (especially on Windows)
a DLL, where the second L stands for &lsquo;library&rsquo;.  Installed packages may
contain compiled code in what is known on most Unix-alikes as a
<em>shared object</em> and on Windows as a DLL (and used to be called a
<em>shared library</em> on some Unix-alikes).  The concept of a
<em>shared library</em> (<em>dynamic library</em> on Mac OS X) as a
collection of compiled code to which a package might link is also used,
especially for R itself on some platforms.
</p>
<p>There are a number of well-defined operations on source packages.  The
most common is <em>installation</em> which takes a source package and
installs it in a library using <code>R CMD INSTALL</code> or
<code>install.packages</code>.  Source packages can be <em>built</em>, a
distinct concept.  This involves taking a source directory and creating
a tarball ready for distribution, including cleaning it up and creating
PDF documentation from any <em>vignettes</em> it may contain.  Source
packages (and most often tarballs) can be <em>checked</em>, when a test
installation is done and tested (including running its examples); also,
the contents of the package are tested in various ways for consistency
and portability.
</p>
<p><em>Compilation</em> is not a correct term for a package.  Installing a
source package which contains C, C++ or Fortran code will involve
compiling that code.  There is also the possibility of (&lsquo;byte&rsquo;)
compiling the R code in a package (using the facilities of package
<strong>compiler</strong>): already the base and recommended packages are
byte-compiled.  At some future time this might be done routinely, so
<em>compiling</em> a package may come to mean compiling its R code.
</p>
<p>It used to be unambiguous to talk about <em>loading</em> an installed
package using <code>library()</code>, but since the advent of package
namespaces this has been less clear: people now often talk about
<em>loading</em> the package&rsquo;s namespace and then <em>attaching</em> the
package so it becomes visible on the search path.  Function
<code>library</code> performs both steps, but a package&rsquo;s namespace can be
loaded without the package being attached (for example by calls like
<code>splines::ns</code>).
</p>
<p>The option of <em>lazy loading</em> of code or data is mentioned at
several points.  This is part of the installation, always selected for
R code but optional for data.  When used
the R objects of the package are created at installation time, and
stored in a database in the &lsquo;<tt>R</tt>&rsquo; directory of the installed package,
being loaded into the session at first use.  This makes the R session
run faster and use less (virtual) memory.
</p>

<table class="menu" border="0" cellspacing="0">
<tr><td align="left" valign="top"><a href="#Package-structure">1.1 Package structure</a></td><td>&nbsp;&nbsp;</td><td align="left" valign="top">           
</td></tr>
<tr><td align="left" valign="top"><a href="#Configure-and-cleanup">1.2 Configure and cleanup</a></td><td>&nbsp;&nbsp;</td><td align="left" valign="top">       
</td></tr>
<tr><td align="left" valign="top"><a href="#Checking-and-building-packages">1.3 Checking and building packages</a></td><td>&nbsp;&nbsp;</td><td align="left" valign="top">  
</td></tr>
<tr><td align="left" valign="top"><a href="#Writing-package-vignettes">1.4 Writing package vignettes</a></td><td>&nbsp;&nbsp;</td><td align="left" valign="top">   
</td></tr>
<tr><td align="left" valign="top"><a href="#Submitting-a-package-to-CRAN">1.5 Submitting a package to <acronym>CRAN</acronym></a></td><td>&nbsp;&nbsp;</td><td align="left" valign="top">  
</td></tr>
<tr><td align="left" valign="top"><a href="#Package-namespaces">1.6 Package namespaces</a></td><td>&nbsp;&nbsp;</td><td align="left" valign="top">          
</td></tr>
<tr><td align="left" valign="top"><a href="#Writing-portable-packages">1.7 Writing portable packages</a></td><td>&nbsp;&nbsp;</td><td align="left" valign="top">   
</td></tr>
<tr><td align="left" valign="top"><a href="#Diagnostic-messages">1.8 Diagnostic messages</a></td><td>&nbsp;&nbsp;</td><td align="left" valign="top">         
</td></tr>
<tr><td align="left" valign="top"><a href="#Internationalization">1.9 Internationalization</a></td><td>&nbsp;&nbsp;</td><td align="left" valign="top">        
</td></tr>
<tr><td align="left" valign="top"><a href="#CITATION-files">1.10 CITATION files</a></td><td>&nbsp;&nbsp;</td><td align="left" valign="top">              
</td></tr>
<tr><td align="left" valign="top"><a href="#Package-types">1.11 Package types</a></td><td>&nbsp;&nbsp;</td><td align="left" valign="top">               
</td></tr>
<tr><td align="left" valign="top"><a href="#Services">1.12 Services</a></td><td>&nbsp;&nbsp;</td><td align="left" valign="top">                    
</td></tr>
</table>

<hr size="6">
<a name="Package-structure"></a>
<table cellpadding="1" cellspacing="1" border="0">
<tr><td valign="middle" align="left">[<a href="#Creating-R-packages" title="Previous section in reading order"> &lt; </a>]</td>
<td valign="middle" align="left">[<a href="#The-DESCRIPTION-file" title="Next section in reading order"> &gt; </a>]</td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left">[<a href="#Creating-R-packages" title="Beginning of this chapter or previous chapter"> &lt;&lt; </a>]</td>
<td valign="middle" align="left">[<a href="#Creating-R-packages" title="Up section"> Up </a>]</td>
<td valign="middle" align="left">[<a href="#Writing-R-documentation-files" title="Next chapter"> &gt;&gt; </a>]</td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left">[<a href="#Top" title="Cover (top) of document">Top</a>]</td>
<td valign="middle" align="left">[<a href="#SEC_Contents" title="Table of contents">Contents</a>]</td>
<td valign="middle" align="left">[<a href="#Function-and-variable-index" title="Index">Index</a>]</td>
<td valign="middle" align="left">[<a href="#SEC_About" title="About (help)"> ? </a>]</td>
</tr></table>
<a name="Package-structure-1"></a>
<h2 class="section">1.1 Package structure</h2>
<a name="index-Package-structure"></a>

<p>The sources of an R package consists of a subdirectory containing a
file &lsquo;<tt>DESCRIPTION</tt>&rsquo; and the subdirectories &lsquo;<tt>R</tt>&rsquo;, &lsquo;<tt>data</tt>&rsquo;,
&lsquo;<tt>demo</tt>&rsquo;, &lsquo;<tt>exec</tt>&rsquo;, &lsquo;<tt>inst</tt>&rsquo;, &lsquo;<tt>man</tt>&rsquo;, &lsquo;<tt>po</tt>&rsquo;,
&lsquo;<tt>src</tt>&rsquo;, and &lsquo;<tt>tests</tt>&rsquo; (some of which can be missing, but which
should not be empty).  The package subdirectory may also contain files
&lsquo;<tt>INDEX</tt>&rsquo;, &lsquo;<tt>NAMESPACE</tt>&rsquo;, &lsquo;<tt>configure</tt>&rsquo;, &lsquo;<tt>cleanup</tt>&rsquo;,
&lsquo;<tt>LICENSE</tt>&rsquo;, &lsquo;<tt>LICENCE</tt>&rsquo; and &lsquo;<tt>NEWS</tt>&rsquo;.  Other files such as
&lsquo;<tt>INSTALL</tt>&rsquo; (for non-standard installation instructions),
&lsquo;<tt>README</tt>&rsquo; or &lsquo;<tt>ChangeLog</tt>&rsquo; will be ignored by R, but may be
useful to end users.
</p>
<p>Except where specifically mentioned,<a name="DOCF2" href="#FOOT2">(2)</a> packages should not contain
Unix-style &lsquo;hidden&rsquo; files/directory (that is, those whose name starts
with a dot).
</p>
<p>The &lsquo;<tt>DESCRIPTION</tt>&rsquo; and &lsquo;<tt>INDEX</tt>&rsquo; files are described in the
subsections below.  The &lsquo;<tt>NAMESPACE</tt>&rsquo; file is described in the
section on <a href="#Package-namespaces">Package namespaces</a>.
</p>
<a name="index-configure-file"></a>
<a name="index-cleanup-file"></a>

<p>The optional files &lsquo;<tt>configure</tt>&rsquo; and &lsquo;<tt>cleanup</tt>&rsquo; are (Bourne
shell) script files which are, respectively, executed before and
(provided that option &lsquo;<samp>--clean</samp>&rsquo; was given) after installation on
Unix-alikes, see <a href="#Configure-and-cleanup">Configure and cleanup</a>.  The analogues on Windows
are &lsquo;<tt>configure.win</tt>&rsquo; and &lsquo;<tt>cleanup.win</tt>&rsquo;.
</p>
<a name="index-LICENSE-file"></a>
<a name="index-LICENCE-file"></a>

<p>The optional file &lsquo;<tt>LICENSE</tt>&rsquo;/&lsquo;<tt>LICENCE</tt>&rsquo; contains a copy of the
license to the package.  Whereas you should feel free to include a
license file in your <em>source</em> distribution, please do not arrange
to <em>install</em> yet another copy of the <acronym>GNU</acronym> &lsquo;<tt>COPYING</tt>&rsquo;
or &lsquo;<tt>COPYING.LIB</tt>&rsquo; files but refer to the copies on
<a href="http://www.r-project.org/Licenses/">http://www.r-project.org/Licenses/</a> and included in the R
distribution (in directory &lsquo;<tt>share/licenses</tt>&rsquo;).  Since files named
&lsquo;<tt>LICENSE</tt>&rsquo; or &lsquo;<tt>LICENCE</tt>&rsquo; <em>will</em> be installed, do not use
these names for standard licence files.
</p>
<p>For the conventions for files &lsquo;<tt>NEWS</tt>&rsquo; and &lsquo;<tt>ChangeLog</tt>&rsquo; in the
<acronym>GNU</acronym> project see
<a href="http://www.gnu.org/prep/standards/standards.html#Documentation">http://www.gnu.org/prep/standards/standards.html#Documentation</a>.
</p>
<p>The package subdirectory should be given the same name as the package.
Because some file systems (e.g., those on Windows and by default on Mac
OS X) are not case-sensitive, to maintain portability it is strongly
recommended that case distinctions not be used to distinguish different
packages.  For example, if you have a package named &lsquo;<tt>foo</tt>&rsquo;, do not
also create a package named &lsquo;<tt>Foo</tt>&rsquo;.
</p>
<p>To ensure that file names are valid across file systems and supported
operating systems, the <acronym>ASCII</acronym> control characters as
well as the characters &lsquo;<samp>&quot;</samp>&rsquo;, &lsquo;<samp>*</samp>&rsquo;, &lsquo;<samp>:</samp>&rsquo;, &lsquo;<samp>/</samp>&rsquo;, &lsquo;<samp>&lt;</samp>&rsquo;,
&lsquo;<samp>&gt;</samp>&rsquo;, &lsquo;<samp>?</samp>&rsquo;, &lsquo;<samp>\</samp>&rsquo;, and &lsquo;<samp>|</samp>&rsquo; are not allowed in file
names.  In addition, files with names &lsquo;<samp>con</samp>&rsquo;, &lsquo;<samp>prn</samp>&rsquo;,
&lsquo;<samp>aux</samp>&rsquo;, &lsquo;<samp>clock$</samp>&rsquo;, &lsquo;<samp>nul</samp>&rsquo;, &lsquo;<samp>com1</samp>&rsquo; to &lsquo;<samp>com9</samp>&rsquo;, and
&lsquo;<samp>lpt1</samp>&rsquo; to &lsquo;<samp>lpt9</samp>&rsquo; after conversion to lower case and stripping
possible &ldquo;extensions&rdquo; (e.g., &lsquo;<samp>lpt5.foo.bar</samp>&rsquo;), are disallowed.
Also, file names in the same directory must not differ only by case (see
the previous paragraph).  In addition, the basenames of &lsquo;<samp>.Rd</samp>&rsquo; files
may be used in URLs and so must be <acronym>ASCII</acronym> and not contain
<code>%</code>.  For maximal portability filenames should only contain only
<acronym>ASCII</acronym> characters not excluded already (that is
<code>A-Za-z0-9._!#$%&amp;+,;=@^(){}'[]</code> &mdash; we exclude space as many
utilities do not accept spaces in file paths): non-English alphabetic
characters cannot be guaranteed to be supported in all locales.  It
would be good practice to avoid the shell metacharacters
<code>(){}'[]$</code>.  In addition, packages are normally distributed as
tarballs, and these have a limit on path lengths (including the package
name): for maximal portability 100 bytes, and less portably up to 256
bytes with restrictions including a final component of no more than 100 bytes.
</p>
<p>A source package if possible should not contain binary executable files:
they are not portable, and a security risk if they are of the
appropriate architecture.  <code>R CMD check</code> will warn about
them<a name="DOCF3" href="#FOOT3">(3)</a> unless they are listed (one filepath per line) in a file
&lsquo;<tt>BinaryFiles</tt>&rsquo; at the top level of the package.  Note that
<acronym>CRAN</acronym> will not accept submissions containing binary files
even if they are listed.
</p>
<p>The R function <code>package.skeleton</code> can help to create the
structure for a new package: see its help page for details.
</p>
<table class="menu" border="0" cellspacing="0">
<tr><td align="left" valign="top"><a href="#The-DESCRIPTION-file">1.1.1 The &lsquo;<tt>DESCRIPTION</tt>&rsquo; file</a></td><td>&nbsp;&nbsp;</td><td align="left" valign="top">        
</td></tr>
<tr><td align="left" valign="top"><a href="#The-INDEX-file">1.1.2 The &lsquo;<tt>INDEX</tt>&rsquo; file</a></td><td>&nbsp;&nbsp;</td><td align="left" valign="top">              
</td></tr>
<tr><td align="left" valign="top"><a href="#Package-subdirectories">1.1.3 Package subdirectories</a></td><td>&nbsp;&nbsp;</td><td align="left" valign="top">      
</td></tr>
<tr><td align="left" valign="top"><a href="#Package-bundles">1.1.4 Package bundles</a></td><td>&nbsp;&nbsp;</td><td align="left" valign="top">             
</td></tr>
<tr><td align="left" valign="top"><a href="#Data-in-packages">1.1.5 Data in packages</a></td><td>&nbsp;&nbsp;</td><td align="left" valign="top">            
</td></tr>
<tr><td align="left" valign="top"><a href="#Non_002dR-scripts-in-packages">1.1.6 Non-R scripts in packages</a></td><td>&nbsp;&nbsp;</td><td align="left" valign="top">   
</td></tr>
</table>

<hr size="6">
<a name="The-DESCRIPTION-file"></a>
<table cellpadding="1" cellspacing="1" border="0">
<tr><td valign="middle" align="left">[<a href="#Package-structure" title="Previous section in reading order"> &lt; </a>]</td>
<td valign="middle" align="left">[<a href="#The-INDEX-file" title="Next section in reading order"> &gt; </a>]</td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left">[<a href="#Creating-R-packages" title="Beginning of this chapter or previous chapter"> &lt;&lt; </a>]</td>
<td valign="middle" align="left">[<a href="#Package-structure" title="Up section"> Up </a>]</td>
<td valign="middle" align="left">[<a href="#Writing-R-documentation-files" title="Next chapter"> &gt;&gt; </a>]</td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left">[<a href="#Top" title="Cover (top) of document">Top</a>]</td>
<td valign="middle" align="left">[<a href="#SEC_Contents" title="Table of contents">Contents</a>]</td>
<td valign="middle" align="left">[<a href="#Function-and-variable-index" title="Index">Index</a>]</td>
<td valign="middle" align="left">[<a href="#SEC_About" title="About (help)"> ? </a>]</td>
</tr></table>
<a name="The-DESCRIPTION-file-1"></a>
<h3 class="subsection">1.1.1 The &lsquo;<tt>DESCRIPTION</tt>&rsquo; file</h3>
<a name="index-DESCRIPTION-file"></a>

<p>The &lsquo;<tt>DESCRIPTION</tt>&rsquo; file contains basic information about the package
in the following format:
</p>
<blockquote><table class="cartouche" border="1"><tr><td>
<table><tr><td>&nbsp;</td><td><pre class="smallexample">Package: pkgname
Version: 0.5-1
Date: 2004-01-01
Title: My First Collection of Functions
Authors@R: c(person(&quot;Joe&quot;, &quot;Developer&quot;, role = c(&quot;aut&quot;, &quot;cre&quot;),
                     email = &quot;Joe.Developer@some.domain.net&quot;),
              person(&quot;Pat&quot;, &quot;Developer&quot;, role = &quot;aut&quot;),
              person(&quot;A.&quot;, &quot;User&quot;, role = &quot;ctb&quot;,
	             email = &quot;A.User@whereever.net&quot;))
Author: Joe Developer and Pat Developer, with contributions from A. User
Maintainer: Joe Developer &lt;Joe.Developer@some.domain.net&gt;
Depends: R (&gt;= 1.8.0), nlme
Suggests: MASS
Description: A short (one paragraph) description of what
  the package does and why it may be useful.
License: GPL (&gt;= 2)
URL: http://www.r-project.org, http://www.another.url
BugReports: http://pkgname.bugtracker.url
</pre></td></tr></table>
</td></tr></table>
</blockquote>

<p>The format is that of a &lsquo;Debian Control File&rsquo; (see the help for
&lsquo;<samp>read.dcf</samp>&rsquo; and
<a href="http://www.debian.org/doc/debian-policy/ch-controlfields.html">http://www.debian.org/doc/debian-policy/ch-controlfields.html</a>:
R does not require encoding in UTF-8 and does not support comments
starting with &lsquo;<samp>#</samp>&rsquo;).  Fields start with an ASCII name immediately
followed by a colon: the value starts after the colon and a space.
Continuation lines (for example, for descriptions longer than one line)
start with a space or tab.  Field names are case-sensitive: all those
used by R are capitalized.
</p>
<p>The &lsquo;<samp>Package</samp>&rsquo;, &lsquo;<samp>Version</samp>&rsquo;, &lsquo;<samp>License</samp>&rsquo;, &lsquo;<samp>Description</samp>&rsquo;,
&lsquo;<samp>Title</samp>&rsquo;, &lsquo;<samp>Author</samp>&rsquo;, and &lsquo;<samp>Maintainer</samp>&rsquo; fields are mandatory,
all other fields are optional.  Fields &lsquo;<samp>Author</samp>&rsquo; and
&lsquo;<samp>Maintainer</samp>&rsquo; can be auto-generated from &lsquo;<samp>Authors@R</samp>&rsquo;, and may
be omitted if the latter is provided (and the package depends on <code>R
(&gt;= 2.14)</code>: see below for details): however if they are not ASCII we
recommend that they are provided.
</p>
<p>For maximal portability, the &lsquo;<tt>DESCRIPTION</tt>&rsquo; file should be written
entirely in <acronym>ASCII</acronym> &mdash; if this is not possible it must contain
an &lsquo;<samp>Encoding</samp>&rsquo; field (see below).
</p>
<p>The mandatory &lsquo;<samp>Package</samp>&rsquo; field gives the name of the package.  This
should contain only (ASCII) letters, numbers and dot, have at least two
characters and start with a letter and not end in a dot.
</p>
<p>The mandatory &lsquo;<samp>Version</samp>&rsquo; field gives the version of the package.
This is a sequence of at least <em>two</em> (and usually three)
non-negative integers separated by single &lsquo;<samp>.</samp>&rsquo; or &lsquo;<samp>-</samp>&rsquo;
characters.  The canonical form is as shown in the example, and a
version such as &lsquo;<samp>0.01</samp>&rsquo; or &lsquo;<samp>0.01.0</samp>&rsquo; will be handled as if it
were &lsquo;<samp>0.1-0</samp>&rsquo;.  It is <strong>not</strong> a decimal number, so for example
<code>0.9 &lt; 0.75</code> since <code>9 &lt; 75</code>.
</p>
<p>The mandatory &lsquo;<samp>License</samp>&rsquo; field should specify the license of the
package in a standardized form.  Alternatives are indicated <em>via</em>
vertical bars.  Individual specifications must be one of
</p><ul>
<li>
One of the &ldquo;standard&rdquo; short specifications
<table><tr><td>&nbsp;</td><td><pre class="example">GPL-2 GPL-3 LGPL-2 LGPL-2.1 LGPL-3 AGPL-3 Artistic-1.0 Artistic-2.0
</pre></td></tr></table>
<p>as made available <em>via</em> <a href="http://www.r-project.org/Licenses/">http://www.r-project.org/Licenses/</a> and
contained in subdirectory &lsquo;<tt>share/licenses</tt>&rsquo; of the R source or home
directory.
</p></li><li>
The names and abbreviations of &ldquo;standard&rdquo; and mostly free or open
source software (FOSS, e.g.,
<a href="http://en.wikipedia.org/wiki/FOSS">http://en.wikipedia.org/wiki/FOSS</a>) licenses contained in the
license data base in file &lsquo;<tt>share/licenses/license.db</tt>&rsquo; in the R
source or home directory, possibly (for versioned licenses) followed by
a version restriction of the form &lsquo;<samp>(<var>op</var> <var>v</var>)</samp>&rsquo; with
<var>op</var> one of the comparison operators &lsquo;<samp>&lt;</samp>&rsquo;, &lsquo;<samp>&lt;=</samp>&rsquo;, &lsquo;<samp>&gt;</samp>&rsquo;,
&lsquo;<samp>&gt;=</samp>&rsquo;, &lsquo;<samp>==</samp>&rsquo;, or &lsquo;<samp>!=</samp>&rsquo; and <var>v</var> a numeric version
specification (strings of non-negative integers separated by &lsquo;<samp>.</samp>&rsquo;),
possibly combined <em>via</em> &lsquo;<samp>,</samp>&rsquo; (see below for an example).  For
versioned licenses, one can also specify the name followed by the
version, or combine an existing abbreviation and the version with a
&lsquo;<samp>-</samp>&rsquo;.
</li><li>
One of the strings &lsquo;<samp>file LICENSE</samp>&rsquo; or &lsquo;<samp>file LICENCE</samp>&rsquo; referring
to a file named &lsquo;<tt>LICENSE</tt>&rsquo; or &lsquo;<tt>LICENCE</tt>&rsquo; in the package (source
and installation) top-level directory.
</li><li>
The string &lsquo;<samp>Unlimited</samp>&rsquo;, meaning that there are no restrictions on
distribution or use other than those imposed by relevant laws (including
copyright laws).
</li></ul>
<p>If a package license restricts a base license (where permitted, e.g.,
using GPL-3 or AGPL-3 with an attribution clause), the additional terms
should be placed in file &lsquo;<tt>LICENSE</tt>&rsquo; (or &lsquo;<tt>LICENCE</tt>&rsquo;), and the
string &lsquo;<samp>+ file LICENSE</samp>&rsquo; (or &lsquo;<samp>+ file LICENCE</samp>&rsquo;, respectively)
should be appended to the corresponding individual license
specification.
</p>
<p>Examples of standardized specifications include
</p><table><tr><td>&nbsp;</td><td><pre class="example">License: GPL-2
License: GPL (&gt;= 2) | BSD
License: LGPL (&gt;= 2.0, &lt; 3) | Mozilla Public License
License: GPL-2 | file LICENCE
License: Artistic-1.0 | AGPL-3 + file LICENSE
</pre></td></tr></table>
<p>Please note in particular that &ldquo;Public domain&rdquo; is not a valid license,
since it is not recognized in some jurisdictions.
</p>
<p>It is very important that you include this license information!
Otherwise, it may not even be legally correct for others to distribute
copies of the package.  Do not use the &lsquo;<samp>License</samp>&rsquo; field for
copyright information: if needed, use a &lsquo;<samp>Copyright</samp>&rsquo; field.
</p>
<p>Please ensure that the license you choose also covers any dependencies
(including system dependencies) of your package: it is particularly
important that any restrictions on the use of such dependencies are
evident to people reading your &lsquo;<tt>DESCRIPTION</tt>&rsquo; file.
</p>
<p>The mandatory &lsquo;<samp>Description</samp>&rsquo; field should give a comprehensive
description of what the package does.  One can use several (complete)
sentences, but only one paragraph.
</p>
<p>The mandatory &lsquo;<samp>Title</samp>&rsquo; field should give a short description of the
package. Some package listings may truncate the title to 65 characters.
It should be capitalized, not use any markup, not have any continuation
lines, and not end in a period.
</p>
<p>The mandatory &lsquo;<samp>Author</samp>&rsquo; field describes who wrote <em>the
package</em>.  It is a plain text field intended for human readers, but not
for automatic processing (such as extracting the email addresses of all
listed contributors: for that use &lsquo;<samp>Authors@R</samp>&rsquo;).  Note that all
significant contributors must be included: if you wrote an R wrapper
for the work of others included in the &lsquo;<tt>src</tt>&rsquo; directory, you are not
the sole (and maybe not even the main) author.
</p>
<p>The mandatory &lsquo;<samp>Maintainer</samp>&rsquo; field should give a <em>single</em> name
followed a <em>valid</em> (RFC 2822) email address in angle brackets.  It
should not end in a period or comma.  This field is what is reported by
the <code>maintainer</code> function and used by <code>bug.report</code>.  For a
<acronym>CRAN</acronym> package it should be a <em>person</em>, not a mailing list
and not a corporate entity: do ensure that it is valid and will remain
valid for the lifetime of the package.
</p>
<p>Both &lsquo;<samp>Author</samp>&rsquo; and &lsquo;<samp>Maintainer</samp>&rsquo; fields can be omitted if a
suitable &lsquo;<samp>Authors@R</samp>&rsquo; field is given.  This field can be used to
provide a refined and machine-readable description of the package
&ldquo;authors&rdquo; (in particular specifying their precise <em>roles</em>), via
suitable R code.  The roles can include &lsquo;<samp>&quot;aut&quot;</samp>&rsquo; (author) for
full authors, &lsquo;<samp>&quot;cre&quot;</samp>&rsquo; (creator) for the package maintainer, and
&lsquo;<samp>&quot;ctb&quot;</samp>&rsquo; (contributor) for other contributors, &lsquo;<samp>&quot;cph&quot;</samp>&rsquo;
(copyright holder), among others.  See <code>?person</code> for more
information.  Note that no role is assumed by default.  Auto-generated
package citation information takes advantage of this specification.  In
R 2.14.0 or later, the &lsquo;<samp>Author</samp>&rsquo; and &lsquo;<samp>Maintainer</samp>&rsquo; fields are
auto-generated from it if needed when building<a name="DOCF4" href="#FOOT4">(4)</a> or
installing<a name="DOCF5" href="#FOOT5">(5)</a>.
</p>
<a name="index-COPYRIGHTS"></a>
<p>An optional &lsquo;<samp>Copyright</samp>&rsquo; field can be used where the copyright
holder(s) are not the authors.  If necessary, this can refer to a file:
the convention is to use file &lsquo;<tt>inst/COPYRIGHTS</tt>&rsquo;.
</p>
<p>Several optional fields take <em>logical values</em>: these can be
specified as &lsquo;<samp>yes</samp>&rsquo;, &lsquo;<samp>true</samp>&rsquo;, &lsquo;<samp>no</samp>&rsquo; or &lsquo;<samp>false</samp>&rsquo;:
capitalized values are also accepted.
</p>
<p>The &lsquo;<samp>Date</samp>&rsquo; field gives the release date of the current
version of the package.  It is strongly recommended to use the yyyy-mm-dd
format conforming to the ISO 8601 standard.
</p>
<p>The &lsquo;<samp>Depends</samp>&rsquo; field gives a comma-separated list of package names
which this package depends on.  The package name may be optionally
followed by a comment in parentheses.  The comment should contain a
comparison operator, whitespace and a valid version number.  You can
also use the special package name &lsquo;<samp>R</samp>&rsquo; if your package depends on a
certain version of R &mdash; e.g., if the package works only with R
version 2.11.0 or later, include &lsquo;<samp>R (&gt;= 2.11.0)</samp>&rsquo; in the
&lsquo;<samp>Depends</samp>&rsquo; field.  You can also require a certain SVN revision for
R-devel or R-patched, e.g. &lsquo;<samp>R (&gt;= 2.14.0), R (&gt;= r56550)</samp>&rsquo;
requires a version later than R-devel of late July 2011 (including
released versions of 2.14.0).  Both <code>library</code> and the R package
checking facilities use this field: hence it is an error to use improper
syntax or misuse the &lsquo;<samp>Depends</samp>&rsquo; field for comments on other software
that might be needed.  Other dependencies (external to the R system)
should be listed in the &lsquo;<samp>SystemRequirements</samp>&rsquo; field, possibly
amplified in a separate &lsquo;<tt>README</tt>&rsquo; file.  The R <code>INSTALL</code>
facilities check if the version of R used is recent enough for the
package being installed, and the list of packages which is specified
will be attached (after checking version requirements) before the
current package, both when <code>library</code> is called and when preparing
for lazy-loading during installation.
</p>
<p>A package (or &lsquo;<samp>R</samp>&rsquo;) can appear more than once in the
&lsquo;<samp>Depends</samp>&rsquo; field.
</p>
<p>It makes no sense to declare a dependence on <code>R</code> without a version
specification, nor on the package <strong>base</strong>: this is an R package
and <strong>base</strong> is always available.
</p>
<p>The &lsquo;<samp>Imports</samp>&rsquo; field lists packages whose namespaces are imported
from (as specified in the &lsquo;<tt>NAMESPACE</tt>&rsquo; file) but which do not need
to be attached.  Namespaces accessed by the &lsquo;<samp>::</samp>&rsquo; and &lsquo;<samp>:::</samp>&rsquo;
operators must be listed here, or in &lsquo;<samp>Suggests</samp>&rsquo; or &lsquo;<samp>Enhances</samp>&rsquo;
(see below).  Ideally this field will include all the standard packages
that are used, and it is important to include S4-using packages (as
their class definitions can change and the &lsquo;<tt>DESCRIPTION</tt>&rsquo; file is
used to decide which packages to re-install when this happens).
Packages declared in the &lsquo;<samp>Depends</samp>&rsquo; field should not also be in the
&lsquo;<samp>Imports</samp>&rsquo; field.  Version requirements can be specified but are
only be checked when the namespace is loaded in R &gt;= 3.0.0.
</p>
<p>The &lsquo;<samp>Suggests</samp>&rsquo; field uses the same syntax as &lsquo;<samp>Depends</samp>&rsquo; and
lists packages that are not necessarily needed.  This includes packages
used only in examples, tests or vignettes (see section <a href="#Writing-package-vignettes">Writing package vignettes</a>), and packages loaded in the body of functions.  E.g.,
suppose an example from package <strong>foo</strong> uses a dataset from package
<strong>bar</strong>. Then it is not necessary to have <strong>bar</strong> use <strong>foo</strong>
unless one wants to execute all the examples/tests/vignettes: it is
useful to have <strong>bar</strong>, but not necessary.  Version requirements can
be specified, and will be used by <code>R CMD check</code>.  Note that
someone wanting to run the examples/tests/vignettes may not have a
suggested package available (and it may not even be possible to install
it for that platform), so it is helpful if the use of suggested packages
is made conditional <em>via</em> <code>if(require(<var>pkgname</var>))</code>).
</p>
<p>Finally, the &lsquo;<samp>Enhances</samp>&rsquo; field lists packages &ldquo;enhanced&rdquo; by the
package at hand, e.g., by providing methods for classes from these
packages, or ways to handle objects from these packages (so several
packages have &lsquo;<samp>Enhances: chron</samp>&rsquo; because they can handle datetime
objects from <a href="http://CRAN.R-project.org/package=chron"><strong>chron</strong></a> even though they prefer R&rsquo;s native
datetime functions).  Version requirements can be specified, but are
currently not used.  Such packages cannot be required to check the
package: any tests which use them must be conditional on the presence
of the package.  (If your tests use e.g. a dataset from another
package it should be in &lsquo;<samp>Suggests</samp>&rsquo; and not &lsquo;<samp>Enhances</samp>&rsquo;.)
</p>
<p>The general rules are
</p>
<ul>
<li>
Packages whose namespace only is needed to load the package using
<code>library(<var>pkgname</var>)</code> must be listed in the &lsquo;<samp>Imports</samp>&rsquo;
field and not in the &lsquo;<samp>Depends</samp>&rsquo; field.
</li><li>
Packages that need to be attached to successfully load the package using
<code>library(<var>pkgname</var>)</code> must be listed in the &lsquo;<samp>Depends</samp>&rsquo;
field, only.
</li><li>
All packages that are needed<a name="DOCF6" href="#FOOT6">(6)</a> to successfully run <code>R CMD check</code> on the
package must be listed in one of &lsquo;<samp>Depends</samp>&rsquo; or &lsquo;<samp>Suggests</samp>&rsquo; or
&lsquo;<samp>Imports</samp>&rsquo;.  Packages used to run examples or tests conditionally
(e.g. <em>via</em> <code>if(require(<var>pkgname</var>))</code>) should be listed
in &lsquo;<samp>Suggests</samp>&rsquo; or &lsquo;<samp>Enhances</samp>&rsquo;.  (This allows checkers to ensure
that all the packages needed for a complete check are installed.)
</li></ul>

<p>In particular, large packages providing &ldquo;only&rdquo; data for examples or
vignettes should be listed in &lsquo;<samp>Suggests</samp>&rsquo; rather than &lsquo;<samp>Depends</samp>&rsquo;
in order to make lean installations possible.
</p>
<p>Version dependencies in the &lsquo;<samp>Depends</samp>&rsquo; field are used by
<code>library</code> when it loads the package, and <code>install.packages</code>
checks versions for the &lsquo;<samp>Imports</samp>&rsquo; and (for <code>dependencies =
TRUE</code>) &lsquo;<samp>Suggests</samp>&rsquo; fields.
</p>
<p>It is increasingly important that the information in these fields is
complete and accurate: it is for example used to compute which packages
depend on an updated package and which packages can safely be installed
in parallel.
</p>
<p>The &lsquo;<samp>URL</samp>&rsquo; field may give a list of <acronym>URL</acronym>s
separated by commas or whitespace, for example the homepage of the
author or a page where additional material describing the software can
be found.  These <acronym>URL</acronym>s are converted to active hyperlinks in
<acronym>CRAN</acronym> package listings.
</p>
<p>The &lsquo;<samp>BugReports</samp>&rsquo; field may contain a single
<acronym>URL</acronym> to which bug reports about the package should be
submitted.  This <acronym>URL</acronym> will be used by <code>bug.reports</code>
instead of sending an email to the maintainer.
</p>
<p>Base and recommended packages (i.e., packages contained in the R
source distribution or available from <acronym>CRAN</acronym> and recommended to
be included in every binary distribution of R) have a &lsquo;<samp>Priority</samp>&rsquo;
field with value &lsquo;<samp>base</samp>&rsquo; or &lsquo;<samp>recommended</samp>&rsquo;, respectively.  These
priorities must not be used by other packages.
</p>
<p>A &lsquo;<samp>Collate</samp>&rsquo; field can be used for controlling the collation order
for the R code files in a package when these are processed for
package installation.  The default is to collate according to the
&lsquo;<samp>C</samp>&rsquo; locale.  If present, the collate specification must list
<em>all</em> R code files in the package (taking possible OS-specific
subdirectories into account, see <a href="#Package-subdirectories">Package subdirectories</a>) as a
whitespace separated list of file paths relative to the &lsquo;<tt>R</tt>&rsquo;
subdirectory.
Paths containing white space or quotes need to be quoted.  An
OS-specific collation field (&lsquo;<samp>Collate.unix</samp>&rsquo; or
&lsquo;<samp>Collate.windows</samp>&rsquo;) will be used in preference to &lsquo;<samp>Collate</samp>&rsquo;.
</p>
<p>The &lsquo;<samp>LazyData</samp>&rsquo; logical field controls whether the R datasets use
lazy-loading.  A &lsquo;<samp>LazyLoad</samp>&rsquo; field was used in versions prior to
2.14.0, but now is ignored.
</p>
<p>The &lsquo;<samp>KeepSource</samp>&rsquo; logical field controls if the package code is sourced
using <code>keep.source = TRUE</code> or <code>FALSE</code>: it might be needed
exceptionally for a package designed to always be used with
<code>keep.source = TRUE</code>.
</p>
<p>The &lsquo;<samp>ByteCompile</samp>&rsquo; logical field controls if the package code is
byte-compiled on installation: the default is currently not to, so this
may be useful for a package known to benefit particularly from
byte-compilation (which can take quite a long time and increases the
installed size of the package).
</p>
<p>The &lsquo;<samp>ZipData</samp>&rsquo; logical field was used to control whether the automatic
Windows build would zip up the data directory or not: set this to
&lsquo;<samp>no</samp>&rsquo; if your package will not work with a zipped data directory.
(Setting to any other value is deprecated, and it is unused from R
2.13.0: but it might still be needed if the package can be installed
under earlier versions of R.)
</p>
<p>The &lsquo;<samp>Biarch</samp>&rsquo; logical field is used on Windows to select the
<code>INSTALL</code> option &lsquo;<samp>--force-biarch</samp>&rsquo; for this package.
(Introduced in R 3.0.0.)
</p>
<p>The &lsquo;<samp>BuildVignettes</samp>&rsquo; logical field can be set to a false value to stop
<code>R CMD build</code> from attempting to rebuild the vignettes, as well
as preventing <code>R CMD check</code> from testing this.  This should only
be used exceptionally, for example if the PDFs need large figures which
are not part of the package sources.
</p>
<p>The &lsquo;<samp>VignetteBuilder</samp>&rsquo; field names a package that provides 
an engine other than Sweave for building vignettes.  This may
be the current package, or one listed in &lsquo;<samp>Depends</samp>&rsquo;,
&lsquo;<samp>Suggests</samp>&rsquo; or &lsquo;<samp>Imports</samp>&rsquo;.
See <a href="#Non_002dSweave-vignettes">Non-Sweave vignettes</a> for details.
If the &lsquo;<tt>DESCRIPTION</tt>&rsquo; file is not entirely in <acronym>ASCII</acronym> it
should contain an &lsquo;<samp>Encoding</samp>&rsquo; field specifying an encoding.  This is
used as the encoding of the &lsquo;<tt>DESCRIPTION</tt>&rsquo; file itself and of the
&lsquo;<tt>R</tt>&rsquo; and &lsquo;<tt>NAMESPACE</tt>&rsquo; files, and as the default encoding of
&lsquo;<tt>.Rd</tt>&rsquo; files.  The examples are assumed to be in this encoding when
running <code>R CMD check</code>, and it is used for the encoding of the
<code>CITATION</code> file.  Only encoding names <code>latin1</code>, <code>latin2</code>
and <code>UTF-8</code> are known to be portable.  (Do not specify an encoding
unless one is actually needed: doing so makes the package <em>less</em>
portable.  If a package has a specified encoding, you should run
<code>R CMD build</code> etc in a locale using that encoding.)
</p>
<p>The &lsquo;<samp>OS_type</samp>&rsquo; field specifies the OS(es) for which the
package is intended.  If present, it should be one of <code>unix</code> or
<code>windows</code>, and indicates that the package can only be installed
on a platform with &lsquo;<samp>.Platform$OS.type</samp>&rsquo; having that value.
</p>
<p>The &lsquo;<samp>Type</samp>&rsquo; field specifies the type of the package:
see section <a href="#Package-types">Package types</a>.
</p>
<blockquote><p><b>Note:</b> There should be no &lsquo;<samp>Built</samp>&rsquo; or &lsquo;<samp>Packaged</samp>&rsquo; fields, as these are
added by the package management tools.
</p></blockquote>

<p>One can add subject classifications for the content of the package using
the fields &lsquo;<samp>Classification/ACM</samp>&rsquo; (using the Computing
Classification System of the Association for Computing Machinery,
<a href="http://www.acm.org/class/">http://www.acm.org/class/</a>), &lsquo;<samp>Classification/JEL</samp>&rsquo; (the
Journal of Economic Literature Classification System,
<a href="http://www.aeaweb.org/journal/jel_class_system.html">http://www.aeaweb.org/journal/jel_class_system.html</a>), or
&lsquo;<samp>Classification/MSC</samp>&rsquo; (the Mathematics Subject Classification of the
American Mathematical Society, <a href="http://www.ams.org/msc/">http://www.ams.org/msc/</a>).  The
subject classifications should be comma-separated lists of the
respective classification codes, e.g., &lsquo;<samp>Classification/ACM: G.4,
H.2.8, I.5.1</samp>&rsquo;.
</p>
<p>An &lsquo;<samp>Language</samp>&rsquo; field can be used to indicate if the package
documentation is not in English: this should be a comma-separated list
of standard (not private use or grandfathered) IETF language tags as
currently defined by RFC 5646
(<a href="http://tools.ietf.org/html/rfc5646">http://tools.ietf.org/html/rfc5646</a>, see also
<a href="http://en.wikipedia.org/wiki/IETF_language_tag">http://en.wikipedia.org/wiki/IETF_language_tag</a>), i.e., use
language subtags which in essence are 2-letter ISO 639-1
(<a href="http://en.wikipedia.org/wiki/ISO_639-1">http://en.wikipedia.org/wiki/ISO_639-1</a>) or 3-letter ISO
639-3 (<a href="http://en.wikipedia.org/wiki/ISO_639-3">http://en.wikipedia.org/wiki/ISO_639-3</a>) language
codes.
</p>
<p>There is no restriction on the use of other fields not mentioned here
(but using other capitalizations of these field names would cause
confusion).  Fields <code>Note</code>, <code>Contact</code> (for contacting the
authors/developers) and <code>MailingList</code> are in common use. Some
repositories (including <acronym>CRAN</acronym> and R-forge) add their own
fields.
</p>

<hr size="6">
<a name="The-INDEX-file"></a>
<table cellpadding="1" cellspacing="1" border="0">
<tr><td valign="middle" align="left">[<a href="#The-DESCRIPTION-file" title="Previous section in reading order"> &lt; </a>]</td>
<td valign="middle" align="left">[<a href="#Package-subdirectories" title="Next section in reading order"> &gt; </a>]</td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left">[<a href="#Creating-R-packages" title="Beginning of this chapter or previous chapter"> &lt;&lt; </a>]</td>
<td valign="middle" align="left">[<a href="#Package-structure" title="Up section"> Up </a>]</td>
<td valign="middle" align="left">[<a href="#Writing-R-documentation-files" title="Next chapter"> &gt;&gt; </a>]</td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left">[<a href="#Top" title="Cover (top) of document">Top</a>]</td>
<td valign="middle" align="left">[<a href="#SEC_Contents" title="Table of contents">Contents</a>]</td>
<td valign="middle" align="left">[<a href="#Function-and-variable-index" title="Index">Index</a>]</td>
<td valign="middle" align="left">[<a href="#SEC_About" title="About (help)"> ? </a>]</td>
</tr></table>
<a name="The-INDEX-file-1"></a>
<h3 class="subsection">1.1.2 The &lsquo;<tt>INDEX</tt>&rsquo; file</h3>
<a name="index-INDEX-file"></a>

<p>The optional file &lsquo;<tt>INDEX</tt>&rsquo; contains a line for each sufficiently
interesting object in the package, giving its name and a description
(functions such as print methods not usually called explicitly might not
be included).  Normally this file is missing and the corresponding
information is automatically generated from the documentation sources
(using <code>tools::Rdindex()</code>) when installing from source.
</p>
<p>The file is part of the information given by <code>library(help =
<var>pkgname</var>)</code>.
</p>
<p>Rather than editing this file, it is preferable to put customized
information about the package into an overview man page
(see section <a href="#Documenting-packages">Documenting packages</a>) and/or a vignette (see section <a href="#Writing-package-vignettes">Writing package vignettes</a>).
</p>
<hr size="6">
<a name="Package-subdirectories"></a>
<table cellpadding="1" cellspacing="1" border="0">
<tr><td valign="middle" align="left">[<a href="#The-INDEX-file" title="Previous section in reading order"> &lt; </a>]</td>
<td valign="middle" align="left">[<a href="#Package-bundles" title="Next section in reading order"> &gt; </a>]</td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left">[<a href="#Creating-R-packages" title="Beginning of this chapter or previous chapter"> &lt;&lt; </a>]</td>
<td valign="middle" align="left">[<a href="#Package-structure" title="Up section"> Up </a>]</td>
<td valign="middle" align="left">[<a href="#Writing-R-documentation-files" title="Next chapter"> &gt;&gt; </a>]</td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left">[<a href="#Top" title="Cover (top) of document">Top</a>]</td>
<td valign="middle" align="left">[<a href="#SEC_Contents" title="Table of contents">Contents</a>]</td>
<td valign="middle" align="left">[<a href="#Function-and-variable-index" title="Index">Index</a>]</td>
<td valign="middle" align="left">[<a href="#SEC_About" title="About (help)"> ? </a>]</td>
</tr></table>
<a name="Package-subdirectories-1"></a>
<h3 class="subsection">1.1.3 Package subdirectories</h3>
<a name="index-Package-subdirectories"></a>

<p>The &lsquo;<tt>R</tt>&rsquo; subdirectory contains R code files, only.  The code
files to be installed must start with an <acronym>ASCII</acronym> (lower or upper
case) letter or digit and have one of the extensions<a name="DOCF7" href="#FOOT7">(7)</a> &lsquo;<tt>.R</tt>&rsquo;,
&lsquo;<tt>.S</tt>&rsquo;, &lsquo;<tt>.q</tt>&rsquo;, &lsquo;<tt>.r</tt>&rsquo;, or &lsquo;<tt>.s</tt>&rsquo;.  We recommend using
&lsquo;<tt>.R</tt>&rsquo;, as this extension seems to be not used by any other software.
It should be possible to read in the files using <code>source()</code>, so
R objects must be created by assignments.  Note that there need be no
connection between the name of the file and the R objects created by
it.  Ideally, the R code files should only directly assign R
objects and definitely should not call functions with side effects such
as <code>require</code> and <code>options</code>.  If computations are required to
create objects these can use code &lsquo;earlier&rsquo; in the package (see the
&lsquo;<samp>Collate</samp>&rsquo; field) plus functions in the &lsquo;<samp>Depends</samp>&rsquo; packages
provided that the objects created do not depend on those packages except
<em>via</em> namespace imports.
</p>
<p>Two exceptions are allowed: if the &lsquo;<tt>R</tt>&rsquo; subdirectory contains a file
&lsquo;<tt>sysdata.rda</tt>&rsquo; (a saved image of R objects: please use suitable
compression as suggested by <code>tools::resaveRdaFiles</code>) this will be
lazy-loaded into the namespace environment &ndash; this is intended for
system datasets that are not intended to be user-accessible <em>via</em>
<code>data</code>.  Also, files ending in &lsquo;<samp>.in</samp>&rsquo; will be allowed in the
&lsquo;<tt>R</tt>&rsquo; directory to allow a &lsquo;<tt>configure</tt>&rsquo; script to generate
suitable files.
</p>
<p>Only <acronym>ASCII</acronym> characters (and the control characters tab,
formfeed, LF and CR) should be used in code files.  Other characters are
accepted in comments, but then the comments may not be readable in
e.g. a UTF-8 locale.  Non-<acronym>ASCII</acronym> characters in object names
will normally<a name="DOCF8" href="#FOOT8">(8)</a> fail when the package is installed.  Any byte will be allowed
in a quoted character string but <code>\uxxxx</code> escapes should be
used<a name="DOCF9" href="#FOOT9">(9)</a> for
non-ASCII characters.  However, non-<acronym>ASCII</acronym> character strings
may not be usable in some locales and may display incorrectly in others.
</p>

<a name="index-library_002edynam"></a>
<p>Various R functions in a package can be used to initialize and
clean up.  See section <a href="#Load-hooks">Load hooks</a>.
</p>
<p>The &lsquo;<tt>man</tt>&rsquo; subdirectory should contain (only) documentation files
for the objects in the package in <em>R documentation</em> (Rd) format.
The documentation filenames must start with an <acronym>ASCII</acronym> (lower or
upper case) letter or digit and have the extension &lsquo;<tt>.Rd</tt>&rsquo; (the
default) or &lsquo;<tt>.rd</tt>&rsquo;.  Further, the names must be valid in
&lsquo;<samp>file://</samp>&rsquo; URLs, which means<a name="DOCF10" href="#FOOT10">(10)</a>  they must be entirely <acronym>ASCII</acronym> and not
contain &lsquo;<samp>%</samp>&rsquo;.  See section <a href="#Writing-R-documentation-files">Writing R documentation files</a>, for more
information.  Note that all user-level objects in a package should be
documented; if a package <var>pkg</var> contains user-level objects which are
for &ldquo;internal&rdquo; use only, it should provide a file
&lsquo;<tt><var>pkg</var>-internal.Rd</tt>&rsquo; which documents all such objects, and
clearly states that these are not meant to be called by the user.  See
e.g. the sources for package <strong>grid</strong> in the R distribution for
an example.  Note that packages which use internal objects extensively
should not export those objects from their namespace, when they do not
need to be documented (see section <a href="#Package-namespaces">Package namespaces</a>).
</p>
<p>Having a &lsquo;<tt>man</tt>&rsquo; directory containing no documentation files may give
an installation error.
</p>
<p>The &lsquo;<tt>R</tt>&rsquo; and &lsquo;<tt>man</tt>&rsquo; subdirectories may contain OS-specific
subdirectories named &lsquo;<tt>unix</tt>&rsquo; or &lsquo;<tt>windows</tt>&rsquo;.
</p>
<p>The sources and headers for the compiled code are in &lsquo;<tt>src</tt>&rsquo;, plus
optionally a file &lsquo;<tt>Makevars</tt>&rsquo; or &lsquo;<tt>Makefile</tt>&rsquo;.  When a package is
installed using <code>R CMD INSTALL</code>, <code>make</code> is used to control
compilation and linking into a shared object for loading into R.
There are default <code>make</code> variables and rules for this
(determined when R is configured and recorded in
&lsquo;<tt><var>R_HOME</var>/etc<var>R_ARCH</var>/Makeconf</tt>&rsquo;), providing support for C,
C++, FORTRAN 77, Fortran 9x<a name="DOCF11" href="#FOOT11">(11)</a>, Objective C and Objective
C++<a name="DOCF12" href="#FOOT12">(12)</a> with associated extensions &lsquo;<tt>.c</tt>&rsquo;, &lsquo;<tt>.cc</tt>&rsquo; or
&lsquo;<tt>.cpp</tt>&rsquo;, &lsquo;<tt>.f</tt>&rsquo;, &lsquo;<tt>.f90</tt>&rsquo; or &lsquo;<tt>.f95</tt>&rsquo;, &lsquo;<tt>.m</tt>&rsquo;, and
&lsquo;<tt>.mm</tt>&rsquo; or &lsquo;<tt>.M</tt>&rsquo;, respectively.  We recommend using &lsquo;<tt>.h</tt>&rsquo; for
headers, also for C++<a name="DOCF13" href="#FOOT13">(13)</a> or Fortran 9x include files.
(Use of extension &lsquo;<tt>.C</tt>&rsquo; for C++ is no longer supported.)
Files in the &lsquo;<tt>src</tt>&rsquo; directory should not be hidden (start with a
dot), and hidden files will under some versions of R be ignored.
</p>
<p>It is not portable (and may not be possible at all) to mix all these
languages in a single package, and we do not support using both C++ and
Fortran 9x. Because R itself uses it, we know that C and FORTRAN 77
can be used together and mixing C and C++ seems to be widely successful.
</p>
<p>If your code needs to depend on the platform there are certain defines
which can used in C or C++.  On all Windows builds (even 64-bit ones)
&lsquo;<samp>WIN32</samp>&rsquo; will be defined: on 64-bit Windows builds also
&lsquo;<samp>WIN64</samp>&rsquo;, and on Mac OS X &lsquo;<samp>__APPLE__</samp>&rsquo; is
defined.<a name="DOCF14" href="#FOOT14">(14)</a>
</p>
<p>The default rules can be tweaked by setting macros<a name="DOCF15" href="#FOOT15">(15)</a> in a file
&lsquo;<tt>src/Makevars</tt>&rsquo; (see section <a href="#Using-Makevars">Using &lsquo;<tt>Makevars</tt>&rsquo;</a>).  Note that this mechanism
should be general enough to eliminate the need for a package-specific
&lsquo;<tt>src/Makefile</tt>&rsquo;.  If such a file is to be distributed, considerable
care is needed to make it general enough to work on all R platforms.
If it has any targets at all, it should have an appropriate first target
named &lsquo;<samp>all</samp>&rsquo; and a (possibly empty) target &lsquo;<samp>clean</samp>&rsquo; which
removes all files generated by running <code>make</code> (to be used by
&lsquo;<samp>R CMD INSTALL --clean</samp>&rsquo; and &lsquo;<samp>R CMD INSTALL --preclean</samp>&rsquo;).
There are platform-specific file names on Windows:
&lsquo;<tt>src/Makevars.win</tt>&rsquo; takes precedence over &lsquo;<tt>src/Makevars</tt>&rsquo; and
&lsquo;<tt>src/Makefile.win</tt>&rsquo; must be used.  Some <code>make</code> programs
require makefiles to have a complete final line, including a newline.
</p>
<p>A few packages use the &lsquo;<tt>src</tt>&rsquo; directory for purposes other than
making a shared object (e.g. to create executables).  Such packages
should have files &lsquo;<tt>src/Makefile</tt>&rsquo; and &lsquo;<tt>src/Makefile.win</tt>&rsquo;
(unless intended for only Unix-alikes or only Windows).
</p>
<p>In very special cases packages may create binary files other than the
shared objects/DLLs in the &lsquo;<tt>src</tt>&rsquo; directory.  Such files will not be
installed in a multi-arch setting since <code>R CMD INSTALL --libs-only</code>
is used to merge multiple architectures and it only copies shared
objects/DLLs.  If a package wants to install other binaries (for example
executable programs), it should provide an R script
&lsquo;<tt>src/install.libs.R</tt>&rsquo; which will be run as part of the installation
in the <code>src</code> build directory <em>instead of</em> copying the shared
objects/DLLs. The script is run in a separate R environment
containing the following variables: <code>R_PACKAGE_NAME</code> (the name of
the package), <code>R_PACKAGE_SOURCE</code> (the path to the source directory
of the package), <code>R_PACKAGE_DIR</code> (the path of the target
installation directory of the package), <code>R_ARCH</code> (the
arch-dependent part of the path), <code>SHLIB_EXT</code> (the extension of
shared objects) and <code>WINDOWS</code> (<code>TRUE</code> on Windows, <code>FALSE</code>
elsewhere).  Something close to the default behavior could be replicated
with the following &lsquo;<tt>src/install.libs.R</tt>&rsquo; file:
</p>
<table><tr><td>&nbsp;</td><td><pre class="example">files &lt;- Sys.glob(paste(&quot;*&quot;, SHLIB_EXT, sep=''))
libarch &lt;- if (nzchar(R_ARCH)) paste('libs', R_ARCH, sep='') else 'libs'
dest &lt;- file.path(R_PACKAGE_DIR, libarch)
dir.create(dest, recursive = TRUE, showWarnings = FALSE)
file.copy(files, dest, overwrite = TRUE)
</pre></td></tr></table>

<p>The &lsquo;<tt>data</tt>&rsquo; subdirectory is for data files: See section <a href="#Data-in-packages">Data in packages</a>.
</p>
<p>The &lsquo;<tt>demo</tt>&rsquo; subdirectory is for R scripts (for running <em>via</em>
<code>demo()</code>) that demonstrate some of the functionality of the
package.  Demos may be interactive and are not checked automatically, so
if testing is desired use code in the &lsquo;<tt>tests</tt>&rsquo; directory to achieve
this.  The script files must start with a (lower or upper case) letter
and have one of the extensions &lsquo;<tt>.R</tt>&rsquo; or &lsquo;<tt>.r</tt>&rsquo;.  If present, the
&lsquo;<tt>demo</tt>&rsquo; subdirectory should also have a &lsquo;<tt>00Index</tt>&rsquo; file with one
line for each demo, giving its name and a description separated by white
space. (Note that it is not possible to generate this index file
automatically.)  Note that a demo does not have a specified encoding and
so should be an ASCII file (see section <a href="#Encoding-issues">Encoding issues</a>).  As from R 3.0.0
<code>demo()</code> will use the package encoding if there is one, but this
is mainly useful for non-ASCII comments.
</p>
<a name="index-_002eRinstignore-file"></a>
<p>The contents of the &lsquo;<tt>inst</tt>&rsquo; subdirectory will be copied recursively
to the installation directory.  Subdirectories of &lsquo;<tt>inst</tt>&rsquo; should not
interfere with those used by R (currently, &lsquo;<tt>R</tt>&rsquo;, &lsquo;<tt>data</tt>&rsquo;,
&lsquo;<tt>demo</tt>&rsquo;, &lsquo;<tt>exec</tt>&rsquo;, &lsquo;<tt>libs</tt>&rsquo;, &lsquo;<tt>man</tt>&rsquo;, &lsquo;<tt>help</tt>&rsquo;,
&lsquo;<tt>html</tt>&rsquo; and &lsquo;<tt>Meta</tt>&rsquo;, and earlier versions used &lsquo;<tt>latex</tt>&rsquo;,
&lsquo;<tt>R-ex</tt>&rsquo;).  The copying of the &lsquo;<tt>inst</tt>&rsquo; happens after &lsquo;<tt>src</tt>&rsquo;
is built so its &lsquo;<tt>Makefile</tt>&rsquo; can create files to be installed.  To
exclude files from being installed, one can specify a list of exclude
patterns in file &lsquo;<tt>.Rinstignore</tt>&rsquo; in the top-level source directory.
These patterns should be Perl-like regular expressions (see the help for
<code>regexp</code> in R for the precise details), one per line, to be
matched<a name="DOCF16" href="#FOOT16">(16)</a> against the file and
directory paths, e.g. &lsquo;<tt>doc/.*[.]png$</tt>&rsquo; will exclude all PNG files
in &lsquo;<tt>inst/doc</tt>&rsquo; based on the (lower-case) extension.
</p>
<p>Note that with the exceptions of &lsquo;<tt>INDEX</tt>&rsquo;,
&lsquo;<tt>LICENSE</tt>&rsquo;/&lsquo;<tt>LICENCE</tt>&rsquo; and &lsquo;<tt>NEWS</tt>&rsquo;, information files at the
top level of the package will <em>not</em> be installed and so not be
known to users of Windows and Mac OS X compiled packages (and not seen
by those who use <code>R CMD INSTALL</code> or <code>install.packages</code>
on the tarball).  So any information files you wish an end user to see
should be included in &lsquo;<tt>inst</tt>&rsquo;.  Note that if the named exceptions
also occur in &lsquo;<tt>inst</tt>&rsquo;, the versions in &lsquo;<tt>inst</tt>&rsquo; will be that seen
in the installed package.
</p>
<a name="index-CITATION"></a>
<a name="index-citation"></a>
<p>One thing you might like to add to &lsquo;<tt>inst</tt>&rsquo; is a &lsquo;<tt>CITATION</tt>&rsquo; file
for use by the <code>citation</code> function.
</p>
<a name="index-AUTHORS"></a>
<a name="index-COPYRIGHTS-1"></a>
<p>Another file sometimes needed in &lsquo;<tt>inst</tt>&rsquo; is &lsquo;<tt>AUTHORS</tt>&rsquo; or
&lsquo;<tt>COPYRIGHTS</tt>&rsquo; to specify the authors or copyright holders when this
is too complex to put in the &lsquo;<tt>DESCRIPTION</tt>&rsquo; file.
</p>
<p>Subdirectory &lsquo;<tt>tests</tt>&rsquo; is for additional package-specific test code,
similar to the specific tests that come with the R distribution.
Test code can either be provided directly in a &lsquo;<tt>.R</tt>&rsquo; file, or
<em>via</em> a &lsquo;<tt>.Rin</tt>&rsquo; file containing code which in turn creates the
corresponding &lsquo;<tt>.R</tt>&rsquo; file (e.g., by collecting all function objects
in the package and then calling them with the strangest arguments).  The
results of running a &lsquo;<tt>.R</tt>&rsquo; file are written to a &lsquo;<tt>.Rout</tt>&rsquo; file.
If there is a corresponding<a name="DOCF17" href="#FOOT17">(17)</a> &lsquo;<tt>.Rout.save</tt>&rsquo;
file, these two are compared, with differences being reported but not
causing an error.  The directory &lsquo;<tt>tests</tt>&rsquo; is copied to the check
area, and the tests are run with the copy as the working directory and
with <code>R_LIBS</code> set to ensure that the copy of the package installed
during testing will be found by <code>library(<var>pkg_name</var>)</code>.  Note
that the package-specific tests are run in a vanilla R session
without setting the random-number seed, so tests which use random
numbers will need to set the seed to obtain reproducible results (and it
can be helpful to do so in all cases, to avoid occasional failures when
tests are run).
</p>
<p>If &lsquo;<tt>tests</tt>&rsquo; has a subdirectory &lsquo;<tt>Examples</tt>&rsquo; containing a file
<code><var>pkg</var>-Ex.Rout.save</code>, this is compared to the output file for
running the examples when the latter are checked.
Reference output should be produced without having the 
&lsquo;<samp>--timings</samp>&rsquo; flag set.
</p>
<p>Subdirectory &lsquo;<tt>exec</tt>&rsquo; could contain additional executable scripts the
package needs, typically scripts for interpreters such as the shell,
Perl, or Tcl.  This mechanism is currently used only by a very few
packages, and still experimental.  NB: only files (and not directories)
under &lsquo;<tt>exec</tt>&rsquo; are installed (and those with names starting with a
dot are ignored), and they are all marked as executable (mode
<code>755</code>, moderated by &lsquo;<samp>umask</samp>&rsquo;) on POSIX platforms.  Note too
that this may not be suitable for executable <em>programs</em> since some
platforms (including Mac OS X and Windows) support multiple
architectures using the same installed package directory.
</p>
<p>Subdirectory &lsquo;<tt>po</tt>&rsquo; is used for files related to <em>localization</em>:
see section <a href="#Internationalization">Internationalization</a>.
</p>
<hr size="6">
<a name="Package-bundles"></a>
<table cellpadding="1" cellspacing="1" border="0">
<tr><td valign="middle" align="left">[<a href="#Package-subdirectories" title="Previous section in reading order"> &lt; </a>]</td>
<td valign="middle" align="left">[<a href="#Data-in-packages" title="Next section in reading order"> &gt; </a>]</td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left">[<a href="#Creating-R-packages" title="Beginning of this chapter or previous chapter"> &lt;&lt; </a>]</td>
<td valign="middle" align="left">[<a href="#Package-structure" title="Up section"> Up </a>]</td>
<td valign="middle" align="left">[<a href="#Writing-R-documentation-files" title="Next chapter"> &gt;&gt; </a>]</td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left">[<a href="#Top" title="Cover (top) of document">Top</a>]</td>
<td valign="middle" align="left">[<a href="#SEC_Contents" title="Table of contents">Contents</a>]</td>
<td valign="middle" align="left">[<a href="#Function-and-variable-index" title="Index">Index</a>]</td>
<td valign="middle" align="left">[<a href="#SEC_About" title="About (help)"> ? </a>]</td>
</tr></table>
<a name="Package-bundles-1"></a>
<h3 class="subsection">1.1.4 Package bundles</h3>
<a name="index-Package-bundles"></a>

<p>Support for package bundles was removed in R 2.11.0.
</p>
<hr size="6">
<a name="Data-in-packages"></a>
<table cellpadding="1" cellspacing="1" border="0">
<tr><td valign="middle" align="left">[<a href="#Package-bundles" title="Previous section in reading order"> &lt; </a>]</td>
<td valign="middle" align="left">[<a href="#Non_002dR-scripts-in-packages" title="Next section in reading order"> &gt; </a>]</td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left">[<a href="#Creating-R-packages" title="Beginning of this chapter or previous chapter"> &lt;&lt; </a>]</td>
<td valign="middle" align="left">[<a href="#Package-structure" title="Up section"> Up </a>]</td>
<td valign="middle" align="left">[<a href="#Writing-R-documentation-files" title="Next chapter"> &gt;&gt; </a>]</td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left">[<a href="#Top" title="Cover (top) of document">Top</a>]</td>
<td valign="middle" align="left">[<a href="#SEC_Contents" title="Table of contents">Contents</a>]</td>
<td valign="middle" align="left">[<a href="#Function-and-variable-index" title="Index">Index</a>]</td>
<td valign="middle" align="left">[<a href="#SEC_About" title="About (help)"> ? </a>]</td>
</tr></table>
<a name="Data-in-packages-1"></a>
<h3 class="subsection">1.1.5 Data in packages</h3>

<p>The &lsquo;<tt>data</tt>&rsquo; subdirectory is for data files, either to be made
available <em>via</em> lazy-loading or for loading using <code>data()</code>.
(The choice is made by the &lsquo;<samp>LazyData</samp>&rsquo; field in the
&lsquo;<tt>DESCRIPTION</tt>&rsquo; file: the default is not to do so.)  It should not be
used for other data files needed by the package, and the convention has
grown up to use directory &lsquo;<tt>inst/extdata</tt>&rsquo; for such files.
</p>
<p>Data files can have one of three types as indicated by their extension:
plain R code (&lsquo;<tt>.R</tt>&rsquo; or &lsquo;<tt>.r</tt>&rsquo;), tables (&lsquo;<tt>.tab</tt>&rsquo;,
&lsquo;<tt>.txt</tt>&rsquo;, or &lsquo;<tt>.csv</tt>&rsquo;, see <code>?data</code> for the file formats, and
note that &lsquo;<tt>.csv</tt>&rsquo; is <strong>not</strong> the standard<a name="DOCF18" href="#FOOT18">(18)</a> CSV format), or
<code>save()</code> images (&lsquo;<tt>.RData</tt>&rsquo; or &lsquo;<tt>.rda</tt>&rsquo;).  The files should
not be hidden (have names starting with a dot).  Note that R code
should be &ldquo;self-sufficient&rdquo; and not make use of extra functionality
provided by the package, so that the data file can also be used without
having to load the package.
</p>
<p>Images (extensions &lsquo;<tt>.RData</tt>&rsquo; or &lsquo;<tt>.rda</tt>&rsquo;) can contain references
to the namespaces of packages that were used to create them.  Preferably
there should be no such references in data files, and in any case they
should only be to packages listed in the <code>Depends</code> and
<code>Imports</code> fields, as otherwise it may be impossible to install the
package.  To check for such references, load all the images into a
vanilla R session, and look at the output of
<code>loadedNamespaces()</code>.
</p>
<p>If your data files are large and you are not using &lsquo;<samp>LazyData</samp>&rsquo; you
can speed up installation by providing a file &lsquo;<tt>datalist</tt>&rsquo; in the
&lsquo;<tt>data</tt>&rsquo; subdirectory.  This should have one line per topic that
<code>data()</code> will find, in the format &lsquo;<samp>foo</samp>&rsquo; if <code>data(foo)</code>
provides &lsquo;<samp>foo</samp>&rsquo;, or &lsquo;<samp>foo: bar bah</samp>&rsquo; if <code>data(foo)</code> provides
&lsquo;<samp>bar</samp>&rsquo; and &lsquo;<samp>bah</samp>&rsquo;.  <code>R CMD build</code> will automatically add
a &lsquo;<tt>datalist</tt>&rsquo; file to &lsquo;<tt>data</tt>&rsquo; directories of over 1Mb, using the
function <code>tools::add_datalist</code>.
</p>
<p>Tables (&lsquo;<tt>.tab</tt>&rsquo;, &lsquo;<tt>.txt</tt>&rsquo;, or &lsquo;<tt>.csv</tt>&rsquo; files) can be
compressed by <code>gzip</code>, <code>bzip2</code> or <code>xz</code>,
optionally with additional extension &lsquo;<tt>.gz</tt>&rsquo;, &lsquo;<tt>.bz2</tt>&rsquo; or
&lsquo;<tt>.xz</tt>&rsquo;.
</p>
<p>If your package is to be distributed, do consider the resource
implications of large datasets for your users: they can make packages
very slow to download and use up unwelcome amounts of storage space, as
well as taking many seconds to load.  It is normally best to distribute
large datasets as &lsquo;<tt>.rda</tt>&rsquo; images prepared by <code>save(, compress =
TRUE)</code> (the default): there is no excuse for distributing ASCII saves.
Using <code>bzip2</code> or <code>xz</code> compression will usually reduce
the size of both the package tarball and the installed package, in some
cases by a factor of two or more.
</p>
<p>Package <strong>tools</strong> has a couple of functions to help with data images:
<code>checkRdaFiles</code> reports on the way the image was saved, and
<code>resaveRdaFiles</code> will re-save with a different type of compression,
including choosing the best type for that particular image.
</p>
<p>Some packages using &lsquo;<samp>LazyData</samp>&rsquo; will benefit from using a form of
compression other than <code>gzip</code> in the installed lazy-loading
database.  This can be selected by the &lsquo;<samp>--data-compress</samp>&rsquo; option
to <code>R CMD INSTALL</code> or by using the &lsquo;<samp>LazyDataCompression</samp>&rsquo;
field in the &lsquo;<tt>DESCRIPTION</tt>&rsquo; file.  Useful values are <code>bzip2</code>,
<code>xz</code> and the default, <code>gzip</code>.  The only way to discover which
is best is to try them all and look at the size of the
&lsquo;<tt><var>pkgname</var>/data/Rdata.rdb</tt>&rsquo; file.
</p>
<p>Lazy-loading is not supported for very large datasets (those which when
serialized exceed 2GB).
</p>
<hr size="6">
<a name="Non_002dR-scripts-in-packages"></a>
<table cellpadding="1" cellspacing="1" border="0">
<tr><td valign="middle" align="left">[<a href="#Data-in-packages" title="Previous section in reading order"> &lt; </a>]</td>
<td valign="middle" align="left">[<a href="#Configure-and-cleanup" title="Next section in reading order"> &gt; </a>]</td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left">[<a href="#Creating-R-packages" title="Beginning of this chapter or previous chapter"> &lt;&lt; </a>]</td>
<td valign="middle" align="left">[<a href="#Package-structure" title="Up section"> Up </a>]</td>
<td valign="middle" align="left">[<a href="#Writing-R-documentation-files" title="Next chapter"> &gt;&gt; </a>]</td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left">[<a href="#Top" title="Cover (top) of document">Top</a>]</td>
<td valign="middle" align="left">[<a href="#SEC_Contents" title="Table of contents">Contents</a>]</td>
<td valign="middle" align="left">[<a href="#Function-and-variable-index" title="Index">Index</a>]</td>
<td valign="middle" align="left">[<a href="#SEC_About" title="About (help)"> ? </a>]</td>
</tr></table>
<a name="Non_002dR-scripts-in-packages-1"></a>
<h3 class="subsection">1.1.6 Non-R scripts in packages</h3>

<p>Code which needs to be compiled (C, C++, FORTRAN, Fortran 95 &hellip;)
is included in the &lsquo;<tt>src</tt>&rsquo; subdirectory and discussed elsewhere in
this document.
</p>
<p>Subdirectory &lsquo;<tt>exec</tt>&rsquo; could be used for scripts for interpreters such
as the shell (e.g. <a href="http://CRAN.R-project.org/package=arulesSequences"><strong>arulesSequences</strong></a>), BUGS, Java, JavaScript,
Matlab, Perl (<a href="http://CRAN.R-project.org/package=FEST"><strong>FEST</strong></a>), php (<a href="http://CRAN.R-project.org/package=amap"><strong>amap</strong></a>), Python or Tcl, or even
R.  However, it seems more common to use the &lsquo;<tt>inst</tt>&rsquo; directory,
for example &lsquo;<tt>AMA/inst/java</tt>&rsquo;, &lsquo;<tt>WriteXLS/inst/Perl</tt>&rsquo;,
&lsquo;<tt>Amelia/inst/tklibs</tt>&rsquo;, &lsquo;<tt>CGIwithR/inst/cgi-bin</tt>&rsquo;,
&lsquo;<tt>NMF/inst/matlab</tt>&rsquo; and &lsquo;<tt>emdbook/inst/BUGS</tt>&rsquo;.
</p>
<p>If your package requires one of these interpreters or an extension then
this should be declared in the &lsquo;<samp>SystemRequirements</samp>&rsquo; field of its
&lsquo;<tt>DESCRIPTION</tt>&rsquo; file.  Windows users should be aware that the Tcl
extensions &lsquo;<samp>BWidget</samp>&rsquo; and &lsquo;<samp>Tktable</samp>&rsquo; which are included with the
R for Windows installer <em>are</em> extensions and do need to be
declared.  &lsquo;<samp>Tktable</samp>&rsquo; does ship as part of the Tcl/Tk provided on
CRAN for Mac OS X, but you will need to tell your users how to make use
of it:
</p>
<table><tr><td>&nbsp;</td><td><pre class="example">&gt; addTclPath('/usr/local/lib/Tktable2.9')
&gt; tclRequire('Tktable')
&lt;Tcl&gt; 2.9
</pre></td></tr></table>

<hr size="6">
<a name="Configure-and-cleanup"></a>
<table cellpadding="1" cellspacing="1" border="0">
<tr><td valign="middle" align="left">[<a href="#Non_002dR-scripts-in-packages" title="Previous section in reading order"> &lt; </a>]</td>
<td valign="middle" align="left">[<a href="#Using-Makevars" title="Next section in reading order"> &gt; </a>]</td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left">[<a href="#Creating-R-packages" title="Beginning of this chapter or previous chapter"> &lt;&lt; </a>]</td>
<td valign="middle" align="left">[<a href="#Creating-R-packages" title="Up section"> Up </a>]</td>
<td valign="middle" align="left">[<a href="#Writing-R-documentation-files" title="Next chapter"> &gt;&gt; </a>]</td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left">[<a href="#Top" title="Cover (top) of document">Top</a>]</td>
<td valign="middle" align="left">[<a href="#SEC_Contents" title="Table of contents">Contents</a>]</td>
<td valign="middle" align="left">[<a href="#Function-and-variable-index" title="Index">Index</a>]</td>
<td valign="middle" align="left">[<a href="#SEC_About" title="About (help)"> ? </a>]</td>
</tr></table>
<a name="Configure-and-cleanup-1"></a>
<h2 class="section">1.2 Configure and cleanup</h2>

<p>Note that most of this section is specific to Unix-alikes: see the
comments later on about the Windows port of R.
</p>
<p>If your package needs some system-dependent configuration before
installation you can include an executable (Bourne shell) script
&lsquo;<tt>configure</tt>&rsquo; in your package which (if present) is executed by
<code>R CMD INSTALL</code> before any other action is performed.  This can be
a script created by the Autoconf mechanism, but may also be a script
written by yourself.  Use this to detect if any nonstandard libraries
are present such that corresponding code in the package can be disabled
at install time rather than giving error messages when the package is
compiled or used.  To summarize, the full power of Autoconf is available
for your extension package (including variable substitution, searching
for libraries, etc.).
</p>
<p>Under a Unix-alike only, an executable (Bourne shell) script
&lsquo;<tt>cleanup</tt>&rsquo; is executed as the last thing by <code>R CMD INSTALL</code> if
option &lsquo;<samp>--clean</samp>&rsquo; was given, and by <code>R CMD build</code> when
preparing the package for building from its source.  It can be used to
clean up the package source tree: in particular, it should remove all
files created by <code>configure</code>.
</p>
<p>As an example consider we want to use functionality provided by a (C or
FORTRAN) library <code>foo</code>.  Using Autoconf, we can create a configure
script which checks for the library, sets variable <code>HAVE_FOO</code> to
<code>TRUE</code> if it was found and to <code>FALSE</code> otherwise, and then
substitutes this value into output files (by replacing instances of
&lsquo;<samp>@HAVE_FOO@</samp>&rsquo; in input files with the value of <code>HAVE_FOO</code>).
For example, if a function named <code>bar</code> is to be made available by
linking against library <code>foo</code> (i.e., using &lsquo;<samp>-lfoo</samp>&rsquo;), one
could use
</p>
<table><tr><td>&nbsp;</td><td><pre class="example">AC_CHECK_LIB(foo, <var>fun</var>, [HAVE_FOO=TRUE], [HAVE_FOO=FALSE])
AC_SUBST(HAVE_FOO)
......
AC_CONFIG_FILES([foo.R])
AC_OUTPUT
</pre></td></tr></table>

<p>in &lsquo;<tt>configure.ac</tt>&rsquo; (assuming Autoconf 2.50 or later).
</p>
<p>The definition of the respective R function in &lsquo;<tt>foo.R.in</tt>&rsquo; could be
</p>
<table><tr><td>&nbsp;</td><td><pre class="example">foo &lt;- function(x) {
    if(!@HAVE_FOO@)
      stop(&quot;Sorry, library 'foo' is not available&quot;))
    ...
</pre></td></tr></table>

<p>From this file <code>configure</code> creates the actual R source file
&lsquo;<tt>foo.R</tt>&rsquo; looking like
</p>
<table><tr><td>&nbsp;</td><td><pre class="example">foo &lt;- function(x) {
    if(!FALSE)
      stop(&quot;Sorry, library 'foo' is not available&quot;))
    ...
</pre></td></tr></table>

<p>if library <code>foo</code> was not found (with the desired functionality).
In this case, the above R code effectively disables the function.
</p>
<p>One could also use different file fragments for available and missing
functionality, respectively.
</p>
<p>You will very likely need to ensure that the same C compiler and
compiler flags are used in the &lsquo;<tt>configure</tt>&rsquo; tests as when compiling
R or your package.  Under a Unix-alike, you can achieve this by
including the following fragment early in &lsquo;<tt>configure.ac</tt>&rsquo;
</p>
<table><tr><td>&nbsp;</td><td><pre class="example">: ${R_HOME=`R RHOME`}
if test -z &quot;${R_HOME}&quot;; then
  echo &quot;could not determine R_HOME&quot;
  exit 1
fi
CC=`&quot;${R_HOME}/bin/R&quot; CMD config CC`
CFLAGS=`&quot;${R_HOME}/bin/R&quot; CMD config CFLAGS`
CPPFLAGS=`&quot;${R_HOME}/bin/R&quot; CMD config CPPFLAGS`
</pre></td></tr></table>

<p>(Using &lsquo;<samp>${R_HOME}/bin/R</samp>&rsquo; rather than just &lsquo;<samp>R</samp>&rsquo; is necessary
in order to use the correct version of R when running the script as
part of <code>R CMD INSTALL</code>, and the quotes since &lsquo;<samp>${R_HOME}</samp>&rsquo;
might contain spaces.)
</p>
<p>If your code does load checks then you may also need
</p><table><tr><td>&nbsp;</td><td><pre class="example">LDFLAGS=`&quot;${R_HOME}/bin/R&quot; CMD config LDFLAGS`
</pre></td></tr></table>

<p>and packages written with C++ need to pick up the details for the C++
compiler and switch the current language to C++ by
</p><table><tr><td>&nbsp;</td><td><pre class="example">AC_LANG(C++)
</pre></td></tr></table>

<p>The latter is important, as for example C headers may not be available
to C++ programs or may not be written to avoid C++ name-mangling.
</p>
<a name="index-R-CMD-config"></a>
<p>You can use <code>R CMD config</code> for getting the value of the basic
configuration variables, or the header and library flags necessary for
linking against R, see <kbd>R CMD config --help</kbd> for details.
</p>
<p>To check for an external BLAS library using the <code>ACX_BLAS</code> macro
from the official Autoconf Macro Archive, one can simply do
</p>
<table><tr><td>&nbsp;</td><td><pre class="example">F77=`&quot;${R_HOME}/bin/R&quot; CMD config F77`
AC_PROG_F77
FLIBS=`&quot;${R_HOME}/bin/R&quot; CMD config FLIBS`
ACX_BLAS([], AC_MSG_ERROR([could not find your BLAS library], 1))
</pre></td></tr></table>

<p>Note that <code>FLIBS</code> as determined by R must be used to ensure that
FORTRAN 77 code works on all R platforms.  Calls to the Autoconf macro
<code>AC_F77_LIBRARY_LDFLAGS</code>, which would overwrite <code>FLIBS</code>, must
not be used (and hence e.g. removed from <code>ACX_BLAS</code>).  (Recent
versions of Autoconf in fact allow an already set <code>FLIBS</code> to
override the test for the FORTRAN linker flags.  Also, recent versions
of R can detect external BLAS and LAPACK libraries.)
</p>
<p>You should bear in mind that the configure script will not be used on
Windows systems.  If your package is to be made publicly available,
please give enough information for a user on a non-Unix-alike platform
to configure it manually, or provide a &lsquo;<tt>configure.win</tt>&rsquo; script to be
used on that platform.  (Optionally, there can be a &lsquo;<tt>cleanup.win</tt>&rsquo;
script.  Both should be shell scripts to be executed by <code>ash</code>,
which is a minimal version of Bourne-style <code>sh</code>.)  When
&lsquo;<tt>configure.win</tt>&rsquo; is run the environment variables <code>R_HOME</code>
(which uses &lsquo;<samp>/</samp>&rsquo; as the file separator) and <code>R_ARCH</code> will be
set.  Use <code>R_ARCH</code> to decide if this is a 64-bit build (its value
there is &lsquo;<samp>/x64</samp>&rsquo;) and to install DLLs to the correct place
(&lsquo;<tt>${R_HOME}/libs${R_ARCH}</tt>&rsquo;).  Use <code>R_ARCH_BIN</code> to find the
correct place under the &lsquo;<tt>bin</tt>&rsquo; directory, e.g.
&lsquo;<tt>${R_HOME}/bin${R_ARCH_BIN}/Rscript.exe</tt>&rsquo;.
</p>
<p>In some rare circumstances, the configuration and cleanup scripts need
to know the location into which the package is being installed.  An
example of this is a package that uses C code and creates two shared
object/DLLs.  Usually, the object that is dynamically loaded by R
is linked against the second, dependent, object.  On some systems, we
can add the location of this dependent object to the object that is
dynamically loaded by R.  This means that each user does not have to
set the value of the <code>LD_LIBRARY_PATH</code> (or equivalent) environment
variable, but that the secondary object is automatically resolved.
Another example is when a package installs support files that are
required at run time, and their location is substituted into an R
data structure at installation time. (This happens with the Java Archive
files in the Omegahat <strong>SJava</strong> package.)
<a name="index-R_005fLIBRARY_005fDIR"></a>
<a name="index-R_005fPACKAGE_005fDIR"></a>
<a name="index-R_005fPACKAGE_005fNAME"></a>
The names of the top-level library directory (i.e., specifiable
<em>via</em> the &lsquo;<samp>-l</samp>&rsquo; argument) and the directory of the package
itself are made available to the installation scripts <em>via</em> the two
shell/environment variables <code>R_LIBRARY_DIR</code> and <code>R_PACKAGE_DIR</code>.
Additionally, the name of the package (e.g. &lsquo;<samp>survival</samp>&rsquo; or
&lsquo;<samp>MASS</samp>&rsquo;) being installed is available from the environment variable
<code>R_PACKAGE_NAME</code>.  (Currently the value of <code>R_PACKAGE_DIR</code> is
always <code>${R_LIBRARY_DIR}/${R_PACKAGE_NAME}</code>, but this used not to
be the case when versioned installs were allowed.  Its main use is in
&lsquo;<tt>configure.win</tt>&rsquo; scripts for the installation path of external
software&rsquo;s DLLs.)  Note that the value of <code>R_PACKAGE_DIR</code> may
contain spaces and other shell-unfriendly characters, and so should be
quoted in makefiles and configure scripts.
</p>
<p>One of the more tricky tasks can be to find the headers and libraries of
external software.  One tool which is increasingly available on
Unix-alikes (but not Mac OS X) to do this is <code>pkg-config</code>.  The
&lsquo;<tt>configure</tt>&rsquo; script will need to test for the presence of the
command itself (see for example package <a href="http://CRAN.R-project.org/package=Cairo"><strong>Cairo</strong></a>), and if present it
can be asked if the software is installed, of a suitable version and for
compilation/linking flags by e.g.
</p>
<table><tr><td>&nbsp;</td><td><pre class="example">$ pkg-config --exists 'QtCore &gt;= 4.0.0'  # check the status
$ pkg-config --modversion QtCore
4.7.1
$ pkg-config --cflags QtCore
-DQT_SHARED -I/usr/include/QtCore
$ pkg-config --libs QtCore
-lQtCore
</pre></td></tr></table>

<p>Note that <code>pkg-config --libs</code> gives the information
required to link against the default version of that library (usually
the dynamic one), and <code>pkg-config --static</code> is needed if the
static library is to be used.
</p>
<p>Sometimes the name by which the software is known to
<code>pkg-config</code> is not what one might expect (e.g.
&lsquo;<samp>gtk+-2.0</samp>&rsquo; even for 2.22).  To get a complete list use
</p>
<table><tr><td>&nbsp;</td><td><pre class="example">pkg-config --list-all | sort
</pre></td></tr></table>

<table class="menu" border="0" cellspacing="0">
<tr><td align="left" valign="top"><a href="#Using-Makevars">1.2.1 Using &lsquo;<tt>Makevars</tt>&rsquo;</a></td><td>&nbsp;&nbsp;</td><td align="left" valign="top">              
</td></tr>
<tr><td align="left" valign="top"><a href="#Configure-example">1.2.2 Configure example</a></td><td>&nbsp;&nbsp;</td><td align="left" valign="top">           
</td></tr>
<tr><td align="left" valign="top"><a href="#Using-F95-code">1.2.3 Using F95 code</a></td><td>&nbsp;&nbsp;</td><td align="left" valign="top">              
</td></tr>
</table>

<hr size="6">
<a name="Using-Makevars"></a>
<table cellpadding="1" cellspacing="1" border="0">
<tr><td valign="middle" align="left">[<a href="#Configure-and-cleanup" title="Previous section in reading order"> &lt; </a>]</td>
<td valign="middle" align="left">[<a href="#OpenMP-support" title="Next section in reading order"> &gt; </a>]</td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left">[<a href="#Creating-R-packages" title="Beginning of this chapter or previous chapter"> &lt;&lt; </a>]</td>
<td valign="middle" align="left">[<a href="#Configure-and-cleanup" title="Up section"> Up </a>]</td>
<td valign="middle" align="left">[<a href="#Writing-R-documentation-files" title="Next chapter"> &gt;&gt; </a>]</td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left">[<a href="#Top" title="Cover (top) of document">Top</a>]</td>
<td valign="middle" align="left">[<a href="#SEC_Contents" title="Table of contents">Contents</a>]</td>
<td valign="middle" align="left">[<a href="#Function-and-variable-index" title="Index">Index</a>]</td>
<td valign="middle" align="left">[<a href="#SEC_About" title="About (help)"> ? </a>]</td>
</tr></table>
<a name="Using-Makevars-1"></a>
<h3 class="subsection">1.2.1 Using &lsquo;<tt>Makevars</tt>&rsquo;</h3>

<table class="menu" border="0" cellspacing="0">
<tr><td align="left" valign="top"><a href="#OpenMP-support">1.2.1.1 OpenMP support</a></td><td>&nbsp;&nbsp;</td><td align="left" valign="top">              
</td></tr>
<tr><td align="left" valign="top"><a href="#Using-pthreads">1.2.1.2 Using pthreads</a></td><td>&nbsp;&nbsp;</td><td align="left" valign="top">              
</td></tr>
<tr><td align="left" valign="top"><a href="#Compiling-in-sub_002ddirectories">1.2.1.3 Compiling in sub-directories</a></td><td>&nbsp;&nbsp;</td><td align="left" valign="top">  
</td></tr>
</table>

<p>Sometimes writing your own &lsquo;<tt>configure</tt>&rsquo; script can be avoided by
supplying a file &lsquo;<tt>Makevars</tt>&rsquo;: also one of the most common uses of a
&lsquo;<tt>configure</tt>&rsquo; script is to make &lsquo;<tt>Makevars</tt>&rsquo; from
&lsquo;<tt>Makevars.in</tt>&rsquo;.
</p>
<p>A &lsquo;<tt>Makevars</tt>&rsquo; file is a makefile and is used as one of several
makefiles by <code>R CMD SHLIB</code> (which is called by <code>R CMD
INSTALL</code> to compile code in the &lsquo;<tt>src</tt>&rsquo; directory).  It should be
written if at all possible in a portable style, in particular (except
for &lsquo;<tt>Makevars.win</tt>&rsquo;) without the use of GNU extensions.
</p>
<p>The most common use of a &lsquo;<tt>Makevars</tt>&rsquo; file is to set additional
preprocessor options (for example include paths) for C/C++ files
<em>via</em> <code>PKG_CPPFLAGS</code>, and additional compiler flags by setting
<code>PKG_CFLAGS</code>, <code>PKG_CXXFLAGS</code>, <code>PKG_FFLAGS</code> or
<code>PKG_FCFLAGS</code>, for C, C++, FORTRAN or Fortran 9x respectively
(see section <a href="#Creating-shared-objects">Creating shared objects</a>).
</p>
<p><strong>NB:</strong> Include paths are preprocessor options, not compiler
options, and <strong>must</strong> be set in <code>PKG_CPPFLAGS</code> as otherwise
platform-specific paths (e.g. &lsquo;<samp>-I/usr/local/include</samp>&rsquo;) will take
precedence.
</p>
<p>&lsquo;<tt>Makevars</tt>&rsquo; can also be used to set flags for the linker, for
example &lsquo;<samp>-L</samp>&rsquo; and &lsquo;<samp>-l</samp>&rsquo; options, <em>via</em> <code>PKG_LIBS</code>.
</p>
<p>When writing a &lsquo;<tt>Makevars</tt>&rsquo; file for a package you intend to
distribute, take care to ensure that it is not specific to your
compiler: flags such as &lsquo;<samp>-O2 -Wall -pedantic</samp>&rsquo; are all specific to
GCC.
</p>
<p>There are some macros<a name="DOCF19" href="#FOOT19">(19)</a>  which are set whilst configuring the
building of R itself and are stored in
&lsquo;<tt><var>R_HOME</var>/etc<var>R_ARCH</var>/Makeconf</tt>&rsquo;.  That makefile is included
as a &lsquo;<tt>Makefile</tt>&rsquo; <em>after</em> &lsquo;<tt>Makevars[.win]</tt>&rsquo;, and the macros
it defines can be used in macro assignments and make command lines in
the latter.  These include
</p>
<dl compact="compact">
<dt> <code>FLIBS</code></dt>
<dd><a name="index-FLIBS"></a>
<p>A macro containing the set of libraries need to link FORTRAN code.  This
may need to be included in <code>PKG_LIBS</code>: it will normally be included
automatically if the package contains FORTRAN source files.
</p>
</dd>
<dt> <code>BLAS_LIBS</code></dt>
<dd><a name="index-BLAS_005fLIBS"></a>
<p>A macro containing the BLAS libraries used when building R.  This may
need to be included in <code>PKG_LIBS</code>.  Beware that if it is empty then
the R executable will contain all the double-precision and
double-complex BLAS routines, but no single-precision or complex
routines.  If <code>BLAS_LIBS</code> is included, then <code>FLIBS</code> also needs
to be<a name="DOCF20" href="#FOOT20">(20)</a> included following it, as most BLAS
libraries are written at least partially in FORTRAN.
</p>
</dd>
<dt> <code>LAPACK_LIBS</code></dt>
<dd><a name="index-LAPACK_005fLIBS"></a>
<p>A macro containing the LAPACK libraries (and paths where appropriate)
used when building R.  This may need to be included in
<code>PKG_LIBS</code>.  It may point to a dynamic library <code>libRlapack</code>
which contains all the double-precision LAPACK routines as well as those
double-complex LAPACK and BLAS routines needed to build R, or it may
point to an external LAPACK library, or may be empty if an external BLAS
library also contains LAPACK.
</p>
<p>[There is no guarantee that the LAPACK library will provide more than
all the double-precision and double-complex routines, and some do not
provide all the auxiliary routines.]
</p>
<p>For portability, the macros <code>BLAS_LIBS</code> and <code>FLIBS</code> should
always be included <em>after</em> <code>LAPACK_LIBS</code> (and in that order).
</p>
</dd>
<dt> <code>SAFE_FFLAGS</code></dt>
<dd><a name="index-SAFE_005fFFLAGS"></a>
<p>A macro containing flags which are needed to circumvent
over-optimization of FORTRAN code: it is typically &lsquo;<samp>-g -O2
-ffloat-store</samp>&rsquo; on &lsquo;<samp>ix86</samp>&rsquo; platforms using <code>gfortran</code>.
Note that this is <strong>not</strong> an additional flag to be used as part of
<code>PKG_FFLAGS</code>, but a replacement for <code>FFLAGS</code>, and that it is
intended for the FORTRAN 77 compiler &lsquo;<samp>F77</samp>&rsquo; and not necessarily for
the Fortran 90/95 compiler &lsquo;<samp>FC</samp>&rsquo;.  See the example later in this
section.
</p></dd>
</dl>

<a name="index-OBJECTS"></a>
<p>Setting certain macros in &lsquo;<tt>Makevars</tt>&rsquo; will prevent <code>R CMD
SHLIB</code> setting them: in particular if &lsquo;<tt>Makevars</tt>&rsquo; sets
&lsquo;<samp>OBJECTS</samp>&rsquo; it will not be set on the <code>make</code> command line.
This can be useful in conjunction with implicit rules to allow other
types of source code to be compiled and included in the shared object.
It can also be used to control the set of files which are compiled,
either by excluding some files in &lsquo;<tt>src</tt>&rsquo; or including some files in
subdirectories.  For example
</p>
<table><tr><td>&nbsp;</td><td><pre class="example">OBJECTS = 4dfp/endianio.o 4dfp/Getifh.o R4dfp-object.o
</pre></td></tr></table>


<p>Note that &lsquo;<tt>Makevars</tt>&rsquo; should not normally contain targets, as it is
included before the default makefile and <code>make</code> will call the
first target, intended to be <code>all</code> in the default makefile.  If you
really need to circumvent that, use a suitable (phony) target <code>all</code>
before any actual targets in &lsquo;<tt>Makevars.[win]</tt>&rsquo;: for example package
<a href="http://CRAN.R-project.org/package=fastICA"><strong>fastICA</strong></a> has
</p>
<table><tr><td>&nbsp;</td><td><pre class="smallexample">PKG_LIBS = @BLAS_LIBS@

SLAMC_FFLAGS=$(R_XTRA_FFLAGS) $(FPICFLAGS) $(SHLIB_FFLAGS) $(SAFE_FFLAGS)

all: $(SHLIB)

slamc.o: slamc.f
        $(F77) $(SLAMC_FFLAGS) -c -o slamc.o slamc.f
</pre></td></tr></table>

<p>needed to ensure that the LAPACK routines find some constants without
infinite looping.  The Windows equivalent is
</p>
<table><tr><td>&nbsp;</td><td><pre class="smallexample">all: $(SHLIB)

slamc.o: slamc.f
        $(F77) $(SAFE_FFLAGS) -c -o slamc.o slamc.f
</pre></td></tr></table>

<p>(since the other macros are all empty on that platform, and R&rsquo;s
internal BLAS is not used).  Note that the first target in
&lsquo;<tt>Makevars</tt>&rsquo; will be called, but for back-compatibility it is best
named <code>all</code>.
</p>
<p>If you want to create and then link to a library, say using code in a
subdirectory, use something like
</p>
<table><tr><td>&nbsp;</td><td><pre class="smallexample">.PHONY: all mylibs

all: $(SHLIB)
$(SHLIB): mylibs

mylibs:
        (cd subdir; make)
</pre></td></tr></table>

<p>Be careful to create all the necessary dependencies, as there is a no
guarantee that the dependencies of <code>all</code> will be run in a
particular order (and some of the <acronym>CRAN</acronym> build machines use
multiple CPUs and parallel makes).
</p>
<p>Note that on Windows it is required that &lsquo;<tt>Makevars[.win]</tt>&rsquo; does
create a DLL: this is needed as it is the only reliable way to ensure
that building a DLL succeeded.  If you want to use the &lsquo;<tt>src</tt>&rsquo;
directory for some purpose other than building a DLL, use a
&lsquo;<tt>Makefile.win</tt>&rsquo; file.
</p>
<p>It is sometimes useful to have a target &lsquo;<samp>clean</samp>&rsquo; in &lsquo;<tt>Makevars</tt>&rsquo;
or &lsquo;<tt>Makevars.win</tt>&rsquo;: this will be used by <code>R CMD build</code> to
clean up (a copy of) the package sources.  When it is run by
<code>build</code> it will have fewer macros set, in particular not
<code>$(SHLIB)</code>, nor <code>$(OBJECTS)</code> unless set in the file itself.
It would also be possible to add tasks to the target &lsquo;<samp>shlib-clean</samp>&rsquo;
which is run by <code>R CMD INSTALL</code> and <code>R CMD SHLIB</code> with
options &lsquo;<samp>--clean</samp>&rsquo; and &lsquo;<samp>--preclean</samp>&rsquo;.
</p>
<p>If you want to run R code in &lsquo;<tt>Makevars</tt>&rsquo;, e.g. to find
configuration information, please do ensure that you use the correct
copy of <code>R</code> or <code>Rscript</code>: there might not be one in the path
at all, or it might be the wrong version or architecture.  The correct
way to do this is <em>via</em>
</p>
<table><tr><td>&nbsp;</td><td><pre class="example">&quot;$(R_HOME)/bin$(R_ARCH_BIN)/Rscript&quot; <var>filename</var>
&quot;$(R_HOME)/bin$(R_ARCH_BIN)/Rscript&quot; -e '<var>R expression</var>'
</pre></td></tr></table>

<p>where <code>$(R_ARCH_BIN)</code> is only needed currently on Windows.
</p>
<p>Environment or make variables can be used to select different macros for
32- and 64-bit code, for example (GNU <code>make</code> syntax, allowed on
Windows)
</p>
<table><tr><td>&nbsp;</td><td><pre class="example">ifeq &quot;$(WIN)&quot; &quot;64&quot;
PKG_LIBS = <var>value for 64-bit Windows</var>
else
PKG_LIBS = <var>value for 32-bit Windows</var>
endif
</pre></td></tr></table>

<p>On Windows there is normally a choice between linking to an import
library or directly to a DLL.  Where possible, the latter is much more
reliable: import libraries are tied to a specific toolchain, and in
particular on 64-bit Windows two different conventions have been
commonly used.  So for example instead of
</p>
<table><tr><td>&nbsp;</td><td><pre class="example">PKG_LIBS = -L$(XML_DIR)/lib -lxml2
</pre></td></tr></table>

<p>one can use
</p>
<table><tr><td>&nbsp;</td><td><pre class="example">PKG_LIBS = -L$(XML_DIR)/bin -lxml2
</pre></td></tr></table>

<p>since on Windows <code>-lxxx</code> will look in turn for
</p>
<table><tr><td>&nbsp;</td><td><pre class="example">libxxx.dll.a
xxx.dll.a
libxxx.a
xxx.lib
libxxx.dll
xxx.dll
</pre></td></tr></table>

<p>where the first and second are conventionally import libraries, the
third and fourth often static libraries (with <code>.lib</code> intended for
Visual C++), but might be import libraries.  See for example
<a href="http://sourceware.org/binutils/docs-2.20/ld/WIN32.html#WIN32">http://sourceware.org/binutils/docs-2.20/ld/WIN32.html#WIN32</a>.
</p>
<p>The fly in the ointment is that the DLL might not be named
&lsquo;<tt>libxxx.dll</tt>&rsquo;, and in fact on 32-bit Windows there is a
&lsquo;<tt>libxml2.dll</tt>&rsquo; whereas on one build for 64-bit Windows the DLL is
called &lsquo;<tt>libxml2-2.dll</tt>&rsquo;.  Using import libraries can cover over
these differences but can cause equal difficulties.
</p>
<p>If static libraries are available they can save a lot of problems with
run-time finding of DLLs, especially when binary packages are to be
distributed and even more when these support both architectures.  Where
using DLLs is unavoidable we normally arrange (<em>via</em>
&lsquo;<tt>configure.win</tt>&rsquo;) to ship them in the same directory as the package
DLL.
</p>
<hr size="6">
<a name="OpenMP-support"></a>
<table cellpadding="1" cellspacing="1" border="0">
<tr><td valign="middle" align="left">[<a href="#Using-Makevars" title="Previous section in reading order"> &lt; </a>]</td>
<td valign="middle" align="left">[<a href="#Using-pthreads" title="Next section in reading order"> &gt; </a>]</td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left">[<a href="#Creating-R-packages" title="Beginning of this chapter or previous chapter"> &lt;&lt; </a>]</td>
<td valign="middle" align="left">[<a href="#Using-Makevars" title="Up section"> Up </a>]</td>
<td valign="middle" align="left">[<a href="#Writing-R-documentation-files" title="Next chapter"> &gt;&gt; </a>]</td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left">[<a href="#Top" title="Cover (top) of document">Top</a>]</td>
<td valign="middle" align="left">[<a href="#SEC_Contents" title="Table of contents">Contents</a>]</td>
<td valign="middle" align="left">[<a href="#Function-and-variable-index" title="Index">Index</a>]</td>
<td valign="middle" align="left">[<a href="#SEC_About" title="About (help)"> ? </a>]</td>
</tr></table>
<a name="OpenMP-support-1"></a>
<h4 class="subsubsection">1.2.1.1 OpenMP support</h4>

<a name="index-OpenMP"></a>

<p>There is some support for packages which wish to use
OpenMP<a name="DOCF21" href="#FOOT21">(21)</a>.  The
<code>make</code> macros
</p>
<table><tr><td>&nbsp;</td><td><pre class="example">SHLIB_OPENMP_CFLAGS
SHLIB_OPENMP_CXXFLAGS
SHLIB_OPENMP_FCFLAGS
SHLIB_OPENMP_FFLAGS
</pre></td></tr></table>

<p>are available for use in &lsquo;<tt>src/Makevars</tt>&rsquo; or
&lsquo;<tt>src/Makevars.win</tt>&rsquo;.<a name="DOCF22" href="#FOOT22">(22)</a>
Include the appropriate macro in <code>PKG_CFLAGS</code>, <code>PKG_CPPFLAGS</code>
and so on, and also in <code>PKG_LIBS</code>.  C/C++ code that needs to be
conditioned on the use of OpenMP can be used inside <code>#ifdef
SUPPORT_OPENMP</code>, a macro defined in the header &lsquo;<tt>Rconfig.h</tt>&rsquo;
(see section <a href="#Platform-and-version-information">Platform and version information</a>): however the use of OpenMP is
most often indicated by &lsquo;<samp>#pragma</samp>&rsquo; statements.
</p>
<p>For example, a package with C code written for OpenMP should have in
&lsquo;<tt>src/Makevars</tt>&rsquo; the lines
</p>
<table><tr><td>&nbsp;</td><td><pre class="example">PKG_CFLAGS = $(SHLIB_OPENMP_CFLAGS)
PKG_LIBS = $(SHLIB_OPENMP_CFLAGS)
</pre></td></tr></table>

<p>There is nothing to say what version of OpenMP is supported: version 3.0
(May 2008) is supported by recent versions of the main platforms (but
note that Mac OS X binaries are currently built for 10.5 using compilers
which support version 2.5), but portable packages cannot assume that end
users have recent versions (there are some years-old versions of Linux
in use), and it may be safest to assume version 2.5.
</p>
<p>C/C++ code written to use OpenMP should include <code>omp</code> pragmas and
other OpenMP-specific code in <code>#ifdef _OPENMP ... #endif</code>.
</p>
<p>OpenMP support is available on Windows in the toolchain used for R
2.15.0 and these macros will be set appropriately.
</p>
<p>The performance of OpenMP varies substantially between platforms.  Both
the Mac OS X and Windows implementations have substantial overheads and
are only beneficial if quite substantial tasks are run in parallel.
</p>
<p>Calling any of the R API from threaded code is &lsquo;for experts only&rsquo;:
they will need to read the source code to determine if it is
thread-safe.  In particular, code which makes use of the stack-checking
mechanism must not be called from threaded code.
</p>
<hr size="6">
<a name="Using-pthreads"></a>
<table cellpadding="1" cellspacing="1" border="0">
<tr><td valign="middle" align="left">[<a href="#OpenMP-support" title="Previous section in reading order"> &lt; </a>]</td>
<td valign="middle" align="left">[<a href="#Compiling-in-sub_002ddirectories" title="Next section in reading order"> &gt; </a>]</td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left">[<a href="#Creating-R-packages" title="Beginning of this chapter or previous chapter"> &lt;&lt; </a>]</td>
<td valign="middle" align="left">[<a href="#Using-Makevars" title="Up section"> Up </a>]</td>
<td valign="middle" align="left">[<a href="#Writing-R-documentation-files" title="Next chapter"> &gt;&gt; </a>]</td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left">[<a href="#Top" title="Cover (top) of document">Top</a>]</td>
<td valign="middle" align="left">[<a href="#SEC_Contents" title="Table of contents">Contents</a>]</td>
<td valign="middle" align="left">[<a href="#Function-and-variable-index" title="Index">Index</a>]</td>
<td valign="middle" align="left">[<a href="#SEC_About" title="About (help)"> ? </a>]</td>
</tr></table>
<a name="Using-pthreads-1"></a>
<h4 class="subsubsection">1.2.1.2 Using pthreads</h4>

<p>There is no direct support for the POSIX threads (more commonly known as
<code>pthreads</code>): by the time we considered adding it several packages
were using it unconditionally so it seems that nowadays it is
universally available on POSIX operating systems (hence not Windows).
</p>
<p>For reasonably recent versions of <code>gcc</code> the correct
specification is
</p>
<table><tr><td>&nbsp;</td><td><pre class="example">PKG_CPPFLAGS = -pthread
PKG_LIBS = -pthread
</pre></td></tr></table>

<p>(and the plural version is also accepted on some systems/versions).  For
other platforms the specification is
</p>
<table><tr><td>&nbsp;</td><td><pre class="example">PKG_CPPFLAGS = -D_REENTRANT
PKG_LIBS = -lpthread
</pre></td></tr></table>
<p>(and note that the library name is singular).  This is what
&lsquo;<samp>-pthread</samp>&rsquo; does on all known current platforms (although earlier
version of OpenBSD used a different library name).
</p>
<p>For a tutorial see
<a href="https://computing.llnl.gov/tutorials/pthreads/">https://computing.llnl.gov/tutorials/pthreads/</a>.
</p>
<p>POSIX threads are not normally used on Windows, which has its own native
concepts of threads.  However, there are two projects implementing
<code>pthreads</code> on top of Windows, <code>pthreads-w32</code> and
<code>winpthreads</code> (a recent part of the MinGW-w64 project).
</p>
<p>Whether Windows toolchains implement <code>pthreads</code> is up to the
toolchain provider: the toolchain recommended for R 2.14.2 and later
does by default provide it.  The toolchains used to compile R prior
to version 2.14.2 do not contain <code>pthreads</code>, although in some cases
<code>pthreads-w32</code> could be retro-fitted.  As from R 2.14.2 a
<code>make</code> variable <code>SHLIB_PTHREAD_FLAGS</code> is available: this
should be included in both <code>PKG_CPPFLAGS</code> (or the Fortran or F9x
equivalents) and <code>PKG_LIBS</code>.
</p>
<p>The presence of a working <code>pthreads</code> implementation cannot be
unambiguously determined without testing for yourself: however, that
&lsquo;<samp>_REENTRANT</samp>&rsquo; is defined<a name="DOCF23" href="#FOOT23">(23)</a> in C/C++ code is a good indication.
</p>
<p>See also the comments on thread-safety and performance under OpenMP: on
all known R platforms OpenMP is implemented <em>via</em>
<code>pthreads</code> and the known performance issues are in the latter.
</p>
<hr size="6">
<a name="Compiling-in-sub_002ddirectories"></a>
<table cellpadding="1" cellspacing="1" border="0">
<tr><td valign="middle" align="left">[<a href="#Using-pthreads" title="Previous section in reading order"> &lt; </a>]</td>
<td valign="middle" align="left">[<a href="#Configure-example" title="Next section in reading order"> &gt; </a>]</td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left">[<a href="#Creating-R-packages" title="Beginning of this chapter or previous chapter"> &lt;&lt; </a>]</td>
<td valign="middle" align="left">[<a href="#Using-Makevars" title="Up section"> Up </a>]</td>
<td valign="middle" align="left">[<a href="#Writing-R-documentation-files" title="Next chapter"> &gt;&gt; </a>]</td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left">[<a href="#Top" title="Cover (top) of document">Top</a>]</td>
<td valign="middle" align="left">[<a href="#SEC_Contents" title="Table of contents">Contents</a>]</td>
<td valign="middle" align="left">[<a href="#Function-and-variable-index" title="Index">Index</a>]</td>
<td valign="middle" align="left">[<a href="#SEC_About" title="About (help)"> ? </a>]</td>
</tr></table>
<a name="Compiling-in-sub_002ddirectories-1"></a>
<h4 class="subsubsection">1.2.1.3 Compiling in sub-directories</h4>

<p>Package authors fairly often want to organize code in sub-directories of
&lsquo;<tt>src</tt>&rsquo;, for example if they are including a separate piece of
external software to which this is an R interface.
</p>
<p>One simple way is simply to set <code>OBJECTS</code> to be all the objects
that need to be compiled, including in sub-directories.  For example,
CRAN package <a href="http://CRAN.R-project.org/package=RSiena"><strong>RSiena</strong></a> has
</p>
<table><tr><td>&nbsp;</td><td><pre class="smallexample">SOURCES = $(wildcard data/*.cpp network/*.cpp utils/*.cpp model/*.cpp model/*/*.cpp model/*/*/*.cpp)

OBJECTS = siena07utilities.o siena07internals.o siena07setup.o siena07models.o $(SOURCES:.cpp=.o)
</pre></td></tr></table>

<p>One problem with that approach is that unless GNU make extensions are
used, the source files need to be listed and kept up-to-date.  As in the
following from CRAN package <a href="http://CRAN.R-project.org/package=lossDev"><strong>lossDev</strong></a>:
</p>
<table><tr><td>&nbsp;</td><td><pre class="smallexample">OBJECTS.samplers = samplers/ExpandableArray.o samplers/Knots.o \
  samplers/RJumpSpline.o samplers/RJumpSplineFactory.o \
  samplers/RealSlicerOV.o samplers/SliceFactoryOV.o samplers/MNorm.o
OBJECTS.distributions = distributions/DSpline.o \
  distributions/DChisqrOV.o distributions/DTOV.o \
  distributions/DNormOV.o distributions/DUnifOV.o distributions/RScalarDist.o
OBJECTS.root = RJump.o

OBJECTS = $(OBJECTS.samplers) $(OBJECTS.distributions) $(OBJECTS.root)
</pre></td></tr></table>

<p>Where the subdirectory is self-contained code with a suitable makefile,
the best approach is something like
</p>
<table><tr><td>&nbsp;</td><td><pre class="smallexample">PKG_LIBS = -LCsdp/lib -lsdp $(LAPACK_LIBS) $(BLAS_LIBS) $(FLIBS)

$(SHLIB): Csdp/lib/libsdp.a

Csdp/lib/libsdp.a
        @(cd Csdp/lib &amp;&amp; $(MAKE) libsdp.a \
          CC=&quot;$(CC)&quot; CFLAGS=&quot;$(CFLAGS) $(CPICFLAGS)&quot; AR=&quot;$(AR)&quot; RANLIB=&quot;$(RANLIB)&quot;)
</pre></td></tr></table>

<p>Note the quotes: the macros can contain spaces, e.g. <code>gcc -m64
-std=gnu99</code>.  Several authors have forgotten about parallel makes: the
static library in the subdirectory must be made before the shared
library and so must depend on the latter.  Others forget the need for
position-independent code.
</p>
<p>We really do not recommend using a &lsquo;<tt>src/Makefile</tt>&rsquo; instead on
&lsquo;<tt>src/Makevars</tt>&rsquo;, and as the example above shows, it is not necessary.
</p>
<hr size="6">
<a name="Configure-example"></a>
<table cellpadding="1" cellspacing="1" border="0">
<tr><td valign="middle" align="left">[<a href="#Compiling-in-sub_002ddirectories" title="Previous section in reading order"> &lt; </a>]</td>
<td valign="middle" align="left">[<a href="#Using-F95-code" title="Next section in reading order"> &gt; </a>]</td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left">[<a href="#Creating-R-packages" title="Beginning of this chapter or previous chapter"> &lt;&lt; </a>]</td>
<td valign="middle" align="left">[<a href="#Configure-and-cleanup" title="Up section"> Up </a>]</td>
<td valign="middle" align="left">[<a href="#Writing-R-documentation-files" title="Next chapter"> &gt;&gt; </a>]</td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left">[<a href="#Top" title="Cover (top) of document">Top</a>]</td>
<td valign="middle" align="left">[<a href="#SEC_Contents" title="Table of contents">Contents</a>]</td>
<td valign="middle" align="left">[<a href="#Function-and-variable-index" title="Index">Index</a>]</td>
<td valign="middle" align="left">[<a href="#SEC_About" title="About (help)"> ? </a>]</td>
</tr></table>
<a name="Configure-example-1"></a>
<h3 class="subsection">1.2.2 Configure example</h3>

<p>It may be helpful to give an extended example of using a
&lsquo;<tt>configure</tt>&rsquo; script to create a &lsquo;<tt>src/Makevars</tt>&rsquo; file: this is
based on that in the <a href="http://CRAN.R-project.org/package=RODBC"><strong>RODBC</strong></a> package.
</p>
<p>The &lsquo;<tt>configure.ac</tt>&rsquo; file follows: &lsquo;<tt>configure</tt>&rsquo; is created from
this by running <code>autoconf</code> in the top-level package directory
(containing &lsquo;<tt>configure.ac</tt>&rsquo;).
</p>
<blockquote><table><tr><td>&nbsp;</td><td><pre class="smallexample">AC_INIT([RODBC], 1.1.8) dnl package name, version

dnl A user-specifiable option
odbc_mgr=&quot;&quot;
AC_ARG_WITH([odbc-manager],
            AC_HELP_STRING([--with-odbc-manager=MGR],
                           [specify the ODBC manager, e.g. odbc or iodbc]),
            [odbc_mgr=$withval])

if test &quot;$odbc_mgr&quot; = &quot;odbc&quot; ; then
  AC_PATH_PROGS(ODBC_CONFIG, odbc_config)
fi

dnl Select an optional include path, from a configure option
dnl or from an environment variable.
AC_ARG_WITH([odbc-include],
            AC_HELP_STRING([--with-odbc-include=INCLUDE_PATH],
                           [the location of ODBC header files]),
            [odbc_include_path=$withval])
RODBC_CPPFLAGS=&quot;-I.&quot;
if test [ -n &quot;$odbc_include_path&quot; ] ; then
   RODBC_CPPFLAGS=&quot;-I. -I${odbc_include_path}&quot;
else
  if test [ -n &quot;${ODBC_INCLUDE}&quot; ] ; then
     RODBC_CPPFLAGS=&quot;-I. -I${ODBC_INCLUDE}&quot;
  fi
fi

dnl ditto for a library path
AC_ARG_WITH([odbc-lib],
            AC_HELP_STRING([--with-odbc-lib=LIB_PATH],
                           [the location of ODBC libraries]),
            [odbc_lib_path=$withval])
if test [ -n &quot;$odbc_lib_path&quot; ] ; then
   LIBS=&quot;-L$odbc_lib_path ${LIBS}&quot;
else
  if test [ -n &quot;${ODBC_LIBS}&quot; ] ; then
     LIBS=&quot;-L${ODBC_LIBS} ${LIBS}&quot;
  else
    if test -n &quot;${ODBC_CONFIG}&quot;; then
      odbc_lib_path=`odbc_config --libs | sed s/-lodbc//`
      LIBS=&quot;${odbc_lib_path} ${LIBS}&quot;
    fi
  fi
fi

dnl Now find the compiler and compiler flags to use
: ${R_HOME=`R RHOME`}
if test -z &quot;${R_HOME}&quot;; then
  echo &quot;could not determine R_HOME&quot;
  exit 1
fi
CC=`&quot;${R_HOME}/bin/R&quot; CMD config CC`
CPP=`&quot;${R_HOME}/bin/R&quot; CMD config CPP`
CFLAGS=`&quot;${R_HOME}/bin/R&quot; CMD config CFLAGS`
CPPFLAGS=`&quot;${R_HOME}/bin/R&quot; CMD config CPPFLAGS`
AC_PROG_CC
AC_PROG_CPP


if test -n &quot;${ODBC_CONFIG}&quot;; then
  RODBC_CPPFLAGS=`odbc_config --cflags`
fi
CPPFLAGS=&quot;${CPPFLAGS} ${RODBC_CPPFLAGS}&quot;

dnl Check the headers can be found
AC_CHECK_HEADERS(sql.h sqlext.h)
if test &quot;${ac_cv_header_sql_h}&quot; = no ||
   test &quot;${ac_cv_header_sqlext_h}&quot; = no; then
   AC_MSG_ERROR(&quot;ODBC headers sql.h and sqlext.h not found&quot;)
fi

dnl search for a library containing an ODBC function
if test [ -n &quot;${odbc_mgr}&quot; ] ; then
  AC_SEARCH_LIBS(SQLTables, ${odbc_mgr}, ,
      AC_MSG_ERROR(&quot;ODBC driver manager ${odbc_mgr} not found&quot;))
else
  AC_SEARCH_LIBS(SQLTables, odbc odbc32 iodbc, ,
      AC_MSG_ERROR(&quot;no ODBC driver manager found&quot;))
fi

dnl for 64-bit ODBC need SQL[U]LEN, and it is unclear where they are defined.
AC_CHECK_TYPES([SQLLEN, SQLULEN], , , [# include &lt;sql.h&gt;])
dnl for unixODBC header
AC_CHECK_SIZEOF(long, 4)

dnl substitute RODBC_CPPFLAGS and LIBS
AC_SUBST(RODBC_CPPFLAGS)
AC_SUBST(LIBS)
AC_CONFIG_HEADERS([src/config.h])
dnl and do substitution in the src/Makevars.in and src/config.h
AC_CONFIG_FILES([src/Makevars])
AC_OUTPUT
</pre></td></tr></table>
</blockquote>

<p>where &lsquo;<tt>src/Makevars.in</tt>&rsquo; would be simply
</p>
<blockquote><table><tr><td>&nbsp;</td><td><pre class="example">PKG_CPPFLAGS = @RODBC_CPPFLAGS@
PKG_LIBS = @LIBS@
</pre></td></tr></table>
</blockquote>

<p>A user can then be advised to specify the location of the ODBC driver
manager files by options like (lines broken for easier reading)
</p>
<table><tr><td>&nbsp;</td><td><pre class="example">R CMD INSTALL \
  --configure-args='--with-odbc-include=/opt/local/include \
  --with-odbc-lib=/opt/local/lib --with-odbc-manager=iodbc' \
  RODBC
</pre></td></tr></table>

<p>or by setting the environment variables <code>ODBC_INCLUDE</code> and
<code>ODBC_LIBS</code>.
</p>
<hr size="6">
<a name="Using-F95-code"></a>
<table cellpadding="1" cellspacing="1" border="0">
<tr><td valign="middle" align="left">[<a href="#Configure-example" title="Previous section in reading order"> &lt; </a>]</td>
<td valign="middle" align="left">[<a href="#Checking-and-building-packages" title="Next section in reading order"> &gt; </a>]</td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left">[<a href="#Creating-R-packages" title="Beginning of this chapter or previous chapter"> &lt;&lt; </a>]</td>
<td valign="middle" align="left">[<a href="#Configure-and-cleanup" title="Up section"> Up </a>]</td>
<td valign="middle" align="left">[<a href="#Writing-R-documentation-files" title="Next chapter"> &gt;&gt; </a>]</td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left">[<a href="#Top" title="Cover (top) of document">Top</a>]</td>
<td valign="middle" align="left">[<a href="#SEC_Contents" title="Table of contents">Contents</a>]</td>
<td valign="middle" align="left">[<a href="#Function-and-variable-index" title="Index">Index</a>]</td>
<td valign="middle" align="left">[<a href="#SEC_About" title="About (help)"> ? </a>]</td>
</tr></table>
<a name="Using-F95-code-1"></a>
<h3 class="subsection">1.2.3 Using F95 code</h3>

<p>R assumes that source files with extension &lsquo;<tt>.f</tt>&rsquo; are FORTRAN 77,
and passes them to the compiler specified by &lsquo;<samp>F77</samp>&rsquo;.  On most but
not all platforms that compiler will accept Fortran 90/95 code: some
platforms have a separate Fortran 90/95 compiler and a few (by now quite
rare<a name="DOCF24" href="#FOOT24">(24)</a>) platforms have no Fortran
90/95 support.
</p>
<p>This means that portable packages need to be written in correct
FORTRAN 77, which will also be valid Fortran 95.  See
<a href="http://developer.r-project.org/Portability.html">http://developer.r-project.org/Portability.html</a> for reference
resources.  In particular, <em>free source form</em> F95 code is not
portable.
</p>
<p>On some systems an alternative F95 compiler is available: from the
<code>gcc</code> family this might be <code>gfortran</code> or <code>g95</code>.
Configuring R will try to find a compiler which (from its name)
appears to be a Fortran 90/95 compiler, and set it in macro &lsquo;<samp>FC</samp>&rsquo;.
Note that it does not check that such a compiler is fully (or even
partially) compliant with Fortran 90/95.  Packages making use of Fortran
90/95 features should use file extension &lsquo;<tt>.f90</tt>&rsquo; or &lsquo;<tt>.f95</tt>&rsquo; for
the source files: the variable <code>PKG_FCFLAGS</code> specifies any special
flags to be used.  There is no guarantee that compiled Fortran 90/95
code can be mixed with any other type of compiled code, nor that a build
of R will have support for such packages.
</p>
<p>Some (but not) all compilers specified by the &lsquo;<samp>FC</samp>&rsquo; macro will
accept Fortran 2003 or 2008 code.  For platforms using
<code>gfortran</code>, you may need to include &lsquo;<samp>-std=f2003</samp>&rsquo; or
&lsquo;<samp>-std=f2008</samp>&rsquo; in <code>PKG_FCFLAGS</code>: the default is &lsquo;GNU Fortran&rsquo;,
Fortran 95 with non-standard extensions.  The Solaris <code>f95</code>
compiler &lsquo;accepts some Fortran 2003 features&rsquo;.  Such code should still
use file extension &lsquo;<tt>.f90</tt>&rsquo; or &lsquo;<tt>.f95</tt>&rsquo;.
</p>
<hr size="6">
<a name="Checking-and-building-packages"></a>
<table cellpadding="1" cellspacing="1" border="0">
<tr><td valign="middle" align="left">[<a href="#Using-F95-code" title="Previous section in reading order"> &lt; </a>]</td>
<td valign="middle" align="left">[<a href="#Checking-packages" title="Next section in reading order"> &gt; </a>]</td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left">[<a href="#Creating-R-packages" title="Beginning of this chapter or previous chapter"> &lt;&lt; </a>]</td>
<td valign="middle" align="left">[<a href="#Creating-R-packages" title="Up section"> Up </a>]</td>
<td valign="middle" align="left">[<a href="#Writing-R-documentation-files" title="Next chapter"> &gt;&gt; </a>]</td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left">[<a href="#Top" title="Cover (top) of document">Top</a>]</td>
<td valign="middle" align="left">[<a href="#SEC_Contents" title="Table of contents">Contents</a>]</td>
<td valign="middle" align="left">[<a href="#Function-and-variable-index" title="Index">Index</a>]</td>
<td valign="middle" align="left">[<a href="#SEC_About" title="About (help)"> ? </a>]</td>
</tr></table>
<a name="Checking-and-building-packages-1"></a>
<h2 class="section">1.3 Checking and building packages</h2>

<p>Before using these tools, please check that your package can be
installed and loaded.  <code>R CMD check</code> will <em>inter alia</em> do
this, but you may get more detailed error messages doing the checks
directly.
</p>
<table class="menu" border="0" cellspacing="0">
<tr><td align="left" valign="top"><a href="#Checking-packages">1.3.1 Checking packages</a></td><td>&nbsp;&nbsp;</td><td align="left" valign="top">           
</td></tr>
<tr><td align="left" valign="top"><a href="#Building-package-tarballs">1.3.2 Building package tarballs</a></td><td>&nbsp;&nbsp;</td><td align="left" valign="top">   
</td></tr>
<tr><td align="left" valign="top"><a href="#Building-binary-packages">1.3.3 Building binary packages</a></td><td>&nbsp;&nbsp;</td><td align="left" valign="top">    
</td></tr>
</table>

<p>If your package specifies an encoding in its &lsquo;<tt>DESCRIPTION</tt>&rsquo; file,
you should run these tools in a locale which makes use of that encoding:
they may not work at all or may work incorrectly in other locales
(although UTF-8 locales will most likely work).
</p>
<blockquote><p><b>Note:</b> <code>R CMD check</code> and <code>R CMD build</code> run R with
&lsquo;<samp>--vanilla</samp>&rsquo;, so none of the user&rsquo;s startup files are read.  If
you need <code>R_LIBS</code> set (to find packages in a non-standard library)
you can set it in the environment: also you can use the check and build
environment files (as specified by the environment variables
<code>R_CHECK_ENVIRON</code> and <code>R_BUILD_ENVIRON</code>; if unset,
files<a name="DOCF25" href="#FOOT25">(25)</a>  &lsquo;<tt>~/.R/check.Renviron</tt>&rsquo; and
&lsquo;<tt>~/.R/build.Renviron</tt>&rsquo; are used) to set environment variables when
using these utilities.
</p></blockquote>

<blockquote><p><b>Note to Windows users:</b> <code>R CMD build</code> will make use of the Windows toolset (see the &ldquo;R
Installation and Administration&rdquo; manual) if present and in your path,
and it is required for packages which need it to install (including
those with &lsquo;<tt>configure.win</tt>&rsquo; or &lsquo;<tt>cleanup.win</tt>&rsquo; scripts or a
&lsquo;<tt>src</tt>&rsquo; directory).  
</p>
<p>You may need to set <code>TMPDIR</code> to point to a suitable writable
directory with a path not containing spaces &ndash; use forward slashes for
the separators.  Also, the directory needs to be on a case-honouring
file system (some network-mounted file systems are not).
</p></blockquote>


<hr size="6">
<a name="Checking-packages"></a>
<table cellpadding="1" cellspacing="1" border="0">
<tr><td valign="middle" align="left">[<a href="#Checking-and-building-packages" title="Previous section in reading order"> &lt; </a>]</td>
<td valign="middle" align="left">[<a href="#Building-package-tarballs" title="Next section in reading order"> &gt; </a>]</td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left">[<a href="#Creating-R-packages" title="Beginning of this chapter or previous chapter"> &lt;&lt; </a>]</td>
<td valign="middle" align="left">[<a href="#Checking-and-building-packages" title="Up section"> Up </a>]</td>
<td valign="middle" align="left">[<a href="#Writing-R-documentation-files" title="Next chapter"> &gt;&gt; </a>]</td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left">[<a href="#Top" title="Cover (top) of document">Top</a>]</td>
<td valign="middle" align="left">[<a href="#SEC_Contents" title="Table of contents">Contents</a>]</td>
<td valign="middle" align="left">[<a href="#Function-and-variable-index" title="Index">Index</a>]</td>
<td valign="middle" align="left">[<a href="#SEC_About" title="About (help)"> ? </a>]</td>
</tr></table>
<a name="Checking-packages-1"></a>
<h3 class="subsection">1.3.1 Checking packages</h3>
<a name="index-Checking-packages"></a>

<a name="index-R-CMD-check"></a>
<p>Using <code>R CMD check</code>, the R package checker, one can test whether
<em>source</em> R packages work correctly.  It can be run on one or
more directories, or compressed package <code>tar</code> archives with
extension &lsquo;<tt>.tar.gz</tt>&rsquo;, &lsquo;<tt>.tgz</tt>&rsquo;, &lsquo;<tt>.tar.bz2</tt>&rsquo; or
&lsquo;<tt>.tar.xz</tt>&rsquo;.
</p>
<p>It is strongly recommended that the final checks are run on a
<code>tar</code> archive prepared by <code>R CMD build</code>.
</p>
<p>This runs a series of checks, including
</p>
<ol>
<li>
The package is installed.  This will warn about missing cross-references
and duplicate aliases in help files.

</li><li>
The file names are checked to be valid across file systems and supported
operating system platforms.

</li><li>
The files and directories are checked for sufficient permissions
(Unix-alikes only).

</li><li>
The files are checked for binary executables, using a suitable version
of <code>file</code> if available<a name="DOCF26" href="#FOOT26">(26)</a>.  (There may be rare false positives.)

</li><li>
The &lsquo;<tt>DESCRIPTION</tt>&rsquo; file is checked for completeness, and some of its
entries for correctness.  Unless installation tests are skipped,
checking is aborted if the package dependencies cannot be resolved at
run time.  (You may need to set <code>R_LIBS</code> if dependent packages are
in a separate library tree.) One check is that the package name is not
that of a standard package, nor one of the defunct standard packages
(&lsquo;<samp>ctest</samp>&rsquo;, &lsquo;<samp>eda</samp>&rsquo;, &lsquo;<samp>lqs</samp>&rsquo;, &lsquo;<samp>mle</samp>&rsquo;, &lsquo;<samp>modreg</samp>&rsquo;,
&lsquo;<samp>mva</samp>&rsquo;, &lsquo;<samp>nls</samp>&rsquo;, &lsquo;<samp>stepfun</samp>&rsquo; and &lsquo;<samp>ts</samp>&rsquo;).  Another check is
that all packages mentioned in <code>library</code> or <code>require</code>s or from
which the &lsquo;<tt>NAMESPACE</tt>&rsquo; file imports or are called <em>via</em>
<code>::</code> or <code>:::</code> are listed (in &lsquo;<samp>Depends</samp>&rsquo;, &lsquo;<samp>Imports</samp>&rsquo;,
&lsquo;<samp>Suggests</samp>&rsquo;): this is not an exhaustive check of the actual imports.

</li><li>
Available index information (in particular, for demos and vignettes) is
checked for completeness.

</li><li>
The package subdirectories are checked for suitable file names and for
not being empty.  The checks on file names are controlled by the option
&lsquo;<samp>--check-subdirs=<var>value</var></samp>&rsquo;.  This defaults to &lsquo;<samp>default</samp>&rsquo;,
which runs the checks only if checking a tarball: the default can be
overridden by specifying the value as &lsquo;<samp>yes</samp>&rsquo; or &lsquo;<samp>no</samp>&rsquo;.  Further,
the check on the &lsquo;<tt>src</tt>&rsquo; directory is only run if the package
does not contain a &lsquo;<tt>configure</tt>&rsquo; script (which corresponds to the
value &lsquo;<samp>yes-maybe</samp>&rsquo;) and there is no &lsquo;<tt>src/Makefile</tt>&rsquo; or
&lsquo;<tt>src/Makefile.in</tt>&rsquo;.

<p>To allow a &lsquo;<tt>configure</tt>&rsquo; script to generate suitable files, files
ending in &lsquo;<samp>.in</samp>&rsquo; will be allowed in the &lsquo;<tt>R</tt>&rsquo; directory.
</p>
<p>A warning is given for directory names that look like R package check
directories &ndash; many packages have been submitted to <acronym>CRAN</acronym>
containing these.
</p>
</li><li>
The R files are checked for syntax errors.  Bytes which are
non-<acronym>ASCII</acronym> are reported as warnings, but these should be
regarded as errors unless it is known that the package will always be
used in the same locale.

</li><li>
It is checked that the package can be loaded, first with the usual
default packages and then only with package <strong>base</strong> already
loaded. It is checked that the namespace this can be loaded in an empty
session with only the <strong>base</strong> namespace loaded.  (Namespaces and
packages can be loaded very early in the session, before the default
packages are available, so packages should work then.)

</li><li>
The R files are checked for correct calls to <code>library.dynam</code>.
Package startup functions are checked for correct argument lists and
(incorrect) calls to functions which modify the search path or
inappropriately generate messages.  The R code is checked for
possible problems using <a href="http://CRAN.R-project.org/package=codetools"><strong>codetools</strong></a>.  In addition, it is checked
whether S3 methods have all arguments of the corresponding generic, and
whether the final argument of replacement functions is called
&lsquo;<samp>value</samp>&rsquo;.  All foreign function calls (<code>.C</code>, <code>.Fortran</code>,
<code>.Call</code> and <code>.External</code> calls) are tested to see if they have
a <code>PACKAGE</code> argument, and if not, whether the appropriate DLL might
be deduced from the namespace of the package.  Any other calls are
reported.  (The check is generous, and users may want to supplement this
by examining the output of <code>tools::checkFF(&quot;mypkg&quot;, verbose=TRUE)</code>,
especially if the intention were to always use a <code>PACKAGE</code>
argument)

</li><li>
The &lsquo;<tt>Rd</tt>&rsquo; files are checked for correct syntax and metadata,
including the presence of the mandatory fields (<code>\name</code>, <code>\alias</code>,
<code>\title</code> and <code>\description</code>).  The &lsquo;<tt>Rd</tt>&rsquo; name and
title are checked for being non-empty, and there is a check for missing
cross-references (links).

</li><li>
A check is made for missing documentation entries, such as undocumented
user-level objects in the package.

</li><li>
Documentation for functions, data sets, and S4 classes is checked for
consistency with the corresponding code.

</li><li>
It is checked whether all function arguments given in <code>\usage</code>
sections of &lsquo;<tt>Rd</tt>&rsquo; files are documented in the corresponding
<code>\arguments</code> section.

</li><li>
The &lsquo;<tt>data</tt>&rsquo; directory is checked for non-ASCII characters and for
the use of reasonable levels of compression.

</li><li>
C, C++ and FORTRAN source and header files<a name="DOCF27" href="#FOOT27">(27)</a> are tested for
portable (LF-only) line endings.  If there is a &lsquo;<tt>Makefile</tt>&rsquo; or
&lsquo;<tt>Makefile.in</tt>&rsquo; or &lsquo;<tt>Makevars</tt>&rsquo; or &lsquo;<tt>Makevars.in</tt>&rsquo; file under
the &lsquo;<tt>src</tt>&rsquo; directory, it is checked for portable line endings and
the correct use of &lsquo;<samp>$(BLAS_LIBS)</samp>&rsquo; and &lsquo;<samp>$(LAPACK_LIBS)</samp>&rsquo;

<p>Compiled code is checked for symbols corresponding to functions which
might terminate R or write to &lsquo;<tt>stdout</tt>&rsquo;/&lsquo;<tt>stderr</tt>&rsquo; instead of
the console.  Note that the latter might give false positives in that
the symbols might be pulled in with external libraries and could never
be called.  Windows<a name="DOCF28" href="#FOOT28">(28)</a> users
should note that the Fortran and C++ runtime libraries are examples of
such external libraries.
</p>
</li><li>
Some checks are made of the contents of the &lsquo;<tt>inst/doc</tt>&rsquo; directory.
These always include checking for files that look like leftovers, and if
suitable tools (such as <code>qpdf</code>) are available, checking that the
PDF documentation is of minimal size.

</li><li>
The examples provided by the package&rsquo;s documentation are run.
(see section <a href="#Writing-R-documentation-files">Writing R documentation files</a>, for information on using
<code>\examples</code> to create executable example code.)  If there is a file
&lsquo;<tt>tests/Examples/<var>pkg</var>-Ex.Rout.save</tt>&rsquo;, the output of running the
examples is compared to that file.

<p>Of course, released packages should be able to run at least their own
examples.  Each example is run in a &lsquo;clean&rsquo; environment (so earlier
examples cannot be assumed to have been run), and with the variables
<code>T</code> and <code>F</code> redefined to generate an error unless they are set
in the example: See <a href="R-intro.html#Logical-vectors">(R-intro)Logical vectors</a> section &lsquo;Logical vectors&rsquo; in <cite>An Introduction to R</cite>.
</p>
</li><li>
If the package sources contain a &lsquo;<tt>tests</tt>&rsquo; directory then the tests
specified in that directory are run.  (Typically they will consist of a
set of &lsquo;<tt>.R</tt>&rsquo; source files and target output files
&lsquo;<tt>.Rout.save</tt>&rsquo;.)  Please note that the comparison will be done in the
end user&rsquo;s locale, so the target output files should be ASCII if at all
possible.

</li><li>
The code in package vignettes (see section <a href="#Writing-package-vignettes">Writing package vignettes</a>) is
executed, and the vignette PDFs re-made from their sources as a check of
completeness of the sources (unless there is a &lsquo;<samp>BuildVignettes</samp>&rsquo;
field in the package&rsquo;s &lsquo;<tt>DESCRIPTION</tt>&rsquo; file with a false value).  If
there is a target output file &lsquo;<tt>.Rout.save</tt>&rsquo; in the vignette source
directory, the output from running the code in that vignette is compared
with the target output file and any differences are reported (but not
recorded in the log file).  (If the vignette sources are in the
deprecated location &lsquo;<tt>inst/doc</tt>&rsquo;, do mark such target output files to
not be installed in &lsquo;<tt>.Rinstignore</tt>&rsquo;.)

<p>If there is an error<a name="DOCF29" href="#FOOT29">(29)</a> in executing the R code in vignette &lsquo;<tt><var>foo.ext</var></tt>&rsquo;, a log
file &lsquo;<tt><var>foo.ext</var>.log</tt>&rsquo; is created in the check directory.  The
vignette PDFs are re-made in a copy of the package sources in the
&lsquo;<tt>vign_test</tt>&rsquo; subdirectory of the check directory, so for further
information on errors look in directory
&lsquo;<tt><var>pkgname</var>/vign_test/inst/doc</tt>&rsquo;.  (It is only retained if there
are errors or if environment variable <code>_R_CHECK_CLEAN_VIGN_TEST_</code> is
set to a false value.)
</p>
</li><li>
The PDF version of the package&rsquo;s manual is created (to check that the
&lsquo;<tt>Rd</tt>&rsquo; files can be converted successfully).  This needs LaTeX and
suitable fonts and LaTeX packages to be installed.
See the section &lsquo;Making the manuals&rsquo; in the &lsquo;R Installation and
Administration&rsquo; manual&rsquo; for further details.

</li></ol>

<p>All these tests are run with collation set to the <code>C</code> locale, and
for the examples and tests with environment variable <code>LANGUAGE=en</code>:
this is to minimize differences between platforms.
</p>
<p>Use <kbd>R CMD check --help</kbd> to obtain more information about the usage
of the R package checker.  A subset of the checking steps can be
selected by adding command-line options. It also allows customization by
setting environment variables <code>_R_CHECK_*_</code>:, as described in
&lsquo;R Internals&rsquo;:
a set of these customizations similar to those used by <acronym>CRAN</acronym>
can be selected by the option &lsquo;<samp>--as-cran</samp>&rsquo; (which works best if
Internet access is available<a name="DOCF30" href="#FOOT30">(30)</a>).
</p>
<p>You do need to ensure that the package is checked in a suitable locale
if it contains non-<acronym>ASCII</acronym> characters.  Such packages are likely
to fail some of the checks in a <code>C</code> locale, and <code>R CMD
check</code> will warn if it spots the problem.  You should be able to check
any package in a UTF-8 locale (if one is available).  Beware that
although a <code>C</code> locale is rarely used at a console, it may be the
default if logging in remotely or for batch jobs.
</p>
<blockquote><p><b>Multiple sub-architectures:</b> On systems which support multiple sub-architectures (principally Windows
and Mac OS X), <code>R CMD check</code> will install and check a package
which contains compiled code under all available sub-architectures. (Use
option &lsquo;<samp>--force-multiarch</samp>&rsquo; to force this for packages without
compiled code, which are otherwise only checked under the main
sub-architecture.)  This will run the loading tests, examples and
&lsquo;<tt>tests</tt>&rsquo; directory under each installed sub-architecture in turn,
and give an error if any fail.  Where environment variables (including
perhaps <code>PATH</code>) need to be set differently for each
sub-architecture, these can be set in architecture-specific files such
as &lsquo;<tt><var>R_HOME</var>/etc/i386/Renviron.site</tt>&rsquo;.
</p>
<p>An alternative approach is to use <code>R CMD check --no-multiarch</code>
to check the primary sub-architecture, and then to use something like
<code>R --arch=x86_64 CMD check --extra-arch</code> or (Windows)
<code>/path/to/R/bin/x64/Rcmd check --extra-arch</code> to run for each
additional sub-architecture just the checks<a name="DOCF31" href="#FOOT31">(31)</a> which differ by sub-architecture.  (This approach is
required for packages which are installed by <code>R CMD INSTALL
--merge-multiarch</code>.)
</p>
<p>Where packages need additional commands to install all the
sub-architectures these can be supplied by e.g.
&lsquo;<samp>--install-args=--force-biarch</samp>&rsquo;.
</p>       
</blockquote>


<hr size="6">
<a name="Building-package-tarballs"></a>
<table cellpadding="1" cellspacing="1" border="0">
<tr><td valign="middle" align="left">[<a href="#Checking-packages" title="Previous section in reading order"> &lt; </a>]</td>
<td valign="middle" align="left">[<a href="#Building-binary-packages" title="Next section in reading order"> &gt; </a>]</td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left">[<a href="#Creating-R-packages" title="Beginning of this chapter or previous chapter"> &lt;&lt; </a>]</td>
<td valign="middle" align="left">[<a href="#Checking-and-building-packages" title="Up section"> Up </a>]</td>
<td valign="middle" align="left">[<a href="#Writing-R-documentation-files" title="Next chapter"> &gt;&gt; </a>]</td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left">[<a href="#Top" title="Cover (top) of document">Top</a>]</td>
<td valign="middle" align="left">[<a href="#SEC_Contents" title="Table of contents">Contents</a>]</td>
<td valign="middle" align="left">[<a href="#Function-and-variable-index" title="Index">Index</a>]</td>
<td valign="middle" align="left">[<a href="#SEC_About" title="About (help)"> ? </a>]</td>
</tr></table>
<a name="Building-package-tarballs-1"></a>
<h3 class="subsection">1.3.2 Building package tarballs</h3>
<a name="index-Building-source-packages"></a>

<a name="index-R-CMD-build"></a>
<a name="index-Package-builder"></a>
<a name="index-tarballs"></a>
<p>Packages may be distributed in source form as &ldquo;tarballs&rdquo;
(&lsquo;<tt>.tar.gz</tt>&rsquo; files) or in binary form. The source form can be
installed on all platforms with suitable tools and is the usual form for
Unix-like systems; the binary form is platform-specific, and is the more
common distribution form for the Windows and Mac platforms.
</p>
<p>Using <code>R CMD build</code>, the R package builder, one can build R
package tarballs from their sources (for example, for subsequent release).
</p>
<p>Prior to actually building the package in the standard gzipped tar file
format, a few diagnostic checks and cleanups are performed.  In
particular, it is tested whether object indices exist and can be assumed
to be up-to-date, and C, C++ and FORTRAN source files and relevant
makefiles in a &lsquo;<tt>src</tt>&rsquo; directory are tested and converted to LF
line-endings if necessary.
</p>
<p>Run-time checks whether the package works correctly should be performed
using <code>R CMD check</code> prior to invoking the final build procedure.
</p>
<a name="index-_002eRbuildignore-file"></a>
<p>To exclude files from being put into the package, one can specify a list
of exclude patterns in file &lsquo;<tt>.Rbuildignore</tt>&rsquo; in the top-level source
directory.  These patterns should be Perl-like regular expressions (see
the help for <code>regexp</code> in R for the precise details), one per
line, to be matched<a name="DOCF32" href="#FOOT32">(32)</a> against the
file and directory names relative to the top-level package source
directory.  In addition, directories from source control
systems<a name="DOCF33" href="#FOOT33">(33)</a> or from <code>eclipse</code><a name="DOCF34" href="#FOOT34">(34)</a>, directories with names ending &lsquo;<tt>.Rcheck</tt>&rsquo; or
&lsquo;<tt>Old</tt>&rsquo; or &lsquo;<tt>old</tt>&rsquo; and files &lsquo;<tt>GNUMakefile</tt>&rsquo;,
&lsquo;<tt>Read-and-delete-me</tt>&rsquo; or with base names starting with &lsquo;<samp>.#</samp>&rsquo;, or
starting and ending with &lsquo;<samp>#</samp>&rsquo;, or ending in &lsquo;<samp>~</samp>&rsquo;, &lsquo;<samp>.bak</samp>&rsquo; or
&lsquo;<samp>.swp</samp>&rsquo;, are excluded by default.  In addition, those files in the
&lsquo;<tt>R</tt>&rsquo;, &lsquo;<tt>demo</tt>&rsquo; and &lsquo;<tt>man</tt>&rsquo; directories which are flagged by
<code>R CMD check</code> as having invalid names will be excluded.
</p>
<p>Use <kbd>R CMD build --help</kbd> to obtain more information about the usage
of the R package builder.
</p>
<p>Unless <kbd>R CMD build</kbd> is invoked with the &lsquo;<samp>--no-vignettes</samp>&rsquo;
option (or the package&rsquo;s &lsquo;<tt>DESCRIPTION</tt>&rsquo; contains
&lsquo;<samp>BuildVignettes: no</samp>&rsquo; or similar), it will attempt to rebuild the
vignettes (see section <a href="#Writing-package-vignettes">Writing package vignettes</a>) in the package.  To do so
it installs the current package into a temporary library tree, but any
dependent packages need to be installed in an available library tree
(see the Note: at the top of this section).
</p>
<p>Similarly, if the &lsquo;<tt>.Rd</tt>&rsquo; documentation files contain any
<code>\Sexpr</code> macros (see section <a href="#Dynamic-pages">Dynamic pages</a>), the package will be
temporarily installed to execute them.  Post-execution binary copies of
those pages containing build-time macros will be saved in
&lsquo;<tt>build/partial.rdb</tt>&rsquo;.  If there are any install-time or render-time
macros, a &lsquo;<tt>.pdf</tt>&rsquo; version of the package manual will be built and
installed in the &lsquo;<tt>build/</tt>&rsquo; subdirectory.  (This allows
<acronym>CRAN</acronym> or other repositories to display the manual even if they
are unable to install the package.)  This can be suppressed by the
option &lsquo;<samp>--no-manual</samp>&rsquo; or if package&rsquo;s &lsquo;<tt>DESCRIPTION</tt>&rsquo; contains
&lsquo;<samp>BuildManual: no</samp>&rsquo; or similar.
</p>
<p>One of the checks that <code>R CMD build</code> runs is for empty source
directories.  These are in most (but not all) cases unintentional, if
they are intentional use the option &lsquo;<samp>--keep-empty-dirs</samp>&rsquo; (or set
the environment variable <code>_R_BUILD_KEEP_EMPTY_DIRS_</code> to &lsquo;<samp>TRUE</samp>&rsquo;,
or have a &lsquo;<samp>BuildKeepEmpty</samp>&rsquo; field with a true value in the
&lsquo;<tt>DESCRIPTION</tt>&rsquo; file).
</p>
<p>The &lsquo;<samp>--resave-data</samp>&rsquo; option allows saved images (&lsquo;<tt>.rda</tt>&rsquo; and
&lsquo;<tt>.RData</tt>&rsquo; files) in the &lsquo;<tt>data</tt>&rsquo; directory to be optimized for
size.  It will also compress tabular files and convert &lsquo;<tt>.R</tt>&rsquo; files
to saved images.  It can take values <code>no</code>, <code>gzip</code> (the default
if this option is not supplied, which can be changed by setting the
environment variable <code>_R_BUILD_RESAVE_DATA_</code>) and <code>best</code>
(equivalent to giving it without a value), which chooses the most
effective compression.  Using <code>best</code> adds a dependence on <code>R
(&gt;= 2.10)</code> to the &lsquo;<tt>DESCRIPTION</tt>&rsquo; file if <code>bzip2</code> or
<code>xz</code> compression is selected for any of the files.  If this is
thought undesirable, &lsquo;<samp>--resave-data=gzip</samp>&rsquo; (which is the default
if that option is not supplied) will do what compression it can with
<code>gzip</code>.  A package can control how its data is resaved by
supplying a &lsquo;<samp>BuildResaveData</samp>&rsquo; field (with one of the values given
earlier in this paragraph) in its &lsquo;<tt>DESCRIPTION</tt>&rsquo; file.
</p>
<p>The &lsquo;<samp>--compact-vignettes</samp>&rsquo; option will run
<code>tools::compactPDF</code> over the PDF files in &lsquo;<tt>inst/doc</tt>&rsquo; (and its
subdirectories) to losslessly compress them.  This is not enabled by
default (it can be selected by environment variable
<code>_R_BUILD_COMPACT_VIGNETTES_</code>) and needs <code>qpdf</code>
(<a href="http://qpdf.sourceforge.net/">http://qpdf.sourceforge.net/</a>) to be available.
</p>
<p>It can be useful to run <code>R CMD check --check-subdirs=yes</code> on the
built tarball as a final check on the contents.
</p>
<p><code>R CMD build</code> looks a suitable <code>tar</code> program that can
produce a compressed tarball: almost certainly one will have been found
when R was configured on a Unix-alike (and the Windows toolset
contains one), but if an unsuitable one is found, set the environment
variable <code>TAR</code> to the path to a suitable program or to
<code>&quot;internal&quot;</code> if none is available.
</p>
<hr size="6">
<a name="Building-binary-packages"></a>
<table cellpadding="1" cellspacing="1" border="0">
<tr><td valign="middle" align="left">[<a href="#Building-package-tarballs" title="Previous section in reading order"> &lt; </a>]</td>
<td valign="middle" align="left">[<a href="#Writing-package-vignettes" title="Next section in reading order"> &gt; </a>]</td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left">[<a href="#Creating-R-packages" title="Beginning of this chapter or previous chapter"> &lt;&lt; </a>]</td>
<td valign="middle" align="left">[<a href="#Checking-and-building-packages" title="Up section"> Up </a>]</td>
<td valign="middle" align="left">[<a href="#Writing-R-documentation-files" title="Next chapter"> &gt;&gt; </a>]</td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left">[<a href="#Top" title="Cover (top) of document">Top</a>]</td>
<td valign="middle" align="left">[<a href="#SEC_Contents" title="Table of contents">Contents</a>]</td>
<td valign="middle" align="left">[<a href="#Function-and-variable-index" title="Index">Index</a>]</td>
<td valign="middle" align="left">[<a href="#SEC_About" title="About (help)"> ? </a>]</td>
</tr></table>
<a name="Building-binary-packages-1"></a>
<h3 class="subsection">1.3.3 Building binary packages</h3>
<a name="index-Building-binary-packages"></a>

<p>Binary packages are compressed copies of installed versions of
packages.  They contain compiled shared libraries rather than C, C++ or
Fortran source code, and the R functions are included in their installed
form.  The format and filename are platform-specific; for example, a
binary package for Windows is usually supplied as a &lsquo;<tt>.zip</tt>&rsquo; file,
and for the Mac platform the default binary package file extension is
&lsquo;<tt>.tgz</tt>&rsquo;.
</p>
<p>The recommended method of building binary packages is to use
</p>
<p><code>R CMD INSTALL --build pkg</code>
where &lsquo;<tt>pkg</tt>&rsquo; is either the name of a source tarball (in the usual
&lsquo;<tt>.tar.gz</tt>&rsquo; format) or the location of the directory of the package
source to be built.
</p>
<p><code>R CMD INSTALL --build</code> operates by first installing the package
and then packing the installed binaries into
the appropriate binary package file for the particular platform.
</p>
<p>By default, <code>R CMD INSTALL --build</code> will attempt to install the package
into the default library tree for the local installation of R. This has two
implications:
</p>
<ul>
<li>
If the installation is successful, it will overwrite any existing installation
of the same package.

</li><li>
The default library tree must have write permission; if not, the package will
not install and the binary will not be created.

</li></ul>

<p>To prevent changes to the present working installation or to provide an
install location with write access, create a suitably located directory
with write access and use the <code>-l</code> option to build the package
in the chosen location.  The usage is then
</p>
<p><code>R CMD INSTALL -l location --build pkg</code>
</p>
<p>where &lsquo;<tt>location</tt>&rsquo; is the chosen directory with write access. The package
will be installed as a subdirectory of &lsquo;<tt>location</tt>&rsquo;, and the package binary
will be created in the current directory.
</p>
<p>Other options for <code>R CMD INSTALL</code> can be found using
<code>R CMD INSTALL --help</code>, and platform-specific details for special
cases (e.g. handling Fortran sources on Mac OS X) are discussed in the
platform-specific FAQs.
</p>

<p>In earlier versions of R, <code>R CMD build --binary</code> could build
a binary version of a package, but this approach is now deprecated in
favour of <code>R CMD INSTALL --build</code>.
</p>

<p>Finally, at least one web-based service is available for building binary
packages from (checked) source code: WinBuilder (see
<a href="http://win-builder.r-project.org/">http://win-builder.r-project.org/</a>) is able to build Windows
binaries. Note that this is intended for developers on other platforms
who do not have access to Windows but wish to provide binaries for the
Windows platform.
</p>
<hr size="6">
<a name="Writing-package-vignettes"></a>
<table cellpadding="1" cellspacing="1" border="0">
<tr><td valign="middle" align="left">[<a href="#Building-binary-packages" title="Previous section in reading order"> &lt; </a>]</td>
<td valign="middle" align="left">[<a href="#Encodings-and-vignettes" title="Next section in reading order"> &gt; </a>]</td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left">[<a href="#Creating-R-packages" title="Beginning of this chapter or previous chapter"> &lt;&lt; </a>]</td>
<td valign="middle" align="left">[<a href="#Creating-R-packages" title="Up section"> Up </a>]</td>
<td valign="middle" align="left">[<a href="#Writing-R-documentation-files" title="Next chapter"> &gt;&gt; </a>]</td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left">[<a href="#Top" title="Cover (top) of document">Top</a>]</td>
<td valign="middle" align="left">[<a href="#SEC_Contents" title="Table of contents">Contents</a>]</td>
<td valign="middle" align="left">[<a href="#Function-and-variable-index" title="Index">Index</a>]</td>
<td valign="middle" align="left">[<a href="#SEC_About" title="About (help)"> ? </a>]</td>
</tr></table>
<a name="Writing-package-vignettes-1"></a>
<h2 class="section">1.4 Writing package vignettes</h2>
<a name="index-vignettes"></a>
<a name="index-Sweave"></a>

<table class="menu" border="0" cellspacing="0">
<tr><td align="left" valign="top"><a href="#Encodings-and-vignettes">1.4.1 Encodings and vignettes</a></td><td>&nbsp;&nbsp;</td><td align="left" valign="top">
</td></tr>
<tr><td align="left" valign="top"><a href="#Non_002dSweave-vignettes">1.4.2 Non-Sweave vignettes</a></td><td>&nbsp;&nbsp;</td><td align="left" valign="top">
</td></tr>
</table>

<p>In addition to the help files in &lsquo;<tt>Rd</tt>&rsquo; format, R packages allow
the inclusion of documents in arbitrary other formats.  The standard
location for these is subdirectory &lsquo;<tt>inst/doc</tt>&rsquo; of a source package,
the contents will be copied to subdirectory &lsquo;<tt>doc</tt>&rsquo; when the package
is installed.  Pointers from package help indices to the installed
documents are automatically created.  Documents in &lsquo;<tt>inst/doc</tt>&rsquo; can
be in arbitrary format, however we strongly recommend providing them in
PDF format, so users on almost all platforms can easily read them.  To
ensure that they can be accessed from a browser (as an HTML index is
provided), the file names should start with an <acronym>ASCII</acronym> letter
and be comprised entirely of <acronym>ASCII</acronym> letters or digits or hyphen
or underscore.
</p>
<p>A special case are PDF documents with sources in Sweave, which we call
<em>package vignettes</em>.  (Since R version 3.0.0, other vignette
formats besides Sweave are supported; see <a href="#Non_002dSweave-vignettes">Non-Sweave vignettes</a>.)
The preferred location for the sources is the subdirectory
&lsquo;<tt>vignettes</tt>&rsquo; of the source packages, but for compatibility with
earlier versions of R, vignette sources will be looked for in
&lsquo;<tt>inst/doc</tt>&rsquo; if &lsquo;<tt>vignettes</tt>&rsquo; does not exist.
</p>
<p>Vignette sources are normally given the file extension &lsquo;<tt>.Rnw</tt>&rsquo; or
&lsquo;<tt>.Rtex</tt>&rsquo;, but for historical reasons extensions<a name="DOCF35" href="#FOOT35">(35)</a> &lsquo;<tt>.Snw</tt>&rsquo; and &lsquo;<tt>.Stex</tt>&rsquo; are also
recognized as vignettes.  Sweave allows the integration of LaTeX
documents: see the <code>Sweave</code> help page in R and the <code>Sweave</code>
vignette in package <strong>utils</strong> for details on the document format.
Package vignettes are tested by <code>R CMD check</code> by executing all R
code chunks they contain (except those with option <code>eval=FALSE</code>).
The R working directory for all vignette tests in <code>R CMD check</code>
is a <em>copy</em> of the vignette source directory.  Make sure all files
needed to run the R code in the vignette (data sets, &hellip;) are
accessible by either placing them in the &lsquo;<tt>inst/doc</tt>&rsquo; hierarchy of
the source package or by using calls to <code>system.file()</code>.  All other
files needed to re-make the vignette PDFs (such as LaTeX style files,
BiBTeX input files and files for any figures not created by running the
code in the vignette) must in the vignette source directory.
</p>
<p><code>R CMD build</code> will automatically<a name="DOCF36" href="#FOOT36">(36)</a> create PDF
versions of the vignettes in &lsquo;<tt>inst/doc</tt>&rsquo; for distribution with the
package sources.  By including the PDF version in the package sources it
is not necessary that the vignette PDFs can be re-built at install time,
i.e., the package author can use private R packages, screen snapshots
and LaTeX extensions which are only available on his
machine.<a name="DOCF37" href="#FOOT37">(37)</a>
</p>
<p>By default <code>R CMD build</code> will run <code>Sweave</code> on all files in
Sweave format in &lsquo;<tt>vignettes</tt>&rsquo;, or if that does not exist,
&lsquo;<tt>inst/doc</tt>&rsquo; (but not in sub-directories).  If no &lsquo;<tt>Makefile</tt>&rsquo; is
found in directory &lsquo;<tt>inst/doc</tt>&rsquo;, then <code>tools::texi2dvi(pdf =
TRUE)</code> is run on all processed vignettes.  Whenever a &lsquo;<tt>Makefile</tt>&rsquo; is
found, then <code>R CMD build</code> will try to run <code>make</code> after the
<code>Sweave</code> runs.  The first target in the &lsquo;<tt>Makefile</tt>&rsquo; should take
care of both creation of PDF files and cleaning up afterwards (including
after <code>Sweave</code>), i.e., delete all files that shall not appear in
the final package archive.  Note that if the <code>make</code> step runs R
it needs to be careful to respect the environment values of <code>R_LIBS</code>
and <code>R_HOME</code><a name="DOCF38" href="#FOOT38">(38)</a>.
Finally, if there is a &lsquo;<tt>Makefile</tt>&rsquo; and it has a &lsquo;<samp>clean:</samp>&rsquo;
target, <code>make clean</code> is run.
</p>
<p>All the usual <em>caveats</em> about including a &lsquo;<tt>Makefile</tt>&rsquo; apply.
It must be portable (no <acronym>GNU</acronym> extensions), use LF line endings
and must work correctly with a parallel <code>make</code>: too many authors
have written things like
</p>
<table><tr><td>&nbsp;</td><td><pre class="example">## BAD EXAMPLE
all: pdf clean

pdf: ABC-intro.pdf ABC-details.pdf

%.pdf:  %.tex
        texi2dvi --pdf $*

clean:
        rm *.tex ABC-details-*.pdf
</pre></td></tr></table>

<p>which will start removing the source files whilst <code>pdflatex</code> is working.
</p>
<p>Note that it is pointless (and potentially misleading since the files
might be outdated) to include in &lsquo;<tt>inst/doc</tt>&rsquo; R code files which
would be generated from vignettes, as these will be re-generated when
the package is installed (unless the vignette does not generate any R
code, in which case it is also pointless/misleading).
</p>
<p>Metadata lines can be placed in the source file, preferably in LaTeX
comments in the preamble.  One such is a <code>\VignetteIndexEntry</code> of
the form
</p><table><tr><td>&nbsp;</td><td><pre class="example">%\VignetteIndexEntry{Using Animal}
</pre></td></tr></table>
<p>Others you may see are <code>\VignettePackage</code> (currently ignored),
<code>\VignetteDepends</code> and <code>\VignetteKeyword</code> (which replaced
<code>\VignetteKeywords</code>).  These are processed at package installation
time to create the saved data frame &lsquo;<tt>Meta/vignette.rds</tt>&rsquo;, but only
the <code>\VignetteIndexEntry</code> and <code>\VignetteKeyword</code> statements
are currently used.  The <code>\VignetteEngine</code> statement
is described in <a href="#Non_002dSweave-vignettes">Non-Sweave vignettes</a>.
</p>
<p>At install time an <acronym>HTML</acronym> index for all vignettes in the package is
automatically created from the <code>\VignetteIndexEntry</code> statements
unless a file &lsquo;<tt>index.html</tt>&rsquo; exists in directory
&lsquo;<tt>inst/doc</tt>&rsquo;. This index is linked from the <acronym>HTML</acronym> help index for
the package.  If you do supply a &lsquo;<tt>inst/doc/index.html</tt>&rsquo; file it
should contain relative links only to files under the installed
&lsquo;<tt>doc</tt>&rsquo; directory, or perhaps (not really an index) to HTML help
files or to the &lsquo;<tt>DESCRIPTION</tt>&rsquo; file.
</p>
<p>Sweave/Stangle allows the document to specify the <code>split=TRUE</code>
option to create a single R file for each code chunk: this will not
work for vignettes where it is assumed that each vignette source
generates a single file with the vignette extension replaced by
&lsquo;<tt>.R</tt>&rsquo;.
</p>
<p>Do watch that PDFs are not too large &ndash; one in a <acronym>CRAN</acronym> package
was 72MB!  This is usually caused by the inclusion of overly detailed
figures, which will not render well in PDF viewers.  Sometimes it is
much better to generate fairly high resolution bitmap (PNG, JPEG)
figures and include those in the PDF document.
</p>
<a name="index-_002einstall_005fextras-file"></a>
<p>When <code>R CMD build</code> builds the vignette PDFs, it copies these and
the vignette sources from directory &lsquo;<tt>vignettes</tt>&rsquo; to &lsquo;<tt>inst/doc</tt>&rsquo;.
To install any other files from the &lsquo;<tt>vignettes</tt>&rsquo; directory, include
a file &lsquo;<tt>vignettes/.install_extras</tt>&rsquo; which specifies these as
Perl-like regular expressions on one or more lines.  (See the
description of the &lsquo;<tt>.Rinstignore</tt>&rsquo; file for full details.)
</p>

<hr size="6">
<a name="Encodings-and-vignettes"></a>
<table cellpadding="1" cellspacing="1" border="0">
<tr><td valign="middle" align="left">[<a href="#Writing-package-vignettes" title="Previous section in reading order"> &lt; </a>]</td>
<td valign="middle" align="left">[<a href="#Non_002dSweave-vignettes" title="Next section in reading order"> &gt; </a>]</td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left">[<a href="#Creating-R-packages" title="Beginning of this chapter or previous chapter"> &lt;&lt; </a>]</td>
<td valign="middle" align="left">[<a href="#Writing-package-vignettes" title="Up section"> Up </a>]</td>
<td valign="middle" align="left">[<a href="#Writing-R-documentation-files" title="Next chapter"> &gt;&gt; </a>]</td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left">[<a href="#Top" title="Cover (top) of document">Top</a>]</td>
<td valign="middle" align="left">[<a href="#SEC_Contents" title="Table of contents">Contents</a>]</td>
<td valign="middle" align="left">[<a href="#Function-and-variable-index" title="Index">Index</a>]</td>
<td valign="middle" align="left">[<a href="#SEC_About" title="About (help)"> ? </a>]</td>
</tr></table>
<a name="Encodings-and-vignettes-1"></a>
<h3 class="subsection">1.4.1 Encodings and vignettes</h3>

<p>Vignette PDFs will in general include descriptive text, R input, R
output and figures, LaTeX include files and bibliographic references.
As any of these may contain non-ASCII characters, the handling of
encodings can become very complicated.
</p>
<p>The vignette source file should be written in ASCII or contain a
declaration of the encoding (see below).  This applies even to comments
within the source file, since <code>Sweave()</code> processes comments to look
for options and metadata lines.  When <code>Sweave()</code> or
<code>Stangle()</code> is called on the vignette source, it will be
converted<a name="DOCF39" href="#FOOT39">(39)</a> to the encoding of the current R
session.
</p>
<p><code>Stangle()</code> will produce an R code file in the current locale&rsquo;s
encoding: for a non-ASCII vignette what that is recorded in a comment at
the top of the file.
</p>
<p><code>Sweave()</code> will produce a &lsquo;<tt>.tex</tt>&rsquo; file in the current locale&rsquo;s
encoding.  That needs to be declared to LaTeX via a line like
</p><table><tr><td>&nbsp;</td><td><pre class="example">\usepackage[utf8]{inputenc}
</pre></td></tr></table>
<p><code>R CMD check</code> will warn about any non-ASCII vignettes it finds
which do not have such a declaration.
The problem is that this cannot be known in advance, so vignette PDFs
may only be re-createable on the author&rsquo;s own machine. <code>R CMD
check</code> will report on any non-ASCII vignettes it finds which do not have
such a declaration.  (It is also possible to use the more recent
&lsquo;<samp>inputenx</samp>&rsquo; LaTeX package.)
</p>
<p><code>Sweave()</code> will also parse and evaluate the R code in each
chunk.  The R output will also be in the current locale, and should
be covered by the &lsquo;<samp>inputenc</samp>&rsquo; declaration.  One thing people often
forget is that the R output may not be ASCII even for ASCII R
sources, for many possible reasons.  One common one is the use of
&lsquo;fancy&rsquo; quotes: see the R help on <code>sQuote</code>: note carefully that
it is not portable to declare UTF-8 or CP1252 to cover such quotes, as
their encoding will depend on the locale used to run <code>Sweave()</code>:
this can be circumvented by setting
<code>options(useFancyQuotes=&quot;UTF-8&quot;)</code> in the vignette.
</p>
<p>The final issue is the encoding of figures &ndash; this applies only to PDF
figures and not PNG etc.  The PDF figures will contain declarations for
their encoding, but the Sweave option <code>pdf.encoding</code> may need to be
set appropriately: see the help for the <code>pdf()</code> graphics device.
</p>
<p>As a real example of the complexities, consider the <a href="http://CRAN.R-project.org/package=fortunes"><strong>fortunes</strong></a>
package version &lsquo;<samp>1.4-0</samp>&rsquo;.  That package did not have a declared
encoding, and its vignette was in ASCII.  However, the data it displays
are read from a UTF-8 CSV file and will be assumed to be in the current
encoding, so &lsquo;<tt>fortunes.tex</tt>&rsquo; will be in UTF-8 in any locale.  Had
<code>read.table</code> been told the data were UTF-8, &lsquo;<tt>fortunes.tex</tt>&rsquo;
would have been in the locale&rsquo;s encoding.
</p>
<hr size="6">
<a name="Non_002dSweave-vignettes"></a>
<table cellpadding="1" cellspacing="1" border="0">
<tr><td valign="middle" align="left">[<a href="#Encodings-and-vignettes" title="Previous section in reading order"> &lt; </a>]</td>
<td valign="middle" align="left">[<a href="#Submitting-a-package-to-CRAN" title="Next section in reading order"> &gt; </a>]</td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left">[<a href="#Creating-R-packages" title="Beginning of this chapter or previous chapter"> &lt;&lt; </a>]</td>
<td valign="middle" align="left">[<a href="#Writing-package-vignettes" title="Up section"> Up </a>]</td>
<td valign="middle" align="left">[<a href="#Writing-R-documentation-files" title="Next chapter"> &gt;&gt; </a>]</td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left">[<a href="#Top" title="Cover (top) of document">Top</a>]</td>
<td valign="middle" align="left">[<a href="#SEC_Contents" title="Table of contents">Contents</a>]</td>
<td valign="middle" align="left">[<a href="#Function-and-variable-index" title="Index">Index</a>]</td>
<td valign="middle" align="left">[<a href="#SEC_About" title="About (help)"> ? </a>]</td>
</tr></table>
<a name="Non_002dSweave-vignettes-1"></a>
<h3 class="subsection">1.4.2 Non-Sweave vignettes</h3>

<p>New in R version 3.0.0 is the possibility of vignettes in formats
other than Sweave by means of &ldquo;vignette engines&rdquo;. For example
<a href="http://CRAN.R-project.org/package=knitr"><strong>knitr</strong></a> version 1.1 or higher can create &lsquo;<tt>.tex</tt>&rsquo; files
from a variation on Sweave format, or &lsquo;<tt>.html</tt>&rsquo; files from a
variation on &ldquo;markdown&rdquo; format. These engines replace the
<code>Sweave()</code> and <code>Stangle()</code> functions with other functions to
convert vignette source files into LaTeX files, &lsquo;<tt>.html</tt>&rsquo; files,
or R source.
</p>
<p>R recognizes non-Sweave vignettes using the same extensions as for
Sweave vignettes; in addition, the extension &lsquo;<tt>.Rmd</tt>&rsquo; (standing for
&ldquo;R markdown&rdquo;) is supported.
The user indicates the vignette engine using the <code>\VignetteEngine</code> line, 
for example
</p><table><tr><td>&nbsp;</td><td><pre class="example">%\VignetteEngine{knitr}
</pre></td></tr></table>
<p>This specifies the name of an engine to use in place of Sweave in
processing the vignette.  As <code>Sweave</code> is the only engine supplied
with R, the package providing any other engine must be specified
in the &lsquo;<samp>VignetteBuilder</samp>&rsquo; field of the package &lsquo;<tt>DESCRIPTION</tt>&rsquo;
file.
</p>
<p>If the vignette source has the &lsquo;<tt>.Rmd</tt>&rsquo; extension  then it is
assumed that the weaving procedure produces &lsquo;<tt>.html</tt>&rsquo; output
directly.  Otherwise, the weaver is assumed to produce &lsquo;<tt>.tex</tt>&rsquo;
output, and R handles the conversion to &lsquo;<tt>.pdf</tt>&rsquo; files.
</p>
<p>Package writers who would like to supply vignette engines need
to register those engines in the package <code>.onLoad</code> function.
For example, that function could make the call
</p><table><tr><td>&nbsp;</td><td><pre class="example">tools::vignetteEngine(&quot;knitr&quot;, weave=vweave, tangle=vtangle)
</pre></td></tr></table>
<p>The <code>weave</code> and <code>tangle</code> arguments specify functions with
headers compatible with <code>Sweave</code> and <code>Stangle</code> respectively.
These will be called by R when processing vignettes.  See
the <code>?tools::vignetteEngine</code> help topic for more details.
</p>
<hr size="6">
<a name="Submitting-a-package-to-CRAN"></a>
<table cellpadding="1" cellspacing="1" border="0">
<tr><td valign="middle" align="left">[<a href="#Non_002dSweave-vignettes" title="Previous section in reading order"> &lt; </a>]</td>
<td valign="middle" align="left">[<a href="#PDF-size" title="Next section in reading order"> &gt; </a>]</td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left">[<a href="#Creating-R-packages" title="Beginning of this chapter or previous chapter"> &lt;&lt; </a>]</td>
<td valign="middle" align="left">[<a href="#Creating-R-packages" title="Up section"> Up </a>]</td>
<td valign="middle" align="left">[<a href="#Writing-R-documentation-files" title="Next chapter"> &gt;&gt; </a>]</td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left">[<a href="#Top" title="Cover (top) of document">Top</a>]</td>
<td valign="middle" align="left">[<a href="#SEC_Contents" title="Table of contents">Contents</a>]</td>
<td valign="middle" align="left">[<a href="#Function-and-variable-index" title="Index">Index</a>]</td>
<td valign="middle" align="left">[<a href="#SEC_About" title="About (help)"> ? </a>]</td>
</tr></table>
<a name="Submitting-a-package-to-CRAN-1"></a>
<h2 class="section">1.5 Submitting a package to <acronym>CRAN</acronym></h2>
<a name="index-CRAN"></a>
<a name="index-CRAN-submission"></a>
<a name="index-Submitting-to-CRAN"></a>

<p><acronym>CRAN</acronym> is a network of WWW sites holding the R distributions
and contributed code, especially R packages.  Users of R are
encouraged to join in the collaborative project and to submit their own
packages to <acronym>CRAN</acronym>.
</p>
<p>Before submitting a package <var>mypkg</var>, read the CRAN policies linked
from <a href="http://CRAN.R-project.org/web/packages/">http://CRAN.R-project.org/web/packages/</a> and note that by
submitting a package you are confirming that your package complies with
them.  If this is a package new to CRAN, confirm that you have read and
agree to those policies in your submission email.
</p>
<p>Next, do run the following steps to test it is complete and will install
properly.  (Run from the directory containing &lsquo;<tt><var>mypkg</var></tt>&rsquo; as a
subdirectory.)
</p>
<ol>
<li>
Run <code>R CMD build</code> to make the release &lsquo;<tt>.tar.gz</tt>&rsquo; file.

</li><li>
Run <code>R CMD check --as-cran</code> on the &lsquo;<tt>.tar.gz</tt>&rsquo; file to check
that the package will install and will run its examples, and that the
documentation is complete and can be processed.  If the package contains
code that needs to be compiled, try to enable a reasonable amount of
diagnostic messaging (&ldquo;warnings&rdquo;) when compiling, such as e.g.
&lsquo;<samp>-Wall -pedantic</samp>&rsquo; for tools from GCC, the <acronym>GNU</acronym> Compiler
Collection.  If R was not configured accordingly, one can achieve
this <em>via</em> personal &lsquo;<tt>Makevars</tt>&rsquo; files.

<p>Note that it is particularly important to use &lsquo;<samp>-Wall -pedantic</samp>&rsquo;
with C++ code: the <acronym>GNU</acronym> C++ compiler has many extensions which
are not supported by other compilers, and this will report <em>some</em>
of them (such as the misuse of variable-length arrays).  If possible,
check C++ code on a standards-conformant compiler.
</p>
<p>Although there is now a 2011 version of the C++ standard, it is not yet
implemented (nor is it likely to be widely available for some years) and
portable C++ code needs to follow the 1998 standard (and not use
features from C99).
</p>
<p>Similarly, the 2011 C standard is unlikely to be widely implemented for
several years.
</p>
</li><li>
Study the output from running your examples, in file
&lsquo;<tt><var>mypkg</var>.Rcheck/<var>mypkg</var>-Ex.Rout</tt>&rsquo;.  Often warnings there
indicate actual errors, and warnings about your mistakes (which the R
developers are warning you that they are working around for you) will
just annoy or confuse your users.

<p>If your package has tests or vignettes, study their output too.
</p>
</li><li>
Look for any problems with help file conversions.  For example, you
should
<ul>
<li>
Read through the PDF manual that was produced by <code>R CMD check</code> at
&lsquo;<tt><var>mypkg</var>.Rcheck/<var>mypkg</var>-manual.pdf</tt>&rsquo;, or produce another copy by
<code>R CMD Rd2pdf <var>mypkg</var></code>.

</li><li>
Look at the rendering of your help pages in text from within R.
</li></ul>

<p>Many aspects of help rendering changed in R 2.10.0, and in particular
the interpretation of comment lines (which are rendered as blank lines,
so do not put comment lines in the middle of a paragraph of text).
</p>
</li><li>
Ensure that the package sources are not unnecessarily large.  In
particular, <code>R CMD check</code> will report<a name="DOCF40" href="#FOOT40">(40)</a> on installed packages of
more than 5Mb, detailing directories of more than 1Mb.  It warns about
inefficient compression of data: <code>R CMD build --resave-data</code>
will compact data as best it can.

<p>Watch out for unnecessary files in &lsquo;<tt>inst/doc</tt>&rsquo;: <code>R CMD
check</code> will note files of types that probably should be installed, but
it cannot distinguish PDF figures from PDF documents.  If files need to
be in &lsquo;<tt>inst/doc</tt>&rsquo; but not installed, use a &lsquo;<tt>.Rinstignore</tt>&rsquo; file.
</p>
<p>The CRAN policy is that &lsquo;<tt>doc</tt>&rsquo; directories should not exceed 5Mb,
and where &lsquo;<tt>data</tt>&rsquo; directories need to be more than 5&ndash;10Mb,
consideration should be given to a separate package containing just the
data.  (Similarly for external data directories, large &lsquo;<tt>jar</tt>&rsquo; files
and other libraries that need to be installed.)
</p>
<p>See below for ways to reduce the size of PDF files such as vignettes.
</p>
</li><li>
Ensure that checking the package takes no more time than is needed (the
CRAN check farm is a resource shared between several thousand packages).

<p>See below for ways to find out where your package checks are taking
significant time.
</p></li></ol>

<p>Please ensure that you can run through the complete procedure with only
warnings that you understand and have reasons not to eliminate.  In
principle, packages must pass <code>R CMD check</code> without warnings or
significant notes to be admitted to the main <acronym>CRAN</acronym> package
area.  If there are warnings or notes you cannot eliminate (for example
because you believe them to be spurious) send an explanatory note as
part of your covering email.
</p>
<p>When all the testing is done, upload the &lsquo;<tt>.tar.gz</tt>&rsquo; file, using
&lsquo;<samp>anonymous</samp>&rsquo; as log-in name and your e-mail address as password, to
<a href="ftp://CRAN.R-project.org/incoming/">ftp://CRAN.R-project.org/incoming/</a> (note: use
&lsquo;<samp>ftp</samp>&rsquo;<a name="DOCF41" href="#FOOT41">(41)</a> and not &lsquo;<samp>sftp</samp>&rsquo; to connect to this server, and passive
&lsquo;<samp>ftp</samp>&rsquo; is more often successful) and send a message to
<a href="mailto:CRAN@R-project.org">CRAN@R-project.org</a> about it (with your package name and version
in the subject line of the form &ldquo;CRAN submission <var>package</var>
<var>version</var>&rdquo;, and please do not submit a package by email).  For a
new submission, please note in the message that you have read and agreed
to the CRAN policies.
</p>
<p>The <acronym>CRAN</acronym> maintainers will run these tests before putting a
submission online.  (They will use the latest development version of
R, so if at all possible so should you.)
</p>
<p>Please note that submissions without an accompanying email to
<a href="mailto:CRAN@R-project.org">CRAN@R-project.org</a> will not be processed, and that emails
should not be sent personally to members of the CRAN team.
</p>
<p>Note also that for running LaTeX, the Debian <acronym>GNU</acronym>/Linux,
Fedora and Solaris check systems on <acronym>CRAN</acronym> use current
TexLive; the Windows <acronym>CRAN</acronym> builder uses a reasonably recent
version of MikTeX (including all packages available directly for
MikTeX); the Mac OS X builders use a current full version of MacTeX,
which includes all of the current TeXLive.  Developers wanting to have
their vignettes use TeX packages or style files not (yet) included
in these distributions should add<a name="DOCF42" href="#FOOT42">(42)</a> the style files to the &lsquo;<tt>vignettes</tt>&rsquo; (or for the legacy
layout, &lsquo;<tt>inst/doc</tt>&rsquo;) subdirectory of their package.
</p>
<table class="menu" border="0" cellspacing="0">
<tr><td align="left" valign="top"><a href="#PDF-size">1.5.1 PDF size</a></td><td>&nbsp;&nbsp;</td><td align="left" valign="top">                    
</td></tr>
<tr><td align="left" valign="top"><a href="#Package-timing">1.5.2 Package timing</a></td><td>&nbsp;&nbsp;</td><td align="left" valign="top">              
</td></tr>
<tr><td align="left" valign="top"><a href="#Windows-external-software">1.5.3 Windows external software</a></td><td>&nbsp;&nbsp;</td><td align="left" valign="top">   
</td></tr>
</table>

<hr size="6">
<a name="PDF-size"></a>
<table cellpadding="1" cellspacing="1" border="0">
<tr><td valign="middle" align="left">[<a href="#Submitting-a-package-to-CRAN" title="Previous section in reading order"> &lt; </a>]</td>
<td valign="middle" align="left">[<a href="#Package-timing" title="Next section in reading order"> &gt; </a>]</td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left">[<a href="#Creating-R-packages" title="Beginning of this chapter or previous chapter"> &lt;&lt; </a>]</td>
<td valign="middle" align="left">[<a href="#Submitting-a-package-to-CRAN" title="Up section"> Up </a>]</td>
<td valign="middle" align="left">[<a href="#Writing-R-documentation-files" title="Next chapter"> &gt;&gt; </a>]</td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left">[<a href="#Top" title="Cover (top) of document">Top</a>]</td>
<td valign="middle" align="left">[<a href="#SEC_Contents" title="Table of contents">Contents</a>]</td>
<td valign="middle" align="left">[<a href="#Function-and-variable-index" title="Index">Index</a>]</td>
<td valign="middle" align="left">[<a href="#SEC_About" title="About (help)"> ? </a>]</td>
</tr></table>
<a name="PDF-size-1"></a>
<h3 class="subsection">1.5.1 PDF size</h3>

<p>There are a several tools available to reduce the size of PDF files,
including Adobe Acrobat (not Reader), Apple&rsquo;s Preview<a name="DOCF43" href="#FOOT43">(43)</a>,
<code>qpdf</code> (<a href="http://qpdf.sourceforge.net/">http://qpdf.sourceforge.net/</a>), and Ghostscript
(which converts PDF to PDF by
</p>
<table><tr><td>&nbsp;</td><td><pre class="example">ps2pdf <var>options</var> -dAutoRotatePages=/None <var>in</var>.pdf <var>out</var>.pdf
</pre></td></tr></table>

<p>and suitable options might be
</p>
<table><tr><td>&nbsp;</td><td><pre class="example">-dPDFSETTINGS=/ebook
-dPDFSETTINGS=/screen
</pre></td></tr></table>

<p>; see <a href="http://www.ghostscript.com/doc/9.04/Ps2pdf.htm">http://www.ghostscript.com/doc/9.04/Ps2pdf.htm</a> for
more such and consider all the options for image downsampling) as well
as numerous commercial and shareware Windows programs.  Note that these
do not all try the same size-reduction strategies, and Acrobat and
<code>ps2pdf</code> can sometimes do much better at reducing the size of
embedded bitmap images, and <code>ps2pdf</code> does not use PDF object
compression (see below).
</p>
<p>Since <code>qpdf</code> is fairly readily available (e.g. it has binaries
for Windows and packages in Debian/Ubuntu/Fedora 17, and is installed as
part of the <acronym>CRAN</acronym> Mac OS X distribution of R), there is an
option &lsquo;<samp>--compact-vignettes</samp>&rsquo; to <code>R CMD build</code> to run
<code>qpdf</code> over PDF files under &lsquo;<tt>inst/doc</tt>&rsquo; and replace them if
at least 10Kb and 10% is saved.  The full path to the <code>qpdf</code>
command can be supplied as environment variable <code>R_QPDF</code> (and is on
the CRAN binary of R for Mac OS X).  This option can take values
&lsquo;<samp>qpdf</samp>&rsquo; (the default) as well as &lsquo;<samp>gs</samp>&rsquo; or &lsquo;<samp>both</samp>&rsquo; to try
harder to reduce the size.  These should definitely be tried before
submission to CRAN for packages with more than 250Kb of PDF files: as
&lsquo;<samp>gs</samp>&rsquo; may make lossy changes such as downsampling bitmap images, do
examine the results and if necessary use <code>ps2pdf</code> or
<code>tools::compactPDF</code> directly.
</p>
<p>Most of the large PDFs we have encountered have been large because of
the inclusion of figures, for example complex figures from R (where
&lsquo;<tt>.png</tt>&rsquo; versions may be more appropriate, and PDF compression was
not used by <code>pdf()</code> prior to R 2.14.0, so it may help to
re-generate them) and screendumps.  However, some have been
unnecessarily large due to <code>pdftex</code> settings.  The modern
default is to use both PDF compression and PDF object compression (which
needs PDF version 1.5 from 2003): this is the default in most TeX
distributions but not MiKTeX.  It can be overridden by code in the
preamble of an Sweave or LaTeX file: see how this is done for the
R reference manual at
<a href="https://svn.r-project.org/R/trunk/doc/manual/refman.top">https://svn.r-project.org/R/trunk/doc/manual/refman.top</a>.
</p>
<hr size="6">
<a name="Package-timing"></a>
<table cellpadding="1" cellspacing="1" border="0">
<tr><td valign="middle" align="left">[<a href="#PDF-size" title="Previous section in reading order"> &lt; </a>]</td>
<td valign="middle" align="left">[<a href="#Windows-external-software" title="Next section in reading order"> &gt; </a>]</td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left">[<a href="#Creating-R-packages" title="Beginning of this chapter or previous chapter"> &lt;&lt; </a>]</td>
<td valign="middle" align="left">[<a href="#Submitting-a-package-to-CRAN" title="Up section"> Up </a>]</td>
<td valign="middle" align="left">[<a href="#Writing-R-documentation-files" title="Next chapter"> &gt;&gt; </a>]</td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left">[<a href="#Top" title="Cover (top) of document">Top</a>]</td>
<td valign="middle" align="left">[<a href="#SEC_Contents" title="Table of contents">Contents</a>]</td>
<td valign="middle" align="left">[<a href="#Function-and-variable-index" title="Index">Index</a>]</td>
<td valign="middle" align="left">[<a href="#SEC_About" title="About (help)"> ? </a>]</td>
</tr></table>
<a name="Package-timing-1"></a>
<h3 class="subsection">1.5.2 Package timing</h3>

<p>There are several ways to find out where time is being spent in the
check process.  Start by setting the environment variable
<code>_R_CHECK_TIMINGS_</code> to &lsquo;<samp>0</samp>&rsquo;.  This will report the total CPU
times (not Windows) and elapsed times for installation and running
examples, tests and vignettes, under each sub-architecture if
appropriate.  For tests and vignettes, it reports the time for each as
well as the total.
</p>
<p>Setting <code>_R_CHECK_TIMINGS_</code> to a non-zero value sets a threshold (in
seconds elapsed time) for reporting timings.
</p>
<p>If you need to look in more detail at the timings for examples, use
option &lsquo;<samp>--timings</samp>&rsquo; to <code>R CMD check</code>.  This generates a
file called &lsquo;<tt><var>mypkg</var>.Rcheck/<var>mypkg</var>-Ex.timings</tt>&rsquo;
containing timings for each help files (as given by
<code>system.time()</code>).  It is a tab-delimited file which can be read
into R for further analysis.
</p>
<p>Timings for the tests and vignette runs are given at the bottom of the
corresponding log file: note that log files for successful vignette runs
are only retained if <code>_R_CHECK_ALWAYS_LOG_VIGNETTE_OUTPUT_</code> is set
to a true value.
</p>

<hr size="6">
<a name="Windows-external-software"></a>
<table cellpadding="1" cellspacing="1" border="0">
<tr><td valign="middle" align="left">[<a href="#Package-timing" title="Previous section in reading order"> &lt; </a>]</td>
<td valign="middle" align="left">[<a href="#Package-namespaces" title="Next section in reading order"> &gt; </a>]</td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left">[<a href="#Creating-R-packages" title="Beginning of this chapter or previous chapter"> &lt;&lt; </a>]</td>
<td valign="middle" align="left">[<a href="#Submitting-a-package-to-CRAN" title="Up section"> Up </a>]</td>
<td valign="middle" align="left">[<a href="#Writing-R-documentation-files" title="Next chapter"> &gt;&gt; </a>]</td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left">[<a href="#Top" title="Cover (top) of document">Top</a>]</td>
<td valign="middle" align="left">[<a href="#SEC_Contents" title="Table of contents">Contents</a>]</td>
<td valign="middle" align="left">[<a href="#Function-and-variable-index" title="Index">Index</a>]</td>
<td valign="middle" align="left">[<a href="#SEC_About" title="About (help)"> ? </a>]</td>
</tr></table>
<a name="Windows-external-software-1"></a>
<h3 class="subsection">1.5.3 Windows external software</h3>

<p>Note that <acronym>CRAN</acronym> does not accept submissions of precompiled
binaries due to security concerns, and does not allow binary executables
in source packages.  Maintainers who need additional software for the
Windows binaries of their packages on <acronym>CRAN</acronym> have three options
</p><ol>
<li>
To arrange for installation of the package to download the
additional software from a URL, as e.g. package <a href="http://CRAN.R-project.org/package=Cairo"><strong>Cairo</strong></a> does.

</li><li>
To negotiate with Uwe Ligges to host the additional components on
WinBuilder, and write a &lsquo;<tt>configure.win</tt>&rsquo; file to install them.
There are used to be many examples, e.g. package <a href="http://CRAN.R-project.org/package=rgdal"><strong>rgdal</strong></a> (however
nowadays CRAN prefers to use a uniform cross-compilation approach for
software such as GDAL).

</li><li>
To negotiate with Brian Ripley to host the package on <acronym>CRAN</acronym>
extras, as was done for package <strong>BRugs</strong> versions 0.5-x.
</li></ol>

<p>Be aware that in all cases license requirements will need to be met so
you may need to supply the sources for the additional components (and
will if your package has a GPL-like license).
</p>
<p>Also be aware that there are both 32- and 64-bit builds of R for
Windows with a combined distribution of binary packages, so the
<acronym>CRAN</acronym> team will be unwilling to support a package that works
under just one of the architectures.
</p>

<hr size="6">
<a name="Package-namespaces"></a>
<table cellpadding="1" cellspacing="1" border="0">
<tr><td valign="middle" align="left">[<a href="#Windows-external-software" title="Previous section in reading order"> &lt; </a>]</td>
<td valign="middle" align="left">[<a href="#Specifying-imports-and-exports" title="Next section in reading order"> &gt; </a>]</td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left">[<a href="#Creating-R-packages" title="Beginning of this chapter or previous chapter"> &lt;&lt; </a>]</td>
<td valign="middle" align="left">[<a href="#Creating-R-packages" title="Up section"> Up </a>]</td>
<td valign="middle" align="left">[<a href="#Writing-R-documentation-files" title="Next chapter"> &gt;&gt; </a>]</td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left">[<a href="#Top" title="Cover (top) of document">Top</a>]</td>
<td valign="middle" align="left">[<a href="#SEC_Contents" title="Table of contents">Contents</a>]</td>
<td valign="middle" align="left">[<a href="#Function-and-variable-index" title="Index">Index</a>]</td>
<td valign="middle" align="left">[<a href="#SEC_About" title="About (help)"> ? </a>]</td>
</tr></table>
<a name="Package-namespaces-1"></a>
<h2 class="section">1.6 Package namespaces</h2>
<a name="index-namespaces"></a>

<p>R has a namespace management system for code in packages.  This
system allows the package writer to specify which variables in the
package should be <em>exported</em> to make them available to package
users, and which variables should be <em>imported</em> from other
packages.
</p>
<p>The mechanism for specifying a namespace for a package is to place a
&lsquo;<tt>NAMESPACE</tt>&rsquo; file in the top level package directory.  This file
contains <em>namespace directives</em> describing the imports and exports
of the namespace.  Additional directives register any shared objects to
be loaded and any S3-style methods that are provided.  Note that
although the file looks like R code (and often has R-style
comments) it is not processed as R code.  Only very simple
conditional processing of <code>if</code> statements is implemented.
</p>
<p>Packages are loaded and attached to the search path by calling
<code>library</code> or <code>require</code>.  Only the exported variables are
placed in the attached frame.  Loading a package that imports
variables from other packages will cause these other packages to be
loaded as well (unless they have already been loaded), but they will
<em>not</em> be placed on the search path by these implicit loads.
</p>
<p>Namespaces are <em>sealed</em> once they are loaded.  Sealing means that
imports and exports cannot be changed and that internal variable
bindings cannot be changed.  Sealing allows a simpler implementation
strategy for the namespace mechanism.  Sealing also allows code
analysis and compilation tools to accurately identify the definition
corresponding to a global variable reference in a function body.
</p>
<p>The namespace controls the search strategy for variables used by
functions in the package.  If not found locally, R searches the
package namespace first, then the imports, then the base namespace and
then the normal search path.
</p>
<p>Prior to version 2.14.0, namespaces were optional in packages: a default
namespace was generated in 2.14.x and 2.15.x.  As from 3.0.0 a namespace
is mandatory.
</p>
<table class="menu" border="0" cellspacing="0">
<tr><td align="left" valign="top"><a href="#Specifying-imports-and-exports">1.6.1 Specifying imports and exports</a></td><td>&nbsp;&nbsp;</td><td align="left" valign="top">  
</td></tr>
<tr><td align="left" valign="top"><a href="#Registering-S3-methods">1.6.2 Registering S3 methods</a></td><td>&nbsp;&nbsp;</td><td align="left" valign="top">      
</td></tr>
<tr><td align="left" valign="top"><a href="#Load-hooks">1.6.3 Load hooks</a></td><td>&nbsp;&nbsp;</td><td align="left" valign="top">                  
</td></tr>
<tr><td align="left" valign="top"><a href="#useDynLib">1.6.4 useDynLib</a></td><td>&nbsp;&nbsp;</td><td align="left" valign="top">                   
</td></tr>
<tr><td align="left" valign="top"><a href="#An-example">1.6.5 An example</a></td><td>&nbsp;&nbsp;</td><td align="left" valign="top">                  
</td></tr>
<tr><td align="left" valign="top"><a href="#Namespaces-with-S4-classes-and-methods">1.6.6 Namespaces with S4 classes and methods</a></td><td>&nbsp;&nbsp;</td><td align="left" valign="top">  
</td></tr>
</table>


<hr size="6">
<a name="Specifying-imports-and-exports"></a>
<table cellpadding="1" cellspacing="1" border="0">
<tr><td valign="middle" align="left">[<a href="#Package-namespaces" title="Previous section in reading order"> &lt; </a>]</td>
<td valign="middle" align="left">[<a href="#Registering-S3-methods" title="Next section in reading order"> &gt; </a>]</td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left">[<a href="#Creating-R-packages" title="Beginning of this chapter or previous chapter"> &lt;&lt; </a>]</td>
<td valign="middle" align="left">[<a href="#Package-namespaces" title="Up section"> Up </a>]</td>
<td valign="middle" align="left">[<a href="#Writing-R-documentation-files" title="Next chapter"> &gt;&gt; </a>]</td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left">[<a href="#Top" title="Cover (top) of document">Top</a>]</td>
<td valign="middle" align="left">[<a href="#SEC_Contents" title="Table of contents">Contents</a>]</td>
<td valign="middle" align="left">[<a href="#Function-and-variable-index" title="Index">Index</a>]</td>
<td valign="middle" align="left">[<a href="#SEC_About" title="About (help)"> ? </a>]</td>
</tr></table>
<a name="Specifying-imports-and-exports-1"></a>
<h3 class="subsection">1.6.1 Specifying imports and exports</h3>

<p>Exports are specified using the <code>export</code> directive in the
&lsquo;<tt>NAMESPACE</tt>&rsquo; file.  A directive of the form
</p>
<a name="index-export"></a>
<table><tr><td>&nbsp;</td><td><pre class="example">export(f, g)
</pre></td></tr></table>

<p>specifies that the variables <code>f</code> and <code>g</code> are to be exported.
(Note that variable names may be quoted, and reserved words and
non-standard names such as <code>[&lt;-.fractions</code> must be.)
</p>
<p>For packages with many variables to export it may be more convenient to
specify the names to export with a regular expression using
<code>exportPattern</code>.  The directive
</p>
<a name="index-exportPattern"></a>
<table><tr><td>&nbsp;</td><td><pre class="example">exportPattern(&quot;^[^\\.]&quot;)
</pre></td></tr></table>

<p>exports all variables that do not start with a period.  However, such
broad patterns are not recommended for production code: it is better to
list all exports or use narrowly-defined groups.  (As from R 2.13.0
this pattern applies to S4 classes, but did not in earlier versions of
R.)  Beware of patterns which include names starting with a period:
some of these are internal-only variables and should never be exported,
e.g. &lsquo;<samp>.__S3MethodsTable__.</samp>&rsquo; .
</p>
<p>Packages implicitly import the base namespace.
Variables exported from other packages with namespaces need to be
imported explicitly using the directives <code>import</code> and
<code>importFrom</code>.  The <code>import</code> directive imports all exported
variables from the specified package(s).  Thus the directives
</p>
<a name="index-import"></a>
<table><tr><td>&nbsp;</td><td><pre class="example">import(foo, bar)
</pre></td></tr></table>

<p>specifies that all exported variables in the packages <strong>foo</strong> and
<strong>bar</strong> are to be imported.  If only some of the exported variables
from a package are needed, then they can be imported using
<code>importFrom</code>.  The directive
</p>
<a name="index-importFrom"></a>
<table><tr><td>&nbsp;</td><td><pre class="example">importFrom(foo, f, g)
</pre></td></tr></table>

<p>specifies that the exported variables <code>f</code> and <code>g</code> of the
package <strong>foo</strong> are to be imported.
</p>
<p>It is possible to export variables from a namespace that it has
imported from other namespaces.
</p>
<p>If a package only needs a few objects from another package it can use a
fully qualified variable reference in the code instead of a formal
import.  A fully qualified reference to the function <code>f</code> in package
<strong>foo</strong> is of the form <code>foo::f</code>.  This is slightly less efficient
than a formal import and also loses the advantage of recording all
dependencies in the &lsquo;<tt>NAMESPACE</tt>&rsquo; file, so this approach is usually
not recommended.  Evaluating <code>foo::f</code> will cause package <strong>foo</strong>
to be loaded, but not attached, if it was not loaded already&mdash;this can
be an advantage in delaying the loading of a rarely used package.
</p>
<p>Using <code>foo:::f</code> instead of <code>foo::f</code> allows access to
unexported objects.  This is generally not recommended, as the
semantics of unexported objects may be changed by the package author
in routine maintenance.
</p>
<hr size="6">
<a name="Registering-S3-methods"></a>
<table cellpadding="1" cellspacing="1" border="0">
<tr><td valign="middle" align="left">[<a href="#Specifying-imports-and-exports" title="Previous section in reading order"> &lt; </a>]</td>
<td valign="middle" align="left">[<a href="#Load-hooks" title="Next section in reading order"> &gt; </a>]</td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left">[<a href="#Creating-R-packages" title="Beginning of this chapter or previous chapter"> &lt;&lt; </a>]</td>
<td valign="middle" align="left">[<a href="#Package-namespaces" title="Up section"> Up </a>]</td>
<td valign="middle" align="left">[<a href="#Writing-R-documentation-files" title="Next chapter"> &gt;&gt; </a>]</td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left">[<a href="#Top" title="Cover (top) of document">Top</a>]</td>
<td valign="middle" align="left">[<a href="#SEC_Contents" title="Table of contents">Contents</a>]</td>
<td valign="middle" align="left">[<a href="#Function-and-variable-index" title="Index">Index</a>]</td>
<td valign="middle" align="left">[<a href="#SEC_About" title="About (help)"> ? </a>]</td>
</tr></table>
<a name="Registering-S3-methods-1"></a>
<h3 class="subsection">1.6.2 Registering S3 methods</h3>

<p>The standard method for S3-style <code>UseMethod</code> dispatching might fail
to locate methods defined in a package that is imported but not attached
to the search path.  To ensure that these methods are available the
packages defining the methods should ensure that the generics are
imported and register the methods using <code>S3method</code> directives.  If
a package defines a function <code>print.foo</code> intended to be used as a
<code>print</code> method for class <code>foo</code>, then the directive
</p>
<a name="index-S3method"></a>
<table><tr><td>&nbsp;</td><td><pre class="example">S3method(print, foo)
</pre></td></tr></table>

<p>ensures that the method is registered and available for <code>UseMethod</code>
dispatch, and the function <code>print.foo</code> does not need to be exported.
Since the generic <code>print</code> is defined in <strong>base</strong> it does not need
to be imported explicitly.
</p>
<p>(Note that function and class names may be quoted, and reserved words
and non-standard names such as <code>[&lt;-</code> and <code>function</code> must
be.)
</p>
<p>It is possible to specify a third argument to S3method, the function to
be used as the method, for example
</p>
<table><tr><td>&nbsp;</td><td><pre class="example">S3method(print, check_so_symbols, .print.via.format)
</pre></td></tr></table>

<p>when <code>print.check_so_symbols</code> is not needed.
</p>

<hr size="6">
<a name="Load-hooks"></a>
<table cellpadding="1" cellspacing="1" border="0">
<tr><td valign="middle" align="left">[<a href="#Registering-S3-methods" title="Previous section in reading order"> &lt; </a>]</td>
<td valign="middle" align="left">[<a href="#useDynLib" title="Next section in reading order"> &gt; </a>]</td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left">[<a href="#Creating-R-packages" title="Beginning of this chapter or previous chapter"> &lt;&lt; </a>]</td>
<td valign="middle" align="left">[<a href="#Package-namespaces" title="Up section"> Up </a>]</td>
<td valign="middle" align="left">[<a href="#Writing-R-documentation-files" title="Next chapter"> &gt;&gt; </a>]</td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left">[<a href="#Top" title="Cover (top) of document">Top</a>]</td>
<td valign="middle" align="left">[<a href="#SEC_Contents" title="Table of contents">Contents</a>]</td>
<td valign="middle" align="left">[<a href="#Function-and-variable-index" title="Index">Index</a>]</td>
<td valign="middle" align="left">[<a href="#SEC_About" title="About (help)"> ? </a>]</td>
</tr></table>
<a name="Load-hooks-1"></a>
<h3 class="subsection">1.6.3 Load hooks</h3>

<a name="index-_002eonLoad"></a>
<a name="index-_002eonAttach"></a>
<p>There are a number of hooks called as packages are loaded, attached,
detached, and unloaded.  See <code>help(&quot;.onLoad&quot;)</code> for more details.
</p>
<p>Since loading and attaching are distinct operations, separate hooks are
provided for each.  These hook functions are called <code>.onLoad</code> and
<code>.onAttach</code>.  They both take arguments<a name="DOCF44" href="#FOOT44">(44)</a> <code>libname</code> and
<code>pkgname</code>; they should be defined in the namespace but not
exported.
</p>
<a name="index-_002eonUnload"></a>
<a name="index-_002eonDetach"></a>
<a name="index-_002eLast_002elib"></a>
<p>Packages can use a <code>.onDetach</code> (as from R 3.0.0) or <code>.Last.lib</code>
function (provided the latter is exported from the namespace) when
<code>detach</code> is called on the package.  It is called with a single
argument, the full path to the installed package.  There is also a hook
<code>.onUnload</code> which is called when the namespace is unloaded
(<em>via</em> a call to <code>unloadNamespace</code>, perhaps called by
<code>detach(unload = TRUE)</code>) with argument the full path to the installed
package&rsquo;s directory.  <code>.onUnload</code> and <code>.onDetach</code> should be
defined in the namespace and not exported, but <code>.Last.lib</code> does
need to be exported.
</p>
<p>Packages are not likely to need <code>.onAttach</code> (except perhaps for a
start-up banner); code to set options and load shared objects should be
placed in a <code>.onLoad</code> function, or use made of the <code>useDynLib</code>
directive described next.
</p>
<p>User-level hooks are also available: see the help on function
<code>setHook</code>.
</p>
<p>These hooks are often used incorrectly.  People forget to export
<code>.Last.lib</code>.   Compiled code should be loaded in <code>.onLoad</code> (or
<em>via</em> a <code>useDynLb</code> directive: see below) and unloaded in
<code>.onUnload</code>.  Do remember that a package&rsquo;s namespace can be loaded
without the namespace being attached (e.g. by <code>pkgname::fun</code>) and
that a package can be detached and re-attached whilst its namespace
remains loaded.
</p>
<hr size="6">
<a name="useDynLib"></a>
<table cellpadding="1" cellspacing="1" border="0">
<tr><td valign="middle" align="left">[<a href="#Load-hooks" title="Previous section in reading order"> &lt; </a>]</td>
<td valign="middle" align="left">[<a href="#An-example" title="Next section in reading order"> &gt; </a>]</td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left">[<a href="#Creating-R-packages" title="Beginning of this chapter or previous chapter"> &lt;&lt; </a>]</td>
<td valign="middle" align="left">[<a href="#Package-namespaces" title="Up section"> Up </a>]</td>
<td valign="middle" align="left">[<a href="#Writing-R-documentation-files" title="Next chapter"> &gt;&gt; </a>]</td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left">[<a href="#Top" title="Cover (top) of document">Top</a>]</td>
<td valign="middle" align="left">[<a href="#SEC_Contents" title="Table of contents">Contents</a>]</td>
<td valign="middle" align="left">[<a href="#Function-and-variable-index" title="Index">Index</a>]</td>
<td valign="middle" align="left">[<a href="#SEC_About" title="About (help)"> ? </a>]</td>
</tr></table>
<a name="useDynLib-1"></a>
<h3 class="subsection">1.6.4 useDynLib</h3>

<p>A &lsquo;<tt>NAMESPACE</tt>&rsquo; file can contain one or more <code>useDynLib</code>
directives which allows shared objects that need to be
loaded.<a name="DOCF45" href="#FOOT45">(45)</a>  The directive
</p>
<a name="index-useDynLib"></a>
<table><tr><td>&nbsp;</td><td><pre class="example">useDynLib(foo)
</pre></td></tr></table>

<p>registers the shared object <code>foo</code><a name="DOCF46" href="#FOOT46">(46)</a> for loading with <code>library.dynam</code>.
Loading of registered object(s) occurs after the package code has been
loaded and before running the load hook function.  Packages that would
only need a load hook function to load a shared object can use the
<code>useDynLib</code> directive instead.
</p>
<p>The <code>useDynLib</code> directive also accepts the names of the native
routines that are to be used in R <em>via</em> the <code>.C</code>, <code>.Call</code>,
<code>.Fortran</code> and <code>.External</code> interface functions.  These are given as
additional arguments to the directive, for example,
</p>
<table><tr><td>&nbsp;</td><td><pre class="example">useDynLib(foo, myRoutine, myOtherRoutine)
</pre></td></tr></table>

<p>By specifying these names in the <code>useDynLib</code> directive, the native
symbols are resolved when the package is loaded and R variables
identifying these symbols are added to the package&rsquo;s namespace with
these names.  These can be used in the <code>.C</code>, <code>.Call</code>,
<code>.Fortran</code> and <code>.External</code> calls in place of the name of the
routine and the <code>PACKAGE</code> argument.  For instance, we can call the
routine <code>myRoutine</code> from R with the code
</p>
<table><tr><td>&nbsp;</td><td><pre class="example"> .Call(myRoutine, x, y)
</pre></td></tr></table>

<p>rather than
</p>
<table><tr><td>&nbsp;</td><td><pre class="example"> .Call(&quot;myRoutine&quot;, x, y, PACKAGE = &quot;foo&quot;)
</pre></td></tr></table>

<p>There are at least two benefits to this approach.  Firstly, the symbol
lookup is done just once for each symbol rather than each time the
routine is invoked.  Secondly, this removes any ambiguity in resolving
symbols that might be present in several compiled DLLs.
</p>
<p>In some circumstances, there will already be an R variable in the
package with the same name as a native symbol. For example, we may have
an R function in the package named <code>myRoutine</code>.  In this case,
it is necessary to map the native symbol to a different R variable
name. This can be done in the <code>useDynLib</code> directive by using named
arguments. For instance, to map the native symbol name <code>myRoutine</code>
to the R variable <code>myRoutine_sym</code>, we would use
</p>
<table><tr><td>&nbsp;</td><td><pre class="example">useDynLib(foo, myRoutine_sym = myRoutine, myOtherRoutine)
</pre></td></tr></table>

<p>We could then call that routine from R using the command
</p>
<table><tr><td>&nbsp;</td><td><pre class="example"> .Call(myRoutine_sym, x, y)
</pre></td></tr></table>

<p>Symbols without explicit names are assigned to the R variable with
that name.
</p>
<p>In some cases, it may be preferable not to create R variables in the
package&rsquo;s namespace that identify the native routines.  It may be too
costly to compute these for many routines when the package is loaded
if many of these routines are not likely to be used.  In this case,
one can still perform the symbol resolution correctly using the DLL,
but do this each time the routine is called.  Given a reference to the
DLL as an R variable, say <code>dll</code>, we can call the routine
<code>myRoutine</code> using the expression
</p>
<table><tr><td>&nbsp;</td><td><pre class="example"> .Call(dll$myRoutine, x, y)
</pre></td></tr></table>

<p>The <code>$</code> operator resolves the routine with the given name in the
DLL using a call to <code>getNativeSymbol</code>.  This is the same
computation as above where we resolve the symbol when the package is
loaded. The only difference is that this is done each time in the case
of <code>dll$myRoutine</code>.
</p>
<p>In order to use this dynamic approach (e.g., <code>dll$myRoutine</code>), one
needs the reference to the DLL as an R variable in the package.  The
DLL can be assigned to a variable by using the <code>variable =
dllName</code> format used above for mapping symbols to R variables.  For
example, if we wanted to assign the DLL reference for the DLL
<code>foo</code> in the example above to the variable <code>myDLL</code>, we would
use the following directive in the &lsquo;<tt>NAMESPACE</tt>&rsquo; file:
</p>
<table><tr><td>&nbsp;</td><td><pre class="example">myDLL = useDynLib(foo, myRoutine_sym = myRoutine, myOtherRoutine)
</pre></td></tr></table>

<p>Then, the R variable <code>myDLL</code> is in the package&rsquo;s namespace and
available for calls such as <code>myDLL$dynRoutine</code> to access routines
that are not explicitly resolved at load time.
</p>
<p>If the package has registration information (see <a href="#Registering-native-routines">Registering native routines</a>), then we can use that directly rather than specifying the
list of symbols again in the <code>useDynLib</code> directive in the
&lsquo;<tt>NAMESPACE</tt>&rsquo; file.  Each routine in the registration information is
specified by giving a name by which the routine is to be specified along
with the address of the routine and any information about the number and
type of the parameters.  Using the <code>.registration</code> argument of
<code>useDynLib</code>, we can instruct the namespace mechanism to create
R variables for these symbols.  For example, suppose we have the
following registration information for a DLL named <code>myDLL</code>:
</p>
<table><tr><td>&nbsp;</td><td><pre class="example">R_CMethodDef cMethods[] = {
   {&quot;foo&quot;, (DL_FUNC) &amp;foo, 4, {REALSXP, INTSXP, STRSXP, LGLSXP}},
   {&quot;bar_sym&quot;, (DL_FUNC) &amp;bar, 0},
   {NULL, NULL, 0}
};

R_CallMethodDef callMethods[] = {
   {&quot;R_call_sym&quot;, (DL_FUNC) &amp;R_call, 4},
   {&quot;R_version_sym&quot;, (DL_FUNC) &amp;R_version, 0},
   {NULL, NULL, 0}
};
</pre></td></tr></table>

<p>Then, the directive in the &lsquo;<tt>NAMESPACE</tt>&rsquo; file
</p>
<table><tr><td>&nbsp;</td><td><pre class="example">useDynLib(myDLL, .registration = TRUE)
</pre></td></tr></table>

<p>causes the DLL to be loaded and also for the R variables <code>foo</code>,
<code>bar_sym</code>, <code>R_call_sym</code> and <code>R_version_sym</code> to be
defined in the package&rsquo;s namespace.
</p>
<p>Note that the names for the R variables are taken from the entry in
the registration information and do not need to be the same as the name
of the native routine.  This allows the creator of the registration
information to map the native symbols to non-conflicting variable names
in R, e.g. <code>R_version</code> to <code>R_version_sym</code> for use in an
R function such as
</p>
<table><tr><td>&nbsp;</td><td><pre class="example">R_version &lt;- function()
{
  .Call(R_version_sym)
}
</pre></td></tr></table>

<p>Using argument <code>.fixes</code> allows an automatic prefix to be added to
the registered symbols, which can be useful when working with an
existing package.  For example, package <a href="http://CRAN.R-project.org/package=KernSmooth"><strong>KernSmooth</strong></a> has
</p>
<table><tr><td>&nbsp;</td><td><pre class="example">useDynLib(KernSmooth, .registration = TRUE, .fixes = &quot;F_&quot;)
</pre></td></tr></table>

<p>which makes the R variables corresponding to the FORTRAN symbols
<code>F_bkde</code> and so on, and so avoid clashes with R code in the
namespace.
</p>


<hr size="6">
<a name="An-example"></a>
<table cellpadding="1" cellspacing="1" border="0">
<tr><td valign="middle" align="left">[<a href="#useDynLib" title="Previous section in reading order"> &lt; </a>]</td>
<td valign="middle" align="left">[<a href="#Namespaces-with-S4-classes-and-methods" title="Next section in reading order"> &gt; </a>]</td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left">[<a href="#Creating-R-packages" title="Beginning of this chapter or previous chapter"> &lt;&lt; </a>]</td>
<td valign="middle" align="left">[<a href="#Package-namespaces" title="Up section"> Up </a>]</td>
<td valign="middle" align="left">[<a href="#Writing-R-documentation-files" title="Next chapter"> &gt;&gt; </a>]</td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left">[<a href="#Top" title="Cover (top) of document">Top</a>]</td>
<td valign="middle" align="left">[<a href="#SEC_Contents" title="Table of contents">Contents</a>]</td>
<td valign="middle" align="left">[<a href="#Function-and-variable-index" title="Index">Index</a>]</td>
<td valign="middle" align="left">[<a href="#SEC_About" title="About (help)"> ? </a>]</td>
</tr></table>
<a name="An-example-2"></a>
<h3 class="subsection">1.6.5 An example</h3>

<p>As an example consider two packages named <strong>foo</strong> and <strong>bar</strong>.  The
R code for package <strong>foo</strong> in file &lsquo;<tt>foo.R</tt>&rsquo; is
</p>
<blockquote><table class="cartouche" border="1"><tr><td>
<table><tr><td>&nbsp;</td><td><pre class="example">x &lt;- 1
f &lt;- function(y) c(x,y)
foo &lt;- function(x) .Call(&quot;foo&quot;, x, PACKAGE=&quot;foo&quot;)
print.foo &lt;- function(x, ...) cat(&quot;&lt;a foo&gt;\n&quot;)
</pre></td></tr></table>
</td></tr></table>
</blockquote>

<p>Some C code defines a C function compiled into DLL <code>foo</code> (with an
appropriate extension).  The &lsquo;<tt>NAMESPACE</tt>&rsquo; file for this package is
</p>
<blockquote><table class="cartouche" border="1"><tr><td>
<table><tr><td>&nbsp;</td><td><pre class="example">useDynLib(foo)
export(f, foo)
S3method(print, foo)
</pre></td></tr></table>
</td></tr></table>
</blockquote>

<p>The second package <strong>bar</strong> has code file &lsquo;<tt>bar.R</tt>&rsquo;
</p>
<blockquote><table class="cartouche" border="1"><tr><td>
<table><tr><td>&nbsp;</td><td><pre class="example">c &lt;- function(...) sum(...)
g &lt;- function(y) f(c(y, 7))
h &lt;- function(y) y+9
</pre></td></tr></table>
</td></tr></table>
</blockquote>

<p>and &lsquo;<tt>NAMESPACE</tt>&rsquo; file
</p>
<blockquote><table class="cartouche" border="1"><tr><td>
<table><tr><td>&nbsp;</td><td><pre class="example">import(foo)
export(g, h)
</pre></td></tr></table>
</td></tr></table>
</blockquote>

<p>Calling <code>library(bar)</code> loads <strong>bar</strong> and attaches its exports to
the search path.  Package <strong>foo</strong> is also loaded but not attached to
the search path.  A call to <code>g</code> produces
</p>
<table><tr><td>&nbsp;</td><td><pre class="example">&gt; g(6)
[1]  1 13
</pre></td></tr></table>

<p>This is consistent with the definitions of <code>c</code> in the two settings:
in <strong>bar</strong> the function <code>c</code> is defined to be equivalent to
<code>sum</code>, but in <strong>foo</strong> the variable <code>c</code> refers to the
standard function <code>c</code> in <strong>base</strong>.
</p>
<hr size="6">
<a name="Namespaces-with-S4-classes-and-methods"></a>
<table cellpadding="1" cellspacing="1" border="0">
<tr><td valign="middle" align="left">[<a href="#An-example" title="Previous section in reading order"> &lt; </a>]</td>
<td valign="middle" align="left">[<a href="#Writing-portable-packages" title="Next section in reading order"> &gt; </a>]</td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left">[<a href="#Creating-R-packages" title="Beginning of this chapter or previous chapter"> &lt;&lt; </a>]</td>
<td valign="middle" align="left">[<a href="#Package-namespaces" title="Up section"> Up </a>]</td>
<td valign="middle" align="left">[<a href="#Writing-R-documentation-files" title="Next chapter"> &gt;&gt; </a>]</td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left">[<a href="#Top" title="Cover (top) of document">Top</a>]</td>
<td valign="middle" align="left">[<a href="#SEC_Contents" title="Table of contents">Contents</a>]</td>
<td valign="middle" align="left">[<a href="#Function-and-variable-index" title="Index">Index</a>]</td>
<td valign="middle" align="left">[<a href="#SEC_About" title="About (help)"> ? </a>]</td>
</tr></table>
<a name="Namespaces-with-S4-classes-and-methods-1"></a>
<h3 class="subsection">1.6.6 Namespaces with S4 classes and methods</h3>

<p>Some additional steps are needed for packages which make use of formal
(S4-style) classes and methods (unless these are purely used
internally).  The package should have <code>Depends: methods</code> in its
&lsquo;<tt>DESCRIPTION</tt>&rsquo; file and any classes and methods which are to be
exported need to be declared in the &lsquo;<tt>NAMESPACE</tt>&rsquo; file.  For example,
the <strong>stats4</strong> package has
</p>
<a name="index-exportClasses"></a>
<a name="index-exportMethods"></a>

<table><tr><td>&nbsp;</td><td><pre class="example">export(mle) # exporting methods implicitly exports the generic
importFrom(&quot;graphics&quot;, plot)
importFrom(&quot;stats&quot;, optim, qchisq)
## For these, we define methods or (AIC, BIC, nobs) an implicit generic:
importFrom(&quot;stats&quot;, AIC, BIC, coef, confint, logLik, nobs, profile,
           update, vcov)
exportClasses(mle, profile.mle, summary.mle)
## All methods for imported generics:
exportMethods(coef, confint, logLik, plot, profile, summary, show, update, vcov)
## implicit generics which do not have any methods here
export(AIC, BIC, nobs)
</pre></td></tr></table>

<a name="index-exportPattern-1"></a>
<a name="index-exportClassPattern"></a>
<p>All S4 classes to be used outside the package need to be listed in an
<code>exportClasses</code> directive. Alternatively, they can be specified
using <code>exportClassPattern</code>.<a name="DOCF47" href="#FOOT47">(47)</a> in the same style as
for <code>exportPattern</code>.  To export methods for generics from other
packages an <code>exportMethods</code> directive can be used.
</p>
<p>Note that exporting methods on a generic in the namespace will also
export the generic, and exporting a generic in the namespace will also
export its methods.  If the generic function is not local to this
package, either because it was imported as a generic function or because
the non-generic version has been made generic
solely to add S4 methods to it (as for functions such as <code>plot</code> in
the example above), it can be declared <em>via</em> either or
both of <code>export</code> or <code>exportMethods</code>, but the latter is
clearer (and is used in the <strong>stats4</strong> example above).
In particular, for primitive functions there is no generic function, so
<code>export</code> would export the primitive, which makes no sense.  On the other
hand, if the generic is local to this package, it is more natural to
export the function itself using <code>export()</code>, and this <em>must</em> be
done if an implicit generic
is created without setting any
methods for it (as is the case for <code>AIC</code> in <strong>stats4</strong>).
</p>
<p>A non-local generic function is only exported to ensure that calls to
the function will dispatch the methods from this package (and that is
not done or required when the methods are for primitive functions).  For
this reason, you do not need to document such implicitly created generic
functions, and <code>undoc</code> in package <strong>tools</strong> will not report them.
</p>
<p>If a package uses S4 classes and methods exported from another
package, but does not import the entire namespace of the other package,
it needs to import the classes and methods explicitly, with directives
</p>
<a name="index-importClassesFrom"></a>
<a name="index-importMethodsFrom"></a>

<table><tr><td>&nbsp;</td><td><pre class="example">importClassesFrom(package, ...)
importMethodsFrom(package, ...)
</pre></td></tr></table>

<p>listing the classes and functions with methods respectively.  Suppose we
had two small packages <strong>A</strong> and <strong>B</strong> with <strong>B</strong> using <strong>A</strong>.
Then they could have <code>NAMESPACE</code> files
</p>
<blockquote><table class="cartouche" border="1"><tr><td>
<table><tr><td>&nbsp;</td><td><pre class="example">export(f1, ng1)
exportMethods(&quot;[&quot;)
exportClasses(c1)
</pre></td></tr></table>
</td></tr></table>
</blockquote>

<p>and
</p>
<blockquote><table class="cartouche" border="1"><tr><td>
<table><tr><td>&nbsp;</td><td><pre class="example">importFrom(A, ng1)
importClassesFrom(A, c1)
importMethodsFrom(A, f1)
export(f4, f5)
exportMethods(f6, &quot;[&quot;)
exportClasses(c1, c2)
</pre></td></tr></table>
</td></tr></table>
</blockquote>

<p>respectively.
</p>
<p>Note that <code>importMethodsFrom</code> will also import any generics defined
in the namespace on those methods.
</p>
<p>It is important if you export S4 methods that the corresponding
generics are available: the requirements on this are stricter as from R
2.15.0.  You may for example need to import <code>plot</code> from
<strong>graphics</strong> to make visible a function to be converted into its
implicit generic.  But it is better practice to make use of the generics
exported by <strong>stats4</strong> as this enables multiple packages to
unambiguously set methods on those generics.
</p>
<hr size="6">
<a name="Writing-portable-packages"></a>
<table cellpadding="1" cellspacing="1" border="0">
<tr><td valign="middle" align="left">[<a href="#Namespaces-with-S4-classes-and-methods" title="Previous section in reading order"> &lt; </a>]</td>
<td valign="middle" align="left">[<a href="#Encoding-issues" title="Next section in reading order"> &gt; </a>]</td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left">[<a href="#Creating-R-packages" title="Beginning of this chapter or previous chapter"> &lt;&lt; </a>]</td>
<td valign="middle" align="left">[<a href="#Creating-R-packages" title="Up section"> Up </a>]</td>
<td valign="middle" align="left">[<a href="#Writing-R-documentation-files" title="Next chapter"> &gt;&gt; </a>]</td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left">[<a href="#Top" title="Cover (top) of document">Top</a>]</td>
<td valign="middle" align="left">[<a href="#SEC_Contents" title="Table of contents">Contents</a>]</td>
<td valign="middle" align="left">[<a href="#Function-and-variable-index" title="Index">Index</a>]</td>
<td valign="middle" align="left">[<a href="#SEC_About" title="About (help)"> ? </a>]</td>
</tr></table>
<a name="Writing-portable-packages-1"></a>
<h2 class="section">1.7 Writing portable packages</h2>

<table class="menu" border="0" cellspacing="0">
<tr><td align="left" valign="top"><a href="#Encoding-issues">1.7.1 Encoding issues</a></td><td>&nbsp;&nbsp;</td><td align="left" valign="top">             
</td></tr>
<tr><td align="left" valign="top"><a href="#Binary-distribution">1.7.2 Binary distribution</a></td><td>&nbsp;&nbsp;</td><td align="left" valign="top">         
</td></tr>
</table>

<p>Portable packages should have simple file names: use only alphanumeric
<acronym>ASCII</acronym> characters and <code>.</code>, and avoid those names not
allowed under Windows which are mentioned above.
</p>
<p><code>R CMD check</code> provides a basic set of checks, but often further
problems emerge when people try to install and use packages submitted to
<acronym>CRAN</acronym> &ndash; many of these involve compiled code.  Here are some
further checks that you can do to make your package more portable.
</p>
<ul>
<li>
If your package has a &lsquo;<tt>configure</tt>&rsquo; script, provide a
&lsquo;<tt>configure.win</tt>&rsquo; script to be used on Windows.  The <acronym>CRAN</acronym>
binary packages for Windows are built automatically, and if your package
does not build without intervention it is unlikely to be easily
available to a high proportion of R users.

</li><li>
If your package has a &lsquo;<tt>Makevars</tt>&rsquo; or &lsquo;<tt>Makefile</tt>&rsquo; file, make sure
that you use only portable make features.  Such files should be
LF-terminated (including the final line of the file) and not make use of
GNU extensions.  Commonly misused GNU extensions are conditional
inclusions (<code>ifeq</code> and the like), <code>${shell ...}</code> and
<code>${wildcard ...}</code>, and the use of <code>+=</code> and <code>:=</code>.  Also,
the use of <code>$&lt;</code> other than in implicit rules is a GNU extension.
Unfortunately makefiles which use GNU extensions often run on other
platforms but do not have the intended results.

<p>The use of <code>${shell ...}</code> can be avoided by using backticks, e.g.
</p>
<table><tr><td>&nbsp;</td><td><pre class="example">PKG_CPPFLAGS = `gsl-config --cflags`
</pre></td></tr></table>

<p>which works in all versions of <code>make</code> known<a name="DOCF48" href="#FOOT48">(48)</a> to be used with R.
</p>
<p>If you really must assume GNU make, declare it in the &lsquo;<tt>DESCRIPTON</tt>&rsquo;
file by
</p>
<table><tr><td>&nbsp;</td><td><pre class="example">SystemRequirements: GNU make
</pre></td></tr></table>

<p>Since the only viable make for Windows is GNU make, it is permissible to
use GNU extensions in files &lsquo;<tt>Makevars.win</tt>&rsquo; or &lsquo;<tt>Makefile.win</tt>&rsquo;.
</p>
</li><li>
Make use of the abilities of your compilers to check the
standards-conformance of your code.  For example, <code>gcc</code> can be used
with options &lsquo;<samp>-Wall -pedantic</samp>&rsquo; to alert you to potential
problems.  This is particularly important for C++, where <code>g++ -Wall
-pedantic</code> will alert you to the use of GNU extensions which fail to
compile on most other C++ compilers.  R assumes a C99 compiler as
from version 2.12.0, but if you want your package to be portable to
earlier versions you should write in C90.

<p>If you use FORTRAN 77, <code>ftnchek</code>
(<a href="http://www.dsm.fordham.edu/~ftnchek/">http://www.dsm.fordham.edu/~ftnchek/</a>) provides thorough testing
of conformance to the standard.
</p>
</li><li>
Do be very careful with passing arguments between R, C and
<acronym>FORTRAN</acronym> code.  In particular, <code>long</code> in C will be 32-bit
on some R platforms (including 64-bit Windows), but 64-bit on most
modern Unix and Linux platforms.  It is rather unlikely that the use of
<code>long</code> in C code has been thought through: if you need a longer
type than <code>int</code> you should use a configure test for a C99 type such
as <code>int_fast64_t</code> (and failing that, <code>long long</code> <a name="DOCF49" href="#FOOT49">(49)</a>) and typedef your own type
to be <code>long</code> or <code>long long</code>, or use another suitable type
(such as <code>size_t</code>).

<p>It is not safe to assume that <code>long</code> and pointer types are the same
size, and they are not on 64-bit Windows.  If you need to convert
pointers to and from integers use the C99 integer types <code>intptr_t</code>
and <code>uintptr_t</code> (which are defined in the header <code>&lt;stdint.h&gt;</code>
and are not required to be implemented by the C99 standard).
</p>
<p>Note that <code>integer</code> in <acronym>FORTRAN</acronym> corresponds to <code>int</code>
in C on all R platforms.
</p>
</li><li>
Under no circumstances should your compiled code ever call <code>abort</code>
or <code>exit</code>: these terminate the user&rsquo;s R process, quite possibly
including all his unsaved work.  One usage that could call <code>abort</code>
is the <code>assert</code> macro in C or C++ functions, which should never be
active in production code.  The normal way to ensure that is to define
the macro <code>NDEBUG</code>, and as from R 2.15.0 <code>R CMD INSTALL</code>
does so as part of the compilation flags.  If you wish to use
<code>assert</code> during development. you can include <code>-UNDEBUG</code> in
<code>PKG_CPPFLAGS</code>.  Note that your own &lsquo;<tt>src/Makefile</tt>&rsquo; or
makefiles in sub-directories may also need to define <code>NDEBUG</code>.

<p>This applies not only to your own code but to any external software you
compile in or link to.
</p>
</li><li>
Compiled code should not write to &lsquo;<tt>stdout</tt>&rsquo; or &lsquo;<tt>stderr</tt>&rsquo; and C++
and Fortran I/O should not be used.  As with the previous item such
calls may come from external software and may never be called.

</li><li>
Errors in memory allocation and reading/writing outside arrays are very
common causes of crashes (e.g., segfaults) on some machines.
See <a href="#Using-valgrind">Using valgrind</a> for a tool which can be used to look for this.

</li><li>
Many platforms will allow unsatisfied entry points in compiled code, but
will crash the application (here R) if they are ever used.  Some
(notably Windows) will not.  Looking at the output of

<table><tr><td>&nbsp;</td><td><pre class="example">nm -pg mypkg.so  # <span class="roman">or other extension such as &lsquo;<tt>.sl</tt>&rsquo;</span>
</pre></td></tr></table>

<p>and checking if any of the symbols marked <code>U</code> is unexpected is a
good way to avoid this.
</p>
</li><li>
Conflicts between symbols in DLLs are handled in very platform-specific
ways.  Good ways to avoid trouble are to make as many symbols as
possible static (check with <code>nm -pg</code>), and to use unusual names, as
well as ensuring you have used the <code>PACKAGE</code> argument.

</li><li>
It is not portable to call compiled code in R or other packages
<em>via</em> <code>.Internal</code>, <code>.C</code>, <code>.Fortran</code>, <code>.Call</code> or
<code>.External</code>, since such interfaces are subject to change without
notice and will probably result in your code terminating the R
process.

</li><li>
Do not use (hard or symbolic) file links in your package sources.
<code>R CMD build</code> packages the tarball with the &lsquo;<samp>-h</samp>&rsquo;
<code>tar</code> flag which is documented to dereference links so this is
not usually a problem, but versions 1.24 and later of GNU <code>tar</code>
dereference some links to hard links which may not be handled correctly
by <code>R CMD INSTALL</code>.

</li><li>
If you do not yourself have a Windows system, submit your source package
to WinBuilder (<a href="http://win-builder.r-project.org/">http://win-builder.r-project.org/</a>) before
distribution (including submission to <acronym>CRAN</acronym>).

</li></ul>

<hr size="6">
<a name="Encoding-issues"></a>
<table cellpadding="1" cellspacing="1" border="0">
<tr><td valign="middle" align="left">[<a href="#Writing-portable-packages" title="Previous section in reading order"> &lt; </a>]</td>
<td valign="middle" align="left">[<a href="#Binary-distribution" title="Next section in reading order"> &gt; </a>]</td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left">[<a href="#Creating-R-packages" title="Beginning of this chapter or previous chapter"> &lt;&lt; </a>]</td>
<td valign="middle" align="left">[<a href="#Writing-portable-packages" title="Up section"> Up </a>]</td>
<td valign="middle" align="left">[<a href="#Writing-R-documentation-files" title="Next chapter"> &gt;&gt; </a>]</td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left">[<a href="#Top" title="Cover (top) of document">Top</a>]</td>
<td valign="middle" align="left">[<a href="#SEC_Contents" title="Table of contents">Contents</a>]</td>
<td valign="middle" align="left">[<a href="#Function-and-variable-index" title="Index">Index</a>]</td>
<td valign="middle" align="left">[<a href="#SEC_About" title="About (help)"> ? </a>]</td>
</tr></table>
<a name="Encoding-issues-1"></a>
<h3 class="subsection">1.7.1 Encoding issues</h3>

<p>Care is needed if your package contains non-<acronym>ASCII</acronym> text, and in
particular if it is intended to be used in more than one locale.  It is
possible to mark the encoding used in the &lsquo;<tt>DESCRIPTION</tt>&rsquo; file and in
&lsquo;<tt>.Rd</tt>&rsquo; files, as discussed elsewhere in this manual.
</p>
<p>First, consider carefully if you really need non-<acronym>ASCII</acronym> text.
Many users of R will only be able to view correctly text in their
native language group (e.g. Western European, Eastern European,
Simplified Chinese) and <acronym>ASCII</acronym>.  Other characters may not be
rendered at all, rendered incorrectly, or cause your R code to give
an error.  For documentation, marking the encoding and including
<acronym>ASCII</acronym> transliterations is likely to do a reasonable job.  The
set of characters which is commonly supported is wider than it used to
be around 2000, but non-Latin alphabets (Greek, Russian, Georgian,
&hellip;) are still often problematic and those with double-width
characters (Chinese, Japanese, Korean) often need specialist fonts to
render correctly.
</p>
<p>Several CRAN packages have messages in their R code in French (and a
few in German).  A better way to tackle this is to use the
internationalization facilities discussed elsewhere in this manual.
</p>
<p>Function <code>showNonASCIIfile</code> in package <strong>tools</strong> can help in
finding non-<acronym>ASCII</acronym> bytes in files.
</p>
<p>There is a portable way to have arbitrary text in character strings
(only) in your R code, which is to supply them in Unicode as
<code>\uxxxx</code> escapes.  If there are any characters not in the current
encoding the parser will encode the character string as UTF-8 and mark
it as such.  This applies also to character strings in datasets: they
can be prepared using <code>\uxxxx</code> escapes or encoded in UTF-8 in a
UTF-8 locale, or even converted to UTF-8 via &lsquo;<samp>iconv()</samp>&rsquo;.  If you do
this, make sure you have &lsquo;<samp>R (&gt;= 2.10)</samp>&rsquo; (or later) in the
&lsquo;<samp>Depends</samp>&rsquo; field of the &lsquo;<tt>DESCRIPTION</tt>&rsquo; file.
</p>
<p>R sessions running in non-UTF-8 locales will if possible re-encode
such strings for display (and this is done by <code>RGui</code> on Windows,
for example).  Suitable fonts will need to be selected or made
available<a name="DOCF50" href="#FOOT50">(50)</a>  both for the console/terminal and graphics devices such as
&lsquo;<samp>X11()</samp>&rsquo; and &lsquo;<samp>windows()</samp>&rsquo;.  Using &lsquo;<samp>postscript</samp>&rsquo; or
&lsquo;<samp>pdf</samp>&rsquo; will choose a default 8-bit encoding depending on the
language of the UTF-8 locale, and your users would need to be told how
to select the &lsquo;<samp>encoding</samp>&rsquo; argument.
</p>
<p>If you want to run <code>R CMD check</code> on a Unix-alike over a package
that sets a package encoding in its &lsquo;<tt>DESCRIPTION</tt>&rsquo; file you may need
to specify a suitable locale <em>via</em> environment variable
<code>R_ENCODING_LOCALES</code>.  The default is equivalent to the value
</p>
<table><tr><td>&nbsp;</td><td><pre class="example">&quot;latin1=en_US:latin2=pl_PL:UTF-8=en_US.UTF-8:latin9=fr_FR.iso885915@euro&quot;
</pre></td></tr></table>

<p>(which is appropriate for a system based on <code>glibc</code>) except that if
the current locale is UTF-8 then the package code is translated to UTF-8
for syntax checking.
</p>
<hr size="6">
<a name="Binary-distribution"></a>
<table cellpadding="1" cellspacing="1" border="0">
<tr><td valign="middle" align="left">[<a href="#Encoding-issues" title="Previous section in reading order"> &lt; </a>]</td>
<td valign="middle" align="left">[<a href="#Diagnostic-messages" title="Next section in reading order"> &gt; </a>]</td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left">[<a href="#Creating-R-packages" title="Beginning of this chapter or previous chapter"> &lt;&lt; </a>]</td>
<td valign="middle" align="left">[<a href="#Writing-portable-packages" title="Up section"> Up </a>]</td>
<td valign="middle" align="left">[<a href="#Writing-R-documentation-files" title="Next chapter"> &gt;&gt; </a>]</td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left">[<a href="#Top" title="Cover (top) of document">Top</a>]</td>
<td valign="middle" align="left">[<a href="#SEC_Contents" title="Table of contents">Contents</a>]</td>
<td valign="middle" align="left">[<a href="#Function-and-variable-index" title="Index">Index</a>]</td>
<td valign="middle" align="left">[<a href="#SEC_About" title="About (help)"> ? </a>]</td>
</tr></table>
<a name="Binary-distribution-1"></a>
<h3 class="subsection">1.7.2 Binary distribution</h3>

<p>If you want to distribute a binary version of a package on Windows or
Mac OS X, there are further checks you need to do to check it is
portable: it is all too easy to depend on external software on your own
machine that other users will not have.
</p>
<p>For Windows, check what other DLLs your package&rsquo;s DLL depends on
(&lsquo;imports&rsquo; from in the DLL tools&rsquo; parlance).  A convenient GUI-based
tool to do so is &lsquo;Dependency Walker&rsquo;
(<a href="http://www.dependencywalker.com/">http://www.dependencywalker.com/</a>) for both 32-bit and 64-bit
DLLs &ndash; note that this will report as missing links to R&rsquo;s own DLLs
such as &lsquo;<tt>R.dll</tt>&rsquo; and &lsquo;<tt>Rblas.dll</tt>&rsquo;.  For 32-bit DLLs only, the
command-line tool <code>pedump.exe -i</code> (in &lsquo;<tt>Rtools*.exe</tt>&rsquo;) can be
used, and for the brave, the <code>objdump</code> tool in the appropriate
toolchain will also reveal what DLLs are imported from.  If you use a
toolchain other than one provided by the R developers or use your own
makefiles, watch out in particular for dependencies on the toolchain&rsquo;s
runtime DLLs such as &lsquo;<tt>libgfortran</tt>&rsquo;, &lsquo;<tt>libstdc++</tt>&rsquo; and
&lsquo;<tt>libgcc_s</tt>&rsquo;.
</p>
<p>For Mac OS X, using <code>R CMD otool -L</code> on the package&rsquo;s shared
objects under &lsquo;<tt>libs</tt>&rsquo; will show what they depend on: watch for any
dependencies in &lsquo;<tt>/usr/local/lib</tt>&rsquo;, notably &lsquo;<tt>libgfortran.2.dylib</tt>&rsquo;.
</p>
<hr size="6">
<a name="Diagnostic-messages"></a>
<table cellpadding="1" cellspacing="1" border="0">
<tr><td valign="middle" align="left">[<a href="#Binary-distribution" title="Previous section in reading order"> &lt; </a>]</td>
<td valign="middle" align="left">[<a href="#Internationalization" title="Next section in reading order"> &gt; </a>]</td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left">[<a href="#Creating-R-packages" title="Beginning of this chapter or previous chapter"> &lt;&lt; </a>]</td>
<td valign="middle" align="left">[<a href="#Creating-R-packages" title="Up section"> Up </a>]</td>
<td valign="middle" align="left">[<a href="#Writing-R-documentation-files" title="Next chapter"> &gt;&gt; </a>]</td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left">[<a href="#Top" title="Cover (top) of document">Top</a>]</td>
<td valign="middle" align="left">[<a href="#SEC_Contents" title="Table of contents">Contents</a>]</td>
<td valign="middle" align="left">[<a href="#Function-and-variable-index" title="Index">Index</a>]</td>
<td valign="middle" align="left">[<a href="#SEC_About" title="About (help)"> ? </a>]</td>
</tr></table>
<a name="Diagnostic-messages-1"></a>
<h2 class="section">1.8 Diagnostic messages</h2>

<p>Now that diagnostic messages can be made available for translation, it
is important to write them in a consistent style.  Using the tools
described in the next section to extract all the messages can give a
useful overview of your consistency (or lack of it).
</p>
<p>Some guidelines follow.
</p>
<ul>
<li>
Messages are sentence fragments, and not viewed in isolation.  So it is
conventional not to capitalize the first word and not to end with a
period (or other punctuation).

</li><li>
Try not to split up messages into small pieces.  In C error messages use
a single format string containing all English words in the messages.

<p>In R error messages do not construct a message with <code>paste</code> (such
messages will not be translated) but <em>via</em> multiple arguments to
<code>stop</code> or <code>warning</code>, or <em>via</em> <code>gettextf</code>.
</p>
</li><li>
Do not use colloquialisms such as &ldquo;can&rsquo;t&rdquo; and &ldquo;don&rsquo;t&rdquo;.

</li><li>
If possible, make quotation marks part of your message as different
languages have different conventions.  In R messages this means not
using <code>sQuote</code> or <code>dQuote</code> except where the argument is a
variable.

<p>Conventionally single quotation marks are used for quotations such as
</p>
<table><tr><td>&nbsp;</td><td><pre class="example">'ord' must be a positive integer, at most the number of knots
</pre></td></tr></table>

<p>and double quotation marks when referring to an R character string
such as
</p>
<table><tr><td>&nbsp;</td><td><pre class="example">'format' must be &quot;normal&quot; or &quot;short&quot; - using &quot;normal&quot;
</pre></td></tr></table>

<p>Since <acronym>ASCII</acronym> does not contain directional quotation marks, it
is best to use &lsquo;<samp>'</samp>&rsquo; and let the translator (including automatic
translation) use directional quotations where available.  The range of
quotation styles is immense: unfortunately we cannot reproduce them in a
portable <code>texinfo</code> document.  But as a taster, some languages use
&lsquo;up&rsquo; and &lsquo;down&rsquo; (comma) quotes rather than left or right quotes, and
some use guillemets (and some use what Adobe calls &lsquo;guillemotleft&rsquo; to
start and others use it to end).
</p>

</li><li>
Occasionally messages need to be singular or plural (and in other
languages there may be no such concept or several plural forms &ndash;
Slovenian has four).  So avoid constructions such as was once used in
<code>library</code>

<table><tr><td>&nbsp;</td><td><pre class="example">if((length(nopkgs) &gt; 0) &amp;&amp; !missing(lib.loc)) {
    if(length(nopkgs) &gt; 1)
        warning(&quot;libraries &quot;,
                paste(sQuote(nopkgs), collapse = &quot;, &quot;),
                &quot; contain no packages&quot;)
    else
        warning(&quot;library &quot;, paste(sQuote(nopkgs)),
                &quot; contains no package&quot;)
}
</pre></td></tr></table>

<p>and was replaced by
</p>
<table><tr><td>&nbsp;</td><td><pre class="example">if((length(nopkgs) &gt; 0) &amp;&amp; !missing(lib.loc)) {
    pkglist &lt;- paste(sQuote(nopkgs), collapse = &quot;, &quot;)
    msg &lt;- sprintf(ngettext(length(nopkgs),
                     &quot;library %s contains no packages&quot;,
                     &quot;libraries %s contain no packages&quot;),
                   pkglist)
    warning(msg, domain=NA)
}
</pre></td></tr></table>

<p>Note that it is much better to have complete clauses as here, since
in another language one might need to say &lsquo;There is no package in library
%s&rsquo; or &lsquo;There are no packages in libraries %s&rsquo;.
</p>
</li></ul>

<hr size="6">
<a name="Internationalization"></a>
<table cellpadding="1" cellspacing="1" border="0">
<tr><td valign="middle" align="left">[<a href="#Diagnostic-messages" title="Previous section in reading order"> &lt; </a>]</td>
<td valign="middle" align="left">[<a href="#C_002dlevel-messages" title="Next section in reading order"> &gt; </a>]</td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left">[<a href="#Creating-R-packages" title="Beginning of this chapter or previous chapter"> &lt;&lt; </a>]</td>
<td valign="middle" align="left">[<a href="#Creating-R-packages" title="Up section"> Up </a>]</td>
<td valign="middle" align="left">[<a href="#Writing-R-documentation-files" title="Next chapter"> &gt;&gt; </a>]</td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left">[<a href="#Top" title="Cover (top) of document">Top</a>]</td>
<td valign="middle" align="left">[<a href="#SEC_Contents" title="Table of contents">Contents</a>]</td>
<td valign="middle" align="left">[<a href="#Function-and-variable-index" title="Index">Index</a>]</td>
<td valign="middle" align="left">[<a href="#SEC_About" title="About (help)"> ? </a>]</td>
</tr></table>
<a name="Internationalization-1"></a>
<h2 class="section">1.9 Internationalization</h2>

<p>There are mechanisms to translate the R- and C-level error and warning
messages.  There are only available if R is compiled with NLS support
(which is requested by <code>configure</code> option &lsquo;<samp>--enable-nls</samp>&rsquo;,
the default).
</p>
<p>The procedures make use of <code>msgfmt</code> and <code>xgettext</code> which are
part of <acronym>GNU</acronym> <code>gettext</code> and this will need to be installed:
Windows users can find pre-compiled binaries at
<a href="http://www.stats.ox.ac.uk/pub/Rtools/goodies/gettext-tools.zip">http://www.stats.ox.ac.uk/pub/Rtools/goodies/gettext-tools.zip</a>
and packaged with the <code>poEdit</code> package
(<a href="http://poedit.sourceforge.net/download.php#win32">http://poedit.sourceforge.net/download.php#win32</a>).
</p>
<table class="menu" border="0" cellspacing="0">
<tr><td align="left" valign="top"><a href="#C_002dlevel-messages">1.9.1 C-level messages</a></td><td>&nbsp;&nbsp;</td><td align="left" valign="top">            
</td></tr>
<tr><td align="left" valign="top"><a href="#R-messages">1.9.2 R messages</a></td><td>&nbsp;&nbsp;</td><td align="left" valign="top">                  
</td></tr>
<tr><td align="left" valign="top"><a href="#Installing-translations">1.9.3 Installing translations</a></td><td>&nbsp;&nbsp;</td><td align="left" valign="top">     
</td></tr>
<tr><td align="left" valign="top"><a href="#Supporting-R-function">1.9.4 Supporting R function</a></td><td>&nbsp;&nbsp;</td><td align="left" valign="top">       
</td></tr>
</table>

<hr size="6">
<a name="C_002dlevel-messages"></a>
<table cellpadding="1" cellspacing="1" border="0">
<tr><td valign="middle" align="left">[<a href="#Internationalization" title="Previous section in reading order"> &lt; </a>]</td>
<td valign="middle" align="left">[<a href="#R-messages" title="Next section in reading order"> &gt; </a>]</td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left">[<a href="#Creating-R-packages" title="Beginning of this chapter or previous chapter"> &lt;&lt; </a>]</td>
<td valign="middle" align="left">[<a href="#Internationalization" title="Up section"> Up </a>]</td>
<td valign="middle" align="left">[<a href="#Writing-R-documentation-files" title="Next chapter"> &gt;&gt; </a>]</td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left">[<a href="#Top" title="Cover (top) of document">Top</a>]</td>
<td valign="middle" align="left">[<a href="#SEC_Contents" title="Table of contents">Contents</a>]</td>
<td valign="middle" align="left">[<a href="#Function-and-variable-index" title="Index">Index</a>]</td>
<td valign="middle" align="left">[<a href="#SEC_About" title="About (help)"> ? </a>]</td>
</tr></table>
<a name="C_002dlevel-messages-1"></a>
<h3 class="subsection">1.9.1 C-level messages</h3>

<p>The process of enabling translations is
</p>
<ul>
<li>
In a header file that will be included in all the C files
containing messages that should be translated, declare

<table><tr><td>&nbsp;</td><td><pre class="example">#include &lt;R.h&gt;  /* to include Rconfig.h */

#ifdef ENABLE_NLS
#include &lt;libintl.h&gt;
#define _(String) dgettext (&quot;<var>pkg</var>&quot;, String)
/* replace <var>pkg</var> as appropriate */
#else
#define _(String) (String)
#endif
</pre></td></tr></table>

</li><li>
For each message that should be translated, wrap it in <code>_(...)</code>,
for example

<table><tr><td>&nbsp;</td><td><pre class="example">error(_(&quot;'ord' must be a positive integer&quot;));
</pre></td></tr></table>

<p>If you want to use different messages for singular and plural forms, you
need to add
</p>
<table><tr><td>&nbsp;</td><td><pre class="example">#ifndef ENABLE_NLS
#define dngettext(pkg, String, StringP, N) (N &gt; 1 ? StringP : String)
#endif
</pre></td></tr></table>

<p>and mark strings by
</p>
<table><tr><td>&nbsp;</td><td><pre class="example">dngettext((&quot;<var>pkg</var>&quot;, <var>&lt;singular string&gt;</var>, <var>&lt;plural string&gt;</var>, n)
</pre></td></tr></table>

</li><li>
In the package&rsquo;s &lsquo;<tt>src</tt>&rsquo; directory run

<table><tr><td>&nbsp;</td><td><pre class="example">xgettext --keyword=_ -o <var>pkg</var>.pot *.c
</pre></td></tr></table>

</li></ul>

<p>The file &lsquo;<tt>src/<var>pkg</var>.pot</tt>&rsquo; is the template file, and
conventionally this is shipped as &lsquo;<tt>po/<var>pkg</var>.pot</tt>&rsquo;.  A translator
to another language makes a copy of this file and edits it (see the
<code>gettext</code> manual) to produce say &lsquo;<tt><var>ll</var>.po</tt>&rsquo;, where
<code><var>ll</var></code> is the code for the language in which the translation is
to be used.  (This file would be shipped in the &lsquo;<tt>po</tt>&rsquo; directory.)
Next run <code>msgfmt</code> on &lsquo;<tt><var>ll</var>.po</tt>&rsquo; to produce
&lsquo;<tt><var>ll</var>.mo</tt>&rsquo;, and copy that to
&lsquo;<tt>inst/po/<var>ll</var>/LC_MESSAGES/<var>pkg</var>.mo</tt>&rsquo;.  Now when the package
is loaded after installation it will look for translations of its
messages in the &lsquo;<tt>po/<var>lang</var>/LC_MESSAGES/<var>pkg</var>.mo</tt>&rsquo; file for
any language <var>lang</var> that matches the user&rsquo;s preferences (<em>via</em>
the setting of the <code>LANGUAGE</code> environment variable or from the
locale settings).
</p>
<hr size="6">
<a name="R-messages"></a>
<table cellpadding="1" cellspacing="1" border="0">
<tr><td valign="middle" align="left">[<a href="#C_002dlevel-messages" title="Previous section in reading order"> &lt; </a>]</td>
<td valign="middle" align="left">[<a href="#Installing-translations" title="Next section in reading order"> &gt; </a>]</td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left">[<a href="#Creating-R-packages" title="Beginning of this chapter or previous chapter"> &lt;&lt; </a>]</td>
<td valign="middle" align="left">[<a href="#Internationalization" title="Up section"> Up </a>]</td>
<td valign="middle" align="left">[<a href="#Writing-R-documentation-files" title="Next chapter"> &gt;&gt; </a>]</td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left">[<a href="#Top" title="Cover (top) of document">Top</a>]</td>
<td valign="middle" align="left">[<a href="#SEC_Contents" title="Table of contents">Contents</a>]</td>
<td valign="middle" align="left">[<a href="#Function-and-variable-index" title="Index">Index</a>]</td>
<td valign="middle" align="left">[<a href="#SEC_About" title="About (help)"> ? </a>]</td>
</tr></table>
<a name="R-messages-1"></a>
<h3 class="subsection">1.9.2 R messages</h3>

<p>Mechanisms are also available to support the automatic translation of
R <code>stop</code>, <code>warning</code> and <code>message</code> messages.  They make
use of message catalogs in the same way as C-level messages, but using
domain <code>R-<var>pkg</var></code> rather than <code><var>pkg</var></code>.  Translation of
character strings inside <code>stop</code>, <code>warning</code> and <code>message</code>
calls is automatically enabled, as well as other messages enclosed in
calls to <code>gettext</code> or <code>gettextf</code>.  (To suppress this, use
argument <code>domain=NA</code>.)
</p>
<p>Tools to prepare the &lsquo;<tt>R-<var>pkg</var>.pot</tt>&rsquo; file are provided in package
<strong>tools</strong>: <code>xgettext2pot</code> will prepare a file from all strings
occurring inside <code>gettext</code>/<code>gettextf</code>, <code>stop</code>,
<code>warning</code> and <code>message</code> calls.  Some of these are likely to be
spurious and so the file is likely to need manual editing.
<code>xgettext</code> extracts the actual calls and so is more useful when
tidying up error messages.
</p>
<p>Translation of messages which might be singular or plural can be very
intricate: languages can have up to four different forms.  The R
function <code>ngettext</code> provides an interface to the C function of the
same name, and will choose an appropriate singular or plural form for
the selected language depending on the value of its first argument
<code>n</code>.  It is safest to use <code>domain=&quot;R-<var>pkg</var>&quot;</code> explicitly in
calls to <code>ngettext</code>, and necessary for earlier versions of R
unless they are calls directly from a function in the package.
</p>

<hr size="6">
<a name="Installing-translations"></a>
<table cellpadding="1" cellspacing="1" border="0">
<tr><td valign="middle" align="left">[<a href="#R-messages" title="Previous section in reading order"> &lt; </a>]</td>
<td valign="middle" align="left">[<a href="#Supporting-R-function" title="Next section in reading order"> &gt; </a>]</td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left">[<a href="#Creating-R-packages" title="Beginning of this chapter or previous chapter"> &lt;&lt; </a>]</td>
<td valign="middle" align="left">[<a href="#Internationalization" title="Up section"> Up </a>]</td>
<td valign="middle" align="left">[<a href="#Writing-R-documentation-files" title="Next chapter"> &gt;&gt; </a>]</td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left">[<a href="#Top" title="Cover (top) of document">Top</a>]</td>
<td valign="middle" align="left">[<a href="#SEC_Contents" title="Table of contents">Contents</a>]</td>
<td valign="middle" align="left">[<a href="#Function-and-variable-index" title="Index">Index</a>]</td>
<td valign="middle" align="left">[<a href="#SEC_About" title="About (help)"> ? </a>]</td>
</tr></table>
<a name="Installing-translations-1"></a>
<h3 class="subsection">1.9.3 Installing translations</h3>

<p>Once the template files have been created, translations can be made.
Conventional translations have file extension &lsquo;<tt>.po</tt>&rsquo; and are placed
in the &lsquo;<tt>po</tt>&rsquo; subdirectory of the package with a name that is either
&lsquo;<samp><var>ll</var>.po</samp>&rsquo; or &lsquo;<samp>R-<var>ll</var>.po</samp>&rsquo; for translations of the C and R
messages respectively to language with code &lsquo;<samp><var>ll</var></samp>&rsquo;.
</p>
<p>See &lsquo;Localization of messages&rsquo; in &lsquo;R Installation and Administration&rsquo;,
for details of language codes.
</p>
<p>Translations need to be prepared and installed in &lsquo;<tt>inst/po/</tt>&rsquo; to be
usable once the package is installed.  To do this use the appropriate
lines of
</p>
<table><tr><td>&nbsp;</td><td><pre class="example">mkdir -p inst/po/<var>ll</var>/LC_MESSAGES
msgfmt -c --statistics -o inst/po/<var>ll</var>/LC_MESSAGES/R-<var>pkg</var>.mo po/R-<var>ll</var>.po
msgfmt -c --statistics -o inst/po/<var>ll</var>/LC_MESSAGES/<var>pkg</var>.mo po/<var>ll</var>.po
</pre></td></tr></table>

<p>from the package&rsquo;s top-level directory.  Using &lsquo;<samp>-c</samp>&rsquo; does some
useful validity checks, and &lsquo;<samp>--statistics</samp>&rsquo; notes the coverage.
</p>
<p>Note that as from R 3.0.0 the location of the compiled translations
(the &lsquo;<tt>.mo</tt>&rsquo; file) is different for a standard package (stored in the
<strong>translations</strong> package) and a contributed one (stored in the
package&rsquo;s own sources).
</p>
<hr size="6">
<a name="Supporting-R-function"></a>
<table cellpadding="1" cellspacing="1" border="0">
<tr><td valign="middle" align="left">[<a href="#Installing-translations" title="Previous section in reading order"> &lt; </a>]</td>
<td valign="middle" align="left">[<a href="#CITATION-files" title="Next section in reading order"> &gt; </a>]</td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left">[<a href="#Creating-R-packages" title="Beginning of this chapter or previous chapter"> &lt;&lt; </a>]</td>
<td valign="middle" align="left">[<a href="#Internationalization" title="Up section"> Up </a>]</td>
<td valign="middle" align="left">[<a href="#Writing-R-documentation-files" title="Next chapter"> &gt;&gt; </a>]</td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left">[<a href="#Top" title="Cover (top) of document">Top</a>]</td>
<td valign="middle" align="left">[<a href="#SEC_Contents" title="Table of contents">Contents</a>]</td>
<td valign="middle" align="left">[<a href="#Function-and-variable-index" title="Index">Index</a>]</td>
<td valign="middle" align="left">[<a href="#SEC_About" title="About (help)"> ? </a>]</td>
</tr></table>
<a name="Supporting-R-function-1"></a>
<h3 class="subsection">1.9.4 Supporting R function</h3>

<p>As from R 3.0.0 there is an R function, <code>update_pkg_po</code> in
package <strong>tools</strong>, to automate much of the maintenance of message
translations.  See its help for what it does in detail.
</p>
<p>If this is called on a package with no existing translations, in creates
the directory &lsquo;<tt><var>pkgdir</var>/po</tt>&rsquo;, creates a template file of R
messages, &lsquo;<tt><var>pkgdir</var>/po/R-<var>pkg</var>.pot</tt>&rsquo;, within it, creates the
&lsquo;<samp>en@quot</samp>&rsquo; translation and installs that.  (The &lsquo;<samp>en@quot</samp>&rsquo;
pseudo-language interprets quotes in their directional forms in suitable
(e.g. UTF-8) locales.)
</p>
<p>If the package has C source files in its &lsquo;<tt>src</tt>&rsquo; directory
that are marked for translation, use
</p>
<table><tr><td>&nbsp;</td><td><pre class="example">touch <var>pkgdir</var>/po/<var>pkg</var>.pot
</pre></td></tr></table>

<p>to create a dummy template file, then call <code>update_pkg_po</code> again
(this can also be done before it is called for the first time).
</p>
<p>When translations to new languages are added in the &lsquo;<tt><var>pkgdir</var>/po</tt>&rsquo;
directory, running the same command will check and then
install the translations.
</p>
<p>If the package sources are updated, the same command will update the
template files, merge the changes into the translation &lsquo;<tt>.po</tt>&rsquo; files
and then installed the updated translations.  You will often see that
merging marks translations as &lsquo;fuzzy&rsquo; and this is reported in the
coverage statistics.  As fuzzy translations are <em>not</em> used, this is
an indication that the translation files need human attention.
</p>
<p>The merged translations are run through <code>tools::checkPofile</code> to
check that C-style formats are used correctly: if not the mismatches are
reported and the broken translations are not installed.
</p>
<p>This support need the GNU <code>gettext-tools</code>: there are usually
installed on Unix-alikes, and are available for Windows (see the help
page for <code>update_pkg_po</code>).
</p>

<a name="index-CITATION-1"></a>
<a name="index-citation-1"></a>
<hr size="6">
<a name="CITATION-files"></a>
<table cellpadding="1" cellspacing="1" border="0">
<tr><td valign="middle" align="left">[<a href="#Supporting-R-function" title="Previous section in reading order"> &lt; </a>]</td>
<td valign="middle" align="left">[<a href="#Package-types" title="Next section in reading order"> &gt; </a>]</td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left">[<a href="#Creating-R-packages" title="Beginning of this chapter or previous chapter"> &lt;&lt; </a>]</td>
<td valign="middle" align="left">[<a href="#Creating-R-packages" title="Up section"> Up </a>]</td>
<td valign="middle" align="left">[<a href="#Writing-R-documentation-files" title="Next chapter"> &gt;&gt; </a>]</td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left">[<a href="#Top" title="Cover (top) of document">Top</a>]</td>
<td valign="middle" align="left">[<a href="#SEC_Contents" title="Table of contents">Contents</a>]</td>
<td valign="middle" align="left">[<a href="#Function-and-variable-index" title="Index">Index</a>]</td>
<td valign="middle" align="left">[<a href="#SEC_About" title="About (help)"> ? </a>]</td>
</tr></table>
<a name="CITATION-files-1"></a>
<h2 class="section">1.10 CITATION files</h2>

<p>An installed file named &lsquo;<tt>CITATION</tt>&rsquo; will be used by the
<code>citation()</code> function.  (To be installed, it needed to be in the
&lsquo;<tt>inst</tt>&rsquo; subdirectory of the package sources.)
</p>
<p>The &lsquo;<tt>CITATION</tt>&rsquo; file is parsed as R code (in the package&rsquo;s
declared encoding, or in ASCII if none is declared).  If no such file is
present, <code>citation</code> auto-generates citation information from the
package &lsquo;<tt>DESCRIPTION</tt>&rsquo; metadata, and an example of what that would
look like as a &lsquo;<tt>CITATION</tt>&rsquo; file can be seen in recommended package
<a href="http://CRAN.R-project.org/package=nlme"><strong>nlme</strong></a> (see below): recommended packages <a href="http://CRAN.R-project.org/package=boot"><strong>boot</strong></a>,
<a href="http://CRAN.R-project.org/package=cluster"><strong>cluster</strong></a> and <a href="http://CRAN.R-project.org/package=mgcv"><strong>mgcv</strong></a> have further examples.
</p>
<p>A &lsquo;<tt>CITATION</tt>&rsquo; file will contain calls to function <code>bibentry</code>.
</p>
<p>Here is that for <a href="http://CRAN.R-project.org/package=nlme"><strong>nlme</strong></a>, re-formatted:
</p>
<table><tr><td>&nbsp;</td><td><pre class="example">citHeader(&quot;To cite package 'nlme' in publications use:&quot;)

year &lt;- sub(&quot;.*(2[[:digit:]]{3})-.*&quot;, &quot;\\1&quot;, meta$Date, perl = TRUE)
vers &lt;- paste(&quot;R package version&quot;, meta$Version)

citEntry(entry=&quot;Manual&quot;,
         title = &quot;nlme: Linear and Nonlinear Mixed Effects Models&quot;,
         author = personList(as.person(&quot;Jose Pinheiro&quot;),
                             as.person(&quot;Douglas Bates&quot;),
                             as.person(&quot;Saikat DebRoy&quot;),
                             as.person(&quot;Deepayan Sarkar&quot;),
                             person(&quot;R Core Team&quot;)),
         year = year,
         note = vers,

         textVersion =
         paste(&quot;Jose Pinheiro, Douglas Bates, Saikat DebRoy,&quot;,
               &quot;Deepayan Sarkar and the R Core Team (&quot;,
               year,
               &quot;). nlme: Linear and Nonlinear Mixed Effects Models. &quot;,
               vers, &quot;.&quot;, sep=&quot;&quot;))
</pre></td></tr></table>

<p>Note the way that information that may need to be updated is picked up
from the &lsquo;<tt>DESCRIPTION</tt>&rsquo; file &ndash; it is tempting to hardcode such
information, but it normally then gets outdated.  See <code>?bibentry</code>
for further details of the information which can be provided.
</p>
<p>The &lsquo;<tt>CITATION</tt>&rsquo; file should itself produce no output when
<code>source</code>-d.
</p>

<hr size="6">
<a name="Package-types"></a>
<table cellpadding="1" cellspacing="1" border="0">
<tr><td valign="middle" align="left">[<a href="#CITATION-files" title="Previous section in reading order"> &lt; </a>]</td>
<td valign="middle" align="left">[<a href="#Frontend" title="Next section in reading order"> &gt; </a>]</td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left">[<a href="#Creating-R-packages" title="Beginning of this chapter or previous chapter"> &lt;&lt; </a>]</td>
<td valign="middle" align="left">[<a href="#Creating-R-packages" title="Up section"> Up </a>]</td>
<td valign="middle" align="left">[<a href="#Writing-R-documentation-files" title="Next chapter"> &gt;&gt; </a>]</td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left">[<a href="#Top" title="Cover (top) of document">Top</a>]</td>
<td valign="middle" align="left">[<a href="#SEC_Contents" title="Table of contents">Contents</a>]</td>
<td valign="middle" align="left">[<a href="#Function-and-variable-index" title="Index">Index</a>]</td>
<td valign="middle" align="left">[<a href="#SEC_About" title="About (help)"> ? </a>]</td>
</tr></table>
<a name="Package-types-1"></a>
<h2 class="section">1.11 Package types</h2>

<p>The &lsquo;<tt>DESCRIPTION</tt>&rsquo; file has an optional field <code>Type</code> which if
missing is assumed to be &lsquo;<samp>Package</samp>&rsquo;, the sort of extension discussed
so far in this chapter.  Currently one other type is recognized; there
used also to be a &lsquo;<samp>Translation</samp>&rsquo; type.
</p>
<table class="menu" border="0" cellspacing="0">
<tr><td align="left" valign="top"><a href="#Frontend">1.11.1 Frontend</a></td><td>&nbsp;&nbsp;</td><td align="left" valign="top">                    
</td></tr>
</table>

<hr size="6">
<a name="Frontend"></a>
<table cellpadding="1" cellspacing="1" border="0">
<tr><td valign="middle" align="left">[<a href="#Package-types" title="Previous section in reading order"> &lt; </a>]</td>
<td valign="middle" align="left">[<a href="#Services" title="Next section in reading order"> &gt; </a>]</td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left">[<a href="#Creating-R-packages" title="Beginning of this chapter or previous chapter"> &lt;&lt; </a>]</td>
<td valign="middle" align="left">[<a href="#Package-types" title="Up section"> Up </a>]</td>
<td valign="middle" align="left">[<a href="#Writing-R-documentation-files" title="Next chapter"> &gt;&gt; </a>]</td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left">[<a href="#Top" title="Cover (top) of document">Top</a>]</td>
<td valign="middle" align="left">[<a href="#SEC_Contents" title="Table of contents">Contents</a>]</td>
<td valign="middle" align="left">[<a href="#Function-and-variable-index" title="Index">Index</a>]</td>
<td valign="middle" align="left">[<a href="#SEC_About" title="About (help)"> ? </a>]</td>
</tr></table>
<a name="Frontend-1"></a>
<h3 class="subsection">1.11.1 Frontend</h3>

<p>This is a rather general mechanism, designed for adding new front-ends
such as the former <strong>gnomeGUI</strong> package (see the &lsquo;<tt>Archive</tt>&rsquo; area on
<acronym>CRAN</acronym>).  If a &lsquo;<tt>configure</tt>&rsquo; file is found in the top-level
directory of the package it is executed, and then if a <code>Makefile</code>
is found (often generated by &lsquo;<tt>configure</tt>&rsquo;), <code>make</code> is called.
If <code>R CMD INSTALL --clean</code> is used <code>make clean</code> is called.  No
other action is taken.
</p>
<p><code>R CMD build</code> can package up this type of extension, but <code>R
CMD check</code> will check the type and skip it.
</p>
<p>Many packages of this type need write permission for the R
installation directory.
</p>
<hr size="6">
<a name="Services"></a>
<table cellpadding="1" cellspacing="1" border="0">
<tr><td valign="middle" align="left">[<a href="#Frontend" title="Previous section in reading order"> &lt; </a>]</td>
<td valign="middle" align="left">[<a href="#Writing-R-documentation-files" title="Next section in reading order"> &gt; </a>]</td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left">[<a href="#Creating-R-packages" title="Beginning of this chapter or previous chapter"> &lt;&lt; </a>]</td>
<td valign="middle" align="left">[<a href="#Creating-R-packages" title="Up section"> Up </a>]</td>
<td valign="middle" align="left">[<a href="#Writing-R-documentation-files" title="Next chapter"> &gt;&gt; </a>]</td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left">[<a href="#Top" title="Cover (top) of document">Top</a>]</td>
<td valign="middle" align="left">[<a href="#SEC_Contents" title="Table of contents">Contents</a>]</td>
<td valign="middle" align="left">[<a href="#Function-and-variable-index" title="Index">Index</a>]</td>
<td valign="middle" align="left">[<a href="#SEC_About" title="About (help)"> ? </a>]</td>
</tr></table>
<a name="Services-1"></a>
<h2 class="section">1.12 Services</h2>

<p>Several members of the R project have set up services to assist those
writing R packages, particularly those intended for public
distribution.
</p>
<p><a href="http://win-builder.r-project.org">win-builder.r-project.org</a>
offers the automated preparation of (32/64-bit) Windows binaries from
well-tested source packages.
</p>
<p>R-Forge (<a href="http://R-Forge.r-project.org">R-Forge.r-project.org</a>) and
RForge (<a href="http://www.rforge.net">www.rforge.net</a>) are similar
services with similar names.  Both provide source-code management
through SVN, daily building and checking, mailing lists and a repository
that can be accessed <em>via</em> <code>install.packages</code> (they can be
selected by <code>setRepositories</code> and the GUI menus that use it).
Package developers have the opportunity to present their work on the
basis of project websites or news announcements.  Mailing lists, forums
or wikis provide useRs with convenient instruments for discussions and
for exchanging information between developers and/or interested useRs.
</p>

<hr size="6">
<a name="Writing-R-documentation-files"></a>
<table cellpadding="1" cellspacing="1" border="0">
<tr><td valign="middle" align="left">[<a href="#Services" title="Previous section in reading order"> &lt; </a>]</td>
<td valign="middle" align="left">[<a href="#Rd-format" title="Next section in reading order"> &gt; </a>]</td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left">[<a href="#Creating-R-packages" title="Beginning of this chapter or previous chapter"> &lt;&lt; </a>]</td>
<td valign="middle" align="left">[<a href="#Top" title="Up section"> Up </a>]</td>
<td valign="middle" align="left">[<a href="#Tidying-and-profiling-R-code" title="Next chapter"> &gt;&gt; </a>]</td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left">[<a href="#Top" title="Cover (top) of document">Top</a>]</td>
<td valign="middle" align="left">[<a href="#SEC_Contents" title="Table of contents">Contents</a>]</td>
<td valign="middle" align="left">[<a href="#Function-and-variable-index" title="Index">Index</a>]</td>
<td valign="middle" align="left">[<a href="#SEC_About" title="About (help)"> ? </a>]</td>
</tr></table>
<a name="Writing-R-documentation-files-1"></a>
<h1 class="chapter">2. Writing R documentation files</h1>
<a name="index-Documentation_002c-writing"></a>

<table class="menu" border="0" cellspacing="0">
<tr><td align="left" valign="top"><a href="#Rd-format">2.1 Rd format</a></td><td>&nbsp;&nbsp;</td><td align="left" valign="top">                   
</td></tr>
<tr><td align="left" valign="top"><a href="#Sectioning">2.2 Sectioning</a></td><td>&nbsp;&nbsp;</td><td align="left" valign="top">                  
</td></tr>
<tr><td align="left" valign="top"><a href="#Marking-text">2.3 Marking text</a></td><td>&nbsp;&nbsp;</td><td align="left" valign="top">                
</td></tr>
<tr><td align="left" valign="top"><a href="#Lists-and-tables">2.4 Lists and tables</a></td><td>&nbsp;&nbsp;</td><td align="left" valign="top">            
</td></tr>
<tr><td align="left" valign="top"><a href="#Cross_002dreferences">2.5 Cross-references</a></td><td>&nbsp;&nbsp;</td><td align="left" valign="top">            
</td></tr>
<tr><td align="left" valign="top"><a href="#Mathematics">2.6 Mathematics</a></td><td>&nbsp;&nbsp;</td><td align="left" valign="top">                 
</td></tr>
<tr><td align="left" valign="top"><a href="#Figures">2.7 Figures</a></td><td>&nbsp;&nbsp;</td><td align="left" valign="top">                     
</td></tr>
<tr><td align="left" valign="top"><a href="#Insertions">2.8 Insertions</a></td><td>&nbsp;&nbsp;</td><td align="left" valign="top">                  
</td></tr>
<tr><td align="left" valign="top"><a href="#Indices">2.9 Indices</a></td><td>&nbsp;&nbsp;</td><td align="left" valign="top">                     
</td></tr>
<tr><td align="left" valign="top"><a href="#Platform_002dspecific-sections">2.10 Platform-specific documentation</a></td><td>&nbsp;&nbsp;</td><td align="left" valign="top">  
</td></tr>
<tr><td align="left" valign="top"><a href="#Conditional-text">2.11 Conditional text</a></td><td>&nbsp;&nbsp;</td><td align="left" valign="top">            
</td></tr>
<tr><td align="left" valign="top"><a href="#Dynamic-pages">2.12 Dynamic pages</a></td><td>&nbsp;&nbsp;</td><td align="left" valign="top">               
</td></tr>
<tr><td align="left" valign="top"><a href="#User_002ddefined-macros">2.13 User-defined macros</a></td><td>&nbsp;&nbsp;</td><td align="left" valign="top">         
</td></tr>
<tr><td align="left" valign="top"><a href="#Encoding">2.14 Encoding</a></td><td>&nbsp;&nbsp;</td><td align="left" valign="top">                    
</td></tr>
<tr><td align="left" valign="top"><a href="#Processing-Rd-format">2.15 Processing Rd format</a></td><td>&nbsp;&nbsp;</td><td align="left" valign="top">        
</td></tr>
<tr><td align="left" valign="top"><a href="#Editing-Rd-files">2.16 Editing Rd files</a></td><td>&nbsp;&nbsp;</td><td align="left" valign="top">            
</td></tr>
</table>

<hr size="6">
<a name="Rd-format"></a>
<table cellpadding="1" cellspacing="1" border="0">
<tr><td valign="middle" align="left">[<a href="#Writing-R-documentation-files" title="Previous section in reading order"> &lt; </a>]</td>
<td valign="middle" align="left">[<a href="#Documenting-functions" title="Next section in reading order"> &gt; </a>]</td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left">[<a href="#Writing-R-documentation-files" title="Beginning of this chapter or previous chapter"> &lt;&lt; </a>]</td>
<td valign="middle" align="left">[<a href="#Writing-R-documentation-files" title="Up section"> Up </a>]</td>
<td valign="middle" align="left">[<a href="#Tidying-and-profiling-R-code" title="Next chapter"> &gt;&gt; </a>]</td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left">[<a href="#Top" title="Cover (top) of document">Top</a>]</td>
<td valign="middle" align="left">[<a href="#SEC_Contents" title="Table of contents">Contents</a>]</td>
<td valign="middle" align="left">[<a href="#Function-and-variable-index" title="Index">Index</a>]</td>
<td valign="middle" align="left">[<a href="#SEC_About" title="About (help)"> ? </a>]</td>
</tr></table>
<a name="Rd-format-1"></a>
<h2 class="section">2.1 Rd format</h2>

<p>R objects are documented in files written in &ldquo;R documentation&rdquo;
(Rd) format, a simple markup language much of which closely resembles
(La)TeX, which can be processed into a variety of formats,
including LaTeX, <acronym>HTML</acronym> and plain text.  The translation is
carried out by functions in the <strong>tools</strong> package called by the
script <code>Rdconv</code> in &lsquo;<tt><var>R_HOME</var>/bin</tt>&rsquo; and by the
installation scripts for packages.
</p>
<p>The R distribution contains more than 1300 such files which can be
found in the &lsquo;<tt>src/library/<var>pkg</var>/man</tt>&rsquo; directories of the R
source tree, where <var>pkg</var> stands for one of the standard packages
which are included in the R distribution.
</p>
<p>As an example, let us look at a simplified version of
&lsquo;<tt>src/library/base/man/load.Rd</tt>&rsquo; which documents the R function
<code>load</code>.
</p>
<blockquote><table class="cartouche" border="1"><tr><td>
<table><tr><td>&nbsp;</td><td><pre class="smallexample">% File src/library/base/man/load.Rd
\name{load}
\alias{load}
\title{Reload Saved Datasets}
\description{
  Reload the datasets written to a file with the function
  \code{save}.
}
\usage{
load(file, envir = parent.frame())
}
\arguments{
  \item{file}{a connection or a character string giving the
    name of the file to load.}
  \item{envir}{the environment where the data should be
    loaded.}
}
\seealso{
  \code{\link{save}}.
}
\examples{
## save all data
save(list = ls(), file= &quot;all.RData&quot;)

## restore the saved values to the current environment
load(&quot;all.RData&quot;)

## restore the saved values to the workspace
load(&quot;all.RData&quot;, .GlobalEnv)
}
\keyword{file}
</pre></td></tr></table>
</td></tr></table>
</blockquote>

<p>An &lsquo;<tt>Rd</tt>&rsquo; file consists of three parts.  The header gives basic
information about the name of the file, the topics documented, a title,
a short textual description and R usage information for the objects
documented.  The body gives further information (for example, on the
function&rsquo;s arguments and return value, as in the above example).
Finally, there is an optional footer with keyword information.  The
header is mandatory.
</p>
<p>Information is given within a series of <em>sections</em> with standard
names (and user-defined sections are also allowed).  Unless otherwise
specified<a name="DOCF51" href="#FOOT51">(51)</a> these should occur only once in an &lsquo;<tt>Rd</tt>&rsquo;
file (in any order), and the processing software will retain only the
first occurrence of a standard section in the file, with a warning.
</p>
<p>See <a href="http://developer.r-project.org/Rds.html">&ldquo;Guidelines for Rd files&rdquo;</a> for guidelines for writing documentation in &lsquo;<tt>Rd</tt>&rsquo; format
which should be useful for package writers.
<a name="index-prompt"></a>
The R
generic function <code>prompt</code> is used to construct a bare-bones &lsquo;<tt>Rd</tt>&rsquo;
file ready for manual editing.  Methods are defined for documenting
functions (which fill in the proper function and argument names) and
data frames.  There are also functions <code>promptData</code>,
<code>promptPackage</code>, <code>promptClass</code>, and <code>promptMethods</code> for
other types of &lsquo;<tt>Rd</tt>&rsquo; file.
</p>
<p>The general syntax of &lsquo;<tt>Rd</tt>&rsquo; files is summarized below.  For a detailed
technical discussion of current &lsquo;<tt>Rd</tt>&rsquo; syntax, see
<a href="http://developer.r-project.org/parseRd.pdf">&ldquo;Parsing Rd files&rdquo;</a>.
Note that there have been a number of changes to the &lsquo;<tt>Rd</tt>&rsquo; format over the
years, which can be important if a package is intended to be used with
earlier versions of R: see earlier versions of this manual if a
package is intended to be used with R before 2.10.0.
</p>
<p>&lsquo;<tt>Rd</tt>&rsquo; files consists of three types of text input.  The most common
is LaTeX-like, with the backslash used as a prefix on markup
(e.g. <code>\alias</code>), and braces used to indicate arguments
(e.g. <code>{load}</code>).  The least common type of text is verbatim text,
where no markup is processed. The third type is R-like, intended for
R code, but allowing some embedded macros.  Quoted strings within
R-like text are handled specially: regular character escapes such as
<code>\n</code> may be entered as-is.  Only markup starting with <code>\l</code>
(e.g.  <code>\link</code>) or <code>\v</code> (e.g. <code>\var</code>) will be recognized
within quoted strings.  The rarely used vertical tab <code>\v</code> must be
entered as <code>\\v</code>.
</p>
<p>Each macro defines the input type for its argument.  For example, the
file initially uses LaTeX-like syntax, and this is also used in the
<code>\description</code> section, but the <code>\usage</code> section uses
R-like syntax, and the <code>\alias</code> macro uses verbatim syntax.
Comments run from a percent symbol <code>%</code> to the end of the line in
all types of text (as on the first line of the <code>load</code> example).
</p>
<p>Because backslashes, braces and percent symbols have special meaning, to
enter them into text sometimes requires escapes using a backslash.  In
general balanced braces do not need to be escaped, but percent symbols
always do.  For the complete list of macros and rules for escapes, see
<a href="http://developer.r-project.org/parseRd.pdf">&ldquo;Parsing Rd files&rdquo;</a>.
</p>
<table class="menu" border="0" cellspacing="0">
<tr><td align="left" valign="top"><a href="#Documenting-functions">2.1.1 Documenting functions</a></td><td>&nbsp;&nbsp;</td><td align="left" valign="top">       
</td></tr>
<tr><td align="left" valign="top"><a href="#Documenting-data-sets">2.1.2 Documenting data sets</a></td><td>&nbsp;&nbsp;</td><td align="left" valign="top">       
</td></tr>
<tr><td align="left" valign="top"><a href="#Documenting-S4-classes-and-methods">2.1.3 Documenting S4 classes and methods</a></td><td>&nbsp;&nbsp;</td><td align="left" valign="top">  
</td></tr>
<tr><td align="left" valign="top"><a href="#Documenting-packages">2.1.4 Documenting packages</a></td><td>&nbsp;&nbsp;</td><td align="left" valign="top">        
</td></tr>
</table>

<hr size="6">
<a name="Documenting-functions"></a>
<table cellpadding="1" cellspacing="1" border="0">
<tr><td valign="middle" align="left">[<a href="#Rd-format" title="Previous section in reading order"> &lt; </a>]</td>
<td valign="middle" align="left">[<a href="#Documenting-data-sets" title="Next section in reading order"> &gt; </a>]</td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left">[<a href="#Writing-R-documentation-files" title="Beginning of this chapter or previous chapter"> &lt;&lt; </a>]</td>
<td valign="middle" align="left">[<a href="#Rd-format" title="Up section"> Up </a>]</td>
<td valign="middle" align="left">[<a href="#Tidying-and-profiling-R-code" title="Next chapter"> &gt;&gt; </a>]</td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left">[<a href="#Top" title="Cover (top) of document">Top</a>]</td>
<td valign="middle" align="left">[<a href="#SEC_Contents" title="Table of contents">Contents</a>]</td>
<td valign="middle" align="left">[<a href="#Function-and-variable-index" title="Index">Index</a>]</td>
<td valign="middle" align="left">[<a href="#SEC_About" title="About (help)"> ? </a>]</td>
</tr></table>
<a name="Documenting-functions-1"></a>
<h3 class="subsection">2.1.1 Documenting functions</h3>

<p>The basic markup commands used for documenting R objects (in
particular, functions) are given in this subsection.
</p>
<dl compact="compact">
<dt> <code>\name{<var>name</var>}</code></dt>
<dd><a name="index-_005cname"></a>
<p><var>name</var> typically<a name="DOCF52" href="#FOOT52">(52)</a> is the basename of
the &lsquo;<tt>Rd</tt>&rsquo; file containing the documentation.  It is the &ldquo;name&rdquo; of
the &lsquo;<tt>Rd</tt>&rsquo; object represented by the file and has to be unique in a
package.  To avoid problems with indexing the package manual, it may not
contain &lsquo;<samp>!</samp>&rsquo;  &lsquo;<samp>|</samp>&rsquo; nor &lsquo;<samp>@</samp>&rsquo;, and to avoid possible problems
with the HTML help system it should not contain &lsquo;<samp>/</samp>&rsquo; nor a space.
(LaTeX special characters are allowed, but may not be collated
correctly in the index.)  There can only be one <code>\name</code> entry in a
file, and it must not contain any markup.  Entries in the package manual
will be in alphabetic<a name="DOCF53" href="#FOOT53">(53)</a> order
of the <code>\name</code> entries.
</p>
</dd>
<dt> <code>\alias{<var>topic</var>}</code></dt>
<dd><a name="index-_005calias"></a>
<p>The <code>\alias</code> sections specify all &ldquo;topics&rdquo; the file documents.
This information is collected into index data bases for lookup by the
on-line (plain text and <acronym>HTML</acronym>) help systems.  The <var>topic</var> can
contain spaces, but (for historical reasons) leading and trailing spaces
will be stripped.  Percent and left brace need to be escaped by
a backslash.
</p>
<p>There may be several <code>\alias</code> entries.  Quite often it is
convenient to document several R objects in one file.  For example,
file &lsquo;<tt>Normal.Rd</tt>&rsquo; documents the density, distribution function,
quantile function and generation of random variates for the normal
distribution, and hence starts with
</p>
<table><tr><td>&nbsp;</td><td><pre class="example">\name{Normal}
\alias{Normal}
\alias{dnorm}
\alias{pnorm}
\alias{qnorm}
\alias{rnorm}
</pre></td></tr></table>

<p>Also, it is often convenient to have several different ways to refer to
an R object, and an <code>\alias</code> does not need to be the name of an
object.
</p>
<p>Note that the <code>\name</code> is not necessarily a topic documented, and if
so desired it needs to have an explicit <code>\alias</code> entry (as in this
example).
</p>
</dd>
<dt> <code>\title{<var>Title</var>}</code></dt>
<dd><a name="index-_005ctitle"></a>
<p>Title information for the &lsquo;<tt>Rd</tt>&rsquo; file.  This should be capitalized
and not end in a period; try to limit its length to at most 65
characters for widest compatibility.
</p>
<p>Since R version 2.12.0 markup has been supported
in the text, but use of characters other than English text and
punctuation (e.g., &lsquo;<samp>&lt;</samp>&rsquo;) may limit portability.
</p>
<p>There must be one (and only one) <code>\title</code> section in a help file.
</p>
</dd>
<dt> <code>\description{&hellip;}</code></dt>
<dd><a name="index-_005cdescription"></a>
<p>A short description of what the function(s) do(es) (one paragraph, a few
lines only).  (If a description is too long and cannot easily be
shortened, the file probably tries to document too much at once.)
This is mandatory except for package-overview files.
</p>
</dd>
<dt> <code>\usage{<var>fun</var>(<var>arg1</var>, <var>arg2</var>, &hellip;)}</code></dt>
<dd><a name="index-_005cusage"></a>
<p>One or more lines showing the synopsis of the function(s) and variables
documented in the file.  These are set in typewriter font.  This is an
R-like command.
</p>
<p>The usage information specified should match the function definition
<em>exactly</em> (such that automatic checking for consistency between
code and documentation is possible).
</p>
<p>It is no longer advisable to use <code>\synopsis</code> for the actual
synopsis and show modified synopses in the <code>\usage</code>.  Support for
<code>\synopsis</code> will be removed eventually.  To indicate that a
function can be used in several different ways, depending on the named
arguments specified, use section <code>\details</code>.  E.g.,
&lsquo;<tt>abline.Rd</tt>&rsquo; contains
</p>
<table><tr><td>&nbsp;</td><td><pre class="example">\details{
  Typical usages are
\preformatted{
abline(a, b, untf = FALSE, \dots)
......
}
</pre></td></tr></table>

<a name="index-_005cmethod"></a>
<p>Use <code>\method{<var>generic</var>}{<var>class</var>}</code> to indicate the name
of an S3 method for the generic function <var>generic</var> for objects
inheriting from class <code>&quot;<var>class</var>&quot;</code>.  In the printed versions,
this will come out as <var>generic</var> (reflecting the understanding that
methods should not be invoked directly but <em>via</em> method dispatch), but
<code>codoc()</code> and other QC tools always have access to the full name.
</p>
<p>For example, &lsquo;<tt>print.ts.Rd</tt>&rsquo; contains
</p>
<table><tr><td>&nbsp;</td><td><pre class="example">\usage{
\method{print}{ts}(x, calendar, \dots)
}
</pre></td></tr></table>

<p>which will print as
</p>
<table><tr><td>&nbsp;</td><td><pre class="example">Usage:

     ## S3 method for class 'ts':
     print(x, calendar, ...)
</pre></td></tr></table>

<p>Usage for replacement functions should be given in the style of
<code>dim(x) &lt;- value</code> rather than explicitly indicating the name of the
replacement function (<code>&quot;dim&lt;-&quot;</code> in the above).  Similarly, one
can use <code>\method{<var>generic</var>}{<var>class</var>}(<var>arglist</var>) &lt;-
value</code> to indicate the usage of an S3 replacement method for the generic
replacement function <code>&quot;<var>generic</var>&lt;-&quot;</code> for objects inheriting
from class <code>&quot;<var>class</var>&quot;</code>.
</p>
<p>Usage for S3 methods for extracting or replacing parts of an object, S3
methods for members of the Ops group, and S3 methods for user-defined
(binary) infix operators (&lsquo;<samp>%<var>xxx</var>%</samp>&rsquo;) follows the above rules,
using the appropriate function names.  E.g., &lsquo;<tt>Extract.factor.Rd</tt>&rsquo;
contains
</p>
<table><tr><td>&nbsp;</td><td><pre class="example">\usage{
\method{[}{factor}(x, \dots, drop = FALSE)
\method{[[}{factor}(x, \dots)
\method{[}{factor}(x, \dots) &lt;- value
}
</pre></td></tr></table>

<p>which will print as
</p>
<table><tr><td>&nbsp;</td><td><pre class="example">Usage:

     ## S3 method for class 'factor':
     x[..., drop = FALSE]
     ## S3 method for class 'factor':
     x[[...]]
     ## S3 replacement method for class 'factor':
     x[...] &lt;- value
</pre></td></tr></table>

<a name="index-_005cS3method"></a>
<p><code>\S3method</code> is accepted as an alternative to <code>\method</code>.
</p>
</dd>
<dt> <code>\arguments{&hellip;}</code></dt>
<dd><a name="index-_005carguments"></a>
<p>Description of the function&rsquo;s arguments, using an entry of the form
</p>
<table><tr><td>&nbsp;</td><td><pre class="example">\item{<var>arg_i</var>}{<var>Description of arg_i</var>.}
</pre></td></tr></table>

<p>for each element of the argument list.  (Note that there is
no whitespace between the three parts of the entry.) There may be
optional text outside the <code>\item</code> entries, for example to give
general information about groups of parameters.
</p>

</dd>
<dt> <code>\details{&hellip;}</code></dt>
<dd><a name="index-_005cdetails"></a>
<p>A detailed if possible precise description of the functionality
provided, extending the basic information in the <code>\description</code>
slot.
</p>
</dd>
<dt> <code>\value{&hellip;}</code></dt>
<dd><a name="index-_005cvalue"></a>
<p>Description of the function&rsquo;s return value.
</p>
<p>If a list with multiple values is returned, you can use entries of the
form
</p>
<table><tr><td>&nbsp;</td><td><pre class="example">\item{<var>comp_i</var>}{<var>Description of comp_i</var>.}
</pre></td></tr></table>

<p>for each component of the list returned.  Optional text may
precede<a name="DOCF54" href="#FOOT54">(54)</a> this list (see for example the help
for <code>rle</code>).  Note that <code>\value</code> is implicitly a
<code>\describe</code> environment, so that environment should not be used for
listing components, just individual <code>\item{}{}</code> entries.
</p>
</dd>
<dt> <code>\references{&hellip;}</code></dt>
<dd><a name="index-_005creferences"></a>
<p>A section with references to the literature.  Use <code>\url{}</code> or
<code>\href{}{}</code> for web pointers.
</p>
</dd>
<dt> <code>\note{...}</code></dt>
<dd><a name="index-_005cnote"></a>
<p>Use this for a special note you want to have pointed out.  Multiple
<code>\note</code> sections are allowed, but might be confusing to the end users.
</p>
<p>For example, &lsquo;<tt>pie.Rd</tt>&rsquo; contains
</p>
<table><tr><td>&nbsp;</td><td><pre class="example">\note{
  Pie charts are a very bad way of displaying information.
  The eye is good at judging linear measures and bad at
  judging relative areas.
  ......
}
</pre></td></tr></table>

</dd>
<dt> <code>\author{&hellip;}</code></dt>
<dd><a name="index-_005cauthor"></a>
<p>Information about the author(s) of the &lsquo;<tt>Rd</tt>&rsquo; file.  Use
<code>\email{}</code> without extra delimiters (such as &lsquo;<samp>( )</samp>&rsquo; or
&lsquo;<samp>&lt; &gt;</samp>&rsquo;) to specify email addresses, or <code>\url{}</code> or
<code>\href{}{}</code> for web pointers.
</p>
</dd>
<dt> <code>\seealso{&hellip;}</code></dt>
<dd><a name="index-_005cseealso"></a>
<p>Pointers to related R objects, using <code>\code{\link{...}}</code> to
refer to them (<code>\code</code> is the correct markup for R object names,
and <code>\link</code> produces hyperlinks in output formats which support
this.  See section <a href="#Marking-text">Marking text</a>, and <a href="#Cross_002dreferences">Cross-references</a>).
</p>
<a name="index-_005cexamples"></a>
</dd>
<dt> <code>\examples{&hellip;}</code></dt>
<dd><p>Examples of how to use the function.  Code in this section is set
in typewriter font without reformatting and is run by
<code>example()</code> unless marked otherwise (see below).
</p>
<p>Examples are not only useful for documentation purposes, but also
provide test code used for diagnostic checking of R code.  By
default, text inside <code>\examples{}</code> will be displayed in the
output of the help page and run by <code>example()</code> and by <code>R CMD
check</code>.  You can use <code>\dontrun{}</code>
<a name="index-_005cdontrun"></a>
for text that should only be shown, but not run, and
<code>\dontshow{}</code>
<a name="index-_005cdontshow"></a>
for extra commands for testing that should not be shown to users, but
will be run by <code>example()</code>.  (Previously this was called
<code>\testonly</code>, and that is still accepted.)
</p>
<p>Text inside <code>\dontrun{}</code> is verbatim, but the other parts
of the <code>\examples</code> section are R-like text.
</p>
<p>For example,
</p>
<table><tr><td>&nbsp;</td><td><pre class="example">x &lt;- runif(10)       # <span class="roman">Shown and run.</span>
\dontrun{plot(x)}    # <span class="roman">Only shown.</span>
\dontshow{log(x)}    # <span class="roman">Only run.</span>
</pre></td></tr></table>

<p>Thus, example code not included in <code>\dontrun</code> must be executable!
In addition, it should not use any system-specific features or require
special facilities (such as Internet access or write permission to
specific directories).  Text included in <code>\dontrun</code> is indicated by
comments in the processed help files: it need not be valid R code but
the escapes must still be used for <code>%</code>, <code>\</code> and unpaired
braces as in other verbatim text.
</p>
<p>Example code must be capable of being run by <code>example</code>, which uses
<code>source</code>.  This means that it should not access &lsquo;<tt>stdin</tt>&rsquo;,
e.g. to <code>scan()</code> data from the example file.
</p>
<p>Data needed for making the examples executable can be obtained by random
number generation (for example, <code>x &lt;- rnorm(100)</code>), or by using
standard data sets listed by <code>data()</code> (see <code>?data</code> for more
info).
</p>
<p>Finally, there is <code>\donttest</code>, used (at the beginning of a separate
line) to mark code that should be run by <code>examples()</code> but not by
<code>R CMD check</code>.  This should be needed only occasionally but can be
used for code which might fail in circumstances that are hard to test
for, for example in some locales.  (Use e.g. <code>capabilities()</code> to
test for features needed in the examples wherever possible, and you can
also use <code>try()</code> or <code>tryCatch()</code>.)
</p>
<a name="index-_005ckeyword"></a>
</dd>
<dt> <code>\keyword{<var>key</var>}</code></dt>
<dd><p>There can be zero or more <code>\keyword</code> sections per file.
Each <code>\keyword</code> section should specify a single keyword, preferably
one of the standard keywords as listed in file &lsquo;<tt>KEYWORDS</tt>&rsquo; in the
R documentation directory (default &lsquo;<tt><var>R_HOME</var>/doc</tt>&rsquo;).  Use
e.g. <code>RShowDoc(&quot;KEYWORDS&quot;)</code> to inspect the standard keywords from
within R.  There can be more than one <code>\keyword</code> entry if the R
object being documented falls into more than one category, or none.
</p>
<p>The special keyword &lsquo;<samp>internal</samp>&rsquo; marks a page of internal objects
that are not part of the package&rsquo;s API.  If the help page for object
<code>foo</code> has keyword &lsquo;<samp>internal</samp>&rsquo;, then <code>help(foo)</code> gives this
help page, but <code>foo</code> is excluded from several object indices,
including the alphabetical list of objects in the <acronym>HTML</acronym> help system.
</p>
<p><code>help.search()</code> can search by keyword, including user-defined
values: however the &lsquo;Search Engine &amp; Keywords&rsquo; HTML page accessed
<em>via</em> <code>help.start()</code> provides single-click access only to a
pre-defined list of keywords.
</p></dd>
</dl>


<hr size="6">
<a name="Documenting-data-sets"></a>
<table cellpadding="1" cellspacing="1" border="0">
<tr><td valign="middle" align="left">[<a href="#Documenting-functions" title="Previous section in reading order"> &lt; </a>]</td>
<td valign="middle" align="left">[<a href="#Documenting-S4-classes-and-methods" title="Next section in reading order"> &gt; </a>]</td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left">[<a href="#Writing-R-documentation-files" title="Beginning of this chapter or previous chapter"> &lt;&lt; </a>]</td>
<td valign="middle" align="left">[<a href="#Rd-format" title="Up section"> Up </a>]</td>
<td valign="middle" align="left">[<a href="#Tidying-and-profiling-R-code" title="Next chapter"> &gt;&gt; </a>]</td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left">[<a href="#Top" title="Cover (top) of document">Top</a>]</td>
<td valign="middle" align="left">[<a href="#SEC_Contents" title="Table of contents">Contents</a>]</td>
<td valign="middle" align="left">[<a href="#Function-and-variable-index" title="Index">Index</a>]</td>
<td valign="middle" align="left">[<a href="#SEC_About" title="About (help)"> ? </a>]</td>
</tr></table>
<a name="Documenting-data-sets-1"></a>
<h3 class="subsection">2.1.2 Documenting data sets</h3>

<p>The structure of &lsquo;<tt>Rd</tt>&rsquo; files which document R data sets is slightly
different.  Sections such as <code>\arguments</code> and <code>\value</code> are not
needed but the format and source of the data should be explained.
</p>
<p>As an example, let us look at &lsquo;<tt>src/library/datasets/man/rivers.Rd</tt>&rsquo;
which documents the standard R data set <code>rivers</code>.
</p>
<blockquote><table class="cartouche" border="1"><tr><td>
<table><tr><td>&nbsp;</td><td><pre class="smallexample">\name{rivers}
\docType{data}
\alias{rivers}
\title{Lengths of Major North American Rivers}
\description{
  This data set gives the lengths (in miles) of 141 \dQuote{major}
  rivers in North America, as compiled by the US Geological
  Survey.
}
\usage{rivers}
\format{A vector containing 141 observations.}
\source{World Almanac and Book of Facts, 1975, page 406.}
\references{
  McNeil, D. R. (1977) \emph{Interactive Data Analysis}.
  New York: Wiley.
}
\keyword{datasets}
</pre></td></tr></table>
</td></tr></table>
</blockquote>

<p>This uses the following additional markup commands.
</p>
<dl compact="compact">
<dt> <code>\docType{&hellip;}</code></dt>
<dd><p>Indicates the &ldquo;type&rdquo; of the documentation object.  Always &lsquo;<samp>data</samp>&rsquo;
for data sets, and &lsquo;<samp>package</samp>&rsquo; for &lsquo;<tt><var>pkg</var>-package.Rd</tt>&rsquo;
overview files.  Documentation for S4 methods and classes uses
&lsquo;<samp>methods</samp>&rsquo; (from <code>promptMethods()</code>) and &lsquo;<samp>class</samp>&rsquo; (from
<code>promptClass()</code>).
</p>
</dd>
<dt> <code>\format{&hellip;}</code></dt>
<dd><a name="index-_005cformat"></a>
<p>A description of the format of the data set (as a vector, matrix, data
frame, time series, &hellip;).  For matrices and data frames this should
give a description of each column, preferably as a list or table.
See section <a href="#Lists-and-tables">Lists and tables</a>, for more information.
</p>
</dd>
<dt> <code>\source{&hellip;}</code></dt>
<dd><a name="index-_005csource"></a>
<p>Details of the original source (a reference or <acronym>URL</acronym>).  In
addition, section <code>\references</code> could give secondary sources and
usages.
</p></dd>
</dl>

<p>Note also that when documenting data set <var>bar</var>,
</p>
<ul>
<li>
The <code>\usage</code> entry is always <code><var>bar</var></code> or (for packages
which do not use lazy-loading of data) <code>data(<var>bar</var>)</code>.  (In
particular, only document a <em>single</em> data object per &lsquo;<tt>Rd</tt>&rsquo; file.)
</li><li>
The <code>\keyword</code> entry should always be &lsquo;<samp>datasets</samp>&rsquo;.
</li></ul>

<p>If <code><var>bar</var></code> is a data frame, documenting it as a data set can
be initiated <em>via</em> <code>prompt(<var>bar</var>)</code>.  Otherwise, the <code>promptData</code>
function may be used.
</p>
<hr size="6">
<a name="Documenting-S4-classes-and-methods"></a>
<table cellpadding="1" cellspacing="1" border="0">
<tr><td valign="middle" align="left">[<a href="#Documenting-data-sets" title="Previous section in reading order"> &lt; </a>]</td>
<td valign="middle" align="left">[<a href="#Documenting-packages" title="Next section in reading order"> &gt; </a>]</td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left">[<a href="#Writing-R-documentation-files" title="Beginning of this chapter or previous chapter"> &lt;&lt; </a>]</td>
<td valign="middle" align="left">[<a href="#Rd-format" title="Up section"> Up </a>]</td>
<td valign="middle" align="left">[<a href="#Tidying-and-profiling-R-code" title="Next chapter"> &gt;&gt; </a>]</td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left">[<a href="#Top" title="Cover (top) of document">Top</a>]</td>
<td valign="middle" align="left">[<a href="#SEC_Contents" title="Table of contents">Contents</a>]</td>
<td valign="middle" align="left">[<a href="#Function-and-variable-index" title="Index">Index</a>]</td>
<td valign="middle" align="left">[<a href="#SEC_About" title="About (help)"> ? </a>]</td>
</tr></table>
<a name="Documenting-S4-classes-and-methods-1"></a>
<h3 class="subsection">2.1.3 Documenting S4 classes and methods</h3>

<p>There are special ways to use the &lsquo;<samp>?</samp>&rsquo;  operator, namely
&lsquo;<samp>class?<var>topic</var></samp>&rsquo; and &lsquo;<samp>methods?<var>topic</var></samp>&rsquo;, to access
documentation for S4 classes and methods, respectively.  This mechanism
depends on conventions for the topic names used in <code>\alias</code>
entries.  The topic names for S4 classes and methods respectively are of
the form
</p>
<table><tr><td>&nbsp;</td><td><pre class="example"><var>class</var>-class
<var>generic</var>,<var>signature_list</var>-method
</pre></td></tr></table>

<p>where <var>signature_list</var> contains the names of the classes in the
signature of the method (without quotes) separated by &lsquo;<samp>,</samp>&rsquo; (without
whitespace), with &lsquo;<samp>ANY</samp>&rsquo; used for arguments without an explicit
specification.  E.g., &lsquo;<samp>genericFunction-class</samp>&rsquo; is the topic name for
documentation for the S4 class <code>&quot;genericFunction&quot;</code>, and
&lsquo;<samp>coerce,ANY,NULL-method</samp>&rsquo; is the topic name for documentation for
the S4 method for <code>coerce</code> for signature <code>c(&quot;ANY&quot;, &quot;NULL&quot;)</code>.
</p>
<p>Skeletons of documentation for S4 classes and methods can be generated
by using the functions <code>promptClass()</code> and <code>promptMethods()</code>
from package <strong>methods</strong>.  If it is necessary or desired to provide an
explicit function declaration (in a <code>\usage</code> section) for an S4
method (e.g., if it has &ldquo;surprising arguments&rdquo; to be mentioned
explicitly), one can use the special markup
</p>
<table><tr><td>&nbsp;</td><td><pre class="example">\S4method{<var>generic</var>}{<var>signature_list</var>}(<var>argument_list</var>)
</pre></td></tr></table>

<p>(e.g., &lsquo;<samp>\S4method{coerce}{ANY,NULL}(from, to)</samp>&rsquo;).
</p>
<p>To make full use of the potential of the on-line documentation system,
all user-visible S4 classes and methods in a package should at least
have a suitable <code>\alias</code> entry in one of the package&rsquo;s &lsquo;<tt>Rd</tt>&rsquo; files.
If a package has methods for a function defined originally somewhere
else, and does not change the underlying default method for the
function, the package is responsible for documenting the methods it
creates, but not for the function itself or the default method.
</p>
<p>An S4 replacement method is documented in the same way as an S3 one: see
the description of  <code>\method</code> in <a href="#Documenting-functions">Documenting functions</a>.
</p>

<p>See <kbd>help(&quot;Documentation&quot;, package = &quot;methods&quot;)</kbd> for more
information on using and creating on-line documentation for S4 classes and
methods.
</p>
<hr size="6">
<a name="Documenting-packages"></a>
<table cellpadding="1" cellspacing="1" border="0">
<tr><td valign="middle" align="left">[<a href="#Documenting-S4-classes-and-methods" title="Previous section in reading order"> &lt; </a>]</td>
<td valign="middle" align="left">[<a href="#Sectioning" title="Next section in reading order"> &gt; </a>]</td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left">[<a href="#Writing-R-documentation-files" title="Beginning of this chapter or previous chapter"> &lt;&lt; </a>]</td>
<td valign="middle" align="left">[<a href="#Rd-format" title="Up section"> Up </a>]</td>
<td valign="middle" align="left">[<a href="#Tidying-and-profiling-R-code" title="Next chapter"> &gt;&gt; </a>]</td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left">[<a href="#Top" title="Cover (top) of document">Top</a>]</td>
<td valign="middle" align="left">[<a href="#SEC_Contents" title="Table of contents">Contents</a>]</td>
<td valign="middle" align="left">[<a href="#Function-and-variable-index" title="Index">Index</a>]</td>
<td valign="middle" align="left">[<a href="#SEC_About" title="About (help)"> ? </a>]</td>
</tr></table>
<a name="Documenting-packages-1"></a>
<h3 class="subsection">2.1.4 Documenting packages</h3>

<p>Packages may have an overview help page with an <code>\alias</code>
<code><var>pkgname</var>-package</code>, e.g. &lsquo;<samp>utils-package</samp>&rsquo; for the
<strong>utils</strong> package, when <code>package?<var>pkgname</var></code> will open that
help page.  If a topic named <code><var>pkgname</var></code> does not exist in
another &lsquo;<tt>Rd</tt>&rsquo; file, it is helpful to use this as an additional
<code>\alias</code>.
</p>
<p>Skeletons of documentation for a package can be generated using the
function <code>promptPackage()</code>.  If the <code>final = TRUE</code> argument
is used, then the &lsquo;<tt>Rd</tt>&rsquo; file will be generated in final form, containing
the information that would be produced up to
<code>library(help = <var>pkgname</var>)</code>.  Otherwise (the default) comments
will be inserted giving suggestions for content.
</p>
<p>Apart from the mandatory <code>\name</code> and <code>\title</code> and the
<code><var>pkgname</var>-package</code> alias, the only requirement for the package
overview page is that it include a <code>\docType{package}</code> statement.
All other content is optional.  We suggest that it should be a short
overview, to give a reader unfamiliar with the package enough
information to get started.  More extensive documentation is better
placed into a package vignette (see section <a href="#Writing-package-vignettes">Writing package vignettes</a>) and
referenced from this page, or into individual man pages for the
functions, datasets, or classes.
</p>
<hr size="6">
<a name="Sectioning"></a>
<table cellpadding="1" cellspacing="1" border="0">
<tr><td valign="middle" align="left">[<a href="#Documenting-packages" title="Previous section in reading order"> &lt; </a>]</td>
<td valign="middle" align="left">[<a href="#Marking-text" title="Next section in reading order"> &gt; </a>]</td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left">[<a href="#Writing-R-documentation-files" title="Beginning of this chapter or previous chapter"> &lt;&lt; </a>]</td>
<td valign="middle" align="left">[<a href="#Writing-R-documentation-files" title="Up section"> Up </a>]</td>
<td valign="middle" align="left">[<a href="#Tidying-and-profiling-R-code" title="Next chapter"> &gt;&gt; </a>]</td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left">[<a href="#Top" title="Cover (top) of document">Top</a>]</td>
<td valign="middle" align="left">[<a href="#SEC_Contents" title="Table of contents">Contents</a>]</td>
<td valign="middle" align="left">[<a href="#Function-and-variable-index" title="Index">Index</a>]</td>
<td valign="middle" align="left">[<a href="#SEC_About" title="About (help)"> ? </a>]</td>
</tr></table>
<a name="Sectioning-1"></a>
<h2 class="section">2.2 Sectioning</h2>

<p>To begin a new paragraph or leave a blank line in an example, just
insert an empty line (as in (La)TeX).  To break a line, use
<code>\cr</code>.
<a name="index-_005ccr"></a>
</p>
<p>In addition to the predefined sections (such as <code>\description{}</code>,
<code>\value{}</code>, etc.), you can &ldquo;define&rdquo; arbitrary ones by
<code>\section{<var>section_title</var>}{&hellip;}</code>.
<a name="index-_005csection"></a>
For example
</p>
<table><tr><td>&nbsp;</td><td><pre class="example">\section{Warning}{
  You must not call this function unless &hellip;
}
</pre></td></tr></table>

<p>For consistency with the pre-assigned sections, the section name (the
first argument to <code>\section</code>) should be capitalized (but not all
upper case).  Whitespace between the first and second braced expressions
is not allowed.  Markup (e.g. <code>\code</code>) within the section title
may cause problems with the latex conversion (depending on the version
of macro packages such as &lsquo;<samp>hyperref</samp>&rsquo;) and so should be avoided.
</p>
<p>The <code>\subsection</code> macro takes arguments in the same format as
<code>\section</code>, but is used within a section, so it may be used to
nest subsections within sections or other subsections.  There is no
predefined limit on the nesting level, but formatting is not designed
for more than 3 levels (i.e. subsections within subsections within
sections).
</p>
<p>Note that additional named sections are always inserted at a fixed
position in the output (before <code>\note</code>, <code>\seealso</code> and the
examples), no matter where they appear in the input (but in the same
order amongst themselves as in the input).
</p>

<hr size="6">
<a name="Marking-text"></a>
<table cellpadding="1" cellspacing="1" border="0">
<tr><td valign="middle" align="left">[<a href="#Sectioning" title="Previous section in reading order"> &lt; </a>]</td>
<td valign="middle" align="left">[<a href="#Lists-and-tables" title="Next section in reading order"> &gt; </a>]</td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left">[<a href="#Writing-R-documentation-files" title="Beginning of this chapter or previous chapter"> &lt;&lt; </a>]</td>
<td valign="middle" align="left">[<a href="#Writing-R-documentation-files" title="Up section"> Up </a>]</td>
<td valign="middle" align="left">[<a href="#Tidying-and-profiling-R-code" title="Next chapter"> &gt;&gt; </a>]</td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left">[<a href="#Top" title="Cover (top) of document">Top</a>]</td>
<td valign="middle" align="left">[<a href="#SEC_Contents" title="Table of contents">Contents</a>]</td>
<td valign="middle" align="left">[<a href="#Function-and-variable-index" title="Index">Index</a>]</td>
<td valign="middle" align="left">[<a href="#SEC_About" title="About (help)"> ? </a>]</td>
</tr></table>
<a name="Marking-text-1"></a>
<h2 class="section">2.3 Marking text</h2>
<a name="index-Marking-text-in-documentation"></a>

<p>The following logical markup commands are available for emphasizing or
quoting text.
</p>
<dl compact="compact">
<dt> <code>\emph{<var>text</var>}</code></dt>
<dd><a name="index-_005cemph"></a>
</dd>
<dt> <code>\strong{<var>text</var>}</code></dt>
<dd><a name="index-_005cstrong"></a>
<p>Emphasize <var>text</var> using <em>italic</em> and <strong>bold</strong> font if
possible; <code>\strong</code> is regarded as stronger (more emphatic).
</p>
</dd>
<dt> <code>\bold{<var>text</var>}</code></dt>
<dd><a name="index-_005cbold"></a>
<p>Set <var>text</var> in <b>bold</b> font if possible.
</p>
</dd>
<dt> <code>\sQuote{<var>text</var>}</code></dt>
<dd><a name="index-_005csQuote"></a>
</dd>
<dt> <code>\dQuote{<var>text</var>}</code></dt>
<dd><a name="index-_005cdQuote"></a>
<p>Portably single or double quote <var>text</var> (without hard-wiring the
characters used for quotation marks).
</p></dd>
</dl>

<p>Each of the above commands takes LaTeX-like input, so other macros
may be used within <var>text</var>.
</p>
<p>The following logical markup commands are available for indicating
specific kinds of text.  Except as noted, these take verbatim text
input, and so other macros may not be used within them.  Some characters
will need to be escaped (see section <a href="#Insertions">Insertions</a>).
</p>
<dl compact="compact">
<dt> <code>\code{<var>text</var>}</code></dt>
<dd><a name="index-_005ccode"></a>
<p>Indicate text that is a literal example of a piece of an R program,
e.g., a fragment of R code or the name of an R object.  Text is
entered in R-like syntax, and displayed using <code>typewriter</code> font
if possible.  Macros <code>\var</code> and <code>\link</code> are interpreted within
<var>text</var>.
</p>
</dd>
<dt> <code>\preformatted{<var>text</var>}</code></dt>
<dd><a name="index-_005cpreformatted"></a>
<p>Indicate text that is a literal example of a piece of a program.  Text
is displayed using <code>typewriter</code> font if possible.  Formatting,
e.g. line breaks, is preserved.
</p>
<p>Due to limitations in LaTeX as of this writing, this macro may not be
nested within other markup macros other than <code>\dQuote</code> and
<code>\sQuote</code>, as errors or bad formatting may result.
</p>
</dd>
<dt> <code>\kbd{<var>keyboard-characters</var>}</code></dt>
<dd><a name="index-_005ckbd"></a>
<p>Indicate keyboard input, using <kbd>slanted typewriter</kbd> font if
possible, so users can distinguish the characters they are supposed to
type from computer output.  Text is entered verbatim.
</p>
</dd>
<dt> <code>\samp{<var>text</var>}</code></dt>
<dd><a name="index-_005csamp"></a>
<p>Indicate text that is a literal example of a sequence of characters,
entered verbatim.  No wrapping or reformatting will occur.  Displayed
using <code>typewriter</code> font if possible.
</p>

</dd>
<dt> <code>\verb{<var>text</var>}</code></dt>
<dd><a name="index-_005cverb"></a>
<p>Indicate text that is a literal example of a sequence of characters,
with no interpretation of e.g. <code>\var</code>, but which will be included
within word-wrapped text.  Displayed using <code>typewriter</code> font if
possible.
</p>
</dd>
<dt> <code>\pkg{<var>package_name</var>}</code></dt>
<dd><a name="index-_005cpkg"></a>
<p>Indicate the name of an R package.  LaTeX-like.
</p>
</dd>
<dt> <code>\file{<var>file_name</var>}</code></dt>
<dd><a name="index-_005cfile"></a>
<p>Indicate the name of a file.  Text is LaTeX-like, so backslash needs
to be escaped.  Displayed using a distinct font if possible.
</p>
</dd>
<dt> <code>\email{<var>email_address</var>}</code></dt>
<dd><a name="index-_005cemail"></a>
<p>Indicate an electronic mail address.  LaTeX-like, will be rendered as
a hyperlink in HTML and PDF conversion.  Displayed using
<code>typewriter</code> font if possible.
</p>
</dd>
<dt> <code>\url{<var>uniform_resource_locator</var>}</code></dt>
<dd><a name="index-_005curl"></a>
<p>Indicate a uniform resource locator (<acronym>URL</acronym>) for the World Wide
Web.  The argument is handled verbatim, and rendered as a hyperlink in
HTML and PDF conversion.  Displayed using <code>typewriter</code> font if
possible.
</p>
</dd>
<dt> <code>\href{<var>uniform_resource_locator</var>}{<var>text</var>}</code></dt>
<dd><a name="index-_005chref"></a>
<p>Indicate a hyperlink to the World Wide Web. The first argument is handled
verbatim, and is used as the <acronym>URL</acronym> in the hyperlink, with the
second argument of LaTeX-like text displayed to the user.
</p>
</dd>
<dt> <code>\var{<var>metasyntactic_variable</var>}</code></dt>
<dd><a name="index-_005cvar"></a>
<p>Indicate a metasyntactic variable.  In some cases this will be rendered
distinctly, e.g. in italic, but not in all<a name="DOCF55" href="#FOOT55">(55)</a>. LaTeX-like.
</p></dd>
<dt> <code>\env{<var>environment_variable</var>}</code></dt>
<dd><a name="index-_005cenv"></a>
<p>Indicate an environment variable. Verbatim.
Displayed using <code>typewriter</code> font if possible
</p></dd>
<dt> <code>\option{<var>option</var>}</code></dt>
<dd><a name="index-_005coption"></a>
<p>Indicate a command-line option.  Verbatim.
Displayed using <code>typewriter</code> font if possible.
</p></dd>
<dt> <code>\command{<var>command_name</var>}</code></dt>
<dd><a name="index-_005ccommand"></a>
<p>Indicate the name of a command. LaTeX-like, so <code>\var</code> is
interpreted.  Displayed using <code>typewriter</code> font if possible.
</p></dd>
<dt> <code>\dfn{<var>term</var>}</code></dt>
<dd><a name="index-_005cdfn"></a>
<p>Indicate the introductory or defining use of a term. LaTeX-like.
</p></dd>
<dt> <code>\cite{<var>reference</var>}</code></dt>
<dd><a name="index-_005ccite"></a>
<p>Indicate a reference without a direct cross-reference <em>via</em> <code>\link</code>
(see section <a href="#Cross_002dreferences">Cross-references</a>), such as the name of a book. LaTeX-like.
</p></dd>
<dt> <code>\acronym{<var>acronym</var>}</code></dt>
<dd><a name="index-_005cacronym"></a>
<p>Indicate an acronym (an abbreviation written in all capital letters),
such as <acronym>GNU</acronym>. LaTeX-like.
</p></dd>
</dl>


<hr size="6">
<a name="Lists-and-tables"></a>
<table cellpadding="1" cellspacing="1" border="0">
<tr><td valign="middle" align="left">[<a href="#Marking-text" title="Previous section in reading order"> &lt; </a>]</td>
<td valign="middle" align="left">[<a href="#Cross_002dreferences" title="Next section in reading order"> &gt; </a>]</td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left">[<a href="#Writing-R-documentation-files" title="Beginning of this chapter or previous chapter"> &lt;&lt; </a>]</td>
<td valign="middle" align="left">[<a href="#Writing-R-documentation-files" title="Up section"> Up </a>]</td>
<td valign="middle" align="left">[<a href="#Tidying-and-profiling-R-code" title="Next chapter"> &gt;&gt; </a>]</td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left">[<a href="#Top" title="Cover (top) of document">Top</a>]</td>
<td valign="middle" align="left">[<a href="#SEC_Contents" title="Table of contents">Contents</a>]</td>
<td valign="middle" align="left">[<a href="#Function-and-variable-index" title="Index">Index</a>]</td>
<td valign="middle" align="left">[<a href="#SEC_About" title="About (help)"> ? </a>]</td>
</tr></table>
<a name="Lists-and-tables-1"></a>
<h2 class="section">2.4 Lists and tables</h2>
<a name="index-Lists-and-tables-in-documentation"></a>

<a name="index-_005citemize"></a>
<a name="index-_005cenumerate"></a>
<p>The <code>\itemize</code> and <code>\enumerate</code> commands take a single
argument, within which there may be one or more <code>\item</code> commands.
The text following each <code>\item</code> is formatted as one or more
paragraphs, suitably indented and with the first paragraph marked with a
bullet point (<code>\itemize</code>) or a number (<code>\enumerate</code>).
</p>
<p>Note that unlike argument lists, <code>\item</code> in these formats is
followed by a space and the text (not enclosed in braces).  For example
</p>
<table><tr><td>&nbsp;</td><td><pre class="example">  \enumerate{
    \item A database consists of one or more records, each with one or
    more named fields.
    \item Regular lines start with a non-whitespace character.
    \item Records are separated by one or more empty lines.
  }
</pre></td></tr></table>

<p><code>\itemize</code> and <code>\enumerate</code> commands may be nested.
</p>
<a name="index-_005cdescribe"></a>
<p>The <code>\describe</code> command is similar to <code>\itemize</code> but allows
initial labels to be specified.  Each <code>\item</code> takes two arguments,
the label and the body of the item, in exactly the same way as an
argument or value <code>\item</code>.  <code>\describe</code> commands are mapped to
<code>&lt;DL&gt;</code> lists in <acronym>HTML</acronym> and <code>\description</code> lists in LaTeX.
</p>
<a name="index-_005ctabular"></a>
<p>The <code>\tabular</code> command takes two arguments.  The first gives for
each of the columns the required alignment (&lsquo;<samp>l</samp>&rsquo; for
left-justification, &lsquo;<samp>r</samp>&rsquo; for right-justification or &lsquo;<samp>c</samp>&rsquo; for
centring.)  The second argument consists of an arbitrary number of
lines separated by <code>\cr</code>, and with fields separated by <code>\tab</code>.
For example:
</p>
<table><tr><td>&nbsp;</td><td><pre class="example">  \tabular{rlll}{
    [,1] \tab Ozone   \tab numeric \tab Ozone (ppb)\cr
    [,2] \tab Solar.R \tab numeric \tab Solar R (lang)\cr
    [,3] \tab Wind    \tab numeric \tab Wind (mph)\cr
    [,4] \tab Temp    \tab numeric \tab Temperature (degrees F)\cr
    [,5] \tab Month   \tab numeric \tab Month (1--12)\cr
    [,6] \tab Day     \tab numeric \tab Day of month (1--31)
  }
</pre></td></tr></table>

<p>There must be the same number of fields on each line as there are
alignments in the first argument, and they must be non-empty (but can
contain only spaces).  (There is no whitespace between <code>\tabular</code>
and the first argument, nor between the two arguments.)
</p>
<hr size="6">
<a name="Cross_002dreferences"></a>
<table cellpadding="1" cellspacing="1" border="0">
<tr><td valign="middle" align="left">[<a href="#Lists-and-tables" title="Previous section in reading order"> &lt; </a>]</td>
<td valign="middle" align="left">[<a href="#Mathematics" title="Next section in reading order"> &gt; </a>]</td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left">[<a href="#Writing-R-documentation-files" title="Beginning of this chapter or previous chapter"> &lt;&lt; </a>]</td>
<td valign="middle" align="left">[<a href="#Writing-R-documentation-files" title="Up section"> Up </a>]</td>
<td valign="middle" align="left">[<a href="#Tidying-and-profiling-R-code" title="Next chapter"> &gt;&gt; </a>]</td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left">[<a href="#Top" title="Cover (top) of document">Top</a>]</td>
<td valign="middle" align="left">[<a href="#SEC_Contents" title="Table of contents">Contents</a>]</td>
<td valign="middle" align="left">[<a href="#Function-and-variable-index" title="Index">Index</a>]</td>
<td valign="middle" align="left">[<a href="#SEC_About" title="About (help)"> ? </a>]</td>
</tr></table>
<a name="Cross_002dreferences-1"></a>
<h2 class="section">2.5 Cross-references</h2>
<a name="index-Cross_002dreferences-in-documentation"></a>

<a name="index-_005clink"></a>
<p>The markup <code>\link{<var>foo</var>}</code> (usually in the combination
<code>\code{\link{<var>foo</var>}}</code>) produces a hyperlink to the help for
<var>foo</var>.  Here <var>foo</var> is a <em>topic</em>, that is the argument of
<code>\alias</code> markup in another &lsquo;<tt>Rd</tt>&rsquo; file (possibly in another package).
Hyperlinks are supported in some of the formats to which &lsquo;<tt>Rd</tt>&rsquo; files are
converted, for example <acronym>HTML</acronym> and PDF, but ignored in others, e.g.
the text format.
</p>
<p>One main usage of <code>\link</code> is in the <code>\seealso</code> section of the
help page, see section <a href="#Rd-format">Rd format</a>.
</p>
<p>Note that whereas leading and trailing spaces are stripped when
extracting a topic from a <code>\alias</code>, they are not stripped when
looking up the topic of a <code>\link</code>.
</p>
<a name="index-_005clinkS4class"></a>
<p>You can specify a link to a different topic than its name by
<code>\link[=<var>dest</var>]{<var>name</var>}</code> which links to topic <var>dest</var>
with name <var>name</var>.  This can be used to refer to the documentation
for S3/4 classes, for example <code>\code{&quot;\link[=abc-class]{abc}&quot;}</code>
would be a way to refer to the documentation of an S4 class <code>&quot;abc&quot;</code>
defined in your package, and
<code>\code{&quot;\link[=terms.object]{terms}&quot;}</code> to the S3 <code>&quot;terms&quot;</code>
class (in package <strong>stats</strong>).  To make these easy to read in the
source file, <code>\code{&quot;\linkS4class{abc}&quot;}</code> expands to the form
given above.
</p>
<p>There are two other forms of optional argument specified as
<code>\link[<var>pkg</var>]{<var>foo</var>}</code> and
<code>\link[<var>pkg:bar</var>]{<var>foo</var>}</code> to link to the package
<strong><var>pkg</var></strong>, to <em>files</em> &lsquo;<tt><var>foo</var>.html</tt>&rsquo; and
&lsquo;<tt><var>bar</var>.html</tt>&rsquo; respectively.  These are rarely needed, perhaps to
refer to not-yet-installed packages (but there the <acronym>HTML</acronym> help system
will resolve the link at run time) or in the normally undesirable event
that more than one package offers help on a topic<a name="DOCF56" href="#FOOT56">(56)</a> (in
which case the present package has precedence so this is only needed to
refer to other packages).  They are currently only used in HTML help
(and ignored for hyperlinks in LaTeX conversions of help pages), and
link to the file rather than the topic (since there is no way to know
which topics are in which files in an uninstalled package).  The
<strong>only</strong> reason to use these forms for base and recommended
packages is to force a reference to a package that might be further down
the search path.  Because they have been frequently misused, the HTML
help system looks for topic <code><var>foo</var></code> in package <strong><var>pkg</var></strong>
if it does not find file &lsquo;<tt><var>foo</var>.html</tt>&rsquo;.
</p>
<hr size="6">
<a name="Mathematics"></a>
<table cellpadding="1" cellspacing="1" border="0">
<tr><td valign="middle" align="left">[<a href="#Cross_002dreferences" title="Previous section in reading order"> &lt; </a>]</td>
<td valign="middle" align="left">[<a href="#Figures" title="Next section in reading order"> &gt; </a>]</td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left">[<a href="#Writing-R-documentation-files" title="Beginning of this chapter or previous chapter"> &lt;&lt; </a>]</td>
<td valign="middle" align="left">[<a href="#Writing-R-documentation-files" title="Up section"> Up </a>]</td>
<td valign="middle" align="left">[<a href="#Tidying-and-profiling-R-code" title="Next chapter"> &gt;&gt; </a>]</td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left">[<a href="#Top" title="Cover (top) of document">Top</a>]</td>
<td valign="middle" align="left">[<a href="#SEC_Contents" title="Table of contents">Contents</a>]</td>
<td valign="middle" align="left">[<a href="#Function-and-variable-index" title="Index">Index</a>]</td>
<td valign="middle" align="left">[<a href="#SEC_About" title="About (help)"> ? </a>]</td>
</tr></table>
<a name="Mathematics-1"></a>
<h2 class="section">2.6 Mathematics</h2>
<a name="index-Mathematics-in-documentation"></a>
<a name="index-_005ceqn"></a>
<a name="index-_005cdeqn"></a>

<p>Mathematical formulae should be set beautifully for printed
documentation yet we still want something useful for text and <acronym>HTML</acronym>
online help.  To this end, the two commands
<code>\eqn{<var>latex</var>}{<var>ascii</var>}</code> and
<code>\deqn{<var>latex</var>}{<var>ascii</var>}</code> are used.  Whereas <code>\eqn</code>
is used for &ldquo;inline&rdquo; formulae (corresponding to TeX&rsquo;s
<code>$&hellip;$</code>), <code>\deqn</code> gives &ldquo;displayed equations&rdquo; (as in
LaTeX&rsquo;s <code>displaymath</code> environment, or TeX&rsquo;s
<code>$$&hellip;$$</code>).  Both arguments are treated as verbatim text.
</p>
<p>Both commands can also be used as <code>\eqn{<var>latexascii</var>}</code> (only
<em>one</em> argument) which then is used for both <var>latex</var> and
<var>ascii</var>.  No whitespace is allowed between command and the first
argument, nor between the first and second arguments.
</p>
<p>The following example is from &lsquo;<tt>Poisson.Rd</tt>&rsquo;:
</p>
<table><tr><td>&nbsp;</td><td><pre class="example">  \deqn{p(x) = \frac{\lambda^x e^{-\lambda}}{x!}}{%
        p(x) = \lambda^x exp(-\lambda)/x!}
  for \eqn{x = 0, 1, 2, \ldots}.
</pre></td></tr></table>


<p>For text on-line help we get
</p>
<blockquote><table class="cartouche" border="1"><tr><td>
<table><tr><td>&nbsp;</td><td><pre class="example">    p(x) = lambda^x exp(-lambda)/x!

for x = 0, 1, 2, ....
</pre></td></tr></table>
</td></tr></table>
</blockquote>

<p>Greek letters (both cases) will be rendered in HTML if preceded by a
backslash, <code>\dots</code> and <code>\ldots</code> will be rendered as ellipses
and <code>\sqrt</code>, <code>\ge</code> and <code>\le</code> as mathematical symbols.
</p>
<p>Note that only basic LaTeX can be used, there being no provision to
specify LaTeX style files such as the AMS extensions.
</p>
<hr size="6">
<a name="Figures"></a>
<table cellpadding="1" cellspacing="1" border="0">
<tr><td valign="middle" align="left">[<a href="#Mathematics" title="Previous section in reading order"> &lt; </a>]</td>
<td valign="middle" align="left">[<a href="#Insertions" title="Next section in reading order"> &gt; </a>]</td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left">[<a href="#Writing-R-documentation-files" title="Beginning of this chapter or previous chapter"> &lt;&lt; </a>]</td>
<td valign="middle" align="left">[<a href="#Writing-R-documentation-files" title="Up section"> Up </a>]</td>
<td valign="middle" align="left">[<a href="#Tidying-and-profiling-R-code" title="Next chapter"> &gt;&gt; </a>]</td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left">[<a href="#Top" title="Cover (top) of document">Top</a>]</td>
<td valign="middle" align="left">[<a href="#SEC_Contents" title="Table of contents">Contents</a>]</td>
<td valign="middle" align="left">[<a href="#Function-and-variable-index" title="Index">Index</a>]</td>
<td valign="middle" align="left">[<a href="#SEC_About" title="About (help)"> ? </a>]</td>
</tr></table>
<a name="Figures-1"></a>
<h2 class="section">2.7 Figures</h2>
<a name="index-Figures-in-documentation"></a>
<a name="index-_005cfigure"></a>

<p>To include figures in help pages, use the <code>\figure</code> markup.  There
are three forms.
</p>
<p>The two commonly used simple forms are <code>\figure{<var>filename</var>}</code>
and <code>\figure{<var>filename</var>}{<var>alternate text</var>}</code>.  This will
include a copy of the figure in either HTML or LaTeX output.  In text
output, the alternate text will be displayed instead.  (When the second
argument is omitted, the filename will be used.)  Both the filename and
the alternate text will be parsed verbatim, and should not include
special characters that are significant in HTML or LaTeX.
</p>
<p>The expert form is <code>\figure{<var>filename</var>}{options:
<var>string</var>}</code>.  (The word &lsquo;<samp>options:</samp>&rsquo; must be typed exactly as
shown and followed by at least one space.)  In this form, the
<var>string</var> is copied into the HTML <code>img</code> tag as attributes
following the <code>src</code> attribute, or into the second argument of the
<code>\Figure</code> macro in LaTeX, which by default is used as options to an
<code>\includegraphics</code> call.  As it is unlikely that any single string
would suffice for both display modes, the expert form would normally be
wrapped in conditionals.  It is up to the author to make sure that legal
HTML/LaTeX is used.  For example, to include a logo in both HTML (using
the simple form) and LaTeX (using the expert form), the following could
be used:
</p>
<table><tr><td>&nbsp;</td><td><pre class="example">\if{html}{\figure{logo.jpg}{Our logo}}
\if{latex}{\figure{logo.jpg}{options: width=0.5in}}
</pre></td></tr></table>

<p>The files containing the figures should be stored in the directory
&lsquo;<tt>man/figures</tt>&rsquo;.  Files with extensions &lsquo;<tt>.jpg</tt>&rsquo;, &lsquo;<tt>.pdf</tt>&rsquo;,
&lsquo;<tt>.png</tt>&rsquo; and &lsquo;<tt>.svg</tt>&rsquo; from that directory will be copied to the
&lsquo;<tt>help/figures</tt>&rsquo; directory at install time. (Figures
in PDF format will not display in most HTML browsers, but
might be the best choice in reference manuals.)  Specify the filename
relative to &lsquo;<tt>man/figures</tt>&rsquo; in the <code>\figure</code> directive.
</p>
<hr size="6">
<a name="Insertions"></a>
<table cellpadding="1" cellspacing="1" border="0">
<tr><td valign="middle" align="left">[<a href="#Figures" title="Previous section in reading order"> &lt; </a>]</td>
<td valign="middle" align="left">[<a href="#Indices" title="Next section in reading order"> &gt; </a>]</td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left">[<a href="#Writing-R-documentation-files" title="Beginning of this chapter or previous chapter"> &lt;&lt; </a>]</td>
<td valign="middle" align="left">[<a href="#Writing-R-documentation-files" title="Up section"> Up </a>]</td>
<td valign="middle" align="left">[<a href="#Tidying-and-profiling-R-code" title="Next chapter"> &gt;&gt; </a>]</td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left">[<a href="#Top" title="Cover (top) of document">Top</a>]</td>
<td valign="middle" align="left">[<a href="#SEC_Contents" title="Table of contents">Contents</a>]</td>
<td valign="middle" align="left">[<a href="#Function-and-variable-index" title="Index">Index</a>]</td>
<td valign="middle" align="left">[<a href="#SEC_About" title="About (help)"> ? </a>]</td>
</tr></table>
<a name="Insertions-1"></a>
<h2 class="section">2.8 Insertions</h2>

<a name="index-_005cR"></a>
<p>Use <code>\R</code> for the R system itself.  Use <code>\dots</code>
<a name="index-_005cdots"></a>
for the dots in function argument lists &lsquo;<samp>&hellip;</samp>&rsquo;, and
<code>\ldots</code>
<a name="index-_005cldots"></a>
for ellipsis dots in ordinary text.<a name="DOCF57" href="#FOOT57">(57)</a>  These can be followed by
<code>{}</code>, and should be unless followed by whitespace.
</p>
<p>After an unescaped &lsquo;<samp>%</samp>&rsquo;, you can put your own comments regarding the
help text.  The rest of the line (but not the newline at the end) will
be completely disregarded.  Therefore, you can also use it to make part
of the &ldquo;help&rdquo; invisible.
</p>
<p>You can produce a backslash (&lsquo;<samp>\</samp>&rsquo;) by escaping it by another
backslash.  (Note that <code>\cr</code> is used for generating line breaks.)
</p>
<p>The &ldquo;comment&rdquo; character &lsquo;<samp>%</samp>&rsquo; and unpaired braces<a name="DOCF58" href="#FOOT58">(58)</a>
<em>almost always</em> need to be escaped by &lsquo;<samp>\</samp>&rsquo;, and &lsquo;<samp>\\</samp>&rsquo; can
be used for backslash and needs to be when there two or more adjacent
backslashes).  In R-like code quoted strings are handled slightly
differently; see <a href="http://developer.r-project.org/parseRd.pdf">&ldquo;Parsing Rd files&rdquo;</a> for details &ndash; in particular braces should not be
escaped in quoted strings.
</p>
<p>All of &lsquo;<samp>% { } \</samp>&rsquo; should be escaped in LaTeX-like text.
</p>
<a name="index-_005cenc"></a>
<p>Text which might need to be represented differently in different
encodings should be marked by <code>\enc</code>, e.g.
<code>\enc{J&ouml;reskog}{Joreskog}</code> (with no whitespace between the
braces) where the first argument will be used where encodings are
allowed and the second should be <acronym>ASCII</acronym> (and is used for e.g.
the text conversion in locales that cannot represent the encoded form).
(This is intended to be used for individual words, not whole sentences
or paragraphs.)
</p>
<hr size="6">
<a name="Indices"></a>
<table cellpadding="1" cellspacing="1" border="0">
<tr><td valign="middle" align="left">[<a href="#Insertions" title="Previous section in reading order"> &lt; </a>]</td>
<td valign="middle" align="left">[<a href="#Platform_002dspecific-sections" title="Next section in reading order"> &gt; </a>]</td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left">[<a href="#Writing-R-documentation-files" title="Beginning of this chapter or previous chapter"> &lt;&lt; </a>]</td>
<td valign="middle" align="left">[<a href="#Writing-R-documentation-files" title="Up section"> Up </a>]</td>
<td valign="middle" align="left">[<a href="#Tidying-and-profiling-R-code" title="Next chapter"> &gt;&gt; </a>]</td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left">[<a href="#Top" title="Cover (top) of document">Top</a>]</td>
<td valign="middle" align="left">[<a href="#SEC_Contents" title="Table of contents">Contents</a>]</td>
<td valign="middle" align="left">[<a href="#Function-and-variable-index" title="Index">Index</a>]</td>
<td valign="middle" align="left">[<a href="#SEC_About" title="About (help)"> ? </a>]</td>
</tr></table>
<a name="Indices-1"></a>
<h2 class="section">2.9 Indices</h2>
<a name="index-Indices"></a>

<p>The <code>\alias</code> command (see section <a href="#Documenting-functions">Documenting functions</a>) is used to
specify the &ldquo;topics&rdquo; documented, which should include <em>all</em> R
objects in a package such as functions and variables, data sets, and S4
classes and methods (see section <a href="#Documenting-S4-classes-and-methods">Documenting S4 classes and methods</a>).  The
on-line help system searches the index data base consisting of all
alias topics.
</p>
<a name="index-_005cconcept"></a>
<p>In addition, it is possible to provide &ldquo;concept index entries&rdquo; using
<code>\concept</code>, which can be used for <code>help.search()</code> lookups.
E.g., file &lsquo;<tt>cor.test.Rd</tt>&rsquo; in the standard package <strong>stats</strong>
contains
</p>
<table><tr><td>&nbsp;</td><td><pre class="example">\concept{Kendall correlation coefficient}
\concept{Pearson correlation coefficient}
\concept{Spearman correlation coefficient}
</pre></td></tr></table>

<p>so that e.g. <kbd>??Spearman</kbd> will succeed in finding the
help page for the test for association between paired samples using
Spearman&rsquo;s rho.
</p>

<p>(Note that <code>help.search()</code> only uses &ldquo;sections&rdquo; of documentation
objects with no additional markup.)
</p>
<p>If you want to cross reference such items from other help files <em>via</em>
<code>\link</code>, you need to use <code>\alias</code> and not <code>\concept</code>.
</p>

<hr size="6">
<a name="Platform_002dspecific-sections"></a>
<table cellpadding="1" cellspacing="1" border="0">
<tr><td valign="middle" align="left">[<a href="#Indices" title="Previous section in reading order"> &lt; </a>]</td>
<td valign="middle" align="left">[<a href="#Conditional-text" title="Next section in reading order"> &gt; </a>]</td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left">[<a href="#Writing-R-documentation-files" title="Beginning of this chapter or previous chapter"> &lt;&lt; </a>]</td>
<td valign="middle" align="left">[<a href="#Writing-R-documentation-files" title="Up section"> Up </a>]</td>
<td valign="middle" align="left">[<a href="#Tidying-and-profiling-R-code" title="Next chapter"> &gt;&gt; </a>]</td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left">[<a href="#Top" title="Cover (top) of document">Top</a>]</td>
<td valign="middle" align="left">[<a href="#SEC_Contents" title="Table of contents">Contents</a>]</td>
<td valign="middle" align="left">[<a href="#Function-and-variable-index" title="Index">Index</a>]</td>
<td valign="middle" align="left">[<a href="#SEC_About" title="About (help)"> ? </a>]</td>
</tr></table>
<a name="Platform_002dspecific-documentation"></a>
<h2 class="section">2.10 Platform-specific documentation</h2>
<a name="index-Platform_002dspecific-documentation"></a>

<p>Sometimes the documentation needs to differ by platform.  Currently two
OS-specific options are available, &lsquo;<samp>unix</samp>&rsquo; and &lsquo;<samp>windows</samp>&rsquo;, and
lines in the help source file can be enclosed in
</p>
<table><tr><td>&nbsp;</td><td><pre class="example">#ifdef <var>OS</var>
   ...
#endif
</pre></td></tr></table>

<p>or
</p>
<table><tr><td>&nbsp;</td><td><pre class="example">#ifndef <var>OS</var>
   ...
#endif
</pre></td></tr></table>

<p>for OS-specific inclusion or exclusion.  Such blocks should not be
nested, and should be entirely within a block (that, is between the
opening and closing brace of a section or item), or at top-level contain
one or more complete sections.
</p>
<p>If the differences between platforms are extensive or the R objects
documented are only relevant to one platform, platform-specific &lsquo;<tt>Rd</tt>&rsquo; files
can be put in a &lsquo;<tt>unix</tt>&rsquo; or &lsquo;<tt>windows</tt>&rsquo; subdirectory.
</p>
<hr size="6">
<a name="Conditional-text"></a>
<table cellpadding="1" cellspacing="1" border="0">
<tr><td valign="middle" align="left">[<a href="#Platform_002dspecific-sections" title="Previous section in reading order"> &lt; </a>]</td>
<td valign="middle" align="left">[<a href="#Dynamic-pages" title="Next section in reading order"> &gt; </a>]</td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left">[<a href="#Writing-R-documentation-files" title="Beginning of this chapter or previous chapter"> &lt;&lt; </a>]</td>
<td valign="middle" align="left">[<a href="#Writing-R-documentation-files" title="Up section"> Up </a>]</td>
<td valign="middle" align="left">[<a href="#Tidying-and-profiling-R-code" title="Next chapter"> &gt;&gt; </a>]</td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left">[<a href="#Top" title="Cover (top) of document">Top</a>]</td>
<td valign="middle" align="left">[<a href="#SEC_Contents" title="Table of contents">Contents</a>]</td>
<td valign="middle" align="left">[<a href="#Function-and-variable-index" title="Index">Index</a>]</td>
<td valign="middle" align="left">[<a href="#SEC_About" title="About (help)"> ? </a>]</td>
</tr></table>
<a name="Conditional-text-1"></a>
<h2 class="section">2.11 Conditional text</h2>
<a name="index-conditionals"></a>
<a name="index-_005cif"></a>
<a name="index-_005cifelse"></a>
<a name="index-_005cout"></a>

<p>Occasionally the best content for one output format is different from
the best content for another.  For this situation, the
<code>\if{<var>format</var>}{<var>text</var>}</code> or
<code>\ifelse{<var>format</var>}{<var>text</var>}{<var>alternate</var>}</code> markup
is used.  Here <var>format</var> is a comma separated list of formats in
which the <var>text</var> should be rendered.  The <var>alternate</var> will be
rendered if the format does not match.  Both <var>text</var> and
<var>alternate</var> may be any sequence of text and markup.
</p>
<p>Currently the following formats are recognized:  <code>example</code>,
<code>html</code>, <code>latex</code> and <code>text</code>.  These select output for
the corresponding targets. (Note that <code>example</code> refers to
extracted example code rather than the displayed example in some other
format.)  Also accepted are <code>TRUE</code> (matching all formats) and
<code>FALSE</code> (matching no formats).  These could be the output
of the <code>\Sexpr</code> macro (see section <a href="#Dynamic-pages">Dynamic pages</a>).
</p>
<p>The <code>\out{<var>literal</var>}</code> macro would usually be used within
the <var>text</var> part of <code>\if{<var>format</var>}{<var>text</var>}</code>.  It
causes the renderer to output the literal text exactly, with no
attempt to escape special characters.  For example, use
the following to output the markup necessary to display the Greek letter in
LaTeX or HTML, and the text string <code>alpha</code> in other formats:
</p><table><tr><td>&nbsp;</td><td><pre class="example">\if{latex}{\out{\alpha}}\ifelse{html}{\out{&amp;alpha;}}{alpha}
</pre></td></tr></table>

<hr size="6">
<a name="Dynamic-pages"></a>
<table cellpadding="1" cellspacing="1" border="0">
<tr><td valign="middle" align="left">[<a href="#Conditional-text" title="Previous section in reading order"> &lt; </a>]</td>
<td valign="middle" align="left">[<a href="#User_002ddefined-macros" title="Next section in reading order"> &gt; </a>]</td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left">[<a href="#Writing-R-documentation-files" title="Beginning of this chapter or previous chapter"> &lt;&lt; </a>]</td>
<td valign="middle" align="left">[<a href="#Writing-R-documentation-files" title="Up section"> Up </a>]</td>
<td valign="middle" align="left">[<a href="#Tidying-and-profiling-R-code" title="Next chapter"> &gt;&gt; </a>]</td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left">[<a href="#Top" title="Cover (top) of document">Top</a>]</td>
<td valign="middle" align="left">[<a href="#SEC_Contents" title="Table of contents">Contents</a>]</td>
<td valign="middle" align="left">[<a href="#Function-and-variable-index" title="Index">Index</a>]</td>
<td valign="middle" align="left">[<a href="#SEC_About" title="About (help)"> ? </a>]</td>
</tr></table>
<a name="Dynamic-pages-1"></a>
<h2 class="section">2.12 Dynamic pages</h2>
<a name="index-dynamic-pages"></a>
<a name="index-_005cSexpr"></a>
<a name="index-_005cRdOpts"></a>

<p>Two macros supporting dynamically generated man pages are <code>\Sexpr</code>
and <code>\RdOpts</code>.  These are modelled after Sweave, and are intended
to contain executable R expressions in the &lsquo;<tt>Rd</tt>&rsquo; file.
</p>
<p>The main argument to <code>\Sexpr</code> must be valid R code that can be
executed. It may also take options in square brackets before the main
argument. Depending on the options, the code may be executed at
package build time, package install time, or man page rendering time.
</p>
<p>The options follow the same format as in Sweave, but different options
are supported.  Currently the allowed options and their defaults are:
</p>
<ul>
<li> <code>eval=TRUE</code>
Whether the R code should be evaluated.

</li><li> <code>echo=FALSE</code>
Whether the R code should be echoed.  If <code>TRUE</code>, a display will
be given in a preformatted block.  For example,
<code>\Sexpr[echo=TRUE]{ x &lt;- 1 }</code> will be displayed as
<table><tr><td>&nbsp;</td><td><pre class="example">&gt; x &lt;- 1
</pre></td></tr></table>

</li><li> <code>keep.source=TRUE</code>
Whether to keep the author&rsquo;s formatting when displaying the
code, or throw it away and use a deparsed version.

</li><li> <code>results=text</code>
How should the results be displayed?  The possibilities
are:

<ul class="toc">
<li>- <code>results=text</code>
Apply <code>as.character()</code> to the result of the code, and insert it
as a text element.

</li><li>- <code>results=verbatim</code>
Print the results of the code just as if it was executed at the console,
and include the printed results verbatim.  (Invisible results will not print.)

</li><li>- <code>results=rd</code>
The result is assumed to be a character vector containing markup to be
passed to <code>parse_Rd()</code>, with the result inserted in place.  This
could be used to insert computed aliases, for instance.
<code>parse_Rd()</code> is called first with <code>fragment = FALSE</code> to allow
a single Rd section macro to be inserted.  If that fails, it is called
again with <code>fragment = TRUE</code>, the older behavior.

</li><li>- <code>results=hide</code>
Insert no output.
</li></ul>

</li><li> <code>strip.white=TRUE</code>
Remove leading and trailing white space from each line of
output if <code>strip.white=TRUE</code>.  With
<code>strip.white=all</code>, also remove blank lines.

</li><li> <code>stage=install</code>
Control when this macro is run.  Possible values are
<ul class="toc">
<li>- <code>stage=build</code>
The macro is run when building a source tarball.

</li><li>- <code>stage=install</code>
The macro is run when installing from source.

</li><li>- <code>stage=render</code>
The macro is run when displaying the help page.
</li></ul>

<p>Conditionals such as <code>#ifdef</code>
(see section <a href="#Platform_002dspecific-sections">Platform-specific documentation</a>) are applied after the
<code>build</code> macros but before the <code>install</code> macros.  In some
situations (e.g. installing directly from a source directory without a
tarball, or building a binary package) the above description is not
literally accurate, but authors can rely on the sequence being
<code>build</code>, <code>#ifdef</code>, <code>install</code>, <code>render</code>, with all
stages executed.
</p>
<p>Code is only run once in each stage, so a <code>\Sexpr[results=rd]</code>
macro can output an <code>\Sexpr</code> macro designed for a later stage,
but not for the current one or any earlier stage.
</p>
</li><li> <code>width, height, fig</code>
These options are currently allowed but ignored.
</li></ul>

<p>The <code>\RdOpts</code> macro is used to set new defaults for options to apply
to following uses of <code>\Sexpr</code>.
</p>
<p>For more details, see the online document
<a href="http://developer.r-project.org/parseRd.pdf">&ldquo;Parsing Rd files&rdquo;</a>.
</p>
<hr size="6">
<a name="User_002ddefined-macros"></a>
<table cellpadding="1" cellspacing="1" border="0">
<tr><td valign="middle" align="left">[<a href="#Dynamic-pages" title="Previous section in reading order"> &lt; </a>]</td>
<td valign="middle" align="left">[<a href="#Encoding" title="Next section in reading order"> &gt; </a>]</td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left">[<a href="#Writing-R-documentation-files" title="Beginning of this chapter or previous chapter"> &lt;&lt; </a>]</td>
<td valign="middle" align="left">[<a href="#Writing-R-documentation-files" title="Up section"> Up </a>]</td>
<td valign="middle" align="left">[<a href="#Tidying-and-profiling-R-code" title="Next chapter"> &gt;&gt; </a>]</td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left">[<a href="#Top" title="Cover (top) of document">Top</a>]</td>
<td valign="middle" align="left">[<a href="#SEC_Contents" title="Table of contents">Contents</a>]</td>
<td valign="middle" align="left">[<a href="#Function-and-variable-index" title="Index">Index</a>]</td>
<td valign="middle" align="left">[<a href="#SEC_About" title="About (help)"> ? </a>]</td>
</tr></table>
<a name="User_002ddefined-macros-1"></a>
<h2 class="section">2.13 User-defined macros</h2>
<a name="index-user_002ddefined-macros"></a>
<a name="index-_005cnewcommand"></a>
<a name="index-_005crenewcommand"></a>

<p>Two new macros supporting user-defined macros were introduced in
R 2.12.0.  The <code>\newcommand</code> and <code>\renewcommand</code> macros allow
new macros to be defined within an Rd file.  These are similar but
not identical to the same-named LaTeX macros.
</p>
<p>They each take two arguments which are parsed verbatim.  The first is
the name of the new macro including the initial backslash, and the second
is the macro definition.  As in LaTeX, <code>\newcommand</code> requires that the
new macro not have been previously defined, whereas <code>\renewcommand</code>
allows existing macros (including all built-in ones) to be replaced.
</p>
<p>Also as in LaTeX, the new macro may be defined to take arguments,
and numeric placeholders such as <code>#1</code> are used in the macro
definition. However, unlike LaTeX, the number of arguments is
determined automatically from the highest placeholder number seen in
the macro definition.  For example, a macro definition containing
<code>#1</code> and <code>#3</code> (but no other placeholders) will define a
three argument macro (whose second argument will be ignored). As in
LaTeX, at most 9 arguments may be defined. If the <code>#</code>
character is followed by a non-digit it will have no special
significance.  All arguments to user-defined macros will be parsed as
verbatim text, and simple text-substitution will be used to replace
the place-holders, after which the replacement text will be parsed.
</p>
<p>For example, the &lsquo;<tt>NEWS.Rd</tt>&rsquo; file currently uses the definition
</p><table><tr><td>&nbsp;</td><td><pre class="example">\newcommand{\PR}{\Sexpr[results=rd]{tools:::Rd_expr_PR(#1)}}
</pre></td></tr></table>
<p>which defines <code>\PR</code> to be a single argument macro; then code like
</p><table><tr><td>&nbsp;</td><td><pre class="example">\PR{1234}
</pre></td></tr></table>
<p>will expand to
</p><table><tr><td>&nbsp;</td><td><pre class="example">\Sexpr[results=rd]{tools:::Rd_expr_PR(1234)}
</pre></td></tr></table>
<p>when parsed.
</p>
<hr size="6">
<a name="Encoding"></a>
<table cellpadding="1" cellspacing="1" border="0">
<tr><td valign="middle" align="left">[<a href="#User_002ddefined-macros" title="Previous section in reading order"> &lt; </a>]</td>
<td valign="middle" align="left">[<a href="#Processing-Rd-format" title="Next section in reading order"> &gt; </a>]</td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left">[<a href="#Writing-R-documentation-files" title="Beginning of this chapter or previous chapter"> &lt;&lt; </a>]</td>
<td valign="middle" align="left">[<a href="#Writing-R-documentation-files" title="Up section"> Up </a>]</td>
<td valign="middle" align="left">[<a href="#Tidying-and-profiling-R-code" title="Next chapter"> &gt;&gt; </a>]</td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left">[<a href="#Top" title="Cover (top) of document">Top</a>]</td>
<td valign="middle" align="left">[<a href="#SEC_Contents" title="Table of contents">Contents</a>]</td>
<td valign="middle" align="left">[<a href="#Function-and-variable-index" title="Index">Index</a>]</td>
<td valign="middle" align="left">[<a href="#SEC_About" title="About (help)"> ? </a>]</td>
</tr></table>
<a name="Encoding-1"></a>
<h2 class="section">2.14 Encoding</h2>
<a name="index-encoding"></a>

<p>Rd files are text files and so it is impossible to deduce the encoding
they are written in unless <acronym>ASCII</acronym>: files with 8-bit characters
could be UTF-8, Latin-1, Latin-9, KOI8-R, EUC-JP, <em>etc</em>.  So an
<code>\encoding{}</code> section must be used to specify the encoding if it
is not <acronym>ASCII</acronym>.  (The <code>\encoding{}</code> section must be on a
line by itself, and in particular one containing no non-<acronym>ASCII</acronym>
characters.  The encoding declared in the &lsquo;<tt>DESCRIPTION</tt>&rsquo; file will
be used if none is declared in the file.)  The &lsquo;<tt>Rd</tt>&rsquo; files are
converted to UTF-8 before parsing and so the preferred encoding for the
files themselves is now UTF-8.
</p>
<p>Wherever possible, avoid non-<acronym>ASCII</acronym> chars in &lsquo;<tt>Rd</tt>&rsquo; files, and
even symbols such as &lsquo;<samp>&lt;</samp>&rsquo;, &lsquo;<samp>&gt;</samp>&rsquo;, &lsquo;<samp>$</samp>&rsquo;, &lsquo;<samp>^</samp>&rsquo;, &lsquo;<samp>&amp;</samp>&rsquo;,
&lsquo;<samp>|</samp>&rsquo;, &lsquo;<samp>@</samp>&rsquo;, &lsquo;<samp>~</samp>&rsquo;, and &lsquo;<samp>*</samp>&rsquo; outside verbatim
environments (since they may disappear in fonts designed to render
text).  (Function <code>showNonASCIIfile</code> in package <strong>tools</strong> can help
in finding non-<acronym>ASCII</acronym> bytes in the files.)
</p>
<p>For convenience, encoding names &lsquo;<samp>latin1</samp>&rsquo; and &lsquo;<samp>latin2</samp>&rsquo; are
always recognized: these and &lsquo;<samp>UTF-8</samp>&rsquo; are likely to work fairly
widely.  However, this does not mean that all characters in UTF-8 will
be recognized, and the coverage of non-Latin characters<a name="DOCF59" href="#FOOT59">(59)</a> is fairly low.  Using LaTeX
<code>inputenx</code> (see <code>?Rd2pdf</code> in R) will give greater coverage
of UTF-8.
</p>
<p>The <code>\enc</code> command (see section <a href="#Insertions">Insertions</a>) can be used to provide
transliterations which will be used in conversions that do not support
the declared encoding.
</p>
<p>The LaTeX conversion converts the file to UTF-8 from the declared
encoding, and includes a
</p>
<table><tr><td>&nbsp;</td><td><pre class="example">\inputencoding{utf8}
</pre></td></tr></table>

<p>command, and this needs to be matched by a suitable invocation of the
<code>\usepackage{inputenc}</code> command.  The R utility <code>R
CMD Rd2pdf</code> looks at the converted code and includes the encodings used:
it might for example use
</p>
<table><tr><td>&nbsp;</td><td><pre class="example">\usepackage[utf8]{inputenc}
</pre></td></tr></table>

<p>(Use of <code>utf8</code> as an encoding requires LaTeX dated 2003/12/01 or
later.  Also, the use of Cyrillic characters in &lsquo;<samp>UTF-8</samp>&rsquo; appears to
also need &lsquo;<samp>\usepackage[T2A]{fontenc}</samp>&rsquo;, and <code>R CMD Rd2pdf</code>
includes this conditionally on the file &lsquo;<tt>t2aenc.def</tt>&rsquo; being present
and environment variable <code>_R_CYRILLIC_TEX_</code> being set.)
</p>
<p>Note that this mechanism works best with Latin letters: the coverage of
UTF-8 in LaTeX is quite low.
</p>


<hr size="6">
<a name="Processing-Rd-format"></a>
<table cellpadding="1" cellspacing="1" border="0">
<tr><td valign="middle" align="left">[<a href="#Encoding" title="Previous section in reading order"> &lt; </a>]</td>
<td valign="middle" align="left">[<a href="#Editing-Rd-files" title="Next section in reading order"> &gt; </a>]</td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left">[<a href="#Writing-R-documentation-files" title="Beginning of this chapter or previous chapter"> &lt;&lt; </a>]</td>
<td valign="middle" align="left">[<a href="#Writing-R-documentation-files" title="Up section"> Up </a>]</td>
<td valign="middle" align="left">[<a href="#Tidying-and-profiling-R-code" title="Next chapter"> &gt;&gt; </a>]</td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left">[<a href="#Top" title="Cover (top) of document">Top</a>]</td>
<td valign="middle" align="left">[<a href="#SEC_Contents" title="Table of contents">Contents</a>]</td>
<td valign="middle" align="left">[<a href="#Function-and-variable-index" title="Index">Index</a>]</td>
<td valign="middle" align="left">[<a href="#SEC_About" title="About (help)"> ? </a>]</td>
</tr></table>
<a name="Processing-Rd-format-1"></a>
<h2 class="section">2.15 Processing Rd format</h2>
<a name="index-Processing-Rd-format"></a>

<p>There are several commands to process Rd files from the system command
line.
</p>
<a name="index-R-CMD-Rdconv"></a>
<p>Using <code>R CMD Rdconv</code> one can convert R documentation format to
other formats, or extract the executable examples for run-time testing.
The currently supported conversions are to plain text, <acronym>HTML</acronym> and
LaTeX as well as extraction of the examples.
</p>
<a name="index-R-CMD-Rd2pdf"></a>
<p><code>R CMD Rd2pdf</code> generates PDF output from documentation in &lsquo;<tt>Rd</tt>&rsquo;
files, which can be specified either explicitly or by the path to a
directory with the sources of a package.  In the latter case, a
reference manual for all documented objects in the package is created,
including the information in the &lsquo;<tt>DESCRIPTION</tt>&rsquo; files.
</p>
<a name="index-R-CMD-Sweave"></a>
<a name="index-R-CMD-Stangle"></a>
<p><code>R CMD Sweave</code> and <code>R CMD Stangle</code> process &lsquo;<samp>Sweave</samp>&rsquo;
documentation files (usually with extension &lsquo;<samp>.Snw</samp>&rsquo; or &lsquo;<samp>.Rnw</samp>&rsquo;):
<code>R CMD Stangle</code> is use to extract the R code fragments.
</p>
<p>The exact usage and a detailed list of available options for all of
these commands can be obtained by running <code>R CMD <var>command</var>
--help</code>, e.g., <kbd>R CMD Rdconv --help</kbd>.  All available commands can be
listed using <kbd>R --help</kbd> (or <kbd>Rcmd --help</kbd> under Windows).
</p>
<p>All of these work under Windows.  You may need to have installed the
the tools to build packages from source as described in the &ldquo;R
Installation and Administration&rdquo; manual, although typically all that is
needed is a LaTeX installation.
</p>
<hr size="6">
<a name="Editing-Rd-files"></a>
<table cellpadding="1" cellspacing="1" border="0">
<tr><td valign="middle" align="left">[<a href="#Processing-Rd-format" title="Previous section in reading order"> &lt; </a>]</td>
<td valign="middle" align="left">[<a href="#Tidying-and-profiling-R-code" title="Next section in reading order"> &gt; </a>]</td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left">[<a href="#Writing-R-documentation-files" title="Beginning of this chapter or previous chapter"> &lt;&lt; </a>]</td>
<td valign="middle" align="left">[<a href="#Writing-R-documentation-files" title="Up section"> Up </a>]</td>
<td valign="middle" align="left">[<a href="#Tidying-and-profiling-R-code" title="Next chapter"> &gt;&gt; </a>]</td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left">[<a href="#Top" title="Cover (top) of document">Top</a>]</td>
<td valign="middle" align="left">[<a href="#SEC_Contents" title="Table of contents">Contents</a>]</td>
<td valign="middle" align="left">[<a href="#Function-and-variable-index" title="Index">Index</a>]</td>
<td valign="middle" align="left">[<a href="#SEC_About" title="About (help)"> ? </a>]</td>
</tr></table>
<a name="Editing-Rd-files-1"></a>
<h2 class="section">2.16 Editing Rd files</h2>
<a name="index-Editing-Rd-files"></a>

<p>It can be very helpful to prepare &lsquo;<tt>.Rd</tt>&rsquo; files using a editor which
knows about their syntax and will highlight commands, indent to show the
structure and detect mis-matched braces, and so on.
</p>
<p>The system most commonly used for this is some version of
<code>Emacs</code> (including <code>XEmacs</code>) with the <acronym>ESS</acronym>
package (<a href="http://ess.r-project.org/">http://ess.r-project.org/</a>: it is often is installed with
<code>Emacs</code> but may need to be loaded, or even installed,
separately).
</p>
<p>Another is the Eclipse IDE with the Stat-ET plugin
(<a href="http://www.walware.de/goto/statet">http://www.walware.de/goto/statet</a>), and (on Windows only)
Tinn-R (<a href="http://sourceforge.net/projects/tinn-r/">http://sourceforge.net/projects/tinn-r/</a>).
</p>
<p>People have also used LaTeX mode in a editor, as &lsquo;<tt>.Rd</tt>&rsquo; files are
rather similar to LaTeX files.
</p>
<p>Some R front-ends provide editing support for  &lsquo;<tt>.Rd</tt>&rsquo; files, for
example RStudio (<a href="http://rstudio.org/">http://rstudio.org/</a>).
</p>
<hr size="6">
<a name="Tidying-and-profiling-R-code"></a>
<table cellpadding="1" cellspacing="1" border="0">
<tr><td valign="middle" align="left">[<a href="#Editing-Rd-files" title="Previous section in reading order"> &lt; </a>]</td>
<td valign="middle" align="left">[<a href="#Tidying-R-code" title="Next section in reading order"> &gt; </a>]</td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left">[<a href="#Writing-R-documentation-files" title="Beginning of this chapter or previous chapter"> &lt;&lt; </a>]</td>
<td valign="middle" align="left">[<a href="#Top" title="Up section"> Up </a>]</td>
<td valign="middle" align="left">[<a href="#Debugging" title="Next chapter"> &gt;&gt; </a>]</td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left">[<a href="#Top" title="Cover (top) of document">Top</a>]</td>
<td valign="middle" align="left">[<a href="#SEC_Contents" title="Table of contents">Contents</a>]</td>
<td valign="middle" align="left">[<a href="#Function-and-variable-index" title="Index">Index</a>]</td>
<td valign="middle" align="left">[<a href="#SEC_About" title="About (help)"> ? </a>]</td>
</tr></table>
<a name="Tidying-and-profiling-R-code-1"></a>
<h1 class="chapter">3. Tidying and profiling R code</h1>

<table class="menu" border="0" cellspacing="0">
<tr><td align="left" valign="top"><a href="#Tidying-R-code">3.1 Tidying R code</a></td><td>&nbsp;&nbsp;</td><td align="left" valign="top">              
</td></tr>
<tr><td align="left" valign="top"><a href="#Profiling-R-code-for-speed">3.2 Profiling R code for speed</a></td><td>&nbsp;&nbsp;</td><td align="left" valign="top">  
</td></tr>
<tr><td align="left" valign="top"><a href="#Profiling-R-code-for-memory-use">3.3 Profiling R code for memory use</a></td><td>&nbsp;&nbsp;</td><td align="left" valign="top">  
</td></tr>
<tr><td align="left" valign="top"><a href="#Profiling-compiled-code">3.4 Profiling compiled code</a></td><td>&nbsp;&nbsp;</td><td align="left" valign="top">     
</td></tr>
</table>

<p>R code which is worth preserving in a package and perhaps making
available for others to use is worth documenting, tidying up and perhaps
optimizing. The last two of these activities are the subject of this
chapter.
</p>
<hr size="6">
<a name="Tidying-R-code"></a>
<table cellpadding="1" cellspacing="1" border="0">
<tr><td valign="middle" align="left">[<a href="#Tidying-and-profiling-R-code" title="Previous section in reading order"> &lt; </a>]</td>
<td valign="middle" align="left">[<a href="#Profiling-R-code-for-speed" title="Next section in reading order"> &gt; </a>]</td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left">[<a href="#Tidying-and-profiling-R-code" title="Beginning of this chapter or previous chapter"> &lt;&lt; </a>]</td>
<td valign="middle" align="left">[<a href="#Tidying-and-profiling-R-code" title="Up section"> Up </a>]</td>
<td valign="middle" align="left">[<a href="#Debugging" title="Next chapter"> &gt;&gt; </a>]</td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left">[<a href="#Top" title="Cover (top) of document">Top</a>]</td>
<td valign="middle" align="left">[<a href="#SEC_Contents" title="Table of contents">Contents</a>]</td>
<td valign="middle" align="left">[<a href="#Function-and-variable-index" title="Index">Index</a>]</td>
<td valign="middle" align="left">[<a href="#SEC_About" title="About (help)"> ? </a>]</td>
</tr></table>
<a name="Tidying-R-code-1"></a>
<h2 class="section">3.1 Tidying R code</h2>
<a name="index-Tidying-R-code"></a>

<p>R treats function code loaded from packages and code entered by users
differently.  By default code entered by users has the source code stored
internally, and when the function is listed, the original source is
reproduced.  Loading code from a package (by default) discards the
source code, and the function listing is re-created from the parse tree
of the function.
</p>
<p>Normally keeping the source code is a good idea, and in particular it
avoids comments being removed from the source.  However, we can make
use of the ability to re-create a function listing from its parse tree
to produce a tidy version of the function, for example with consistent
indentation and spaces around operators.  If the original source
does not follow the standard format this tidied version can be much
easier to read.
</p>
<p>We can subvert the keeping of source in two ways.
</p>
<ol>
<li>
The option <code>keep.source</code> can be set to <code>FALSE</code> before the code
is loaded into R.
</li><li>
The stored source code can be removed by calling the <code>removeSource()</code>
function, for example by

<table><tr><td>&nbsp;</td><td><pre class="example">myfun &lt;- removeSource(myfun)
</pre></td></tr></table>

</li></ol>

<p>In each case if we then list the function we will get the standard
layout.
</p>
<p>Suppose we have a file of functions &lsquo;<tt>myfuns.R</tt>&rsquo; that we want to
tidy up.  Create a file &lsquo;<tt>tidy.R</tt>&rsquo; containing
</p>
<table><tr><td>&nbsp;</td><td><pre class="example">source(&quot;myfuns.R&quot;, keep.source = FALSE)
dump(ls(all = TRUE), file = &quot;new.myfuns.R&quot;)
</pre></td></tr></table>

<p>and run R with this as the source file, for example by <kbd>R
--vanilla &lt; tidy.R</kbd> or by pasting into an R session.  Then the file
&lsquo;<tt>new.myfuns.R</tt>&rsquo; will contain the functions in alphabetical order in
the standard layout.  Warning:  comments in your functions will be lost.
</p>
<p>The standard format provides a good starting point for further tidying.
Although the deparsing cannot do so, we recommend the consistent use of
the preferred assignment operator &lsquo;<samp>&lt;-</samp>&rsquo; (rather than &lsquo;<samp>=</samp>&rsquo;) for
assignment.  Many package authors use a version of Emacs (on a
Unix-alike or Windows) to edit R code, using the ESS[S] mode of the
<acronym>ESS</acronym> Emacs package.  See <a href="R-ints.html#R-coding-standards">(R-ints)R coding standards</a> section &lsquo;R coding standards&rsquo; in <cite>R Internals</cite> for style options within the ESS[S] mode
recommended for the source code of R itself.
</p>


<hr size="6">
<a name="Profiling-R-code-for-speed"></a>
<table cellpadding="1" cellspacing="1" border="0">
<tr><td valign="middle" align="left">[<a href="#Tidying-R-code" title="Previous section in reading order"> &lt; </a>]</td>
<td valign="middle" align="left">[<a href="#Profiling-R-code-for-memory-use" title="Next section in reading order"> &gt; </a>]</td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left">[<a href="#Tidying-and-profiling-R-code" title="Beginning of this chapter or previous chapter"> &lt;&lt; </a>]</td>
<td valign="middle" align="left">[<a href="#Tidying-and-profiling-R-code" title="Up section"> Up </a>]</td>
<td valign="middle" align="left">[<a href="#Debugging" title="Next chapter"> &gt;&gt; </a>]</td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left">[<a href="#Top" title="Cover (top) of document">Top</a>]</td>
<td valign="middle" align="left">[<a href="#SEC_Contents" title="Table of contents">Contents</a>]</td>
<td valign="middle" align="left">[<a href="#Function-and-variable-index" title="Index">Index</a>]</td>
<td valign="middle" align="left">[<a href="#SEC_About" title="About (help)"> ? </a>]</td>
</tr></table>
<a name="Profiling-R-code-for-speed-1"></a>
<h2 class="section">3.2 Profiling R code for speed</h2>
<a name="index-Profiling"></a>
<a name="index-Rprof"></a>

<p>It is possible to profile R code on Windows and most<a name="DOCF60" href="#FOOT60">(60)</a> Unix-alike versions of
R.
</p>
<p>The command <code>Rprof</code> is used to control profiling, and its help
page can be consulted for full details.  Profiling works by recording
at fixed intervals<a name="DOCF61" href="#FOOT61">(61)</a> (by default every 20 msecs)
which line in which R function is being used, and recording the
results in a file (default &lsquo;<tt>Rprof.out</tt>&rsquo; in the working directory).
Then the function <code>summaryRprof</code> or the command-line utility
<code>R CMD Rprof <var>Rprof.out</var></code> can be used to summarize the
activity.
</p>
<p>As an example, consider the following code (from Venables &amp; Ripley,
2002, pp. 225&ndash;6).
</p>
<table><tr><td>&nbsp;</td><td><pre class="smallexample">library(MASS); library(boot)
storm.fm &lt;- nls(Time ~ b*Viscosity/(Wt - c), stormer,
                start = c(b=30.401, c=2.2183))
st &lt;- cbind(stormer, fit=fitted(storm.fm))
storm.bf &lt;- function(rs, i) {
    st$Time &lt;-  st$fit + rs[i]
    tmp &lt;- nls(Time ~ (b * Viscosity)/(Wt - c), st,
               start = coef(storm.fm))
    tmp$m$getAllPars()
}
rs &lt;- scale(resid(storm.fm), scale = FALSE) # remove the mean
Rprof(&quot;boot.out&quot;)
storm.boot &lt;- boot(rs, storm.bf, R = 4999) # slow enough to profile
Rprof(NULL)
</pre></td></tr></table>

<p>Having run this we can summarize the results by
</p>
<table><tr><td>&nbsp;</td><td><pre class="smallexample">R CMD Rprof boot.out

Each sample represents 0.02 seconds.
Total run time: 22.52 seconds.

Total seconds: time spent in function and callees.
Self seconds: time spent in function alone.
</pre><pre class="smallexample">
</pre><pre class="smallexample">   %       total       %        self
 total    seconds     self    seconds    name
 100.0     25.22       0.2      0.04     &quot;boot&quot;
  99.8     25.18       0.6      0.16     &quot;statistic&quot;
  96.3     24.30       4.0      1.02     &quot;nls&quot;
  33.9      8.56       2.2      0.56     &quot;&lt;Anonymous&gt;&quot;
  32.4      8.18       1.4      0.36     &quot;eval&quot;
  31.8      8.02       1.4      0.34     &quot;.Call&quot;
  28.6      7.22       0.0      0.00     &quot;eval.parent&quot;
  28.5      7.18       0.3      0.08     &quot;model.frame&quot;
  28.1      7.10       3.5      0.88     &quot;model.frame.default&quot;
  17.4      4.38       0.7      0.18     &quot;sapply&quot;
  15.0      3.78       3.2      0.80     &quot;nlsModel&quot;
  12.5      3.16       1.8      0.46     &quot;lapply&quot;
  12.3      3.10       2.7      0.68     &quot;assign&quot;
 ...
</pre><pre class="smallexample">
</pre><pre class="smallexample">   %        self        %      total
  self    seconds     total   seconds    name
   5.7      1.44       7.5      1.88     &quot;inherits&quot;
   4.0      1.02      96.3     24.30     &quot;nls&quot;
   3.6      0.92       3.6      0.92     &quot;$&quot;
   3.5      0.88      28.1      7.10     &quot;model.frame.default&quot;
   3.2      0.80      15.0      3.78     &quot;nlsModel&quot;
   2.8      0.70       9.8      2.46     &quot;qr.coef&quot;
   2.7      0.68      12.3      3.10     &quot;assign&quot;
   2.5      0.64       2.5      0.64     &quot;.Fortran&quot;
   2.5      0.62       7.1      1.80     &quot;qr.default&quot;
   2.2      0.56      33.9      8.56     &quot;&lt;Anonymous&gt;&quot;
   2.1      0.54       5.9      1.48     &quot;unlist&quot;
   2.1      0.52       7.9      2.00     &quot;FUN&quot;
  ...
</pre></td></tr></table>

<p>This often produces
surprising results and can be used to identify bottlenecks or pieces of
R code that could benefit from being replaced by compiled code.
</p>
<p>Two warnings: profiling does impose a small performance penalty, and the
output files can be very large if long runs are profiled at the default
sampling interval.
</p>
<p>Profiling short runs can sometimes give misleading results.  R from
time to time performs <em>garbage collection</em> to reclaim unused
memory, and this takes an appreciable amount of time which profiling
will charge to whichever function happens to provoke it.  It may be
useful to compare profiling code immediately after a call to <code>gc()</code>
with a profiling run without a preceding call to <code>gc</code>.
</p>
<p>More detailed analysis of the output can be achieved by the tools in the
<acronym>CRAN</acronym> packages <a href="http://CRAN.R-project.org/package=proftools"><strong>proftools</strong></a> and <a href="http://CRAN.R-project.org/package=profr"><strong>profr</strong></a>: in
particular these allow call graphs to be studied.
</p>
<hr size="6">
<a name="Profiling-R-code-for-memory-use"></a>
<table cellpadding="1" cellspacing="1" border="0">
<tr><td valign="middle" align="left">[<a href="#Profiling-R-code-for-speed" title="Previous section in reading order"> &lt; </a>]</td>
<td valign="middle" align="left">[<a href="#Memory-statistics-from-Rprof" title="Next section in reading order"> &gt; </a>]</td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left">[<a href="#Tidying-and-profiling-R-code" title="Beginning of this chapter or previous chapter"> &lt;&lt; </a>]</td>
<td valign="middle" align="left">[<a href="#Tidying-and-profiling-R-code" title="Up section"> Up </a>]</td>
<td valign="middle" align="left">[<a href="#Debugging" title="Next chapter"> &gt;&gt; </a>]</td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left">[<a href="#Top" title="Cover (top) of document">Top</a>]</td>
<td valign="middle" align="left">[<a href="#SEC_Contents" title="Table of contents">Contents</a>]</td>
<td valign="middle" align="left">[<a href="#Function-and-variable-index" title="Index">Index</a>]</td>
<td valign="middle" align="left">[<a href="#SEC_About" title="About (help)"> ? </a>]</td>
</tr></table>
<a name="Profiling-R-code-for-memory-use-1"></a>
<h2 class="section">3.3 Profiling R code for memory use</h2>
<a name="index-Profiling-1"></a>
<a name="index-Memory-use"></a>

<p>Measuring memory use in R code is useful either when the code takes
more memory than is conveniently available or when memory allocation and
copying of objects is responsible for slow code. There are three ways to
profile memory use over time in R code. All three require R to
have been compiled with &lsquo;<samp>--enable-memory-profiling</samp>&rsquo;, which is not
the default, but is currently used for the Mac OS X and Windows binary
distributions. All can be misleading, for different reasons.
</p>
<p>In understanding the memory profiles it is useful to know a little more
about R&rsquo;s memory allocation. Looking at the results of <code>gc()</code>
shows a division of memory into <code>Vcells</code> used to store the contents
of vectors and <code>Ncells</code> used to store everything else, including
all the administrative overhead for vectors such as type and length
information.  In fact the vector contents are divided into two
pools. Memory for small vectors (by default 128 bytes or less) is
obtained in large chunks and then parcelled out by R; memory for
larger vectors is obtained directly from the operating system.
</p>
<p>Some memory allocation is obvious in interpreted code, for example,
</p>
<table><tr><td>&nbsp;</td><td><pre class="smallexample">y &lt;- x + 1
</pre></td></tr></table>

<p>allocates memory for a new vector <code>y</code>. Other memory allocation is
less obvious and occurs because <code>R</code> is forced to make good on its
promise of &lsquo;call-by-value&rsquo; argument passing.  When an argument is
passed to a function it is not immediately copied. Copying occurs (if
necessary) only when the argument is modified.  This can lead to
surprising memory use. For example, in the &lsquo;survey&rsquo; package we have
</p>
<table><tr><td>&nbsp;</td><td><pre class="smallexample">print.svycoxph &lt;- function (x, ...)
{
    print(x$survey.design, varnames = FALSE, design.summaries = FALSE,
        ...)
    x$call &lt;- x$printcall
    NextMethod()
}
</pre></td></tr></table>

<p>It may not be obvious that the assignment to <code>x$call</code> will cause
the entire object <code>x</code> to be copied.  This copying to preserve the
call-by-value illusion is usually done by the internal C function
<code>duplicate</code>.
</p>
<p>The main reason that memory-use profiling is difficult is garbage
collection. Memory is allocated at well-defined times in an R
program, but is freed whenever the garbage collector happens to run.
</p>
<table class="menu" border="0" cellspacing="0">
<tr><td align="left" valign="top"><a href="#Memory-statistics-from-Rprof">3.3.1 Memory statistics from <code>Rprof</code></a></td><td>&nbsp;&nbsp;</td><td align="left" valign="top">  
</td></tr>
<tr><td align="left" valign="top"><a href="#Tracking-memory-allocations">3.3.2 Tracking memory allocations</a></td><td>&nbsp;&nbsp;</td><td align="left" valign="top">  
</td></tr>
<tr><td align="left" valign="top"><a href="#Tracing-copies-of-an-object">3.3.3 Tracing copies of an object</a></td><td>&nbsp;&nbsp;</td><td align="left" valign="top">  
</td></tr>
</table>

<hr size="6">
<a name="Memory-statistics-from-Rprof"></a>
<table cellpadding="1" cellspacing="1" border="0">
<tr><td valign="middle" align="left">[<a href="#Profiling-R-code-for-memory-use" title="Previous section in reading order"> &lt; </a>]</td>
<td valign="middle" align="left">[<a href="#Tracking-memory-allocations" title="Next section in reading order"> &gt; </a>]</td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left">[<a href="#Tidying-and-profiling-R-code" title="Beginning of this chapter or previous chapter"> &lt;&lt; </a>]</td>
<td valign="middle" align="left">[<a href="#Profiling-R-code-for-memory-use" title="Up section"> Up </a>]</td>
<td valign="middle" align="left">[<a href="#Debugging" title="Next chapter"> &gt;&gt; </a>]</td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left">[<a href="#Top" title="Cover (top) of document">Top</a>]</td>
<td valign="middle" align="left">[<a href="#SEC_Contents" title="Table of contents">Contents</a>]</td>
<td valign="middle" align="left">[<a href="#Function-and-variable-index" title="Index">Index</a>]</td>
<td valign="middle" align="left">[<a href="#SEC_About" title="About (help)"> ? </a>]</td>
</tr></table>
<a name="Memory-statistics-from-Rprof-1"></a>
<h3 class="subsection">3.3.1 Memory statistics from <code>Rprof</code></h3>
<a name="index-Rprof-1"></a>
<a name="index-summaryRprof"></a>

<p>The sampling profiler <code>Rprof</code> described in the previous section can
be given the option <code>memory.profiling=TRUE</code>. It then writes out the
total R memory allocation in small vectors, large vectors, and cons
cells or nodes at each sampling interval. It also writes out the number
of calls to the internal function <code>duplicate</code>, which is called to
copy R objects. <code>summaryRprof</code> provides summaries of this
information.  The main reason that this can be misleading is that the
memory use is attributed to the function running at the end of the
sampling interval. A second reason is that garbage collection can make
the amount of memory in use decrease, so a function appears to use
little memory.  Running under <code>gctorture</code> helps with both problems:
it slows down the code to effectively increase the sampling frequency
and it makes each garbage collection release a smaller amount of memory.
Changing the memory limits with <code>mem.limits()</code> may also be useful,
to see how the code would run under different memory conditions.
</p>
<hr size="6">
<a name="Tracking-memory-allocations"></a>
<table cellpadding="1" cellspacing="1" border="0">
<tr><td valign="middle" align="left">[<a href="#Memory-statistics-from-Rprof" title="Previous section in reading order"> &lt; </a>]</td>
<td valign="middle" align="left">[<a href="#Tracing-copies-of-an-object" title="Next section in reading order"> &gt; </a>]</td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left">[<a href="#Tidying-and-profiling-R-code" title="Beginning of this chapter or previous chapter"> &lt;&lt; </a>]</td>
<td valign="middle" align="left">[<a href="#Profiling-R-code-for-memory-use" title="Up section"> Up </a>]</td>
<td valign="middle" align="left">[<a href="#Debugging" title="Next chapter"> &gt;&gt; </a>]</td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left">[<a href="#Top" title="Cover (top) of document">Top</a>]</td>
<td valign="middle" align="left">[<a href="#SEC_Contents" title="Table of contents">Contents</a>]</td>
<td valign="middle" align="left">[<a href="#Function-and-variable-index" title="Index">Index</a>]</td>
<td valign="middle" align="left">[<a href="#SEC_About" title="About (help)"> ? </a>]</td>
</tr></table>
<a name="Tracking-memory-allocations-1"></a>
<h3 class="subsection">3.3.2 Tracking memory allocations</h3>
<a name="index-Rprofmem"></a>

<p>The second method of memory profiling uses a memory-allocation
profiler, <code>Rprofmem()</code>, which writes out a stack trace to an
output file every time a large vector is allocated (with a
user-specified threshold for &lsquo;large&rsquo;) or a new page of memory is
allocated for the R heap. Summary functions for this output are still
being designed.
</p>
<p>Running the example from the previous section with
</p>
<table><tr><td>&nbsp;</td><td><pre class="smallexample">&gt; Rprofmem(&quot;boot.memprof&quot;,threshold=1000)
&gt; storm.boot &lt;- boot(rs, storm.bf, R = 4999)
&gt; Rprofmem(NULL)
</pre></td></tr></table>

<p>shows that apart from some initial and final work in <code>boot</code> there
are no vector allocations over 1000 bytes.
</p>
<hr size="6">
<a name="Tracing-copies-of-an-object"></a>
<table cellpadding="1" cellspacing="1" border="0">
<tr><td valign="middle" align="left">[<a href="#Tracking-memory-allocations" title="Previous section in reading order"> &lt; </a>]</td>
<td valign="middle" align="left">[<a href="#Profiling-compiled-code" title="Next section in reading order"> &gt; </a>]</td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left">[<a href="#Tidying-and-profiling-R-code" title="Beginning of this chapter or previous chapter"> &lt;&lt; </a>]</td>
<td valign="middle" align="left">[<a href="#Profiling-R-code-for-memory-use" title="Up section"> Up </a>]</td>
<td valign="middle" align="left">[<a href="#Debugging" title="Next chapter"> &gt;&gt; </a>]</td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left">[<a href="#Top" title="Cover (top) of document">Top</a>]</td>
<td valign="middle" align="left">[<a href="#SEC_Contents" title="Table of contents">Contents</a>]</td>
<td valign="middle" align="left">[<a href="#Function-and-variable-index" title="Index">Index</a>]</td>
<td valign="middle" align="left">[<a href="#SEC_About" title="About (help)"> ? </a>]</td>
</tr></table>
<a name="Tracing-copies-of-an-object-1"></a>
<h3 class="subsection">3.3.3 Tracing copies of an object</h3>
<a name="index-tracemem"></a>
<a name="index-untracemem"></a>

<p>The third method of memory profiling involves tracing copies made of a
specific (presumably large) R object. Calling <code>tracemem</code> on an
object marks it so that a message is printed to standard output when
the object is copied <em>via</em> <code>duplicate</code> or coercion to another type,
or when a new object of the same size is created in arithmetic
operations. The main reason that this can be misleading is that
copying of subsets or components of an object is not tracked. It may
be helpful to use <code>tracemem</code> on these components.
</p>

<p>In the example above we can run <code>tracemem</code> on the data frame
<code>st</code>
</p>
<table><tr><td>&nbsp;</td><td><pre class="smallexample">&gt; tracemem(st)
[1] &quot;&lt;0x9abd5e0&gt;&quot;
&gt; storm.boot &lt;- boot(rs, storm.bf, R = 4)
memtrace[0x9abd5e0-&gt;0x92a6d08]: statistic boot
memtrace[0x92a6d08-&gt;0x92a6d80]: $&lt;-.data.frame $&lt;- statistic boot
memtrace[0x92a6d80-&gt;0x92a6df8]: $&lt;-.data.frame $&lt;- statistic boot
memtrace[0x9abd5e0-&gt;0x9271318]: statistic boot
memtrace[0x9271318-&gt;0x9271390]: $&lt;-.data.frame $&lt;- statistic boot
memtrace[0x9271390-&gt;0x9271408]: $&lt;-.data.frame $&lt;- statistic boot
memtrace[0x9abd5e0-&gt;0x914f558]: statistic boot
memtrace[0x914f558-&gt;0x914f5f8]: $&lt;-.data.frame $&lt;- statistic boot
memtrace[0x914f5f8-&gt;0x914f670]: $&lt;-.data.frame $&lt;- statistic boot
memtrace[0x9abd5e0-&gt;0x972cbf0]: statistic boot
memtrace[0x972cbf0-&gt;0x972cc68]: $&lt;-.data.frame $&lt;- statistic boot
memtrace[0x972cc68-&gt;0x972cd08]: $&lt;-.data.frame $&lt;- statistic boot
memtrace[0x9abd5e0-&gt;0x98ead98]: statistic boot
memtrace[0x98ead98-&gt;0x98eae10]: $&lt;-.data.frame $&lt;- statistic boot
memtrace[0x98eae10-&gt;0x98eae88]: $&lt;-.data.frame $&lt;- statistic boot
</pre></td></tr></table>

<p>The object is duplicated fifteen times, three times for each of the
<code>R+1</code> calls to <code>storm.bf</code>.  This is surprising, since none of the duplications happen inside <code>nls</code>. Stepping through <code>storm.bf</code> in the debugger shows that all three happen in the line
</p>
<table><tr><td>&nbsp;</td><td><pre class="smallexample">st$Time &lt;- st$fit + rs[i]
</pre></td></tr></table>

<p>Data frames are slower than matrices and this is an example of why.
Using <code>tracemem(st$Viscosity)</code> does not reveal any additional
copying.
</p>
<hr size="6">
<a name="Profiling-compiled-code"></a>
<table cellpadding="1" cellspacing="1" border="0">
<tr><td valign="middle" align="left">[<a href="#Tracing-copies-of-an-object" title="Previous section in reading order"> &lt; </a>]</td>
<td valign="middle" align="left">[<a href="#Linux" title="Next section in reading order"> &gt; </a>]</td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left">[<a href="#Tidying-and-profiling-R-code" title="Beginning of this chapter or previous chapter"> &lt;&lt; </a>]</td>
<td valign="middle" align="left">[<a href="#Tidying-and-profiling-R-code" title="Up section"> Up </a>]</td>
<td valign="middle" align="left">[<a href="#Debugging" title="Next chapter"> &gt;&gt; </a>]</td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left">[<a href="#Top" title="Cover (top) of document">Top</a>]</td>
<td valign="middle" align="left">[<a href="#SEC_Contents" title="Table of contents">Contents</a>]</td>
<td valign="middle" align="left">[<a href="#Function-and-variable-index" title="Index">Index</a>]</td>
<td valign="middle" align="left">[<a href="#SEC_About" title="About (help)"> ? </a>]</td>
</tr></table>
<a name="Profiling-compiled-code-1"></a>
<h2 class="section">3.4 Profiling compiled code</h2>
<a name="index-Profiling-2"></a>

<p>Profiling compiled code is highly system-specific, but this section
contains some hints gleaned from various R users.  Some methods need
to be different for a compiled executable and for dynamic/shared
libraries/objects as used by R packages.  We know of no good way to
profile DLLs on Windows.
</p>
<table class="menu" border="0" cellspacing="0">
<tr><td align="left" valign="top"><a href="#Linux">3.4.1 Linux</a></td><td>&nbsp;&nbsp;</td><td align="left" valign="top">                       
</td></tr>
<tr><td align="left" valign="top"><a href="#Solaris">3.4.2 Solaris</a></td><td>&nbsp;&nbsp;</td><td align="left" valign="top">                     
</td></tr>
<tr><td align="left" valign="top"><a href="#Mac-OS-X">3.4.3 Mac OS X</a></td><td>&nbsp;&nbsp;</td><td align="left" valign="top">                    
</td></tr>
</table>

<hr size="6">
<a name="Linux"></a>
<table cellpadding="1" cellspacing="1" border="0">
<tr><td valign="middle" align="left">[<a href="#Profiling-compiled-code" title="Previous section in reading order"> &lt; </a>]</td>
<td valign="middle" align="left">[<a href="#sprof" title="Next section in reading order"> &gt; </a>]</td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left">[<a href="#Tidying-and-profiling-R-code" title="Beginning of this chapter or previous chapter"> &lt;&lt; </a>]</td>
<td valign="middle" align="left">[<a href="#Profiling-compiled-code" title="Up section"> Up </a>]</td>
<td valign="middle" align="left">[<a href="#Debugging" title="Next chapter"> &gt;&gt; </a>]</td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left">[<a href="#Top" title="Cover (top) of document">Top</a>]</td>
<td valign="middle" align="left">[<a href="#SEC_Contents" title="Table of contents">Contents</a>]</td>
<td valign="middle" align="left">[<a href="#Function-and-variable-index" title="Index">Index</a>]</td>
<td valign="middle" align="left">[<a href="#SEC_About" title="About (help)"> ? </a>]</td>
</tr></table>
<a name="Linux-1"></a>
<h3 class="subsection">3.4.1 Linux</h3>

<p>Options include using <code>sprof</code> for a shared object, and
<code>oprofile</code> (see <a href="http://oprofile.sourceforge.net/">http://oprofile.sourceforge.net/</a>) and
<code>perf</code> (see
<a href="https://perf.wiki.kernel.org/index.php/Tutorial">https://perf.wiki.kernel.org/index.php/Tutorial</a>) for any
executable or shared object.
</p>
<hr size="6">
<a name="sprof"></a>
<table cellpadding="1" cellspacing="1" border="0">
<tr><td valign="middle" align="left">[<a href="#Linux" title="Previous section in reading order"> &lt; </a>]</td>
<td valign="middle" align="left">[<a href="#oprofile" title="Next section in reading order"> &gt; </a>]</td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left">[<a href="#Tidying-and-profiling-R-code" title="Beginning of this chapter or previous chapter"> &lt;&lt; </a>]</td>
<td valign="middle" align="left">[<a href="#Linux" title="Up section"> Up </a>]</td>
<td valign="middle" align="left">[<a href="#Debugging" title="Next chapter"> &gt;&gt; </a>]</td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left">[<a href="#Top" title="Cover (top) of document">Top</a>]</td>
<td valign="middle" align="left">[<a href="#SEC_Contents" title="Table of contents">Contents</a>]</td>
<td valign="middle" align="left">[<a href="#Function-and-variable-index" title="Index">Index</a>]</td>
<td valign="middle" align="left">[<a href="#SEC_About" title="About (help)"> ? </a>]</td>
</tr></table>
<h4 class="subsubsection">3.4.1.1 sprof</h4>

<p>You can select shared objects to be profiled with <code>sprof</code> by
setting the environment variable <code>LD_PROFILE</code>.  For example
</p>
<table><tr><td>&nbsp;</td><td><pre class="example">% setenv LD_PROFILE /path/to/R_HOME/library/stats/libs/stats.so
R
... run the boot example
% sprof /path/to/R_HOME/library/stats/libs/stats.so \
  /var/tmp/path/to/R_HOME/library/stats/libs/stats.so.profile

Flat profile:

Each sample counts as 0.01 seconds.
  %   cumulative   self              self     total
 time   seconds   seconds    calls  us/call  us/call  name
 76.19      0.32     0.32        0     0.00           numeric_deriv
 16.67      0.39     0.07        0     0.00           nls_iter
  7.14      0.42     0.03        0     0.00           getListElement

rm /path/to/R_HOME/library/stats/libs/stats.so.profile
... to clean up ...
</pre></td></tr></table>

<p>It is possible that root access is needed to create the directories used
for the profile data.
</p>
<hr size="6">
<a name="oprofile"></a>
<table cellpadding="1" cellspacing="1" border="0">
<tr><td valign="middle" align="left">[<a href="#sprof" title="Previous section in reading order"> &lt; </a>]</td>
<td valign="middle" align="left">[<a href="#Solaris" title="Next section in reading order"> &gt; </a>]</td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left">[<a href="#Tidying-and-profiling-R-code" title="Beginning of this chapter or previous chapter"> &lt;&lt; </a>]</td>
<td valign="middle" align="left">[<a href="#Linux" title="Up section"> Up </a>]</td>
<td valign="middle" align="left">[<a href="#Debugging" title="Next chapter"> &gt;&gt; </a>]</td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left">[<a href="#Top" title="Cover (top) of document">Top</a>]</td>
<td valign="middle" align="left">[<a href="#SEC_Contents" title="Table of contents">Contents</a>]</td>
<td valign="middle" align="left">[<a href="#Function-and-variable-index" title="Index">Index</a>]</td>
<td valign="middle" align="left">[<a href="#SEC_About" title="About (help)"> ? </a>]</td>
</tr></table>
<h4 class="subsubsection">3.4.1.2 oprofile</h4>

<p><code>oprofile</code> works by running a daemon which collects information.
The daemon must be started as root, e.g.
</p>
<table><tr><td>&nbsp;</td><td><pre class="example">% su
% opcontrol --no-vmlinux
% (optional, some platforms) opcontrol --callgraph=5
% opcontrol --start
% exit
</pre></td></tr></table>

<p>Then as a user
</p>
<table><tr><td>&nbsp;</td><td><pre class="example">% R
... run the boot example
% opcontrol --dump
% opreport -l /path/to/R_HOME/library/stats/libs/stats.so
...
samples  %        symbol name
1623     75.5939  anonymous symbol from section .plt
349      16.2552  numeric_deriv
113       5.2632  nls_iter
62        2.8878  getListElement
% opreport -l /path/to/R_HOME/bin/exec/R
...
samples  %        symbol name
76052    11.9912  Rf_eval
54670     8.6198  Rf_findVarInFrame3
37814     5.9622  Rf_allocVector
31489     4.9649  Rf_duplicate
28221     4.4496  Rf_protect
26485     4.1759  Rf_cons
23650     3.7289  Rf_matchArgs
21088     3.3250  Rf_findFun
19995     3.1526  findVarLocInFrame
14871     2.3447  Rf_evalList
13794     2.1749  R_Newhashpjw
13522     2.1320  R_gc_internal
...
</pre></td></tr></table>

<p>Shutting down the profiler and clearing the records needs to be done as
root.  You can use <code>opannotate</code> to annotate the source code with
the times spent in each section, if the appropriate source code was
compiled with debugging support, and <code>opreport -c</code> to generate a
callgraph (if collection was enabled and the platform supports this).
</p>
<hr size="6">
<a name="Solaris"></a>
<table cellpadding="1" cellspacing="1" border="0">
<tr><td valign="middle" align="left">[<a href="#oprofile" title="Previous section in reading order"> &lt; </a>]</td>
<td valign="middle" align="left">[<a href="#Mac-OS-X" title="Next section in reading order"> &gt; </a>]</td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left">[<a href="#Tidying-and-profiling-R-code" title="Beginning of this chapter or previous chapter"> &lt;&lt; </a>]</td>
<td valign="middle" align="left">[<a href="#Profiling-compiled-code" title="Up section"> Up </a>]</td>
<td valign="middle" align="left">[<a href="#Debugging" title="Next chapter"> &gt;&gt; </a>]</td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left">[<a href="#Top" title="Cover (top) of document">Top</a>]</td>
<td valign="middle" align="left">[<a href="#SEC_Contents" title="Table of contents">Contents</a>]</td>
<td valign="middle" align="left">[<a href="#Function-and-variable-index" title="Index">Index</a>]</td>
<td valign="middle" align="left">[<a href="#SEC_About" title="About (help)"> ? </a>]</td>
</tr></table>
<a name="Solaris-1"></a>
<h3 class="subsection">3.4.2 Solaris</h3>

<p>On 64-bit (only) Solaris, the standard profiling tool <code>gprof</code>
collects information from shared objects compiled with &lsquo;<samp>-pg</samp>&rsquo;.
</p>
<hr size="6">
<a name="Mac-OS-X"></a>
<table cellpadding="1" cellspacing="1" border="0">
<tr><td valign="middle" align="left">[<a href="#Solaris" title="Previous section in reading order"> &lt; </a>]</td>
<td valign="middle" align="left">[<a href="#Debugging" title="Next section in reading order"> &gt; </a>]</td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left">[<a href="#Tidying-and-profiling-R-code" title="Beginning of this chapter or previous chapter"> &lt;&lt; </a>]</td>
<td valign="middle" align="left">[<a href="#Profiling-compiled-code" title="Up section"> Up </a>]</td>
<td valign="middle" align="left">[<a href="#Debugging" title="Next chapter"> &gt;&gt; </a>]</td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left">[<a href="#Top" title="Cover (top) of document">Top</a>]</td>
<td valign="middle" align="left">[<a href="#SEC_Contents" title="Table of contents">Contents</a>]</td>
<td valign="middle" align="left">[<a href="#Function-and-variable-index" title="Index">Index</a>]</td>
<td valign="middle" align="left">[<a href="#SEC_About" title="About (help)"> ? </a>]</td>
</tr></table>
<a name="Mac-OS-X-1"></a>
<h3 class="subsection">3.4.3 Mac OS X</h3>

<p>Developers have recommended <code>sample</code> (or <code>Sampler.app</code>,
which is a GUI version) and <code>Shark</code> (see
<a href="http://developer.apple.com/tools/sharkoptimize.html">http://developer.apple.com/tools/sharkoptimize.html</a> and
<a href="http://developer.apple.com/tools/shark_optimize.html">http://developer.apple.com/tools/shark_optimize.html</a>).
</p>

<hr size="6">
<a name="Debugging"></a>
<table cellpadding="1" cellspacing="1" border="0">
<tr><td valign="middle" align="left">[<a href="#Mac-OS-X" title="Previous section in reading order"> &lt; </a>]</td>
<td valign="middle" align="left">[<a href="#Browsing" title="Next section in reading order"> &gt; </a>]</td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left">[<a href="#Tidying-and-profiling-R-code" title="Beginning of this chapter or previous chapter"> &lt;&lt; </a>]</td>
<td valign="middle" align="left">[<a href="#Top" title="Up section"> Up </a>]</td>
<td valign="middle" align="left">[<a href="#System-and-foreign-language-interfaces" title="Next chapter"> &gt;&gt; </a>]</td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left">[<a href="#Top" title="Cover (top) of document">Top</a>]</td>
<td valign="middle" align="left">[<a href="#SEC_Contents" title="Table of contents">Contents</a>]</td>
<td valign="middle" align="left">[<a href="#Function-and-variable-index" title="Index">Index</a>]</td>
<td valign="middle" align="left">[<a href="#SEC_About" title="About (help)"> ? </a>]</td>
</tr></table>
<a name="Debugging-1"></a>
<h1 class="chapter">4. Debugging</h1>

<p>This chapter covers the debugging of R extensions, starting with the
ways to get useful error information and moving on to how to deal with
errors that crash R.  For those who prefer other styles there are
contributed packages such as <a href="http://CRAN.R-project.org/package=debug"><strong>debug</strong></a> on <acronym>CRAN</acronym>
(described in an article in
<a href="http://CRAN.R-project.org/doc/Rnews/Rnews_2003-3.pdf">R-News 3/3</a>).  (There are notes from 2002 provided by Roger Peng at
<a href="http://www.biostat.jhsph.edu/~rpeng/docs/R-debug-tools.pdf">http://www.biostat.jhsph.edu/~rpeng/docs/R-debug-tools.pdf</a>
which provide complementary examples to those given here.)
</p>
<table class="menu" border="0" cellspacing="0">
<tr><td align="left" valign="top"><a href="#Browsing">4.1 Browsing</a></td><td>&nbsp;&nbsp;</td><td align="left" valign="top">                    
</td></tr>
<tr><td align="left" valign="top"><a href="#Debugging-R-code">4.2 Debugging R code</a></td><td>&nbsp;&nbsp;</td><td align="left" valign="top">            
</td></tr>
<tr><td align="left" valign="top"><a href="#Using-gctorture-and-valgrind">4.3 Using gctorture and valgrind</a></td><td>&nbsp;&nbsp;</td><td align="left" valign="top">  
</td></tr>
<tr><td align="left" valign="top"><a href="#Debugging-compiled-code">4.4 Debugging compiled code</a></td><td>&nbsp;&nbsp;</td><td align="left" valign="top">     
</td></tr>
</table>


<hr size="6">
<a name="Browsing"></a>
<table cellpadding="1" cellspacing="1" border="0">
<tr><td valign="middle" align="left">[<a href="#Debugging" title="Previous section in reading order"> &lt; </a>]</td>
<td valign="middle" align="left">[<a href="#Debugging-R-code" title="Next section in reading order"> &gt; </a>]</td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left">[<a href="#Debugging" title="Beginning of this chapter or previous chapter"> &lt;&lt; </a>]</td>
<td valign="middle" align="left">[<a href="#Debugging" title="Up section"> Up </a>]</td>
<td valign="middle" align="left">[<a href="#System-and-foreign-language-interfaces" title="Next chapter"> &gt;&gt; </a>]</td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left">[<a href="#Top" title="Cover (top) of document">Top</a>]</td>
<td valign="middle" align="left">[<a href="#SEC_Contents" title="Table of contents">Contents</a>]</td>
<td valign="middle" align="left">[<a href="#Function-and-variable-index" title="Index">Index</a>]</td>
<td valign="middle" align="left">[<a href="#SEC_About" title="About (help)"> ? </a>]</td>
</tr></table>
<a name="Browsing-1"></a>
<h2 class="section">4.1 Browsing</h2>

<a name="index-browser"></a>
<p>Most of the R-level debugging facilities are based around the
built-in browser.  This can be used directly by inserting a call to
<code>browser()</code> into the code of a function (for example, using
<code>fix(my_function)</code> ).  When code execution reaches that point in
the function, control returns to the R console with a special prompt.
For example
</p>
<table><tr><td>&nbsp;</td><td><pre class="example">&gt; fix(summary.data.frame) ## insert browser() call after for() loop
&gt; summary(women)
Called from: summary.data.frame(women)
Browse[1]&gt; ls()
 [1] &quot;digits&quot; &quot;i&quot;      &quot;lbs&quot;    &quot;lw&quot;     &quot;maxsum&quot; &quot;nm&quot;     &quot;nr&quot;     &quot;nv&quot;
 [9] &quot;object&quot; &quot;sms&quot;    &quot;z&quot;
Browse[1]&gt; maxsum
[1] 7
Browse[1]&gt;
     height         weight
 Min.   :58.0   Min.   :115.0
 1st Qu.:61.5   1st Qu.:124.5
 Median :65.0   Median :135.0
 Mean   :65.0   Mean   :136.7
 3rd Qu.:68.5   3rd Qu.:148.0
 Max.   :72.0   Max.   :164.0
&gt; rm(summary.data.frame)
</pre></td></tr></table>

<p>At the browser prompt one can enter any R expression, so for example
<code>ls()</code> lists the objects in the current frame, and entering the
name of an object will<a name="DOCF62" href="#FOOT62">(62)</a> print it.  The following commands are
also accepted
</p>
<ul>
<li> <code>n</code>

<p>Enter &lsquo;step-through&rsquo; mode.  In this mode, hitting return executes the
next line of code (more precisely one line and any continuation lines).
Typing <code>c</code> will continue to the end of the current context, e.g.
to the end of the current loop or function.
</p>
</li><li> <code>c</code>

<p>In normal mode, this quits the browser and continues execution, and just
return works in the same way.  <code>cont</code> is a synonym.
</p>
</li><li> <code>where</code>

<p>This prints the call stack.  For example
</p>
<table><tr><td>&nbsp;</td><td><pre class="example">&gt; summary(women)
Called from: summary.data.frame(women)
Browse[1]&gt; where
where 1: summary.data.frame(women)
where 2: summary(women)

Browse[1]&gt;
</pre></td></tr></table>

</li><li> <code>Q</code>

<p>Quit both the browser and the current expression, and return to the
top-level prompt.
</p></li></ul>

<p>Errors in code executed at the browser prompt will normally return
control to the browser prompt.  Objects can be altered by assignment,
and will keep their changed values when the browser is exited.  If
really necessary, objects can be assigned to the workspace from the
browser prompt (by using <code>&lt;&lt;-</code> if the name is not already in
scope).
</p>
<hr size="6">
<a name="Debugging-R-code"></a>
<table cellpadding="1" cellspacing="1" border="0">
<tr><td valign="middle" align="left">[<a href="#Browsing" title="Previous section in reading order"> &lt; </a>]</td>
<td valign="middle" align="left">[<a href="#Using-gctorture-and-valgrind" title="Next section in reading order"> &gt; </a>]</td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left">[<a href="#Debugging" title="Beginning of this chapter or previous chapter"> &lt;&lt; </a>]</td>
<td valign="middle" align="left">[<a href="#Debugging" title="Up section"> Up </a>]</td>
<td valign="middle" align="left">[<a href="#System-and-foreign-language-interfaces" title="Next chapter"> &gt;&gt; </a>]</td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left">[<a href="#Top" title="Cover (top) of document">Top</a>]</td>
<td valign="middle" align="left">[<a href="#SEC_Contents" title="Table of contents">Contents</a>]</td>
<td valign="middle" align="left">[<a href="#Function-and-variable-index" title="Index">Index</a>]</td>
<td valign="middle" align="left">[<a href="#SEC_About" title="About (help)"> ? </a>]</td>
</tr></table>
<a name="Debugging-R-code-1"></a>
<h2 class="section">4.2 Debugging R code</h2>

<a name="index-traceback"></a>
<p>Suppose your R program gives an error message.  The first thing to
find out is what R was doing at the time of the error, and the most
useful tool is <code>traceback()</code>.  We suggest that this is run whenever
the cause of the error is not immediately obvious.  Daily, errors are
reported to the R mailing lists as being in some package when
<code>traceback()</code> would show that the error was being reported by some
other package or base R.  Here is an example from the regression
suite.
</p>
<table><tr><td>&nbsp;</td><td><pre class="smallexample">&gt; success &lt;- c(13,12,11,14,14,11,13,11,12)
&gt; failure &lt;- c(0,0,0,0,0,0,0,2,2)
&gt; resp &lt;- cbind(success, failure)
&gt; predictor &lt;- c(0, 5^(0:7))
&gt; glm(resp ~ 0+predictor, family = binomial(link=&quot;log&quot;))
Error: no valid set of coefficients has been found: please supply starting values
&gt; traceback()
3: stop(&quot;no valid set of coefficients has been found: please supply
         starting values&quot;, call. = FALSE)
2: glm.fit(x = X, y = Y, weights = weights, start = start, etastart = etastart,
       mustart = mustart, offset = offset, family = family, control = control,
       intercept = attr(mt, &quot;intercept&quot;) &gt; 0)
1: glm(resp ~ 0 + predictor, family = binomial(link =&quot;log&quot;))
</pre></td></tr></table>

<p>The calls to the active frames are given in reverse order (starting with
the innermost).  So we see the error message comes from an explicit
check in <code>glm.fit</code>.  (<code>traceback()</code> shows you all the lines of
the function calls, which can be limited by setting <code>option</code>
&lsquo;<samp>&quot;deparse.max.lines&quot;</samp>&rsquo;.)
</p>
<p>Sometimes the traceback will indicate that the error was detected inside
compiled code, for example (from <code>?nls</code>)
</p>
<table><tr><td>&nbsp;</td><td><pre class="smallexample">Error in nls(y ~ a + b * x, start = list(a = 0.12345, b = 0.54321), trace = TRUE) :
        step factor 0.000488281 reduced below 'minFactor' of 0.000976563
&gt;  traceback()
2: .Call(R_nls_iter, m, ctrl, trace)
1: nls(y ~ a + b * x, start = list(a = 0.12345, b = 0.54321), trace = TRUE)
</pre></td></tr></table>

<p>This will be the case if the innermost call is to <code>.C</code>,
<code>.Fortran</code>, <code>.Call</code>, <code>.External</code> or <code>.Internal</code>, but
as it is also possible for such code to evaluate R expressions, this
need not be the innermost call, as in
</p>
<table><tr><td>&nbsp;</td><td><pre class="smallexample">&gt; traceback()
9: gm(a, b, x)
8: .Call(R_numeric_deriv, expr, theta, rho, dir)
7: numericDeriv(form[[3]], names(ind), env)
6: getRHS()
5: assign(&quot;rhs&quot;, getRHS(), envir = thisEnv)
4: assign(&quot;resid&quot;, .swts * (lhs - assign(&quot;rhs&quot;, getRHS(), envir = thisEnv)),
       envir = thisEnv)
3: function (newPars)
   {
       setPars(newPars)
       assign(&quot;resid&quot;, .swts * (lhs - assign(&quot;rhs&quot;, getRHS(), envir = thisEnv)),
           envir = thisEnv)
       assign(&quot;dev&quot;, sum(resid^2), envir = thisEnv)
       assign(&quot;QR&quot;, qr(.swts * attr(rhs, &quot;gradient&quot;)), envir = thisEnv)
       return(QR$rank &lt; min(dim(QR$qr)))
   }(c(-0.00760232418963883, 1.00119632515036))
2: .Call(R_nls_iter, m, ctrl, trace)
1: nls(yeps ~ gm(a, b, x), start = list(a = 0.12345, b = 0.54321))
</pre></td></tr></table>

<p>Occasionally <code>traceback()</code> does not help, and this can be the case
if S4 method dispatch is involved.  Consider the following example
</p>
<table><tr><td>&nbsp;</td><td><pre class="example">&gt; xyd &lt;- new(&quot;xyloc&quot;, x=runif(20), y=runif(20))
Error in as.environment(pkg) : no item called &quot;package:S4nswv&quot;
on the search list
Error in initialize(value, ...) : S language method selection got
an error when called from internal dispatch for function 'initialize'
&gt; traceback()
2: initialize(value, ...)
1: new(&quot;xyloc&quot;, x = runif(20), y = runif(20))
</pre></td></tr></table>

<p>which does not help much, as there is no call to <code>as.environment</code>
in <code>initialize</code> (and the note &ldquo;called from internal dispatch&rdquo;
tells us so).  In this case we searched the R sources for the quoted
call, which occurred in only one place,
<code>methods:::.asEnvironmentPackage</code>.  So now we knew where the
error was occurring.  (This was an unusually opaque example.)
</p>
<p>The error message
</p>
<table><tr><td>&nbsp;</td><td><pre class="example">evaluation nested too deeply: infinite recursion / options(expressions=)?
</pre></td></tr></table>

<p>can be hard to handle with the default value (5000).  Unless you know
that there actually is deep recursion going on, it can help to set
something like
</p>
<table><tr><td>&nbsp;</td><td><pre class="example">options(expressions=500)
</pre></td></tr></table>

<p>and re-run the example showing the error.
</p>
<p>Sometimes there is warning that clearly is the precursor to some later
error, but it is not obvious where it is coming from.  Setting
<code>options(warn = 2)</code> (which turns warnings into errors) can help here.
</p>
<p>Once we have located the error, we have some choices.  One way to proceed
is to find out more about what was happening at the time of the crash by
looking a <em>post-mortem</em> dump.  To do so, set
<a name="index-dump_002eframes"></a>
<code>options(error=dump.frames)</code> and run the code again.  Then invoke
<code>debugger()</code> and explore the dump.  Continuing our example:
</p>
<table><tr><td>&nbsp;</td><td><pre class="smallexample">&gt; options(error = dump.frames)
&gt; glm(resp ~ 0 + predictor, family = binomial(link =&quot;log&quot;))
Error: no valid set of coefficients has been found: please supply starting values
</pre></td></tr></table>

<p>which is the same as before, but an object called <code>last.dump</code> has
appeared in the workspace.  (Such objects can be large, so remove it
when it is no longer needed.)  We can examine this at a later time by
calling the function <code>debugger</code>.
<a name="index-debugger"></a>
</p>
<table><tr><td>&nbsp;</td><td><pre class="smallexample">&gt; debugger()
Message:  Error: no valid set of coefficients has been found: please supply starting values
Available environments had calls:
1: glm(resp ~ 0 + predictor, family = binomial(link = &quot;log&quot;))
2: glm.fit(x = X, y = Y, weights = weights, start = start, etastart = etastart, mus
3: stop(&quot;no valid set of coefficients has been found: please supply starting values
Enter an environment number, or 0 to exit  Selection:
</pre></td></tr></table>

<p>which gives the same sequence of calls as <code>traceback</code>, but in
outer-first order and with only the first line of the call, truncated to
the current width.  However, we can now examine in more detail what was
happening at the time of the error.  Selecting an environment opens the
browser in that frame.  So we select the function call which spawned the
error message, and explore some of the variables (and execute two
function calls).
</p>
<table><tr><td>&nbsp;</td><td><pre class="smallexample">Enter an environment number, or 0 to exit  Selection: 2
Browsing in the environment with call:
   glm.fit(x = X, y = Y, weights = weights, start = start, etas
Called from: debugger.look(ind)
Browse[1]&gt; ls()
 [1] &quot;aic&quot;        &quot;boundary&quot;   &quot;coefold&quot;    &quot;control&quot;    &quot;conv&quot;
 [6] &quot;dev&quot;        &quot;dev.resids&quot; &quot;devold&quot;     &quot;EMPTY&quot;      &quot;eta&quot;
[11] &quot;etastart&quot;   &quot;family&quot;     &quot;fit&quot;        &quot;good&quot;       &quot;intercept&quot;
[16] &quot;iter&quot;       &quot;linkinv&quot;    &quot;mu&quot;         &quot;mu.eta&quot;     &quot;mu.eta.val&quot;
[21] &quot;mustart&quot;    &quot;n&quot;          &quot;ngoodobs&quot;   &quot;nobs&quot;       &quot;nvars&quot;
[26] &quot;offset&quot;     &quot;start&quot;      &quot;valideta&quot;   &quot;validmu&quot;    &quot;variance&quot;
[31] &quot;varmu&quot;      &quot;w&quot;          &quot;weights&quot;    &quot;x&quot;          &quot;xnames&quot;
[36] &quot;y&quot;          &quot;ynames&quot;     &quot;z&quot;
Browse[1]&gt; eta
            1             2             3             4             5
 0.000000e+00 -2.235357e-06 -1.117679e-05 -5.588393e-05 -2.794197e-04
            6             7             8             9
-1.397098e-03 -6.985492e-03 -3.492746e-02 -1.746373e-01
Browse[1]&gt; valideta(eta)
[1] TRUE
Browse[1]&gt; mu
        1         2         3         4         5         6         7         8
1.0000000 0.9999978 0.9999888 0.9999441 0.9997206 0.9986039 0.9930389 0.9656755
        9
0.8397616
Browse[1]&gt; validmu(mu)
[1] FALSE
Browse[1]&gt; c
Available environments had calls:
1: glm(resp ~ 0 + predictor, family = binomial(link = &quot;log&quot;))
2: glm.fit(x = X, y = Y, weights = weights, start = start, etastart = etastart
3: stop(&quot;no valid set of coefficients has been found: please supply starting v

Enter an environment number, or 0 to exit  Selection: 0
&gt; rm(last.dump)
</pre></td></tr></table>

<p>Because <code>last.dump</code> can be looked at later or even in another R
session, post-mortem debugging is possible even for batch usage of R.
We do need to arrange for the dump to be saved: this can be done either
using the command-line flag &lsquo;<samp>--save</samp>&rsquo; to save the workspace at the
end of the run, or <em>via</em> a setting such as
</p>
<table><tr><td>&nbsp;</td><td><pre class="example">&gt; options(error = quote({dump.frames(to.file=TRUE); q()}))
</pre></td></tr></table>

<p>See the help on <code>dump.frames</code> for further options and a worked
example.
</p>
<a name="index-recover"></a>
<p>An alternative error action is to use the function <code>recover()</code>:
</p>
<table><tr><td>&nbsp;</td><td><pre class="smallexample">&gt; options(error = recover)
&gt; glm(resp ~ 0 + predictor, family = binomial(link = &quot;log&quot;))
Error: no valid set of coefficients has been found: please supply starting values

Enter a frame number, or 0 to exit

1: glm(resp ~ 0 + predictor, family = binomial(link = &quot;log&quot;))
2: glm.fit(x = X, y = Y, weights = weights, start = start, etastart = etastart

Selection:
</pre></td></tr></table>

<p>which is very similar to <code>dump.frames</code>.  However, we can examine
the state of the program directly, without dumping and re-loading the
dump.  As its help page says, <code>recover</code> can be routinely used as
the error action in place of <code>dump.calls</code> and <code>dump.frames</code>,
since it behaves like <code>dump.frames</code> in non-interactive use.
</p>

<a name="index-debug"></a>
<p>Post-mortem debugging is good for finding out exactly what went wrong,
but not necessarily why.  An alternative approach is to take a closer
look at what was happening just before the error, and a good way to do
that is to use <code>debug</code>.  This inserts a call to the browser
at the beginning of the function, starting in step-through mode.  So in
our example we could use
</p>
<table><tr><td>&nbsp;</td><td><pre class="smallexample">&gt; debug(glm.fit)
&gt; glm(resp ~ 0 + predictor, family = binomial(link =&quot;log&quot;))
debugging in: glm.fit(x = X, y = Y, weights = weights, start = start, etastart = etastart,
    mustart = mustart, offset = offset, family = family, control = control,
    intercept = attr(mt, &quot;intercept&quot;) &gt; 0)
debug: {
## lists the whole function
Browse[1]&gt;
debug: x &lt;- as.matrix(x)
...
Browse[1]&gt; start
[1] -2.235357e-06
debug: eta &lt;- drop(x %*% start)
Browse[1]&gt; eta
            1             2             3             4             5
 0.000000e+00 -2.235357e-06 -1.117679e-05 -5.588393e-05 -2.794197e-04
            6             7             8             9
-1.397098e-03 -6.985492e-03 -3.492746e-02 -1.746373e-01
Browse[1]&gt;
debug: mu &lt;- linkinv(eta &lt;- eta + offset)
Browse[1]&gt; mu
        1         2         3         4         5         6         7         8
1.0000000 0.9999978 0.9999888 0.9999441 0.9997206 0.9986039 0.9930389 0.9656755
        9
0.8397616
</pre></td></tr></table>

<p>(The prompt <code>Browse[1]&gt;</code> indicates that this is the first level of
browsing: it is possible to step into another function that is itself
being debugged or contains a call to <code>browser()</code>.)
</p>
<p><code>debug</code> can be used for hidden functions and S3 methods by
e.g. <code>debug(stats:::predict.Arima)</code>.  (It cannot be used for S4
methods, but an alternative is given on the help page for <code>debug</code>.)
Sometimes you want to debug a function defined inside another function,
e.g. the function <code>arimafn</code> defined inside <code>arima</code>.  To do so,
set <code>debug</code> on the outer function (here <code>arima</code>) and
step through it until the inner function has been defined.  Then
call <code>debug</code> on the inner function (and use <code>c</code> to get out of
step-through mode in the outer function).
</p>
<a name="index-undebug"></a>
<p>To remove debugging of a function, call <code>undebug</code> with the argument
previously given to <code>debug</code>; debugging otherwise lasts for the rest
of the R session (or until the function is edited or otherwise
replaced).
</p>
<a name="index-trace"></a>
<p><code>trace</code> can be used to temporarily insert debugging code into a
function, for example to insert a call to <code>browser()</code> just before
the point of the error.  To return to our running example
</p>
<table><tr><td>&nbsp;</td><td><pre class="example">## first get a numbered listing of the expressions of the function
&gt; page(as.list(body(glm.fit)), method=&quot;print&quot;)
&gt; trace(glm.fit, browser, at=22)
Tracing function &quot;glm.fit&quot; in package &quot;stats&quot;
[1] &quot;glm.fit&quot;
&gt; glm(resp ~ 0 + predictor, family = binomial(link =&quot;log&quot;))
Tracing glm.fit(x = X, y = Y, weights = weights, start = start,
   etastart = etastart,  .... step 22
Called from: eval(expr, envir, enclos)
Browse[1]&gt; n
## and single-step from here.
&gt; untrace(glm.fit)
</pre></td></tr></table>
<p>For your own functions, it may be as easy to use <code>fix</code> to insert
temporary code, but <code>trace</code> can help with functions in a namespace
(as can <code>fixInNamespace</code>).  Alternatively, use
<code>trace(,edit=TRUE)</code> to insert code visually.
</p>

<hr size="6">
<a name="Using-gctorture-and-valgrind"></a>
<table cellpadding="1" cellspacing="1" border="0">
<tr><td valign="middle" align="left">[<a href="#Debugging-R-code" title="Previous section in reading order"> &lt; </a>]</td>
<td valign="middle" align="left">[<a href="#Using-gctorture" title="Next section in reading order"> &gt; </a>]</td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left">[<a href="#Debugging" title="Beginning of this chapter or previous chapter"> &lt;&lt; </a>]</td>
<td valign="middle" align="left">[<a href="#Debugging" title="Up section"> Up </a>]</td>
<td valign="middle" align="left">[<a href="#System-and-foreign-language-interfaces" title="Next chapter"> &gt;&gt; </a>]</td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left">[<a href="#Top" title="Cover (top) of document">Top</a>]</td>
<td valign="middle" align="left">[<a href="#SEC_Contents" title="Table of contents">Contents</a>]</td>
<td valign="middle" align="left">[<a href="#Function-and-variable-index" title="Index">Index</a>]</td>
<td valign="middle" align="left">[<a href="#SEC_About" title="About (help)"> ? </a>]</td>
</tr></table>
<a name="Using-gctorture-and-valgrind-1"></a>
<h2 class="section">4.3 Using gctorture and valgrind</h2>

<p>Errors in memory allocation and reading/writing outside arrays are very
common causes of crashes (e.g., segfaults) on some machines.  Often
the crash appears long after the invalid memory access: in particular
damage to the structures which R itself has allocated may only become
apparent at the next garbage collection (or even at later garbage
collections after objects have been deleted).
</p>
<table class="menu" border="0" cellspacing="0">
<tr><td align="left" valign="top"><a href="#Using-gctorture">4.3.1 Using gctorture</a></td><td>&nbsp;&nbsp;</td><td align="left" valign="top">             
</td></tr>
<tr><td align="left" valign="top"><a href="#Using-valgrind">4.3.2 Using valgrind</a></td><td>&nbsp;&nbsp;</td><td align="left" valign="top">              
</td></tr>
</table>

<hr size="6">
<a name="Using-gctorture"></a>
<table cellpadding="1" cellspacing="1" border="0">
<tr><td valign="middle" align="left">[<a href="#Using-gctorture-and-valgrind" title="Previous section in reading order"> &lt; </a>]</td>
<td valign="middle" align="left">[<a href="#Using-valgrind" title="Next section in reading order"> &gt; </a>]</td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left">[<a href="#Debugging" title="Beginning of this chapter or previous chapter"> &lt;&lt; </a>]</td>
<td valign="middle" align="left">[<a href="#Using-gctorture-and-valgrind" title="Up section"> Up </a>]</td>
<td valign="middle" align="left">[<a href="#System-and-foreign-language-interfaces" title="Next chapter"> &gt;&gt; </a>]</td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left">[<a href="#Top" title="Cover (top) of document">Top</a>]</td>
<td valign="middle" align="left">[<a href="#SEC_Contents" title="Table of contents">Contents</a>]</td>
<td valign="middle" align="left">[<a href="#Function-and-variable-index" title="Index">Index</a>]</td>
<td valign="middle" align="left">[<a href="#SEC_About" title="About (help)"> ? </a>]</td>
</tr></table>
<a name="Using-gctorture-1"></a>
<h3 class="subsection">4.3.1 Using gctorture</h3>

<a name="index-gctorture"></a>
<p>We can help to detect memory problems earlier by running garbage
collection as often as possible.  This is achieved by
<code>gctorture(TRUE)</code>, which as described on its help page
</p>
<blockquote><p>Provokes garbage collection on (nearly) every memory allocation.
Intended to ferret out memory protection bugs.  Also makes R run
<em>very</em> slowly, unfortunately.
</p></blockquote>

<p>The reference to &lsquo;memory protection&rsquo; is to missing C-level calls to
<code>PROTECT</code>/<code>UNPROTECT</code> (see section <a href="#Garbage-Collection">Handling the effects of garbage collection</a>) which if
missing allow R objects to be garbage-collected when they are still
in use.  But it can also help with other memory-related errors.
</p>
<p>Normally running under <code>gctorture(TRUE)</code> will just produce a crash
earlier in the R program, hopefully close to the actual cause. See
the next section for how to decipher such crashes.
</p>
<p>It is possible to run all the examples, tests and vignettes covered by
<code>R CMD check</code> under <code>gctorture(TRUE)</code> by using the option
&lsquo;<samp>--use-gct</samp>&rsquo;.
</p>
<p>The function <code>gctorture2</code> provides more refined control over the GC
torture process.  Its arguments <code>step</code>, <code>wait</code> and
<code>inhibit_release</code> are documented on its help page.  Environment
variables can also be used to turn on GC torture: <code>R_GCTORTURE</code>
corresponds to the <code>step</code> argument to <code>gctorture</code>,
<code>R_GCTORTURE_WAIT</code> to <code>wait</code>, and
<code>R_GCTORTURE_INHIBIT_RELEASE</code> to <code>inhibit_release</code>.
</p>
<p>If R is configured with &lsquo;<samp>--enable-strict-barrier</samp>&rsquo; then a
variety of tests for the integrity of the write barrier are enabled.  In
addition tests to help detect protect issues are enabled as well:
</p>
<ul>
<li>
All GCs are full GCs.

</li><li>
New nodes in small node pages are marked as <code>NEWSXP</code> on creation.

</li><li>
After a GC all free nodes that are not of type <code>NEWSXP</code> are marked
as type <code>FREESXP</code> and their previous type is recorded.

</li><li>
Most calls to accessor functions check their <code>SEXP</code> inputs and
<code>SEXP</code> outputs and signal an error if a <code>FREESXP</code> is found.
The address of the node and the old type are included in the error
message.

</li></ul>

<p>Used with a debugger and with <code>gctorture</code> or <code>gctorture2</code> this
mechanism can be helpful in isolating memory protect problems.
</p>

<hr size="6">
<a name="Using-valgrind"></a>
<table cellpadding="1" cellspacing="1" border="0">
<tr><td valign="middle" align="left">[<a href="#Using-gctorture" title="Previous section in reading order"> &lt; </a>]</td>
<td valign="middle" align="left">[<a href="#Debugging-compiled-code" title="Next section in reading order"> &gt; </a>]</td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left">[<a href="#Debugging" title="Beginning of this chapter or previous chapter"> &lt;&lt; </a>]</td>
<td valign="middle" align="left">[<a href="#Using-gctorture-and-valgrind" title="Up section"> Up </a>]</td>
<td valign="middle" align="left">[<a href="#System-and-foreign-language-interfaces" title="Next chapter"> &gt;&gt; </a>]</td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left">[<a href="#Top" title="Cover (top) of document">Top</a>]</td>
<td valign="middle" align="left">[<a href="#SEC_Contents" title="Table of contents">Contents</a>]</td>
<td valign="middle" align="left">[<a href="#Function-and-variable-index" title="Index">Index</a>]</td>
<td valign="middle" align="left">[<a href="#SEC_About" title="About (help)"> ? </a>]</td>
</tr></table>
<a name="Using-valgrind-1"></a>
<h3 class="subsection">4.3.2 Using valgrind</h3>

<p>If you have access to Linux on an &lsquo;<samp>ix86</samp>&rsquo;, &lsquo;<samp>x86_64</samp>&rsquo;,
&lsquo;<samp>ppc32</samp>&rsquo;, &lsquo;<samp>ppc64</samp>&rsquo; or &lsquo;<samp>s390x</samp>&rsquo; platform, or Mac OS
10.5/6/7 on &lsquo;<samp>i386</samp>&rsquo; or &lsquo;<samp>x86_64</samp>&rsquo; you can use
<code>valgrind</code> (<a href="http://www.valgrind.org/">http://www.valgrind.org/</a>, pronounced to rhyme
with &lsquo;tinned&rsquo;) to check for possible problems.  To run some examples
under <code>valgrind</code> use something like
</p>
<table><tr><td>&nbsp;</td><td><pre class="example">R -d valgrind --vanilla &lt; mypkg-Ex.R
R -d &quot;valgrind --tool=memcheck --leak-check=full&quot; --vanilla &lt; mypkg-Ex.R
</pre></td></tr></table>

<p>where &lsquo;<tt>mypkg-Ex.R</tt>&rsquo; is a set of examples, e.g. the file created in
&lsquo;<tt>mypkg.Rcheck</tt>&rsquo; by <code>R CMD check</code>.  Occasionally this reports
memory reads of &lsquo;uninitialised values&rsquo; that are the result of compiler
optimization, so can be worth checking under an unoptimized compile: for
maximal information use a build with debugging symbols.  We know there
will be some small memory leaks from <code>readline</code> and R itself &mdash;
these are memory areas that are in use right up to the end of the R
session.  Expect this to run around 20x slower than without
<code>valgrind</code>, and in some cases even slower than that.  Earlier
versions of <code>valgrind</code> were not happy with many optimized BLASes
that use <acronym>CPU</acronym>-specific instructions (3D now, SSE, SSE2, SSE3
and similar) so you may need to build a version of R specifically to
use with <code>valgrind</code>.
</p>
<p>On Mac OS 10.6/7 the valgrind session is liable to hang when R
terminates.  This was an issue in <code>valgrind</code> prior to 3.8.1 and
can be circumvented by setting the environment variable
<code>R_OSX_VALGRIND</code>.  It is still necessary to avoid the use of
<code>system()</code> in the R session, directly or indirectly.
</p>
<p>On platforms supported by <code>valgrind</code> you can build a version of
R with extra instrumentation to help <code>valgrind</code> detect errors in
the use of memory allocated from the R heap.  The configure option is
&lsquo;<samp>--with-valgrind-instrumentation=<var>level</var></samp>&rsquo;, where <var>level</var>
is 0, 1, or 2.  Level 0 is the default and does not add any anything.
Level 1 will detect use of uninitialised memory and has little impact on
speed. Level 2 will detect many other memory-use bugs but makes R
much slower when running under <code>valgrind</code>.  Using this in
conjunction with <code>gctorture</code> can be even more effective (and even
slower).
</p>
<p>An example of <code>valgrind</code> output is
</p><table><tr><td>&nbsp;</td><td><pre class="smallexample">==12539== Invalid read of size 4
==12539==    at 0x1CDF6CBE: csc_compTr (Mutils.c:273)
==12539==    by 0x1CE07E1E: tsc_transpose (dtCMatrix.c:25)
==12539==    by 0x80A67A7: do_dotcall (dotcode.c:858)
==12539==    by 0x80CACE2: Rf_eval (eval.c:400)
==12539==    by 0x80CB5AF: R_execClosure (eval.c:658)
==12539==    by 0x80CB98E: R_execMethod (eval.c:760)
==12539==    by 0x1B93DEFA: R_standardGeneric (methods_list_dispatch.c:624)
==12539==    by 0x810262E: do_standardGeneric (objects.c:1012)
==12539==    by 0x80CAD23: Rf_eval (eval.c:403)
==12539==    by 0x80CB2F0: Rf_applyClosure (eval.c:573)
==12539==    by 0x80CADCC: Rf_eval (eval.c:414)
==12539==    by 0x80CAA03: Rf_eval (eval.c:362)
==12539==  Address 0x1C0D2EA8 is 280 bytes inside a block of size 1996 alloc'd
==12539==    at 0x1B9008D1: malloc (vg_replace_malloc.c:149)
==12539==    by 0x80F1B34: GetNewPage (memory.c:610)
==12539==    by 0x80F7515: Rf_allocVector (memory.c:1915)
...
</pre></td></tr></table>
<p>This example is from an instrumented version of R, while tracking
down a bug in the <a href="http://CRAN.R-project.org/package=Matrix"><strong>Matrix</strong></a> package in January, 2006.  The first line
indicates that R has tried to read 4 bytes from a memory address that
it does not have access to. This is followed by a C stack trace showing
where the error occurred. Next is a description of the memory that was
accessed. It is inside a block allocated by <code>malloc</code>, called from
<code>GetNewPage</code>, that is, in the internal R heap.  Since this
memory all belongs to R, <code>valgrind</code> would not (and did not)
detect the problem in an uninstrumented build of R.  In this example
the stack trace was enough to isolate and fix the bug, which was in
<code>tsc_transpose</code>, and in this example running under
<code>gctorture()</code> did not provide any additional information.  When the
stack trace is not sufficiently informative the option
&lsquo;<samp>--db-attach=yes</samp>&rsquo; to <code>valgrind</code> may be helpful.  This starts
a post-mortem debugger (by default <code>gdb</code>) so that variables in the
C code can be inspected (see section <a href="#Inspecting-R-objects">Inspecting R objects when debugging</a>).
</p>

<p>It is possible to run all the examples, tests and vignettes covered by
<code>R CMD check</code> under <code>valgrind</code> by using the option
&lsquo;<samp>--use-valgrind</samp>&rsquo;.  If you do this you will need to select the
<code>valgrind</code> options some other way, for example by having a
&lsquo;<tt>~/.valgrindrc</tt>&rsquo; file containing
</p>
<table><tr><td>&nbsp;</td><td><pre class="example">--tool=memcheck
--memcheck:leak-check=full
</pre></td></tr></table>

<p>or setting the environment variable <code>VALGRIND_OPTS</code>.
</p>
<p>On Mac OS X you may need to ensure that debugging symbols are made
available (so <code>valgrind</code> reports line numbers in files).  This
can usually be done with the <code>valgrind</code> option
&lsquo;<samp>--dysmutil=yes</samp>&rsquo; to ask for the symbols to be dumped when the
&lsquo;<tt>.so</tt>&rsquo; file is loaded.  This will not work where packages are
installed into a system area (such as the &lsquo;<tt>R.framework</tt>&rsquo;) and can be
slow.  Installing packages with <code>R CMD INSTALL --dsym</code> installs
the dumped symbols.  (This can also be done by setting environment
variable <code>PKG_MAKE_DSYM</code> to a non-empty value.)
</p>

<hr size="6">
<a name="Debugging-compiled-code"></a>
<table cellpadding="1" cellspacing="1" border="0">
<tr><td valign="middle" align="left">[<a href="#Using-valgrind" title="Previous section in reading order"> &lt; </a>]</td>
<td valign="middle" align="left">[<a href="#Finding-entry-points" title="Next section in reading order"> &gt; </a>]</td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left">[<a href="#Debugging" title="Beginning of this chapter or previous chapter"> &lt;&lt; </a>]</td>
<td valign="middle" align="left">[<a href="#Debugging" title="Up section"> Up </a>]</td>
<td valign="middle" align="left">[<a href="#System-and-foreign-language-interfaces" title="Next chapter"> &gt;&gt; </a>]</td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left">[<a href="#Top" title="Cover (top) of document">Top</a>]</td>
<td valign="middle" align="left">[<a href="#SEC_Contents" title="Table of contents">Contents</a>]</td>
<td valign="middle" align="left">[<a href="#Function-and-variable-index" title="Index">Index</a>]</td>
<td valign="middle" align="left">[<a href="#SEC_About" title="About (help)"> ? </a>]</td>
</tr></table>
<a name="Debugging-compiled-code-1"></a>
<h2 class="section">4.4 Debugging compiled code</h2>
<a name="index-Debugging"></a>


<p>Sooner or later programmers will be faced with the need to debug
compiled code loaded into R.   This section is geared to platforms
using <code>gdb</code> with code compiled by <code>gcc</code>, but similar things
are possible with front-ends to <code>gdb</code> such as <code>ddd</code> and
<code>insight</code>, and other debuggers such as Sun&rsquo;s <code>dbx</code>.
</p>
<p>Consider first &lsquo;crashes&rsquo;, that is when R terminated unexpectedly with
an illegal memory access (a &lsquo;segfault&rsquo; or &lsquo;bus error&rsquo;), illegal
instruction or similar.  Unix-alike versions of R use a signal
handler which aims to give some basic information.  For example
</p>
<table><tr><td>&nbsp;</td><td><pre class="example"> *** caught segfault ***
address 0x20000028, cause 'memory not mapped'

Traceback:
 1: .identC(class1[[1]], class2)
 2: possibleExtends(class(sloti), classi, ClassDef2 = getClassDef(classi,
where = where))
 3: validObject(t(cu))
 4: stopifnot(validObject(cu &lt;- as(tu, &quot;dtCMatrix&quot;)), validObject(t(cu)),
validObject(t(tu)))

Possible actions:
1: abort (with core dump)
2: normal R exit
3: exit R without saving workspace
4: exit R saving workspace
Selection: 3
</pre></td></tr></table>

<p>Since the R process may be damaged, the only really safe option is
the first.
</p>
<p>A fairly common cause of such crashes is a package which uses <code>.C</code>
or <code>.Fortran</code> and writes beyond (at either end) one of the
arguments it is passed.  As from R 3.0.0 there is a good way to
detect this: using <code>options(CBoundsCheck = TRUE)</code> (which can be
selected <em>via</em> the environment variable <code>R_C_BOUNDS_CHECK=yes)</code>
changes the way <code>.C</code> and <code>.Fortran</code> work to check if the
compiled code writes in the 64 bytes at either end of an argument.
</p>
<p>Another cause of a &lsquo;crash&rsquo; is to overrun the C stack.  R tries to
track that in its own code, but it may happen in third-party compiled
code.  For modern POSIX-compliant OSes R can safely catch that and
return to the top-level prompt, so one gets something like
</p>
<table><tr><td>&nbsp;</td><td><pre class="example">&gt; .C(&quot;aaa&quot;)
Error: segfault from C stack overflow
&gt;
</pre></td></tr></table>

<p>However, C stack overflows are fatal under Windows and normally defeat
attempts at debugging on that platform.  Further, the size of the stack
is set when R is compiled<a name="DOCF63" href="#FOOT63">(63)</a>,
whereas on POSIX OSes it can be set in the shell from which R is
launched.
</p>
<p>If you have a crash which gives a core dump you can use something like
</p>
<table><tr><td>&nbsp;</td><td><pre class="example">gdb /path/to/R/bin/exec/R core.12345
</pre></td></tr></table>

<p>to examine the core dump.  If core dumps are disabled or to catch errors
that do not generate a dump one can run R directly under a debugger
by for example
</p>
<table><tr><td>&nbsp;</td><td><pre class="example">$ R -d gdb --vanilla
...
gdb&gt; run
</pre></td></tr></table>

<p>at which point R will run normally, and hopefully the debugger will
catch the error and return to its prompt.  This can also be used to
catch infinite loops or interrupt very long-running code.  For a simple
example
</p>
<table><tr><td>&nbsp;</td><td><pre class="example">&gt; for(i in 1:1e7) x &lt;- rnorm(100)
[hit Ctrl-C]
Program received signal SIGINT, Interrupt.
0x00397682 in _int_free () from /lib/tls/libc.so.6
(gdb) where
#0  0x00397682 in _int_free () from /lib/tls/libc.so.6
#1  0x00397eba in free () from /lib/tls/libc.so.6
#2  0xb7cf2551 in R_gc_internal (size_needed=313)
    at /users/ripley/R/svn/R-devel/src/main/memory.c:743
#3  0xb7cf3617 in Rf_allocVector (type=13, length=626)
    at /users/ripley/R/svn/R-devel/src/main/memory.c:1906
#4  0xb7c3f6d3 in PutRNGstate ()
    at /users/ripley/R/svn/R-devel/src/main/RNG.c:351
#5  0xb7d6c0a5 in do_random2 (call=0x94bf7d4, op=0x92580e8, args=0x9698f98,
    rho=0x9698f28) at /users/ripley/R/svn/R-devel/src/main/random.c:183
...
</pre></td></tr></table>

<p>Some &ldquo;tricks&rdquo; worth knowing follow:
</p>
<table class="menu" border="0" cellspacing="0">
<tr><td align="left" valign="top"><a href="#Finding-entry-points">4.4.1 Finding entry points in dynamically loaded code</a></td><td>&nbsp;&nbsp;</td><td align="left" valign="top">        
</td></tr>
<tr><td align="left" valign="top"><a href="#Inspecting-R-objects">4.4.2 Inspecting R objects when debugging</a></td><td>&nbsp;&nbsp;</td><td align="left" valign="top">        
</td></tr>
</table>

<hr size="6">
<a name="Finding-entry-points"></a>
<table cellpadding="1" cellspacing="1" border="0">
<tr><td valign="middle" align="left">[<a href="#Debugging-compiled-code" title="Previous section in reading order"> &lt; </a>]</td>
<td valign="middle" align="left">[<a href="#Inspecting-R-objects" title="Next section in reading order"> &gt; </a>]</td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left">[<a href="#Debugging" title="Beginning of this chapter or previous chapter"> &lt;&lt; </a>]</td>
<td valign="middle" align="left">[<a href="#Debugging-compiled-code" title="Up section"> Up </a>]</td>
<td valign="middle" align="left">[<a href="#System-and-foreign-language-interfaces" title="Next chapter"> &gt;&gt; </a>]</td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left">[<a href="#Top" title="Cover (top) of document">Top</a>]</td>
<td valign="middle" align="left">[<a href="#SEC_Contents" title="Table of contents">Contents</a>]</td>
<td valign="middle" align="left">[<a href="#Function-and-variable-index" title="Index">Index</a>]</td>
<td valign="middle" align="left">[<a href="#SEC_About" title="About (help)"> ? </a>]</td>
</tr></table>
<a name="Finding-entry-points-in-dynamically-loaded-code"></a>
<h3 class="subsection">4.4.1 Finding entry points in dynamically loaded code</h3>

<p>Under most compilation environments, compiled code dynamically loaded
into R cannot have breakpoints set within it until it is loaded.  To
use a symbolic debugger on such dynamically loaded code under
Unix-alikes use
</p>
<ul>
<li>
Call the debugger on the R executable, for example by <kbd>R -d gdb</kbd>.
</li><li>
Start R.
</li><li>
At the R prompt, use <code>dyn.load</code> or <code>library</code> to load your
shared object.
</li><li>
Send an interrupt signal.  This will put you back to the debugger
prompt.
</li><li>
Set the breakpoints in your code.
</li><li>
Continue execution of R by typing <kbd>signal 0&lt;RET&gt;</kbd>.
</li></ul>

<p>Under Windows signals may not be able to be used, and if so the procedure is
more complicated.  See the rw-FAQ and
<a href="http://www.stats.uwo.ca/faculty/murdoch/software/debuggingR/gdb.shtml"><code>www.stats.uwo.ca/faculty/murdoch/software/debuggingR/gdb.shtml</code></a>.
</p>

<hr size="6">
<a name="Inspecting-R-objects"></a>
<table cellpadding="1" cellspacing="1" border="0">
<tr><td valign="middle" align="left">[<a href="#Finding-entry-points" title="Previous section in reading order"> &lt; </a>]</td>
<td valign="middle" align="left">[<a href="#System-and-foreign-language-interfaces" title="Next section in reading order"> &gt; </a>]</td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left">[<a href="#Debugging" title="Beginning of this chapter or previous chapter"> &lt;&lt; </a>]</td>
<td valign="middle" align="left">[<a href="#Debugging-compiled-code" title="Up section"> Up </a>]</td>
<td valign="middle" align="left">[<a href="#System-and-foreign-language-interfaces" title="Next chapter"> &gt;&gt; </a>]</td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left">[<a href="#Top" title="Cover (top) of document">Top</a>]</td>
<td valign="middle" align="left">[<a href="#SEC_Contents" title="Table of contents">Contents</a>]</td>
<td valign="middle" align="left">[<a href="#Function-and-variable-index" title="Index">Index</a>]</td>
<td valign="middle" align="left">[<a href="#SEC_About" title="About (help)"> ? </a>]</td>
</tr></table>
<a name="Inspecting-R-objects-when-debugging"></a>
<h3 class="subsection">4.4.2 Inspecting R objects when debugging</h3>
<a name="index-Inspecting-R-objects-when-debugging"></a>

<p>The key to inspecting R objects from compiled code is the function
<code>PrintValue(SEXP <var>s</var>)</code> which uses the normal R printing
mechanisms to print the R object pointed to by <var>s</var>, or the safer
version <code>R_PV(SEXP <var>s</var>)</code> which will only print &lsquo;objects&rsquo;.
</p>
<p>One way to make use of <code>PrintValue</code> is to insert suitable calls
into the code to be debugged.
</p>
<p>Another way is to call <code>R_PV</code> from the symbolic debugger.
(<code>PrintValue</code> is hidden as <code>Rf_PrintValue</code>.)  For example,
from <code>gdb</code> we can use
</p>
<table><tr><td>&nbsp;</td><td><pre class="example">(gdb) p R_PV(ab)
</pre></td></tr></table>

<p>using the object <code>ab</code> from the convolution example, if we have
placed a suitable breakpoint in the convolution C code.
</p>
<p>To examine an arbitrary R object we need to work a little harder.
For example, let
</p>
<table><tr><td>&nbsp;</td><td><pre class="example">R&gt; DF &lt;- data.frame(a = 1:3, b = 4:6)
</pre></td></tr></table>

<p>By setting a breakpoint at <code>do_get</code> and typing <kbd>get(&quot;DF&quot;)</kbd> at
the R prompt, one can find out the address in memory of <code>DF</code>, for
example
</p>
<table><tr><td>&nbsp;</td><td><pre class="example">Value returned is $1 = (SEXPREC *) 0x40583e1c
(gdb) p *$1
$2 = {
  sxpinfo = {type = 19, obj = 1, named = 1, gp = 0,
    mark = 0, debug = 0, trace = 0, = 0},
  attrib = 0x40583e80,
  u = {
    vecsxp = {
      length = 2,
      type = {c = 0x40634700 &quot;0&gt;X@D&gt;X@0&gt;X@&quot;, i = 0x40634700,
        f = 0x40634700, z = 0x40634700, s = 0x40634700},
      truelength = 1075851272,
    },
    primsxp = {offset = 2},
    symsxp = {pname = 0x2, value = 0x40634700, internal = 0x40203008},
    listsxp = {carval = 0x2, cdrval = 0x40634700, tagval = 0x40203008},
    envsxp = {frame = 0x2, enclos = 0x40634700},
    closxp = {formals = 0x2, body = 0x40634700, env = 0x40203008},
    promsxp = {value = 0x2, expr = 0x40634700, env = 0x40203008}
  }
}
</pre></td></tr></table>

<p>(Debugger output reformatted for better legibility).
</p>
<p>Using <code>R_PV()</code> one can &ldquo;inspect&rdquo; the values of the various
elements of the SEXP, for example,
</p>
<table><tr><td>&nbsp;</td><td><pre class="example">(gdb) p R_PV($1-&gt;attrib)
$names
[1] &quot;a&quot; &quot;b&quot;

$row.names
[1] &quot;1&quot; &quot;2&quot; &quot;3&quot;

$class
[1] &quot;data.frame&quot;

$3 = void
</pre></td></tr></table>

<p>To find out where exactly the corresponding information is stored, one
needs to go &ldquo;deeper&rdquo;:
</p>
<table><tr><td>&nbsp;</td><td><pre class="example">(gdb) set $a = $1-&gt;attrib
(gdb) p $a-&gt;u.listsxp.tagval-&gt;u.symsxp.pname-&gt;u.vecsxp.type.c
$4 = 0x405d40e8 &quot;names&quot;
(gdb) p $a-&gt;u.listsxp.carval-&gt;u.vecsxp.type.s[1]-&gt;u.vecsxp.type.c
$5 = 0x40634378 &quot;b&quot;
(gdb) p $1-&gt;u.vecsxp.type.s[0]-&gt;u.vecsxp.type.i[0]
$6 = 1
(gdb) p $1-&gt;u.vecsxp.type.s[1]-&gt;u.vecsxp.type.i[1]
$7 = 5
</pre></td></tr></table>

<p>Another alternative available from R 2.13.0 on is the <code>R_inspect</code>
function which shows the low-level structure of the objects
recursively (addresses differ from the above as this example is
created on another machine):
</p>
<table><tr><td>&nbsp;</td><td><pre class="example">(gdb) p R_inspect($1)
@100954d18 19 VECSXP g0c2 [OBJ,NAM(2),ATT] (len=2, tl=0)
  @100954d50 13 INTSXP g0c2 [NAM(2)] (len=3, tl=0) 1,2,3
  @100954d88 13 INTSXP g0c2 [NAM(2)] (len=3, tl=0) 4,5,6
ATTRIB:
  @102a70140 02 LISTSXP g0c0 []
    TAG: @10083c478 01 SYMSXP g0c0 [MARK,NAM(2),gp=0x4000] &quot;names&quot;
    @100954dc0 16 STRSXP g0c2 [NAM(2)] (len=2, tl=0)
      @10099df28 09 CHARSXP g0c1 [MARK,gp=0x21] &quot;a&quot;
      @10095e518 09 CHARSXP g0c1 [MARK,gp=0x21] &quot;b&quot;
    TAG: @100859e60 01 SYMSXP g0c0 [MARK,NAM(2),gp=0x4000] &quot;row.names&quot;
    @102a6f868 13 INTSXP g0c1 [NAM(2)] (len=2, tl=1) -2147483648,-3
    TAG: @10083c948 01 SYMSXP g0c0 [MARK,gp=0x4000] &quot;class&quot;
    @102a6f838 16 STRSXP g0c1 [NAM(2)] (len=1, tl=1)
      @1008c6d48 09 CHARSXP g0c2 [MARK,gp=0x21,ATT] &quot;data.frame&quot;
</pre></td></tr></table>

<p>In general the representation of each object follows the format:
</p>
<table><tr><td>&nbsp;</td><td><pre class="smallexample">@&lt;address&gt; &lt;type-nr&gt; &lt;type-name&gt; &lt;gc-info&gt; [&lt;flags&gt;] ...
</pre></td></tr></table>

<p>For a more fine-grained control over the the depth of the recursion
and the output of vectors <code>R_inspect3</code> takes additional two integer
parameters: maximum depth and the maximal number of elements that will
be printed for scalar vectors. The defaults in <code>R_inspect</code> are
currently -1 (no limit) and 5 respectively.
</p>

<hr size="6">
<a name="System-and-foreign-language-interfaces"></a>
<table cellpadding="1" cellspacing="1" border="0">
<tr><td valign="middle" align="left">[<a href="#Inspecting-R-objects" title="Previous section in reading order"> &lt; </a>]</td>
<td valign="middle" align="left">[<a href="#Operating-system-access" title="Next section in reading order"> &gt; </a>]</td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left">[<a href="#Debugging" title="Beginning of this chapter or previous chapter"> &lt;&lt; </a>]</td>
<td valign="middle" align="left">[<a href="#Top" title="Up section"> Up </a>]</td>
<td valign="middle" align="left">[<a href="#The-R-API" title="Next chapter"> &gt;&gt; </a>]</td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left">[<a href="#Top" title="Cover (top) of document">Top</a>]</td>
<td valign="middle" align="left">[<a href="#SEC_Contents" title="Table of contents">Contents</a>]</td>
<td valign="middle" align="left">[<a href="#Function-and-variable-index" title="Index">Index</a>]</td>
<td valign="middle" align="left">[<a href="#SEC_About" title="About (help)"> ? </a>]</td>
</tr></table>
<a name="System-and-foreign-language-interfaces-1"></a>
<h1 class="chapter">5. System and foreign language interfaces</h1>

<table class="menu" border="0" cellspacing="0">
<tr><td align="left" valign="top"><a href="#Operating-system-access">5.1 Operating system access</a></td><td>&nbsp;&nbsp;</td><td align="left" valign="top">     
</td></tr>
<tr><td align="left" valign="top"><a href="#Interface-functions-_002eC-and-_002eFortran">5.2 Interface functions <code>.C</code> and <code>.Fortran</code></a></td><td>&nbsp;&nbsp;</td><td align="left" valign="top">  
</td></tr>
<tr><td align="left" valign="top"><a href="#dyn_002eload-and-dyn_002eunload">5.3 <code>dyn.load</code> and <code>dyn.unload</code></a></td><td>&nbsp;&nbsp;</td><td align="left" valign="top">     
</td></tr>
<tr><td align="left" valign="top"><a href="#Registering-native-routines">5.4 Registering native routines</a></td><td>&nbsp;&nbsp;</td><td align="left" valign="top">  
</td></tr>
<tr><td align="left" valign="top"><a href="#Creating-shared-objects">5.5 Creating shared objects</a></td><td>&nbsp;&nbsp;</td><td align="left" valign="top">     
</td></tr>
<tr><td align="left" valign="top"><a href="#Interfacing-C_002b_002b-code">5.6 Interfacing C++ code</a></td><td>&nbsp;&nbsp;</td><td align="left" valign="top">        
</td></tr>
<tr><td align="left" valign="top"><a href="#Fortran-I_002fO">5.7 Fortran I/O</a></td><td>&nbsp;&nbsp;</td><td align="left" valign="top">                 
</td></tr>
<tr><td align="left" valign="top"><a href="#Linking-to-other-packages">5.8 Linking to other packages</a></td><td>&nbsp;&nbsp;</td><td align="left" valign="top">   
</td></tr>
<tr><td align="left" valign="top"><a href="#Handling-R-objects-in-C">5.9 Handling R objects in C</a></td><td>&nbsp;&nbsp;</td><td align="left" valign="top">     
</td></tr>
<tr><td align="left" valign="top"><a href="#Interface-functions-_002eCall-and-_002eExternal">5.10 Interface functions <code>.Call</code> and <code>.External</code></a></td><td>&nbsp;&nbsp;</td><td align="left" valign="top">  
</td></tr>
<tr><td align="left" valign="top"><a href="#Evaluating-R-expressions-from-C">5.11 Evaluating R expressions from C</a></td><td>&nbsp;&nbsp;</td><td align="left" valign="top">  
</td></tr>
<tr><td align="left" valign="top"><a href="#Parsing-R-code-from-C">5.12 Parsing R code from C</a></td><td>&nbsp;&nbsp;</td><td align="left" valign="top">       
</td></tr>
<tr><td align="left" valign="top"><a href="#External-pointers-and-weak-references">5.13 External pointers and weak references</a></td><td>&nbsp;&nbsp;</td><td align="left" valign="top">  
</td></tr>
<tr><td align="left" valign="top"><a href="#Vector-accessor-functions">5.14 Vector accessor functions</a></td><td>&nbsp;&nbsp;</td><td align="left" valign="top">   
</td></tr>
<tr><td align="left" valign="top"><a href="#Character-encoding-issues">5.15 Character encoding issues</a></td><td>&nbsp;&nbsp;</td><td align="left" valign="top">   
</td></tr>
</table>

<hr size="6">
<a name="Operating-system-access"></a>
<table cellpadding="1" cellspacing="1" border="0">
<tr><td valign="middle" align="left">[<a href="#System-and-foreign-language-interfaces" title="Previous section in reading order"> &lt; </a>]</td>
<td valign="middle" align="left">[<a href="#Interface-functions-_002eC-and-_002eFortran" title="Next section in reading order"> &gt; </a>]</td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left">[<a href="#System-and-foreign-language-interfaces" title="Beginning of this chapter or previous chapter"> &lt;&lt; </a>]</td>
<td valign="middle" align="left">[<a href="#System-and-foreign-language-interfaces" title="Up section"> Up </a>]</td>
<td valign="middle" align="left">[<a href="#The-R-API" title="Next chapter"> &gt;&gt; </a>]</td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left">[<a href="#Top" title="Cover (top) of document">Top</a>]</td>
<td valign="middle" align="left">[<a href="#SEC_Contents" title="Table of contents">Contents</a>]</td>
<td valign="middle" align="left">[<a href="#Function-and-variable-index" title="Index">Index</a>]</td>
<td valign="middle" align="left">[<a href="#SEC_About" title="About (help)"> ? </a>]</td>
</tr></table>
<a name="Operating-system-access-1"></a>
<h2 class="section">5.1 Operating system access</h2>
<a name="index-Operating-system-access"></a>

<p>Access to operating system functions is <em>via</em> the R functions
<code>system</code> and <code>system2</code>.
<a name="index-system"></a>
<a name="index-system2"></a>
The details will differ by platform (see the on-line help), and about
all that can safely be assumed is that the first argument will be a
string <code>command</code> that will be passed for execution (not necessarily
by a shell) and the second argument to <code>system</code> will be
<code>internal</code> which if true will collect the output of the command
into an R character vector.
</p>
<p>The function <code>system.time</code>
<a name="index-system_002etime"></a>
is available for timing.  Timing on child processes is only available on
Unix-alikes, and may not be reliable there.
</p>
<hr size="6">
<a name="Interface-functions-_002eC-and-_002eFortran"></a>
<table cellpadding="1" cellspacing="1" border="0">
<tr><td valign="middle" align="left">[<a href="#Operating-system-access" title="Previous section in reading order"> &lt; </a>]</td>
<td valign="middle" align="left">[<a href="#dyn_002eload-and-dyn_002eunload" title="Next section in reading order"> &gt; </a>]</td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left">[<a href="#System-and-foreign-language-interfaces" title="Beginning of this chapter or previous chapter"> &lt;&lt; </a>]</td>
<td valign="middle" align="left">[<a href="#System-and-foreign-language-interfaces" title="Up section"> Up </a>]</td>
<td valign="middle" align="left">[<a href="#The-R-API" title="Next chapter"> &gt;&gt; </a>]</td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left">[<a href="#Top" title="Cover (top) of document">Top</a>]</td>
<td valign="middle" align="left">[<a href="#SEC_Contents" title="Table of contents">Contents</a>]</td>
<td valign="middle" align="left">[<a href="#Function-and-variable-index" title="Index">Index</a>]</td>
<td valign="middle" align="left">[<a href="#SEC_About" title="About (help)"> ? </a>]</td>
</tr></table>
<a name="Interface-functions-_002eC-and-_002eFortran-1"></a>
<h2 class="section">5.2 Interface functions <code>.C</code> and <code>.Fortran</code></h2>
<a name="index-Interfaces-to-compiled-code"></a>

<a name="index-_002eC"></a>
<a name="index-_002eFortran"></a>

<p>These two functions provide an interface to compiled code that has been
linked into R, either at build time or <em>via</em> <code>dyn.load</code>
(see section <a href="#dyn_002eload-and-dyn_002eunload"><code>dyn.load</code> and <code>dyn.unload</code></a>).  They are primarily intended for
compiled C and FORTRAN 77 code respectively, but the <code>.C</code> function
can be used with other languages which can generate C interfaces, for
example C++ (see section <a href="#Interfacing-C_002b_002b-code">Interfacing C++ code</a>).
</p>
<p>The first argument to each function is a character string specifying the
symbol name as known<a name="DOCF64" href="#FOOT64">(64)</a> to C or
FORTRAN, that is the function or subroutine name.  (That the symbol is
loaded can be tested by, for example, <code>is.loaded(&quot;cg&quot;)</code>.  Use the
name you pass to <code>.C</code> or <code>.Fortran</code> rather than the translated
symbol name.)
</p>
<p>There can be up to 65 further arguments giving R objects to be passed
to compiled code.  Normally these are copied before being passed in, and
copied again to an R list object when the compiled code returns.  If
the arguments are given names, these are used as names for the
components in the returned list object (but not passed to the compiled
code).
</p>
<p>The following table gives the mapping between the modes of R atomic
vectors and the types of arguments to a C function or FORTRAN
subroutine.
</p>
<blockquote><table>
<thead><tr><th>R storage mode</th><th>C type</th><th>FORTRAN type</th></tr></thead>
<tr><td><code>logical</code></td><td><code>int *</code></td><td><code>INTEGER</code></td></tr>
<tr><td><code>integer</code></td><td><code>int *</code></td><td><code>INTEGER</code></td></tr>
<tr><td><code>double</code></td><td><code>double *</code></td><td><code>DOUBLE PRECISION</code></td></tr>
<tr><td><code>complex</code></td><td><code>Rcomplex *</code></td><td><code>DOUBLE COMPLEX</code></td></tr>
<tr><td><code>character</code></td><td><code>char **</code></td><td><code>CHARACTER*255</code></td></tr>
<tr><td><code>raw</code></td><td><code>unsigned char *</code></td><td>none</td></tr>
</table>
</blockquote>

<p>Do please note the first two.  On the 64-bit Unix/Linux/OS X platforms,
<code>long</code> is 64-bit whereas <code>int</code> and <code>INTEGER</code> are 32-bit.
Code ported from S-PLUS (which uses <code>long *</code> for <code>logical</code> and
<code>integer</code>) will not work on all 64-bit platforms (although it may
appear to work on some, including Windows).  Note also that if your
compiled code is a mixture of C functions and FORTRAN subprograms the
argument types must match as given in the table above.
</p>
<p>C type <code>Rcomplex</code> is a structure with <code>double</code> members
<code>r</code> and <code>i</code> defined in the header file &lsquo;<tt>R_ext/Complex.h</tt>&rsquo;
included by &lsquo;<tt>R.h</tt>&rsquo;.  (On most platforms this is stored in a way
compatible with the C99 <code>double complex</code> type: however, it may not
be possible to pass <code>Rcomplex</code> to a C99 function expecting a
<code>double complex</code> argument.  Nor need it be compatible with a C++
<code>complex</code> type.  Moreover, the compatibility can depends on the
optimization level set for the compiler.)
</p>
<p>Only a single character string can be passed to or from FORTRAN, and the
success of this is compiler-dependent.  Other R objects can be passed
to <code>.C</code>, but it is much better to use one of the other interfaces.
</p>
<p>It is possible to pass numeric vectors of storage mode <code>double</code> to
C as <code>float *</code> or to FORTRAN as <code>REAL</code> by setting the
attribute <code>Csingle</code>, most conveniently by using the R functions
<code>as.single</code>, <code>single</code> or <code>mode</code>.  This is intended only
to be used to aid interfacing existing C or FORTRAN code.
</p>
<p>Logical values are sent as <code>0</code> (<code>FALSE</code>), <code>1</code>
(<code>TRUE</code>) or <code>INT_MIN = -2147483648</code> (<code>NA</code>, but only if
<code>NAOK</code> is true), and the compiled code should return one of these
three values.  (Non-zero values other than <code>INT_MIN</code> are mapped to
<code>TRUE</code>.)
</p>
<p>Unless formal argument <code>NAOK</code> is true, all the other arguments are
checked for missing values <code>NA</code> and for the <acronym>IEEE</acronym> special
values <code>NaN</code>, <code>Inf</code> and <code>-Inf</code>, and the presence of any
of these generates an error.  If it is true, these values are passed
unchecked.
</p>
<p>Argument <code>DUP</code> can be used to suppress copying.  It is dangerous:
see the on-line help for arguments against its use.  It is not possible
to pass numeric vectors as <code>float *</code> or <code>REAL</code> if
<code>DUP = FALSE</code>, and character vectors cannot be used.
</p>
<p>Argument <code>PACKAGE</code> confines the search for the symbol name to a
specific shared object (or use <code>&quot;base&quot;</code> for code compiled into
R).  Its use is highly desirable, as there is no way to avoid two
package writers using the same symbol name, and such name clashes are
normally sufficient to cause R to crash.  (If it is not present and
the call is from the body of a function defined in a package namespace,
the shared object loaded by the first (if any) <code>useDynLib</code>
directive will be used.  However, prior to R 2.15.2 the detection of
the correct namespace is unreliable and you are strongly recommended to
use the <code>PACKAGE</code> argument for packages to be used with earlier
versions of R.
</p>
<p>Note that the compiled code should not return anything except through
its arguments: C functions should be of type <code>void</code> and FORTRAN
subprograms should be subroutines.
</p>
<p>To fix ideas, let us consider a very simple example which convolves two
finite sequences. (This is hard to do fast in interpreted R code, but
easy in C code.)  We could do this using <code>.C</code> by
</p>
<table><tr><td>&nbsp;</td><td><pre class="example">void convolve(double *a, int *na, double *b, int *nb, double *ab)
{
    int i, j, nab = *na + *nb - 1;

    for(i = 0; i &lt; nab; i++)
        ab[i] = 0.0;
    for(i = 0; i &lt; *na; i++)
        for(j = 0; j &lt; *nb; j++)
            ab[i + j] += a[i] * b[j];
}
</pre></td></tr></table>

<p>called from R by
</p>
<table><tr><td>&nbsp;</td><td><pre class="example">conv &lt;- function(a, b)
    .C(&quot;convolve&quot;,
       as.double(a),
       as.integer(length(a)),
       as.double(b),
       as.integer(length(b)),
       ab = double(length(a) + length(b) - 1))$ab
</pre></td></tr></table>

<p>Note that we take care to coerce all the arguments to the correct R
storage mode before calling <code>.C</code>; mistakes in matching the types
can lead to wrong results or hard-to-catch errors.
</p>
<p>Special care is needed in handling <code>character</code> vector arguments in
C (or C++).  Since only <code>DUP = TRUE</code> is allowed, on entry the
contents of the elements are duplicated and assigned to the elements of
a <code>char **</code> array, and on exit the elements of the C array are
copied to create new elements of a character vector.  This means that
the contents of the character strings of the <code>char **</code> array can be
changed, including to <code>\0</code> to shorten the string, but the strings
cannot be lengthened.  It is possible<a name="DOCF65" href="#FOOT65">(65)</a> to
allocate a new string <em>via</em> <code>R_alloc</code> and replace an entry in
the <code>char **</code> array by the new string.  However, when character
vectors are used other than in a read-only way, the <code>.Call</code>
interface is much to be preferred.
</p>
<p>Passing character strings to FORTRAN code needs even more care, and
should be avoided where possible.  Only the first element of the
character vector is passed in, as a fixed-length (255) character array.
Up to 255 characters are passed back to a length-one character vector.
How well this works (or even if it works at all) depends on the C and
FORTRAN compilers on each platform.
</p>
<p>It is possible to pass R objects other than atomic vectors via
<code>.C</code>, but this is only supported for historical compatibility: use
the <code>.Call</code> or <code>.External</code> interfaces for such objects.  Any
C/C++ code that includes &lsquo;<tt>Rinternals.h</tt>&rsquo; should be called via
<code>.Call</code> or <code>.External</code>.
</p>
<hr size="6">
<a name="dyn_002eload-and-dyn_002eunload"></a>
<table cellpadding="1" cellspacing="1" border="0">
<tr><td valign="middle" align="left">[<a href="#Interface-functions-_002eC-and-_002eFortran" title="Previous section in reading order"> &lt; </a>]</td>
<td valign="middle" align="left">[<a href="#Registering-native-routines" title="Next section in reading order"> &gt; </a>]</td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left">[<a href="#System-and-foreign-language-interfaces" title="Beginning of this chapter or previous chapter"> &lt;&lt; </a>]</td>
<td valign="middle" align="left">[<a href="#System-and-foreign-language-interfaces" title="Up section"> Up </a>]</td>
<td valign="middle" align="left">[<a href="#The-R-API" title="Next chapter"> &gt;&gt; </a>]</td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left">[<a href="#Top" title="Cover (top) of document">Top</a>]</td>
<td valign="middle" align="left">[<a href="#SEC_Contents" title="Table of contents">Contents</a>]</td>
<td valign="middle" align="left">[<a href="#Function-and-variable-index" title="Index">Index</a>]</td>
<td valign="middle" align="left">[<a href="#SEC_About" title="About (help)"> ? </a>]</td>
</tr></table>
<a name="dyn_002eload-and-dyn_002eunload-1"></a>
<h2 class="section">5.3 <code>dyn.load</code> and <code>dyn.unload</code></h2>
<a name="index-Dynamic-loading"></a>

<a name="index-dyn_002eload"></a>
<a name="index-dyn_002eunload"></a>

<p>Compiled code to be used with R is loaded as a shared object
(Unix-alikes including Mac OS X, see section <a href="#Creating-shared-objects">Creating shared objects</a> for
more information) or DLL (Windows).
</p>
<p>The shared object/DLL is loaded by <code>dyn.load</code> and unloaded by
<code>dyn.unload</code>.  Unloading is not normally necessary, but it is
needed to allow the DLL to be re-built on some platforms, including
Windows.
</p>
<p>The first argument to both functions is a character string giving the
path to the object.  Programmers should not assume a specific file
extension for the object/DLL (such as &lsquo;<tt>.so</tt>&rsquo;) but use a construction
like
</p>
<table><tr><td>&nbsp;</td><td><pre class="example">file.path(path1, path2, paste0(&quot;mylib&quot;, .Platform$dynlib.ext))
</pre></td></tr></table>

<p>for platform independence.  On Unix-alike systems the path supplied to
<code>dyn.load</code> can be an absolute path, one relative to the current
directory or, if it starts with &lsquo;<samp>~</samp>&rsquo;, relative to the user&rsquo;s home
directory.
</p>
<p>Loading is most often done automatically based on the <code>useDynLib()</code>
declaration in the &lsquo;<tt>NAMESPACE</tt>&rsquo; file, but may be done
explicitly <em>via</em> a call to <code>library.dynam</code>.
<a name="index-library_002edynam-1"></a>
This has the form
</p>
<table><tr><td>&nbsp;</td><td><pre class="example">library.dynam(&quot;libname&quot;, package, lib.loc)
</pre></td></tr></table>

<p>where <code>libname</code> is the object/DLL name <em>with the extension
omitted</em>.  Note that the first argument, <code>chname</code>, should
<strong>not</strong> be <code>package</code> since this will not work if the package
is installed under another name.
</p>
<p>Under some Unix-alike systems there is a choice of how the symbols are
resolved when the object is loaded, governed by the arguments
<code>local</code> and <code>now</code>.  Only use these if really necessary: in
particular using <code>now=FALSE</code> and then calling an unresolved symbol
will terminate R unceremoniously.
</p>
<p>R provides a way of executing some code automatically when a object/DLL
is either loaded or unloaded.  This can be used, for example, to
register native routines with R&rsquo;s dynamic symbol mechanism, initialize
some data in the native code, or initialize a third party library.  On
loading a DLL, R will look for a routine within that DLL named
<code>R_init_<var>lib</var></code> where <var>lib</var> is the name of the DLL file with
the extension removed.  For example, in the command
</p>
<table><tr><td>&nbsp;</td><td><pre class="example">library.dynam(&quot;mylib&quot;, package, lib.loc)
</pre></td></tr></table>

<p>R looks for the symbol named <code>R_init_mylib</code>.  Similarly, when
unloading the object, R looks for a routine named
<code>R_unload_<var>lib</var></code>, e.g., <code>R_unload_mylib</code>.  In either case,
if the routine is present, R will invoke it and pass it a single
argument describing the DLL.  This is a value of type <code>DllInfo</code>
which is defined in the &lsquo;<tt>Rdynload.h</tt>&rsquo; file in the &lsquo;<tt>R_ext</tt>&rsquo;
directory.
</p>
<p>Note that there are some implicit restrictions on this mechanism as the
basename of the DLL needs to be both a valid file name and valid as part
of a C entry point (e.g. it cannot contain &lsquo;<samp>.</samp>&rsquo;): for portable
code it is best to confine DLL names to be ASCII alphanumeric plus
underscore.  As from R 2.15.0, if entry point <code>R_init_<var>lib</var></code>
is not found it is also looked for with &lsquo;<samp>.</samp>&rsquo; replaced by &lsquo;<samp>_</samp>&rsquo;.
</p>

<p>The following example shows templates for the initialization and
unload routines for the <code>mylib</code> DLL.
</p>
<blockquote><table class="cartouche" border="1"><tr><td>
<table><tr><td>&nbsp;</td><td><pre class="example">#include &lt;R.h&gt;
#include &lt;Rinternals.h&gt;
#include &lt;R_ext/Rdynload.h&gt;

void
R_init_mylib(DllInfo *info)
{
  /* Register routines,
     allocate resources. */
}

void
R_unload_mylib(DllInfo *info)
{
  /* Release resources. */
}
</pre></td></tr></table>
</td></tr></table>
</blockquote>

<p>If a shared object/DLL is loaded more than once the most recent version
is used.  More generally, if the same symbol name appears in several
shared objects, the most recently loaded occurrence is used.  The
<code>PACKAGE</code> argument and registration (see the next section) provide
good ways to avoid any ambiguity in which occurrence is meant.
</p>
<p>On Unix-alikes the paths used to resolve dynamically linked dependent
libraries are fixed (for security reasons) when the process is launched,
so <code>dyn.load</code> will only look for such libraries in the locations
set by the &lsquo;<tt>R</tt>&rsquo; shell script (<em>via</em> &lsquo;<tt>etc/ldpaths</tt>&rsquo;) and in
the OS-specific defaults.
</p>
<p>Windows allows more control (and less security) over where dependent
DLLs are looked for.  On all versions this includes the <code>PATH</code>
environment variable, but with lowest priority: note that it does not
include the directory from which the DLL was loaded.  It is possible to
add a single path with quite high priority <em>via</em> the <code>DLLpath</code>
argument to <code>dyn.load</code>.  This is (by default) used by
<code>library.dynam</code> to include the package&rsquo;s &lsquo;<tt>libs/i386</tt>&rsquo; or
&lsquo;<tt>libs/x64</tt>&rsquo; directory in the DLL search path.
</p>

<hr size="6">
<a name="Registering-native-routines"></a>
<table cellpadding="1" cellspacing="1" border="0">
<tr><td valign="middle" align="left">[<a href="#dyn_002eload-and-dyn_002eunload" title="Previous section in reading order"> &lt; </a>]</td>
<td valign="middle" align="left">[<a href="#Speed-considerations" title="Next section in reading order"> &gt; </a>]</td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left">[<a href="#System-and-foreign-language-interfaces" title="Beginning of this chapter or previous chapter"> &lt;&lt; </a>]</td>
<td valign="middle" align="left">[<a href="#System-and-foreign-language-interfaces" title="Up section"> Up </a>]</td>
<td valign="middle" align="left">[<a href="#The-R-API" title="Next chapter"> &gt;&gt; </a>]</td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left">[<a href="#Top" title="Cover (top) of document">Top</a>]</td>
<td valign="middle" align="left">[<a href="#SEC_Contents" title="Table of contents">Contents</a>]</td>
<td valign="middle" align="left">[<a href="#Function-and-variable-index" title="Index">Index</a>]</td>
<td valign="middle" align="left">[<a href="#SEC_About" title="About (help)"> ? </a>]</td>
</tr></table>
<a name="Registering-native-routines-1"></a>
<h2 class="section">5.4 Registering native routines</h2>
<a name="index-Registering-native-routines"></a>

<p>By &lsquo;native&rsquo; routine, we mean an entry point in compiled code.
</p>
<p>In calls to <code>.C</code>, <code>.Call</code>, <code>.Fortran</code> and
<code>.External</code>, R must locate the specified native routine by
looking in the appropriate shared object/DLL.  By default, R uses the
operating system-specific dynamic loader to lookup the symbol in all
loaded DLLs and elsewhere.  Alternatively, the author of the DLL
can explicitly register routines with R and use a single,
platform-independent mechanism for finding the routines in the DLL.  One
can use this registration mechanism to provide additional information
about a routine, including the number and type of the arguments, and
also make it available to R programmers under a different name.  In
the future, registration may be used to implement a form of &ldquo;secure&rdquo;
or limited native access.
</p>
<a name="index-R_005fregisterRoutines"></a>
<p>To register routines with R, one calls the C routine
<code>R_registerRoutines</code>.  This is typically done when the DLL is first
loaded within the initialization routine <code>R_init_<var>dll name</var></code>
described in <a href="#dyn_002eload-and-dyn_002eunload"><code>dyn.load</code> and <code>dyn.unload</code></a>.  <code>R_registerRoutines</code>
takes 5 arguments.  The first is the <code>DllInfo</code> object passed by
R to the initialization routine. This is where R stores the
information about the methods.  The remaining 4 arguments are arrays
describing the routines for each of the 4 different interfaces:
<code>.C</code>, <code>.Call</code>, <code>.Fortran</code> and <code>.External</code>.  Each
argument is a <code>NULL</code>-terminated array of the element types given in
the following table:
</p>
<blockquote><table>
<tr><td><code>.C</code></td><td><code>R_CMethodDef</code></td></tr>
<tr><td><code>.Call</code></td><td><code>R_CallMethodDef</code></td></tr>
<tr><td><code>.Fortran</code></td><td><code>R_FortranMethodDef</code></td></tr>
<tr><td><code>.External</code></td><td><code>R_ExternalMethodDef</code></td></tr>
</table>
</blockquote>

<p>Currently, the <code>R_ExternalMethodDef</code> is the same as
<code>R_CallMethodDef</code> type and contains fields for the name of the
routine by which it can be accessed in R, a pointer to the actual
native symbol (i.e., the routine itself), and the number of arguments
the routine expects to be passed from R. For example, if we had a
routine named <code>myCall</code> defined as
</p>
<table><tr><td>&nbsp;</td><td><pre class="example">SEXP myCall(SEXP a, SEXP b, SEXP c);
</pre></td></tr></table>

<p>we would describe this as
</p>
<table><tr><td>&nbsp;</td><td><pre class="example">R_CallMethodDef callMethods[]  = {
  {&quot;myCall&quot;, (DL_FUNC) &amp;myCall, 3},
  {NULL, NULL, 0}
};
</pre></td></tr></table>

<p>along with any other routines for the <code>.Call</code> interface. For
routines with a variable number of arguments invoked <em>via</em> the
<code>.External</code> interface, one specifies <code>-1</code> for the number of
arguments which tells R not to check the actual number passed.  Note
that the number of arguments passed to <code>.External</code> were not
checked prior to R 3.0.0.
</p>
<p>Routines for use with the <code>.C</code> and <code>.Fortran</code> interfaces are
described with similar data structures, but which have two additional
fields for describing the type and &ldquo;style&rdquo; of each argument.  Each of
these can be omitted. However, if specified, each should be an array
with the same number of elements as the number of parameters for the
routine.  The types array should contain the <code>SEXP</code> types
describing the expected type of the argument. (Technically, the elements
of the types array are of type <code>R_NativePrimitiveArgType</code> which is
just an unsigned integer.)  The R types and corresponding type
identifiers are provided in the following table:
</p>
<blockquote><table>
<tr><td><code>numeric</code></td><td><code>REALSXP</code></td></tr>
<tr><td><code>integer</code></td><td><code>INTSXP</code></td></tr>
<tr><td><code>logical</code></td><td><code>LGLSXP</code></td></tr>
<tr><td><code>single</code></td><td><code>SINGLESXP</code></td></tr>
<tr><td><code>character</code></td><td><code>STRSXP</code></td></tr>
<tr><td><code>list</code></td><td><code>VECSXP</code></td></tr>
</table>
</blockquote>

<p>Consider a C routine, <code>myC</code>, declared as
</p>
<table><tr><td>&nbsp;</td><td><pre class="example">void myC(double *x, int *n, char **names, int *status);
</pre></td></tr></table>

<p>We would register it as
</p>
<table><tr><td>&nbsp;</td><td><pre class="example">R_CMethodDef cMethods[] = {
   {&quot;myC&quot;, (DL_FUNC) &amp;myC, 4, {REALSXP, INTSXP, STRSXP, LGLSXP}},
   {NULL, NULL, 0}
};
</pre></td></tr></table>

<p>One can also specify whether each argument is used simply as input, or
as output, or as both input and output.  The style field in the
description of a method is used for this.  The purpose is to
allow<a name="DOCF66" href="#FOOT66">(66)</a> R to transfer values
more efficiently across the R-C/FORTRAN interface by avoiding copying
values when it is not necessary. Typically, one omits this information
in the registration data.
</p>
<p>Having created the arrays describing each routine, the last step is to
actually register them with R.  We do this by calling
<code>R_registerRoutines</code>.  For example, if we have the descriptions
above for the routines accessed by the <code>.C</code> and <code>.Call</code>
we would use the following code:
</p>
<table><tr><td>&nbsp;</td><td><pre class="example">void
R_init_myLib(DllInfo *info)
{
   R_registerRoutines(info, cMethods, callMethods, NULL, NULL);
}
</pre></td></tr></table>

<p>This routine will be invoked when R loads the shared object/DLL named
<code>myLib</code>.  The last two arguments in the call to
<code>R_registerRoutines</code> are for the routines accessed by
<code>.Fortran</code> and <code>.External</code> interfaces.  In our example, these
are given as <code>NULL</code> since we have no routines of these types.
</p>
<p>When R unloads a shared object/DLL, its registrations are
automatically removed.  There is no other facility for unregistering a
symbol.
</p>
<p>Examples of registering routines can be found in the different packages
in the R source tree (e.g., <strong>stats</strong>).  Also, there is a
brief, high-level introduction in <em>R News</em> (volume 1/3, September
2001, pages 20&ndash;23, <a href="http://www.r-project.org/doc/Rnews/Rnews_2001-3.pdf">http://www.r-project.org/doc/Rnews/Rnews_2001-3.pdf</a>).
</p>
<p>Once routines are registered, they can be referred to as R objects if
they this is arranged in the <code>useDynLib</code> call in the package&rsquo;s
&lsquo;<tt>NAMESPACE</tt>&rsquo; file (see <a href="#useDynLib">useDynLib</a>).  This avoids the overhead
of looking up an entry point each time it is used, and ensure that the
entry point in the package is the one used (without a <code>PACKAGE =
&quot;pkg&quot;</code> argument).  So for example the <strong>stats</strong> package has
</p><table><tr><td>&nbsp;</td><td><pre class="example"># Refer to all C/Fortran routines by their name prefixed by C_
useDynLib(stats, .registration = TRUE, .fixes = &quot;C_&quot;)
</pre></td></tr></table>
<p>in its &lsquo;<tt>NAMESPACE</tt>&rsquo; file, and then <code>ansari.test</code>&rsquo;s default
methods can contain
</p><table><tr><td>&nbsp;</td><td><pre class="example">        pansari &lt;- function(q, m, n)
            .C(C_pansari, as.integer(length(q)), p = as.double(q), 
                as.integer(m), as.integer(n))$p
</pre></td></tr></table>



<table class="menu" border="0" cellspacing="0">
<tr><td align="left" valign="top"><a href="#Speed-considerations">5.4.1 Speed considerations</a></td><td>&nbsp;&nbsp;</td><td align="left" valign="top">        
</td></tr>
<tr><td align="left" valign="top"><a href="#Linking-to-native-routines-in-other-packages">5.4.2 Linking to native routines in other packages</a></td><td>&nbsp;&nbsp;</td><td align="left" valign="top">  
</td></tr>
</table>

<hr size="6">
<a name="Speed-considerations"></a>
<table cellpadding="1" cellspacing="1" border="0">
<tr><td valign="middle" align="left">[<a href="#Registering-native-routines" title="Previous section in reading order"> &lt; </a>]</td>
<td valign="middle" align="left">[<a href="#Linking-to-native-routines-in-other-packages" title="Next section in reading order"> &gt; </a>]</td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left">[<a href="#System-and-foreign-language-interfaces" title="Beginning of this chapter or previous chapter"> &lt;&lt; </a>]</td>
<td valign="middle" align="left">[<a href="#Registering-native-routines" title="Up section"> Up </a>]</td>
<td valign="middle" align="left">[<a href="#The-R-API" title="Next chapter"> &gt;&gt; </a>]</td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left">[<a href="#Top" title="Cover (top) of document">Top</a>]</td>
<td valign="middle" align="left">[<a href="#SEC_Contents" title="Table of contents">Contents</a>]</td>
<td valign="middle" align="left">[<a href="#Function-and-variable-index" title="Index">Index</a>]</td>
<td valign="middle" align="left">[<a href="#SEC_About" title="About (help)"> ? </a>]</td>
</tr></table>
<a name="Speed-considerations-1"></a>
<h3 class="subsection">5.4.1 Speed considerations</h3>

<p>Sometimes registering native routines or using a <code>PACKAGE</code> argument
can make a large difference.  The results can depend quite markedly on
the OS (and even if it is 32- or 64-bit), on the version of R and
what else is loaded into R at the time.
</p>
<p>To fix ideas, first consider <code>x84_64</code> Mac OS 10.7 and R 2.15.2.  A
simple <code>.Call</code> function might be
</p><table><tr><td>&nbsp;</td><td><pre class="example">foo &lt;- function(x) .Call(&quot;foo&quot;, x)
</pre></td></tr></table>
<p>with C code
</p><table><tr><td>&nbsp;</td><td><pre class="example">SEXP foo(SEXP x)
{
    return x;
}
</pre></td></tr></table>
<p>If we compile with by <code>R CMD SHLIB foo.c</code>, load the code by
<code>dyn.load(&quot;foo.so&quot;)</code> and run <code>foo(pi)</code> it took around 22
microseconds (us). Specifying the DLL by
</p><table><tr><td>&nbsp;</td><td><pre class="example">foo2 &lt;- function(x) .Call(&quot;foo&quot;, x, PACKAGE = &quot;foo&quot;)
</pre></td></tr></table>
<p>reduced the time to 1.7 us.
</p>
<p>Now consider making these functions part of a package whose
&lsquo;<tt>NAMESPACE</tt>&rsquo; file uses <code>useDynlib(foo)</code>.  This immediately
reduces the running time as <code>&quot;foo&quot;</code> will be preferentially looked
for &lsquo;<tt>foo.dll</tt>&rsquo;.  Without specifying <code>PACKAGE</code> it took about 5
us (it needs to fathom out the appropriate DLL each time it is invoked
but it does not need to search all DLLs), and with the <code>PACKAGE</code>
argument it is again about 1.7 us.
</p>
<p>Next suppose the package has registered the native routine <code>foo</code>.
Then <code>foo()</code> still has to find the appropriate DLL but can get to
the entry point in the DLL faster, in about 4.2 us.  And <code>foo2()</code>
now takes about 1 us.  If we register the symbols in the
&lsquo;<tt>NAMESPACE</tt>&rsquo; file and use
</p><table><tr><td>&nbsp;</td><td><pre class="example">foo3 &lt;- function(x) .Call(C_foo, x)
</pre></td></tr></table>
<p>then the address for the native routine is looked up just once when the
package is loaded, and <code>foo3(pi)</code> takes about 0.8 us.
</p>
<p>Versions using <code>.C()</code> rather than <code>.Call()</code> take about 0.2 us
longer.
</p>
<p>These are all quite small differences, but C routines are not uncommonly
invoked millions of times for run times of a few microseconds, and those
doing such things may wish to be aware of the differences.
</p>
<p>On Linux and Solaris there is a much smaller overhead in looking up
symbols so <code>foo(pi)</code> takes around 5 times as long as
<code>foo3(pi)</code>.
</p>
<p>Symbol lookup on Windows used to be far slower, so R maintains a
small cache.  If the cache is currently empty enough that the symbol can
be stored in the cache then the performance is similar to Linux and
Solaris: if not it may be slower.  R&rsquo;s own code always uses
registered symbols and so these never contribute to the cache: however
many other packages do rely on symbol lookup.
</p>


<hr size="6">
<a name="Linking-to-native-routines-in-other-packages"></a>
<table cellpadding="1" cellspacing="1" border="0">
<tr><td valign="middle" align="left">[<a href="#Speed-considerations" title="Previous section in reading order"> &lt; </a>]</td>
<td valign="middle" align="left">[<a href="#Creating-shared-objects" title="Next section in reading order"> &gt; </a>]</td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left">[<a href="#System-and-foreign-language-interfaces" title="Beginning of this chapter or previous chapter"> &lt;&lt; </a>]</td>
<td valign="middle" align="left">[<a href="#Registering-native-routines" title="Up section"> Up </a>]</td>
<td valign="middle" align="left">[<a href="#The-R-API" title="Next chapter"> &gt;&gt; </a>]</td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left">[<a href="#Top" title="Cover (top) of document">Top</a>]</td>
<td valign="middle" align="left">[<a href="#SEC_Contents" title="Table of contents">Contents</a>]</td>
<td valign="middle" align="left">[<a href="#Function-and-variable-index" title="Index">Index</a>]</td>
<td valign="middle" align="left">[<a href="#SEC_About" title="About (help)"> ? </a>]</td>
</tr></table>
<a name="Linking-to-native-routines-in-other-packages-1"></a>
<h3 class="subsection">5.4.2 Linking to native routines in other packages</h3>

<p>In addition to registering C routines to be called by R, it can at
times be useful for one package to make some of its C routines available
to be called by C code in another package.  The interface consists of
two routines declared in header &lsquo;<tt>R_ext/Rdynload.h</tt>&rsquo; as
</p>
<a name="index-R_005fRegisterCCallable"></a>
<a name="index-R_005fGetCCallable"></a>
<table><tr><td>&nbsp;</td><td><pre class="example">void R_RegisterCCallable(const char *package, const char *name,
                         DL_FUNC fptr);
DL_FUNC R_GetCCallable(const char *package, const char *name);
</pre></td></tr></table>

<p>A package <strong>packA</strong> that wants to make a C routine <code>myCfun</code>
available to C code in other packages would include the call
</p>
<table><tr><td>&nbsp;</td><td><pre class="example">R_RegisterCCallable(&quot;packA&quot;, &quot;myCfun&quot;, myCfun);
</pre></td></tr></table>

<p>in its initialization function <code>R_init_packA</code>.  A package
<strong>packB</strong> that wants to use this routine would retrieve the function
pointer with a call of the form
</p>
<table><tr><td>&nbsp;</td><td><pre class="example">p_myCfun = R_GetCCallable(&quot;packA&quot;, &quot;myCfun&quot;);
</pre></td></tr></table>

<p>The author of <strong>packB</strong> is responsible for ensuring that
<code>p_myCfun</code> has an appropriate declaration. In the future R may
provide some automated tools to simplify exporting larger numbers of
routines.
</p>
<p>A package that wishes to make use of header files in other packages needs
to declare them as a comma-separated list in the field &lsquo;<samp>LinkingTo</samp>&rsquo;
in the &lsquo;<tt>DESCRIPTION</tt>&rsquo; file.  For example
</p>
<table><tr><td>&nbsp;</td><td><pre class="example">Depends: link2, link3
LinkingTo: link2, link3
</pre></td></tr></table>

<p>It must also &lsquo;Depends&rsquo; on those packages for they have to be installed
prior to this one, and loaded prior to this one (so the path to their
compiled code can be found).
</p>
<p>This then arranges that the &lsquo;<tt>include</tt>&rsquo; directories in the installed
linked-to packages are added to the include paths for C and C++ code.
</p>
<p>A <acronym>CRAN</acronym> example of the use of this mechanism is package
<a href="http://CRAN.R-project.org/package=lme4"><strong>lme4</strong></a>, which links to <a href="http://CRAN.R-project.org/package=Matrix"><strong>Matrix</strong></a>.
</p>
<hr size="6">
<a name="Creating-shared-objects"></a>
<table cellpadding="1" cellspacing="1" border="0">
<tr><td valign="middle" align="left">[<a href="#Linking-to-native-routines-in-other-packages" title="Previous section in reading order"> &lt; </a>]</td>
<td valign="middle" align="left">[<a href="#Interfacing-C_002b_002b-code" title="Next section in reading order"> &gt; </a>]</td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left">[<a href="#System-and-foreign-language-interfaces" title="Beginning of this chapter or previous chapter"> &lt;&lt; </a>]</td>
<td valign="middle" align="left">[<a href="#System-and-foreign-language-interfaces" title="Up section"> Up </a>]</td>
<td valign="middle" align="left">[<a href="#The-R-API" title="Next chapter"> &gt;&gt; </a>]</td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left">[<a href="#Top" title="Cover (top) of document">Top</a>]</td>
<td valign="middle" align="left">[<a href="#SEC_Contents" title="Table of contents">Contents</a>]</td>
<td valign="middle" align="left">[<a href="#Function-and-variable-index" title="Index">Index</a>]</td>
<td valign="middle" align="left">[<a href="#SEC_About" title="About (help)"> ? </a>]</td>
</tr></table>
<a name="Creating-shared-objects-1"></a>
<h2 class="section">5.5 Creating shared objects</h2>
<a name="index-Creating-shared-objects"></a>
<a name="index-R-CMD-SHLIB"></a>

<p>Shared objects for loading into R can be created using <code>R CMD
SHLIB</code>.  This accepts as arguments a list of files which must be object
files (with extension &lsquo;<tt>.o</tt>&rsquo;) or sources for C, C++, FORTRAN 77,
Fortran 9x, Objective C or Objective C++ (with extensions &lsquo;<tt>.c</tt>&rsquo;,
&lsquo;<tt>.cc</tt>&rsquo; or &lsquo;<tt>.cpp</tt>&rsquo;, &lsquo;<tt>.f</tt>&rsquo;, &lsquo;<tt>.f90</tt>&rsquo; or &lsquo;<tt>.f95</tt>&rsquo;,
&lsquo;<tt>.m</tt>&rsquo;, and &lsquo;<tt>.mm</tt>&rsquo; or &lsquo;<tt>.M</tt>&rsquo;, respectively), or commands to be
passed to the linker.  See <kbd>R CMD SHLIB --help</kbd> (or the R help
for <code>SHLIB</code>) for usage information.
</p>
<p>If compiling the source files does not work &ldquo;out of the box&rdquo;, you can
specify additional flags by setting some of the variables
<a name="index-PKG_005fCPPFLAGS"></a>
<code>PKG_CPPFLAGS</code> (for the C preprocessor, typically &lsquo;<samp>-I</samp>&rsquo; flags),
<a name="index-PKG_005fCFLAGS"></a>
<a name="index-PKG_005fCXXFLAGS"></a>
<a name="index-PKG_005fFFLAGS"></a>
<a name="index-PKG_005fFCFLAGS"></a>
<a name="index-PKG_005fOBJCFLAGS"></a>
<code>PKG_CFLAGS</code>, <code>PKG_CXXFLAGS</code>, <code>PKG_FFLAGS</code>,
<code>PKG_FCFLAGS</code>, and <code>PKG_OBJCFLAGS</code> (for the C, C++, FORTRAN
77, Fortran 9x, and Objective C compilers, respectively) in the file
&lsquo;<tt>Makevars</tt>&rsquo; in the compilation directory (or, of course, create the
object files directly from the command line).
<a name="index-PKG_005fLIBS"></a>
Similarly, variable <code>PKG_LIBS</code> in &lsquo;<tt>Makevars</tt>&rsquo; can be used for
additional &lsquo;<samp>-l</samp>&rsquo; and &lsquo;<samp>-L</samp>&rsquo; flags to be passed to the linker when
building the shared object. (Supplying linker commands as arguments to
<code>R CMD SHLIB</code> will take precedence over <code>PKG_LIBS</code> in
&lsquo;<tt>Makevars</tt>&rsquo;.)
</p>
<a name="index-OBJECTS-1"></a>
<p>It is possible to arrange to include compiled code from other languages
by setting the macro &lsquo;<samp>OBJECTS</samp>&rsquo; in file &lsquo;<tt>Makevars</tt>&rsquo;, together
with suitable rules to make the objects.
</p>
<p>Flags which are already set (for example in file
&lsquo;<tt>etc<var>R_ARCH</var>/Makeconf</tt>&rsquo;) can be overridden by the environment
variable <code>MAKEFLAGS</code> (at least for systems using a POSIX-compliant
<code>make</code>), as in (Bourne shell syntax)
</p>
<table><tr><td>&nbsp;</td><td><pre class="example">MAKEFLAGS=&quot;CFLAGS=-O3&quot; R CMD SHLIB *.c
</pre></td></tr></table>

<p>It is also possible to set such variables in personal &lsquo;<tt>Makevars</tt>&rsquo;
files, which are read after the local &lsquo;<tt>Makevars</tt>&rsquo; and the system
makefiles or in a site-wide &lsquo;<tt>Makevars.site</tt>&rsquo; file.
</p>

<p>Note that as <code>R CMD SHLIB</code> uses Make, it will not remake a shared
object just because the flags have changed, and if &lsquo;<tt>test.c</tt>&rsquo; and
&lsquo;<tt>test.f</tt>&rsquo; both exist in the current directory
</p>
<table><tr><td>&nbsp;</td><td><pre class="example">R CMD SHLIB test.f
</pre></td></tr></table>

<p>will compile &lsquo;<tt>test.c</tt>&rsquo;!
</p>

<p>If the &lsquo;<tt>src</tt>&rsquo; subdirectory of an add-on package contains source code
with one of the extensions listed above or a file &lsquo;<tt>Makevars</tt>&rsquo; but
<strong>not</strong> a file <code>Makefile</code>, <code>R CMD INSTALL</code> creates a
shared object (for loading into R through <code>useDynlib</code> in the
&lsquo;<tt>NAMESPACE</tt>&rsquo;, or in the <code>.onLoad</code> function of the package)
using the <code>R CMD SHLIB</code> mechanism.  If file &lsquo;<tt>Makevars</tt>&rsquo;
exists it is read first, then the system makefile and then any personal
&lsquo;<tt>Makevars</tt>&rsquo; files.
</p>
<p>If the &lsquo;<tt>src</tt>&rsquo; subdirectory of package contains a file
&lsquo;<tt>Makefile</tt>&rsquo;, this is used by <code>R CMD INSTALL</code> in place of the
<code>R CMD SHLIB</code> mechanism.  <code>make</code> is called with makefiles
&lsquo;<tt><var>R_HOME</var>/etc<var>R_ARCH</var>/Makeconf</tt>&rsquo;, &lsquo;<tt>src/Makefile</tt>&rsquo; and
any personal &lsquo;<tt>Makevars</tt>&rsquo; files (in that order).  The first target
found in &lsquo;<tt>src/Makefile</tt>&rsquo; is used.
</p>
<p>It is better to make use of a <code>Makevars</code> file rather than a
<code>Makefile</code>: the latter should be needed only exceptionally.
</p>

<p>Under Windows the same commands work, but &lsquo;<tt>Makevars.win</tt>&rsquo; will be
used in preference to &lsquo;<tt>Makevars</tt>&rsquo;, and only &lsquo;<tt>src/Makefile.win</tt>&rsquo;
will be used by <code>R CMD INSTALL</code> with &lsquo;<tt>src/Makefile</tt>&rsquo; being
ignored.  For past experiences of building DLLs with a variety of
compilers, see file &lsquo;<samp>README.packages</samp>&rsquo; and
<a href="http://www.stats.uwo.ca/faculty/murdoch/software/compilingDLLs/">http://www.stats.uwo.ca/faculty/murdoch/software/compilingDLLs/</a>
.  Under Windows you can supply an exports definitions file called
&lsquo;<tt><var>dllname</var>-win.def</tt>&rsquo;: otherwise all entry points in objects (but
not libraries) supplied to <code>R CMD SHLIB</code> will be exported from the
DLL.  An example is &lsquo;<tt>stats-win.def</tt>&rsquo; for the <strong>stats</strong> package: a
<acronym>CRAN</acronym> example in package <a href="http://CRAN.R-project.org/package=fastICA"><strong>fastICA</strong></a>.
</p>
<p>If you feel tempted to read the source code and subvert these
mechanisms, please resist.  Far too much developer time has been wasted
in chasing down errors caused by failures to follow this documentation,
and even more by package authors demanding explanations as to why their
packages not longer work.
In particular, undocumented environment or make variables are not for
use by package writers and are subject to change without notice.
</p>
<hr size="6">
<a name="Interfacing-C_002b_002b-code"></a>
<table cellpadding="1" cellspacing="1" border="0">
<tr><td valign="middle" align="left">[<a href="#Creating-shared-objects" title="Previous section in reading order"> &lt; </a>]</td>
<td valign="middle" align="left">[<a href="#Fortran-I_002fO" title="Next section in reading order"> &gt; </a>]</td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left">[<a href="#System-and-foreign-language-interfaces" title="Beginning of this chapter or previous chapter"> &lt;&lt; </a>]</td>
<td valign="middle" align="left">[<a href="#System-and-foreign-language-interfaces" title="Up section"> Up </a>]</td>
<td valign="middle" align="left">[<a href="#The-R-API" title="Next chapter"> &gt;&gt; </a>]</td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left">[<a href="#Top" title="Cover (top) of document">Top</a>]</td>
<td valign="middle" align="left">[<a href="#SEC_Contents" title="Table of contents">Contents</a>]</td>
<td valign="middle" align="left">[<a href="#Function-and-variable-index" title="Index">Index</a>]</td>
<td valign="middle" align="left">[<a href="#SEC_About" title="About (help)"> ? </a>]</td>
</tr></table>
<a name="Interfacing-C_002b_002b-code-1"></a>
<h2 class="section">5.6 Interfacing C++ code</h2>
<a name="index-Interfacing-C_002b_002b-code"></a>
<a name="index-C_002b_002b-code_002c-interfacing"></a>

<p>Suppose we have the following hypothetical C++ library, consisting of
the two files &lsquo;<tt>X.h</tt>&rsquo; and &lsquo;<tt>X.cpp</tt>&rsquo;, and implementing the two
classes <code>X</code> and <code>Y</code> which we want to use in R.
</p>
<blockquote><table class="cartouche" border="1"><tr><td>
<table><tr><td>&nbsp;</td><td><pre class="example">// X.h

class X {
public: X (); ~X ();
};

class Y {
public: Y (); ~Y ();
};
</pre></td></tr></table>
</td></tr></table>
</blockquote>

<blockquote><table class="cartouche" border="1"><tr><td>
<table><tr><td>&nbsp;</td><td><pre class="example">// X.cpp

#include &lt;R.h&gt;
#include &quot;X.h&quot;

static Y y;

X::X()  { REprintf(&quot;constructor X\n&quot;); }
X::~X() { REprintf(&quot;destructor X\n&quot;);  }
Y::Y()  { REprintf(&quot;constructor Y\n&quot;); }
Y::~Y() { REprintf(&quot;destructor Y\n&quot;);  }
</pre></td></tr></table>
</td></tr></table>
</blockquote>

<p>To use with R, the only thing we have to do is writing a wrapper
function and ensuring that the function is enclosed in
</p>
<table><tr><td>&nbsp;</td><td><pre class="example">extern &quot;C&quot; {

}
</pre></td></tr></table>

<p>For example,
</p>
<blockquote><table class="cartouche" border="1"><tr><td>
<table><tr><td>&nbsp;</td><td><pre class="example">// X_main.cpp:

#include &quot;X.h&quot;

extern &quot;C&quot; {

void X_main () {
  X x;
}

} // extern &quot;C&quot;
</pre></td></tr></table>
</td></tr></table>
</blockquote>

<p>Compiling and linking should be done with the C++ compiler-linker
(rather than the C compiler-linker or the linker itself); otherwise, the
C++ initialization code (and hence the constructor of the static
variable <code>Y</code>) are not called.  On a properly configured system, one
can simply use
</p>
<table><tr><td>&nbsp;</td><td><pre class="example">R CMD SHLIB X.cpp X_main.cpp
</pre></td></tr></table>

<p>to create the shared object, typically &lsquo;<tt>X.so</tt>&rsquo; (the file name
extension may be different on your platform).  Now starting R yields
</p>
<table><tr><td>&nbsp;</td><td><pre class="example">R version 2.14.1 Patched (2012-01-16 r58124)
Copyright (C) 2012 The R Foundation for Statistical Computing
...
Type    &quot;q()&quot; to quit R.
</pre><pre class="example">
</pre><pre class="example">R&gt; dyn.load(paste(&quot;X&quot;, .Platform$dynlib.ext, sep = &quot;&quot;))
constructor Y
R&gt; .C(&quot;X_main&quot;)
constructor X
destructor X
list()
R&gt; q()
Save workspace image? [y/n/c]: y
destructor Y
</pre></td></tr></table>

<p>The R for Windows <acronym>FAQ</acronym> (&lsquo;<tt>rw-FAQ</tt>&rsquo;) contains details of how
to compile this example under Windows.
</p>
<p>Earlier version of this example used C++ iostreams: this is best
avoided.  There is no guarantee that the output will appear in the R
console, and indeed it will not on the R for Windows console.  Use
R code or the C entry points (see section <a href="#Printing">Printing</a>) for all I/O if at all
possible.  Examples have been seen where merely loading a DLL that
contained calls to C++ I/O upset R&rsquo;s own C I/O (for example by
resetting buffers on open files).
</p>
<p>Most R header files can be included within C++ programs, and they
should <strong>not</strong> be included within an <code>extern &quot;C&quot;</code> block (as
they include C++ system headers).  It may not be possible to include
some R headers as they in turn include C header files that may cause
conflicts&mdash;if this happens, define &lsquo;<samp>NO_C_HEADERS</samp>&rsquo; before including
the R headers, and include C++ versions (such as &lsquo;<samp>cmath</samp>&rsquo;) of the
appropriate headers yourself before the R headers.
</p>
<hr size="6">
<a name="Fortran-I_002fO"></a>
<table cellpadding="1" cellspacing="1" border="0">
<tr><td valign="middle" align="left">[<a href="#Interfacing-C_002b_002b-code" title="Previous section in reading order"> &lt; </a>]</td>
<td valign="middle" align="left">[<a href="#Linking-to-other-packages" title="Next section in reading order"> &gt; </a>]</td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left">[<a href="#System-and-foreign-language-interfaces" title="Beginning of this chapter or previous chapter"> &lt;&lt; </a>]</td>
<td valign="middle" align="left">[<a href="#System-and-foreign-language-interfaces" title="Up section"> Up </a>]</td>
<td valign="middle" align="left">[<a href="#The-R-API" title="Next chapter"> &gt;&gt; </a>]</td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left">[<a href="#Top" title="Cover (top) of document">Top</a>]</td>
<td valign="middle" align="left">[<a href="#SEC_Contents" title="Table of contents">Contents</a>]</td>
<td valign="middle" align="left">[<a href="#Function-and-variable-index" title="Index">Index</a>]</td>
<td valign="middle" align="left">[<a href="#SEC_About" title="About (help)"> ? </a>]</td>
</tr></table>
<a name="Fortran-I_002fO-1"></a>
<h2 class="section">5.7 Fortran I/O</h2>

<p>We have already warned against the use of C++ iostreams not least
because output is not guaranteed to appear on the R console, and this
warning applies equally to Fortran (77 or 9x) output to units <code>*</code>
and <code>6</code>. See section <a href="#Printing-from-FORTRAN">Printing from FORTRAN</a>, which describes workarounds.
</p>
<p>In the past most Fortran compilers implemented I/O on top of the C I/O
system and so the two interworked successfully.  This was true of
<code>g77</code>, but it is less true of <code>gfortran</code> as used in
<code>gcc 4.y.z</code>.  In particular, any package that makes use of Fortran
I/O will when compiled on Windows interfere with C I/O: when the Fortran
I/O is initialized (typically when the package is loaded) the C
<code>stdout</code> and <code>stderr</code> are switched to LF line endings.
(Function <code>init</code> in file &lsquo;<tt>src/modules/lapack/init_win.c</tt>&rsquo; shows how to
mitigate this.)
</p>
<hr size="6">
<a name="Linking-to-other-packages"></a>
<table cellpadding="1" cellspacing="1" border="0">
<tr><td valign="middle" align="left">[<a href="#Fortran-I_002fO" title="Previous section in reading order"> &lt; </a>]</td>
<td valign="middle" align="left">[<a href="#Unix_002dalikes" title="Next section in reading order"> &gt; </a>]</td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left">[<a href="#System-and-foreign-language-interfaces" title="Beginning of this chapter or previous chapter"> &lt;&lt; </a>]</td>
<td valign="middle" align="left">[<a href="#System-and-foreign-language-interfaces" title="Up section"> Up </a>]</td>
<td valign="middle" align="left">[<a href="#The-R-API" title="Next chapter"> &gt;&gt; </a>]</td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left">[<a href="#Top" title="Cover (top) of document">Top</a>]</td>
<td valign="middle" align="left">[<a href="#SEC_Contents" title="Table of contents">Contents</a>]</td>
<td valign="middle" align="left">[<a href="#Function-and-variable-index" title="Index">Index</a>]</td>
<td valign="middle" align="left">[<a href="#SEC_About" title="About (help)"> ? </a>]</td>
</tr></table>
<a name="Linking-to-other-packages-1"></a>
<h2 class="section">5.8 Linking to other packages</h2>

<p>It is not in general possible to link a DLL in package <strong>packA</strong> to a
DLL provided by package <strong>packB</strong> (for the security reasons mentioned
in <a href="#dyn_002eload-and-dyn_002eunload"><code>dyn.load</code> and <code>dyn.unload</code></a>, and also because some platforms
distinguish between shared objects and dynamic libraries), but it is on
Windows.
</p>
<p>Note that there can be tricky versioning issues here, as package
<strong>packB</strong> could be re-installed after package <strong>packA</strong> &mdash; it is
desirable that the API provided by package <strong>packB</strong> remains
backwards-compatible.
</p>
<table class="menu" border="0" cellspacing="0">
<tr><td align="left" valign="top"><a href="#Unix_002dalikes">5.8.1 Unix-alikes</a></td><td>&nbsp;&nbsp;</td><td align="left" valign="top">                 
</td></tr>
<tr><td align="left" valign="top"><a href="#Windows">5.8.2 Windows</a></td><td>&nbsp;&nbsp;</td><td align="left" valign="top">                     
</td></tr>
</table>

<hr size="6">
<a name="Unix_002dalikes"></a>
<table cellpadding="1" cellspacing="1" border="0">
<tr><td valign="middle" align="left">[<a href="#Linking-to-other-packages" title="Previous section in reading order"> &lt; </a>]</td>
<td valign="middle" align="left">[<a href="#Windows" title="Next section in reading order"> &gt; </a>]</td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left">[<a href="#System-and-foreign-language-interfaces" title="Beginning of this chapter or previous chapter"> &lt;&lt; </a>]</td>
<td valign="middle" align="left">[<a href="#Linking-to-other-packages" title="Up section"> Up </a>]</td>
<td valign="middle" align="left">[<a href="#The-R-API" title="Next chapter"> &gt;&gt; </a>]</td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left">[<a href="#Top" title="Cover (top) of document">Top</a>]</td>
<td valign="middle" align="left">[<a href="#SEC_Contents" title="Table of contents">Contents</a>]</td>
<td valign="middle" align="left">[<a href="#Function-and-variable-index" title="Index">Index</a>]</td>
<td valign="middle" align="left">[<a href="#SEC_About" title="About (help)"> ? </a>]</td>
</tr></table>
<a name="Unix_002dalikes-1"></a>
<h3 class="subsection">5.8.1 Unix-alikes</h3>

<p>It is possible to link a shared object in package <strong>packA</strong> to a
library provided by package <strong>packB</strong> under limited circumstances
on a Unix-alike OS.  There are severe portability issues, so this is not
recommended for a distributed package.
</p>
<p>This is easiest if <strong>packB</strong> provides a static library
&lsquo;<tt>packB/libs/libpackB.a</tt>&rsquo;.  (This will need to be compiled with
<code>PIC</code> flags on platforms where it matters.)  Then as the code from
package <strong>packB</strong> is incorporated when package <strong>packA</strong> is
installed, we only need to find the static library at install time for
package <strong>packB</strong>.  The only issue is to find package <strong>packB</strong>, and
for that we can ask R by something like
</p>
<table><tr><td>&nbsp;</td><td><pre class="example">PKGB_PATH=`echo 'cat(system.file(&quot;libs&quot;, .Platform$r_arch, package=&quot;packB&quot;, mustWork=TRUE))' \
 | &quot;${R_HOME}/bin/R&quot; --vanilla --slave`
PKG_LIBS=&quot;$(PKGB_PATH)/libpackB.a&quot;
</pre></td></tr></table>

<p>which will give an empty path component if sub-architectures are not in
use (but that works on current platforms).
</p>
<p>For a dynamic library &lsquo;<tt>packB/libs/libpackB.so</tt>&rsquo;
(&lsquo;<tt>packB/libs/libpackB.dylib</tt>&rsquo; on Mac OS X) we could use
</p>
<table><tr><td>&nbsp;</td><td><pre class="example">PKGB_PATH=`echo 'cat(system.file(&quot;libs&quot;, .Platform$r_arch, package=&quot;packB&quot;, mustWork=TRUE))' \
 | &quot;${R_HOME}/bin/R&quot; --vanilla --slave`
PKG_LIBS=-L&quot;$(PKGB_PATH)&quot; -lpackB
</pre></td></tr></table>

<p>This will work for installation, but very likely not when package
<code>packB</code> is loaded, as the path to package <strong>packB</strong>&rsquo;s &lsquo;<tt>libs</tt>&rsquo;
directory is not in the <code>ld.so</code><a name="DOCF67" href="#FOOT67">(67)</a>  search path.  You can
arrange to put it there <strong>before</strong> R is launched by setting (on
some platforms) <code>LD_RUN_PATH</code> or <code>LD_LIBRARY_PATH</code> or adding to
the <code>ld.so</code> cache (see <code>man ldconfig</code>).  On platforms
that support it, the path to the dynamic library can be hardcoded at
install time (which assumes that the location of package <strong>packB</strong>
will not be changed) nor the package updated to a changed API).  On
systems with the <acronym>GNU</acronym>
linker (e.g. Linux) and some others (e.g. Mac OS X) this can be done
by
</p>
<table><tr><td>&nbsp;</td><td><pre class="example">PKGB_PATH=`echo 'library(packB); cat(system.file(&quot;libs&quot;, package=&quot;packB&quot;))' \
 | &quot;${R_HOME}/bin/R&quot; --vanilla --slave`
PKG_LIBS=-L&quot;$(PKGB_PATH)&quot; -rpath &quot;$(PKGB_PATH)&quot; -lpackB
</pre></td></tr></table>

<p>and on some other systems (e.g. Solaris with its native linker) use
<code>-R</code> rather than <code>-rpath</code>.
</p>
<p>It may be possible to figure out what is required semi-automatically
from the result of <code>R CMD libtool --config</code> (look for
&lsquo;<samp>hardcode</samp>&rsquo;).
</p>
<p>Making headers provided by package <strong>packB</strong> available to the code to
be compiled in package <strong>packA</strong> can be done by the <code>LinkingTo</code>
mechanism (see section <a href="#Registering-native-routines">Registering native routines</a>).
</p>

<hr size="6">
<a name="Windows"></a>
<table cellpadding="1" cellspacing="1" border="0">
<tr><td valign="middle" align="left">[<a href="#Unix_002dalikes" title="Previous section in reading order"> &lt; </a>]</td>
<td valign="middle" align="left">[<a href="#Handling-R-objects-in-C" title="Next section in reading order"> &gt; </a>]</td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left">[<a href="#System-and-foreign-language-interfaces" title="Beginning of this chapter or previous chapter"> &lt;&lt; </a>]</td>
<td valign="middle" align="left">[<a href="#Linking-to-other-packages" title="Up section"> Up </a>]</td>
<td valign="middle" align="left">[<a href="#The-R-API" title="Next chapter"> &gt;&gt; </a>]</td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left">[<a href="#Top" title="Cover (top) of document">Top</a>]</td>
<td valign="middle" align="left">[<a href="#SEC_Contents" title="Table of contents">Contents</a>]</td>
<td valign="middle" align="left">[<a href="#Function-and-variable-index" title="Index">Index</a>]</td>
<td valign="middle" align="left">[<a href="#SEC_About" title="About (help)"> ? </a>]</td>
</tr></table>
<a name="Windows-1"></a>
<h3 class="subsection">5.8.2 Windows</h3>

<p>Suppose package <strong>packA</strong> wants to make use of compiled code provided
by <strong>packB</strong> in DLL &lsquo;<tt>packB/libs/exB.dll</tt>&rsquo;, possibly the package&rsquo;s
DLL &lsquo;<tt>packB/libs/packB.dll</tt>&rsquo;.  (This can be extended to linking to
more than one package in a similar way.)  There are three issues to be
addressed:
</p>
<ul>
<li>
Making headers provided by package <strong>packB</strong> available to the code to
be compiled in package <strong>packA</strong>.

<p>This is done by the <code>LinkingTo</code> mechanism (see section <a href="#Registering-native-routines">Registering native routines</a>).
</p>
</li><li> preparing <code>packA.dll</code> to link to &lsquo;<tt>packB/libs/exB.dll</tt>&rsquo;.

<p>This needs an entry in &lsquo;<tt>Makevars.win</tt>&rsquo; of the form
</p>
<table><tr><td>&nbsp;</td><td><pre class="example">PKG_LIBS= -L&lt;something&gt; -lexB
</pre></td></tr></table>

<p>and one possibility is that <code>&lt;something&gt;</code> is the path to the
installed &lsquo;<tt>pkgB/libs</tt>&rsquo; directory.  To find that we need to ask R
where it is by something like
</p>
<table><tr><td>&nbsp;</td><td><pre class="example">PKGB_PATH=`echo 'library(packB); cat(system.file(&quot;libs&quot;, package=&quot;packB&quot;))' \
 | rterm --vanilla --slave`
PKG_LIBS= -L&quot;$(PKGB_PATH)&quot; -lexB
</pre></td></tr></table>

<p>Another possibility is to use an import library, shipping with package
<strong>packA</strong> an exports file &lsquo;<tt>exB.def</tt>&rsquo;.  Then &lsquo;<tt>Makevars.win</tt>&rsquo;
could contain
</p>
<table><tr><td>&nbsp;</td><td><pre class="example">PKG_LIBS= -L. -lexB

all: $(SHLIB) before

before: libexB.dll.a
libexB.dll.a: exB.def
</pre></td></tr></table>

<p>and then installing package <strong>packA</strong> will make and use the import
library for &lsquo;<tt>exB.dll</tt>&rsquo;.  (One way to prepare the exports file is to
use &lsquo;<tt>pexports.exe</tt>&rsquo;.)
</p>
</li><li> loading &lsquo;<tt>packA.dll</tt>&rsquo; which depends on &lsquo;<tt>exB.dll</tt>&rsquo;.

<p>If <code>exB.dll</code> was used by package <strong>packB</strong> (because it is in fact
&lsquo;<tt>packB.dll</tt>&rsquo; or &lsquo;<tt>packB.dll</tt>&rsquo; depends on it) and <strong>packB</strong> has
been loaded before <strong>packA</strong>, then nothing more needs to be done as
&lsquo;<tt>exB.dll</tt>&rsquo; will already be loaded into the R executable.  (This
is the most common scenario).
</p>
<p>More generally, we can use the <code>DLLpath</code> argument to
<code>library.dynam</code> to ensure that <code>exB.dll</code> is found, for example
by setting
</p>
<table><tr><td>&nbsp;</td><td><pre class="example">library.dynam(&quot;packA&quot;, pkg, lib,
              DLLpath = system.file(&quot;libs&quot;, package=&quot;packB&quot;))
</pre></td></tr></table>

<p>Note that <code>DLLpath</code> can only set one path, and so for linking to
two or more packages you would need to resort to setting <code>PATH</code>.
</p>
</li></ul>

<hr size="6">
<a name="Handling-R-objects-in-C"></a>
<table cellpadding="1" cellspacing="1" border="0">
<tr><td valign="middle" align="left">[<a href="#Windows" title="Previous section in reading order"> &lt; </a>]</td>
<td valign="middle" align="left">[<a href="#Garbage-Collection" title="Next section in reading order"> &gt; </a>]</td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left">[<a href="#System-and-foreign-language-interfaces" title="Beginning of this chapter or previous chapter"> &lt;&lt; </a>]</td>
<td valign="middle" align="left">[<a href="#System-and-foreign-language-interfaces" title="Up section"> Up </a>]</td>
<td valign="middle" align="left">[<a href="#The-R-API" title="Next chapter"> &gt;&gt; </a>]</td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left">[<a href="#Top" title="Cover (top) of document">Top</a>]</td>
<td valign="middle" align="left">[<a href="#SEC_Contents" title="Table of contents">Contents</a>]</td>
<td valign="middle" align="left">[<a href="#Function-and-variable-index" title="Index">Index</a>]</td>
<td valign="middle" align="left">[<a href="#SEC_About" title="About (help)"> ? </a>]</td>
</tr></table>
<a name="Handling-R-objects-in-C-1"></a>
<h2 class="section">5.9 Handling R objects in C</h2>
<a name="index-Handling-R-objects-in-C"></a>

<p>Using C code to speed up the execution of an R function is often very
fruitful.  Traditionally this has been done <em>via</em> the <code>.C</code>
function in R.  However, if a user wants to write C code using
internal R data structures, then that can be done using the
<code>.Call</code> and <code>.External</code> functions.  The syntax for the calling
function in R in each case is similar to that of <code>.C</code>, but the
two functions have different C interfaces.  Generally the <code>.Call</code>
interface (which is modelled on the interface of the same name in S
version 4) is a little simpler to use, but <code>.External</code> is a little
more general.
<a name="index-_002eCall"></a>
<a name="index-_002eExternal"></a>
</p>
<p>A call to <code>.Call</code> is very similar to <code>.C</code>, for example
</p>
<table><tr><td>&nbsp;</td><td><pre class="example">.Call(&quot;convolve2&quot;, a, b)
</pre></td></tr></table>

<p>The first argument should be a character string giving a C symbol name
of code that has already been loaded into R.  Up to 65 R objects
can passed as arguments.  The C side of the interface is
</p>
<table><tr><td>&nbsp;</td><td><pre class="example">#include &lt;R.h&gt;
#include &lt;Rinternals.h&gt;

SEXP convolve2(SEXP a, SEXP b)
 ...
</pre></td></tr></table>

<p>A call to <code>.External</code> is almost identical
</p>
<table><tr><td>&nbsp;</td><td><pre class="example">.External(&quot;convolveE&quot;, a, b)
</pre></td></tr></table>

<p>but the C side of the interface is different, having only one argument
</p>
<table><tr><td>&nbsp;</td><td><pre class="example">#include &lt;R.h&gt;
#include &lt;Rinternals.h&gt;

SEXP convolveE(SEXP args)
 ...
</pre></td></tr></table>

<p>Here <code>args</code> is a <code>LISTSXP</code>, a Lisp-style pairlist from which
the arguments can be extracted.
</p>
<p>In each case the R objects are available for manipulation <em>via</em> a set
of functions and macros defined in the header file &lsquo;<tt>Rinternals.h</tt>&rsquo;
or some S4-compatibility macros defined in &lsquo;<tt>Rdefines.h</tt>&rsquo;.  See
<a href="#Interface-functions-_002eCall-and-_002eExternal">Interface functions <code>.Call</code> and <code>.External</code></a> for details on
<code>.Call</code> and <code>.External</code>.
</p>
<p>Before you decide to use <code>.Call</code> or <code>.External</code>, you should
look at other alternatives.  First, consider working in interpreted R
code; if this is fast enough, this is normally the best option.  You
should also see if using <code>.C</code> is enough.  If the task to be
performed in C is simple enough involving only atomic vectors and
requiring no call to R, <code>.C</code> suffices.  The new interfaces are
relatively recent additions to S and R, and a great deal of
useful code has been written using just <code>.C</code> before they were
available.  The <code>.Call</code> and <code>.External</code> interfaces allow much
more control, but they also impose much greater responsibilities so need
to be used with care.  Neither <code>.Call</code> nor <code>.External</code> copy
their arguments: you should treat arguments you receive through these
interfaces as read-only.
</p>
<p>There are two approaches that can be taken to handling R objects from
within C code.  The first (historically) is to use the macros and
functions that have been used to implement the core parts of R
through <code>.Internal</code> calls.  A public<a name="DOCF68" href="#FOOT68">(68)</a>  subset of these is
defined in the header file &lsquo;<tt>Rinternals.h</tt>&rsquo; in the directory
&lsquo;<tt><var>R_INCLUDE_DIR</var></tt>&rsquo; (default &lsquo;<tt><var>R_HOME</var>/include</tt>&rsquo;) that
should be available on any R installation.
</p>
<p>Another approach is to use R versions of the macros and functions
defined for the S version 4 interface <code>.Call</code>, which are
defined in the header file &lsquo;<tt>Rdefines.h</tt>&rsquo;.  This is a somewhat
simpler approach, and is to be preferred if the code is intended to be
shared with S.  However, it is less well documented and even less
tested.  Note too that some idiomatic S4 constructions with these macros
(such as assigning elements of character vectors or lists) are invalid
in R.
</p>
<p>A substantial amount of R is implemented using the functions and
macros described here, so the R source code provides a rich source of
examples and &ldquo;how to do it&rdquo;: do make use of the source code for
inspirational examples.
</p>
<p>It is necessary to know something about how R objects are handled in
C code.  All the R objects you will deal with will be handled with
the type <em>SEXP</em><a name="DOCF69" href="#FOOT69">(69)</a>, which is a
pointer to a structure with typedef <code>SEXPREC</code>.  Think of this
structure as a <em>variant type</em> that can handle all the usual types
of R objects, that is vectors of various modes, functions,
environments, language objects and so on.  The details are given later
in this section and in <a href="R-ints.html#R-Internal-Structures">(R-ints)R Internal Structures</a> section &lsquo;R Internal Structures&rsquo; in <cite>R Internals</cite>, but for most
purposes the programmer does not need to know them.  Think rather of a
model such as that used by Visual Basic, in which R objects are
handed around in C code (as they are in interpreted R code) as the
variant type, and the appropriate part is extracted for, for example,
numerical calculations, only when it is needed.  As in interpreted R
code, much use is made of coercion to force the variant object to the
right type.
</p>
<table class="menu" border="0" cellspacing="0">
<tr><td align="left" valign="top"><a href="#Garbage-Collection">5.9.1 Handling the effects of garbage collection</a></td><td>&nbsp;&nbsp;</td><td align="left" valign="top">          
</td></tr>
<tr><td align="left" valign="top"><a href="#Allocating-storage">5.9.2 Allocating storage</a></td><td>&nbsp;&nbsp;</td><td align="left" valign="top">          
</td></tr>
<tr><td align="left" valign="top"><a href="#Details-of-R-types">5.9.3 Details of R types</a></td><td>&nbsp;&nbsp;</td><td align="left" valign="top">          
</td></tr>
<tr><td align="left" valign="top"><a href="#Attributes">5.9.4 Attributes</a></td><td>&nbsp;&nbsp;</td><td align="left" valign="top">                  
</td></tr>
<tr><td align="left" valign="top"><a href="#Classes">5.9.5 Classes</a></td><td>&nbsp;&nbsp;</td><td align="left" valign="top">                     
</td></tr>
<tr><td align="left" valign="top"><a href="#Handling-lists">5.9.6 Handling lists</a></td><td>&nbsp;&nbsp;</td><td align="left" valign="top">              
</td></tr>
<tr><td align="left" valign="top"><a href="#Handling-character-data">5.9.7 Handling character data</a></td><td>&nbsp;&nbsp;</td><td align="left" valign="top">     
</td></tr>
<tr><td align="left" valign="top"><a href="#Finding-and-setting-variables">5.9.8 Finding and setting variables</a></td><td>&nbsp;&nbsp;</td><td align="left" valign="top">  
</td></tr>
<tr><td align="left" valign="top"><a href="#Some-convenience-functions">5.9.9 Some convenience functions</a></td><td>&nbsp;&nbsp;</td><td align="left" valign="top">  
</td></tr>
<tr><td align="left" valign="top"><a href="#Named-objects-and-copying">5.9.10 Named objects and copying</a></td><td>&nbsp;&nbsp;</td><td align="left" valign="top">   
</td></tr>
</table>

<hr size="6">
<a name="Garbage-Collection"></a>
<table cellpadding="1" cellspacing="1" border="0">
<tr><td valign="middle" align="left">[<a href="#Handling-R-objects-in-C" title="Previous section in reading order"> &lt; </a>]</td>
<td valign="middle" align="left">[<a href="#Allocating-storage" title="Next section in reading order"> &gt; </a>]</td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left">[<a href="#System-and-foreign-language-interfaces" title="Beginning of this chapter or previous chapter"> &lt;&lt; </a>]</td>
<td valign="middle" align="left">[<a href="#Handling-R-objects-in-C" title="Up section"> Up </a>]</td>
<td valign="middle" align="left">[<a href="#The-R-API" title="Next chapter"> &gt;&gt; </a>]</td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left">[<a href="#Top" title="Cover (top) of document">Top</a>]</td>
<td valign="middle" align="left">[<a href="#SEC_Contents" title="Table of contents">Contents</a>]</td>
<td valign="middle" align="left">[<a href="#Function-and-variable-index" title="Index">Index</a>]</td>
<td valign="middle" align="left">[<a href="#SEC_About" title="About (help)"> ? </a>]</td>
</tr></table>
<a name="Handling-the-effects-of-garbage-collection"></a>
<h3 class="subsection">5.9.1 Handling the effects of garbage collection</h3>
<a name="index-Garbage-collection"></a>

<a name="index-PROTECT"></a>
<a name="index-UNPROTECT"></a>

<p>We need to know a little about the way R handles memory allocation.
The memory allocated for R objects is not freed by the user; instead,
the memory is from time to time <em>garbage collected</em>.  That is, some
or all of the allocated memory not being used is freed or marked as
re-usable.
</p>
<p>The R object types are represented by a C structure defined by a
typedef <code>SEXPREC</code> in &lsquo;<tt>Rinternals.h</tt>&rsquo;.  It contains several
things among which are pointers to data blocks and to other
<code>SEXPREC</code>s.  A <code>SEXP</code> is simply a pointer to a <code>SEXPREC</code>.
</p>
<p>If you create an R object in your C code, you must tell R that you
are using the object by using the <code>PROTECT</code> macro on a pointer to
the object. This tells R that the object is in use so it is not
destroyed during garbage collection.  Notice that it is the object which
is protected, not the pointer variable.  It is a common mistake to
believe that if you invoked <code>PROTECT(<var>p</var>)</code> at some point then
<var>p</var> is protected from then on, but that is not true once a new
object is assigned to <var>p</var>.
</p>
<p>Protecting an R object automatically protects all the R objects
pointed to in the corresponding <code>SEXPREC</code>, for example all elements
of a protected list are automatically protected.
</p>
<p>The programmer is solely responsible for housekeeping the calls to
<code>PROTECT</code>.  There is a corresponding macro <code>UNPROTECT</code> that
takes as argument an <code>int</code> giving the number of objects to
unprotect when they are no longer needed.  The protection mechanism is
stack-based, so <code>UNPROTECT(<var>n</var>)</code> unprotects the last <var>n</var>
objects which were protected.  The calls to <code>PROTECT</code> and
<code>UNPROTECT</code> must balance when the user&rsquo;s code returns.  R will
warn about <code>&quot;stack imbalance in .Call&quot;</code> (or <code>.External</code>) if
the housekeeping is wrong.
</p>
<p>Here is a small example of creating an R numeric vector in C code.
First we use the macros in &lsquo;<tt>Rinternals.h</tt>&rsquo;:
</p>
<table><tr><td>&nbsp;</td><td><pre class="example">#include &lt;R.h&gt;
#include &lt;Rinternals.h&gt;

    SEXP ab;
      ....
    PROTECT(ab = allocVector(REALSXP, 2));
    REAL(ab)[0] = 123.45;
    REAL(ab)[1] = 67.89;
    UNPROTECT(1);
</pre></td></tr></table>

<p>and then those in &lsquo;<tt>Rdefines.h</tt>&rsquo;:
</p>
<table><tr><td>&nbsp;</td><td><pre class="example">#include &lt;R.h&gt;
#include &lt;Rdefines.h&gt;

    SEXP ab;
      ....
    PROTECT(ab = NEW_NUMERIC(2));
    NUMERIC_POINTER(ab)[0] = 123.45;
    NUMERIC_POINTER(ab)[1] = 67.89;
    UNPROTECT(1);
</pre></td></tr></table>

<p>Now, the reader may ask how the R object could possibly get removed
during those manipulations, as it is just our C code that is running.
As it happens, we can do without the protection in this example, but in
general we do not know (nor want to know) what is hiding behind the R
macros and functions we use, and any of them might cause memory to be
allocated, hence garbage collection and hence our object <code>ab</code> to be
removed. It is usually wise to err on the side of caution and assume
that any of the R macros and functions might remove the object.
</p>
<p>In some cases it is necessary to keep better track of whether protection
is really needed.  Be particularly aware of situations where a large
number of objects are generated.  The pointer protection stack has a
fixed size (default 10,000) and can become full.  It is not a good idea
then to just <code>PROTECT</code> everything in sight and <code>UNPROTECT</code>
several thousand objects at the end. It will almost invariably be
possible to either assign the objects as part of another object (which
automatically protects them) or unprotect them immediately after use.
</p>
<p>Protection is not needed for objects which R already knows are in
use.  In particular, this applies to function arguments.
</p>
<p>There is a less-used macro <code>UNPROTECT_PTR(<var>s</var>)</code> that unprotects
the object pointed to by the <code>SEXP</code> <var>s</var>, even if it is not the
top item on the pointer protection stack. This is rarely needed outside
the parser (the R sources currently have three examples, one in
&lsquo;<tt>src/main/plot3d.c</tt>&rsquo;).
<a name="index-UNPROTECT_005fPTR"></a>
</p>
<p>Sometimes an object is changed (for example duplicated, coerced or
grown) yet the current value needs to be protected.  For these cases
<code>PROTECT_WITH_INDEX</code> saves an index of the protection location that
can be used to replace the protected value using <code>REPROTECT</code>.
<a name="index-PROTECT_005fWITH_005fINDEX"></a>
<a name="index-REPROTECT"></a>
For example (from the internal code for <code>optim</code>)
</p>
<table><tr><td>&nbsp;</td><td><pre class="example">    PROTECT_INDEX ipx;

    ....
    PROTECT_WITH_INDEX(s = eval(OS-&gt;R_fcall, OS-&gt;R_env), &amp;ipx);
    REPROTECT(s = coerceVector(s, REALSXP), ipx);
</pre></td></tr></table>

<p>Note that it is dangerous to mix <code>UNPROTECT_PTR</code> with
<code>PROTECT_WITH_INDEX</code>, as the former changes the protection
locations of objects that were protected after the one being
unprotected.
</p>
<hr size="6">
<a name="Allocating-storage"></a>
<table cellpadding="1" cellspacing="1" border="0">
<tr><td valign="middle" align="left">[<a href="#Garbage-Collection" title="Previous section in reading order"> &lt; </a>]</td>
<td valign="middle" align="left">[<a href="#Details-of-R-types" title="Next section in reading order"> &gt; </a>]</td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left">[<a href="#System-and-foreign-language-interfaces" title="Beginning of this chapter or previous chapter"> &lt;&lt; </a>]</td>
<td valign="middle" align="left">[<a href="#Handling-R-objects-in-C" title="Up section"> Up </a>]</td>
<td valign="middle" align="left">[<a href="#The-R-API" title="Next chapter"> &gt;&gt; </a>]</td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left">[<a href="#Top" title="Cover (top) of document">Top</a>]</td>
<td valign="middle" align="left">[<a href="#SEC_Contents" title="Table of contents">Contents</a>]</td>
<td valign="middle" align="left">[<a href="#Function-and-variable-index" title="Index">Index</a>]</td>
<td valign="middle" align="left">[<a href="#SEC_About" title="About (help)"> ? </a>]</td>
</tr></table>
<a name="Allocating-storage-1"></a>
<h3 class="subsection">5.9.2 Allocating storage</h3>
<a name="index-Allocating-storage"></a>

<p>For many purposes it is sufficient to allocate R objects and
manipulate those.  There are quite a few <code>alloc<var>Xxx</var></code> functions
defined in &lsquo;<tt>Rinternals.h</tt>&rsquo;&mdash;you may want to explore them.  These
allocate R objects of various types, and for the standard vector
types there are equivalent <code>NEW_<var>XXX</var></code> macros defined in
&lsquo;<tt>Rdefines.h</tt>&rsquo;.
</p>
<p>If storage is required for C objects during the calculations this is
best allocating by calling <code>R_alloc</code>; see section <a href="#Memory-allocation">Memory allocation</a>.
All of these memory allocation routines do their own error-checking, so
the programmer may assume that they will raise an error and not return
if the memory cannot be allocated.
</p>
<hr size="6">
<a name="Details-of-R-types"></a>
<table cellpadding="1" cellspacing="1" border="0">
<tr><td valign="middle" align="left">[<a href="#Allocating-storage" title="Previous section in reading order"> &lt; </a>]</td>
<td valign="middle" align="left">[<a href="#Attributes" title="Next section in reading order"> &gt; </a>]</td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left">[<a href="#System-and-foreign-language-interfaces" title="Beginning of this chapter or previous chapter"> &lt;&lt; </a>]</td>
<td valign="middle" align="left">[<a href="#Handling-R-objects-in-C" title="Up section"> Up </a>]</td>
<td valign="middle" align="left">[<a href="#The-R-API" title="Next chapter"> &gt;&gt; </a>]</td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left">[<a href="#Top" title="Cover (top) of document">Top</a>]</td>
<td valign="middle" align="left">[<a href="#SEC_Contents" title="Table of contents">Contents</a>]</td>
<td valign="middle" align="left">[<a href="#Function-and-variable-index" title="Index">Index</a>]</td>
<td valign="middle" align="left">[<a href="#SEC_About" title="About (help)"> ? </a>]</td>
</tr></table>
<a name="Details-of-R-types-1"></a>
<h3 class="subsection">5.9.3 Details of R types</h3>
<a name="index-Details-of-R-types"></a>

<p>Users of the &lsquo;<tt>Rinternals.h</tt>&rsquo; macros will need to know how the R
types are known internally: if the &lsquo;<tt>Rdefines.h</tt>&rsquo; macros are used
then S4-compatible names are used.
</p>
<p>The different R data types are represented in C by <em>SEXPTYPE</em>.
Some of these are familiar from R and some are internal data types.
The usual R object modes are given in the table.
</p>
<blockquote><table>
<thead><tr><th>SEXPTYPE</th><th>R equivalent</th></tr></thead>
<tr><td><code>REALSXP</code></td><td>numeric with storage mode <code>double</code></td></tr>
<tr><td><code>INTSXP</code></td><td>integer</td></tr>
<tr><td><code>CPLXSXP</code></td><td>complex</td></tr>
<tr><td><code>LGLSXP</code></td><td>logical</td></tr>
<tr><td><code>STRSXP</code></td><td>character</td></tr>
<tr><td><code>VECSXP</code></td><td>list (generic vector)</td></tr>
<tr><td><code>LISTSXP</code></td><td>pairlist</td></tr>
<tr><td><code>DOTSXP</code></td><td>a &lsquo;<samp>&hellip;</samp>&rsquo; object</td></tr>
<tr><td><code>NILSXP</code></td><td>NULL</td></tr>
<tr><td><code>SYMSXP</code></td><td>name/symbol</td></tr>
<tr><td><code>CLOSXP</code></td><td>function or function closure</td></tr>
<tr><td><code>ENVSXP</code></td><td>environment</td></tr>
</table>
</blockquote>

<p>Among the important internal <code>SEXPTYPE</code>s are <code>LANGSXP</code>,
<code>CHARSXP</code>, <code>PROMSXP</code>, etc.  (<strong>Note</strong>: although it is
possible to return objects of internal types, it is unsafe to do so as
assumptions are made about how they are handled which may be violated at
user-level evaluation.)  More details are given in <a href="R-ints.html#R-Internal-Structures">(R-ints)R Internal Structures</a> section &lsquo;R Internal Structures&rsquo; in <cite>R Internals</cite>.
</p>
<p>Unless you are very sure about the type of the arguments, the code
should check the data types.  Sometimes it may also be necessary to
check data types of objects created by evaluating an R expression in
the C code.  You can use functions like <code>isReal</code>, <code>isInteger</code>
and <code>isString</code> to do type checking.  See the header file
&lsquo;<tt>Rinternals.h</tt>&rsquo; for definitions of other such functions.  All of
these take a <code>SEXP</code> as argument and return 1 or 0 to indicate
<var>TRUE</var> or <var>FALSE</var>.  Once again there are two ways to do this,
and &lsquo;<tt>Rdefines.h</tt>&rsquo; has macros such as <code>IS_NUMERIC</code>.
</p>
<p>What happens if the <code>SEXP</code> is not of the correct type?  Sometimes
you have no other option except to generate an error.  You can use the
function <code>error</code> for this.  It is usually better to coerce the
object to the correct type.  For example, if you find that an
<code>SEXP</code> is of the type <code>INTEGER</code>, but you need a <code>REAL</code>
object, you can change the type by using, equivalently,
</p>
<table><tr><td>&nbsp;</td><td><pre class="example">PROTECT(<var>newSexp</var> = coerceVector(<var>oldSexp</var>, REALSXP));
</pre></td></tr></table>

<p>or
</p>
<table><tr><td>&nbsp;</td><td><pre class="example">PROTECT(<var>newSexp</var> = AS_NUMERIC(<var>oldSexp</var>));
</pre></td></tr></table>

<p>Protection is needed as a new <em>object</em> is created; the object
formerly pointed to by the <code>SEXP</code> is still protected but now
unused.
</p>
<p>All the coercion functions do their own error-checking, and generate
<code>NA</code>s with a warning or stop with an error as appropriate.
</p>
<p>Note that these coercion functions are <em>not</em> the same as calling
<code>as.numeric</code> (and so on) in R code, as they do not dispatch on
the class of the object.  Thus it is normally preferable to do the
coercion in the calling R code.
</p>
<p>So far we have only seen how to create and coerce R objects from C
code, and how to extract the numeric data from numeric R vectors.
These can suffice to take us a long way in interfacing R objects to
numerical algorithms, but we may need to know a little more to create
useful return objects.
</p>
<hr size="6">
<a name="Attributes"></a>
<table cellpadding="1" cellspacing="1" border="0">
<tr><td valign="middle" align="left">[<a href="#Details-of-R-types" title="Previous section in reading order"> &lt; </a>]</td>
<td valign="middle" align="left">[<a href="#Classes" title="Next section in reading order"> &gt; </a>]</td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left">[<a href="#System-and-foreign-language-interfaces" title="Beginning of this chapter or previous chapter"> &lt;&lt; </a>]</td>
<td valign="middle" align="left">[<a href="#Handling-R-objects-in-C" title="Up section"> Up </a>]</td>
<td valign="middle" align="left">[<a href="#The-R-API" title="Next chapter"> &gt;&gt; </a>]</td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left">[<a href="#Top" title="Cover (top) of document">Top</a>]</td>
<td valign="middle" align="left">[<a href="#SEC_Contents" title="Table of contents">Contents</a>]</td>
<td valign="middle" align="left">[<a href="#Function-and-variable-index" title="Index">Index</a>]</td>
<td valign="middle" align="left">[<a href="#SEC_About" title="About (help)"> ? </a>]</td>
</tr></table>
<a name="Attributes-1"></a>
<h3 class="subsection">5.9.4 Attributes</h3>
<a name="index-Attributes"></a>

<p>Many R objects have attributes: some of the most useful are classes
and the <code>dim</code> and <code>dimnames</code> that mark objects as matrices or
arrays.  It can also be helpful to work with the <code>names</code> attribute
of vectors.
</p>
<p>To illustrate this, let us write code to take the outer product of two
vectors (which <code>outer</code> and <code>%o%</code> already do).  As usual the
R code is simple
</p>
<table><tr><td>&nbsp;</td><td><pre class="example">out &lt;- function(x, y)
{
    storage.mode(x) &lt;- storage.mode(y) &lt;- &quot;double&quot;
    .Call(&quot;out&quot;, x, y)
}
</pre></td></tr></table>

<p>where we expect <code>x</code> and <code>y</code> to be numeric vectors (possibly
integer), possibly with names.  This time we do the coercion in the
calling R code.
</p>
<p>C code to do the computations is
</p>
<table><tr><td>&nbsp;</td><td><pre class="example">#include &lt;R.h&gt;
#include &lt;Rinternals.h&gt;

SEXP out(SEXP x, SEXP y)
{
    int i, j, nx = length(x), ny = length(y);
    double tmp, *rx = REAL(x), *ry = REAL(y), *rans;
    SEXP ans;

    PROTECT(ans = allocMatrix(REALSXP, nx, ny));
    rans = REAL(ans);
    for(i = 0; i &lt; nx; i++) {
        tmp = rx[i];
        for(j = 0; j &lt; ny; j++)
            rans[i + nx*j] = tmp * ry[j];
    }
    UNPROTECT(1);
    return(ans);
}
</pre></td></tr></table>

<p>Note the way <code>REAL</code> is used: as it is a function call it can be
considerably faster to store the result and index that.
</p>
<p>However, we would like to set the <code>dimnames</code> of the result.
Although <code>allocMatrix</code> provides a short cut, we will show how to
set the <code>dim</code> attribute directly.
</p>
<table><tr><td>&nbsp;</td><td><pre class="example">#include &lt;R.h&gt;
#include &lt;Rinternals.h&gt;

</pre><pre class="example">SEXP out(SEXP x, SEXP y)
{
    int i, j, nx = length(x), ny = length(y);
    double tmp, *rx = REAL(x), *ry = REAL(y), *rans;
    SEXP ans, dim, dimnames;
</pre><pre class="example">
</pre><pre class="example">    PROTECT(ans = allocVector(REALSXP, nx*ny));
    rans = REAL(ans);
    for(i = 0; i &lt; nx; i++) {
    tmp = rx[i];
    for(j = 0; j &lt; ny; j++)
         rans[i + nx*j] = tmp * ry[j];
    }
</pre><pre class="example">
</pre><pre class="example">    PROTECT(dim = allocVector(INTSXP, 2));
    INTEGER(dim)[0] = nx; INTEGER(dim)[1] = ny;
    setAttrib(ans, R_DimSymbol, dim);
</pre><pre class="example">
</pre><pre class="example">    PROTECT(dimnames = allocVector(VECSXP, 2));
    SET_VECTOR_ELT(dimnames, 0, getAttrib(x, R_NamesSymbol));
    SET_VECTOR_ELT(dimnames, 1, getAttrib(y, R_NamesSymbol));
    setAttrib(ans, R_DimNamesSymbol, dimnames);
</pre><pre class="example">
</pre><pre class="example">    UNPROTECT(3);
    return(ans);
}
</pre></td></tr></table>

<p>This example introduces several new features.  The <code>getAttrib</code> and
<code>setAttrib</code>
<a name="index-getAttrib"></a>
<a name="index-setAttrib"></a>
functions get and set individual attributes.  Their second argument is a
<code>SEXP</code> defining the name in the symbol table of the attribute we
want; these and many such symbols are defined in the header file
&lsquo;<tt>Rinternals.h</tt>&rsquo;.
</p>
<p>There are shortcuts here too: the functions <code>namesgets</code>,
<code>dimgets</code> and <code>dimnamesgets</code> are the internal versions of the
default methods of <code>names&lt;-</code>, <code>dim&lt;-</code> and <code>dimnames&lt;-</code>
(for vectors and arrays), and there are functions such as
<code>GetMatrixDimnames</code> and <code>GetArrayDimnames</code>.
</p>
<p>What happens if we want to add an attribute that is not pre-defined? We
need to add a symbol for it <em>via</em> a call to
<a name="index-install"></a>
<code>install</code>.  Suppose for illustration we wanted to add an attribute
<code>&quot;version&quot;</code> with value <code>3.0</code>.  We could use
</p>
<table><tr><td>&nbsp;</td><td><pre class="example">    SEXP version;
    PROTECT(version = allocVector(REALSXP, 1));
    REAL(version)[0] = 3.0;
    setAttrib(ans, install(&quot;version&quot;), version);
    UNPROTECT(1);
</pre></td></tr></table>

<p>Using <code>install</code> when it is not needed is harmless and provides a
simple way to retrieve the symbol from the symbol table if it is already
installed. However, the lookup takes a non-trivial amount of time, so
consider code such as
</p>
<table><tr><td>&nbsp;</td><td><pre class="example">static SEXP VerSymbol = NULL;
...
    if (VerSymbol == NULL) VerSymbol = install(&quot;version&quot;);
</pre></td></tr></table>

<p>if it is to be done frequently.
</p>
<hr size="6">
<a name="Classes"></a>
<table cellpadding="1" cellspacing="1" border="0">
<tr><td valign="middle" align="left">[<a href="#Attributes" title="Previous section in reading order"> &lt; </a>]</td>
<td valign="middle" align="left">[<a href="#Handling-lists" title="Next section in reading order"> &gt; </a>]</td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left">[<a href="#System-and-foreign-language-interfaces" title="Beginning of this chapter or previous chapter"> &lt;&lt; </a>]</td>
<td valign="middle" align="left">[<a href="#Handling-R-objects-in-C" title="Up section"> Up </a>]</td>
<td valign="middle" align="left">[<a href="#The-R-API" title="Next chapter"> &gt;&gt; </a>]</td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left">[<a href="#Top" title="Cover (top) of document">Top</a>]</td>
<td valign="middle" align="left">[<a href="#SEC_Contents" title="Table of contents">Contents</a>]</td>
<td valign="middle" align="left">[<a href="#Function-and-variable-index" title="Index">Index</a>]</td>
<td valign="middle" align="left">[<a href="#SEC_About" title="About (help)"> ? </a>]</td>
</tr></table>
<a name="Classes-1"></a>
<h3 class="subsection">5.9.5 Classes</h3>
<a name="index-Classes"></a>

<p>In R the class is just the attribute named <code>&quot;class&quot;</code> so it can
be handled as such, but there is a shortcut <code>classgets</code>.  Suppose
we want to give the return value in our example the class <code>&quot;mat&quot;</code>.
We can use
</p>
<table><tr><td>&nbsp;</td><td><pre class="example">#include &lt;R.h&gt;
#include &lt;Rdefines.h&gt;
      ....
    SEXP ans, dim, dimnames, class;
      ....
    PROTECT(class = allocVector(STRSXP, 1));
    SET_STRING_ELT(class, 0, mkChar(&quot;mat&quot;));
    classgets(ans, class);
    UNPROTECT(4);
    return(ans);
}
</pre></td></tr></table>

<p>As the value is a character vector, we have to know how to create that
from a C character array, which we do using the function
<code>mkChar</code>.
</p>
<hr size="6">
<a name="Handling-lists"></a>
<table cellpadding="1" cellspacing="1" border="0">
<tr><td valign="middle" align="left">[<a href="#Classes" title="Previous section in reading order"> &lt; </a>]</td>
<td valign="middle" align="left">[<a href="#Handling-character-data" title="Next section in reading order"> &gt; </a>]</td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left">[<a href="#System-and-foreign-language-interfaces" title="Beginning of this chapter or previous chapter"> &lt;&lt; </a>]</td>
<td valign="middle" align="left">[<a href="#Handling-R-objects-in-C" title="Up section"> Up </a>]</td>
<td valign="middle" align="left">[<a href="#The-R-API" title="Next chapter"> &gt;&gt; </a>]</td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left">[<a href="#Top" title="Cover (top) of document">Top</a>]</td>
<td valign="middle" align="left">[<a href="#SEC_Contents" title="Table of contents">Contents</a>]</td>
<td valign="middle" align="left">[<a href="#Function-and-variable-index" title="Index">Index</a>]</td>
<td valign="middle" align="left">[<a href="#SEC_About" title="About (help)"> ? </a>]</td>
</tr></table>
<a name="Handling-lists-1"></a>
<h3 class="subsection">5.9.6 Handling lists</h3>
<a name="index-Handling-lists"></a>

<p>Some care is needed with lists, as R moved early on from using
LISP-like lists (now called &ldquo;pairlists&rdquo;) to S-like generic vectors.
As a result, the appropriate test for an object of mode <code>list</code> is
<code>isNewList</code>, and we need <code>allocVector(VECSXP, <var>n</var></code>) and
<em>not</em> <code>allocList(<var>n</var>)</code>.
</p>
<p>List elements can be retrieved or set by direct access to the elements
of the generic vector.  Suppose we have a list object
</p>
<table><tr><td>&nbsp;</td><td><pre class="example">a &lt;- list(f = 1, g = 2, h = 3)
</pre></td></tr></table>

<p>Then we can access <code>a$g</code> as <code>a[[2]]</code> by
</p>
<table><tr><td>&nbsp;</td><td><pre class="example">    double g;
      ....
    g = REAL(VECTOR_ELT(a, 1))[0];
</pre></td></tr></table>

<p>This can rapidly become tedious, and the following function (based on
one in package <strong>stats</strong>) is very useful:
</p>
<table><tr><td>&nbsp;</td><td><pre class="example">/* get the list element named str, or return NULL */

SEXP getListElement(SEXP list, const char *str)
{
    SEXP elmt = R_NilValue, names = getAttrib(list, R_NamesSymbol);
</pre><pre class="example">
</pre><pre class="example">    for (int i = 0; i &lt; length(list); i++)
        if(strcmp(CHAR(STRING_ELT(names, i)), str) == 0) {
           elmt = VECTOR_ELT(list, i);
           break;
        }
    return elmt;
}
</pre></td></tr></table>

<p>and enables us to say
</p>
<table><tr><td>&nbsp;</td><td><pre class="example">  double g;
  g = REAL(getListElement(a, &quot;g&quot;))[0];
</pre></td></tr></table>

<hr size="6">
<a name="Handling-character-data"></a>
<table cellpadding="1" cellspacing="1" border="0">
<tr><td valign="middle" align="left">[<a href="#Handling-lists" title="Previous section in reading order"> &lt; </a>]</td>
<td valign="middle" align="left">[<a href="#Finding-and-setting-variables" title="Next section in reading order"> &gt; </a>]</td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left">[<a href="#System-and-foreign-language-interfaces" title="Beginning of this chapter or previous chapter"> &lt;&lt; </a>]</td>
<td valign="middle" align="left">[<a href="#Handling-R-objects-in-C" title="Up section"> Up </a>]</td>
<td valign="middle" align="left">[<a href="#The-R-API" title="Next chapter"> &gt;&gt; </a>]</td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left">[<a href="#Top" title="Cover (top) of document">Top</a>]</td>
<td valign="middle" align="left">[<a href="#SEC_Contents" title="Table of contents">Contents</a>]</td>
<td valign="middle" align="left">[<a href="#Function-and-variable-index" title="Index">Index</a>]</td>
<td valign="middle" align="left">[<a href="#SEC_About" title="About (help)"> ? </a>]</td>
</tr></table>
<a name="Handling-character-data-1"></a>
<h3 class="subsection">5.9.7 Handling character data</h3>
<a name="index-handling-character-data"></a>

<p>R character vectors are stored as <code>STRSXP</code>s, a vector type like
<code>VECSXP</code> where every element is of type <code>CHARSXP</code>.  The
<code>CHARSXP</code> elements of <code>STRSXP</code>s are accessed using
<code>STRING_ELT</code> and <code>SET_STRING_ELT</code>.
</p>
<p><code>CHARSXP</code>s are read-only objects and must never be modified.  In
particular, the C-style string contained in a <code>CHARSXP</code> should be
treated as read-only and for this reason the <code>CHAR</code> function used
to access the character data of a <code>CHARSXP</code> returns <code>(const
char *)</code> (this also allows compilers to issue warnings about improper
use).  Since <code>CHARSXP</code>s are immutable, the same <code>CHARSXP</code> can
be shared by any <code>STRSXP</code> needing an element representing the same
string. R maintains a global cache of <code>CHARSXP</code>s so that there
is only ever one <code>CHARSXP</code> representing a given string in memory.
</p>
<a name="index-mkChar"></a>
<a name="index-mkCharLen"></a>
<p>You can obtain a <code>CHARSXP</code> by calling <code>mkChar</code> and providing a
nul-terminated C-style string.  This function will return a pre-existing
<code>CHARSXP</code> if one with a matching string already exists, otherwise
it will create a new one and add it to the cache before returning it to
you.   The variant <code>mkCharLen</code> can be used to create a
<code>CHARSXP</code> from part of a buffer and will ensure null-termination.
</p>
<p>Note that R character strings are restricted to <code>2^31 - 1</code>
bytes, and hence so should the input to <code>mkChar</code> be (C allows
longer strings on 64-bit platforms).
</p>
<hr size="6">
<a name="Finding-and-setting-variables"></a>
<table cellpadding="1" cellspacing="1" border="0">
<tr><td valign="middle" align="left">[<a href="#Handling-character-data" title="Previous section in reading order"> &lt; </a>]</td>
<td valign="middle" align="left">[<a href="#Some-convenience-functions" title="Next section in reading order"> &gt; </a>]</td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left">[<a href="#System-and-foreign-language-interfaces" title="Beginning of this chapter or previous chapter"> &lt;&lt; </a>]</td>
<td valign="middle" align="left">[<a href="#Handling-R-objects-in-C" title="Up section"> Up </a>]</td>
<td valign="middle" align="left">[<a href="#The-R-API" title="Next chapter"> &gt;&gt; </a>]</td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left">[<a href="#Top" title="Cover (top) of document">Top</a>]</td>
<td valign="middle" align="left">[<a href="#SEC_Contents" title="Table of contents">Contents</a>]</td>
<td valign="middle" align="left">[<a href="#Function-and-variable-index" title="Index">Index</a>]</td>
<td valign="middle" align="left">[<a href="#SEC_About" title="About (help)"> ? </a>]</td>
</tr></table>
<a name="Finding-and-setting-variables-1"></a>
<h3 class="subsection">5.9.8 Finding and setting variables</h3>
<a name="index-Finding-variables"></a>
<a name="index-Setting-variables"></a>

<p>It will be usual that all the R objects needed in our C computations
are passed as arguments to <code>.Call</code> or <code>.External</code>, but it is
possible to find the values of R objects from within the C given
their names.  The following code is the equivalent of <code>get(name,
envir = rho)</code>.
</p>
<table><tr><td>&nbsp;</td><td><pre class="example">SEXP getvar(SEXP name, SEXP rho)
{
    SEXP ans;

    if(!isString(name) || length(name) != 1)
        error(&quot;name is not a single string&quot;);
    if(!isEnvironment(rho))
        error(&quot;rho should be an environment&quot;);
    ans = findVar(install(CHAR(STRING_ELT(name, 0))), rho);
    Rprintf(&quot;first value is %f\n&quot;, REAL(ans)[0]);
    return(R_NilValue);
}
</pre></td></tr></table>

<p>The main work is done by
<a name="index-findVar"></a>
<code>findVar</code>, but to use it we need to install <code>name</code> as a name
in the symbol table.  As we wanted the value for internal use, we return
<code>NULL</code>.
</p>
<p>Similar functions with syntax
</p>
<table><tr><td>&nbsp;</td><td><pre class="example">void defineVar(SEXP symbol, SEXP value, SEXP rho)
void setVar(SEXP symbol, SEXP value, SEXP rho)
</pre></td></tr></table>
<a name="index-defineVar"></a>
<a name="index-setVar"></a>

<p>can be used to assign values to R variables.  <code>defineVar</code>
creates a new binding or changes the value of an existing binding in the
specified environment frame; it is the analogue of <code>assign(symbol,
value, envir = rho, inherits = FALSE)</code>, but unlike <code>assign</code>,
<code>defineVar</code> does not make a copy of the object
<code>value</code>.<a name="DOCF70" href="#FOOT70">(70)</a>  <code>setVar</code> searches for an existing
binding for <code>symbol</code> in <code>rho</code> or its enclosing environments.
If a binding is found, its value is changed to <code>value</code>.  Otherwise,
a new binding with the specified value is created in the global
environment.  This corresponds to <code>assign(symbol, value, envir =
rho, inherits = TRUE)</code>.
</p>
<hr size="6">
<a name="Some-convenience-functions"></a>
<table cellpadding="1" cellspacing="1" border="0">
<tr><td valign="middle" align="left">[<a href="#Finding-and-setting-variables" title="Previous section in reading order"> &lt; </a>]</td>
<td valign="middle" align="left">[<a href="#Semi_002dinternal-convenience-functions" title="Next section in reading order"> &gt; </a>]</td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left">[<a href="#System-and-foreign-language-interfaces" title="Beginning of this chapter or previous chapter"> &lt;&lt; </a>]</td>
<td valign="middle" align="left">[<a href="#Handling-R-objects-in-C" title="Up section"> Up </a>]</td>
<td valign="middle" align="left">[<a href="#The-R-API" title="Next chapter"> &gt;&gt; </a>]</td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left">[<a href="#Top" title="Cover (top) of document">Top</a>]</td>
<td valign="middle" align="left">[<a href="#SEC_Contents" title="Table of contents">Contents</a>]</td>
<td valign="middle" align="left">[<a href="#Function-and-variable-index" title="Index">Index</a>]</td>
<td valign="middle" align="left">[<a href="#SEC_About" title="About (help)"> ? </a>]</td>
</tr></table>
<a name="Some-convenience-functions-1"></a>
<h3 class="subsection">5.9.9 Some convenience functions</h3>

<p>Some operations are done so frequently that there are convenience
functions to handle them. (All these are provided via the header file
&lsquo;<tt>Rinternals.h</tt>&rsquo;.)
</p>
<p>Suppose we wanted to pass a single logical argument
<code>ignore_quotes</code>: we could use
</p>
<table><tr><td>&nbsp;</td><td><pre class="example">    int ign = asLogical(ignore_quotes);
    if(ign == NA_LOGICAL) error(&quot;'ignore_quotes' must be TRUE or FALSE&quot;);
</pre></td></tr></table>

<p>which will do any coercion needed (at least from a vector argument), and
return <code>NA_LOGICAL</code> if the value passed was <code>NA</code> or coercion
failed.  There are also <code>asInteger</code>, <code>asReal</code> and
<code>asComplex</code>.  The function <code>asChar</code> returns a <code>CHARSXP</code>.
All of these functions ignore any elements of an input vector after the
first.
</p>
<p>To return a length-one real vector we can use
</p>
<table><tr><td>&nbsp;</td><td><pre class="example">    double x;

    ...
    return ScalarReal(x);
</pre></td></tr></table>

<p>and there are versions of this for all the atomic vector types (those for
a length-one character vector being <code>ScalarString</code> with argument a
<code>CHARSXP</code> and <code>mkString</code> with argument <code>const char *</code>).
</p>
<p>Some of the <code>is<var>XXXX</var></code> functions differ from their apparent
R-level counterparts: for example <code>isVector</code> is true for any
atomic vector type (<code>isVectorAtomic</code>) and for lists and expressions
(<code>isVectorList</code>) (with no check on attributes).  <code>isMatrix</code> is
a test of a length-2 <code>&quot;dim&quot;</code> attribute.
</p>
<p>There are a series of small macros/functions to help construct pairlists
and language objects (whose internal structures just differ by
<code>SEXPTYPE</code>).  Function <code>CONS(u, v)</code> is the basic building
block: it constructs a pairlist from <code>u</code> followed by <code>v</code>
(which is a pairlist or <code>R_NilValue</code>).  <code>LCONS</code> is a variant
that constructs a language object.  Functions <code>list1</code> to
<code>list5</code> construct a pairlist from one to five items, and
<code>lang1</code> to <code>lang6</code> do the same for a language object (a
function to call plus zero to five arguments).  Functions <code>elt</code> and
<code>lastElt</code> find the <var>i</var>th element and the last element of a
pairlist, and <code>nthcdr</code> returns a pointer to the <var>n</var>th position
in the pairlist (whose <code>CAR</code> is the <var>n</var>th item).
</p>
<p>Functions <code>str2type</code> and <code>type2str</code> map R
length-one character strings to and from <code>SEXPTYPE</code> numbers, and
<code>type2char</code> maps numbers to C character strings.
</p>
<table class="menu" border="0" cellspacing="0">
<tr><td align="left" valign="top"><a href="#Semi_002dinternal-convenience-functions">5.9.9.1 Semi-internal convenience functions</a></td><td>&nbsp;&nbsp;</td><td align="left" valign="top">  
</td></tr>
</table>

<hr size="6">
<a name="Semi_002dinternal-convenience-functions"></a>
<table cellpadding="1" cellspacing="1" border="0">
<tr><td valign="middle" align="left">[<a href="#Some-convenience-functions" title="Previous section in reading order"> &lt; </a>]</td>
<td valign="middle" align="left">[<a href="#Named-objects-and-copying" title="Next section in reading order"> &gt; </a>]</td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left">[<a href="#System-and-foreign-language-interfaces" title="Beginning of this chapter or previous chapter"> &lt;&lt; </a>]</td>
<td valign="middle" align="left">[<a href="#Some-convenience-functions" title="Up section"> Up </a>]</td>
<td valign="middle" align="left">[<a href="#The-R-API" title="Next chapter"> &gt;&gt; </a>]</td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left">[<a href="#Top" title="Cover (top) of document">Top</a>]</td>
<td valign="middle" align="left">[<a href="#SEC_Contents" title="Table of contents">Contents</a>]</td>
<td valign="middle" align="left">[<a href="#Function-and-variable-index" title="Index">Index</a>]</td>
<td valign="middle" align="left">[<a href="#SEC_About" title="About (help)"> ? </a>]</td>
</tr></table>
<a name="Semi_002dinternal-convenience-functions-1"></a>
<h4 class="subsubsection">5.9.9.1 Semi-internal convenience functions</h4>

<p>There is quite a collection of functions that may be used in your C code
<em>if</em> you are willing to adapt to rare &ldquo;API&rdquo; changes.
These typically contain &ldquo;workhorses&rdquo; of their R counterparts.
</p>
<p>Functions <code>any_duplicated</code> and <code>any_duplicated3</code> are fast
versions of R&rsquo;s <code>any(duplicated(.))</code>.
</p>
<p>Function <code>R_compute_identical</code> corresponds to R&rsquo;s <code>identical</code> function.
</p>

<hr size="6">
<a name="Named-objects-and-copying"></a>
<table cellpadding="1" cellspacing="1" border="0">
<tr><td valign="middle" align="left">[<a href="#Semi_002dinternal-convenience-functions" title="Previous section in reading order"> &lt; </a>]</td>
<td valign="middle" align="left">[<a href="#Interface-functions-_002eCall-and-_002eExternal" title="Next section in reading order"> &gt; </a>]</td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left">[<a href="#System-and-foreign-language-interfaces" title="Beginning of this chapter or previous chapter"> &lt;&lt; </a>]</td>
<td valign="middle" align="left">[<a href="#Handling-R-objects-in-C" title="Up section"> Up </a>]</td>
<td valign="middle" align="left">[<a href="#The-R-API" title="Next chapter"> &gt;&gt; </a>]</td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left">[<a href="#Top" title="Cover (top) of document">Top</a>]</td>
<td valign="middle" align="left">[<a href="#SEC_Contents" title="Table of contents">Contents</a>]</td>
<td valign="middle" align="left">[<a href="#Function-and-variable-index" title="Index">Index</a>]</td>
<td valign="middle" align="left">[<a href="#SEC_About" title="About (help)"> ? </a>]</td>
</tr></table>
<a name="Named-objects-and-copying-1"></a>
<h3 class="subsection">5.9.10 Named objects and copying</h3>
<a name="index-duplicate"></a>
<a name="index-Copying-objects"></a>

<p>When assignments are done in R such as
</p>
<table><tr><td>&nbsp;</td><td><pre class="example">x &lt;- 1:10
y &lt;- x
</pre></td></tr></table>

<p>the named object is not necessarily copied, so after those two
assignments <code>y</code> and <code>x</code> are bound to the same <code>SEXPREC</code>
(the structure a <code>SEXP</code> points to).  This means that any code which
alters one of them has to make a copy before modifying the copy if the
usual R semantics are to apply.  Note that whereas <code>.C</code> and
<code>.Fortran</code> do copy their arguments (unless the dangerous <code>dup
= FALSE</code> is used), <code>.Call</code> and <code>.External</code> do not.  So
<code>duplicate</code> is commonly called on arguments to <code>.Call</code> before
modifying them.
</p>
<p>However, at least some of this copying is unneeded.  In the first
assignment shown, <code>x &lt;- 1:10</code>, R first creates an object with
value <code>1:10</code> and then assigns it to <code>x</code> but if <code>x</code> is
modified no copy is necessary as the temporary object with value
<code>1:10</code> cannot be referred to again.  R distinguishes between
named and unnamed objects <em>via</em> a field in a <code>SEXPREC</code> that
can be accessed <em>via</em> the macros <code>NAMED</code> and <code>SET_NAMED</code>.  This
can take values
</p>
<dl compact="compact">
<dt> <code>0</code></dt>
<dd><p>The object is not bound to any symbol
</p></dd>
<dt> <code>1</code></dt>
<dd><p>The object has been bound to exactly one symbol
</p></dd>
<dt> <code>2</code></dt>
<dd><p>The object has potentially been bound to two or more symbols, and one
should act as if another variable is currently bound to this value.
</p></dd>
</dl>

<p>Note the past tenses: R does not do full reference counting and there
may currently be fewer bindings.
</p>
<p>It is safe to modify the value of any <code>SEXP</code> for which
<code>NAMED(foo)</code> is zero, and if <code>NAMED(foo)</code> is two, the value
should be duplicated (<em>via</em> a call to <code>duplicate</code>) before any
modification.  Note that it is the responsibility of the author of the
code making the modification to do the duplication, even if it is
<code>x</code> whose value is being modified after <code>y &lt;- x</code>.
</p>
<p>The case <code>NAMED(foo) == 1</code> allows some optimization, but it can be
ignored (and duplication done whenever <code>NAMED(foo) &gt; 0</code>).  (This
optimization is not currently usable in user code.)  It is intended
for use within replacement functions.  Suppose we used
</p>
<table><tr><td>&nbsp;</td><td><pre class="example">x &lt;- 1:10
foo(x) &lt;- 3
</pre></td></tr></table>

<p>which is computed as
</p>
<table><tr><td>&nbsp;</td><td><pre class="example">x &lt;- 1:10
x &lt;- &quot;foo&lt;-&quot;(x, 3)
</pre></td></tr></table>

<p>Then inside <code>&quot;foo&lt;-&quot;</code> the object pointing to the current value of
<code>x</code> will have <code>NAMED(foo)</code> as one, and it would be safe to
modify it as the only symbol bound to it is <code>x</code> and that will be
rebound immediately.  (Provided the remaining code in <code>&quot;foo&lt;-&quot;</code>
make no reference to <code>x</code>, and no one is going to attempt a direct
call such as <code>y &lt;- &quot;foo&lt;-&quot;(x)</code>.)
</p>
<p>Currently all arguments to a <code>.Call</code> call will have <code>NAMED</code>
set to 2, and so users must assume that they need to be duplicated
before alteration.
</p>
<hr size="6">
<a name="Interface-functions-_002eCall-and-_002eExternal"></a>
<table cellpadding="1" cellspacing="1" border="0">
<tr><td valign="middle" align="left">[<a href="#Named-objects-and-copying" title="Previous section in reading order"> &lt; </a>]</td>
<td valign="middle" align="left">[<a href="#Calling-_002eCall" title="Next section in reading order"> &gt; </a>]</td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left">[<a href="#System-and-foreign-language-interfaces" title="Beginning of this chapter or previous chapter"> &lt;&lt; </a>]</td>
<td valign="middle" align="left">[<a href="#System-and-foreign-language-interfaces" title="Up section"> Up </a>]</td>
<td valign="middle" align="left">[<a href="#The-R-API" title="Next chapter"> &gt;&gt; </a>]</td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left">[<a href="#Top" title="Cover (top) of document">Top</a>]</td>
<td valign="middle" align="left">[<a href="#SEC_Contents" title="Table of contents">Contents</a>]</td>
<td valign="middle" align="left">[<a href="#Function-and-variable-index" title="Index">Index</a>]</td>
<td valign="middle" align="left">[<a href="#SEC_About" title="About (help)"> ? </a>]</td>
</tr></table>
<a name="Interface-functions-_002eCall-and-_002eExternal-1"></a>
<h2 class="section">5.10 Interface functions <code>.Call</code> and <code>.External</code></h2>
<a name="index-Interfaces-to-compiled-code-1"></a>

<p>In this section we consider the details of the R/C interfaces.
</p>
<p>These two interfaces have almost the same functionality. <code>.Call</code> is
based on the interface of the same name in S version 4, and
<code>.External</code> is based on R&rsquo;s <code>.Internal</code>.  <code>.External</code>
is more complex but allows a variable number of arguments.
</p>
<table class="menu" border="0" cellspacing="0">
<tr><td align="left" valign="top"><a href="#Calling-_002eCall">5.10.1 Calling <code>.Call</code></a></td><td>&nbsp;&nbsp;</td><td align="left" valign="top">               
</td></tr>
<tr><td align="left" valign="top"><a href="#Calling-_002eExternal">5.10.2 Calling <code>.External</code></a></td><td>&nbsp;&nbsp;</td><td align="left" valign="top">           
</td></tr>
<tr><td align="left" valign="top"><a href="#Missing-and-special-values">5.10.3 Missing and special values</a></td><td>&nbsp;&nbsp;</td><td align="left" valign="top">  
</td></tr>
</table>

<hr size="6">
<a name="Calling-_002eCall"></a>
<table cellpadding="1" cellspacing="1" border="0">
<tr><td valign="middle" align="left">[<a href="#Interface-functions-_002eCall-and-_002eExternal" title="Previous section in reading order"> &lt; </a>]</td>
<td valign="middle" align="left">[<a href="#Calling-_002eExternal" title="Next section in reading order"> &gt; </a>]</td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left">[<a href="#System-and-foreign-language-interfaces" title="Beginning of this chapter or previous chapter"> &lt;&lt; </a>]</td>
<td valign="middle" align="left">[<a href="#Interface-functions-_002eCall-and-_002eExternal" title="Up section"> Up </a>]</td>
<td valign="middle" align="left">[<a href="#The-R-API" title="Next chapter"> &gt;&gt; </a>]</td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left">[<a href="#Top" title="Cover (top) of document">Top</a>]</td>
<td valign="middle" align="left">[<a href="#SEC_Contents" title="Table of contents">Contents</a>]</td>
<td valign="middle" align="left">[<a href="#Function-and-variable-index" title="Index">Index</a>]</td>
<td valign="middle" align="left">[<a href="#SEC_About" title="About (help)"> ? </a>]</td>
</tr></table>
<a name="Calling-_002eCall-1"></a>
<h3 class="subsection">5.10.1 Calling <code>.Call</code></h3>

<a name="index-_002eCall-1"></a>

<p>Let us convert our finite convolution example to use <code>.Call</code>, first
using the &lsquo;<tt>Rdefines.h</tt>&rsquo; macros.  The calling function in R is
</p>
<table><tr><td>&nbsp;</td><td><pre class="example">conv &lt;- function(a, b) .Call(&quot;convolve2&quot;, a, b)
</pre></td></tr></table>

<p>which could hardly be simpler, but as we shall see all the type checking
must be transferred to the C code, which is
</p>
<table><tr><td>&nbsp;</td><td><pre class="example">#include &lt;R.h&gt;
#include &lt;Rdefines.h&gt;

SEXP convolve2(SEXP a, SEXP b)
{
    int i, j, na, nb, nab;
    double *xa, *xb, *xab;
    SEXP ab;

    PROTECT(a = AS_NUMERIC(a));
    PROTECT(b = AS_NUMERIC(b));
    na = LENGTH(a); nb = LENGTH(b); nab = na + nb - 1;
    PROTECT(ab = NEW_NUMERIC(nab));
    xa = NUMERIC_POINTER(a); xb = NUMERIC_POINTER(b);
    xab = NUMERIC_POINTER(ab);
    for(i = 0; i &lt; nab; i++) xab[i] = 0.0;
    for(i = 0; i &lt; na; i++)
         for(j = 0; j &lt; nb; j++) xab[i + j] += xa[i] * xb[j];
    UNPROTECT(3);
    return(ab);
}
</pre></td></tr></table>

<p>Now for the version in &lsquo;<tt>Rinternals.h</tt>&rsquo; style.  Only the C code changes.
</p>
<table><tr><td>&nbsp;</td><td><pre class="example">#include &lt;R.h&gt;
#include &lt;Rinternals.h&gt;

SEXP convolve2(SEXP a, SEXP b)
{
    int i, j, na, nb, nab;
    double *xa, *xb, *xab;
    SEXP ab;

    PROTECT(a = coerceVector(a, REALSXP));
    PROTECT(b = coerceVector(b, REALSXP));
    na = length(a); nb = length(b); nab = na + nb - 1;
    PROTECT(ab = allocVector(REALSXP, nab));
    xa = REAL(a); xb = REAL(b);
    xab = REAL(ab);
    for(i = 0; i &lt; nab; i++) xab[i] = 0.0;
    for(i = 0; i &lt; na; i++)
        for(j = 0; j &lt; nb; j++) xab[i + j] += xa[i] * xb[j];
    UNPROTECT(3);
    return(ab);
}
</pre></td></tr></table>

<p>This is called in exactly the same way.
</p>
<hr size="6">
<a name="Calling-_002eExternal"></a>
<table cellpadding="1" cellspacing="1" border="0">
<tr><td valign="middle" align="left">[<a href="#Calling-_002eCall" title="Previous section in reading order"> &lt; </a>]</td>
<td valign="middle" align="left">[<a href="#Missing-and-special-values" title="Next section in reading order"> &gt; </a>]</td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left">[<a href="#System-and-foreign-language-interfaces" title="Beginning of this chapter or previous chapter"> &lt;&lt; </a>]</td>
<td valign="middle" align="left">[<a href="#Interface-functions-_002eCall-and-_002eExternal" title="Up section"> Up </a>]</td>
<td valign="middle" align="left">[<a href="#The-R-API" title="Next chapter"> &gt;&gt; </a>]</td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left">[<a href="#Top" title="Cover (top) of document">Top</a>]</td>
<td valign="middle" align="left">[<a href="#SEC_Contents" title="Table of contents">Contents</a>]</td>
<td valign="middle" align="left">[<a href="#Function-and-variable-index" title="Index">Index</a>]</td>
<td valign="middle" align="left">[<a href="#SEC_About" title="About (help)"> ? </a>]</td>
</tr></table>
<a name="Calling-_002eExternal-1"></a>
<h3 class="subsection">5.10.2 Calling <code>.External</code></h3>

<a name="index-_002eExternal-1"></a>

<p>We can use the same example to illustrate <code>.External</code>.  The R
code changes only by replacing <code>.Call</code> by <code>.External</code>
</p>
<table><tr><td>&nbsp;</td><td><pre class="example">conv &lt;- function(a, b) .External(&quot;convolveE&quot;, a, b)
</pre></td></tr></table>

<p>but the main change is how the arguments are passed to the C code, this
time as a single SEXP.  The only change to the C code is how we handle
the arguments.
</p>
<table><tr><td>&nbsp;</td><td><pre class="example">#include &lt;R.h&gt;
#include &lt;Rinternals.h&gt;

SEXP convolveE(SEXP args)
{
    int i, j, na, nb, nab;
    double *xa, *xb, *xab;
    SEXP a, b, ab;

    PROTECT(a = coerceVector(CADR(args), REALSXP));
    PROTECT(b = coerceVector(CADDR(args), REALSXP));
    ...
}
</pre></td></tr></table>

<p>Once again we do not need to protect the arguments, as in the R side
of the interface they are objects that are already in use.  The macros
</p>
<table><tr><td>&nbsp;</td><td><pre class="example">  first = CADR(args);
  second = CADDR(args);
  third = CADDDR(args);
  fourth = CAD4R(args);
</pre></td></tr></table>

<p>provide convenient ways to access the first four arguments.  More
generally we can use the
<a name="index-CAR"></a>
<a name="index-CDR"></a>
<code>CDR</code> and <code>CAR</code> macros as in
</p>
<table><tr><td>&nbsp;</td><td><pre class="example">  args = CDR(args); a = CAR(args);
  args = CDR(args); b = CAR(args);
</pre></td></tr></table>

<p>which clearly allows us to extract an unlimited number of arguments
(whereas <code>.Call</code> has a limit, albeit at 65 not a small one).
</p>
<p>More usefully, the <code>.External</code> interface provides an easy way to
handle calls with a variable number of arguments, as <code>length(args)</code>
will give the number of arguments supplied (of which the first is
ignored).  We may need to know the names (&lsquo;tags&rsquo;) given to the actual
arguments, which we can by using the <code>TAG</code> macro and using
something like the following example, that prints the names and the first
value of its arguments if they are vector types.
</p>
<table><tr><td>&nbsp;</td><td><pre class="example">SEXP showArgs(SEXP args)
{
    args = CDR(args); /* skip 'name' */
    for(int i = 0; args != R_NilValue; i++, args = CDR(args)) {
        const char *name =
            isNull(TAG(args)) ? &quot;&quot; : CHAR(PRINTNAME(TAG(args)));
        SEXP el = CAR(args);
        if (length(el) == 0) {
            Rprintf(&quot;[%d] '%s' R type, length 0\n&quot;, i+1, name);
           continue;
        }
</pre><pre class="example">        switch(TYPEOF(el)) {
        case REALSXP:
            Rprintf(&quot;[%d] '%s' %f\n&quot;, i+1, name, REAL(el)[0]);
            break;
</pre><pre class="example">        case LGLSXP:
        case INTSXP:
            Rprintf(&quot;[%d] '%s' %d\n&quot;, i+1, name, INTEGER(el)[0]);
            break;
</pre><pre class="example">        case CPLXSXP:
        {
            Rcomplex cpl = COMPLEX(el)[0];
            Rprintf(&quot;[%d] '%s' %f + %fi\n&quot;, i+1, name, cpl.r, cpl.i);
        }
            break;
</pre><pre class="example">        case STRSXP:
            Rprintf(&quot;[%d] '%s' %s\n&quot;, i+1, name,
                   CHAR(STRING_ELT(el, 0)));
           break;
</pre><pre class="example">        default:
            Rprintf(&quot;[%d] '%s' R type\n&quot;, i+1, name);
       }
    }
    return(R_NilValue);
}
</pre></td></tr></table>

<p>This can be called by the wrapper function
</p>
<table><tr><td>&nbsp;</td><td><pre class="example">showArgs &lt;- function(...) invisible(.External(&quot;showArgs&quot;, ...))
</pre></td></tr></table>

<p>Note that this style of programming is convenient but not necessary, as
an alternative style is
</p>
<table><tr><td>&nbsp;</td><td><pre class="example">showArgs1 &lt;- function(...) invisible(.Call(&quot;showArgs1&quot;, list(...)))
</pre></td></tr></table>

<p>The (very similar) C code is in the scripts.
</p>
<hr size="6">
<a name="Missing-and-special-values"></a>
<table cellpadding="1" cellspacing="1" border="0">
<tr><td valign="middle" align="left">[<a href="#Calling-_002eExternal" title="Previous section in reading order"> &lt; </a>]</td>
<td valign="middle" align="left">[<a href="#Evaluating-R-expressions-from-C" title="Next section in reading order"> &gt; </a>]</td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left">[<a href="#System-and-foreign-language-interfaces" title="Beginning of this chapter or previous chapter"> &lt;&lt; </a>]</td>
<td valign="middle" align="left">[<a href="#Interface-functions-_002eCall-and-_002eExternal" title="Up section"> Up </a>]</td>
<td valign="middle" align="left">[<a href="#The-R-API" title="Next chapter"> &gt;&gt; </a>]</td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left">[<a href="#Top" title="Cover (top) of document">Top</a>]</td>
<td valign="middle" align="left">[<a href="#SEC_Contents" title="Table of contents">Contents</a>]</td>
<td valign="middle" align="left">[<a href="#Function-and-variable-index" title="Index">Index</a>]</td>
<td valign="middle" align="left">[<a href="#SEC_About" title="About (help)"> ? </a>]</td>
</tr></table>
<a name="Missing-and-special-values-1"></a>
<h3 class="subsection">5.10.3 Missing and special values</h3>
<a name="index-Missing-values"></a>
<a name="index-IEEE-special-values"></a>

<p>One piece of error-checking the <code>.C</code> call does (unless <code>NAOK</code>
is true) is to check for missing (<code>NA</code>) and <acronym>IEEE</acronym> special
values (<code>Inf</code>, <code>-Inf</code> and <code>NaN</code>) and give an error if any
are found.  With the <code>.Call</code> interface these will be passed to our
code.  In this example the special values are no problem, as
<acronym>IEC60559</acronym> arithmetic will handle them correctly.  In the current
implementation this is also true of <code>NA</code> as it is a type of
<code>NaN</code>, but it is unwise to rely on such details.  Thus we will
re-write the code to handle <code>NA</code>s using macros defined in
&lsquo;<tt>R_exts/Arith.h</tt>&rsquo; included by &lsquo;<tt>R.h</tt>&rsquo;.
</p>
<p>The code changes are the same in any of the versions of <code>convolve2</code>
or <code>convolveE</code>:
</p>
<table><tr><td>&nbsp;</td><td><pre class="example">    ...
  for(i = 0; i &lt; na; i++)
    for(j = 0; j &lt; nb; j++)
        if(ISNA(xa[i]) || ISNA(xb[j]) || ISNA(xab[i + j]))
            xab[i + j] = NA_REAL;
        else
            xab[i + j] += xa[i] * xb[j];
    ...
</pre></td></tr></table>

<a name="index-ISNA"></a>
<a name="index-ISNAN"></a>

<p>Note that the <code>ISNA</code> macro, and the similar macros <code>ISNAN</code>
(which checks for <code>NaN</code> or <code>NA</code>) and <code>R_FINITE</code> (which is
false for <code>NA</code> and all the special values), only apply to numeric
values of type <code>double</code>.  Missingness of integers, logicals and
character strings can be tested by equality to the constants
<code>NA_INTEGER</code>, <code>NA_LOGICAL</code> and <code>NA_STRING</code>.  These and
<code>NA_REAL</code> can be used to set elements of R vectors to <code>NA</code>.
</p>
<p>The constants <code>R_NaN</code>, <code>R_PosInf</code> and <code>R_NegInf</code> can be
used to set <code>double</code>s to the special values.
</p>
<hr size="6">
<a name="Evaluating-R-expressions-from-C"></a>
<table cellpadding="1" cellspacing="1" border="0">
<tr><td valign="middle" align="left">[<a href="#Missing-and-special-values" title="Previous section in reading order"> &lt; </a>]</td>
<td valign="middle" align="left">[<a href="#Zero_002dfinding" title="Next section in reading order"> &gt; </a>]</td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left">[<a href="#System-and-foreign-language-interfaces" title="Beginning of this chapter or previous chapter"> &lt;&lt; </a>]</td>
<td valign="middle" align="left">[<a href="#System-and-foreign-language-interfaces" title="Up section"> Up </a>]</td>
<td valign="middle" align="left">[<a href="#The-R-API" title="Next chapter"> &gt;&gt; </a>]</td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left">[<a href="#Top" title="Cover (top) of document">Top</a>]</td>
<td valign="middle" align="left">[<a href="#SEC_Contents" title="Table of contents">Contents</a>]</td>
<td valign="middle" align="left">[<a href="#Function-and-variable-index" title="Index">Index</a>]</td>
<td valign="middle" align="left">[<a href="#SEC_About" title="About (help)"> ? </a>]</td>
</tr></table>
<a name="Evaluating-R-expressions-from-C-1"></a>
<h2 class="section">5.11 Evaluating R expressions from C</h2>
<a name="index-Evaluating-R-expressions-from-C"></a>

<p>The main function we will use is
</p>
<table><tr><td>&nbsp;</td><td><pre class="example">SEXP eval(SEXP expr, SEXP rho);
</pre></td></tr></table>

<p>the equivalent of the interpreted R code <code>eval(expr, envir =
rho)</code>, although we can also make use of <code>findVar</code>, <code>defineVar</code>
and <code>findFun</code> (which restricts the search to functions).
</p>
<p>To see how this might be applied, here is a simplified internal version
of <code>lapply</code> for expressions, used as
</p>
<table><tr><td>&nbsp;</td><td><pre class="example">a &lt;- list(a = 1:5, b = rnorm(10), test = runif(100))
.Call(&quot;lapply&quot;, a, quote(sum(x)), new.env())
</pre></td></tr></table>

<p>with C code
</p>
<table><tr><td>&nbsp;</td><td><pre class="example">SEXP lapply(SEXP list, SEXP expr, SEXP rho)
{
    int i, n = length(list);
    SEXP ans;

    if(!isNewList(list)) error(&quot;'list' must be a list&quot;);
    if(!isEnvironment(rho)) error(&quot;'rho' should be an environment&quot;);
    PROTECT(ans = allocVector(VECSXP, n));
    for(i = 0; i &lt; n; i++) {
        defineVar(install(&quot;x&quot;), VECTOR_ELT(list, i), rho);
        SET_VECTOR_ELT(ans, i, eval(expr, rho));
    }
    setAttrib(ans, R_NamesSymbol, getAttrib(list, R_NamesSymbol));
    UNPROTECT(1);
    return(ans);
}
</pre></td></tr></table>

<p>It would be closer to <code>lapply</code> if we could pass in a function
rather than an expression.  One way to do this is <em>via</em> interpreted
R code as in the next example, but it is possible (if somewhat
obscure) to do this in C code.  The following is based on the code in
&lsquo;<tt>src/main/optimize.c</tt>&rsquo;.
</p>
<table><tr><td>&nbsp;</td><td><pre class="example">SEXP lapply2(SEXP list, SEXP fn, SEXP rho)
{
    int i, n = length(list);
    SEXP R_fcall, ans;

    if(!isNewList(list)) error(&quot;'list' must be a list&quot;);
    if(!isFunction(fn)) error(&quot;'fn' must be a function&quot;);
    if(!isEnvironment(rho)) error(&quot;'rho' should be an environment&quot;);
    PROTECT(R_fcall = lang2(fn, R_NilValue));
    PROTECT(ans = allocVector(VECSXP, n));
    for(i = 0; i &lt; n; i++) {
        SETCADR(R_fcall, VECTOR_ELT(list, i));
        SET_VECTOR_ELT(ans, i, eval(R_fcall, rho));
    }
    setAttrib(ans, R_NamesSymbol, getAttrib(list, R_NamesSymbol));
    UNPROTECT(2);
    return(ans);
}
</pre></td></tr></table>

<p>used by
</p>
<table><tr><td>&nbsp;</td><td><pre class="example">.Call(&quot;lapply2&quot;, a, sum, new.env())
</pre></td></tr></table>

<p>Function <code>lang2</code> creates an executable pairlist of two elements, but
this will only be clear to those with a knowledge of a LISP-like
language.
</p>
<p>As a more comprehensive example of constructing an R call in C code
and evaluating, consider the following fragment of
<code>printAttributes</code> in &lsquo;<tt>src/main/print.c</tt>&rsquo;.
</p>
<table><tr><td>&nbsp;</td><td><pre class="example">    /* Need to construct a call to
       print(CAR(a), digits=digits)
       based on the R_print structure, then eval(call, env).
       See do_docall for the template for this sort of thing.
    */
    SEXP s, t;
    PROTECT(t = s = allocList(3));
    SET_TYPEOF(s, LANGSXP);
    SETCAR(t, install(&quot;print&quot;)); t = CDR(t);
    SETCAR(t,  CAR(a)); t = CDR(t);
    SETCAR(t, ScalarInteger(digits));
    SET_TAG(t, install(&quot;digits&quot;));
    eval(s, env);
    UNPROTECT(1);
</pre></td></tr></table>

<p>At this point <code>CAR(a)</code> is the R object to be printed, the
current attribute.  There are three steps: the call is constructed as
a pairlist of length 3, the list is filled in, and the expression
represented by the pairlist is evaluated.
</p>
<p>A pairlist is quite distinct from a generic vector list, the only
user-visible form of list in R.  A pairlist is a linked list (with
<code>CDR(t)</code> computing the next entry), with items (accessed by
<code>CAR(t)</code>) and names or tags (set by <code>SET_TAG</code>).  In this call
there are to be three items, a symbol (pointing to the function to be
called) and two argument values, the first unnamed and the second named.
Setting the type to <code>LANGSXP</code> makes this a call which can be evaluated.
</p>
<table class="menu" border="0" cellspacing="0">
<tr><td align="left" valign="top"><a href="#Zero_002dfinding">5.11.1 Zero-finding</a></td><td>&nbsp;&nbsp;</td><td align="left" valign="top">                
</td></tr>
<tr><td align="left" valign="top"><a href="#Calculating-numerical-derivatives">5.11.2 Calculating numerical derivatives</a></td><td>&nbsp;&nbsp;</td><td align="left" valign="top">  
</td></tr>
</table>

<hr size="6">
<a name="Zero_002dfinding"></a>
<table cellpadding="1" cellspacing="1" border="0">
<tr><td valign="middle" align="left">[<a href="#Evaluating-R-expressions-from-C" title="Previous section in reading order"> &lt; </a>]</td>
<td valign="middle" align="left">[<a href="#Calculating-numerical-derivatives" title="Next section in reading order"> &gt; </a>]</td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left">[<a href="#System-and-foreign-language-interfaces" title="Beginning of this chapter or previous chapter"> &lt;&lt; </a>]</td>
<td valign="middle" align="left">[<a href="#Evaluating-R-expressions-from-C" title="Up section"> Up </a>]</td>
<td valign="middle" align="left">[<a href="#The-R-API" title="Next chapter"> &gt;&gt; </a>]</td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left">[<a href="#Top" title="Cover (top) of document">Top</a>]</td>
<td valign="middle" align="left">[<a href="#SEC_Contents" title="Table of contents">Contents</a>]</td>
<td valign="middle" align="left">[<a href="#Function-and-variable-index" title="Index">Index</a>]</td>
<td valign="middle" align="left">[<a href="#SEC_About" title="About (help)"> ? </a>]</td>
</tr></table>
<a name="Zero_002dfinding-1"></a>
<h3 class="subsection">5.11.1 Zero-finding</h3>
<a name="index-Zero_002dfinding"></a>

<p>In this section we re-work the example of Becker, Chambers &amp; Wilks (1988,
pp.~205&ndash;10) on finding a zero of a univariate function.  The R code
and an example are
</p>
<table><tr><td>&nbsp;</td><td><pre class="example">zero &lt;- function(f, guesses, tol = 1e-7) {
    f.check &lt;- function(x) {
        x &lt;- f(x)
        if(!is.numeric(x)) stop(&quot;Need a numeric result&quot;)
        as.double(x)
    }
    .Call(&quot;zero&quot;, body(f.check), as.double(guesses), as.double(tol),
          new.env())
}

cube1 &lt;- function(x) (x^2 + 1) * (x - 1.5)
zero(cube1, c(0, 5))
</pre></td></tr></table>

<p>where this time we do the coercion and error-checking in the R code.
The C code is
</p>
<table><tr><td>&nbsp;</td><td><pre class="example">SEXP mkans(double x)
{
    SEXP ans;
    PROTECT(ans = allocVector(REALSXP, 1));
    REAL(ans)[0] = x;
    UNPROTECT(1);
    return ans;
}
</pre><pre class="example">
</pre><pre class="example">double feval(double x, SEXP f, SEXP rho)
{
    defineVar(install(&quot;x&quot;), mkans(x), rho);
    return(REAL(eval(f, rho))[0]);
}
</pre><pre class="example">
</pre><pre class="example">SEXP zero(SEXP f, SEXP guesses, SEXP stol, SEXP rho)
{
    double x0 = REAL(guesses)[0], x1 = REAL(guesses)[1],
           tol = REAL(stol)[0];
    double f0, f1, fc, xc;
</pre><pre class="example">
</pre><pre class="example">    if(tol &lt;= 0.0) error(&quot;non-positive tol value&quot;);
    f0 = feval(x0, f, rho); f1 = feval(x1, f, rho);
    if(f0 == 0.0) return mkans(x0);
    if(f1 == 0.0) return mkans(x1);
    if(f0*f1 &gt; 0.0) error(&quot;x[0] and x[1] have the same sign&quot;);
</pre><pre class="example">
</pre><pre class="example">    for(;;) {
        xc = 0.5*(x0+x1);
        if(fabs(x0-x1) &lt; tol) return  mkans(xc);
        fc = feval(xc, f, rho);
        if(fc == 0) return  mkans(xc);
        if(f0*fc &gt; 0.0) {
            x0 = xc; f0 = fc;
        } else {
            x1 = xc; f1 = fc;
        }
    }
}
</pre></td></tr></table>

<hr size="6">
<a name="Calculating-numerical-derivatives"></a>
<table cellpadding="1" cellspacing="1" border="0">
<tr><td valign="middle" align="left">[<a href="#Zero_002dfinding" title="Previous section in reading order"> &lt; </a>]</td>
<td valign="middle" align="left">[<a href="#Parsing-R-code-from-C" title="Next section in reading order"> &gt; </a>]</td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left">[<a href="#System-and-foreign-language-interfaces" title="Beginning of this chapter or previous chapter"> &lt;&lt; </a>]</td>
<td valign="middle" align="left">[<a href="#Evaluating-R-expressions-from-C" title="Up section"> Up </a>]</td>
<td valign="middle" align="left">[<a href="#The-R-API" title="Next chapter"> &gt;&gt; </a>]</td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left">[<a href="#Top" title="Cover (top) of document">Top</a>]</td>
<td valign="middle" align="left">[<a href="#SEC_Contents" title="Table of contents">Contents</a>]</td>
<td valign="middle" align="left">[<a href="#Function-and-variable-index" title="Index">Index</a>]</td>
<td valign="middle" align="left">[<a href="#SEC_About" title="About (help)"> ? </a>]</td>
</tr></table>
<a name="Calculating-numerical-derivatives-1"></a>
<h3 class="subsection">5.11.2 Calculating numerical derivatives</h3>
<a name="index-Numerical-derivatives"></a>

<p>We will use a longer example (by Saikat DebRoy) to illustrate the use of
evaluation and <code>.External</code>.  This calculates numerical derivatives,
something that could be done as effectively in interpreted R code but
may be needed as part of a larger C calculation.
</p>
<p>An interpreted R version and an example are
</p>
<table><tr><td>&nbsp;</td><td><pre class="example">numeric.deriv &lt;- function(expr, theta, rho=sys.frame(sys.parent()))
{
    eps &lt;- sqrt(.Machine$double.eps)
    ans &lt;- eval(substitute(expr), rho)
    grad &lt;- matrix(, length(ans), length(theta),
                   dimnames=list(NULL, theta))
    for (i in seq_along(theta)) {
        old &lt;- get(theta[i], envir=rho)
        delta &lt;- eps * max(1, abs(old))
        assign(theta[i], old+delta, envir=rho)
        ans1 &lt;- eval(substitute(expr), rho)
        assign(theta[i], old, envir=rho)
        grad[, i] &lt;- (ans1 - ans)/delta
    }
    attr(ans, &quot;gradient&quot;) &lt;- grad
    ans
}
omega &lt;- 1:5; x &lt;- 1; y &lt;- 2
numeric.deriv(sin(omega*x*y), c(&quot;x&quot;, &quot;y&quot;))
</pre></td></tr></table>

<p>where <code>expr</code> is an expression, <code>theta</code> a character vector of
variable names and <code>rho</code> the environment to be used.
</p>
<p>For the compiled version the call from R will be
</p>
<table><tr><td>&nbsp;</td><td><pre class="example">.External(&quot;numeric_deriv&quot;, <var>expr</var>, <var>theta</var>, <var>rho</var>)
</pre></td></tr></table>

<p>with example usage
</p>
<table><tr><td>&nbsp;</td><td><pre class="example">.External(&quot;numeric_deriv&quot;, quote(sin(omega*x*y)),
          c(&quot;x&quot;, &quot;y&quot;), .GlobalEnv)
</pre></td></tr></table>

<p>Note the need to quote the expression to stop it being evaluated in the
caller.
</p>
<p>Here is the complete C code which we will explain section by section.
</p>
<table><tr><td>&nbsp;</td><td><pre class="example">#include &lt;R.h&gt; /* for DOUBLE_EPS */
#include &lt;Rinternals.h&gt;

SEXP numeric_deriv(SEXP args)
{
    SEXP theta, expr, rho, ans, ans1, gradient, par, dimnames;
    double tt, xx, delta, eps = sqrt(DOUBLE_EPS), *rgr, *rans;
    int start, i, j;
</pre><pre class="example">
</pre><pre class="example">    expr = CADR(args);
    if(!isString(theta = CADDR(args)))
        error(&quot;theta should be of type character&quot;);
    if(!isEnvironment(rho = CADDDR(args)))
        error(&quot;rho should be an environment&quot;);
</pre><pre class="example">
</pre><pre class="example">    PROTECT(ans = coerceVector(eval(expr, rho), REALSXP));
    PROTECT(gradient = allocMatrix(REALSXP, LENGTH(ans), LENGTH(theta)));
    rgr = REAL(gradient); rans = REAL(ans);
</pre><pre class="example">
</pre><pre class="example">    for(i = 0, start = 0; i &lt; LENGTH(theta); i++, start += LENGTH(ans)) {
        PROTECT(par = findVar(install(CHAR(STRING_ELT(theta, i))), rho));
        tt = REAL(par)[0];
        xx = fabs(tt);
        delta = (xx &lt; 1) ? eps : xx*eps;
        REAL(par)[0] += delta;
        PROTECT(ans1 = coerceVector(eval(expr, rho), REALSXP));
        for(j = 0; j &lt; LENGTH(ans); j++)
            rgr[j + start] = (REAL(ans1)[j] - rans[j])/delta;
        REAL(par)[0] = tt;
        UNPROTECT(2); /* par, ans1 */
    }
</pre><pre class="example">
</pre><pre class="example">    PROTECT(dimnames = allocVector(VECSXP, 2));
    SET_VECTOR_ELT(dimnames, 1,  theta);
    dimnamesgets(gradient, dimnames);
    setAttrib(ans, install(&quot;gradient&quot;), gradient);
    UNPROTECT(3); /* ans  gradient  dimnames */
    return ans;
}
</pre></td></tr></table>

<p>The code to handle the arguments is
</p>
<table><tr><td>&nbsp;</td><td><pre class="example">    expr = CADR(args);
    if(!isString(theta = CADDR(args)))
        error(&quot;theta should be of type character&quot;);
    if(!isEnvironment(rho = CADDDR(args)))
        error(&quot;rho should be an environment&quot;);
</pre></td></tr></table>

<p>Note that we check for correct types of <code>theta</code> and <code>rho</code> but
do not check the type of <code>expr</code>.  That is because <code>eval</code> can
handle many types of R objects other than <code>EXPRSXP</code>.  There is
no useful coercion we can do, so we stop with an error message if the
arguments are not of the correct mode.
</p>
<p>The first step in the code is to evaluate the expression in the
environment <code>rho</code>, by
</p>
<table><tr><td>&nbsp;</td><td><pre class="example">    PROTECT(ans = coerceVector(eval(expr, rho), REALSXP));
</pre></td></tr></table>

<p>We then allocate space for the calculated derivative by
</p>
<table><tr><td>&nbsp;</td><td><pre class="example">    PROTECT(gradient = allocMatrix(REALSXP, LENGTH(ans), LENGTH(theta)));
</pre></td></tr></table>

<p>The first argument to <code>allocMatrix</code> gives the <code>SEXPTYPE</code> of
the matrix: here we want it to be <code>REALSXP</code>.  The other two
arguments are the numbers of rows and columns.
</p>
<table><tr><td>&nbsp;</td><td><pre class="example">    for(i = 0, start = 0; i &lt; LENGTH(theta); i++, start += LENGTH(ans)) {
        PROTECT(par = findVar(install(CHAR(STRING_ELT(theta, i))), rho));
</pre></td></tr></table>

<p>Here, we are entering a for loop.  We loop through each of the
variables.  In the <code>for</code> loop, we first create a symbol
corresponding to the <code>i</code>&rsquo;th element of the <code>STRSXP</code>
<code>theta</code>.  Here, <code>STRING_ELT(theta, i)</code> accesses the
<code>i</code>&rsquo;th element of the <code>STRSXP</code> <code>theta</code>.  Macro
<code>CHAR()</code> extracts the actual character
representation<a name="DOCF71" href="#FOOT71">(71)</a> of it: it returns a pointer.  We then
install the name and use <code>findVar</code> to find its value.
</p>
<table><tr><td>&nbsp;</td><td><pre class="example">        tt = REAL(par)[0];
        xx = fabs(tt);
        delta = (xx &lt; 1) ? eps : xx*eps;
        REAL(par)[0] += delta;
        PROTECT(ans1 = coerceVector(eval(expr, rho), REALSXP));
</pre></td></tr></table>

<p>We first extract the real value of the parameter, then calculate
<code>delta</code>, the increment to be used for approximating the numerical
derivative.  Then we change the value stored in <code>par</code> (in
environment <code>rho</code>) by <code>delta</code> and evaluate <code>expr</code> in
environment <code>rho</code> again.  Because we are directly dealing with
original R memory locations here, R does the evaluation for the
changed parameter value.
</p>
<table><tr><td>&nbsp;</td><td><pre class="example">        for(j = 0; j &lt; LENGTH(ans); j++)
            rgr[j + start] = (REAL(ans1)[j] - rans[j])/delta;
        REAL(par)[0] = tt;
        UNPROTECT(2);
    }
</pre></td></tr></table>

<p>Now, we compute the <code>i</code>&rsquo;th column of the gradient matrix.  Note how
it is accessed: R stores matrices by column (like FORTRAN).
</p>
<table><tr><td>&nbsp;</td><td><pre class="example">    PROTECT(dimnames = allocVector(VECSXP, 2));
    SET_VECTOR_ELT(dimnames, 1, theta);
    dimnamesgets(gradient, dimnames);
    setAttrib(ans, install(&quot;gradient&quot;), gradient);
    UNPROTECT(3);
    return ans;
}
</pre></td></tr></table>

<p>First we add column names to the gradient matrix.  This is done by
allocating a list (a <code>VECSXP</code>) whose first element, the row names,
is <code>NULL</code> (the default) and the second element, the column names,
is set as <code>theta</code>.  This list is then assigned as the attribute
having the symbol <code>R_DimNamesSymbol</code>.  Finally we set the gradient
matrix as the gradient attribute of <code>ans</code>, unprotect the remaining
protected locations and return the answer <code>ans</code>.
</p>
<hr size="6">
<a name="Parsing-R-code-from-C"></a>
<table cellpadding="1" cellspacing="1" border="0">
<tr><td valign="middle" align="left">[<a href="#Calculating-numerical-derivatives" title="Previous section in reading order"> &lt; </a>]</td>
<td valign="middle" align="left">[<a href="#Accessing-source-references" title="Next section in reading order"> &gt; </a>]</td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left">[<a href="#System-and-foreign-language-interfaces" title="Beginning of this chapter or previous chapter"> &lt;&lt; </a>]</td>
<td valign="middle" align="left">[<a href="#System-and-foreign-language-interfaces" title="Up section"> Up </a>]</td>
<td valign="middle" align="left">[<a href="#The-R-API" title="Next chapter"> &gt;&gt; </a>]</td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left">[<a href="#Top" title="Cover (top) of document">Top</a>]</td>
<td valign="middle" align="left">[<a href="#SEC_Contents" title="Table of contents">Contents</a>]</td>
<td valign="middle" align="left">[<a href="#Function-and-variable-index" title="Index">Index</a>]</td>
<td valign="middle" align="left">[<a href="#SEC_About" title="About (help)"> ? </a>]</td>
</tr></table>
<a name="Parsing-R-code-from-C-1"></a>
<h2 class="section">5.12 Parsing R code from C</h2>
<a name="index-Parsing-R-code-from-C"></a>

<p>Suppose an R extension want to accept an R expression from the
user and evaluate it.  The previous section covered evaluation, but the
expression will be entered as text and needs to be parsed first.  A
small part of R&rsquo;s parse interface is declared in header file
&lsquo;<tt>R_ext/Parse.h</tt>&rsquo;<a name="DOCF72" href="#FOOT72">(72)</a>.
</p>
<p>An example of the usage can be found in the (example) Windows package
<strong>windlgs</strong> included in the R source tree.  The essential part is
</p>
<table><tr><td>&nbsp;</td><td><pre class="example">#include &lt;R.h&gt;
#include &lt;Rinternals.h&gt;
#include &lt;R_ext/Parse.h&gt;

SEXP menu_ttest3()
{
    char cmd[256];
    SEXP cmdSexp, cmdexpr, ans = R_NilValue;
    ParseStatus status;
   ...
    if(done == 1) {
        PROTECT(cmdSexp = allocVector(STRSXP, 1));
        SET_STRING_ELT(cmdSexp, 0, mkChar(cmd));
        cmdexpr = PROTECT(R_ParseVector(cmdSexp, -1, &amp;status, R_NilValue));
        if (status != PARSE_OK) {
            UNPROTECT(2);
            error(&quot;invalid call %s&quot;, cmd);
        }
        /* Loop is needed here as EXPSEXP will be of length &gt; 1 */
        for(int i = 0; i &lt; length(cmdexpr); i++)
            ans = eval(VECTOR_ELT(cmdexpr, i), R_GlobalEnv);
        UNPROTECT(2);
    }
    return ans;
}
</pre></td></tr></table>
<p>Note that a single line of text may give rise to more than one R
expression.
</p>
<a name="index-R_005fParseVector"></a>
<p><code>R_ParseVector</code> is essentially the code used to implement
<code>parse(text=)</code> at R level.  The first argument is a character
vector (corresponding to <code>text</code>) and the second the maximal
number of expressions to parse (corresponding to <code>n</code>).  The third
argument is a pointer to a variable of an enumeration type, and it is
normal (as <code>parse</code> does) to regard all values other than
<code>PARSE_OK</code> as an error.  Other values which might be returned are
<code>PARSE_INCOMPLETE</code> (an incomplete expression was found) and
<code>PARSE_ERROR</code> (a syntax error), in both cases the value returned
being <code>R_NilValue</code>. The fourth argument is a length one character
vector to be used as a filename in error messages, a <code>srcfile</code>
object or the R <code>NULL</code> object (as in the example above). If a
<code>srcfile</code> object was used, a <code>srcref</code> attribute would be
attached to the result, containing a list of <code>srcref</code> objects of
the same length as the expression, to allow it to be echoed with its
original formatting.
</p>
<table class="menu" border="0" cellspacing="0">
<tr><td align="left" valign="top"><a href="#Accessing-source-references">5.12.1 Accessing source references</a></td><td>&nbsp;&nbsp;</td><td align="left" valign="top">  
</td></tr>
</table>

<hr size="6">
<a name="Accessing-source-references"></a>
<table cellpadding="1" cellspacing="1" border="0">
<tr><td valign="middle" align="left">[<a href="#Parsing-R-code-from-C" title="Previous section in reading order"> &lt; </a>]</td>
<td valign="middle" align="left">[<a href="#External-pointers-and-weak-references" title="Next section in reading order"> &gt; </a>]</td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left">[<a href="#System-and-foreign-language-interfaces" title="Beginning of this chapter or previous chapter"> &lt;&lt; </a>]</td>
<td valign="middle" align="left">[<a href="#Parsing-R-code-from-C" title="Up section"> Up </a>]</td>
<td valign="middle" align="left">[<a href="#The-R-API" title="Next chapter"> &gt;&gt; </a>]</td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left">[<a href="#Top" title="Cover (top) of document">Top</a>]</td>
<td valign="middle" align="left">[<a href="#SEC_Contents" title="Table of contents">Contents</a>]</td>
<td valign="middle" align="left">[<a href="#Function-and-variable-index" title="Index">Index</a>]</td>
<td valign="middle" align="left">[<a href="#SEC_About" title="About (help)"> ? </a>]</td>
</tr></table>
<a name="Accessing-source-references-1"></a>
<h3 class="subsection">5.12.1 Accessing source references</h3>

<p>The source references added by the parser are recorded by R&rsquo;s evaluator 
as it evaluates code. Two functions
make these available to debuggers running C code:
<a name="index-R_005fSrcref"></a>
<a name="index-R_005fGetCurrentSrcref"></a>
<a name="index-R_005fGetSrcFilename"></a>
</p>
<table><tr><td>&nbsp;</td><td><pre class="example">SEXP R_GetCurrentSrcref(int skip);
</pre></td></tr></table>

<p>This function checks <code>R_Srcref</code> and the current evaluation stack
for entries that contain source reference information.  The
<code>skip</code> argument tells how many source references to skip before
returning the <code>SEXP</code> of the <code>srcref</code> object, counting from
the top of the stack.  If <code>skip &lt; 0</code>, <code>abs(skip)</code> locations
are counted up from the bottom of the stack. If too few or no source
references are found, <code>NULL</code> is returned.
</p>
<table><tr><td>&nbsp;</td><td><pre class="example">SEXP R_GetSrcFilename(SEXP srcref);
</pre></td></tr></table>

<p>This function extracts the filename from the source reference for
display, returning a length 1 character vector containing the
filename.  If no name is found, <code>&quot;&quot;</code> is returned.
</p>
<hr size="6">
<a name="External-pointers-and-weak-references"></a>
<table cellpadding="1" cellspacing="1" border="0">
<tr><td valign="middle" align="left">[<a href="#Accessing-source-references" title="Previous section in reading order"> &lt; </a>]</td>
<td valign="middle" align="left">[<a href="#An-external-pointer-example" title="Next section in reading order"> &gt; </a>]</td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left">[<a href="#System-and-foreign-language-interfaces" title="Beginning of this chapter or previous chapter"> &lt;&lt; </a>]</td>
<td valign="middle" align="left">[<a href="#System-and-foreign-language-interfaces" title="Up section"> Up </a>]</td>
<td valign="middle" align="left">[<a href="#The-R-API" title="Next chapter"> &gt;&gt; </a>]</td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left">[<a href="#Top" title="Cover (top) of document">Top</a>]</td>
<td valign="middle" align="left">[<a href="#SEC_Contents" title="Table of contents">Contents</a>]</td>
<td valign="middle" align="left">[<a href="#Function-and-variable-index" title="Index">Index</a>]</td>
<td valign="middle" align="left">[<a href="#SEC_About" title="About (help)"> ? </a>]</td>
</tr></table>
<a name="External-pointers-and-weak-references-1"></a>
<h2 class="section">5.13 External pointers and weak references</h2>

<p>The <code>SEXPTYPE</code>s <code>EXTPTRSXP</code> and <code>WEAKREFSXP</code> can be
encountered at R level, but are created in C code.
</p>
<a name="index-external-pointer"></a>
<p>External pointer <code>SEXP</code>s are intended to handle references to C
structures such as &lsquo;handles&rsquo;, and are used for this purpose in package
<a href="http://CRAN.R-project.org/package=RODBC"><strong>RODBC</strong></a> for example.  They are unusual in their copying semantics in
that when an R object is copied, the external pointer object is not
duplicated.  (For this reason external pointers should only be used as
part of an object with normal semantics, for example an attribute or an
element of a list.)
</p>
<p>An external pointer is created by
</p>
<table><tr><td>&nbsp;</td><td><pre class="example">SEXP R_MakeExternalPtr(void *p, SEXP tag, SEXP prot);
</pre></td></tr></table>

<p>where <code>p</code> is the pointer (and hence this cannot portably be a
function pointer), and <code>tag</code> and <code>prot</code> are references to
ordinary R objects which will remain in existence (be protected from
garbage collection) for the lifetime of the external pointer object.  A
useful convention is to use the <code>tag</code> field for some form of type
identification and the <code>prot</code> field for protecting the memory that
the external pointer represents, if that memory is allocated from the
R heap.  Both <code>tag</code> and <code>prot</code> can be <code>R_NilValue</code>,
and often are.
</p>
<p>The elements of an external pointer can be accessed and set <em>via</em>
</p>
<table><tr><td>&nbsp;</td><td><pre class="example">void *R_ExternalPtrAddr(SEXP s);
SEXP R_ExternalPtrTag(SEXP s);
SEXP R_ExternalPtrProtected(SEXP s);
void R_ClearExternalPtr(SEXP s);
void R_SetExternalPtrAddr(SEXP s, void *p);
void R_SetExternalPtrTag(SEXP s, SEXP tag);
void R_SetExternalPtrProtected(SEXP s, SEXP p);
</pre></td></tr></table>

<p>Clearing a pointer sets its value to the C <code>NULL</code> pointer.
</p>
<a name="index-finalizer"></a>
<p>An external pointer object can have a <em>finalizer</em>, a piece of code
to be run when the object is garbage collected.  This can be R code
or C code, and the various interfaces are, respectively.
</p>
<table><tr><td>&nbsp;</td><td><pre class="example">void R_RegisterFinalizerEx(SEXP s, SEXP fun, Rboolean onexit);

typedef void (*R_CFinalizer_t)(SEXP);
void R_RegisterCFinalizerEx(SEXP s, R_CFinalizer_t fun, Rboolean onexit);
</pre></td></tr></table>

<p>The R function indicated by <code>fun</code> should be a function of a
single argument, the object to be finalized.  R does not perform a
garbage collection when shutting down, and the <code>onexit</code> argument of
the extended forms can be used to ask that the finalizer be run during a
normal shutdown of the R session.  It is suggested that it is good
practice to clear the pointer on finalization.
</p>
<p>The only R level function for interacting with external pointers is
<code>reg.finalizer</code> which can be used to set a finalizer.
</p>
<p>It is probably not a good idea to allow an external pointer to be
<code>save</code>d and then reloaded, but if this happens the pointer will be
set to the C <code>NULL</code> pointer.
</p>

<a name="index-weak-reference"></a>
<p>Weak references are used to allow the programmer to maintain information
on entities without preventing the garbage collection of the entities
once they become unreachable.
</p>
<p>A weak reference contains a key and a value.  The value is reachable is
if it either reachable directly or <em>via</em> weak references with reachable
keys.  Once a value is determined to be unreachable during garbage
collection, the key and value are set to <code>R_NilValue</code> and the
finalizer will be run later in the garbage collection.
</p>
<p>Weak reference objects are created by one of
</p>
<table><tr><td>&nbsp;</td><td><pre class="example">SEXP R_MakeWeakRef(SEXP key, SEXP val, SEXP fin, Rboolean onexit);
SEXP R_MakeWeakRefC(SEXP key, SEXP val, R_CFinalizer_t fin,
                    Rboolean onexit);
</pre></td></tr></table>

<p>where the R or C finalizer are specified in exactly the same way as
for an external pointer object (whose finalization interface is
implemented <em>via</em> weak references).
</p>
<p>The parts can be accessed <em>via</em>
</p>
<table><tr><td>&nbsp;</td><td><pre class="example">SEXP R_WeakRefKey(SEXP w);
SEXP R_WeakRefValue(SEXP w);
void R_RunWeakRefFinalizer(SEXP w);
</pre></td></tr></table>

<p>A toy example of the use of weak references can be found at
<a href="http://www.stat.uiowa.edu/~luke/R/references/weakfinex.html"><code>www.stat.uiowa.edu/~luke/R/references/weakfinex.html</code></a>,
but that is used to add finalizers to external pointers which can now be
done more directly.  At the time of writing no <acronym>CRAN</acronym> or
Bioconductor package uses weak references.
</p>

<table class="menu" border="0" cellspacing="0">
<tr><td align="left" valign="top"><a href="#An-external-pointer-example">5.13.1 An example</a></td><td>&nbsp;&nbsp;</td><td align="left" valign="top">  
</td></tr>
</table>

<hr size="6">
<a name="An-external-pointer-example"></a>
<table cellpadding="1" cellspacing="1" border="0">
<tr><td valign="middle" align="left">[<a href="#External-pointers-and-weak-references" title="Previous section in reading order"> &lt; </a>]</td>
<td valign="middle" align="left">[<a href="#Vector-accessor-functions" title="Next section in reading order"> &gt; </a>]</td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left">[<a href="#System-and-foreign-language-interfaces" title="Beginning of this chapter or previous chapter"> &lt;&lt; </a>]</td>
<td valign="middle" align="left">[<a href="#External-pointers-and-weak-references" title="Up section"> Up </a>]</td>
<td valign="middle" align="left">[<a href="#The-R-API" title="Next chapter"> &gt;&gt; </a>]</td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left">[<a href="#Top" title="Cover (top) of document">Top</a>]</td>
<td valign="middle" align="left">[<a href="#SEC_Contents" title="Table of contents">Contents</a>]</td>
<td valign="middle" align="left">[<a href="#Function-and-variable-index" title="Index">Index</a>]</td>
<td valign="middle" align="left">[<a href="#SEC_About" title="About (help)"> ? </a>]</td>
</tr></table>
<a name="An-example-1"></a>
<h3 class="subsection">5.13.1 An example</h3>

<p>Package <a href="http://CRAN.R-project.org/package=RODBC"><strong>RODBC</strong></a> uses external pointers to maintain its
<em>channels</em>, connections to databases.  There can be several
connections open at once, and the status information for each is stored
in a C structure (pointed to by <code>this_handle</code>) in the code extract
below) that is returned <em>via</em> an external pointer as part of the RODBC
&lsquo;channel&rsquo; (as the <code>&quot;handle_ptr&quot;</code> attribute).  The external pointer
is created by
</p>
<table><tr><td>&nbsp;</td><td><pre class="example">    SEXP ans, ptr;
    PROTECT(ans = allocVector(INTSXP, 1));
    ptr = R_MakeExternalPtr(thisHandle, install(&quot;RODBC_channel&quot;), R_NilValue);
    PROTECT(ptr);
    R_RegisterCFinalizerEx(ptr, chanFinalizer, TRUE);
            ...
    /* return the channel no */
    INTEGER(ans)[0] = nChannels;
    /* and the connection string as an attribute */
    setAttrib(ans, install(&quot;connection.string&quot;), constr);
    setAttrib(ans, install(&quot;handle_ptr&quot;), ptr);
    UNPROTECT(3);
    return ans;
</pre></td></tr></table>

<p>Note the symbol given to identify the usage of the external pointer, and
the use of the finalizer.  Since the final argument when registering the
finalizer is <code>TRUE</code>, the finalizer will be run at the the of the
R session (unless it crashes).  This is used to close and clean up
the connection to the database.  The finalizer code is simply
</p>
<table><tr><td>&nbsp;</td><td><pre class="example">static void chanFinalizer(SEXP ptr)
{
    if(!R_ExternalPtrAddr(ptr)) return;
    inRODBCClose(R_ExternalPtrAddr(ptr));
    R_ClearExternalPtr(ptr); /* not really needed */
}
</pre></td></tr></table>

<p>Clearing the pointer and checking for a <code>NULL</code> pointer avoids any
possibility of attempting to close an already-closed channel.
</p>
<p>R&rsquo;s connections provide another example of using external pointers,
in that case purely to be able to use a finalizer to close and destroy the
connection if it is no longer is use.
</p>
<hr size="6">
<a name="Vector-accessor-functions"></a>
<table cellpadding="1" cellspacing="1" border="0">
<tr><td valign="middle" align="left">[<a href="#An-external-pointer-example" title="Previous section in reading order"> &lt; </a>]</td>
<td valign="middle" align="left">[<a href="#Character-encoding-issues" title="Next section in reading order"> &gt; </a>]</td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left">[<a href="#System-and-foreign-language-interfaces" title="Beginning of this chapter or previous chapter"> &lt;&lt; </a>]</td>
<td valign="middle" align="left">[<a href="#System-and-foreign-language-interfaces" title="Up section"> Up </a>]</td>
<td valign="middle" align="left">[<a href="#The-R-API" title="Next chapter"> &gt;&gt; </a>]</td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left">[<a href="#Top" title="Cover (top) of document">Top</a>]</td>
<td valign="middle" align="left">[<a href="#SEC_Contents" title="Table of contents">Contents</a>]</td>
<td valign="middle" align="left">[<a href="#Function-and-variable-index" title="Index">Index</a>]</td>
<td valign="middle" align="left">[<a href="#SEC_About" title="About (help)"> ? </a>]</td>
</tr></table>
<a name="Vector-accessor-functions-1"></a>
<h2 class="section">5.14 Vector accessor functions</h2>

<p>The vector accessors like <code>REAL</code> and <code>INTEGER</code> and
<code>VECTOR_ELT</code> are <em>functions</em> when used in R extensions.
(For efficiency they are macros when used in the R source code, apart
from <code>SET_STRING_ELT</code> and <code>SET_VECTOR_ELT</code> which are always
functions.)
</p>
<p>The accessor functions check that they are being used on an appropriate
type of <code>SEXP</code>.
</p>
<p>If efficiency is essential, the macro versions of the accessors can be
obtained by defining &lsquo;<samp>USE_RINTERNALS</samp>&rsquo; before including
&lsquo;<tt>Rinternals.h</tt>&rsquo;.  If you find it necessary to do so, please do test
that your code compiles without &lsquo;<samp>USE_RINTERNALS</samp>&rsquo; defined, as this
provides a stricter test that the accessors have been used correctly.
</p>
<hr size="6">
<a name="Character-encoding-issues"></a>
<table cellpadding="1" cellspacing="1" border="0">
<tr><td valign="middle" align="left">[<a href="#Vector-accessor-functions" title="Previous section in reading order"> &lt; </a>]</td>
<td valign="middle" align="left">[<a href="#The-R-API" title="Next section in reading order"> &gt; </a>]</td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left">[<a href="#System-and-foreign-language-interfaces" title="Beginning of this chapter or previous chapter"> &lt;&lt; </a>]</td>
<td valign="middle" align="left">[<a href="#System-and-foreign-language-interfaces" title="Up section"> Up </a>]</td>
<td valign="middle" align="left">[<a href="#The-R-API" title="Next chapter"> &gt;&gt; </a>]</td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left">[<a href="#Top" title="Cover (top) of document">Top</a>]</td>
<td valign="middle" align="left">[<a href="#SEC_Contents" title="Table of contents">Contents</a>]</td>
<td valign="middle" align="left">[<a href="#Function-and-variable-index" title="Index">Index</a>]</td>
<td valign="middle" align="left">[<a href="#SEC_About" title="About (help)"> ? </a>]</td>
</tr></table>
<a name="Character-encoding-issues-1"></a>
<h2 class="section">5.15 Character encoding issues</h2>

<a name="index-translateChar"></a>
<a name="index-translateCharUTF8"></a>
<p><code>CHARSXP</code>s can be marked as coming from a known encoding (Latin-1
or UTF-8).  This is mainly intended for human-readable output, and most
packages can just treat such <code>CHARSXP</code>s as a whole.  However, if
they need to be interpreted as characters or output at C level then it
would normally be correct to ensure that they are converted to the
encoding of the current locale: this can be done by accessing the data
in the <code>CHARSXP</code> by <code>translateChar</code> rather than by
<code>CHAR</code>.  If re-encoding is needed this allocates memory with
<code>R_alloc</code> which thus persists to the end of the
<code>.Call</code>/<code>.External</code> call unless <code>vmaxset</code> is used.
</p>
<p>There is a similar function <code>translateCharUTF8</code> which converts to
UTF-8: this has the advantage that a faithful translation is almost
always possible (whereas only a few languages can be represented in the
encoding of the current locale unless that is UTF-8).
</p>
<a name="index-getCharCE"></a>
<a name="index-mkCharCE"></a>
<p>There is a public interface to the encoding marked on <code>CHARXSXPs</code>
<em>via</em>
</p>
<table><tr><td>&nbsp;</td><td><pre class="example">typedef enum {CE_NATIVE, CE_UTF8, CE_LATIN1, CE_SYMBOL, CE_ANY} cetype_t;
cetype_t getCharCE(SEXP);
SEXP mkCharCE(const char *, cetype_t);
</pre></td></tr></table>

<p>Only <code>CE_UTF8</code> and <code>CE_LATIN1</code> are marked on <code>CHARSXPs</code>
(and so <code>Rf_getCharCE</code> will only return one of the first three),
and these should only be used on non-<acronym>ASCII</acronym> strings.  Value
<code>CE_SYMBOL</code> is used internally to indicate Adobe Symbol encoding.
Value <code>CE_ANY</code> is used to indicate a character string that will not
need re-encoding &ndash; this is used for character strings known to be in
<acronym>ASCII</acronym>, and can also be used as an input parameter where the
intention is that the string is treated as a series of bytes.  (See the
comments under <code>mkChar</code> about the length of input allowed.)
</p>
<p>Function
</p>
<a name="index-reEnc"></a>
<table><tr><td>&nbsp;</td><td><pre class="example">const char *reEnc(const char *x, cetype_t ce_in, cetype_t ce_out,
                  int subst);
</pre></td></tr></table>

<p>can be used to re-encode character strings: like <code>translateChar</code> it
returns a string allocated by <code>R_alloc</code>.  This can translate from
<code>CE_SYMBOL</code> to <code>CE_UTF8</code>, but not conversely.  Argument
<code>subst</code> controls what to do with untranslatable characters or
invalid input: this is done byte-by-byte with <code>1</code> indicates to
output hex of the form <code>&lt;a0&gt;</code>, and <code>2</code> to replace by <code>.</code>,
with any other value causing the byte to produce no output.
</p>
<a name="index-mkCharLenCE"></a>
<p>There is also
</p>
<table><tr><td>&nbsp;</td><td><pre class="example">SEXP mkCharLenCE(const char *, size_t, cetype_t);
</pre></td></tr></table>

<p>to create marked character strings of a given length.
</p>

<hr size="6">
<a name="The-R-API"></a>
<table cellpadding="1" cellspacing="1" border="0">
<tr><td valign="middle" align="left">[<a href="#Character-encoding-issues" title="Previous section in reading order"> &lt; </a>]</td>
<td valign="middle" align="left">[<a href="#Memory-allocation" title="Next section in reading order"> &gt; </a>]</td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left">[<a href="#System-and-foreign-language-interfaces" title="Beginning of this chapter or previous chapter"> &lt;&lt; </a>]</td>
<td valign="middle" align="left">[<a href="#Top" title="Up section"> Up </a>]</td>
<td valign="middle" align="left">[<a href="#Generic-functions-and-methods" title="Next chapter"> &gt;&gt; </a>]</td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left">[<a href="#Top" title="Cover (top) of document">Top</a>]</td>
<td valign="middle" align="left">[<a href="#SEC_Contents" title="Table of contents">Contents</a>]</td>
<td valign="middle" align="left">[<a href="#Function-and-variable-index" title="Index">Index</a>]</td>
<td valign="middle" align="left">[<a href="#SEC_About" title="About (help)"> ? </a>]</td>
</tr></table>
<a name="The-R-API_003a-entry-points-for-C-code"></a>
<h1 class="chapter">6. The R <acronym>API</acronym>: entry points for C code</h1>

<table class="menu" border="0" cellspacing="0">
<tr><td align="left" valign="top"><a href="#Memory-allocation">6.1 Memory allocation</a></td><td>&nbsp;&nbsp;</td><td align="left" valign="top">           
</td></tr>
<tr><td align="left" valign="top"><a href="#Error-handling">6.2 Error handling</a></td><td>&nbsp;&nbsp;</td><td align="left" valign="top">              
</td></tr>
<tr><td align="left" valign="top"><a href="#Random-numbers">6.3 Random number generation</a></td><td>&nbsp;&nbsp;</td><td align="left" valign="top">              
</td></tr>
<tr><td align="left" valign="top"><a href="#Missing-and-IEEE-values">6.4 Missing and <acronym>IEEE</acronym> special values</a></td><td>&nbsp;&nbsp;</td><td align="left" valign="top">     
</td></tr>
<tr><td align="left" valign="top"><a href="#Printing">6.5 Printing</a></td><td>&nbsp;&nbsp;</td><td align="left" valign="top">                    
</td></tr>
<tr><td align="left" valign="top"><a href="#Calling-C-from-FORTRAN-and-vice-versa">6.6 Calling C from FORTRAN and vice versa</a></td><td>&nbsp;&nbsp;</td><td align="left" valign="top">  
</td></tr>
<tr><td align="left" valign="top"><a href="#Numerical-analysis-subroutines">6.7 Numerical analysis subroutines</a></td><td>&nbsp;&nbsp;</td><td align="left" valign="top">  
</td></tr>
<tr><td align="left" valign="top"><a href="#Optimization">6.8 Optimization</a></td><td>&nbsp;&nbsp;</td><td align="left" valign="top">                
</td></tr>
<tr><td align="left" valign="top"><a href="#Integration">6.9 Integration</a></td><td>&nbsp;&nbsp;</td><td align="left" valign="top">                 
</td></tr>
<tr><td align="left" valign="top"><a href="#Utility-functions">6.10 Utility functions</a></td><td>&nbsp;&nbsp;</td><td align="left" valign="top">           
</td></tr>
<tr><td align="left" valign="top"><a href="#Re_002dencoding">6.11 Re-encoding</a></td><td>&nbsp;&nbsp;</td><td align="left" valign="top">                 
</td></tr>
<tr><td align="left" valign="top"><a href="#Allowing-interrupts">6.12 Allowing interrupts</a></td><td>&nbsp;&nbsp;</td><td align="left" valign="top">         
</td></tr>
<tr><td align="left" valign="top"><a href="#Platform-and-version-information">6.13 Platform and version information</a></td><td>&nbsp;&nbsp;</td><td align="left" valign="top">  
</td></tr>
<tr><td align="left" valign="top"><a href="#Inlining-C-functions">6.14 Inlining C functions</a></td><td>&nbsp;&nbsp;</td><td align="left" valign="top">        
</td></tr>
<tr><td align="left" valign="top"><a href="#Controlling-visibility">6.15 Controlling visibility</a></td><td>&nbsp;&nbsp;</td><td align="left" valign="top">      
</td></tr>
<tr><td align="left" valign="top"><a href="#Standalone-Mathlib">6.16 Using these functions in your own C code</a></td><td>&nbsp;&nbsp;</td><td align="left" valign="top">          
</td></tr>
<tr><td align="left" valign="top"><a href="#Organization-of-header-files">6.17 Organization of header files</a></td><td>&nbsp;&nbsp;</td><td align="left" valign="top">  
</td></tr>
</table>

<p>There are a large number of entry points in the R executable/DLL that
can be called from C code (and some that can be called from FORTRAN
code).  Only those documented here are stable enough that they will only
be changed with considerable notice.
</p>
<p>The recommended procedure to use these is to include the header file
&lsquo;<tt>R.h</tt>&rsquo; in your C code by
</p>
<table><tr><td>&nbsp;</td><td><pre class="example">#include &lt;R.h&gt;
</pre></td></tr></table>

<p>This will include several other header files from the directory
&lsquo;<tt><var>R_INCLUDE_DIR</var>/R_ext</tt>&rsquo;, and there are other header files
there that can be included too, but many of the features they contain
should be regarded as undocumented and unstable.
</p>
<p>An alternative is to include the header file &lsquo;<tt>S.h</tt>&rsquo;, which may be
useful when porting code from S.  This includes rather less than
&lsquo;<tt>R.h</tt>&rsquo;, and has some extra compatibility definitions (for example
the <code>S_complex</code> type from S).
</p>
<p>The defines used for compatibility with S sometimes causes
conflicts (notably with Windows headers), and the known
problematic defines can be removed by defining <code>STRICT_R_HEADERS</code>.
</p>
<p>Most of these header files, including all those included by &lsquo;<tt>R.h</tt>&rsquo;,
can be used from C++ code.  Some others need to be included within an
<code>extern &quot;C&quot;</code> declaration, and for clarity this is advisable for all
R header files.
</p>
<blockquote><p><b>Note:</b> Because R re-maps many of its external names to avoid clashes with
user code, it is <em>essential</em> to include the appropriate header
files when using these entry points.
</p></blockquote>

<p>This remapping can cause problems<a name="DOCF73" href="#FOOT73">(73)</a>, and can
be eliminated by defining <code>R_NO_REMAP</code> and prepending &lsquo;<samp>Rf_</samp>&rsquo; to
<em>all</em> the function names used from &lsquo;<tt>Rinternals.h</tt>&rsquo; and
&lsquo;<tt>R_ext/Error.h</tt>&rsquo;.
</p>
<p>We can classify the entry points as
</p>
<dl compact="compact">
<dt> <em>API</em></dt>
<dd><p>Entry points which are documented in this manual and declared in an
installed header file.  These can be used in distributed packages and
will only be changed after deprecation.
</p>
</dd>
<dt> <em>public</em></dt>
<dd><p>Entry points declared in an installed header file that are exported
on all R platforms but are not documented and subject to change
without notice.
</p>
</dd>
<dt> <em>private</em></dt>
<dd><p>Entry points that are used when building R and exported on all R
platforms but are not declared in the installed header files.
Do not use these in distributed code.
</p>
</dd>
<dt> <em>hidden</em></dt>
<dd><p>Entry points that are where possible (Windows and some modern Unix-alike
compilers/loaders when using R as a shared library) not exported.
</p></dd>
</dl>

<hr size="6">
<a name="Memory-allocation"></a>
<table cellpadding="1" cellspacing="1" border="0">
<tr><td valign="middle" align="left">[<a href="#The-R-API" title="Previous section in reading order"> &lt; </a>]</td>
<td valign="middle" align="left">[<a href="#Transient" title="Next section in reading order"> &gt; </a>]</td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left">[<a href="#The-R-API" title="Beginning of this chapter or previous chapter"> &lt;&lt; </a>]</td>
<td valign="middle" align="left">[<a href="#The-R-API" title="Up section"> Up </a>]</td>
<td valign="middle" align="left">[<a href="#Generic-functions-and-methods" title="Next chapter"> &gt;&gt; </a>]</td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left">[<a href="#Top" title="Cover (top) of document">Top</a>]</td>
<td valign="middle" align="left">[<a href="#SEC_Contents" title="Table of contents">Contents</a>]</td>
<td valign="middle" align="left">[<a href="#Function-and-variable-index" title="Index">Index</a>]</td>
<td valign="middle" align="left">[<a href="#SEC_About" title="About (help)"> ? </a>]</td>
</tr></table>
<a name="Memory-allocation-1"></a>
<h2 class="section">6.1 Memory allocation</h2>
<a name="index-Memory-allocation-from-C"></a>

<table class="menu" border="0" cellspacing="0">
<tr><td align="left" valign="top"><a href="#Transient">6.1.1 Transient storage allocation</a></td><td>&nbsp;&nbsp;</td><td align="left" valign="top">                   
</td></tr>
<tr><td align="left" valign="top"><a href="#User_002dcontrolled">6.1.2 User-controlled memory</a></td><td>&nbsp;&nbsp;</td><td align="left" valign="top">             
</td></tr>
</table>

<p>There are two types of memory allocation available to the C programmer,
one in which R manages the clean-up and the other in which user
has full control (and responsibility).
</p>
<hr size="6">
<a name="Transient"></a>
<table cellpadding="1" cellspacing="1" border="0">
<tr><td valign="middle" align="left">[<a href="#Memory-allocation" title="Previous section in reading order"> &lt; </a>]</td>
<td valign="middle" align="left">[<a href="#User_002dcontrolled" title="Next section in reading order"> &gt; </a>]</td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left">[<a href="#The-R-API" title="Beginning of this chapter or previous chapter"> &lt;&lt; </a>]</td>
<td valign="middle" align="left">[<a href="#Memory-allocation" title="Up section"> Up </a>]</td>
<td valign="middle" align="left">[<a href="#Generic-functions-and-methods" title="Next chapter"> &gt;&gt; </a>]</td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left">[<a href="#Top" title="Cover (top) of document">Top</a>]</td>
<td valign="middle" align="left">[<a href="#SEC_Contents" title="Table of contents">Contents</a>]</td>
<td valign="middle" align="left">[<a href="#Function-and-variable-index" title="Index">Index</a>]</td>
<td valign="middle" align="left">[<a href="#SEC_About" title="About (help)"> ? </a>]</td>
</tr></table>
<a name="Transient-storage-allocation"></a>
<h3 class="subsection">6.1.1 Transient storage allocation</h3>
<a name="index-R_005falloc"></a>
<a name="index-S_005falloc"></a>
<a name="index-S_005frealloc"></a>
<a name="index-vmaxget"></a>
<a name="index-vmaxset"></a>

<p>Here R will reclaim the memory at the end of the call to <code>.C</code>.
Use
</p>
<table><tr><td>&nbsp;</td><td><pre class="example">char *R_alloc(size_t <var>n</var>, int <var>size</var>)
</pre></td></tr></table>

<p>which allocates <var>n</var> units of <var>size</var> bytes each.  A typical usage
(from package <strong>stats</strong>) is
</p>
<table><tr><td>&nbsp;</td><td><pre class="example">x = (int *) R_alloc(nrows(merge)+2, sizeof(int));
</pre></td></tr></table>

<p>(<code>size_t</code> is defined in &lsquo;<tt>stddef.h</tt>&rsquo; which the header defining
<code>R_alloc</code> includes.)
</p>
<p>There is a similar call, <code>S_alloc</code> (for compatibility with older
versions of S) which zeroes the memory allocated,
</p>
<table><tr><td>&nbsp;</td><td><pre class="example">char *S_alloc(long <var>n</var>, int <var>size</var>)
</pre></td></tr></table>

<p>and
</p>
<table><tr><td>&nbsp;</td><td><pre class="example">char *S_realloc(char *<var>p</var>, long <var>new</var>, long <var>old</var>, int <var>size</var>)
</pre></td></tr></table>

<p>which changes the allocation size from <var>old</var> to <var>new</var> units, and
zeroes the additional units.
</p>
<p>For compatibility with current versions of S, header &lsquo;<tt>S.h</tt>&rsquo;
(only) defines wrapper macros equivalent to
</p>
<table><tr><td>&nbsp;</td><td><pre class="example">type* Salloc(long <var>n</var>, int <var>type</var>)
type* Srealloc(char *<var>p</var>, long <var>new</var>, long <var>old</var>, int <var>type</var>)
</pre></td></tr></table>

<p>This memory is taken from the heap, and released at the end of the
<code>.C</code>, <code>.Call</code> or <code>.External</code> call.  Users can also manage
it, by noting the current position with a call to <code>vmaxget</code> and
clearing memory allocated subsequently by a call to <code>vmaxset</code>.
This is only recommended for experts.
</p>
<p>Note that this memory will be freed on error or user interrupt
(if allowed: see section <a href="#Allowing-interrupts">Allowing interrupts</a>).
</p>
<p>Note that although <var>n</var> is <code>long</code>, there are limits imposed by
R&rsquo;s internal allocation mechanism.  These will only come into play on
64-bit systems, where the current limit for <var>n</var> is just under 16Gb.
</p>
<hr size="6">
<a name="User_002dcontrolled"></a>
<table cellpadding="1" cellspacing="1" border="0">
<tr><td valign="middle" align="left">[<a href="#Transient" title="Previous section in reading order"> &lt; </a>]</td>
<td valign="middle" align="left">[<a href="#Error-handling" title="Next section in reading order"> &gt; </a>]</td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left">[<a href="#The-R-API" title="Beginning of this chapter or previous chapter"> &lt;&lt; </a>]</td>
<td valign="middle" align="left">[<a href="#Memory-allocation" title="Up section"> Up </a>]</td>
<td valign="middle" align="left">[<a href="#Generic-functions-and-methods" title="Next chapter"> &gt;&gt; </a>]</td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left">[<a href="#Top" title="Cover (top) of document">Top</a>]</td>
<td valign="middle" align="left">[<a href="#SEC_Contents" title="Table of contents">Contents</a>]</td>
<td valign="middle" align="left">[<a href="#Function-and-variable-index" title="Index">Index</a>]</td>
<td valign="middle" align="left">[<a href="#SEC_About" title="About (help)"> ? </a>]</td>
</tr></table>
<a name="User_002dcontrolled-memory"></a>
<h3 class="subsection">6.1.2 User-controlled memory</h3>
<a name="index-Calloc"></a>
<a name="index-Realloc"></a>
<a name="index-Free"></a>

<p>The other form of memory allocation is an interface to <code>malloc</code>,
the interface providing R error handling.  This memory lasts until
freed by the user and is additional to the memory allocated for the R
workspace.
</p>
<p>The interface functions are
</p>
<table><tr><td>&nbsp;</td><td><pre class="example"><var>type</var>* Calloc(size_t <var>n</var>, <var>type</var>)
<var>type</var>* Realloc(<var>any</var> *<var>p</var>, size_t <var>n</var>, <var>type</var>)
void Free(<var>any</var> *<var>p</var>)
</pre></td></tr></table>

<p>providing analogues of <code>calloc</code>, <code>realloc</code> and <code>free</code>.
If there is an error during allocation it is handled by R, so if
these routines return the memory has been successfully allocated or
freed.  <code>Free</code> will set the pointer <var>p</var> to <code>NULL</code>.  (Some
but not all versions of S do so.)
</p>
<p>Users should arrange to <code>Free</code> this memory when no longer needed,
including on error or user interrupt.  This can often be done most
conveniently from an <code>on.exit</code> action in the calling R function
&ndash; see <code>pwilcox</code> for an example.
</p>
<p>Do not assume that memory allocated by <code>Calloc</code>/<code>Realloc</code>
comes from the same pool as used by <code>malloc</code>: in particular do not
use <code>free</code> or <code>strdup</code> with it.
</p>
<p>These entry points need to be prefixed by <code>R_</code> if
<code>STRICT_R_HEADERS</code> has been defined.
</p>

<hr size="6">
<a name="Error-handling"></a>
<table cellpadding="1" cellspacing="1" border="0">
<tr><td valign="middle" align="left">[<a href="#User_002dcontrolled" title="Previous section in reading order"> &lt; </a>]</td>
<td valign="middle" align="left">[<a href="#Error-handling-from-FORTRAN" title="Next section in reading order"> &gt; </a>]</td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left">[<a href="#The-R-API" title="Beginning of this chapter or previous chapter"> &lt;&lt; </a>]</td>
<td valign="middle" align="left">[<a href="#The-R-API" title="Up section"> Up </a>]</td>
<td valign="middle" align="left">[<a href="#Generic-functions-and-methods" title="Next chapter"> &gt;&gt; </a>]</td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left">[<a href="#Top" title="Cover (top) of document">Top</a>]</td>
<td valign="middle" align="left">[<a href="#SEC_Contents" title="Table of contents">Contents</a>]</td>
<td valign="middle" align="left">[<a href="#Function-and-variable-index" title="Index">Index</a>]</td>
<td valign="middle" align="left">[<a href="#SEC_About" title="About (help)"> ? </a>]</td>
</tr></table>
<a name="Error-handling-1"></a>
<h2 class="section">6.2 Error handling</h2>
<a name="index-Error-handling-from-C"></a>

<p>The basic error handling routines are the equivalents of <code>stop</code> and
<code>warning</code> in R code, and use the same interface.
</p>
<table><tr><td>&nbsp;</td><td><pre class="example">void error(const char * <var>format</var>, ...);
void warning(const char * <var>format</var>, ...);
</pre></td></tr></table>

<p>These have the same call sequences as calls to <code>printf</code>, but in the
simplest case can be called with a single character string argument
giving the error message. (Don&rsquo;t do this if the string contains &lsquo;<samp>%</samp>&rsquo;
or might otherwise be interpreted as a format.)
</p>
<p>If <code>STRICT_R_HEADERS</code> is not defined there is also an
S-compatibility interface which uses calls of the form
</p>
<table><tr><td>&nbsp;</td><td><pre class="example">PROBLEM ...... ERROR
MESSAGE ...... WARN
PROBLEM ...... RECOVER(NULL_ENTRY)
MESSAGE ...... WARNING(NULL_ENTRY)
</pre></td></tr></table>

<p>the last two being the forms available in all S versions.  Here
&lsquo;<samp>......</samp>&rsquo; is a set of arguments to <code>printf</code>, so can be a string
or a format string followed by arguments separated by commas.
</p>
<table class="menu" border="0" cellspacing="0">
<tr><td align="left" valign="top"><a href="#Error-handling-from-FORTRAN">6.2.1 Error handling from FORTRAN</a></td><td>&nbsp;&nbsp;</td><td align="left" valign="top">  
</td></tr>
</table>

<hr size="6">
<a name="Error-handling-from-FORTRAN"></a>
<table cellpadding="1" cellspacing="1" border="0">
<tr><td valign="middle" align="left">[<a href="#Error-handling" title="Previous section in reading order"> &lt; </a>]</td>
<td valign="middle" align="left">[<a href="#Random-numbers" title="Next section in reading order"> &gt; </a>]</td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left">[<a href="#The-R-API" title="Beginning of this chapter or previous chapter"> &lt;&lt; </a>]</td>
<td valign="middle" align="left">[<a href="#Error-handling" title="Up section"> Up </a>]</td>
<td valign="middle" align="left">[<a href="#Generic-functions-and-methods" title="Next chapter"> &gt;&gt; </a>]</td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left">[<a href="#Top" title="Cover (top) of document">Top</a>]</td>
<td valign="middle" align="left">[<a href="#SEC_Contents" title="Table of contents">Contents</a>]</td>
<td valign="middle" align="left">[<a href="#Function-and-variable-index" title="Index">Index</a>]</td>
<td valign="middle" align="left">[<a href="#SEC_About" title="About (help)"> ? </a>]</td>
</tr></table>
<a name="Error-handling-from-FORTRAN-1"></a>
<h3 class="subsection">6.2.1 Error handling from FORTRAN</h3>
<a name="index-Error-handling-from-FORTRAN"></a>

<p>There are two interface function provided to call <code>error</code> and
<code>warning</code> from FORTRAN code, in each case with a simple character
string argument.  They are defined as
</p>
<table><tr><td>&nbsp;</td><td><pre class="example">subroutine rexit(<var>message</var>)
subroutine rwarn(<var>message</var>)
</pre></td></tr></table>

<p>Messages of more than 255 characters are truncated, with a warning.
</p>

<hr size="6">
<a name="Random-numbers"></a>
<table cellpadding="1" cellspacing="1" border="0">
<tr><td valign="middle" align="left">[<a href="#Error-handling-from-FORTRAN" title="Previous section in reading order"> &lt; </a>]</td>
<td valign="middle" align="left">[<a href="#Missing-and-IEEE-values" title="Next section in reading order"> &gt; </a>]</td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left">[<a href="#The-R-API" title="Beginning of this chapter or previous chapter"> &lt;&lt; </a>]</td>
<td valign="middle" align="left">[<a href="#The-R-API" title="Up section"> Up </a>]</td>
<td valign="middle" align="left">[<a href="#Generic-functions-and-methods" title="Next chapter"> &gt;&gt; </a>]</td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left">[<a href="#Top" title="Cover (top) of document">Top</a>]</td>
<td valign="middle" align="left">[<a href="#SEC_Contents" title="Table of contents">Contents</a>]</td>
<td valign="middle" align="left">[<a href="#Function-and-variable-index" title="Index">Index</a>]</td>
<td valign="middle" align="left">[<a href="#SEC_About" title="About (help)"> ? </a>]</td>
</tr></table>
<a name="Random-number-generation"></a>
<h2 class="section">6.3 Random number generation</h2>
<a name="index-Random-numbers-in-C"></a>
<a name="index-unif_005frand"></a>
<a name="index-norm_005frand"></a>
<a name="index-exp_005frand"></a>
<a name="index-GetRNGstate"></a>
<a name="index-PutRNGstate"></a>
<a name="index-_002eRandom_002eseed"></a>
<a name="index-seed_005fin"></a>
<a name="index-seed_005fout"></a>

<p>The interface to R&rsquo;s internal random number generation routines is
</p>
<table><tr><td>&nbsp;</td><td><pre class="example">double unif_rand();
double norm_rand();
double exp_rand();
</pre></td></tr></table>

<p>giving one uniform, normal or exponential pseudo-random variate.
However, before these are used, the user must call
</p>
<table><tr><td>&nbsp;</td><td><pre class="example">GetRNGstate();
</pre></td></tr></table>

<p>and after all the required variates have been generated, call
</p>
<table><tr><td>&nbsp;</td><td><pre class="example">PutRNGstate();
</pre></td></tr></table>

<p>These essentially read in (or create) <code>.Random.seed</code> and write it
out after use.
</p>
<p>File &lsquo;<tt>S.h</tt>&rsquo; defines <code>seed_in</code> and <code>seed_out</code> for
S-compatibility rather than <code>GetRNGstate</code> and
<code>PutRNGstate</code>.  These take a <code>long *</code> argument which is
ignored.
</p>
<p>The random number generator is private to R; there is no way to
select the kind of RNG or set the seed except by evaluating calls to the
R functions.
</p>
<p>The C code behind R&rsquo;s <code>r<var>xxx</var></code> functions can be accessed by
including the header file &lsquo;<tt>Rmath.h</tt>&rsquo;; See section <a href="#Distribution-functions">Distribution functions</a>.  Those calls generate a single variate and should also be
enclosed in calls to <code>GetRNGstate</code> and <code>PutRNGstate</code>.
</p>

<hr size="6">
<a name="Missing-and-IEEE-values"></a>
<table cellpadding="1" cellspacing="1" border="0">
<tr><td valign="middle" align="left">[<a href="#Random-numbers" title="Previous section in reading order"> &lt; </a>]</td>
<td valign="middle" align="left">[<a href="#Printing" title="Next section in reading order"> &gt; </a>]</td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left">[<a href="#The-R-API" title="Beginning of this chapter or previous chapter"> &lt;&lt; </a>]</td>
<td valign="middle" align="left">[<a href="#The-R-API" title="Up section"> Up </a>]</td>
<td valign="middle" align="left">[<a href="#Generic-functions-and-methods" title="Next chapter"> &gt;&gt; </a>]</td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left">[<a href="#Top" title="Cover (top) of document">Top</a>]</td>
<td valign="middle" align="left">[<a href="#SEC_Contents" title="Table of contents">Contents</a>]</td>
<td valign="middle" align="left">[<a href="#Function-and-variable-index" title="Index">Index</a>]</td>
<td valign="middle" align="left">[<a href="#SEC_About" title="About (help)"> ? </a>]</td>
</tr></table>
<a name="Missing-and-IEEE-special-values"></a>
<h2 class="section">6.4 Missing and <acronym>IEEE</acronym> special values</h2>
<a name="index-Missing-values-1"></a>
<a name="index-IEEE-special-values-1"></a>
<a name="index-ISNA-1"></a>
<a name="index-ISNAN-1"></a>
<a name="index-R_005fFINITE"></a>
<a name="index-R_005fIsNaN"></a>
<a name="index-R_005fPosInf"></a>
<a name="index-R_005fNegInf"></a>
<a name="index-NA_005fREAL"></a>

<p>A set of functions is provided to test for <code>NA</code>, <code>Inf</code>,
<code>-Inf</code> and <code>NaN</code>.  These functions are accessed <em>via</em> macros:
</p>
<table><tr><td>&nbsp;</td><td><pre class="example">ISNA(<var>x</var>)        <span class="roman">True for R's <code>NA</code> only</span>
ISNAN(<var>x</var>)       <span class="roman">True for R's <code>NA</code> and <acronym>IEEE</acronym> <code>NaN</code></span>
R_FINITE(<var>x</var>)    <span class="roman">False for <code>Inf</code>, <code>-Inf</code>, <code>NA</code>, <code>NaN</code></span>
</pre></td></tr></table>

<p>and <em>via</em> function <code>R_IsNaN</code> which is true for <code>NaN</code> but not
<code>NA</code>.
</p>
<p>Do use <code>R_FINITE</code> rather than <code>isfinite</code> or <code>finite</code>; the
latter is often mendacious and <code>isfinite</code> is only available on a
some platforms, on which <code>R_FINITE</code> is a macro expanding to
<code>isfinite</code>.
</p>
<p>Currently in C code <code>ISNAN</code> is a macro calling <code>isnan</code>.
(Since this gives problems on some C++ systems, if the R headers is
called from C++ code a function call is used.)
</p>
<p>You can check for <code>Inf</code> or <code>-Inf</code> by testing equality to
<code>R_PosInf</code> or <code>R_NegInf</code>, and set (but not test) an <code>NA</code>
as <code>NA_REAL</code>.
</p>
<p>All of the above apply to <em>double</em> variables only.  For integer
variables there is a variable accessed by the macro <code>NA_INTEGER</code>
which can used to set or test for missingness.
</p>

<hr size="6">
<a name="Printing"></a>
<table cellpadding="1" cellspacing="1" border="0">
<tr><td valign="middle" align="left">[<a href="#Missing-and-IEEE-values" title="Previous section in reading order"> &lt; </a>]</td>
<td valign="middle" align="left">[<a href="#Printing-from-FORTRAN" title="Next section in reading order"> &gt; </a>]</td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left">[<a href="#The-R-API" title="Beginning of this chapter or previous chapter"> &lt;&lt; </a>]</td>
<td valign="middle" align="left">[<a href="#The-R-API" title="Up section"> Up </a>]</td>
<td valign="middle" align="left">[<a href="#Generic-functions-and-methods" title="Next chapter"> &gt;&gt; </a>]</td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left">[<a href="#Top" title="Cover (top) of document">Top</a>]</td>
<td valign="middle" align="left">[<a href="#SEC_Contents" title="Table of contents">Contents</a>]</td>
<td valign="middle" align="left">[<a href="#Function-and-variable-index" title="Index">Index</a>]</td>
<td valign="middle" align="left">[<a href="#SEC_About" title="About (help)"> ? </a>]</td>
</tr></table>
<a name="Printing-1"></a>
<h2 class="section">6.5 Printing</h2>
<a name="index-Printing-from-C"></a>
<a name="index-Rprintf"></a>
<a name="index-REprintf"></a>
<a name="index-Rvprintf"></a>
<a name="index-REvprintf"></a>

<p>The most useful function for printing from a C routine compiled into
R is <code>Rprintf</code>.  This is used in exactly the same way as
<code>printf</code>, but is guaranteed to write to R&rsquo;s output (which might
be a <acronym>GUI</acronym> console rather than a file, and can be re-directed by
<code>sink</code>).  It is wise to write complete lines (including the
<code>&quot;\n&quot;</code>) before returning to R.  It is defined in
&lsquo;<tt>R_ext/Print.h</tt>&rsquo;.
</p>
<p>The function <code>REprintf</code> is similar but writes on the error stream
(<code>stderr</code>) which may or may not be different from the standard
output stream.
</p>
<p>Functions <code>Rvprintf</code> and <code>REvprintf</code> are analogues using the
<code>vprintf</code> interface.  Because that is a C99 interface, they are
only defined by &lsquo;<tt>R_ext/Print.h</tt>&rsquo; in C++ code if the macro
<code>R_USE_C99_IN_CXX</code> is defined when it is included.
</p>
<p>Another circumstance when it may be important to use these functions is
when using parallel computation on a cluster of computational nodes, as
their output will be re-directed/logged appropriately.
</p>
<table class="menu" border="0" cellspacing="0">
<tr><td align="left" valign="top"><a href="#Printing-from-FORTRAN">6.5.1 Printing from FORTRAN</a></td><td>&nbsp;&nbsp;</td><td align="left" valign="top">       
</td></tr>
</table>

<hr size="6">
<a name="Printing-from-FORTRAN"></a>
<table cellpadding="1" cellspacing="1" border="0">
<tr><td valign="middle" align="left">[<a href="#Printing" title="Previous section in reading order"> &lt; </a>]</td>
<td valign="middle" align="left">[<a href="#Calling-C-from-FORTRAN-and-vice-versa" title="Next section in reading order"> &gt; </a>]</td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left">[<a href="#The-R-API" title="Beginning of this chapter or previous chapter"> &lt;&lt; </a>]</td>
<td valign="middle" align="left">[<a href="#Printing" title="Up section"> Up </a>]</td>
<td valign="middle" align="left">[<a href="#Generic-functions-and-methods" title="Next chapter"> &gt;&gt; </a>]</td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left">[<a href="#Top" title="Cover (top) of document">Top</a>]</td>
<td valign="middle" align="left">[<a href="#SEC_Contents" title="Table of contents">Contents</a>]</td>
<td valign="middle" align="left">[<a href="#Function-and-variable-index" title="Index">Index</a>]</td>
<td valign="middle" align="left">[<a href="#SEC_About" title="About (help)"> ? </a>]</td>
</tr></table>
<a name="Printing-from-FORTRAN-1"></a>
<h3 class="subsection">6.5.1 Printing from FORTRAN</h3>
<a name="index-Printing-from-FORTRAN"></a>

<p>On many systems FORTRAN <code>write</code> and <code>print</code> statements can be
used, but the output may not interleave well with that of C, and will be
invisible on <acronym>GUI</acronym> interfaces.  They are not portable and best
avoided.
</p>
<p>Three subroutines are provided to ease the output of information from
FORTRAN code.
</p>
<table><tr><td>&nbsp;</td><td><pre class="example">subroutine dblepr(<var>label</var>, <var>nchar</var>, <var>data</var>, <var>ndata</var>)
subroutine realpr(<var>label</var>, <var>nchar</var>, <var>data</var>, <var>ndata</var>)
subroutine intpr (<var>label</var>, <var>nchar</var>, <var>data</var>, <var>ndata</var>)
</pre></td></tr></table>

<p>Here <var>label</var> is a character label of up to 255 characters,
<var>nchar</var> is its length (which can be <code>-1</code> if the whole label is
to be used), and <var>data</var> is an array of length at least <var>ndata</var>
of the appropriate type (<code>double precision</code>, <code>real</code> and
<code>integer</code> respectively).  These routines print the label on one
line and then print <var>data</var> as if it were an R vector on
subsequent line(s).  They work with zero <var>ndata</var>, and so can be used
to print a label alone.
</p>
<hr size="6">
<a name="Calling-C-from-FORTRAN-and-vice-versa"></a>
<table cellpadding="1" cellspacing="1" border="0">
<tr><td valign="middle" align="left">[<a href="#Printing-from-FORTRAN" title="Previous section in reading order"> &lt; </a>]</td>
<td valign="middle" align="left">[<a href="#Numerical-analysis-subroutines" title="Next section in reading order"> &gt; </a>]</td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left">[<a href="#The-R-API" title="Beginning of this chapter or previous chapter"> &lt;&lt; </a>]</td>
<td valign="middle" align="left">[<a href="#The-R-API" title="Up section"> Up </a>]</td>
<td valign="middle" align="left">[<a href="#Generic-functions-and-methods" title="Next chapter"> &gt;&gt; </a>]</td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left">[<a href="#Top" title="Cover (top) of document">Top</a>]</td>
<td valign="middle" align="left">[<a href="#SEC_Contents" title="Table of contents">Contents</a>]</td>
<td valign="middle" align="left">[<a href="#Function-and-variable-index" title="Index">Index</a>]</td>
<td valign="middle" align="left">[<a href="#SEC_About" title="About (help)"> ? </a>]</td>
</tr></table>
<a name="Calling-C-from-FORTRAN-and-vice-versa-1"></a>
<h2 class="section">6.6 Calling C from FORTRAN and vice versa</h2>
<a name="index-Calling-C-from-FORTRAN-and-vice-versa"></a>

<p>Naming conventions for symbols generated by FORTRAN differ by platform:
it is not safe to assume that FORTRAN names appear to C with a trailing
underscore.  To help cover up the platform-specific differences there is
a set of macros that should be used.
</p>
<dl compact="compact">
<dt> <code>F77_SUB(<var>name</var>)</code></dt>
<dd><p>to define a function in C to be called from FORTRAN
</p></dd>
<dt> <code>F77_NAME(<var>name</var>)</code></dt>
<dd><p>to declare a FORTRAN routine in C before use
</p></dd>
<dt> <code>F77_CALL(<var>name</var>)</code></dt>
<dd><p>to call a FORTRAN routine from C
</p></dd>
<dt> <code>F77_COMDECL(<var>name</var>)</code></dt>
<dd><p>to declare a FORTRAN common block in C
</p></dd>
<dt> <code>F77_COM(<var>name</var>)</code></dt>
<dd><p>to access a FORTRAN common block from C
</p></dd>
</dl>

<p>On most current platforms these are all the same, but it is unwise to
rely on this.  Note that names with underscores are not legal in FORTRAN
77, and are not portably handled by the above macros.  (Also, all
FORTRAN names for use by R are lower case, but this is not enforced
by the macros.)
</p>
<p>For example, suppose we want to call R&rsquo;s normal random numbers from
FORTRAN.  We need a C wrapper along the lines of
</p>
<a name="index-Random-numbers-in-FORTRAN"></a>
<table><tr><td>&nbsp;</td><td><pre class="example">#include &lt;R.h&gt;

void F77_SUB(rndstart)(void) { GetRNGstate(); }
void F77_SUB(rndend)(void) { PutRNGstate(); }
double F77_SUB(normrnd)(void) { return norm_rand(); }
</pre></td></tr></table>

<p>to be called from FORTRAN as in
</p>
<table><tr><td>&nbsp;</td><td><pre class="example">      subroutine testit()
      double precision normrnd, x
      call rndstart()
      x = normrnd()
      call dblepr(&quot;X was&quot;, 5, x, 1)
      call rndend()
      end
</pre></td></tr></table>

<p>Note that this is not guaranteed to be portable, for the return
conventions might not be compatible between the C and FORTRAN compilers
used.  (Passing values <em>via</em> arguments is safer.)
</p>
<p>The standard packages, for example <strong>stats</strong>, are a rich source of
further examples.
</p>


<hr size="6">
<a name="Numerical-analysis-subroutines"></a>
<table cellpadding="1" cellspacing="1" border="0">
<tr><td valign="middle" align="left">[<a href="#Calling-C-from-FORTRAN-and-vice-versa" title="Previous section in reading order"> &lt; </a>]</td>
<td valign="middle" align="left">[<a href="#Distribution-functions" title="Next section in reading order"> &gt; </a>]</td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left">[<a href="#The-R-API" title="Beginning of this chapter or previous chapter"> &lt;&lt; </a>]</td>
<td valign="middle" align="left">[<a href="#The-R-API" title="Up section"> Up </a>]</td>
<td valign="middle" align="left">[<a href="#Generic-functions-and-methods" title="Next chapter"> &gt;&gt; </a>]</td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left">[<a href="#Top" title="Cover (top) of document">Top</a>]</td>
<td valign="middle" align="left">[<a href="#SEC_Contents" title="Table of contents">Contents</a>]</td>
<td valign="middle" align="left">[<a href="#Function-and-variable-index" title="Index">Index</a>]</td>
<td valign="middle" align="left">[<a href="#SEC_About" title="About (help)"> ? </a>]</td>
</tr></table>
<a name="Numerical-analysis-subroutines-1"></a>
<h2 class="section">6.7 Numerical analysis subroutines</h2>
<a name="index-Numerical-analysis-subroutines-from-C"></a>

<p>R contains a large number of mathematical functions for its own use,
for example numerical linear algebra computations and special functions.
</p>
<p>The header files &lsquo;<tt>R_ext/BLAS.h</tt>&rsquo;, &lsquo;<tt>R_ext/Lapack.h</tt>&rsquo; and
&lsquo;<tt>R_ext/Linpack.h</tt>&rsquo; contains declarations of the BLAS, LAPACK and
LINPACK/EISPACK linear algebra functions included in R.  These
are expressed as calls to FORTRAN subroutines, and they will also be
usable from users&rsquo; FORTRAN code.  Although not part of the official
<acronym>API</acronym>, this set of subroutines is unlikely to change (but might
be supplemented).
</p>
<p>The header file &lsquo;<tt>Rmath.h</tt>&rsquo; lists many other functions that are
available and documented in the following subsections. Many of these are
C interfaces to the code behind R functions, so the R function
documentation may give further details.
</p>
<table class="menu" border="0" cellspacing="0">
<tr><td align="left" valign="top"><a href="#Distribution-functions">6.7.1 Distribution functions</a></td><td>&nbsp;&nbsp;</td><td align="left" valign="top">      
</td></tr>
<tr><td align="left" valign="top"><a href="#Mathematical-functions">6.7.2 Mathematical functions</a></td><td>&nbsp;&nbsp;</td><td align="left" valign="top">      
</td></tr>
<tr><td align="left" valign="top"><a href="#Numerical-Utilities">6.7.3 Numerical Utilities</a></td><td>&nbsp;&nbsp;</td><td align="left" valign="top">         
</td></tr>
<tr><td align="left" valign="top"><a href="#Mathematical-constants">6.7.4 Mathematical constants</a></td><td>&nbsp;&nbsp;</td><td align="left" valign="top">      
</td></tr>
</table>

<hr size="6">
<a name="Distribution-functions"></a>
<table cellpadding="1" cellspacing="1" border="0">
<tr><td valign="middle" align="left">[<a href="#Numerical-analysis-subroutines" title="Previous section in reading order"> &lt; </a>]</td>
<td valign="middle" align="left">[<a href="#Mathematical-functions" title="Next section in reading order"> &gt; </a>]</td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left">[<a href="#The-R-API" title="Beginning of this chapter or previous chapter"> &lt;&lt; </a>]</td>
<td valign="middle" align="left">[<a href="#Numerical-analysis-subroutines" title="Up section"> Up </a>]</td>
<td valign="middle" align="left">[<a href="#Generic-functions-and-methods" title="Next chapter"> &gt;&gt; </a>]</td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left">[<a href="#Top" title="Cover (top) of document">Top</a>]</td>
<td valign="middle" align="left">[<a href="#SEC_Contents" title="Table of contents">Contents</a>]</td>
<td valign="middle" align="left">[<a href="#Function-and-variable-index" title="Index">Index</a>]</td>
<td valign="middle" align="left">[<a href="#SEC_About" title="About (help)"> ? </a>]</td>
</tr></table>
<a name="Distribution-functions-1"></a>
<h3 class="subsection">6.7.1 Distribution functions</h3>
<a name="index-Distribution-functions-from-C"></a>

<p>The routines used to calculate densities, cumulative distribution
functions and quantile functions for the standard statistical
distributions are available as entry points.
</p>
<p>The arguments for the entry points follow the pattern of those for the
normal distribution:
</p>
<table><tr><td>&nbsp;</td><td><pre class="example">double dnorm(double <var>x</var>, double <var>mu</var>, double <var>sigma</var>, int <var>give_log</var>);
double pnorm(double <var>x</var>, double <var>mu</var>, double <var>sigma</var>, int <var>lower_tail</var>,
             int <var>give_log</var>);
double qnorm(double <var>p</var>, double <var>mu</var>, double <var>sigma</var>, int <var>lower_tail</var>,
             int <var>log_p</var>);
double rnorm(double <var>mu</var>, double <var>sigma</var>);
</pre></td></tr></table>

<p>That is, the first argument gives the position for the density and CDF
and probability for the quantile function, followed by the
distribution&rsquo;s parameters.  Argument <var>lower_tail</var> should be
<code>TRUE</code> (or <code>1</code>) for normal use, but can be <code>FALSE</code> (or
<code>0</code>) if the probability of the upper tail is desired or specified.
</p>
<p>Finally, <var>give_log</var> should be non-zero if the result is required on
log scale, and <var>log_p</var> should be non-zero if <var>p</var> has been
specified on log scale.
</p>
<p>Note that you directly get the cumulative (or &ldquo;integrated&rdquo;)
<em>hazard</em> function, H(t) = - log(1 -
F(t)), by using
</p>
<table><tr><td>&nbsp;</td><td><pre class="example">- p<var>dist</var>(t, ..., /*lower_tail = */ FALSE, /* give_log = */ TRUE)
</pre></td></tr></table>

<p>or shorter (and more cryptic) <code>- p<var>dist</var>(t, ..., 0, 1)</code>.
<a name="index-cumulative-hazard"></a>
</p>
<p>The random-variate generation routine <code>rnorm</code> returns one normal
variate. See section <a href="#Random-numbers">Random number generation</a>, for the protocol in using the
random-variate routines.
<a name="index-Random-numbers-in-C-1"></a>
</p>
<p>Note that these argument sequences are (apart from the names and that
<code>rnorm</code> has no <var>n</var>) mainly the same as the corresponding R
functions of the same name, so the documentation of the R functions
can be used.  Note that the exponential and gamma distributions are
parametrized by <code>scale</code> rather than <code>rate</code>.
</p>

<p>For reference, the following table gives the basic name (to be prefixed
by &lsquo;<samp>d</samp>&rsquo;, &lsquo;<samp>p</samp>&rsquo;, &lsquo;<samp>q</samp>&rsquo; or &lsquo;<samp>r</samp>&rsquo; apart from the exceptions
noted) and distribution-specific arguments for the complete set of
distributions.
</p>
<blockquote><table>
<tr><td width="28%">beta</td><td width="22%"><code>beta</code></td><td width="30%"><code>a</code>, <code>b</code></td></tr>
<tr><td width="28%">non-central beta</td><td width="22%"><code>nbeta</code></td><td width="30%"><code>a</code>, <code>b</code>, <code>ncp</code></td></tr>
<tr><td width="28%">binomial</td><td width="22%"><code>binom</code></td><td width="30%"><code>n</code>, <code>p</code></td></tr>
<tr><td width="28%">Cauchy</td><td width="22%"><code>cauchy</code></td><td width="30%"><code>location</code>, <code>scale</code></td></tr>
<tr><td width="28%">chi-squared</td><td width="22%"><code>chisq</code></td><td width="30%"><code>df</code></td></tr>
<tr><td width="28%">non-central chi-squared</td><td width="22%"><code>nchisq</code></td><td width="30%"><code>df</code>, <code>ncp</code></td></tr>
<tr><td width="28%">exponential</td><td width="22%"><code>exp</code></td><td width="30%"><code>scale</code> (and <strong>not</strong> <code>rate</code>)</td></tr>
<tr><td width="28%">F</td><td width="22%"><code>f</code></td><td width="30%"><code>n1</code>, <code>n2</code></td></tr>
<tr><td width="28%">non-central F</td><td width="22%"><code>nf</code></td><td width="30%"><code>n1</code>, <code>n2</code>, <code>ncp</code></td></tr>
<tr><td width="28%">gamma</td><td width="22%"><code>gamma</code></td><td width="30%"><code>shape</code>, <code>scale</code></td></tr>
<tr><td width="28%">geometric</td><td width="22%"><code>geom</code></td><td width="30%"><code>p</code></td></tr>
<tr><td width="28%">hypergeometric</td><td width="22%"><code>hyper</code></td><td width="30%"><code>NR</code>, <code>NB</code>, <code>n</code></td></tr>
<tr><td width="28%">logistic</td><td width="22%"><code>logis</code></td><td width="30%"><code>location</code>, <code>scale</code></td></tr>
<tr><td width="28%">lognormal</td><td width="22%"><code>lnorm</code></td><td width="30%"><code>logmean</code>, <code>logsd</code></td></tr>
<tr><td width="28%">negative binomial</td><td width="22%"><code>nbinom</code></td><td width="30%"><code>size</code>, <code>prob</code></td></tr>
<tr><td width="28%">normal</td><td width="22%"><code>norm</code></td><td width="30%"><code>mu</code>, <code>sigma</code></td></tr>
<tr><td width="28%">Poisson</td><td width="22%"><code>pois</code></td><td width="30%"><code>lambda</code></td></tr>
<tr><td width="28%">Student&rsquo;s t</td><td width="22%"><code>t</code></td><td width="30%"><code>n</code></td></tr>
<tr><td width="28%">non-central t</td><td width="22%"><code>nt</code></td><td width="30%"><code>df</code>, <code>delta</code></td></tr>
<tr><td width="28%">Studentized range</td><td width="22%"><code>tukey</code> (*)</td><td width="30%"><code>rr</code>, <code>cc</code>, <code>df</code></td></tr>
<tr><td width="28%">uniform</td><td width="22%"><code>unif</code></td><td width="30%"><code>a</code>, <code>b</code></td></tr>
<tr><td width="28%">Weibull</td><td width="22%"><code>weibull</code></td><td width="30%"><code>shape</code>, <code>scale</code></td></tr>
<tr><td width="28%">Wilcoxon rank sum</td><td width="22%"><code>wilcox</code></td><td width="30%"><code>m</code>, <code>n</code></td></tr>
<tr><td width="28%">Wilcoxon signed rank</td><td width="22%"><code>signrank</code></td><td width="30%"><code>n</code></td></tr>
</table>
</blockquote>

<p>Entries marked with an asterisk only have &lsquo;<samp>p</samp>&rsquo; and &lsquo;<samp>q</samp>&rsquo;
functions available, and none of the non-central distributions have
&lsquo;<samp>r</samp>&rsquo; functions.  After a call to <code>dwilcox</code>, <code>pwilcox</code> or
<code>qwilcox</code> the function <code>wilcox_free()</code> should be called, and
similarly for the signed rank functions.
</p>
<hr size="6">
<a name="Mathematical-functions"></a>
<table cellpadding="1" cellspacing="1" border="0">
<tr><td valign="middle" align="left">[<a href="#Distribution-functions" title="Previous section in reading order"> &lt; </a>]</td>
<td valign="middle" align="left">[<a href="#Numerical-Utilities" title="Next section in reading order"> &gt; </a>]</td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left">[<a href="#The-R-API" title="Beginning of this chapter or previous chapter"> &lt;&lt; </a>]</td>
<td valign="middle" align="left">[<a href="#Numerical-analysis-subroutines" title="Up section"> Up </a>]</td>
<td valign="middle" align="left">[<a href="#Generic-functions-and-methods" title="Next chapter"> &gt;&gt; </a>]</td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left">[<a href="#Top" title="Cover (top) of document">Top</a>]</td>
<td valign="middle" align="left">[<a href="#SEC_Contents" title="Table of contents">Contents</a>]</td>
<td valign="middle" align="left">[<a href="#Function-and-variable-index" title="Index">Index</a>]</td>
<td valign="middle" align="left">[<a href="#SEC_About" title="About (help)"> ? </a>]</td>
</tr></table>
<a name="Mathematical-functions-1"></a>
<h3 class="subsection">6.7.2 Mathematical functions</h3>

<a name="index-gammafn"></a>
<a name="index-lgammafn"></a>
<a name="index-digamma"></a>
<a name="index-trigamma"></a>
<a name="index-tetragamma"></a>
<a name="index-pentagamma"></a>
<a name="index-psigamma"></a>
<a name="index-Gamma-function"></a>
<dl>
<dt><a name="index-gammafn-1"></a><u>Function:</u> double <b>gammafn</b><i> (double <var>x</var>)</i></dt>
<dt><a name="index-lgammafn-1"></a><u>Function:</u> double <b>lgammafn</b><i> (double <var>x</var>)</i></dt>
<dt><a name="index-digamma-1"></a><u>Function:</u> double <b>digamma</b><i> (double <var>x</var>)</i></dt>
<dt><a name="index-trigamma-1"></a><u>Function:</u> double <b>trigamma</b><i> (double <var>x</var>)</i></dt>
<dt><a name="index-tetragamma-1"></a><u>Function:</u> double <b>tetragamma</b><i> (double <var>x</var>)</i></dt>
<dt><a name="index-pentagamma-1"></a><u>Function:</u> double <b>pentagamma</b><i> (double <var>x</var>)</i></dt>
<dt><a name="index-psigamma-1"></a><u>Function:</u> double <b>psigamma</b><i> (double <var>x</var>, double <var>deriv</var>)</i></dt>
<dd><p>The Gamma function, the natural logarithm of its absolute value and
first four derivatives and the n-th derivative of Psi, the digamma
function, which is the derivative of <code>lgammafn</code>. In other words,
<code>digamma(x)</code> is the same as <code>(psigamma(x,0)</code>,
<code>trigamma(x) == psigamma(x,1)</code>, etc.
</p></dd></dl>

<a name="index-beta"></a>
<a name="index-lbeta"></a>
<a name="index-Beta-function"></a>
<dl>
<dt><a name="index-beta-1"></a><u>Function:</u> double <b>beta</b><i> (double <var>a</var>, double <var>b</var>)</i></dt>
<dt><a name="index-lbeta-1"></a><u>Function:</u> double <b>lbeta</b><i> (double <var>a</var>, double <var>b</var>)</i></dt>
<dd><p>The (complete) Beta function and its natural logarithm.
</p></dd></dl>

<a name="index-choose"></a>
<a name="index-lchoose"></a>
<dl>
<dt><a name="index-choose-1"></a><u>Function:</u> double <b>choose</b><i> (double <var>n</var>, double <var>k</var>)</i></dt>
<dt><a name="index-lchoose-1"></a><u>Function:</u> double <b>lchoose</b><i> (double <var>n</var>, double <var>k</var>)</i></dt>
<dd><p>The number of combinations of <var>k</var> items chosen from from <var>n</var> and
the natural logarithm of its absolute value, generalized to arbitrary real
<var>n</var>.  <var>k</var> is rounded to the nearest integer (with a warning if
needed).
</p></dd></dl>

<a name="index-bessel_005fi"></a>
<a name="index-bessel_005fj"></a>
<a name="index-bessel_005fk"></a>
<a name="index-bessel_005fy"></a>
<a name="index-Bessel-functions"></a>
<dl>
<dt><a name="index-bessel_005fi-1"></a><u>Function:</u> double <b>bessel_i</b><i> (double <var>x</var>, double <var>nu</var>, double <var>expo</var>)</i></dt>
<dt><a name="index-bessel_005fj-1"></a><u>Function:</u> double <b>bessel_j</b><i> (double <var>x</var>, double <var>nu</var>)</i></dt>
<dt><a name="index-bessel_005fk-1"></a><u>Function:</u> double <b>bessel_k</b><i> (double <var>x</var>, double <var>nu</var>, double <var>expo</var>)</i></dt>
<dt><a name="index-bessel_005fy-1"></a><u>Function:</u> double <b>bessel_y</b><i> (double <var>x</var>, double <var>nu</var>)</i></dt>
<dd><p>Bessel functions of types I, J, K and Y with index <var>nu</var>.  For
<code>bessel_i</code> and <code>bessel_k</code> there is the option to return
exp(-<var>x</var>) I(<var>x</var>; <var>nu</var>) or exp(<var>x</var>) K(<var>x</var>;
<var>nu</var>) if <var>expo</var> is 2. (Use <code><var>expo</var> == 1</code> for unscaled
values.)
</p></dd></dl>


<hr size="6">
<a name="Numerical-Utilities"></a>
<table cellpadding="1" cellspacing="1" border="0">
<tr><td valign="middle" align="left">[<a href="#Mathematical-functions" title="Previous section in reading order"> &lt; </a>]</td>
<td valign="middle" align="left">[<a href="#Mathematical-constants" title="Next section in reading order"> &gt; </a>]</td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left">[<a href="#The-R-API" title="Beginning of this chapter or previous chapter"> &lt;&lt; </a>]</td>
<td valign="middle" align="left">[<a href="#Numerical-analysis-subroutines" title="Up section"> Up </a>]</td>
<td valign="middle" align="left">[<a href="#Generic-functions-and-methods" title="Next chapter"> &gt;&gt; </a>]</td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left">[<a href="#Top" title="Cover (top) of document">Top</a>]</td>
<td valign="middle" align="left">[<a href="#SEC_Contents" title="Table of contents">Contents</a>]</td>
<td valign="middle" align="left">[<a href="#Function-and-variable-index" title="Index">Index</a>]</td>
<td valign="middle" align="left">[<a href="#SEC_About" title="About (help)"> ? </a>]</td>
</tr></table>
<a name="Numerical-Utilities-1"></a>
<h3 class="subsection">6.7.3 Numerical Utilities</h3>
<p>There are a few other numerical utility functions available as entry points.
</p>

<dl>
<dt><a name="index-R_005fpow"></a><u>Function:</u> double <b>R_pow</b><i> (double <var>x</var>, double <var>y</var>)</i></dt>
<dt><a name="index-R_005fpow_005fdi"></a><u>Function:</u> double <b>R_pow_di</b><i> (double <var>x</var>, int <var>i</var>)</i></dt>
<dd><p><code>R_pow(<var>x</var>, <var>y</var>)</code> and <code>R_pow_di(<var>x</var>, <var>i</var>)</code>
compute <code><var>x</var>^<var>y</var></code> and <code><var>x</var>^<var>i</var></code>, respectively
using <code>R_FINITE</code> checks and returning the proper result (the same
as R) for the cases where <var>x</var>, <var>y</var> or <var>i</var> are 0 or
missing or infinite or <code>NaN</code>.
</p></dd></dl>

<dl>
<dt><a name="index-log1p"></a><u>Function:</u> double <b>log1p</b><i> (double <var>x</var>)</i></dt>
<dd><p>Computes <code>log(1 + <var>x</var>)</code> (<em>log 1 <b>p</b>lus x</em>), accurately
even for small <var>x</var>, i.e., |x| &lt;&lt; 1.
</p>
<p>This should be provided by your platform, in which case it is not included
in &lsquo;<tt>Rmath.h</tt>&rsquo;, but is (probably) in &lsquo;<tt>math.h</tt>&rsquo; which
&lsquo;<tt>Rmath.h</tt>&rsquo; includes.
</p></dd></dl>

<dl>
<dt><a name="index-log1pmx"></a><u>Function:</u> double <b>log1pmx</b><i> (double <var>x</var>)</i></dt>
<dd><p>Computes <code>log(1 + <var>x</var>) - <var>x</var></code> (<em>log 1 <b>p</b>lus x <b>m</b>inus <b>x</b></em>),
accurately even for small <var>x</var>, i.e., |x| &lt;&lt; 1.
</p></dd></dl>

<dl>
<dt><a name="index-log1pexp"></a><u>Function:</u> double <b>log1pexp</b><i> (double <var>x</var>)</i></dt>
<dd><p>Computes <code>log(1 + exp(<var>x</var>))</code> (<em>log 1 <b>p</b>lus <b>exp</b></em>),
accurately, notably for large <var>x</var>, e.g., x &gt; 720.
</p></dd></dl>


<dl>
<dt><a name="index-expm1"></a><u>Function:</u> double <b>expm1</b><i> (double <var>x</var>)</i></dt>
<dd><p>Computes <code>exp(<var>x</var>) - 1</code> (<em>exp x <b>m</b>inus 1</em>), accurately
even for small <var>x</var>, i.e., |x| &lt;&lt; 1.
</p>
<p>This should be provided by your platform, in which case it is not included
in &lsquo;<tt>Rmath.h</tt>&rsquo;, but is (probably) in &lsquo;<tt>math.h</tt>&rsquo; which
&lsquo;<tt>Rmath.h</tt>&rsquo; includes.
</p></dd></dl>

<dl>
<dt><a name="index-lgamma1p"></a><u>Function:</u> double <b>lgamma1p</b><i> (double <var>x</var>)</i></dt>
<dd><p>Computes <code>log(gamma(<var>x</var> + 1))</code> (<em>log(gamma(1 <b>p</b>lus x))</em>),
accurately even for small <var>x</var>, i.e., 0 &lt; x &lt; 0.5.
</p></dd></dl>

<dl>
<dt><a name="index-logspace_005fadd"></a><u>Function:</u> double <b>logspace_add</b><i> (double <var>logx</var>, double <var>logy</var>)</i></dt>
<dt><a name="index-logspace_005fsub"></a><u>Function:</u> double <b>logspace_sub</b><i> (double <var>logx</var>, double <var>logy</var>)</i></dt>
<dd><p>Compute the log of a sum or difference from logs of terms, i.e., &ldquo;x +
y&rdquo; as <code>log (exp(<var>logx</var>) + exp(<var>logy</var>))</code> and &ldquo;x - y&rdquo; as
<code>log (exp(<var>logx</var>) - exp(<var>logy</var>))</code>, without causing
unnecessary overflows or throwing away too much accuracy.
</p></dd></dl>

<dl>
<dt><a name="index-imax2"></a><u>Function:</u> int <b>imax2</b><i> (int <var>x</var>, int <var>y</var>)</i></dt>
<dt><a name="index-imin2"></a><u>Function:</u> int <b>imin2</b><i> (int <var>x</var>, int <var>y</var>)</i></dt>
<dt><a name="index-fmax2"></a><u>Function:</u> double <b>fmax2</b><i> (double <var>x</var>, double <var>y</var>)</i></dt>
<dt><a name="index-fmin2"></a><u>Function:</u> double <b>fmin2</b><i> (double <var>x</var>, double <var>y</var>)</i></dt>
<dd><p>Return the larger (<code>max</code>) or smaller (<code>min</code>) of two integer or
double numbers, respectively.  Note that <code>fmax2</code> and <code>fmin2</code>
differ from C99&rsquo;s <code>fmax</code> and <code>fmin</code> when one of the arguments
is a <code>NaN</code>: these versions return <code>NaN</code>.
</p></dd></dl>

<dl>
<dt><a name="index-sign"></a><u>Function:</u> double <b>sign</b><i> (double <var>x</var>)</i></dt>
<dd><p>Compute the <em>signum</em> function, where sign(<var>x</var>) is 1, 0, or
<em>-1</em>, when <var>x</var> is positive, 0, or negative, respectively, and
<code>NaN</code> if <code>x</code> is a <code>NaN</code>.
</p></dd></dl>

<dl>
<dt><a name="index-fsign"></a><u>Function:</u> double <b>fsign</b><i> (double <var>x</var>, double <var>y</var>)</i></dt>
<dd><p>Performs &ldquo;transfer of sign&rdquo; and is defined as |x| * sign(y).
</p></dd></dl>

<dl>
<dt><a name="index-fprec"></a><u>Function:</u> double <b>fprec</b><i> (double <var>x</var>, double <var>digits</var>)</i></dt>
<dd><p>Returns the value of <var>x</var> rounded to <var>digits</var> decimal digits
(after the decimal point).
</p>
<p>This is the function used by R&rsquo;s <code>signif()</code>.
</p></dd></dl>

<dl>
<dt><a name="index-fround"></a><u>Function:</u> double <b>fround</b><i> (double <var>x</var>, double <var>digits</var>)</i></dt>
<dd><p>Returns the value of <var>x</var> rounded to <var>digits</var> <em>significant</em>
decimal digits.
</p>
<p>This is the function used by R&rsquo;s <code>round()</code>.
</p></dd></dl>

<dl>
<dt><a name="index-ftrunc"></a><u>Function:</u> double <b>ftrunc</b><i> (double <var>x</var>)</i></dt>
<dd><p>Returns the value of <var>x</var> truncated (to an integer value) towards zero.
</p></dd></dl>

<hr size="6">
<a name="Mathematical-constants"></a>
<table cellpadding="1" cellspacing="1" border="0">
<tr><td valign="middle" align="left">[<a href="#Numerical-Utilities" title="Previous section in reading order"> &lt; </a>]</td>
<td valign="middle" align="left">[<a href="#Optimization" title="Next section in reading order"> &gt; </a>]</td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left">[<a href="#The-R-API" title="Beginning of this chapter or previous chapter"> &lt;&lt; </a>]</td>
<td valign="middle" align="left">[<a href="#Numerical-analysis-subroutines" title="Up section"> Up </a>]</td>
<td valign="middle" align="left">[<a href="#Generic-functions-and-methods" title="Next chapter"> &gt;&gt; </a>]</td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left">[<a href="#Top" title="Cover (top) of document">Top</a>]</td>
<td valign="middle" align="left">[<a href="#SEC_Contents" title="Table of contents">Contents</a>]</td>
<td valign="middle" align="left">[<a href="#Function-and-variable-index" title="Index">Index</a>]</td>
<td valign="middle" align="left">[<a href="#SEC_About" title="About (help)"> ? </a>]</td>
</tr></table>
<a name="Mathematical-constants-1"></a>
<h3 class="subsection">6.7.4 Mathematical constants</h3>
<a name="index-M_005fE"></a>
<a name="index-M_005fPI"></a>

<p>R has a set of commonly used mathematical constants encompassing
constants usually found &lsquo;<tt>math.h</tt>&rsquo; and contains further ones that are
used in statistical computations.  All these are defined to (at least)
30 digits accuracy in &lsquo;<tt>Rmath.h</tt>&rsquo;.  The following definitions
use <code>ln(x)</code> for the natural logarithm (<code>log(x)</code> in R).
</p>
<blockquote><table>
<thead><tr><th>Name</th><th>Definition (<code>ln = log</code>)</th><th>round(<em>value</em>, 7)</th></tr></thead>
<tr><td><code>M_E</code></td><td><em>e</em></td><td>2.7182818</td></tr>
<tr><td><code>M_LOG2E</code></td><td>log2(<em>e</em>)</td><td>1.4426950</td></tr>
<tr><td><code>M_LOG10E</code></td><td>log10(<em>e</em>)</td><td>0.4342945</td></tr>
<tr><td><code>M_LN2</code></td><td>ln(2)</td><td>0.6931472</td></tr>
<tr><td><code>M_LN10</code></td><td>ln(10)</td><td>2.3025851</td></tr>
<tr><td><code>M_PI</code></td><td>pi</td><td>3.1415927</td></tr>
<tr><td><code>M_PI_2</code></td><td>pi/2</td><td>1.5707963</td></tr>
<tr><td><code>M_PI_4</code></td><td>pi/4</td><td>0.7853982</td></tr>
<tr><td><code>M_1_PI</code></td><td>1/pi</td><td>0.3183099</td></tr>
<tr><td><code>M_2_PI</code></td><td>2/pi</td><td>0.6366198</td></tr>
<tr><td><code>M_2_SQRTPI</code></td><td>2/sqrt(pi)</td><td>1.1283792</td></tr>
<tr><td><code>M_SQRT2</code></td><td>sqrt(2)</td><td>1.4142136</td></tr>
<tr><td><code>M_SQRT1_2</code></td><td>1/sqrt(2)</td><td>0.7071068</td></tr>
<tr><td><code>M_SQRT_3</code></td><td>sqrt(3)</td><td>1.7320508</td></tr>
<tr><td><code>M_SQRT_32</code></td><td>sqrt(32)</td><td>5.6568542</td></tr>
<tr><td><code>M_LOG10_2</code></td><td>log10(2)</td><td>0.3010300</td></tr>
<tr><td><code>M_2PI</code></td><td>2*pi</td><td>6.2831853</td></tr>
<tr><td><code>M_SQRT_PI</code></td><td>sqrt(pi)</td><td>1.7724539</td></tr>
<tr><td><code>M_1_SQRT_2PI</code></td><td>1/sqrt(2*pi)</td><td>0.3989423</td></tr>
<tr><td><code>M_SQRT_2dPI</code></td><td>sqrt(2/pi)</td><td>0.7978846</td></tr>
<tr><td><code>M_LN_SQRT_PI</code></td><td>ln(sqrt(pi))</td><td>0.5723649</td></tr>
<tr><td><code>M_LN_SQRT_2PI</code></td><td>ln(sqrt(2*pi))</td><td>0.9189385</td></tr>
<tr><td><code>M_LN_SQRT_PId2</code></td><td>ln(sqrt(pi/2))</td><td>0.2257914</td></tr>
</table>
</blockquote>

<p>There are a set of constants (<code>PI</code>, <code>DOUBLE_EPS</code>) (and so on)
defined (unless <code>STRICT_R_HEADERS</code> is defined) in the included
header &lsquo;<tt>R_ext/Constants.h</tt>&rsquo;, mainly for compatibility with S.
</p>
<a name="index-TRUE"></a>
<a name="index-FALSE"></a>
<p>Further, the included header &lsquo;<tt>R_ext/Boolean.h</tt>&rsquo; has constants
<code>TRUE</code> and <code>FALSE = 0</code> of type <code>Rboolean</code> in order to
provide a way of using &ldquo;logical&rdquo; variables in C consistently.
</p>

<hr size="6">
<a name="Optimization"></a>
<table cellpadding="1" cellspacing="1" border="0">
<tr><td valign="middle" align="left">[<a href="#Mathematical-constants" title="Previous section in reading order"> &lt; </a>]</td>
<td valign="middle" align="left">[<a href="#Integration" title="Next section in reading order"> &gt; </a>]</td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left">[<a href="#The-R-API" title="Beginning of this chapter or previous chapter"> &lt;&lt; </a>]</td>
<td valign="middle" align="left">[<a href="#The-R-API" title="Up section"> Up </a>]</td>
<td valign="middle" align="left">[<a href="#Generic-functions-and-methods" title="Next chapter"> &gt;&gt; </a>]</td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left">[<a href="#Top" title="Cover (top) of document">Top</a>]</td>
<td valign="middle" align="left">[<a href="#SEC_Contents" title="Table of contents">Contents</a>]</td>
<td valign="middle" align="left">[<a href="#Function-and-variable-index" title="Index">Index</a>]</td>
<td valign="middle" align="left">[<a href="#SEC_About" title="About (help)"> ? </a>]</td>
</tr></table>
<a name="Optimization-1"></a>
<h2 class="section">6.8 Optimization</h2>
<a name="index-optimization"></a>

<p>The C code underlying <code>optim</code> can be accessed directly.  The user
needs to supply a function to compute the function to be minimized, of
the type
</p>
<table><tr><td>&nbsp;</td><td><pre class="example">typedef double optimfn(int n, double *par, void *ex);
</pre></td></tr></table>

<p>where the first argument is the number of parameters in the second
argument.  The third argument is a pointer passed down from the calling
routine, normally used to carry auxiliary information.
</p>
<p>Some of the methods also require a gradient function
</p>
<table><tr><td>&nbsp;</td><td><pre class="example">typedef void optimgr(int n, double *par, double *gr, void *ex);
</pre></td></tr></table>

<p>which passes back the gradient in the <code>gr</code> argument.  No function
is provided for finite-differencing, nor for approximating the Hessian
at the result.
</p>
<p>The interfaces (defined in header &lsquo;<tt>R_ext/Applic.h</tt>&rsquo;) are
</p>
<ul>
<li> Nelder Mead:
<a name="index-nmmin"></a>
<table><tr><td>&nbsp;</td><td><pre class="example">void nmmin(int n, double *xin, double *x, double *Fmin, optimfn fn,
           int *fail, double abstol, double intol, void *ex,
           double alpha, double beta, double gamma, int trace,
           int *fncount, int maxit);
</pre></td></tr></table>

</li><li> BFGS:
<a name="index-vmmin"></a>
<table><tr><td>&nbsp;</td><td><pre class="example">void vmmin(int n, double *x, double *Fmin,
           optimfn fn, optimgr gr, int maxit, int trace,
           int *mask, double abstol, double reltol, int nREPORT,
           void *ex, int *fncount, int *grcount, int *fail);
</pre></td></tr></table>

</li><li> Conjugate gradients:
<a name="index-cgmin"></a>
<table><tr><td>&nbsp;</td><td><pre class="example">void cgmin(int n, double *xin, double *x, double *Fmin,
           optimfn fn, optimgr gr, int *fail, double abstol,
           double intol, void *ex, int type, int trace,
           int *fncount, int *grcount, int maxit);
</pre></td></tr></table>

</li><li> Limited-memory BFGS with bounds:
<a name="index-lbfgsb"></a>
<table><tr><td>&nbsp;</td><td><pre class="example">void lbfgsb(int n, int lmm, double *x, double *lower,
            double *upper, int *nbd, double *Fmin, optimfn fn,
            optimgr gr, int *fail, void *ex, double factr,
            double pgtol, int *fncount, int *grcount,
            int maxit, char *msg, int trace, int nREPORT);
</pre></td></tr></table>

</li><li> Simulated annealing:
<a name="index-samin"></a>
<table><tr><td>&nbsp;</td><td><pre class="example">void samin(int n, double *x, double *Fmin, optimfn fn, int maxit,
           int tmax, double temp, int trace, void *ex);
</pre></td></tr></table>

</li></ul>

<p>Many of the arguments are common to the various methods.  <code>n</code> is
the number of parameters, <code>x</code> or <code>xin</code> is the starting
parameters on entry and <code>x</code> the final parameters on exit, with
final value returned in <code>Fmin</code>.  Most of the other parameters can
be found from the help page for <code>optim</code>: see the source code
&lsquo;<tt>src/appl/lbfgsb.c</tt>&rsquo; for the values of <code>nbd</code>, which
specifies which bounds are to be used.
</p>

<hr size="6">
<a name="Integration"></a>
<table cellpadding="1" cellspacing="1" border="0">
<tr><td valign="middle" align="left">[<a href="#Optimization" title="Previous section in reading order"> &lt; </a>]</td>
<td valign="middle" align="left">[<a href="#Utility-functions" title="Next section in reading order"> &gt; </a>]</td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left">[<a href="#The-R-API" title="Beginning of this chapter or previous chapter"> &lt;&lt; </a>]</td>
<td valign="middle" align="left">[<a href="#The-R-API" title="Up section"> Up </a>]</td>
<td valign="middle" align="left">[<a href="#Generic-functions-and-methods" title="Next chapter"> &gt;&gt; </a>]</td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left">[<a href="#Top" title="Cover (top) of document">Top</a>]</td>
<td valign="middle" align="left">[<a href="#SEC_Contents" title="Table of contents">Contents</a>]</td>
<td valign="middle" align="left">[<a href="#Function-and-variable-index" title="Index">Index</a>]</td>
<td valign="middle" align="left">[<a href="#SEC_About" title="About (help)"> ? </a>]</td>
</tr></table>
<a name="Integration-1"></a>
<h2 class="section">6.9 Integration</h2>
<a name="index-integration"></a>

<p>The C code underlying <code>integrate</code> can be accessed directly.  The
user needs to supply a <em>vectorizing</em> C function to compute the
function to be integrated, of the type
</p>
<table><tr><td>&nbsp;</td><td><pre class="example">typedef void integr_fn(double *x, int n, void *ex);
</pre></td></tr></table>

<p>where <code>x[]</code> is both input and output and has length <code>n</code>, i.e.,
a C function, say <code>fn</code>, of type <code>integr_fn</code> must basically do
<code>for(i in 1:n) x[i] := f(x[i], ex)</code>.  The vectorization requirement
can be used to speed up the integrand instead of calling it <code>n</code>
times.  Note that in the current implementation built on QUADPACK,
<code>n</code> will be either 15 or 21.  The <code>ex</code> argument is a pointer
passed down from the calling routine, normally used to carry auxiliary
information.
</p>
<p>There are interfaces (defined in header &lsquo;<tt>R_ext/Applic.h</tt>&rsquo;) for
definite and for indefinite integrals.  &lsquo;Indefinite&rsquo; means that at least
one of the integration boundaries is not finite.
</p>
<ul>
<li> Finite:
<a name="index-Rdqags"></a>
<table><tr><td>&nbsp;</td><td><pre class="example">void Rdqags(integr_fn f, void *ex, double *a, double *b,
            double *epsabs, double *epsrel,
            double *result, double *abserr, int *neval, int *ier,
            int *limit, int *lenw, int *last,
            int *iwork, double *work);
</pre></td></tr></table>

</li><li> Indefinite:
<a name="index-Rdqagi"></a>
<table><tr><td>&nbsp;</td><td><pre class="example">void Rdqagi(integr_fn f, void *ex, double *bound, int *inf,
            double *epsabs, double *epsrel,
            double *result, double *abserr, int *neval, int *ier,
            int *limit, int *lenw, int *last,
            int *iwork, double *work);
</pre></td></tr></table>

</li></ul>

<p>Only the 3rd and 4th argument differ for the two integrators; for the
definite integral, using <code>Rdqags</code>, <code>a</code> and <code>b</code> are the
integration interval bounds, whereas for an indefinite integral, using
<code>Rdqagi</code>, <code>bound</code> is the finite bound of the integration (if
the integral is not doubly-infinite) and <code>inf</code> is a code indicating
the kind of integration range,
</p>
<dl compact="compact">
<dt> <code>inf = 1</code></dt>
<dd><p>      corresponds to (bound, +Inf),
</p></dd>
<dt> <code>inf = -1</code></dt>
<dd><p>      corresponds to (-Inf, bound),
</p></dd>
<dt> <code>inf = 2</code></dt>
<dd><p>      corresponds to (-Inf, +Inf),
</p></dd>
</dl>

<p><code>f</code> and <code>ex</code> define the integrand function, see above;
<code>epsabs</code> and <code>epsrel</code> specify the absolute and relative
accuracy requested, <code>result</code>, <code>abserr</code> and <code>last</code> are the
output components <code>value</code>, <code>abs.err</code> and <code>subdivisions</code>
of the R function integrate, where <code>neval</code> gives the number of
integrand function evaluations, and the error code <code>ier</code> is
translated to R&rsquo;s <code>integrate() $ message</code>, look at that function
definition.  <code>limit</code> corresponds to <code>integrate(...,
subdivisions = *)</code>.  It seems you should always define the two work
arrays and the length of the second one as
</p>
<table><tr><td>&nbsp;</td><td><pre class="example">    lenw = 4 * limit;
    iwork =   (int *) R_alloc(limit, sizeof(int));
    work = (double *) R_alloc(lenw,  sizeof(double));
</pre></td></tr></table>

<p>The comments in the source code in &lsquo;<tt>src/appl/integrate.c</tt>&rsquo; give
more details, particularly about reasons for failure (<code>ier &gt;= 1</code>).
</p>

<hr size="6">
<a name="Utility-functions"></a>
<table cellpadding="1" cellspacing="1" border="0">
<tr><td valign="middle" align="left">[<a href="#Integration" title="Previous section in reading order"> &lt; </a>]</td>
<td valign="middle" align="left">[<a href="#Re_002dencoding" title="Next section in reading order"> &gt; </a>]</td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left">[<a href="#The-R-API" title="Beginning of this chapter or previous chapter"> &lt;&lt; </a>]</td>
<td valign="middle" align="left">[<a href="#The-R-API" title="Up section"> Up </a>]</td>
<td valign="middle" align="left">[<a href="#Generic-functions-and-methods" title="Next chapter"> &gt;&gt; </a>]</td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left">[<a href="#Top" title="Cover (top) of document">Top</a>]</td>
<td valign="middle" align="left">[<a href="#SEC_Contents" title="Table of contents">Contents</a>]</td>
<td valign="middle" align="left">[<a href="#Function-and-variable-index" title="Index">Index</a>]</td>
<td valign="middle" align="left">[<a href="#SEC_About" title="About (help)"> ? </a>]</td>
</tr></table>
<a name="Utility-functions-1"></a>
<h2 class="section">6.10 Utility functions</h2>
<a name="index-Sort-functions-from-C"></a>

<p>R has a fairly comprehensive set of sort routines which are made
available to users&rsquo; C code.
The following is declared in header file &lsquo;<tt>Rinternals.h</tt>&rsquo;.
</p>
<dl>
<dt><a name="index-R_005forderVector"></a><u>Function:</u> void <b>R_orderVector</b><i> (int* <var>indx</var>, int <var>n</var>, SEXP <var>arglist</var>, Rboolean <var>nalast</var>, Rboolean <var>decreasing</var>)</i></dt>
<dd>
<p>This corresponds to R&rsquo;s <code>order(..., na.last, decreasing)</code>.
More specifically, <code>indx &lt;- order(x, y, na.last, decreasing)</code> corresponds to
<code>R_orderVector(indx, n, Rf_lang2(x, y), nalast, decreasing)</code> and for
three vectors, <code>Rf_lang3(x,y,z)</code> is used as <var>arglist</var>.
</p>
<p>Note that  <code>R_orderVector()</code> assumes the vector <code>indx</code>
to be allocated to length &gt;= n.  On return, <code>indx[]</code>
contains a permutation of <code>0:(n-1)</code>, i.e., 0-based C indices (and not
1-based R indices, as R&rsquo;s <code>order()</code>).
</p></dd></dl>

<p>All other sort routines are declared in header file
&lsquo;<tt>R_ext/Utils.h</tt>&rsquo; (included by &lsquo;<tt>R.h</tt>&rsquo;) and include the following.
</p>
<dl>
<dt><a name="index-R_005fisort"></a><u>Function:</u> void <b>R_isort</b><i> (int* <var>x</var>, int <var>n</var>)</i></dt>
<dt><a name="index-R_005frsort"></a><u>Function:</u> void <b>R_rsort</b><i> (double* <var>x</var>, int <var>n</var>)</i></dt>
<dt><a name="index-R_005fcsort"></a><u>Function:</u> void <b>R_csort</b><i> (Rcomplex* <var>x</var>, int <var>n</var>)</i></dt>
<dt><a name="index-rsort_005fwith_005findex"></a><u>Function:</u> void <b>rsort_with_index</b><i> (double* <var>x</var>, int* <var>index</var>, int <var>n</var>)</i></dt>
<dd><p>The first three sort integer, real (double) and complex data
respectively.  (Complex numbers are sorted by the real part first then
the imaginary part.)  <code>NA</code>s are sorted last.
</p>
<p><code>rsort_with_index</code> sorts on <var>x</var>, and applies the same
permutation to <var>index</var>.  <code>NA</code>s are sorted last.
</p></dd></dl>

<dl>
<dt><a name="index-revsort"></a><u>Function:</u> void <b>revsort</b><i> (double* <var>x</var>, int* <var>index</var>, int <var>n</var>)</i></dt>
<dd><p>Is similar to <code>rsort_with_index</code> but sorts into decreasing order,
and <code>NA</code>s are not handled.
</p></dd></dl>

<dl>
<dt><a name="index-iPsort"></a><u>Function:</u> void <b>iPsort</b><i> (int* <var>x</var>, int <var>n</var>, int <var>k</var>)</i></dt>
<dt><a name="index-rPsort"></a><u>Function:</u> void <b>rPsort</b><i> (double* <var>x</var>, int <var>n</var>, int <var>k</var>)</i></dt>
<dt><a name="index-cPsort"></a><u>Function:</u> void <b>cPsort</b><i> (Rcomplex* <var>x</var>, int <var>n</var>, int <var>k</var>)</i></dt>
<dd><p>These all provide (very) partial sorting: they permute <var>x</var> so that
<code><var>x</var>[<var>k</var>]</code> is in the correct place with smaller values to
the left, larger ones to the right.
</p></dd></dl>


<dl>
<dt><a name="index-R_005fqsort"></a><u>Function:</u> void <b>R_qsort</b><i>   (double *<var>v</var>, size_t <var>i</var>, size_t <var>j</var>)</i></dt>
<dt><a name="index-R_005fqsort_005fI"></a><u>Function:</u> void <b>R_qsort_I</b><i> (double *<var>v</var>, int *<var>I</var>, int <var>i</var>, int <var>j</var>)</i></dt>
<dt><a name="index-R_005fqsort_005fint"></a><u>Function:</u> void <b>R_qsort_int</b><i>   (int *<var>iv</var>, size_t <var>i</var>, size_t <var>j</var>)</i></dt>
<dt><a name="index-R_005fqsort_005fint_005fI"></a><u>Function:</u> void <b>R_qsort_int_I</b><i> (int *<var>iv</var>, int *<var>I</var>, int <var>i</var>, int <var>j</var>)</i></dt>
<dd>

<p>These routines sort <code><var>v</var>[<var>i</var>:<var>j</var>]</code> or
<code><var>iv</var>[<var>i</var>:<var>j</var>]</code> (using 1-indexing, i.e.,
<code><var>v</var>[1]</code> is the first element) calling the quicksort algorithm
as used by R&rsquo;s <code>sort(v, method = &quot;quick&quot;)</code> and documented on the
help page for the R function <code>sort</code>.  The <code>..._I()</code>
versions also return the <code>sort.index()</code> vector in <code>I</code>.  Note
that the ordering is <em>not</em> stable, so tied values may be permuted.
</p>
<p>Note that <code>NA</code>s are not handled (explicitly) and you should
use different sorting functions if <code>NA</code>s can be present.
</p></dd></dl>

<dl>
<dt><a name="index-qsort4"></a><u>Function:</u> subroutine <b>qsort4</b><i> (double precision <var>v</var>, integer <var>indx</var>, integer <var>ii</var>, integer <var>jj</var>)</i></dt>
<dt><a name="index-qsort3"></a><u>Function:</u> subroutine <b>qsort3</b><i> (double precision <var>v</var>, integer <var>ii</var>, integer <var>jj</var>)</i></dt>
<dd>
<p>The FORTRAN interface routines for sorting double precision vectors are
<code>qsort3</code> and <code>qsort4</code>, equivalent to <code>R_qsort</code> and
<code>R_qsort_I</code>, respectively.
</p></dd></dl>

<dl>
<dt><a name="index-R_005fmax_005fcol"></a><u>Function:</u> void <b>R_max_col</b><i> (double* <var>matrix</var>, int* <var>nr</var>, int* <var>nc</var>, int* <var>maxes</var>, int* <var>ties_meth</var>)</i></dt>
<dd><p>Given the <var>nr</var> by <var>nc</var> matrix <code>matrix</code> in column-major
(&ldquo;FORTRAN&rdquo;)
order, <code>R_max_col()</code> returns in <code><var>maxes</var>[<var>i</var>-1]</code> the
column number of the maximal element in the <var>i</var>-th row (the same as
R&rsquo;s <code>max.col()</code> function).  In the case of ties (multiple maxima),
<code>*ties_meth</code> is an integer code in <code>1:3</code> determining the method:
1 = &ldquo;random&rdquo;, 2 = &ldquo;first&rdquo; and 3 = &ldquo;last&rdquo;.
See R&rsquo;s help page <code>?max.col</code>.
</p></dd></dl>

<dl>
<dt><a name="index-findInterval"></a><u>Function:</u> int <b>findInterval</b><i> (double* <var>xt</var>, int <var>n</var>, double <var>x</var>, Rboolean <var>rightmost_closed</var>, Rboolean <var>all_inside</var>, int <var>ilo</var>, int* <var>mflag</var>)</i></dt>
<dd><p>Given the ordered vector <var>xt</var> of length <var>n</var>, return the interval
or index of <var>x</var> in <code><var>xt</var>[]</code>, typically max(<em>i</em>; 1 &lt;= i &lt;= <var>n</var> &amp; <em><var>xt</var>[i]</em> &lt;=<var>x</var>) where we use 1-indexing as in R and FORTRAN (but not C).  If
<var>rightmost_closed</var> is true, also returns <em><var>n</var>-1</em> if <var>x</var>
equals <em><var>xt</var>[<var>n</var>]</em>.  If <var>all_inside</var> is not 0, the
result is coerced to lie in <code>1:(<var>n</var>-1)</code> even when <var>x</var> is
outside the <var>xt</var>[] range.  On return, <code>*<var>mflag</var></code> equals
<em>-1</em> if <var>x</var> &lt; <var>xt</var>[1], <em>+1</em> if <var>x</var> &gt;=
<var>xt</var>[<var>n</var>], and 0 otherwise.
</p>
<p>The algorithm is particularly fast when <var>ilo</var> is set to the last
result of <code>findInterval()</code> and <var>x</var> is a value of a sequence which
is increasing or decreasing for subsequent calls.
</p>
<p>There is also an <code>F77_CALL(interv)()</code> version of
<code>findInterval()</code> with the same arguments, but all pointers.
</p></dd></dl>

<p>A system-independent interface to produce the name of a temporary
file is provided as
</p>
<dl>
<dt><a name="index-R_005ftmpnam"></a><u>Function:</u> char * <b>R_tmpnam</b><i> (const char *<var>prefix</var>, const char *<var>tmpdir</var>)</i></dt>
<dt><a name="index-R_005ftmpnam2"></a><u>Function:</u> char * <b>R_tmpnam2</b><i> (const char *<var>prefix</var>, const char *<var>tmpdir</var>, const char *<var>fileext</var>)</i></dt>
<dd><p>Return a pathname for a temporary file with name beginning with
<var>prefix</var> and ending with <var>fileext</var> in directory <var>tmpdir</var>.
A <code>NULL</code> prefix or extension is replaced by <code>&quot;&quot;</code>.  Note that
the return value is <code>malloc</code>ed and should be <code>free</code>d when no
longer needed (unlike the system call <code>tmpnam</code>).
</p></dd></dl>


<p>There is also the internal function used to expand file names in several
R functions, and called directly by <code>path.expand</code>.
</p>
<dl>
<dt><a name="index-R_005fExpandFileName"></a><u>Function:</u> const char * <b>R_ExpandFileName</b><i> (const char *<var>fn</var>)</i></dt>
<dd><p>Expand a path name <var>fn</var> by replacing a leading tilde by the user&rsquo;s
home directory (if defined).  The precise meaning is platform-specific;
it will usually be taken from the environment variable <code>HOME</code> if
this is defined.
</p></dd></dl>

<p>For historical reasons there are FORTRAN interfaces to functions
<code>D1MACH</code> and <code>I1MACH</code>.  These can be called from C code as
e.g. <code>F77_CALL(d1mach)(4)</code>.  Note that these are emulations of
the original functions by Fox, Hall and Schryer on NetLib at
<a href="http://www.netlib.org/slatec/src/">http://www.netlib.org/slatec/src/</a> for IEC 60559 arithmetic
(required by R).
</p>
<hr size="6">
<a name="Re_002dencoding"></a>
<table cellpadding="1" cellspacing="1" border="0">
<tr><td valign="middle" align="left">[<a href="#Utility-functions" title="Previous section in reading order"> &lt; </a>]</td>
<td valign="middle" align="left">[<a href="#Allowing-interrupts" title="Next section in reading order"> &gt; </a>]</td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left">[<a href="#The-R-API" title="Beginning of this chapter or previous chapter"> &lt;&lt; </a>]</td>
<td valign="middle" align="left">[<a href="#The-R-API" title="Up section"> Up </a>]</td>
<td valign="middle" align="left">[<a href="#Generic-functions-and-methods" title="Next chapter"> &gt;&gt; </a>]</td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left">[<a href="#Top" title="Cover (top) of document">Top</a>]</td>
<td valign="middle" align="left">[<a href="#SEC_Contents" title="Table of contents">Contents</a>]</td>
<td valign="middle" align="left">[<a href="#Function-and-variable-index" title="Index">Index</a>]</td>
<td valign="middle" align="left">[<a href="#SEC_About" title="About (help)"> ? </a>]</td>
</tr></table>
<a name="Re_002dencoding-1"></a>
<h2 class="section">6.11 Re-encoding</h2>

<p>R has its own C-level interface to the encoding conversion
capabilities provided by <code>iconv</code> because there are
incompatibilities between the declarations in different implementations
of <code>iconv</code>.
</p>
<p>These are declared in header file &lsquo;<tt>R_ext/Riconv.h</tt>&rsquo;.
</p>
<dl>
<dt><a name="index-_002aRiconv_005fopen"></a><u>Function:</u> void <b>*Riconv_open</b><i> (const char *<var>to</var>, const char *<var>from</var>)</i></dt>
</dl>
<p>Set up a pointer to an encoding object to be used to convert between two
encodings: <code>&quot;&quot;</code> indicates the current locale.
</p>
<dl>
<dt><a name="index-Riconv"></a><u>Function:</u> size_t <b>Riconv</b><i> (void *<var>cd</var>, const char **<var>inbuf</var>, size_t *<var>inbytesleft</var>, char  **<var>outbuf</var>, size_t *<var>outbytesleft</var>)</i></dt>
</dl>
<p>Convert as much as possible of <code>inbuf</code> to <code>outbuf</code>.  Initially
the <code>int</code> variables indicate the number of bytes available in the
buffers, and they are updated (and the <code>char</code> pointers are updated
to point to the next free byte in the buffer).  The return value is the
number of characters converted, or <code>(size_t)-1</code> (beware:
<code>size_t</code> is usually an unsigned type).  It should be safe to assume
that an error condition sets <code>errno</code> to one of <code>E2BIG</code> (the
output buffer is full), <code>EILSEQ</code> (the input cannot be converted,
and might be invalid in the encoding specified) or <code>EINVAL</code> (the
input does not end with a complete multi-byte character).
</p>
<dl>
<dt><a name="index-Riconv_005fclose"></a><u>Function:</u> int <b>Riconv_close</b><i> (void * <var>cd</var>)</i></dt>
</dl>
<p>Free the resources of an encoding object.
</p>

<hr size="6">
<a name="Allowing-interrupts"></a>
<table cellpadding="1" cellspacing="1" border="0">
<tr><td valign="middle" align="left">[<a href="#Re_002dencoding" title="Previous section in reading order"> &lt; </a>]</td>
<td valign="middle" align="left">[<a href="#Platform-and-version-information" title="Next section in reading order"> &gt; </a>]</td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left">[<a href="#The-R-API" title="Beginning of this chapter or previous chapter"> &lt;&lt; </a>]</td>
<td valign="middle" align="left">[<a href="#The-R-API" title="Up section"> Up </a>]</td>
<td valign="middle" align="left">[<a href="#Generic-functions-and-methods" title="Next chapter"> &gt;&gt; </a>]</td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left">[<a href="#Top" title="Cover (top) of document">Top</a>]</td>
<td valign="middle" align="left">[<a href="#SEC_Contents" title="Table of contents">Contents</a>]</td>
<td valign="middle" align="left">[<a href="#Function-and-variable-index" title="Index">Index</a>]</td>
<td valign="middle" align="left">[<a href="#SEC_About" title="About (help)"> ? </a>]</td>
</tr></table>
<a name="Allowing-interrupts-1"></a>
<h2 class="section">6.12 Allowing interrupts</h2>
<a name="index-Interrupts"></a>

<p>No port of R can be interrupted whilst running long computations in
compiled code, so programmers should make provision for the code to be
interrupted at suitable points by calling from C
</p>
<table><tr><td>&nbsp;</td><td><pre class="example">#include &lt;R_ext/Utils.h&gt;

void R_CheckUserInterrupt(void);
</pre></td></tr></table>

<p>and from FORTRAN
</p>
<table><tr><td>&nbsp;</td><td><pre class="example">subroutine rchkusr()
</pre></td></tr></table>

<p>These check if the user has requested an interrupt, and if so branch to
R&rsquo;s error handling functions.
</p>
<p>Note that it is possible that the code behind one of the entry points
defined here if called from your C or FORTRAN code could be interruptible
or generate an error and so not return to your code.
</p>

<hr size="6">
<a name="Platform-and-version-information"></a>
<table cellpadding="1" cellspacing="1" border="0">
<tr><td valign="middle" align="left">[<a href="#Allowing-interrupts" title="Previous section in reading order"> &lt; </a>]</td>
<td valign="middle" align="left">[<a href="#Inlining-C-functions" title="Next section in reading order"> &gt; </a>]</td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left">[<a href="#The-R-API" title="Beginning of this chapter or previous chapter"> &lt;&lt; </a>]</td>
<td valign="middle" align="left">[<a href="#The-R-API" title="Up section"> Up </a>]</td>
<td valign="middle" align="left">[<a href="#Generic-functions-and-methods" title="Next chapter"> &gt;&gt; </a>]</td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left">[<a href="#Top" title="Cover (top) of document">Top</a>]</td>
<td valign="middle" align="left">[<a href="#SEC_Contents" title="Table of contents">Contents</a>]</td>
<td valign="middle" align="left">[<a href="#Function-and-variable-index" title="Index">Index</a>]</td>
<td valign="middle" align="left">[<a href="#SEC_About" title="About (help)"> ? </a>]</td>
</tr></table>
<a name="Platform-and-version-information-1"></a>
<h2 class="section">6.13 Platform and version information</h2>
<a name="index-Version-information-from-C"></a>
<a name="index-OpenMP-1"></a>
<a name="index-R_005fVersion"></a>

<p>The header files define <code>USING_R</code>, which can be used to test if
the code is indeed being used with R.
</p>
<p>Header file &lsquo;<tt>Rconfig.h</tt>&rsquo; (included by &lsquo;<tt>R.h</tt>&rsquo;) is used to define
platform-specific macros that are mainly for use in other header files.
The macro <code>WORDS_BIGENDIAN</code> is defined on
big-endian<a name="DOCF74" href="#FOOT74">(74)</a>
systems (e.g. most OSes on Sparc and PowerPC hardware) and not on
little-endian systems (such as <code>i686</code> and <code>x86_64</code> on all
OSes, and Linux on Alpha and Itanium).  It can be useful when
manipulating binary files.  The macro <code>SUPPORT_OPENMP</code> is defined
on suitable systems and can be used in conjunction with the
<code>SUPPORT_OPENMP_*</code> macros in packages that want to make use of
OpenMP.
</p>
<p>Header file &lsquo;<tt>Rversion.h</tt>&rsquo; (<strong>not</strong> included by &lsquo;<tt>R.h</tt>&rsquo;)
defines a macro <code>R_VERSION</code> giving the version number encoded as an
integer, plus a macro <code>R_Version</code> to do the encoding.  This can be
used to test if the version of R is late enough, or to include
back-compatibility features.  For protection against very old versions
of R which did not have this macro, use a construction such as
</p>
<table><tr><td>&nbsp;</td><td><pre class="example">#if defined(R_VERSION) &amp;&amp; R_VERSION &gt;= R_Version(1, 9, 0)
  ...
#endif
</pre></td></tr></table>

<p>More detailed information is available in the macros <code>R_MAJOR</code>,
<code>R_MINOR</code>, <code>R_YEAR</code>, <code>R_MONTH</code> and <code>R_DAY</code>: see the
header file &lsquo;<tt>Rversion.h</tt>&rsquo; for their format.  Note that the minor
version includes the patchlevel (as in &lsquo;<samp>9.0</samp>&rsquo;).
</p>
<hr size="6">
<a name="Inlining-C-functions"></a>
<table cellpadding="1" cellspacing="1" border="0">
<tr><td valign="middle" align="left">[<a href="#Platform-and-version-information" title="Previous section in reading order"> &lt; </a>]</td>
<td valign="middle" align="left">[<a href="#Controlling-visibility" title="Next section in reading order"> &gt; </a>]</td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left">[<a href="#The-R-API" title="Beginning of this chapter or previous chapter"> &lt;&lt; </a>]</td>
<td valign="middle" align="left">[<a href="#The-R-API" title="Up section"> Up </a>]</td>
<td valign="middle" align="left">[<a href="#Generic-functions-and-methods" title="Next chapter"> &gt;&gt; </a>]</td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left">[<a href="#Top" title="Cover (top) of document">Top</a>]</td>
<td valign="middle" align="left">[<a href="#SEC_Contents" title="Table of contents">Contents</a>]</td>
<td valign="middle" align="left">[<a href="#Function-and-variable-index" title="Index">Index</a>]</td>
<td valign="middle" align="left">[<a href="#SEC_About" title="About (help)"> ? </a>]</td>
</tr></table>
<a name="Inlining-C-functions-1"></a>
<h2 class="section">6.14 Inlining C functions</h2>
<a name="index-R_005fINLINE"></a>

<p>The C99 keyword <code>inline</code> should be recognized by all compilers now
used to build R.  Portable code which might be used with earlier
versions of R can be written using the macro <code>R_INLINE</code> (defined
in file &lsquo;<tt>Rconfig.h</tt>&rsquo; included by &lsquo;<tt>R.h</tt>&rsquo;), as for example from
package <a href="http://CRAN.R-project.org/package=cluster"><strong>cluster</strong></a>
</p>
<table><tr><td>&nbsp;</td><td><pre class="example">#include &lt;R.h&gt;

static R_INLINE int ind_2(int l, int j)
{
...
}
</pre></td></tr></table>

<p>Be aware that using inlining with functions in more than one compilation
unit is almost impossible to do portably, see
<a href="http://www.greenend.org.uk/rjk/2003/03/inline.html">http://www.greenend.org.uk/rjk/2003/03/inline.html</a>, so this usage
is for <code>static</code> functions as in the example.  All the R
configure code has checked is that <code>R_INLINE</code> can be used in a
single C file with the compiler used to build R.  We recommend that
packages making extensive use of inlining include their own configure
code.
</p>
<hr size="6">
<a name="Controlling-visibility"></a>
<table cellpadding="1" cellspacing="1" border="0">
<tr><td valign="middle" align="left">[<a href="#Inlining-C-functions" title="Previous section in reading order"> &lt; </a>]</td>
<td valign="middle" align="left">[<a href="#Standalone-Mathlib" title="Next section in reading order"> &gt; </a>]</td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left">[<a href="#The-R-API" title="Beginning of this chapter or previous chapter"> &lt;&lt; </a>]</td>
<td valign="middle" align="left">[<a href="#The-R-API" title="Up section"> Up </a>]</td>
<td valign="middle" align="left">[<a href="#Generic-functions-and-methods" title="Next chapter"> &gt;&gt; </a>]</td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left">[<a href="#Top" title="Cover (top) of document">Top</a>]</td>
<td valign="middle" align="left">[<a href="#SEC_Contents" title="Table of contents">Contents</a>]</td>
<td valign="middle" align="left">[<a href="#Function-and-variable-index" title="Index">Index</a>]</td>
<td valign="middle" align="left">[<a href="#SEC_About" title="About (help)"> ? </a>]</td>
</tr></table>
<a name="Controlling-visibility-1"></a>
<h2 class="section">6.15 Controlling visibility</h2>
<a name="index-Visibility"></a>

<p>Header &lsquo;<tt>R_ext/Visibility</tt>&rsquo; has some definitions for controlling the
visibility of entry points.  These are only effective when
&lsquo;<samp>HAVE_VISIBILITY_ATTRIBUTE</samp>&rsquo; is defined &ndash; this is checked when R
is configured and recorded in header &lsquo;<tt>Rconfig.h</tt>&rsquo; (included by
&lsquo;<tt>R_ext/Visibility.h</tt>&rsquo;).  It is generally defined on modern
Unix-alikes with a recent compiler (e.g. <code>gcc4</code>), but not
supported on Windows.  Minimizing the visibility of symbols in a shared
library will both speed up its loading (unlikely to be significant) and
reduce the possibility of linking to the wrong entry points of the same
name.
</p>
<p>C/C++ entry points prefixed by <code>attribute_hidden</code> will not be
visible in the shared object.  There is no comparable mechanism for
FORTRAN entry points, but there is a more comprehensive scheme used by,
for example package <strong>stats</strong>.  Most compilers which allow control of
visibility will allow control of visibility for all symbols <em>via</em> a flag,
and where known the flag is encapsulated in the macros
&lsquo;<samp>C_VISIBILITY</samp>&rsquo; and <code>F77_VISIBILITY</code> for C and FORTRAN
compilers.  These are defined in &lsquo;<tt>etc/Makeconf</tt>&rsquo; and so available
for normal compilation of package code.  For example,
&lsquo;<tt>src/Makevars</tt>&rsquo; could include
</p>
<table><tr><td>&nbsp;</td><td><pre class="example">PKG_CFLAGS=$(C_VISIBILITY)
PKG_FFLAGS=$(F77_VISIBILITY)
</pre></td></tr></table>

<p>This would end up with <strong>no</strong> visible entry points, which would be
pointless.  However, the effect of the flags can be overridden by using
the <code>attribute_visible</code> prefix.  A shared object which registers
its entry points needs only for have one visible entry point, its
initializer, so for example package <strong>stats</strong> has
</p>
<table><tr><td>&nbsp;</td><td><pre class="example">void attribute_visible R_init_stats(DllInfo *dll)
{
    R_registerRoutines(dll, CEntries, CallEntries, FortEntries, NULL);
    R_useDynamicSymbols(dll, FALSE);
...
}
</pre></td></tr></table>

<p>The visibility mechanism is not available on Windows, but there is an
equally effective way to control which entry points are visible, by
supplying a definitions file
&lsquo;<tt><var>pkgnme</var>/src/<var>pkgname</var>-win.def</tt>&rsquo;: only entry points
listed in that file will be visible.  Again using <strong>stats</strong> as an
example, it has
</p>
<table><tr><td>&nbsp;</td><td><pre class="example">LIBRARY stats.dll
EXPORTS
 R_init_stats
</pre></td></tr></table>

<hr size="6">
<a name="Standalone-Mathlib"></a>
<table cellpadding="1" cellspacing="1" border="0">
<tr><td valign="middle" align="left">[<a href="#Controlling-visibility" title="Previous section in reading order"> &lt; </a>]</td>
<td valign="middle" align="left">[<a href="#Organization-of-header-files" title="Next section in reading order"> &gt; </a>]</td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left">[<a href="#The-R-API" title="Beginning of this chapter or previous chapter"> &lt;&lt; </a>]</td>
<td valign="middle" align="left">[<a href="#The-R-API" title="Up section"> Up </a>]</td>
<td valign="middle" align="left">[<a href="#Generic-functions-and-methods" title="Next chapter"> &gt;&gt; </a>]</td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left">[<a href="#Top" title="Cover (top) of document">Top</a>]</td>
<td valign="middle" align="left">[<a href="#SEC_Contents" title="Table of contents">Contents</a>]</td>
<td valign="middle" align="left">[<a href="#Function-and-variable-index" title="Index">Index</a>]</td>
<td valign="middle" align="left">[<a href="#SEC_About" title="About (help)"> ? </a>]</td>
</tr></table>
<a name="Using-these-functions-in-your-own-C-code"></a>
<h2 class="section">6.16 Using these functions in your own C code</h2>

<p>It is possible to build <code>Mathlib</code>, the R set of mathematical
functions documented in &lsquo;<tt>Rmath.h</tt>&rsquo;, as a standalone library
&lsquo;<tt>libRmath</tt>&rsquo; under both Unix-alikes and Windows.  (This includes the
functions documented in <a href="#Numerical-analysis-subroutines">Numerical analysis subroutines</a> as from
that header file.)
</p>
<p>The library is not built automatically when R is installed, but can
be built in the directory &lsquo;<tt>src/nmath/standalone</tt>&rsquo; in the R
sources: see the file &lsquo;<tt>README</tt>&rsquo; there.  To use the code in your own
C program include
</p>
<table><tr><td>&nbsp;</td><td><pre class="example">#define MATHLIB_STANDALONE
#include &lt;Rmath.h&gt;
</pre></td></tr></table>

<p>and link against &lsquo;<samp>-lRmath</samp>&rsquo; (and perhaps &lsquo;<samp>-lm</samp>&rsquo;.  There is an
example file &lsquo;<tt>test.c</tt>&rsquo;.
</p>
<p>A little care is needed to use the random-number routines. You will
need to supply the uniform random number generator
</p>
<table><tr><td>&nbsp;</td><td><pre class="example">double unif_rand(void)
</pre></td></tr></table>

<p>or use the one supplied (and with a dynamic library or DLL you will have
to use the one supplied, which is the Marsaglia-multicarry with an entry
points
</p>
<table><tr><td>&nbsp;</td><td><pre class="example">set_seed(unsigned int, unsigned int)
</pre></td></tr></table>

<p>to set its seeds and
</p>
<table><tr><td>&nbsp;</td><td><pre class="example">get_seed(unsigned int *, unsigned int *)
</pre></td></tr></table>

<p>to read the seeds).
</p>
<hr size="6">
<a name="Organization-of-header-files"></a>
<table cellpadding="1" cellspacing="1" border="0">
<tr><td valign="middle" align="left">[<a href="#Standalone-Mathlib" title="Previous section in reading order"> &lt; </a>]</td>
<td valign="middle" align="left">[<a href="#Generic-functions-and-methods" title="Next section in reading order"> &gt; </a>]</td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left">[<a href="#The-R-API" title="Beginning of this chapter or previous chapter"> &lt;&lt; </a>]</td>
<td valign="middle" align="left">[<a href="#The-R-API" title="Up section"> Up </a>]</td>
<td valign="middle" align="left">[<a href="#Generic-functions-and-methods" title="Next chapter"> &gt;&gt; </a>]</td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left">[<a href="#Top" title="Cover (top) of document">Top</a>]</td>
<td valign="middle" align="left">[<a href="#SEC_Contents" title="Table of contents">Contents</a>]</td>
<td valign="middle" align="left">[<a href="#Function-and-variable-index" title="Index">Index</a>]</td>
<td valign="middle" align="left">[<a href="#SEC_About" title="About (help)"> ? </a>]</td>
</tr></table>
<a name="Organization-of-header-files-1"></a>
<h2 class="section">6.17 Organization of header files</h2>

<p>The header files which R installs are in directory
&lsquo;<tt><var>R_INCLUDE_DIR</var></tt>&rsquo; (default &lsquo;<tt><var>R_HOME</var>/include</tt>&rsquo;).  This
currently includes
</p>
<blockquote><table>
<tr><td width="30%">&lsquo;<tt>R.h</tt>&rsquo;</td><td width="55%">includes many other files</td></tr>
<tr><td width="30%">&lsquo;<tt>S.h</tt>&rsquo;</td><td width="55%">different version for code ported from S</td></tr>
<tr><td width="30%">&lsquo;<tt>Rinternals.h</tt>&rsquo;</td><td width="55%">definitions for using R&rsquo;s internal
structures</td></tr>
<tr><td width="30%">&lsquo;<tt>Rdefines.h</tt>&rsquo;</td><td width="55%">macros for an S-like interface to the
above</td></tr>
<tr><td width="30%">&lsquo;<tt>Rmath.h</tt>&rsquo;</td><td width="55%">standalone math library</td></tr>
<tr><td width="30%">&lsquo;<tt>Rversion.h</tt>&rsquo;</td><td width="55%">R version information</td></tr>
<tr><td width="30%">&lsquo;<tt>Rinterface.h</tt>&rsquo;</td><td width="55%">for add-on front-ends (Unix-alikes only)</td></tr>
<tr><td width="30%">&lsquo;<tt>Rembedded.h</tt>&rsquo;</td><td width="55%">for add-on front-ends</td></tr>
<tr><td width="30%">&lsquo;<tt>R_ext/Applic.h</tt>&rsquo;</td><td width="55%">optimization and integration</td></tr>
<tr><td width="30%">&lsquo;<tt>R_ext/BLAS.h</tt>&rsquo;</td><td width="55%">C definitions for BLAS routines</td></tr>
<tr><td width="30%">&lsquo;<tt>R_ext/Callbacks.h</tt>&rsquo;</td><td width="55%">C (and R function) top-level task
handlers</td></tr>
<tr><td width="30%">&lsquo;<tt>R_ext/GetX11Image.h</tt>&rsquo;</td><td width="55%">X11Image interface used by package
<strong>trkplot</strong></td></tr>
<tr><td width="30%">&lsquo;<tt>R_ext/Lapack.h</tt>&rsquo;</td><td width="55%">C definitions for some LAPACK routines</td></tr>
<tr><td width="30%">&lsquo;<tt>R_ext/Linpack.h</tt>&rsquo;</td><td width="55%">C definitions for some LINPACK
routines, not all of which are included in R</td></tr>
<tr><td width="30%">&lsquo;<tt>R_ext/Parse.h</tt>&rsquo;</td><td width="55%">a small part of R&rsquo;s parse interface:
not part of the stable API.</td></tr>
<tr><td width="30%">&lsquo;<tt>R_ext/RConvertors.h</tt>&rsquo;</td></tr>
<tr><td width="30%">&lsquo;<tt>R_ext/RStartup.h</tt>&rsquo;</td><td width="55%">for add-on front-ends</td></tr>
<tr><td width="30%">&lsquo;<tt>R_ext/Rdynload.h</tt>&rsquo;</td><td width="55%">needed to register compiled code in
packages</td></tr>
<tr><td width="30%">&lsquo;<tt>R_ext/R-ftp-http.h</tt>&rsquo;</td><td width="55%">interface to internal method of
<code>download.file</code></td></tr>
<tr><td width="30%">&lsquo;<tt>R_ext/Riconv.h</tt>&rsquo;</td><td width="55%">interface to <code>iconv</code></td></tr>
<tr><td width="30%">&lsquo;<tt>R_ext/Visibility.h</tt>&rsquo;</td><td width="55%">definitions controlling visibility</td></tr>
<tr><td width="30%">&lsquo;<tt>R_ext/eventloop.h</tt>&rsquo;</td><td width="55%">for add-on front-ends and for
packages that need to share in the R event loops (on all platforms)</td></tr>
</table>
</blockquote>

<p>The following headers are included by &lsquo;<tt>R.h</tt>&rsquo;:
</p>
<blockquote><table>
<tr><td width="30%">&lsquo;<tt>Rconfig.h</tt>&rsquo;</td><td width="55%">configuration info that is made available</td></tr>
<tr><td width="30%">&lsquo;<tt>R_ext/Arith.h</tt>&rsquo;</td><td width="55%">handling for <code>NA</code>s, <code>NaN</code>s,
<code>Inf</code>/<code>-Inf</code></td></tr>
<tr><td width="30%">&lsquo;<tt>R_ext/Boolean.h</tt>&rsquo;</td><td width="55%"><code>TRUE</code>/<code>FALSE</code> type</td></tr>
<tr><td width="30%">&lsquo;<tt>R_ext/Complex.h</tt>&rsquo;</td><td width="55%">C typedefs for R&rsquo;s <code>complex</code></td></tr>
<tr><td width="30%">&lsquo;<tt>R_ext/Constants.h</tt>&rsquo;</td><td width="55%">constants</td></tr>
<tr><td width="30%">&lsquo;<tt>R_ext/Error.h</tt>&rsquo;</td><td width="55%">error handling</td></tr>
<tr><td width="30%">&lsquo;<tt>R_ext/Memory.h</tt>&rsquo;</td><td width="55%">memory allocation</td></tr>
<tr><td width="30%">&lsquo;<tt>R_ext/Print.h</tt>&rsquo;</td><td width="55%"><code>Rprintf</code> and variations.</td></tr>
<tr><td width="30%">&lsquo;<tt>R_ext/RS.h</tt>&rsquo;</td><td width="55%">definitions common to &lsquo;<tt>R.h</tt>&rsquo; and
&lsquo;<tt>S.h</tt>&rsquo;, including <code>F77_CALL</code> etc.</td></tr>
<tr><td width="30%">&lsquo;<tt>R_ext/Random.h</tt>&rsquo;</td><td width="55%">random number generation</td></tr>
<tr><td width="30%">&lsquo;<tt>R_ext/Utils.h</tt>&rsquo;</td><td width="55%">sorting and other utilities</td></tr>
<tr><td width="30%">&lsquo;<tt>R_ext/libextern.h</tt>&rsquo;</td><td width="55%">definitions for exports from
&lsquo;<tt>R.dll</tt>&rsquo; on Windows.</td></tr>
</table>
</blockquote>

<p>The graphics systems are exposed in headers
&lsquo;<tt>R_ext/GraphicsEngine.h</tt>&rsquo;, &lsquo;<tt>R_ext/GraphicsDevice.h</tt>&rsquo; (which it
includes) and &lsquo;<tt>R_ext/QuartzDevice.h</tt>&rsquo;.  Some entry points from the
<strong>stats</strong> package are in &lsquo;<tt>R_ext/stats_package.h</tt>&rsquo; (currently
related to the internals of <code>nls</code> and <code>nlminb</code>).
</p>

<hr size="6">
<a name="Generic-functions-and-methods"></a>
<table cellpadding="1" cellspacing="1" border="0">
<tr><td valign="middle" align="left">[<a href="#Organization-of-header-files" title="Previous section in reading order"> &lt; </a>]</td>
<td valign="middle" align="left">[<a href="#Adding-new-generics" title="Next section in reading order"> &gt; </a>]</td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left">[<a href="#The-R-API" title="Beginning of this chapter or previous chapter"> &lt;&lt; </a>]</td>
<td valign="middle" align="left">[<a href="#Top" title="Up section"> Up </a>]</td>
<td valign="middle" align="left">[<a href="#Linking-GUIs-and-other-front_002dends-to-R" title="Next chapter"> &gt;&gt; </a>]</td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left">[<a href="#Top" title="Cover (top) of document">Top</a>]</td>
<td valign="middle" align="left">[<a href="#SEC_Contents" title="Table of contents">Contents</a>]</td>
<td valign="middle" align="left">[<a href="#Function-and-variable-index" title="Index">Index</a>]</td>
<td valign="middle" align="left">[<a href="#SEC_About" title="About (help)"> ? </a>]</td>
</tr></table>
<a name="Generic-functions-and-methods-1"></a>
<h1 class="chapter">7. Generic functions and methods</h1>
<a name="index-Generic-functions"></a>
<a name="index-Method-functions"></a>

<p>R programmers will often want to add methods for existing generic
functions, and may want to add new generic functions or make existing
functions generic.  In this chapter we give guidelines for doing so,
with examples of the problems caused by not adhering to them.
</p>
<p>This chapter only covers the &lsquo;informal&rsquo; class system copied from S3,
and not with the S4 (formal) methods of package <strong>methods</strong>.
</p>
<p>The key function for methods is <code>NextMethod</code>, which dispatches the
next method.  It is quite typical for a method function to make a few
changes to its arguments, dispatch to the next method, receive the
results and modify them a little.  An example is
</p>
<table><tr><td>&nbsp;</td><td><pre class="example">t.data.frame &lt;- function(x)
{
    x &lt;- as.matrix(x)
    NextMethod(&quot;t&quot;)
}
</pre></td></tr></table>

<p>Also consider <code>predict.glm</code>: it happens that in R for historical
reasons it calls <code>predict.lm</code> directly, but in principle (and in S
originally and currently) it could use <code>NextMethod</code>.
(<code>NextMethod</code> seems under-used in the R sources.  Do be aware
that there are S/R differences in this area, and the example above works
because there is a <em>next</em> method, the default method, not that a
new method is selected when the class is changed.)
</p>
<p><em>Any</em> method a programmer writes may be invoked from another method
by <code>NextMethod</code>, <em>with the arguments appropriate to the
previous method</em>.  Further, the programmer cannot predict which method
<code>NextMethod</code> will pick (it might be one not yet dreamt of), and the
end user calling the generic needs to be able to pass arguments to the
next method.  For this to work
</p>
<blockquote><p><em>A method must have all the arguments of the generic, including
<code>&hellip;</code> if the generic does.</em>
</p></blockquote>

<p>It is a grave misunderstanding to think that a method needs only to
accept the arguments it needs.  The original S version of
<code>predict.lm</code> did not have a <code>&hellip;</code> argument, although
<code>predict</code> did.  It soon became clear that <code>predict.glm</code> needed
an argument <code>dispersion</code> to handle over-dispersion.  As
<code>predict.lm</code> had neither a <code>dispersion</code> nor a <code>&hellip;</code>
argument, <code>NextMethod</code> could no longer be used.  (The legacy, two
direct calls to <code>predict.lm</code>, lives on in <code>predict.glm</code> in
R, which is based on the workaround for S3 written by Venables &amp;
Ripley.)
</p>
<p>Further, the user is entitled to use positional matching when calling
the generic, and the arguments to a method called by <code>UseMethod</code>
are those of the call to the generic.  Thus
</p>
<blockquote><p><em>A method must have arguments in exactly the same order as the
generic.</em>
</p></blockquote>

<p>To see the scale of this problem, consider the generic function
<code>scale</code>, defined as
</p>
<table><tr><td>&nbsp;</td><td><pre class="example">scale &lt;- function (x, center = TRUE, scale = TRUE)
    UseMethod(&quot;scale&quot;)
</pre></td></tr></table>

<p>Suppose an unthinking package writer created methods such as
</p>
<table><tr><td>&nbsp;</td><td><pre class="example">scale.foo &lt;- function(x, scale = FALSE, ...) { }
</pre></td></tr></table>

<p>Then for <code>x</code> of class <code>&quot;foo&quot;</code> the calls
</p>
<table><tr><td>&nbsp;</td><td><pre class="example">scale(x, , TRUE)
scale(x, scale = TRUE)
</pre></td></tr></table>

<p>would do most likely do different things, to the justifiable
consternation of the end user.
</p>
<p>To add a further twist, which default is used when a user calls
<code>scale(x)</code> in our example?  What if
</p>
<table><tr><td>&nbsp;</td><td><pre class="example">scale.bar &lt;- function(x, center, scale = TRUE) NextMethod(&quot;scale&quot;)
</pre></td></tr></table>

<p>and <code>x</code> has class <code>c(&quot;bar&quot;, &quot;foo&quot;)</code>?  It is the default
specified in the method that is used, but the default
specified in the generic may be the one the user sees.
This leads to the recommendation:
</p>
<blockquote><p><em>If the generic specifies defaults, all methods should use the same defaults.</em>
</p></blockquote>

<p>An easy way to follow these recommendations is to always keep generics
simple, e.g.
</p>
<table><tr><td>&nbsp;</td><td><pre class="example">scale &lt;- function(x, ...) UseMethod(&quot;scale&quot;)
</pre></td></tr></table>

<p>Only add parameters and defaults to the generic if they make sense in
all possible methods implementing it.
</p>
<table class="menu" border="0" cellspacing="0">
<tr><td align="left" valign="top"><a href="#Adding-new-generics">7.1 Adding new generics</a></td><td>&nbsp;&nbsp;</td><td align="left" valign="top">         
</td></tr>
</table>

<hr size="6">
<a name="Adding-new-generics"></a>
<table cellpadding="1" cellspacing="1" border="0">
<tr><td valign="middle" align="left">[<a href="#Generic-functions-and-methods" title="Previous section in reading order"> &lt; </a>]</td>
<td valign="middle" align="left">[<a href="#Linking-GUIs-and-other-front_002dends-to-R" title="Next section in reading order"> &gt; </a>]</td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left">[<a href="#Generic-functions-and-methods" title="Beginning of this chapter or previous chapter"> &lt;&lt; </a>]</td>
<td valign="middle" align="left">[<a href="#Generic-functions-and-methods" title="Up section"> Up </a>]</td>
<td valign="middle" align="left">[<a href="#Linking-GUIs-and-other-front_002dends-to-R" title="Next chapter"> &gt;&gt; </a>]</td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left">[<a href="#Top" title="Cover (top) of document">Top</a>]</td>
<td valign="middle" align="left">[<a href="#SEC_Contents" title="Table of contents">Contents</a>]</td>
<td valign="middle" align="left">[<a href="#Function-and-variable-index" title="Index">Index</a>]</td>
<td valign="middle" align="left">[<a href="#SEC_About" title="About (help)"> ? </a>]</td>
</tr></table>
<a name="Adding-new-generics-1"></a>
<h2 class="section">7.1 Adding new generics</h2>

<p>When creating a new generic function, bear in mind that its argument
list will be the maximal set of arguments for methods, including those
written elsewhere years later.  So choosing a good set of arguments may
well be an important design issue, and there need to be good arguments
<em>not</em> to include a <code>&hellip;</code> argument.
</p>
<p>If a <code>&hellip;</code> argument is supplied, some thought should be given
to its position in the argument sequence.  Arguments which follow
<code>&hellip;</code> must be named in calls to the function, and they must be
named in full (partial matching is suppressed after <code>&hellip;</code>).
Formal arguments before <code>&hellip;</code> can be partially matched, and so
may &lsquo;swallow&rsquo; actual arguments intended for <code>&hellip;</code>.  Although it
is commonplace to make the <code>&hellip;</code> argument the last one, that is
not always the right choice.
</p>
<p>Sometimes package writers want to make generic a function in the base
package, and request a change in R.  This may be justifiable, but
making a function generic with the old definition as the default method
does have a small performance cost.  It is never necessary, as a package
can take over a function in the base package and make it generic by
something like
</p>
<table><tr><td>&nbsp;</td><td><pre class="example">foo &lt;- function(object, ...) UseMethod(&quot;foo&quot;)
foo.default &lt;- function(object, ...) base::foo(object)
</pre></td></tr></table>

<p>Earlier versions of this manual suggested assigning <code>foo.default &lt;-
base::foo</code>.  This is <strong>not</strong> a good idea, as it captures the base
function at the time of installation and it might be changed as R is
patched or updated.
</p>
<p>The same idea can be applied for functions in other packages with namespaces.
</p>
<hr size="6">
<a name="Linking-GUIs-and-other-front_002dends-to-R"></a>
<table cellpadding="1" cellspacing="1" border="0">
<tr><td valign="middle" align="left">[<a href="#Adding-new-generics" title="Previous section in reading order"> &lt; </a>]</td>
<td valign="middle" align="left">[<a href="#Embedding-R-under-Unix_002dalikes" title="Next section in reading order"> &gt; </a>]</td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left">[<a href="#Generic-functions-and-methods" title="Beginning of this chapter or previous chapter"> &lt;&lt; </a>]</td>
<td valign="middle" align="left">[<a href="#Top" title="Up section"> Up </a>]</td>
<td valign="middle" align="left">[<a href="#Function-and-variable-index" title="Next chapter"> &gt;&gt; </a>]</td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left">[<a href="#Top" title="Cover (top) of document">Top</a>]</td>
<td valign="middle" align="left">[<a href="#SEC_Contents" title="Table of contents">Contents</a>]</td>
<td valign="middle" align="left">[<a href="#Function-and-variable-index" title="Index">Index</a>]</td>
<td valign="middle" align="left">[<a href="#SEC_About" title="About (help)"> ? </a>]</td>
</tr></table>
<a name="Linking-GUIs-and-other-front_002dends-to-R-1"></a>
<h1 class="chapter">8. Linking GUIs and other front-ends to R</h1>

<p>There are a number of ways to build front-ends to R: we take this to
mean a GUI or other application that has the ability to submit commands
to R and perhaps to receive results back (not necessarily in a text
format).  There are other routes besides those described here, for
example the package <a href="http://CRAN.R-project.org/package=Rserve"><strong>Rserve</strong></a> (from <acronym>CRAN</acronym>, see also
<a href="http://www.rforge.net/Rserve/">http://www.rforge.net/Rserve/</a>) and connections to Java in the
Omegahat package &lsquo;<samp>SJava</samp>&rsquo; and &lsquo;<samp>JRI</samp>&rsquo; (part of the
<a href="http://CRAN.R-project.org/package=rJava"><strong>rJava</strong></a> package on <acronym>CRAN</acronym>).
</p>
<p>Note that the APIs described in this chapter are only intended to be
used in an alternative front-end: they are not part of the API made
available for R packages and can be dangerous to use in a
conventional package (although packages may contain alternative
front-ends).
</p>
<table class="menu" border="0" cellspacing="0">
<tr><td align="left" valign="top"><a href="#Embedding-R-under-Unix_002dalikes">8.1 Embedding R under Unix-alikes</a></td><td>&nbsp;&nbsp;</td><td align="left" valign="top">  
</td></tr>
<tr><td align="left" valign="top"><a href="#Embedding-R-under-Windows">8.2 Embedding R under Windows</a></td><td>&nbsp;&nbsp;</td><td align="left" valign="top">   
</td></tr>
</table>

<hr size="6">
<a name="Embedding-R-under-Unix_002dalikes"></a>
<table cellpadding="1" cellspacing="1" border="0">
<tr><td valign="middle" align="left">[<a href="#Linking-GUIs-and-other-front_002dends-to-R" title="Previous section in reading order"> &lt; </a>]</td>
<td valign="middle" align="left">[<a href="#Compiling-against-the-R-library" title="Next section in reading order"> &gt; </a>]</td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left">[<a href="#Linking-GUIs-and-other-front_002dends-to-R" title="Beginning of this chapter or previous chapter"> &lt;&lt; </a>]</td>
<td valign="middle" align="left">[<a href="#Linking-GUIs-and-other-front_002dends-to-R" title="Up section"> Up </a>]</td>
<td valign="middle" align="left">[<a href="#Function-and-variable-index" title="Next chapter"> &gt;&gt; </a>]</td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left">[<a href="#Top" title="Cover (top) of document">Top</a>]</td>
<td valign="middle" align="left">[<a href="#SEC_Contents" title="Table of contents">Contents</a>]</td>
<td valign="middle" align="left">[<a href="#Function-and-variable-index" title="Index">Index</a>]</td>
<td valign="middle" align="left">[<a href="#SEC_About" title="About (help)"> ? </a>]</td>
</tr></table>
<a name="Embedding-R-under-Unix_002dalikes-1"></a>
<h2 class="section">8.1 Embedding R under Unix-alikes</h2>

<p>R can be built as a shared library<a name="DOCF75" href="#FOOT75">(75)</a> if configured with &lsquo;<samp>--enable-R-shlib</samp>&rsquo;.  This
shared library can be used to run R from alternative front-end
programs.  We will assume this has been done for the rest of this
section.  Also, it can be built as a static library if configured with
&lsquo;<samp>--enable-R-static-lib</samp>&rsquo;, and this can be used in a very similar
way.
</p>
<p>The command-line R front-end, &lsquo;<tt><var>R_HOME</var>/bin/exec/R</tt>&rsquo; is one
such example, and the former <acronym>GNOME</acronym> (see package <strong>gnomeGUI</strong>
on <acronym>CRAN</acronym>&rsquo;s &lsquo;<samp>Archive</samp>&rsquo; area) and Mac OS X consoles are
others.  The source for &lsquo;<tt><var>R_HOME</var>/bin/exec/R</tt>&rsquo; is in file
&lsquo;<tt>src/main/Rmain.c</tt>&rsquo; and is very simple
</p>
<table><tr><td>&nbsp;</td><td><pre class="example">int Rf_initialize_R(int ac, char **av); /* in ../unix/system.c */
void Rf_mainloop();                     /* in main.c */

extern int R_running_as_main_program;   /* in ../unix/system.c */

int main(int ac, char **av)
{
    R_running_as_main_program = 1;
    Rf_initialize_R(ac, av);
    Rf_mainloop(); /* does not return */
    return 0;
}
</pre></td></tr></table>

<p>indeed, misleadingly simple.  Remember that
&lsquo;<tt><var>R_HOME</var>/bin/exec/R</tt>&rsquo; is run from a shell script
&lsquo;<tt><var>R_HOME</var>/bin/R</tt>&rsquo; which sets up the environment for the
executable, and this is used for
</p>
<ul>
<li>
Setting <code>R_HOME</code> and checking it is valid, as well as the path
<code>R_SHARE_DIR</code> and <code>R_DOC_DIR</code> to the installed &lsquo;<tt>share</tt>&rsquo; and
&lsquo;<tt>doc</tt>&rsquo; directory trees.  Also setting <code>R_ARCH</code> if needed.

</li><li>
Setting <code>LD_LIBRARY_PATH</code> to include the directories used in linking
R.  This is recorded as the default setting of
<code>R_LD_LIBRARY_PATH</code> in the shell script
&lsquo;<tt><var>R_HOME</var>/etc<var>R_ARCH</var>/ldpaths</tt>&rsquo;.

</li><li>
Processing some of the arguments, for example to run R under a
debugger and to launch alternative front-ends to provide GUIs.
</li></ul>

<p>The first two of these can be achieved for your front-end by running it
<em>via</em> <code>R CMD</code>. So, for example
</p>
<table><tr><td>&nbsp;</td><td><pre class="example">R CMD /usr/local/lib/R/bin/exec/R
R CMD exec/R
</pre></td></tr></table>

<p>will both work in a standard R installation. (<code>R CMD</code> looks
first for executables in &lsquo;<tt><var>R_HOME</var>/bin</tt>&rsquo;.)  If you do not want
to run your front-end in this way, you need to ensure that <code>R_HOME</code>
is set and <code>LD_LIBRARY_PATH</code> is suitable.  (The latter might well
be, but modern Unix/Linux systems do not normally include
&lsquo;<tt>/usr/local/lib</tt>&rsquo; (&lsquo;<tt>/usr/local/lib64</tt>&rsquo; on some architectures),
and R does look there for system components.)
</p>
<p>The other senses in which this example is too simple are that all the
internal defaults are used and that control is handed over to the
R main loop.  There are a number of small examples<a name="DOCF76" href="#FOOT76">(76)</a> in the
&lsquo;<tt>tests/Embedding</tt>&rsquo; directory.  These make use of
<code>Rf_initEmbeddedR</code> in &lsquo;<tt>src/main/Rembedded.c</tt>&rsquo;, and essentially
use
</p><table><tr><td>&nbsp;</td><td><pre class="example">#include &lt;Rembedded.h&gt;

int main(int ac, char **av)
{
    /* do some setup */
    Rf_initEmbeddedR(argc, argv);
    /* do some more setup */

    /* submit some code to R, which is done interactively via
        run_Rmainloop();

        A possible substitute for a pseudo-console is

        R_ReplDLLinit();
        while(R_ReplDLLdo1() &gt; 0) {
        /* add user actions here if desired */
       }

     */
    Rf_endEmbeddedR(0);
    /* final tidying up after R is shutdown */
    return 0;
}
</pre></td></tr></table>

<p>If you don&rsquo;t want to pass R arguments, you can fake an <code>argv</code>
array, for example by
</p>
<table><tr><td>&nbsp;</td><td><pre class="example">    char *argv[]= {&quot;REmbeddedPostgres&quot;, &quot;--silent&quot;};
    Rf_initEmbeddedR(sizeof(argv)/sizeof(argv[0]), argv);
</pre></td></tr></table>

<p>However, to make a GUI we usually do want to run <code>run_Rmainloop</code>
after setting up various parts of R to talk to our GUI, and arranging
for our GUI callbacks to be called during the R mainloop.
</p>
<p>One issue to watch is that on some platforms <code>Rf_initEmbeddedR</code> and
<code>Rf_endEmbeddedR</code> change the settings of the FPU (e.g. to allow
errors to be trapped and to set extended precision registers).
</p>
<p>The standard code sets up a session temporary directory in the usual
way, <em>unless</em> <code>R_TempDir</code> is set to a non-NULL value before
<code>Rf_initEmbeddedR</code> is called.  In that case the value is assumed to
contain an existing writable directory (no check is done), and it is not
cleaned up when R is shut down.
</p>
<p><code>Rf_initEmbeddedR</code> sets R to be in interactive mode: you can set
<code>R_Interactive</code> (defined in &lsquo;<tt>Rinterface.h</tt>&rsquo;) subsequently to
change this.
</p>
<p>Note that R expects to be run with the locale category
&lsquo;<samp>LC_NUMERIC</samp>&rsquo; set to its default value of <code>C</code>, and so should
not be embedded into an application which changes that.
</p>
<table class="menu" border="0" cellspacing="0">
<tr><td align="left" valign="top"><a href="#Compiling-against-the-R-library">8.1.1 Compiling against the R library</a></td><td>&nbsp;&nbsp;</td><td align="left" valign="top">  
</td></tr>
<tr><td align="left" valign="top"><a href="#Setting-R-callbacks">8.1.2 Setting R callbacks</a></td><td>&nbsp;&nbsp;</td><td align="left" valign="top">         
</td></tr>
<tr><td align="left" valign="top"><a href="#Registering-symbols">8.1.3 Registering symbols</a></td><td>&nbsp;&nbsp;</td><td align="left" valign="top">         
</td></tr>
<tr><td align="left" valign="top"><a href="#Meshing-event-loops">8.1.4 Meshing event loops</a></td><td>&nbsp;&nbsp;</td><td align="left" valign="top">         
</td></tr>
<tr><td align="left" valign="top"><a href="#Threading-issues">8.1.5 Threading issues</a></td><td>&nbsp;&nbsp;</td><td align="left" valign="top">            
</td></tr>
</table>

<hr size="6">
<a name="Compiling-against-the-R-library"></a>
<table cellpadding="1" cellspacing="1" border="0">
<tr><td valign="middle" align="left">[<a href="#Embedding-R-under-Unix_002dalikes" title="Previous section in reading order"> &lt; </a>]</td>
<td valign="middle" align="left">[<a href="#Setting-R-callbacks" title="Next section in reading order"> &gt; </a>]</td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left">[<a href="#Linking-GUIs-and-other-front_002dends-to-R" title="Beginning of this chapter or previous chapter"> &lt;&lt; </a>]</td>
<td valign="middle" align="left">[<a href="#Embedding-R-under-Unix_002dalikes" title="Up section"> Up </a>]</td>
<td valign="middle" align="left">[<a href="#Function-and-variable-index" title="Next chapter"> &gt;&gt; </a>]</td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left">[<a href="#Top" title="Cover (top) of document">Top</a>]</td>
<td valign="middle" align="left">[<a href="#SEC_Contents" title="Table of contents">Contents</a>]</td>
<td valign="middle" align="left">[<a href="#Function-and-variable-index" title="Index">Index</a>]</td>
<td valign="middle" align="left">[<a href="#SEC_About" title="About (help)"> ? </a>]</td>
</tr></table>
<a name="Compiling-against-the-R-library-1"></a>
<h3 class="subsection">8.1.1 Compiling against the R library</h3>

<p>Suitable flags to compile and link against the R (shared or static)
library can be found by
</p>
<table><tr><td>&nbsp;</td><td><pre class="example">R CMD config --cppflags
R CMD config --ldflags
</pre></td></tr></table>

<p>If R is installed, <code>pkg-config</code> is available and
sub-architectures have not been used, alternatives for a shared R
library are
</p>
<table><tr><td>&nbsp;</td><td><pre class="example">pkg-config --cflags libR
pkg-config --libs libR
</pre></td></tr></table>

<p>and for a static R library
</p>
<table><tr><td>&nbsp;</td><td><pre class="example">pkg-config --cflags libR
pkg-config --libs --static libR
</pre></td></tr></table>

<hr size="6">
<a name="Setting-R-callbacks"></a>
<table cellpadding="1" cellspacing="1" border="0">
<tr><td valign="middle" align="left">[<a href="#Compiling-against-the-R-library" title="Previous section in reading order"> &lt; </a>]</td>
<td valign="middle" align="left">[<a href="#Registering-symbols" title="Next section in reading order"> &gt; </a>]</td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left">[<a href="#Linking-GUIs-and-other-front_002dends-to-R" title="Beginning of this chapter or previous chapter"> &lt;&lt; </a>]</td>
<td valign="middle" align="left">[<a href="#Embedding-R-under-Unix_002dalikes" title="Up section"> Up </a>]</td>
<td valign="middle" align="left">[<a href="#Function-and-variable-index" title="Next chapter"> &gt;&gt; </a>]</td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left">[<a href="#Top" title="Cover (top) of document">Top</a>]</td>
<td valign="middle" align="left">[<a href="#SEC_Contents" title="Table of contents">Contents</a>]</td>
<td valign="middle" align="left">[<a href="#Function-and-variable-index" title="Index">Index</a>]</td>
<td valign="middle" align="left">[<a href="#SEC_About" title="About (help)"> ? </a>]</td>
</tr></table>
<a name="Setting-R-callbacks-1"></a>
<h3 class="subsection">8.1.2 Setting R callbacks</h3>

<p>For Unix-alikes there is a public header file &lsquo;<tt>Rinterface.h</tt>&rsquo; that
makes it possible to change the standard callbacks used by R in a
documented way.  This defines pointers (if <code>R_INTERFACE_PTRS</code> is
defined)
</p>
<table><tr><td>&nbsp;</td><td><pre class="example">extern void (*ptr_R_Suicide)(const char *);
extern void (*ptr_R_ShowMessage)(const char *);
extern int  (*ptr_R_ReadConsole)(const char *, unsigned char *, int, int);
extern void (*ptr_R_WriteConsole)(const char *, int);
extern void (*ptr_R_WriteConsoleEx)(const char *, int, int);
extern void (*ptr_R_ResetConsole)();
extern void (*ptr_R_FlushConsole)();
extern void (*ptr_R_ClearerrConsole)();
extern void (*ptr_R_Busy)(int);
extern void (*ptr_R_CleanUp)(SA_TYPE, int, int);
extern int  (*ptr_R_ShowFiles)(int, const char **, const char **,
                               const char *, Rboolean, const char *);
extern int  (*ptr_R_ChooseFile)(int, char *, int);
extern int  (*ptr_R_EditFile)(const char *);
extern void (*ptr_R_loadhistory)(SEXP, SEXP, SEXP, SEXP);
extern void (*ptr_R_savehistory)(SEXP, SEXP, SEXP, SEXP);
extern void (*ptr_R_addhistory)(SEXP, SEXP, SEXP, SEXP);
// added in R 3.0.0
extern int  (*ptr_R_EditFiles)(int, const char **, const char **, const char *);
extern SEXP (*ptr_do_selectlist)(SEXP, SEXP, SEXP, SEXP);
extern SEXP (*ptr_do_dataentry)(SEXP, SEXP, SEXP, SEXP);
extern SEXP (*ptr_do_dataviewer)(SEXP, SEXP, SEXP, SEXP);
extern void (*ptr_R_ProcessEvents)();
</pre></td></tr></table>

<p>which allow standard R callbacks to be redirected to your GUI.  What
these do is generally documented in the file &lsquo;<tt>src/unix/system.txt</tt>&rsquo;.
</p>
<dl>
<dt><a name="index-R_005fShowMessage"></a><u>Function:</u> void <b>R_ShowMessage</b><i> (char *<var>message</var>)</i></dt>
<dd><p>This should display the message, which may have multiple lines:  it
should be brought to the user&rsquo;s attention immediately.
</p></dd></dl>

<dl>
<dt><a name="index-R_005fBusy"></a><u>Function:</u> void <b>R_Busy</b><i> (int <var>which</var>)</i></dt>
<dd><p>This function invokes actions (such as change of cursor) when R
embarks on an extended computation (<code><var>which</var>=1</code>) and when such
a state terminates (<code><var>which</var>=0</code>).
</p></dd></dl>

<dl>
<dt><a name="index-R_005fReadConsole"></a><u>Function:</u> int <b>R_ReadConsole</b><i> (const char *<var>prompt</var>, unsigned char *<var>buf</var>,   int <var>buflen</var>, int <var>hist</var>)</i></dt>
<dt><a name="index-R_005fWriteConsole"></a><u>Function:</u> void <b>R_WriteConsole</b><i> (const char *<var>buf</var>, int <var>buflen</var>)</i></dt>
<dt><a name="index-R_005fWriteConsoleEx"></a><u>Function:</u> void <b>R_WriteConsoleEx</b><i> (const char *<var>buf</var>, int <var>buflen</var>, int <var>otype</var>)</i></dt>
<dt><a name="index-R_005fResetConsole"></a><u>Function:</u> void <b>R_ResetConsole</b><i> ()</i></dt>
<dt><a name="index-R_005fFlushConsole"></a><u>Function:</u> void <b>R_FlushConsole</b><i> ()</i></dt>
<dt><a name="index-R_005fClearErrConsole"></a><u>Function:</u> void <b>R_ClearErrConsole</b><i> ()</i></dt>
<dd>
<p>These functions interact with a console.
</p>
<p><code>R_ReadConsole</code> prints the given prompt at the console and then
does a <code>fgets(3)</code>&ndash;like operation, transferring up to <var>buflen</var>
characters into the buffer <var>buf</var>. The last two bytes should be
set to &lsquo;<samp>&quot;\n\0&quot;</samp>&rsquo; to preserve sanity.  If <var>hist</var> is non-zero,
then the line should be added to any command history which is being
maintained.  The return value is 0 is no input is available and &gt;0
otherwise.
</p>
<p><code>R_WriteConsoleEx</code> writes the given buffer to the console,
<var>otype</var> specifies the output type (regular output or
warning/error). Call to <code>R_WriteConsole(buf, buflen)</code> is equivalent
to <code>R_WriteConsoleEx(buf, buflen, 0)</code>. To ensure backward
compatibility of the callbacks, <code>ptr_R_WriteConsoleEx</code> is used only
if <code>ptr_R_WriteConsole</code> is set to <code>NULL</code>.  To ensure that
<code>stdout()</code> and <code>stderr()</code> connections point to the console,
set the corresponding files to <code>NULL</code> <em>via</em>
</p><table><tr><td>&nbsp;</td><td><pre class="example">      R_Outputfile = NULL;
      R_Consolefile = NULL;
</pre></td></tr></table>

<p><code>R_ResetConsole</code> is called when the system is reset after an error.
<code>R_FlushConsole</code> is called to flush any pending output to the
system console.  <code>R_ClearerrConsole</code> clears any errors associated
with reading from the console.
</p></dd></dl>

<dl>
<dt><a name="index-R_005fShowFiles"></a><u>Function:</u> int <b>R_ShowFiles</b><i> (int <var>nfile</var>, const char **<var>file</var>,   const char **<var>headers</var>, const char *<var>wtitle</var>, Rboolean <var>del</var>,   const char *<var>pager</var>)</i></dt>
<dd>
<p>This function is used to display the contents of files.
</p></dd></dl>

<dl>
<dt><a name="index-R_005fChooseFile"></a><u>Function:</u> int <b>R_ChooseFile</b><i> (int <var>new</var>, char *<var>buf</var>,   int <var>len</var>)</i></dt>
<dd>
<p>Choose a file and return its name in <var>buf</var> of length <var>len</var>.
Return value is 0 for success, &gt; 0 otherwise.
</p></dd></dl>

<dl>
<dt><a name="index-R_005fEditFile"></a><u>Function:</u> int <b>R_EditFile</b><i> (const char *<var>buf</var>)</i></dt>
<dd><p>Send a file to an editor window.
</p></dd></dl>

<dl>
<dt><a name="index-R_005fEditFiles"></a><u>Function:</u> int <b>R_EditFiles</b><i> (int <var>nfile</var>, const char **<var>file</var>, const char **<var>title</var>, const char *<var>editor</var>)</i></dt>
<dd><p>Send <var>nfile</var> files to an editor, with titles possibly to be used for
the editor window(s).
</p></dd></dl>

<dl>
<dt><a name="index-R_005floadhistory"></a><u>Function:</u> SEXP <b>R_loadhistory</b><i> (SEXP, SEXP, SEXP, SEXP);</i></dt>
<dt><a name="index-R_005fsavehistory"></a><u>Function:</u> SEXP <b>R_savehistory</b><i> (SEXP, SEXP, SEXP, SEXP);</i></dt>
<dt><a name="index-R_005faddhistory"></a><u>Function:</u> SEXP <b>R_addhistory</b><i> (SEXP, SEXP, SEXP, SEXP);</i></dt>
<dd>
<p><code>.Internal</code> functions for <code>loadhistory</code>, <code>savehistory</code>
and <code>timestamp</code>.
</p>
<p>If the console has no history mechanism these can be as
simple as
</p>
<table><tr><td>&nbsp;</td><td><pre class="example">SEXP R_loadhistory (SEXP call, SEXP op, SEXP args, SEXP env)
{
    errorcall(call, &quot;loadhistory is not implemented&quot;);
    return R_NilValue;
}
SEXP R_savehistory (SEXP call, SEXP op , SEXP args, SEXP env)
{
    errorcall(call, &quot;savehistory is not implemented&quot;);
    return R_NilValue;
}
SEXP R_addhistory (SEXP call, SEXP op , SEXP args, SEXP env)
{
    return R_NilValue;
}
</pre></td></tr></table>

<p>The <code>R_addhistory</code> function should return silently if no history
mechanism is present, as a user may be calling <code>timestamp</code> purely
to write the time stamp to the console.
</p></dd></dl>

<dl>
<dt><a name="index-R_005fSuicide"></a><u>Function:</u> void <b>R_Suicide</b><i> (const char *<var>message</var>)</i></dt>
<dd><p>This should abort R as rapidly as possible, displaying the message.
A possible implementation is
</p>
<table><tr><td>&nbsp;</td><td><pre class="example">void R_Suicide (const char *message)
{
    char  pp[1024];
    snprintf(pp, 1024, &quot;Fatal error: %s\n&quot;, s);
    R_ShowMessage(pp);
    R_CleanUp(SA_SUICIDE, 2, 0);
}
</pre></td></tr></table>
</dd></dl>

<dl>
<dt><a name="index-R_005fCleanUp"></a><u>Function:</u> void <b>R_CleanUp</b><i> (SA_TYPE <var>saveact</var>, int <var>status</var>,   int <var>RunLast</var>)</i></dt>
<dd>
<p>This function invokes any actions which occur at system termination.
It needs to be quite complex:
</p>
<table><tr><td>&nbsp;</td><td><pre class="example">#include &lt;Rinterface.h&gt;
#include &lt;Rembedded.h&gt;    /* for Rf_KillAllDevices */

void R_CleanUp (SA_TYPE saveact, int status, int RunLast)
{
    if(saveact == SA_DEFAULT) saveact = SaveAction;
    if(saveact == SA_SAVEASK) {
       /* ask what to do and set saveact */
    }
    switch (saveact) {
    case SA_SAVE:
        if(runLast) R_dot_Last();
        if(R_DirtyImage) R_SaveGlobalEnv();
        /* save the console history in R_HistoryFile */
        break;
    case SA_NOSAVE:
        if(runLast) R_dot_Last();
        break;
    case SA_SUICIDE:
    default:
        break;
    }

    R_RunExitFinalizers();
    /* clean up after the editor e.g. CleanEd() */

    R_CleanTempDir();

    /* close all the graphics devices */
    if(saveact != SA_SUICIDE) Rf_KillAllDevices();
    fpu_setup(FALSE);

    exit(status);
}
</pre></td></tr></table>
</dd></dl>

<p>These callbacks should never be changed in a running R session (and
hence cannot be called from an extension package).
</p>
<dl>
<dt><a name="index-R_005fdataentry"></a><u>Function:</u> SEXP <b>R_dataentry</b><i> (SEXP, SEXP, SEXP, SEXP);</i></dt>
<dt><a name="index-R_005fdataviewer"></a><u>Function:</u> SEXP <b>R_dataviewer</b><i> (SEXP, SEXP, SEXP, SEXP);</i></dt>
<dt><a name="index-R_005fselectlist"></a><u>Function:</u> SEXP <b>R_selectlist</b><i> (SEXP, SEXP, SEXP, SEXP);</i></dt>
<dd>
<p><code>.External</code> functions for <code>dataentry</code> (and <code>edit</code> on
matrices and data frames), <code>View</code> and <code>select.list</code>.  These
can be changed if they are not currently in use.
</p></dd></dl>


<hr size="6">
<a name="Registering-symbols"></a>
<table cellpadding="1" cellspacing="1" border="0">
<tr><td valign="middle" align="left">[<a href="#Setting-R-callbacks" title="Previous section in reading order"> &lt; </a>]</td>
<td valign="middle" align="left">[<a href="#Meshing-event-loops" title="Next section in reading order"> &gt; </a>]</td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left">[<a href="#Linking-GUIs-and-other-front_002dends-to-R" title="Beginning of this chapter or previous chapter"> &lt;&lt; </a>]</td>
<td valign="middle" align="left">[<a href="#Embedding-R-under-Unix_002dalikes" title="Up section"> Up </a>]</td>
<td valign="middle" align="left">[<a href="#Function-and-variable-index" title="Next chapter"> &gt;&gt; </a>]</td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left">[<a href="#Top" title="Cover (top) of document">Top</a>]</td>
<td valign="middle" align="left">[<a href="#SEC_Contents" title="Table of contents">Contents</a>]</td>
<td valign="middle" align="left">[<a href="#Function-and-variable-index" title="Index">Index</a>]</td>
<td valign="middle" align="left">[<a href="#SEC_About" title="About (help)"> ? </a>]</td>
</tr></table>
<a name="Registering-symbols-1"></a>
<h3 class="subsection">8.1.3 Registering symbols</h3>

<p>An application embedding R needs a different way of registering
symbols because it is not a dynamic library loaded by R as would be
the case with a package.  Therefore R reserves a special
<code>DllInfo</code> entry for the embedding application such that it can
register symbols to be used with <code>.C</code>, <code>.Call</code> etc.  This
entry can be obtained by calling <code>getEmbeddingDllInfo</code>, so a
typical use is
</p>
<table><tr><td>&nbsp;</td><td><pre class="example">DllInfo *info = R_getEmbeddingDllInfo();
R_registerRoutines(info, cMethods, callMethods, NULL, NULL);
</pre></td></tr></table>

<p>The native routines defined by <code>cMethods</code> and <code>callMethods</code>
should be present in the embedding application.  See <a href="#Registering-native-routines">Registering native routines</a> for details on registering symbols in general.
</p>

<hr size="6">
<a name="Meshing-event-loops"></a>
<table cellpadding="1" cellspacing="1" border="0">
<tr><td valign="middle" align="left">[<a href="#Registering-symbols" title="Previous section in reading order"> &lt; </a>]</td>
<td valign="middle" align="left">[<a href="#Threading-issues" title="Next section in reading order"> &gt; </a>]</td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left">[<a href="#Linking-GUIs-and-other-front_002dends-to-R" title="Beginning of this chapter or previous chapter"> &lt;&lt; </a>]</td>
<td valign="middle" align="left">[<a href="#Embedding-R-under-Unix_002dalikes" title="Up section"> Up </a>]</td>
<td valign="middle" align="left">[<a href="#Function-and-variable-index" title="Next chapter"> &gt;&gt; </a>]</td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left">[<a href="#Top" title="Cover (top) of document">Top</a>]</td>
<td valign="middle" align="left">[<a href="#SEC_Contents" title="Table of contents">Contents</a>]</td>
<td valign="middle" align="left">[<a href="#Function-and-variable-index" title="Index">Index</a>]</td>
<td valign="middle" align="left">[<a href="#SEC_About" title="About (help)"> ? </a>]</td>
</tr></table>
<a name="Meshing-event-loops-1"></a>
<h3 class="subsection">8.1.4 Meshing event loops</h3>

<p>One of the most difficult issues in interfacing R to a front-end is
the handling of event loops, at least if a single thread is used.  R
uses events and timers for
</p>
<ul>
<li>
Running X11 windows such as the graphics device and data editor, and
interacting with them (e.g., using <code>locator()</code>).

</li><li>
Supporting Tcl/Tk events for the <strong>tcltk</strong> package (for at least the
X11 version of Tk).

</li><li>
Preparing input.

</li><li>
Timing operations, for example for profiling R code and
<code>Sys.sleep()</code>.

</li><li>
Interrupts, where permitted.
</li></ul>

<p>Specifically, the Unix-alike command-line version of R runs separate
event loops for
</p>
<ul>
<li>
Preparing input at the console command-line, in file
&lsquo;<tt>src/unix/sys-unix.c</tt>&rsquo;.

</li><li>
Waiting for a response from a socket in the internal functions
underlying FTP and HTTP transfers in <code>download.file()</code> and for
direct socket access, in files
&lsquo;<tt>src/modules/internet/nanoftp.c</tt>&rsquo;,
&lsquo;<tt>src/modules/internet/nanohttp.c</tt>&rsquo; and
&lsquo;<tt>src/modules/internet/Rsock.c</tt>&rsquo;

</li><li>
Mouse and window events when displaying the X11-based dataentry window,
in file &lsquo;<tt>src/modules/X11/dataentry.c</tt>&rsquo;.  This is regarded as
<em>modal</em>, and no other events are serviced whilst it is active.
</li></ul>

<p>There is a protocol for adding event handlers to the first two types of
event loops, using types and functions declared in the header
&lsquo;<tt>R_ext/eventloop.h</tt>&rsquo; and described in comments in file
&lsquo;<tt>src/unix/sys-std.c</tt>&rsquo;.  It is possible to add (or remove) an input
handler for events on a particular file descriptor, or to set a polling
interval (<em>via</em> <code>R_wait_usec</code>) and a function to be called
periodically <em>via</em> <code>R_PolledEvents</code>: the polling mechanism is used by
the <strong>tcltk</strong> package.
</p>
<p>It is not intended that these facilities are used by packages, but if
they are needed exceptionally, the package should ensure that it cleans
up and removes its handlers when its namespace is unloaded.
</p>
<p>An alternative front-end needs both to make provision for other R
events whilst waiting for input, and to ensure that it is not frozen out
during events of the second type.  This is not handled very well in the
existing examples.  The GNOME front-end can run a own handler for polled
events by setting
</p>
<table><tr><td>&nbsp;</td><td><pre class="example">extern int (*R_timeout_handler)();
extern long R_timeout_val;

      if (R_timeout_handler &amp;&amp; R_timeout_val)
          gtk_timeout_add(R_timeout_val, R_timeout_handler, NULL);
      gtk_main ();
</pre></td></tr></table>

<p>whilst it is waiting for console input.  This obviously handles events
for Gtk windows (such as the graphics device in the <strong>gtkDevice</strong>
package), but not X11 events (such as the <code>X11()</code> device) or for
other event handlers that might have been registered with R.  It does
not attempt to keep itself alive whilst R is waiting on sockets.  The
ability to add a polled handler as <code>R_timeout_handler</code> is used by
the <strong>tcltk</strong> package.
</p>

<hr size="6">
<a name="Threading-issues"></a>
<table cellpadding="1" cellspacing="1" border="0">
<tr><td valign="middle" align="left">[<a href="#Meshing-event-loops" title="Previous section in reading order"> &lt; </a>]</td>
<td valign="middle" align="left">[<a href="#Embedding-R-under-Windows" title="Next section in reading order"> &gt; </a>]</td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left">[<a href="#Linking-GUIs-and-other-front_002dends-to-R" title="Beginning of this chapter or previous chapter"> &lt;&lt; </a>]</td>
<td valign="middle" align="left">[<a href="#Embedding-R-under-Unix_002dalikes" title="Up section"> Up </a>]</td>
<td valign="middle" align="left">[<a href="#Function-and-variable-index" title="Next chapter"> &gt;&gt; </a>]</td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left">[<a href="#Top" title="Cover (top) of document">Top</a>]</td>
<td valign="middle" align="left">[<a href="#SEC_Contents" title="Table of contents">Contents</a>]</td>
<td valign="middle" align="left">[<a href="#Function-and-variable-index" title="Index">Index</a>]</td>
<td valign="middle" align="left">[<a href="#SEC_About" title="About (help)"> ? </a>]</td>
</tr></table>
<a name="Threading-issues-1"></a>
<h3 class="subsection">8.1.5 Threading issues</h3>

<p>Embedded R is designed to be run in the main thread, and all the
testing is done in that context.  There is a potential issue with the
stack-checking mechanism where threads are involved.  This uses two
variables declared in &lsquo;<tt>Rinterface.h</tt>&rsquo; (if <code>CSTACK_DEFNS</code> is
defined) as
</p>
<table><tr><td>&nbsp;</td><td><pre class="example">extern uintptr_t R_CStackLimit; /* C stack limit */
extern uintptr_t R_CStackStart; /* Initial stack address */
</pre></td></tr></table>

<p>Note that <code>uintptr_t</code> is a C99 type for which a substitute is
defined in R, so your code needs to define <code>HAVE_UINTPTR_T</code>
appropriately.
</p>
<p>These will be set<a name="DOCF77" href="#FOOT77">(77)</a> when <code>Rf_initialize_R</code> is called, to values appropriate to
the main thread.  Stack-checking can be disabled by setting
<code>R_CStackLimit = (uintptr_t)-1</code>, but it is better to if possible
set appropriate values.  (What these are and how to determine them are
OS-specific, and the stack size limit may differ for secondary threads.
If you have a choice of stack size, at least 8Mb is recommended.)
</p>
<p>You may also want to consider how signals are handled: R sets signal
handlers for several signals, including <code>SIGINT</code>, <code>SIGSEGV</code>,
<code>SIGPIPE</code>, <code>SIGUSR1</code> and <code>SIGUSR2</code>, but these can all be
suppressed by setting the variable <code>R_SignalHandlers</code> (declared in
&lsquo;<tt>Rinterface.h</tt>&rsquo;) to <code>0</code>.
</p>
<p>Note that these variables must not be changed by an R
<strong>package</strong>: a package should not calling R internals which
makes use of the stack-checking mechanism on a secondary thread.
</p>
<hr size="6">
<a name="Embedding-R-under-Windows"></a>
<table cellpadding="1" cellspacing="1" border="0">
<tr><td valign="middle" align="left">[<a href="#Threading-issues" title="Previous section in reading order"> &lt; </a>]</td>
<td valign="middle" align="left">[<a href="#Using-_0028D_0029COM" title="Next section in reading order"> &gt; </a>]</td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left">[<a href="#Linking-GUIs-and-other-front_002dends-to-R" title="Beginning of this chapter or previous chapter"> &lt;&lt; </a>]</td>
<td valign="middle" align="left">[<a href="#Linking-GUIs-and-other-front_002dends-to-R" title="Up section"> Up </a>]</td>
<td valign="middle" align="left">[<a href="#Function-and-variable-index" title="Next chapter"> &gt;&gt; </a>]</td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left">[<a href="#Top" title="Cover (top) of document">Top</a>]</td>
<td valign="middle" align="left">[<a href="#SEC_Contents" title="Table of contents">Contents</a>]</td>
<td valign="middle" align="left">[<a href="#Function-and-variable-index" title="Index">Index</a>]</td>
<td valign="middle" align="left">[<a href="#SEC_About" title="About (help)"> ? </a>]</td>
</tr></table>
<a name="Embedding-R-under-Windows-1"></a>
<h2 class="section">8.2 Embedding R under Windows</h2>

<p>All Windows interfaces to R call entry points in the DLL
&lsquo;<tt>R.dll</tt>&rsquo;, directly or indirectly.  Simpler applications may find it
easier to use the indirect route <em>via</em> <acronym>(D)COM</acronym>.
</p>
<table class="menu" border="0" cellspacing="0">
<tr><td align="left" valign="top"><a href="#Using-_0028D_0029COM">8.2.1 Using (D)COM</a></td><td>&nbsp;&nbsp;</td><td align="left" valign="top">                
</td></tr>
<tr><td align="left" valign="top"><a href="#Calling-R_002edll-directly">8.2.2 Calling R.dll directly</a></td><td>&nbsp;&nbsp;</td><td align="left" valign="top">      
</td></tr>
<tr><td align="left" valign="top"><a href="#Finding-R_005fHOME">8.2.3 Finding R_HOME</a></td><td>&nbsp;&nbsp;</td><td align="left" valign="top">              
</td></tr>
</table>

<hr size="6">
<a name="Using-_0028D_0029COM"></a>
<table cellpadding="1" cellspacing="1" border="0">
<tr><td valign="middle" align="left">[<a href="#Embedding-R-under-Windows" title="Previous section in reading order"> &lt; </a>]</td>
<td valign="middle" align="left">[<a href="#Calling-R_002edll-directly" title="Next section in reading order"> &gt; </a>]</td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left">[<a href="#Linking-GUIs-and-other-front_002dends-to-R" title="Beginning of this chapter or previous chapter"> &lt;&lt; </a>]</td>
<td valign="middle" align="left">[<a href="#Embedding-R-under-Windows" title="Up section"> Up </a>]</td>
<td valign="middle" align="left">[<a href="#Function-and-variable-index" title="Next chapter"> &gt;&gt; </a>]</td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left">[<a href="#Top" title="Cover (top) of document">Top</a>]</td>
<td valign="middle" align="left">[<a href="#SEC_Contents" title="Table of contents">Contents</a>]</td>
<td valign="middle" align="left">[<a href="#Function-and-variable-index" title="Index">Index</a>]</td>
<td valign="middle" align="left">[<a href="#SEC_About" title="About (help)"> ? </a>]</td>
</tr></table>
<a name="Using-_0028D_0029COM-1"></a>
<h3 class="subsection">8.2.1 Using (D)COM</h3>

<p><acronym>(D)COM</acronym> is a standard Windows mechanism used for communication
between Windows applications.  One application (here R) is run as COM
server which offers services to clients, here the front-end calling
application.  The services are described in a &lsquo;Type Library&rsquo; and are
(more or less) language-independent, so the calling application can be
written in C or C++ or Visual Basic or Perl or Python and so on.
The &lsquo;D&rsquo; in (D)COM refers to &lsquo;distributed&rsquo;, as the client and server can
be running on different machines.
</p>
<p>The basic R distribution is not a (D)COM server, but two addons are
currently available that interface directly with R and provide a
(D)COM server:
</p><ul>
<li>
There is a (D)COM server called <code>StatConnector</code> written by Thomas
Baier available via
<a href="http://CRAN.R-project.org/other-software.html">http://CRAN.R-project.org/other-software.html</a> or
<a href="http://sunsite.univie.ac.at/rcom/">http://sunsite.univie.ac.at/rcom/</a>, which works with package
<a href="http://CRAN.R-project.org/package=rscproxy"><strong>rscproxy</strong></a> to support transfer of data to and from R and remote
execution of R commands, as well as embedding of an R graphics
window.  The <a href="http://CRAN.R-project.org/package=rcom"><strong>rcom</strong></a> package on <acronym>CRAN</acronym> provides a (D)COM
server in a running R session.

</li><li>
Another (D)COM server, <code>RDCOMServer</code>, is available from
<a href="http://www.omegahat.org/">http://www.omegahat.org/</a>. Its philosophy is discussed in
<a href="http://www.omegahat.org/RDCOMServer/Docs/Paradigm.html">http://www.omegahat.org/RDCOMServer/Docs/Paradigm.html</a> and is
very different from the purpose of this section.
</li></ul>
<hr size="6">
<a name="Calling-R_002edll-directly"></a>
<table cellpadding="1" cellspacing="1" border="0">
<tr><td valign="middle" align="left">[<a href="#Using-_0028D_0029COM" title="Previous section in reading order"> &lt; </a>]</td>
<td valign="middle" align="left">[<a href="#Finding-R_005fHOME" title="Next section in reading order"> &gt; </a>]</td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left">[<a href="#Linking-GUIs-and-other-front_002dends-to-R" title="Beginning of this chapter or previous chapter"> &lt;&lt; </a>]</td>
<td valign="middle" align="left">[<a href="#Embedding-R-under-Windows" title="Up section"> Up </a>]</td>
<td valign="middle" align="left">[<a href="#Function-and-variable-index" title="Next chapter"> &gt;&gt; </a>]</td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left">[<a href="#Top" title="Cover (top) of document">Top</a>]</td>
<td valign="middle" align="left">[<a href="#SEC_Contents" title="Table of contents">Contents</a>]</td>
<td valign="middle" align="left">[<a href="#Function-and-variable-index" title="Index">Index</a>]</td>
<td valign="middle" align="left">[<a href="#SEC_About" title="About (help)"> ? </a>]</td>
</tr></table>
<a name="Calling-R_002edll-directly-1"></a>
<h3 class="subsection">8.2.2 Calling R.dll directly</h3>

<p>The <code>R</code> DLL is mainly written in C and has <code>_cdecl</code> entry
points.  Calling it directly will be tricky except from C code (or C++
with a little care).
</p>
<p>There is a version of the Unix-alike interface calling
</p>
<table><tr><td>&nbsp;</td><td><pre class="example">int Rf_initEmbeddedR(int ac, char **av);
void Rf_endEmbeddedR(int fatal);
</pre></td></tr></table>

<p>which is an entry point in &lsquo;<tt>R.dll</tt>&rsquo;.  Examples of its use (and a
suitable &lsquo;<tt>Makefile.win</tt>&rsquo;) can be found in the &lsquo;<tt>tests/Embedding</tt>&rsquo;
directory of the sources.  You may need to ensure that
&lsquo;<tt><var>R_HOME</var>/bin</tt>&rsquo; is in your <code>PATH</code> so the R DLLs are found.
</p>
<p>Examples of calling &lsquo;<tt>R.dll</tt>&rsquo; directly are provided in the directory
&lsquo;<tt>src/gnuwin32/front-ends</tt>&rsquo;, including a simple command-line
front end &lsquo;<tt>rtest.c</tt>&rsquo; whose code is
</p>
<table><tr><td>&nbsp;</td><td><pre class="smallexample">#define Win32
#include &lt;windows.h&gt;
#include &lt;stdio.h&gt;
#include &lt;Rversion.h&gt;
#define LibExtern __declspec(dllimport) extern
#include &lt;Rembedded.h&gt;
#include &lt;R_ext/RStartup.h&gt;
/* for askok and askyesnocancel */
#include &lt;graphapp.h&gt;

/* for signal-handling code */
#include &lt;psignal.h&gt;

/* simple input, simple output */

/* This version blocks all events: a real one needs to call ProcessEvents
   frequently. See rterm.c and ../system.c for one approach using
   a separate thread for input.
*/
int myReadConsole(const char *prompt, char *buf, int len, int addtohistory)
{
    fputs(prompt, stdout);
    fflush(stdout);
    if(fgets(buf, len, stdin)) return 1; else return 0;
}

void myWriteConsole(const char *buf, int len)
{
    printf(&quot;%s&quot;, buf);
}

void myCallBack(void)
{
    /* called during i/o, eval, graphics in ProcessEvents */
}

void myBusy(int which)
{
    /* set a busy cursor ... if which = 1, unset if which = 0 */
}

static void my_onintr(int sig) { UserBreak = 1; }

int main (int argc, char **argv)
{
    structRstart rp;
    Rstart Rp = &amp;rp;
    char Rversion[25], *RHome;

    sprintf(Rversion, &quot;%s.%s&quot;, R_MAJOR, R_MINOR);
    if(strcmp(getDLLVersion(), Rversion) != 0) {
        fprintf(stderr, &quot;Error: R.DLL version does not match\n&quot;);
        exit(1);
    }

    R_setStartTime();
    R_DefParams(Rp);
    if((RHome = get_R_HOME()) == NULL) {
         fprintf(stderr, &quot;R_HOME must be set in the environment or Registry\n&quot;);
         exit(1);
    }
    Rp-&gt;rhome = RHome;
    Rp-&gt;home = getRUser();
    Rp-&gt;CharacterMode = LinkDLL;
    Rp-&gt;ReadConsole = myReadConsole;
    Rp-&gt;WriteConsole = myWriteConsole;
    Rp-&gt;CallBack = myCallBack;
    Rp-&gt;ShowMessage = askok;
    Rp-&gt;YesNoCancel = askyesnocancel;
    Rp-&gt;Busy = myBusy;

    Rp-&gt;R_Quiet = TRUE;        /* Default is FALSE */
    Rp-&gt;R_Interactive = FALSE; /* Default is TRUE */
    Rp-&gt;RestoreAction = SA_RESTORE;
    Rp-&gt;SaveAction = SA_NOSAVE;
    R_SetParams(Rp);
    R_set_command_line_arguments(argc, argv);

    FlushConsoleInputBuffer(GetStdHandle(STD_INPUT_HANDLE));

    signal(SIGBREAK, my_onintr);
    GA_initapp(0, 0);
    readconsolecfg();
    setup_Rmainloop();
#ifdef SIMPLE_CASE
    run_Rmainloop();
#else
    R_ReplDLLinit();
    while(R_ReplDLLdo1() &gt; 0) {
/* add user actions here if desired */
    }
/* only get here on EOF (not q()) */
#endif
    Rf_endEmbeddedR(0);
    return 0;
}
</pre></td></tr></table>

<p>The ideas are
</p>
<ul>
<li>
Check that the front-end and the linked &lsquo;<tt>R.dll</tt>&rsquo; match &ndash; other
front-ends may allow a looser match.

</li><li>
Find and set the R home directory and the user&rsquo;s home directory.  The
former may be available from the Windows Registry: it will be in
<code>HKEY_LOCAL_MACHINE\Software\R-core\R\InstallPath</code> from an
administrative install and
<code>HKEY_CURRENT_USER\Software\R-core\R\InstallPath</code> otherwise, if
selected during installation (as it is by default).

</li><li>
Define startup conditions and callbacks <em>via</em> the <code>Rstart</code> structure.
<code>R_DefParams</code> sets the defaults, and <code>R_SetParams</code> sets
updated values.

</li><li>
Record the command-line arguments used by
<code>R_set_command_line_arguments</code> for use by the R function
<code>commandArgs()</code>.

</li><li>
Set up the signal handler and the basic user interface.

</li><li>
Run the main R loop, possibly with our actions intermeshed.

</li><li>
Arrange to clean up.
</li></ul>

<p>An underlying theme is the need to keep the GUI &lsquo;alive&rsquo;, and this has
not been done in this example.  The R callback <code>R_ProcessEvents</code>
needs to be called frequently to ensure that Windows events in R
windows are handled expeditiously.  Conversely, R needs to allow the
GUI code (which is running in the same process) to update itself as
needed &ndash; two ways are provided to allow this:
</p>
<ul>
<li>
<code>R_ProcessEvents</code> calls the callback registered by
<code>Rp-&gt;callback</code>.  A version of this is used to run package Tcl/Tk
for <strong>tcltk</strong> under Windows, for the code is

<table><tr><td>&nbsp;</td><td><pre class="example">void R_ProcessEvents(void)
{
    while (peekevent()) doevent(); /* Windows events for GraphApp */
    if (UserBreak) { UserBreak = FALSE; onintr(); }
    R_CallBackHook();
    if(R_tcldo) R_tcldo();
}
</pre></td></tr></table>

</li><li>
The mainloop can be split up to allow the calling application to take
some action after each line of input has been dealt with: see the
alternative code below <code>#ifdef SIMPLE_CASE</code>.
</li></ul>

<p>It may be that no R GraphApp windows need to be considered, although
these include pagers, the <code>windows()</code> graphics device, the R
data and script editors and various popups such as <code>choose.file()</code>
and <code>select.list()</code>.  It would be possible to replace all of these,
but it seems easier to allow GraphApp to handle most of them.
</p>
<p>It is possible to run R in a GUI in a single thread (as
&lsquo;<tt>RGui.exe</tt>&rsquo; shows) but it will normally be easier<a name="DOCF78" href="#FOOT78">(78)</a> to
use multiple threads.
</p>
<p>Note that R&rsquo;s own front ends use a stack size of 10Mb, whereas MinGW
executables default to 2Mb, and Visual C++ ones to 1Mb.  The latter
stack sizes are too small for a number of R applications, so
general-purpose front-ends should use a larger stack size.
</p>

<hr size="6">
<a name="Finding-R_005fHOME"></a>
<table cellpadding="1" cellspacing="1" border="0">
<tr><td valign="middle" align="left">[<a href="#Calling-R_002edll-directly" title="Previous section in reading order"> &lt; </a>]</td>
<td valign="middle" align="left">[<a href="#Function-and-variable-index" title="Next section in reading order"> &gt; </a>]</td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left">[<a href="#Linking-GUIs-and-other-front_002dends-to-R" title="Beginning of this chapter or previous chapter"> &lt;&lt; </a>]</td>
<td valign="middle" align="left">[<a href="#Embedding-R-under-Windows" title="Up section"> Up </a>]</td>
<td valign="middle" align="left">[<a href="#Function-and-variable-index" title="Next chapter"> &gt;&gt; </a>]</td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left">[<a href="#Top" title="Cover (top) of document">Top</a>]</td>
<td valign="middle" align="left">[<a href="#SEC_Contents" title="Table of contents">Contents</a>]</td>
<td valign="middle" align="left">[<a href="#Function-and-variable-index" title="Index">Index</a>]</td>
<td valign="middle" align="left">[<a href="#SEC_About" title="About (help)"> ? </a>]</td>
</tr></table>
<a name="Finding-R_005fHOME-1"></a>
<h3 class="subsection">8.2.3 Finding R_HOME</h3>

<p>Both applications which embed R and those which use a <code>system</code>
call to invoke R (as <code>Rscript.exe</code>, <code>Rterm.exe</code> or
<code>R.exe</code>) need to be able to find the R &lsquo;<tt>bin</tt>&rsquo; directory.
The simplest way to do so is the ask the user to set an environment
variable <code>R_HOME</code> and use that, but naive users may be flummoxed as
to how to do so or what value to use.
</p>
<p>The R for Windows installers have for a long time allowed the value
of <code>R_HOME</code> to be recorded in the Windows Registry: this is
optional but selected by default.  <em>Where</em> it is recorded has
changed over the years to allow for multiple versions of R to be
installed at once, and to allow 32- and 64-bit versions of R to be
installed on the same machine.
</p>
<p>The basic Registry location is <code>Software\R-core\R</code>.  For an
administrative install this is under <code>HKEY_LOCAL_MACHINE</code> and on a
64-bit OS <code>HKEY_LOCAL_MACHINE\Software\R-core\R</code> is by default
redirected for a 32-bit application, so a 32-bit application will see
the information for the last 32-bit install, and a 64-bit application
that for the last 64-bit install.  For a personal install, the
information is under <code>HKEY_CURRENT_USER\Software\R-core\R</code> which is
seen by both 32-bit and 64-bit applications and so records the last
install of either architecture.  To circumvent this, there are locations
<code>Software\R-core\R32</code> and <code>Software\R-core\R64</code> which always
refer to one architecture.
</p>
<p>When R is installed and recording is not disabled then two string
values are written at that location for keys <code>InstallPath</code> and
<code>Current Version</code>, and these keys are removed when R is
uninstalled.  To allow information about other installed versions to be
retained, there is also a key named something like <code>2.11.0</code> or
<code>2.11.0 patched</code> or <code>2.12.0 Pre-release</code> with a value for
<code>InstallPath</code>.
</p>
<p>So a comprehensive algorithm to search for <code>R_HOME</code> is something
like
</p>
<ul>
<li>
Decide which of personal or administrative installs should have
precedence.  There are arguments both ways: we find that with roaming
profiles that <code>HKEY_CURRENT_USER\Software</code> often gets reverted to
an earlier version.  Do the following for one or both of
<code>HKEY_CURRENT_USER</code> and <code>HKEY_LOCAL_MACHINE</code>.

</li><li>
If the desired architecture is known, look in <code>Software\R-core\R32</code>
or <code>Software\R-core\R64</code>, and if that does not exist or the
architecture is immaterial, in <code>Software\R-core\R</code>.

</li><li>
If key <code>InstallPath</code> exists then this is <code>R_HOME</code> (recorded
using backslashes).  If it does not, look for version-specific keys like
<code>2.11.0 alpha</code>, pick the latest (which is of itself a complicated
algorithm as <code>2.11.0 patched &gt; 2.11.0 &gt; 2.11.0 alpha &gt; 2.8.1</code>) and
use its value for <code>InstallPath</code>.
</li></ul>

<p>Prior to R 2.12.0 &lsquo;<tt>R.dll</tt>&rsquo; and the various front-end executables
were in &lsquo;<tt>R_HOME\bin</tt>&rsquo;, but they are now in &lsquo;<tt>R_HOME\bin\i386</tt>&rsquo; or
&lsquo;<tt>R_HOME\bin\x64</tt>&rsquo;.  So you need to arrange to look first in the
architecture-specific subdirectory and then in &lsquo;<tt>R_HOME\bin</tt>&rsquo;.
</p>
<hr size="6">
<a name="Function-and-variable-index"></a>
<table cellpadding="1" cellspacing="1" border="0">
<tr><td valign="middle" align="left">[<a href="#Finding-R_005fHOME" title="Previous section in reading order"> &lt; </a>]</td>
<td valign="middle" align="left">[<a href="#Concept-index" title="Next section in reading order"> &gt; </a>]</td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left">[<a href="#Linking-GUIs-and-other-front_002dends-to-R" title="Beginning of this chapter or previous chapter"> &lt;&lt; </a>]</td>
<td valign="middle" align="left">[<a href="#Top" title="Up section"> Up </a>]</td>
<td valign="middle" align="left">[<a href="#Concept-index" title="Next chapter"> &gt;&gt; </a>]</td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left">[<a href="#Top" title="Cover (top) of document">Top</a>]</td>
<td valign="middle" align="left">[<a href="#SEC_Contents" title="Table of contents">Contents</a>]</td>
<td valign="middle" align="left">[<a href="#Function-and-variable-index" title="Index">Index</a>]</td>
<td valign="middle" align="left">[<a href="#SEC_About" title="About (help)"> ? </a>]</td>
</tr></table>
<a name="Function-and-variable-index-1"></a>
<h1 class="unnumbered">Function and variable index</h1>

<table><tr><th valign="top">Jump to: &nbsp; </th><td><a href="#Function-and-variable-index-1_vr_symbol-1" class="summary-letter"><b>*</b></a>
 &nbsp; 
<a href="#Function-and-variable-index-1_vr_symbol-2" class="summary-letter"><b>.</b></a>
 &nbsp; 
<a href="#Function-and-variable-index-1_vr_symbol-3" class="summary-letter"><b>\</b></a>
 &nbsp; 
<br>
<a href="#Function-and-variable-index-1_vr_letter-A" class="summary-letter"><b>A</b></a>
 &nbsp; 
<a href="#Function-and-variable-index-1_vr_letter-B" class="summary-letter"><b>B</b></a>
 &nbsp; 
<a href="#Function-and-variable-index-1_vr_letter-C" class="summary-letter"><b>C</b></a>
 &nbsp; 
<a href="#Function-and-variable-index-1_vr_letter-D" class="summary-letter"><b>D</b></a>
 &nbsp; 
<a href="#Function-and-variable-index-1_vr_letter-E" class="summary-letter"><b>E</b></a>
 &nbsp; 
<a href="#Function-and-variable-index-1_vr_letter-F" class="summary-letter"><b>F</b></a>
 &nbsp; 
<a href="#Function-and-variable-index-1_vr_letter-G" class="summary-letter"><b>G</b></a>
 &nbsp; 
<a href="#Function-and-variable-index-1_vr_letter-I" class="summary-letter"><b>I</b></a>
 &nbsp; 
<a href="#Function-and-variable-index-1_vr_letter-L" class="summary-letter"><b>L</b></a>
 &nbsp; 
<a href="#Function-and-variable-index-1_vr_letter-M" class="summary-letter"><b>M</b></a>
 &nbsp; 
<a href="#Function-and-variable-index-1_vr_letter-N" class="summary-letter"><b>N</b></a>
 &nbsp; 
<a href="#Function-and-variable-index-1_vr_letter-O" class="summary-letter"><b>O</b></a>
 &nbsp; 
<a href="#Function-and-variable-index-1_vr_letter-P" class="summary-letter"><b>P</b></a>
 &nbsp; 
<a href="#Function-and-variable-index-1_vr_letter-Q" class="summary-letter"><b>Q</b></a>
 &nbsp; 
<a href="#Function-and-variable-index-1_vr_letter-R" class="summary-letter"><b>R</b></a>
 &nbsp; 
<a href="#Function-and-variable-index-1_vr_letter-S" class="summary-letter"><b>S</b></a>
 &nbsp; 
<a href="#Function-and-variable-index-1_vr_letter-T" class="summary-letter"><b>T</b></a>
 &nbsp; 
<a href="#Function-and-variable-index-1_vr_letter-U" class="summary-letter"><b>U</b></a>
 &nbsp; 
<a href="#Function-and-variable-index-1_vr_letter-V" class="summary-letter"><b>V</b></a>
 &nbsp; 
</td></tr></table>
<table border="0" class="index-vr">
<tr><td></td><th align="left">Index Entry</th><th align="left"> Section</th></tr>
<tr><td colspan="3"> <hr></td></tr>
<tr><th><a name="Function-and-variable-index-1_vr_symbol-1">*</a></th><td></td><td></td></tr>
<tr><td></td><td valign="top"><a href="#index-_002aRiconv_005fopen"><code>*Riconv_open</code></a></td><td valign="top"><a href="#Re_002dencoding">6.11 Re-encoding</a></td></tr>
<tr><td colspan="3"> <hr></td></tr>
<tr><th><a name="Function-and-variable-index-1_vr_symbol-2">.</a></th><td></td><td></td></tr>
<tr><td></td><td valign="top"><a href="#index-_002eC"><code>.C</code></a></td><td valign="top"><a href="#Interface-functions-_002eC-and-_002eFortran">5.2 Interface functions <code>.C</code> and <code>.Fortran</code></a></td></tr>
<tr><td></td><td valign="top"><a href="#index-_002eCall"><code>.Call</code></a></td><td valign="top"><a href="#Handling-R-objects-in-C">5.9 Handling R objects in C</a></td></tr>
<tr><td></td><td valign="top"><a href="#index-_002eCall-1"><code>.Call</code></a></td><td valign="top"><a href="#Calling-_002eCall">5.10.1 Calling <code>.Call</code></a></td></tr>
<tr><td></td><td valign="top"><a href="#index-_002eExternal"><code>.External</code></a></td><td valign="top"><a href="#Handling-R-objects-in-C">5.9 Handling R objects in C</a></td></tr>
<tr><td></td><td valign="top"><a href="#index-_002eExternal-1"><code>.External</code></a></td><td valign="top"><a href="#Calling-_002eExternal">5.10.2 Calling <code>.External</code></a></td></tr>
<tr><td></td><td valign="top"><a href="#index-_002eFortran"><code>.Fortran</code></a></td><td valign="top"><a href="#Interface-functions-_002eC-and-_002eFortran">5.2 Interface functions <code>.C</code> and <code>.Fortran</code></a></td></tr>
<tr><td></td><td valign="top"><a href="#index-_002eLast_002elib"><code>.Last.lib</code></a></td><td valign="top"><a href="#Load-hooks">1.6.3 Load hooks</a></td></tr>
<tr><td></td><td valign="top"><a href="#index-_002eonAttach"><code>.onAttach</code></a></td><td valign="top"><a href="#Load-hooks">1.6.3 Load hooks</a></td></tr>
<tr><td></td><td valign="top"><a href="#index-_002eonDetach"><code>.onDetach</code></a></td><td valign="top"><a href="#Load-hooks">1.6.3 Load hooks</a></td></tr>
<tr><td></td><td valign="top"><a href="#index-_002eonLoad"><code>.onLoad</code></a></td><td valign="top"><a href="#Load-hooks">1.6.3 Load hooks</a></td></tr>
<tr><td></td><td valign="top"><a href="#index-_002eonUnload"><code>.onUnload</code></a></td><td valign="top"><a href="#Load-hooks">1.6.3 Load hooks</a></td></tr>
<tr><td></td><td valign="top"><a href="#index-_002eRandom_002eseed"><code>.Random.seed</code></a></td><td valign="top"><a href="#Random-numbers">6.3 Random number generation</a></td></tr>
<tr><td colspan="3"> <hr></td></tr>
<tr><th><a name="Function-and-variable-index-1_vr_symbol-3">\</a></th><td></td><td></td></tr>
<tr><td></td><td valign="top"><a href="#index-_005cacronym"><code>\acronym</code></a></td><td valign="top"><a href="#Marking-text">2.3 Marking text</a></td></tr>
<tr><td></td><td valign="top"><a href="#index-_005calias"><code>\alias</code></a></td><td valign="top"><a href="#Documenting-functions">2.1.1 Documenting functions</a></td></tr>
<tr><td></td><td valign="top"><a href="#index-_005carguments"><code>\arguments</code></a></td><td valign="top"><a href="#Documenting-functions">2.1.1 Documenting functions</a></td></tr>
<tr><td></td><td valign="top"><a href="#index-_005cauthor"><code>\author</code></a></td><td valign="top"><a href="#Documenting-functions">2.1.1 Documenting functions</a></td></tr>
<tr><td></td><td valign="top"><a href="#index-_005cbold"><code>\bold</code></a></td><td valign="top"><a href="#Marking-text">2.3 Marking text</a></td></tr>
<tr><td></td><td valign="top"><a href="#index-_005ccite"><code>\cite</code></a></td><td valign="top"><a href="#Marking-text">2.3 Marking text</a></td></tr>
<tr><td></td><td valign="top"><a href="#index-_005ccode"><code>\code</code></a></td><td valign="top"><a href="#Marking-text">2.3 Marking text</a></td></tr>
<tr><td></td><td valign="top"><a href="#index-_005ccommand"><code>\command</code></a></td><td valign="top"><a href="#Marking-text">2.3 Marking text</a></td></tr>
<tr><td></td><td valign="top"><a href="#index-_005cconcept"><code>\concept</code></a></td><td valign="top"><a href="#Indices">2.9 Indices</a></td></tr>
<tr><td></td><td valign="top"><a href="#index-_005ccr"><code>\cr</code></a></td><td valign="top"><a href="#Sectioning">2.2 Sectioning</a></td></tr>
<tr><td></td><td valign="top"><a href="#index-_005cdeqn"><code>\deqn</code></a></td><td valign="top"><a href="#Mathematics">2.6 Mathematics</a></td></tr>
<tr><td></td><td valign="top"><a href="#index-_005cdescribe"><code>\describe</code></a></td><td valign="top"><a href="#Lists-and-tables">2.4 Lists and tables</a></td></tr>
<tr><td></td><td valign="top"><a href="#index-_005cdescription"><code>\description</code></a></td><td valign="top"><a href="#Documenting-functions">2.1.1 Documenting functions</a></td></tr>
<tr><td></td><td valign="top"><a href="#index-_005cdetails"><code>\details</code></a></td><td valign="top"><a href="#Documenting-functions">2.1.1 Documenting functions</a></td></tr>
<tr><td></td><td valign="top"><a href="#index-_005cdfn"><code>\dfn</code></a></td><td valign="top"><a href="#Marking-text">2.3 Marking text</a></td></tr>
<tr><td></td><td valign="top"><a href="#index-_005cdontrun"><code>\dontrun</code></a></td><td valign="top"><a href="#Documenting-functions">2.1.1 Documenting functions</a></td></tr>
<tr><td></td><td valign="top"><a href="#index-_005cdontshow"><code>\dontshow</code></a></td><td valign="top"><a href="#Documenting-functions">2.1.1 Documenting functions</a></td></tr>
<tr><td></td><td valign="top"><a href="#index-_005cdots"><code>\dots</code></a></td><td valign="top"><a href="#Insertions">2.8 Insertions</a></td></tr>
<tr><td></td><td valign="top"><a href="#index-_005cdQuote"><code>\dQuote</code></a></td><td valign="top"><a href="#Marking-text">2.3 Marking text</a></td></tr>
<tr><td></td><td valign="top"><a href="#index-_005cemail"><code>\email</code></a></td><td valign="top"><a href="#Marking-text">2.3 Marking text</a></td></tr>
<tr><td></td><td valign="top"><a href="#index-_005cemph"><code>\emph</code></a></td><td valign="top"><a href="#Marking-text">2.3 Marking text</a></td></tr>
<tr><td></td><td valign="top"><a href="#index-_005cenc"><code>\enc</code></a></td><td valign="top"><a href="#Insertions">2.8 Insertions</a></td></tr>
<tr><td></td><td valign="top"><a href="#index-_005cenumerate"><code>\enumerate</code></a></td><td valign="top"><a href="#Lists-and-tables">2.4 Lists and tables</a></td></tr>
<tr><td></td><td valign="top"><a href="#index-_005cenv"><code>\env</code></a></td><td valign="top"><a href="#Marking-text">2.3 Marking text</a></td></tr>
<tr><td></td><td valign="top"><a href="#index-_005ceqn"><code>\eqn</code></a></td><td valign="top"><a href="#Mathematics">2.6 Mathematics</a></td></tr>
<tr><td></td><td valign="top"><a href="#index-_005cexamples"><code>\examples</code></a></td><td valign="top"><a href="#Documenting-functions">2.1.1 Documenting functions</a></td></tr>
<tr><td></td><td valign="top"><a href="#index-_005cfigure"><code>\figure</code></a></td><td valign="top"><a href="#Figures">2.7 Figures</a></td></tr>
<tr><td></td><td valign="top"><a href="#index-_005cfile"><code>\file</code></a></td><td valign="top"><a href="#Marking-text">2.3 Marking text</a></td></tr>
<tr><td></td><td valign="top"><a href="#index-_005cformat"><code>\format</code></a></td><td valign="top"><a href="#Documenting-data-sets">2.1.2 Documenting data sets</a></td></tr>
<tr><td></td><td valign="top"><a href="#index-_005chref"><code>\href</code></a></td><td valign="top"><a href="#Marking-text">2.3 Marking text</a></td></tr>
<tr><td></td><td valign="top"><a href="#index-_005cif"><code>\if</code></a></td><td valign="top"><a href="#Conditional-text">2.11 Conditional text</a></td></tr>
<tr><td></td><td valign="top"><a href="#index-_005cifelse"><code>\ifelse</code></a></td><td valign="top"><a href="#Conditional-text">2.11 Conditional text</a></td></tr>
<tr><td></td><td valign="top"><a href="#index-_005citemize"><code>\itemize</code></a></td><td valign="top"><a href="#Lists-and-tables">2.4 Lists and tables</a></td></tr>
<tr><td></td><td valign="top"><a href="#index-_005ckbd"><code>\kbd</code></a></td><td valign="top"><a href="#Marking-text">2.3 Marking text</a></td></tr>
<tr><td></td><td valign="top"><a href="#index-_005ckeyword"><code>\keyword</code></a></td><td valign="top"><a href="#Documenting-functions">2.1.1 Documenting functions</a></td></tr>
<tr><td></td><td valign="top"><a href="#index-_005cldots"><code>\ldots</code></a></td><td valign="top"><a href="#Insertions">2.8 Insertions</a></td></tr>
<tr><td></td><td valign="top"><a href="#index-_005clink"><code>\link</code></a></td><td valign="top"><a href="#Cross_002dreferences">2.5 Cross-references</a></td></tr>
<tr><td></td><td valign="top"><a href="#index-_005cmethod"><code>\method</code></a></td><td valign="top"><a href="#Documenting-functions">2.1.1 Documenting functions</a></td></tr>
<tr><td></td><td valign="top"><a href="#index-_005cname"><code>\name</code></a></td><td valign="top"><a href="#Documenting-functions">2.1.1 Documenting functions</a></td></tr>
<tr><td></td><td valign="top"><a href="#index-_005cnewcommand"><code>\newcommand</code></a></td><td valign="top"><a href="#User_002ddefined-macros">2.13 User-defined macros</a></td></tr>
<tr><td></td><td valign="top"><a href="#index-_005cnote"><code>\note</code></a></td><td valign="top"><a href="#Documenting-functions">2.1.1 Documenting functions</a></td></tr>
<tr><td></td><td valign="top"><a href="#index-_005coption"><code>\option</code></a></td><td valign="top"><a href="#Marking-text">2.3 Marking text</a></td></tr>
<tr><td></td><td valign="top"><a href="#index-_005cout"><code>\out</code></a></td><td valign="top"><a href="#Conditional-text">2.11 Conditional text</a></td></tr>
<tr><td></td><td valign="top"><a href="#index-_005cpkg"><code>\pkg</code></a></td><td valign="top"><a href="#Marking-text">2.3 Marking text</a></td></tr>
<tr><td></td><td valign="top"><a href="#index-_005cpreformatted"><code>\preformatted</code></a></td><td valign="top"><a href="#Marking-text">2.3 Marking text</a></td></tr>
<tr><td></td><td valign="top"><a href="#index-_005cR"><code>\R</code></a></td><td valign="top"><a href="#Insertions">2.8 Insertions</a></td></tr>
<tr><td></td><td valign="top"><a href="#index-_005cRdOpts"><code>\RdOpts</code></a></td><td valign="top"><a href="#Dynamic-pages">2.12 Dynamic pages</a></td></tr>
<tr><td></td><td valign="top"><a href="#index-_005creferences"><code>\references</code></a></td><td valign="top"><a href="#Documenting-functions">2.1.1 Documenting functions</a></td></tr>
<tr><td></td><td valign="top"><a href="#index-_005crenewcommand"><code>\renewcommand</code></a></td><td valign="top"><a href="#User_002ddefined-macros">2.13 User-defined macros</a></td></tr>
<tr><td></td><td valign="top"><a href="#index-_005cS3method"><code>\S3method</code></a></td><td valign="top"><a href="#Documenting-functions">2.1.1 Documenting functions</a></td></tr>
<tr><td></td><td valign="top"><a href="#index-_005csamp"><code>\samp</code></a></td><td valign="top"><a href="#Marking-text">2.3 Marking text</a></td></tr>
<tr><td></td><td valign="top"><a href="#index-_005csection"><code>\section</code></a></td><td valign="top"><a href="#Sectioning">2.2 Sectioning</a></td></tr>
<tr><td></td><td valign="top"><a href="#index-_005cseealso"><code>\seealso</code></a></td><td valign="top"><a href="#Documenting-functions">2.1.1 Documenting functions</a></td></tr>
<tr><td></td><td valign="top"><a href="#index-_005cSexpr"><code>\Sexpr</code></a></td><td valign="top"><a href="#Dynamic-pages">2.12 Dynamic pages</a></td></tr>
<tr><td></td><td valign="top"><a href="#index-_005csource"><code>\source</code></a></td><td valign="top"><a href="#Documenting-data-sets">2.1.2 Documenting data sets</a></td></tr>
<tr><td></td><td valign="top"><a href="#index-_005csQuote"><code>\sQuote</code></a></td><td valign="top"><a href="#Marking-text">2.3 Marking text</a></td></tr>
<tr><td></td><td valign="top"><a href="#index-_005cstrong"><code>\strong</code></a></td><td valign="top"><a href="#Marking-text">2.3 Marking text</a></td></tr>
<tr><td></td><td valign="top"><a href="#index-_005ctabular"><code>\tabular</code></a></td><td valign="top"><a href="#Lists-and-tables">2.4 Lists and tables</a></td></tr>
<tr><td></td><td valign="top"><a href="#index-_005ctitle"><code>\title</code></a></td><td valign="top"><a href="#Documenting-functions">2.1.1 Documenting functions</a></td></tr>
<tr><td></td><td valign="top"><a href="#index-_005curl"><code>\url</code></a></td><td valign="top"><a href="#Marking-text">2.3 Marking text</a></td></tr>
<tr><td></td><td valign="top"><a href="#index-_005cusage"><code>\usage</code></a></td><td valign="top"><a href="#Documenting-functions">2.1.1 Documenting functions</a></td></tr>
<tr><td></td><td valign="top"><a href="#index-_005cvalue"><code>\value</code></a></td><td valign="top"><a href="#Documenting-functions">2.1.1 Documenting functions</a></td></tr>
<tr><td></td><td valign="top"><a href="#index-_005cvar"><code>\var</code></a></td><td valign="top"><a href="#Marking-text">2.3 Marking text</a></td></tr>
<tr><td></td><td valign="top"><a href="#index-_005cverb"><code>\verb</code></a></td><td valign="top"><a href="#Marking-text">2.3 Marking text</a></td></tr>
<tr><td colspan="3"> <hr></td></tr>
<tr><th><a name="Function-and-variable-index-1_vr_letter-A">A</a></th><td></td><td></td></tr>
<tr><td></td><td valign="top"><a href="#index-AUTHORS"><code>AUTHORS</code></a></td><td valign="top"><a href="#Package-subdirectories">1.1.3 Package subdirectories</a></td></tr>
<tr><td colspan="3"> <hr></td></tr>
<tr><th><a name="Function-and-variable-index-1_vr_letter-B">B</a></th><td></td><td></td></tr>
<tr><td></td><td valign="top"><a href="#index-bessel_005fi"><code>bessel_i</code></a></td><td valign="top"><a href="#Mathematical-functions">6.7.2 Mathematical functions</a></td></tr>
<tr><td></td><td valign="top"><a href="#index-bessel_005fi-1"><code>bessel_i</code></a></td><td valign="top"><a href="#Mathematical-functions">6.7.2 Mathematical functions</a></td></tr>
<tr><td></td><td valign="top"><a href="#index-bessel_005fj"><code>bessel_j</code></a></td><td valign="top"><a href="#Mathematical-functions">6.7.2 Mathematical functions</a></td></tr>
<tr><td></td><td valign="top"><a href="#index-bessel_005fj-1"><code>bessel_j</code></a></td><td valign="top"><a href="#Mathematical-functions">6.7.2 Mathematical functions</a></td></tr>
<tr><td></td><td valign="top"><a href="#index-bessel_005fk"><code>bessel_k</code></a></td><td valign="top"><a href="#Mathematical-functions">6.7.2 Mathematical functions</a></td></tr>
<tr><td></td><td valign="top"><a href="#index-bessel_005fk-1"><code>bessel_k</code></a></td><td valign="top"><a href="#Mathematical-functions">6.7.2 Mathematical functions</a></td></tr>
<tr><td></td><td valign="top"><a href="#index-bessel_005fy"><code>bessel_y</code></a></td><td valign="top"><a href="#Mathematical-functions">6.7.2 Mathematical functions</a></td></tr>
<tr><td></td><td valign="top"><a href="#index-bessel_005fy-1"><code>bessel_y</code></a></td><td valign="top"><a href="#Mathematical-functions">6.7.2 Mathematical functions</a></td></tr>
<tr><td></td><td valign="top"><a href="#index-beta"><code>beta</code></a></td><td valign="top"><a href="#Mathematical-functions">6.7.2 Mathematical functions</a></td></tr>
<tr><td></td><td valign="top"><a href="#index-beta-1"><code>beta</code></a></td><td valign="top"><a href="#Mathematical-functions">6.7.2 Mathematical functions</a></td></tr>
<tr><td></td><td valign="top"><a href="#index-BLAS_005fLIBS"><code>BLAS_LIBS</code></a></td><td valign="top"><a href="#Using-Makevars">1.2.1 Using &lsquo;<tt>Makevars</tt>&rsquo;</a></td></tr>
<tr><td></td><td valign="top"><a href="#index-browser"><code>browser</code></a></td><td valign="top"><a href="#Browsing">4.1 Browsing</a></td></tr>
<tr><td colspan="3"> <hr></td></tr>
<tr><th><a name="Function-and-variable-index-1_vr_letter-C">C</a></th><td></td><td></td></tr>
<tr><td></td><td valign="top"><a href="#index-Calloc"><code>Calloc</code></a></td><td valign="top"><a href="#User_002dcontrolled">6.1.2 User-controlled memory</a></td></tr>
<tr><td></td><td valign="top"><a href="#index-CAR"><code>CAR</code></a></td><td valign="top"><a href="#Calling-_002eExternal">5.10.2 Calling <code>.External</code></a></td></tr>
<tr><td></td><td valign="top"><a href="#index-CDR"><code>CDR</code></a></td><td valign="top"><a href="#Calling-_002eExternal">5.10.2 Calling <code>.External</code></a></td></tr>
<tr><td></td><td valign="top"><a href="#index-cgmin"><code>cgmin</code></a></td><td valign="top"><a href="#Optimization">6.8 Optimization</a></td></tr>
<tr><td></td><td valign="top"><a href="#index-choose"><code>choose</code></a></td><td valign="top"><a href="#Mathematical-functions">6.7.2 Mathematical functions</a></td></tr>
<tr><td></td><td valign="top"><a href="#index-choose-1"><code>choose</code></a></td><td valign="top"><a href="#Mathematical-functions">6.7.2 Mathematical functions</a></td></tr>
<tr><td></td><td valign="top"><a href="#index-CITATION"><code>CITATION</code></a></td><td valign="top"><a href="#Package-subdirectories">1.1.3 Package subdirectories</a></td></tr>
<tr><td></td><td valign="top"><a href="#index-CITATION-1"><code>CITATION</code></a></td><td valign="top"><a href="#Supporting-R-function">1.9.4 Supporting R function</a></td></tr>
<tr><td></td><td valign="top"><a href="#index-COPYRIGHTS"><code>COPYRIGHTS</code></a></td><td valign="top"><a href="#The-DESCRIPTION-file">1.1.1 The &lsquo;<tt>DESCRIPTION</tt>&rsquo; file</a></td></tr>
<tr><td></td><td valign="top"><a href="#index-COPYRIGHTS-1"><code>COPYRIGHTS</code></a></td><td valign="top"><a href="#Package-subdirectories">1.1.3 Package subdirectories</a></td></tr>
<tr><td></td><td valign="top"><a href="#index-cPsort"><code>cPsort</code></a></td><td valign="top"><a href="#Utility-functions">6.10 Utility functions</a></td></tr>
<tr><td colspan="3"> <hr></td></tr>
<tr><th><a name="Function-and-variable-index-1_vr_letter-D">D</a></th><td></td><td></td></tr>
<tr><td></td><td valign="top"><a href="#index-debug"><code>debug</code></a></td><td valign="top"><a href="#Debugging-R-code">4.2 Debugging R code</a></td></tr>
<tr><td></td><td valign="top"><a href="#index-debugger"><code>debugger</code></a></td><td valign="top"><a href="#Debugging-R-code">4.2 Debugging R code</a></td></tr>
<tr><td></td><td valign="top"><a href="#index-defineVar"><code>defineVar</code></a></td><td valign="top"><a href="#Finding-and-setting-variables">5.9.8 Finding and setting variables</a></td></tr>
<tr><td></td><td valign="top"><a href="#index-digamma"><code>digamma</code></a></td><td valign="top"><a href="#Mathematical-functions">6.7.2 Mathematical functions</a></td></tr>
<tr><td></td><td valign="top"><a href="#index-digamma-1"><code>digamma</code></a></td><td valign="top"><a href="#Mathematical-functions">6.7.2 Mathematical functions</a></td></tr>
<tr><td></td><td valign="top"><a href="#index-dump_002eframes"><code>dump.frames</code></a></td><td valign="top"><a href="#Debugging-R-code">4.2 Debugging R code</a></td></tr>
<tr><td></td><td valign="top"><a href="#index-duplicate"><code>duplicate</code></a></td><td valign="top"><a href="#Named-objects-and-copying">5.9.10 Named objects and copying</a></td></tr>
<tr><td></td><td valign="top"><a href="#index-dyn_002eload"><code>dyn.load</code></a></td><td valign="top"><a href="#dyn_002eload-and-dyn_002eunload">5.3 <code>dyn.load</code> and <code>dyn.unload</code></a></td></tr>
<tr><td></td><td valign="top"><a href="#index-dyn_002eunload"><code>dyn.unload</code></a></td><td valign="top"><a href="#dyn_002eload-and-dyn_002eunload">5.3 <code>dyn.load</code> and <code>dyn.unload</code></a></td></tr>
<tr><td colspan="3"> <hr></td></tr>
<tr><th><a name="Function-and-variable-index-1_vr_letter-E">E</a></th><td></td><td></td></tr>
<tr><td></td><td valign="top"><a href="#index-expm1"><code>expm1</code></a></td><td valign="top"><a href="#Numerical-Utilities">6.7.3 Numerical Utilities</a></td></tr>
<tr><td></td><td valign="top"><a href="#index-export"><code>export</code></a></td><td valign="top"><a href="#Specifying-imports-and-exports">1.6.1 Specifying imports and exports</a></td></tr>
<tr><td></td><td valign="top"><a href="#index-exportClasses"><code>exportClasses</code></a></td><td valign="top"><a href="#Namespaces-with-S4-classes-and-methods">1.6.6 Namespaces with S4 classes and methods</a></td></tr>
<tr><td></td><td valign="top"><a href="#index-exportClassPattern"><code>exportClassPattern</code></a></td><td valign="top"><a href="#Namespaces-with-S4-classes-and-methods">1.6.6 Namespaces with S4 classes and methods</a></td></tr>
<tr><td></td><td valign="top"><a href="#index-exportMethods"><code>exportMethods</code></a></td><td valign="top"><a href="#Namespaces-with-S4-classes-and-methods">1.6.6 Namespaces with S4 classes and methods</a></td></tr>
<tr><td></td><td valign="top"><a href="#index-exportPattern"><code>exportPattern</code></a></td><td valign="top"><a href="#Specifying-imports-and-exports">1.6.1 Specifying imports and exports</a></td></tr>
<tr><td></td><td valign="top"><a href="#index-exportPattern-1"><code>exportPattern</code></a></td><td valign="top"><a href="#Namespaces-with-S4-classes-and-methods">1.6.6 Namespaces with S4 classes and methods</a></td></tr>
<tr><td></td><td valign="top"><a href="#index-exp_005frand"><code>exp_rand</code></a></td><td valign="top"><a href="#Random-numbers">6.3 Random number generation</a></td></tr>
<tr><td colspan="3"> <hr></td></tr>
<tr><th><a name="Function-and-variable-index-1_vr_letter-F">F</a></th><td></td><td></td></tr>
<tr><td></td><td valign="top"><a href="#index-FALSE"><code>FALSE</code></a></td><td valign="top"><a href="#Mathematical-constants">6.7.4 Mathematical constants</a></td></tr>
<tr><td></td><td valign="top"><a href="#index-findInterval"><code>findInterval</code></a></td><td valign="top"><a href="#Utility-functions">6.10 Utility functions</a></td></tr>
<tr><td></td><td valign="top"><a href="#index-findVar"><code>findVar</code></a></td><td valign="top"><a href="#Finding-and-setting-variables">5.9.8 Finding and setting variables</a></td></tr>
<tr><td></td><td valign="top"><a href="#index-FLIBS"><code>FLIBS</code></a></td><td valign="top"><a href="#Using-Makevars">1.2.1 Using &lsquo;<tt>Makevars</tt>&rsquo;</a></td></tr>
<tr><td></td><td valign="top"><a href="#index-fmax2"><code>fmax2</code></a></td><td valign="top"><a href="#Numerical-Utilities">6.7.3 Numerical Utilities</a></td></tr>
<tr><td></td><td valign="top"><a href="#index-fmin2"><code>fmin2</code></a></td><td valign="top"><a href="#Numerical-Utilities">6.7.3 Numerical Utilities</a></td></tr>
<tr><td></td><td valign="top"><a href="#index-fprec"><code>fprec</code></a></td><td valign="top"><a href="#Numerical-Utilities">6.7.3 Numerical Utilities</a></td></tr>
<tr><td></td><td valign="top"><a href="#index-Free"><code>Free</code></a></td><td valign="top"><a href="#User_002dcontrolled">6.1.2 User-controlled memory</a></td></tr>
<tr><td></td><td valign="top"><a href="#index-fround"><code>fround</code></a></td><td valign="top"><a href="#Numerical-Utilities">6.7.3 Numerical Utilities</a></td></tr>
<tr><td></td><td valign="top"><a href="#index-fsign"><code>fsign</code></a></td><td valign="top"><a href="#Numerical-Utilities">6.7.3 Numerical Utilities</a></td></tr>
<tr><td></td><td valign="top"><a href="#index-ftrunc"><code>ftrunc</code></a></td><td valign="top"><a href="#Numerical-Utilities">6.7.3 Numerical Utilities</a></td></tr>
<tr><td colspan="3"> <hr></td></tr>
<tr><th><a name="Function-and-variable-index-1_vr_letter-G">G</a></th><td></td><td></td></tr>
<tr><td></td><td valign="top"><a href="#index-gammafn"><code>gammafn</code></a></td><td valign="top"><a href="#Mathematical-functions">6.7.2 Mathematical functions</a></td></tr>
<tr><td></td><td valign="top"><a href="#index-gammafn-1"><code>gammafn</code></a></td><td valign="top"><a href="#Mathematical-functions">6.7.2 Mathematical functions</a></td></tr>
<tr><td></td><td valign="top"><a href="#index-gctorture"><code>gctorture</code></a></td><td valign="top"><a href="#Using-gctorture">4.3.1 Using gctorture</a></td></tr>
<tr><td></td><td valign="top"><a href="#index-getAttrib"><code>getAttrib</code></a></td><td valign="top"><a href="#Attributes">5.9.4 Attributes</a></td></tr>
<tr><td></td><td valign="top"><a href="#index-getCharCE"><code>getCharCE</code></a></td><td valign="top"><a href="#Character-encoding-issues">5.15 Character encoding issues</a></td></tr>
<tr><td></td><td valign="top"><a href="#index-GetRNGstate"><code>GetRNGstate</code></a></td><td valign="top"><a href="#Random-numbers">6.3 Random number generation</a></td></tr>
<tr><td colspan="3"> <hr></td></tr>
<tr><th><a name="Function-and-variable-index-1_vr_letter-I">I</a></th><td></td><td></td></tr>
<tr><td></td><td valign="top"><a href="#index-imax2"><code>imax2</code></a></td><td valign="top"><a href="#Numerical-Utilities">6.7.3 Numerical Utilities</a></td></tr>
<tr><td></td><td valign="top"><a href="#index-imin2"><code>imin2</code></a></td><td valign="top"><a href="#Numerical-Utilities">6.7.3 Numerical Utilities</a></td></tr>
<tr><td></td><td valign="top"><a href="#index-import"><code>import</code></a></td><td valign="top"><a href="#Specifying-imports-and-exports">1.6.1 Specifying imports and exports</a></td></tr>
<tr><td></td><td valign="top"><a href="#index-importClassesFrom"><code>importClassesFrom</code></a></td><td valign="top"><a href="#Namespaces-with-S4-classes-and-methods">1.6.6 Namespaces with S4 classes and methods</a></td></tr>
<tr><td></td><td valign="top"><a href="#index-importFrom"><code>importFrom</code></a></td><td valign="top"><a href="#Specifying-imports-and-exports">1.6.1 Specifying imports and exports</a></td></tr>
<tr><td></td><td valign="top"><a href="#index-importMethodsFrom"><code>importMethodsFrom</code></a></td><td valign="top"><a href="#Namespaces-with-S4-classes-and-methods">1.6.6 Namespaces with S4 classes and methods</a></td></tr>
<tr><td></td><td valign="top"><a href="#index-install"><code>install</code></a></td><td valign="top"><a href="#Attributes">5.9.4 Attributes</a></td></tr>
<tr><td></td><td valign="top"><a href="#index-iPsort"><code>iPsort</code></a></td><td valign="top"><a href="#Utility-functions">6.10 Utility functions</a></td></tr>
<tr><td></td><td valign="top"><a href="#index-ISNA"><code>ISNA</code></a></td><td valign="top"><a href="#Missing-and-special-values">5.10.3 Missing and special values</a></td></tr>
<tr><td></td><td valign="top"><a href="#index-ISNA-1"><code>ISNA</code></a></td><td valign="top"><a href="#Missing-and-IEEE-values">6.4 Missing and <acronym>IEEE</acronym> special values</a></td></tr>
<tr><td></td><td valign="top"><a href="#index-ISNAN"><code>ISNAN</code></a></td><td valign="top"><a href="#Missing-and-special-values">5.10.3 Missing and special values</a></td></tr>
<tr><td></td><td valign="top"><a href="#index-ISNAN-1"><code>ISNAN</code></a></td><td valign="top"><a href="#Missing-and-IEEE-values">6.4 Missing and <acronym>IEEE</acronym> special values</a></td></tr>
<tr><td colspan="3"> <hr></td></tr>
<tr><th><a name="Function-and-variable-index-1_vr_letter-L">L</a></th><td></td><td></td></tr>
<tr><td></td><td valign="top"><a href="#index-LAPACK_005fLIBS"><code>LAPACK_LIBS</code></a></td><td valign="top"><a href="#Using-Makevars">1.2.1 Using &lsquo;<tt>Makevars</tt>&rsquo;</a></td></tr>
<tr><td></td><td valign="top"><a href="#index-lbeta"><code>lbeta</code></a></td><td valign="top"><a href="#Mathematical-functions">6.7.2 Mathematical functions</a></td></tr>
<tr><td></td><td valign="top"><a href="#index-lbeta-1"><code>lbeta</code></a></td><td valign="top"><a href="#Mathematical-functions">6.7.2 Mathematical functions</a></td></tr>
<tr><td></td><td valign="top"><a href="#index-lbfgsb"><code>lbfgsb</code></a></td><td valign="top"><a href="#Optimization">6.8 Optimization</a></td></tr>
<tr><td></td><td valign="top"><a href="#index-lchoose"><code>lchoose</code></a></td><td valign="top"><a href="#Mathematical-functions">6.7.2 Mathematical functions</a></td></tr>
<tr><td></td><td valign="top"><a href="#index-lchoose-1"><code>lchoose</code></a></td><td valign="top"><a href="#Mathematical-functions">6.7.2 Mathematical functions</a></td></tr>
<tr><td></td><td valign="top"><a href="#index-lgamma1p"><code>lgamma1p</code></a></td><td valign="top"><a href="#Numerical-Utilities">6.7.3 Numerical Utilities</a></td></tr>
<tr><td></td><td valign="top"><a href="#index-lgammafn"><code>lgammafn</code></a></td><td valign="top"><a href="#Mathematical-functions">6.7.2 Mathematical functions</a></td></tr>
<tr><td></td><td valign="top"><a href="#index-lgammafn-1"><code>lgammafn</code></a></td><td valign="top"><a href="#Mathematical-functions">6.7.2 Mathematical functions</a></td></tr>
<tr><td></td><td valign="top"><a href="#index-library_002edynam"><code>library.dynam</code></a></td><td valign="top"><a href="#Package-subdirectories">1.1.3 Package subdirectories</a></td></tr>
<tr><td></td><td valign="top"><a href="#index-library_002edynam-1"><code>library.dynam</code></a></td><td valign="top"><a href="#dyn_002eload-and-dyn_002eunload">5.3 <code>dyn.load</code> and <code>dyn.unload</code></a></td></tr>
<tr><td></td><td valign="top"><a href="#index-log1p"><code>log1p</code></a></td><td valign="top"><a href="#Numerical-Utilities">6.7.3 Numerical Utilities</a></td></tr>
<tr><td></td><td valign="top"><a href="#index-log1pexp"><code>log1pexp</code></a></td><td valign="top"><a href="#Numerical-Utilities">6.7.3 Numerical Utilities</a></td></tr>
<tr><td></td><td valign="top"><a href="#index-log1pmx"><code>log1pmx</code></a></td><td valign="top"><a href="#Numerical-Utilities">6.7.3 Numerical Utilities</a></td></tr>
<tr><td></td><td valign="top"><a href="#index-logspace_005fadd"><code>logspace_add</code></a></td><td valign="top"><a href="#Numerical-Utilities">6.7.3 Numerical Utilities</a></td></tr>
<tr><td></td><td valign="top"><a href="#index-logspace_005fsub"><code>logspace_sub</code></a></td><td valign="top"><a href="#Numerical-Utilities">6.7.3 Numerical Utilities</a></td></tr>
<tr><td colspan="3"> <hr></td></tr>
<tr><th><a name="Function-and-variable-index-1_vr_letter-M">M</a></th><td></td><td></td></tr>
<tr><td></td><td valign="top"><a href="#index-mkChar"><code>mkChar</code></a></td><td valign="top"><a href="#Handling-character-data">5.9.7 Handling character data</a></td></tr>
<tr><td></td><td valign="top"><a href="#index-mkCharCE"><code>mkCharCE</code></a></td><td valign="top"><a href="#Character-encoding-issues">5.15 Character encoding issues</a></td></tr>
<tr><td></td><td valign="top"><a href="#index-mkCharLen"><code>mkCharLen</code></a></td><td valign="top"><a href="#Handling-character-data">5.9.7 Handling character data</a></td></tr>
<tr><td></td><td valign="top"><a href="#index-mkCharLenCE"><code>mkCharLenCE</code></a></td><td valign="top"><a href="#Character-encoding-issues">5.15 Character encoding issues</a></td></tr>
<tr><td></td><td valign="top"><a href="#index-M_005fE"><code>M_E</code></a></td><td valign="top"><a href="#Mathematical-constants">6.7.4 Mathematical constants</a></td></tr>
<tr><td></td><td valign="top"><a href="#index-M_005fPI"><code>M_PI</code></a></td><td valign="top"><a href="#Mathematical-constants">6.7.4 Mathematical constants</a></td></tr>
<tr><td colspan="3"> <hr></td></tr>
<tr><th><a name="Function-and-variable-index-1_vr_letter-N">N</a></th><td></td><td></td></tr>
<tr><td></td><td valign="top"><a href="#index-NA_005fREAL"><code>NA_REAL</code></a></td><td valign="top"><a href="#Missing-and-IEEE-values">6.4 Missing and <acronym>IEEE</acronym> special values</a></td></tr>
<tr><td></td><td valign="top"><a href="#index-nmmin"><code>nmmin</code></a></td><td valign="top"><a href="#Optimization">6.8 Optimization</a></td></tr>
<tr><td></td><td valign="top"><a href="#index-norm_005frand"><code>norm_rand</code></a></td><td valign="top"><a href="#Random-numbers">6.3 Random number generation</a></td></tr>
<tr><td colspan="3"> <hr></td></tr>
<tr><th><a name="Function-and-variable-index-1_vr_letter-O">O</a></th><td></td><td></td></tr>
<tr><td></td><td valign="top"><a href="#index-OBJECTS"><code>OBJECTS</code></a></td><td valign="top"><a href="#Using-Makevars">1.2.1 Using &lsquo;<tt>Makevars</tt>&rsquo;</a></td></tr>
<tr><td></td><td valign="top"><a href="#index-OBJECTS-1"><code>OBJECTS</code></a></td><td valign="top"><a href="#Creating-shared-objects">5.5 Creating shared objects</a></td></tr>
<tr><td colspan="3"> <hr></td></tr>
<tr><th><a name="Function-and-variable-index-1_vr_letter-P">P</a></th><td></td><td></td></tr>
<tr><td></td><td valign="top"><a href="#index-pentagamma"><code>pentagamma</code></a></td><td valign="top"><a href="#Mathematical-functions">6.7.2 Mathematical functions</a></td></tr>
<tr><td></td><td valign="top"><a href="#index-pentagamma-1"><code>pentagamma</code></a></td><td valign="top"><a href="#Mathematical-functions">6.7.2 Mathematical functions</a></td></tr>
<tr><td></td><td valign="top"><a href="#index-PKG_005fCFLAGS"><code>PKG_CFLAGS</code></a></td><td valign="top"><a href="#Creating-shared-objects">5.5 Creating shared objects</a></td></tr>
<tr><td></td><td valign="top"><a href="#index-PKG_005fCPPFLAGS"><code>PKG_CPPFLAGS</code></a></td><td valign="top"><a href="#Creating-shared-objects">5.5 Creating shared objects</a></td></tr>
<tr><td></td><td valign="top"><a href="#index-PKG_005fCXXFLAGS"><code>PKG_CXXFLAGS</code></a></td><td valign="top"><a href="#Creating-shared-objects">5.5 Creating shared objects</a></td></tr>
<tr><td></td><td valign="top"><a href="#index-PKG_005fFCFLAGS"><code>PKG_FCFLAGS</code></a></td><td valign="top"><a href="#Creating-shared-objects">5.5 Creating shared objects</a></td></tr>
<tr><td></td><td valign="top"><a href="#index-PKG_005fFFLAGS"><code>PKG_FFLAGS</code></a></td><td valign="top"><a href="#Creating-shared-objects">5.5 Creating shared objects</a></td></tr>
<tr><td></td><td valign="top"><a href="#index-PKG_005fLIBS"><code>PKG_LIBS</code></a></td><td valign="top"><a href="#Creating-shared-objects">5.5 Creating shared objects</a></td></tr>
<tr><td></td><td valign="top"><a href="#index-PKG_005fOBJCFLAGS"><code>PKG_OBJCFLAGS</code></a></td><td valign="top"><a href="#Creating-shared-objects">5.5 Creating shared objects</a></td></tr>
<tr><td></td><td valign="top"><a href="#index-prompt"><code>prompt</code></a></td><td valign="top"><a href="#Rd-format">2.1 Rd format</a></td></tr>
<tr><td></td><td valign="top"><a href="#index-PROTECT"><code>PROTECT</code></a></td><td valign="top"><a href="#Garbage-Collection">5.9.1 Handling the effects of garbage collection</a></td></tr>
<tr><td></td><td valign="top"><a href="#index-PROTECT_005fWITH_005fINDEX"><code>PROTECT_WITH_INDEX</code></a></td><td valign="top"><a href="#Garbage-Collection">5.9.1 Handling the effects of garbage collection</a></td></tr>
<tr><td></td><td valign="top"><a href="#index-psigamma"><code>psigamma</code></a></td><td valign="top"><a href="#Mathematical-functions">6.7.2 Mathematical functions</a></td></tr>
<tr><td></td><td valign="top"><a href="#index-psigamma-1"><code>psigamma</code></a></td><td valign="top"><a href="#Mathematical-functions">6.7.2 Mathematical functions</a></td></tr>
<tr><td></td><td valign="top"><a href="#index-PutRNGstate"><code>PutRNGstate</code></a></td><td valign="top"><a href="#Random-numbers">6.3 Random number generation</a></td></tr>
<tr><td colspan="3"> <hr></td></tr>
<tr><th><a name="Function-and-variable-index-1_vr_letter-Q">Q</a></th><td></td><td></td></tr>
<tr><td></td><td valign="top"><a href="#index-qsort3"><code>qsort3</code></a></td><td valign="top"><a href="#Utility-functions">6.10 Utility functions</a></td></tr>
<tr><td></td><td valign="top"><a href="#index-qsort4"><code>qsort4</code></a></td><td valign="top"><a href="#Utility-functions">6.10 Utility functions</a></td></tr>
<tr><td colspan="3"> <hr></td></tr>
<tr><th><a name="Function-and-variable-index-1_vr_letter-R">R</a></th><td></td><td></td></tr>
<tr><td></td><td valign="top"><a href="#index-R-CMD-build"><code>R CMD build</code></a></td><td valign="top"><a href="#Building-package-tarballs">1.3.2 Building package tarballs</a></td></tr>
<tr><td></td><td valign="top"><a href="#index-R-CMD-check"><code>R CMD check</code></a></td><td valign="top"><a href="#Checking-packages">1.3.1 Checking packages</a></td></tr>
<tr><td></td><td valign="top"><a href="#index-R-CMD-config"><code>R CMD config</code></a></td><td valign="top"><a href="#Configure-and-cleanup">1.2 Configure and cleanup</a></td></tr>
<tr><td></td><td valign="top"><a href="#index-R-CMD-Rd2pdf"><code>R CMD Rd2pdf</code></a></td><td valign="top"><a href="#Processing-Rd-format">2.15 Processing Rd format</a></td></tr>
<tr><td></td><td valign="top"><a href="#index-R-CMD-Rdconv"><code>R CMD Rdconv</code></a></td><td valign="top"><a href="#Processing-Rd-format">2.15 Processing Rd format</a></td></tr>
<tr><td></td><td valign="top"><a href="#index-R-CMD-SHLIB"><code>R CMD SHLIB</code></a></td><td valign="top"><a href="#Creating-shared-objects">5.5 Creating shared objects</a></td></tr>
<tr><td></td><td valign="top"><a href="#index-R-CMD-Stangle"><code>R CMD Stangle</code></a></td><td valign="top"><a href="#Processing-Rd-format">2.15 Processing Rd format</a></td></tr>
<tr><td></td><td valign="top"><a href="#index-R-CMD-Sweave"><code>R CMD Sweave</code></a></td><td valign="top"><a href="#Processing-Rd-format">2.15 Processing Rd format</a></td></tr>
<tr><td></td><td valign="top"><a href="#index-Rdqagi"><code>Rdqagi</code></a></td><td valign="top"><a href="#Integration">6.9 Integration</a></td></tr>
<tr><td></td><td valign="top"><a href="#index-Rdqags"><code>Rdqags</code></a></td><td valign="top"><a href="#Integration">6.9 Integration</a></td></tr>
<tr><td></td><td valign="top"><a href="#index-Realloc"><code>Realloc</code></a></td><td valign="top"><a href="#User_002dcontrolled">6.1.2 User-controlled memory</a></td></tr>
<tr><td></td><td valign="top"><a href="#index-recover"><code>recover</code></a></td><td valign="top"><a href="#Debugging-R-code">4.2 Debugging R code</a></td></tr>
<tr><td></td><td valign="top"><a href="#index-reEnc"><code>reEnc</code></a></td><td valign="top"><a href="#Character-encoding-issues">5.15 Character encoding issues</a></td></tr>
<tr><td></td><td valign="top"><a href="#index-REprintf"><code>REprintf</code></a></td><td valign="top"><a href="#Printing">6.5 Printing</a></td></tr>
<tr><td></td><td valign="top"><a href="#index-REPROTECT"><code>REPROTECT</code></a></td><td valign="top"><a href="#Garbage-Collection">5.9.1 Handling the effects of garbage collection</a></td></tr>
<tr><td></td><td valign="top"><a href="#index-REvprintf"><code>REvprintf</code></a></td><td valign="top"><a href="#Printing">6.5 Printing</a></td></tr>
<tr><td></td><td valign="top"><a href="#index-revsort"><code>revsort</code></a></td><td valign="top"><a href="#Utility-functions">6.10 Utility functions</a></td></tr>
<tr><td></td><td valign="top"><a href="#index-Riconv"><code>Riconv</code></a></td><td valign="top"><a href="#Re_002dencoding">6.11 Re-encoding</a></td></tr>
<tr><td></td><td valign="top"><a href="#index-Riconv_005fclose"><code>Riconv_close</code></a></td><td valign="top"><a href="#Re_002dencoding">6.11 Re-encoding</a></td></tr>
<tr><td></td><td valign="top"><a href="#index-Rprintf"><code>Rprintf</code></a></td><td valign="top"><a href="#Printing">6.5 Printing</a></td></tr>
<tr><td></td><td valign="top"><a href="#index-Rprof"><code>Rprof</code></a></td><td valign="top"><a href="#Profiling-R-code-for-speed">3.2 Profiling R code for speed</a></td></tr>
<tr><td></td><td valign="top"><a href="#index-Rprof-1"><code>Rprof</code></a></td><td valign="top"><a href="#Memory-statistics-from-Rprof">3.3.1 Memory statistics from <code>Rprof</code></a></td></tr>
<tr><td></td><td valign="top"><a href="#index-Rprofmem"><code>Rprofmem</code></a></td><td valign="top"><a href="#Tracking-memory-allocations">3.3.2 Tracking memory allocations</a></td></tr>
<tr><td></td><td valign="top"><a href="#index-rPsort"><code>rPsort</code></a></td><td valign="top"><a href="#Utility-functions">6.10 Utility functions</a></td></tr>
<tr><td></td><td valign="top"><a href="#index-rsort_005fwith_005findex"><code>rsort_with_index</code></a></td><td valign="top"><a href="#Utility-functions">6.10 Utility functions</a></td></tr>
<tr><td></td><td valign="top"><a href="#index-Rvprintf"><code>Rvprintf</code></a></td><td valign="top"><a href="#Printing">6.5 Printing</a></td></tr>
<tr><td></td><td valign="top"><a href="#index-R_005faddhistory"><code>R_addhistory</code></a></td><td valign="top"><a href="#Setting-R-callbacks">8.1.2 Setting R callbacks</a></td></tr>
<tr><td></td><td valign="top"><a href="#index-R_005falloc"><code>R_alloc</code></a></td><td valign="top"><a href="#Transient">6.1.1 Transient storage allocation</a></td></tr>
<tr><td></td><td valign="top"><a href="#index-R_005fBusy"><code>R_Busy</code></a></td><td valign="top"><a href="#Setting-R-callbacks">8.1.2 Setting R callbacks</a></td></tr>
<tr><td></td><td valign="top"><a href="#index-R_005fChooseFile"><code>R_ChooseFile</code></a></td><td valign="top"><a href="#Setting-R-callbacks">8.1.2 Setting R callbacks</a></td></tr>
<tr><td></td><td valign="top"><a href="#index-R_005fCleanUp"><code>R_CleanUp</code></a></td><td valign="top"><a href="#Setting-R-callbacks">8.1.2 Setting R callbacks</a></td></tr>
<tr><td></td><td valign="top"><a href="#index-R_005fClearErrConsole"><code>R_ClearErrConsole</code></a></td><td valign="top"><a href="#Setting-R-callbacks">8.1.2 Setting R callbacks</a></td></tr>
<tr><td></td><td valign="top"><a href="#index-R_005fcsort"><code>R_csort</code></a></td><td valign="top"><a href="#Utility-functions">6.10 Utility functions</a></td></tr>
<tr><td></td><td valign="top"><a href="#index-R_005fdataentry"><code>R_dataentry</code></a></td><td valign="top"><a href="#Setting-R-callbacks">8.1.2 Setting R callbacks</a></td></tr>
<tr><td></td><td valign="top"><a href="#index-R_005fdataviewer"><code>R_dataviewer</code></a></td><td valign="top"><a href="#Setting-R-callbacks">8.1.2 Setting R callbacks</a></td></tr>
<tr><td></td><td valign="top"><a href="#index-R_005fEditFile"><code>R_EditFile</code></a></td><td valign="top"><a href="#Setting-R-callbacks">8.1.2 Setting R callbacks</a></td></tr>
<tr><td></td><td valign="top"><a href="#index-R_005fEditFiles"><code>R_EditFiles</code></a></td><td valign="top"><a href="#Setting-R-callbacks">8.1.2 Setting R callbacks</a></td></tr>
<tr><td></td><td valign="top"><a href="#index-R_005fExpandFileName"><code>R_ExpandFileName</code></a></td><td valign="top"><a href="#Utility-functions">6.10 Utility functions</a></td></tr>
<tr><td></td><td valign="top"><a href="#index-R_005fFINITE"><code>R_FINITE</code></a></td><td valign="top"><a href="#Missing-and-IEEE-values">6.4 Missing and <acronym>IEEE</acronym> special values</a></td></tr>
<tr><td></td><td valign="top"><a href="#index-R_005fFlushConsole"><code>R_FlushConsole</code></a></td><td valign="top"><a href="#Setting-R-callbacks">8.1.2 Setting R callbacks</a></td></tr>
<tr><td></td><td valign="top"><a href="#index-R_005fGetCCallable"><code>R_GetCCallable</code></a></td><td valign="top"><a href="#Linking-to-native-routines-in-other-packages">5.4.2 Linking to native routines in other packages</a></td></tr>
<tr><td></td><td valign="top"><a href="#index-R_005fGetCurrentSrcref"><code>R_GetCurrentSrcref</code></a></td><td valign="top"><a href="#Accessing-source-references">5.12.1 Accessing source references</a></td></tr>
<tr><td></td><td valign="top"><a href="#index-R_005fGetSrcFilename"><code>R_GetSrcFilename</code></a></td><td valign="top"><a href="#Accessing-source-references">5.12.1 Accessing source references</a></td></tr>
<tr><td></td><td valign="top"><a href="#index-R_005fINLINE"><code>R_INLINE</code></a></td><td valign="top"><a href="#Inlining-C-functions">6.14 Inlining C functions</a></td></tr>
<tr><td></td><td valign="top"><a href="#index-R_005fIsNaN"><code>R_IsNaN</code></a></td><td valign="top"><a href="#Missing-and-IEEE-values">6.4 Missing and <acronym>IEEE</acronym> special values</a></td></tr>
<tr><td></td><td valign="top"><a href="#index-R_005fisort"><code>R_isort</code></a></td><td valign="top"><a href="#Utility-functions">6.10 Utility functions</a></td></tr>
<tr><td></td><td valign="top"><a href="#index-R_005fLIBRARY_005fDIR"><code>R_LIBRARY_DIR</code></a></td><td valign="top"><a href="#Configure-and-cleanup">1.2 Configure and cleanup</a></td></tr>
<tr><td></td><td valign="top"><a href="#index-R_005floadhistory"><code>R_loadhistory</code></a></td><td valign="top"><a href="#Setting-R-callbacks">8.1.2 Setting R callbacks</a></td></tr>
<tr><td></td><td valign="top"><a href="#index-R_005fmax_005fcol"><code>R_max_col</code></a></td><td valign="top"><a href="#Utility-functions">6.10 Utility functions</a></td></tr>
<tr><td></td><td valign="top"><a href="#index-R_005fNegInf"><code>R_NegInf</code></a></td><td valign="top"><a href="#Missing-and-IEEE-values">6.4 Missing and <acronym>IEEE</acronym> special values</a></td></tr>
<tr><td></td><td valign="top"><a href="#index-R_005forderVector"><code>R_orderVector</code></a></td><td valign="top"><a href="#Utility-functions">6.10 Utility functions</a></td></tr>
<tr><td></td><td valign="top"><a href="#index-R_005fPACKAGE_005fDIR"><code>R_PACKAGE_DIR</code></a></td><td valign="top"><a href="#Configure-and-cleanup">1.2 Configure and cleanup</a></td></tr>
<tr><td></td><td valign="top"><a href="#index-R_005fPACKAGE_005fNAME"><code>R_PACKAGE_NAME</code></a></td><td valign="top"><a href="#Configure-and-cleanup">1.2 Configure and cleanup</a></td></tr>
<tr><td></td><td valign="top"><a href="#index-R_005fParseVector"><code>R_ParseVector</code></a></td><td valign="top"><a href="#Parsing-R-code-from-C">5.12 Parsing R code from C</a></td></tr>
<tr><td></td><td valign="top"><a href="#index-R_005fPosInf"><code>R_PosInf</code></a></td><td valign="top"><a href="#Missing-and-IEEE-values">6.4 Missing and <acronym>IEEE</acronym> special values</a></td></tr>
<tr><td></td><td valign="top"><a href="#index-R_005fpow"><code>R_pow</code></a></td><td valign="top"><a href="#Numerical-Utilities">6.7.3 Numerical Utilities</a></td></tr>
<tr><td></td><td valign="top"><a href="#index-R_005fpow_005fdi"><code>R_pow_di</code></a></td><td valign="top"><a href="#Numerical-Utilities">6.7.3 Numerical Utilities</a></td></tr>
<tr><td></td><td valign="top"><a href="#index-R_005fqsort"><code>R_qsort</code></a></td><td valign="top"><a href="#Utility-functions">6.10 Utility functions</a></td></tr>
<tr><td></td><td valign="top"><a href="#index-R_005fqsort_005fI"><code>R_qsort_I</code></a></td><td valign="top"><a href="#Utility-functions">6.10 Utility functions</a></td></tr>
<tr><td></td><td valign="top"><a href="#index-R_005fqsort_005fint"><code>R_qsort_int</code></a></td><td valign="top"><a href="#Utility-functions">6.10 Utility functions</a></td></tr>
<tr><td></td><td valign="top"><a href="#index-R_005fqsort_005fint_005fI"><code>R_qsort_int_I</code></a></td><td valign="top"><a href="#Utility-functions">6.10 Utility functions</a></td></tr>
<tr><td></td><td valign="top"><a href="#index-R_005fReadConsole"><code>R_ReadConsole</code></a></td><td valign="top"><a href="#Setting-R-callbacks">8.1.2 Setting R callbacks</a></td></tr>
<tr><td></td><td valign="top"><a href="#index-R_005fRegisterCCallable"><code>R_RegisterCCallable</code></a></td><td valign="top"><a href="#Linking-to-native-routines-in-other-packages">5.4.2 Linking to native routines in other packages</a></td></tr>
<tr><td></td><td valign="top"><a href="#index-R_005fregisterRoutines"><code>R_registerRoutines</code></a></td><td valign="top"><a href="#Registering-native-routines">5.4 Registering native routines</a></td></tr>
<tr><td></td><td valign="top"><a href="#index-R_005fResetConsole"><code>R_ResetConsole</code></a></td><td valign="top"><a href="#Setting-R-callbacks">8.1.2 Setting R callbacks</a></td></tr>
<tr><td></td><td valign="top"><a href="#index-R_005frsort"><code>R_rsort</code></a></td><td valign="top"><a href="#Utility-functions">6.10 Utility functions</a></td></tr>
<tr><td></td><td valign="top"><a href="#index-R_005fsavehistory"><code>R_savehistory</code></a></td><td valign="top"><a href="#Setting-R-callbacks">8.1.2 Setting R callbacks</a></td></tr>
<tr><td></td><td valign="top"><a href="#index-R_005fselectlist"><code>R_selectlist</code></a></td><td valign="top"><a href="#Setting-R-callbacks">8.1.2 Setting R callbacks</a></td></tr>
<tr><td></td><td valign="top"><a href="#index-R_005fShowFiles"><code>R_ShowFiles</code></a></td><td valign="top"><a href="#Setting-R-callbacks">8.1.2 Setting R callbacks</a></td></tr>
<tr><td></td><td valign="top"><a href="#index-R_005fShowMessage"><code>R_ShowMessage</code></a></td><td valign="top"><a href="#Setting-R-callbacks">8.1.2 Setting R callbacks</a></td></tr>
<tr><td></td><td valign="top"><a href="#index-R_005fSrcref"><code>R_Srcref</code></a></td><td valign="top"><a href="#Accessing-source-references">5.12.1 Accessing source references</a></td></tr>
<tr><td></td><td valign="top"><a href="#index-R_005fSuicide"><code>R_Suicide</code></a></td><td valign="top"><a href="#Setting-R-callbacks">8.1.2 Setting R callbacks</a></td></tr>
<tr><td></td><td valign="top"><a href="#index-R_005ftmpnam"><code>R_tmpnam</code></a></td><td valign="top"><a href="#Utility-functions">6.10 Utility functions</a></td></tr>
<tr><td></td><td valign="top"><a href="#index-R_005ftmpnam2"><code>R_tmpnam2</code></a></td><td valign="top"><a href="#Utility-functions">6.10 Utility functions</a></td></tr>
<tr><td></td><td valign="top"><a href="#index-R_005fVersion"><code>R_Version</code></a></td><td valign="top"><a href="#Platform-and-version-information">6.13 Platform and version information</a></td></tr>
<tr><td></td><td valign="top"><a href="#index-R_005fWriteConsole"><code>R_WriteConsole</code></a></td><td valign="top"><a href="#Setting-R-callbacks">8.1.2 Setting R callbacks</a></td></tr>
<tr><td></td><td valign="top"><a href="#index-R_005fWriteConsoleEx"><code>R_WriteConsoleEx</code></a></td><td valign="top"><a href="#Setting-R-callbacks">8.1.2 Setting R callbacks</a></td></tr>
<tr><td colspan="3"> <hr></td></tr>
<tr><th><a name="Function-and-variable-index-1_vr_letter-S">S</a></th><td></td><td></td></tr>
<tr><td></td><td valign="top"><a href="#index-S3method"><code>S3method</code></a></td><td valign="top"><a href="#Registering-S3-methods">1.6.2 Registering S3 methods</a></td></tr>
<tr><td></td><td valign="top"><a href="#index-SAFE_005fFFLAGS"><code>SAFE_FFLAGS</code></a></td><td valign="top"><a href="#Using-Makevars">1.2.1 Using &lsquo;<tt>Makevars</tt>&rsquo;</a></td></tr>
<tr><td></td><td valign="top"><a href="#index-samin"><code>samin</code></a></td><td valign="top"><a href="#Optimization">6.8 Optimization</a></td></tr>
<tr><td></td><td valign="top"><a href="#index-seed_005fin"><code>seed_in</code></a></td><td valign="top"><a href="#Random-numbers">6.3 Random number generation</a></td></tr>
<tr><td></td><td valign="top"><a href="#index-seed_005fout"><code>seed_out</code></a></td><td valign="top"><a href="#Random-numbers">6.3 Random number generation</a></td></tr>
<tr><td></td><td valign="top"><a href="#index-setAttrib"><code>setAttrib</code></a></td><td valign="top"><a href="#Attributes">5.9.4 Attributes</a></td></tr>
<tr><td></td><td valign="top"><a href="#index-setVar"><code>setVar</code></a></td><td valign="top"><a href="#Finding-and-setting-variables">5.9.8 Finding and setting variables</a></td></tr>
<tr><td></td><td valign="top"><a href="#index-sign"><code>sign</code></a></td><td valign="top"><a href="#Numerical-Utilities">6.7.3 Numerical Utilities</a></td></tr>
<tr><td></td><td valign="top"><a href="#index-summaryRprof"><code>summaryRprof</code></a></td><td valign="top"><a href="#Memory-statistics-from-Rprof">3.3.1 Memory statistics from <code>Rprof</code></a></td></tr>
<tr><td></td><td valign="top"><a href="#index-system"><code>system</code></a></td><td valign="top"><a href="#Operating-system-access">5.1 Operating system access</a></td></tr>
<tr><td></td><td valign="top"><a href="#index-system_002etime"><code>system.time</code></a></td><td valign="top"><a href="#Operating-system-access">5.1 Operating system access</a></td></tr>
<tr><td></td><td valign="top"><a href="#index-system2"><code>system2</code></a></td><td valign="top"><a href="#Operating-system-access">5.1 Operating system access</a></td></tr>
<tr><td></td><td valign="top"><a href="#index-S_005falloc"><code>S_alloc</code></a></td><td valign="top"><a href="#Transient">6.1.1 Transient storage allocation</a></td></tr>
<tr><td></td><td valign="top"><a href="#index-S_005frealloc"><code>S_realloc</code></a></td><td valign="top"><a href="#Transient">6.1.1 Transient storage allocation</a></td></tr>
<tr><td colspan="3"> <hr></td></tr>
<tr><th><a name="Function-and-variable-index-1_vr_letter-T">T</a></th><td></td><td></td></tr>
<tr><td></td><td valign="top"><a href="#index-tetragamma"><code>tetragamma</code></a></td><td valign="top"><a href="#Mathematical-functions">6.7.2 Mathematical functions</a></td></tr>
<tr><td></td><td valign="top"><a href="#index-tetragamma-1"><code>tetragamma</code></a></td><td valign="top"><a href="#Mathematical-functions">6.7.2 Mathematical functions</a></td></tr>
<tr><td></td><td valign="top"><a href="#index-trace"><code>trace</code></a></td><td valign="top"><a href="#Debugging-R-code">4.2 Debugging R code</a></td></tr>
<tr><td></td><td valign="top"><a href="#index-traceback"><code>traceback</code></a></td><td valign="top"><a href="#Debugging-R-code">4.2 Debugging R code</a></td></tr>
<tr><td></td><td valign="top"><a href="#index-tracemem"><code>tracemem</code></a></td><td valign="top"><a href="#Tracing-copies-of-an-object">3.3.3 Tracing copies of an object</a></td></tr>
<tr><td></td><td valign="top"><a href="#index-translateChar"><code>translateChar</code></a></td><td valign="top"><a href="#Character-encoding-issues">5.15 Character encoding issues</a></td></tr>
<tr><td></td><td valign="top"><a href="#index-translateCharUTF8"><code>translateCharUTF8</code></a></td><td valign="top"><a href="#Character-encoding-issues">5.15 Character encoding issues</a></td></tr>
<tr><td></td><td valign="top"><a href="#index-trigamma"><code>trigamma</code></a></td><td valign="top"><a href="#Mathematical-functions">6.7.2 Mathematical functions</a></td></tr>
<tr><td></td><td valign="top"><a href="#index-trigamma-1"><code>trigamma</code></a></td><td valign="top"><a href="#Mathematical-functions">6.7.2 Mathematical functions</a></td></tr>
<tr><td></td><td valign="top"><a href="#index-TRUE"><code>TRUE</code></a></td><td valign="top"><a href="#Mathematical-constants">6.7.4 Mathematical constants</a></td></tr>
<tr><td colspan="3"> <hr></td></tr>
<tr><th><a name="Function-and-variable-index-1_vr_letter-U">U</a></th><td></td><td></td></tr>
<tr><td></td><td valign="top"><a href="#index-undebug"><code>undebug</code></a></td><td valign="top"><a href="#Debugging-R-code">4.2 Debugging R code</a></td></tr>
<tr><td></td><td valign="top"><a href="#index-unif_005frand"><code>unif_rand</code></a></td><td valign="top"><a href="#Random-numbers">6.3 Random number generation</a></td></tr>
<tr><td></td><td valign="top"><a href="#index-UNPROTECT"><code>UNPROTECT</code></a></td><td valign="top"><a href="#Garbage-Collection">5.9.1 Handling the effects of garbage collection</a></td></tr>
<tr><td></td><td valign="top"><a href="#index-UNPROTECT_005fPTR"><code>UNPROTECT_PTR</code></a></td><td valign="top"><a href="#Garbage-Collection">5.9.1 Handling the effects of garbage collection</a></td></tr>
<tr><td></td><td valign="top"><a href="#index-untracemem"><code>untracemem</code></a></td><td valign="top"><a href="#Tracing-copies-of-an-object">3.3.3 Tracing copies of an object</a></td></tr>
<tr><td></td><td valign="top"><a href="#index-useDynLib"><code>useDynLib</code></a></td><td valign="top"><a href="#useDynLib">1.6.4 useDynLib</a></td></tr>
<tr><td colspan="3"> <hr></td></tr>
<tr><th><a name="Function-and-variable-index-1_vr_letter-V">V</a></th><td></td><td></td></tr>
<tr><td></td><td valign="top"><a href="#index-vmaxget"><code>vmaxget</code></a></td><td valign="top"><a href="#Transient">6.1.1 Transient storage allocation</a></td></tr>
<tr><td></td><td valign="top"><a href="#index-vmaxset"><code>vmaxset</code></a></td><td valign="top"><a href="#Transient">6.1.1 Transient storage allocation</a></td></tr>
<tr><td></td><td valign="top"><a href="#index-vmmin"><code>vmmin</code></a></td><td valign="top"><a href="#Optimization">6.8 Optimization</a></td></tr>
<tr><td colspan="3"> <hr></td></tr>
</table>
<table><tr><th valign="top">Jump to: &nbsp; </th><td><a href="#Function-and-variable-index-1_vr_symbol-1" class="summary-letter"><b>*</b></a>
 &nbsp; 
<a href="#Function-and-variable-index-1_vr_symbol-2" class="summary-letter"><b>.</b></a>
 &nbsp; 
<a href="#Function-and-variable-index-1_vr_symbol-3" class="summary-letter"><b>\</b></a>
 &nbsp; 
<br>
<a href="#Function-and-variable-index-1_vr_letter-A" class="summary-letter"><b>A</b></a>
 &nbsp; 
<a href="#Function-and-variable-index-1_vr_letter-B" class="summary-letter"><b>B</b></a>
 &nbsp; 
<a href="#Function-and-variable-index-1_vr_letter-C" class="summary-letter"><b>C</b></a>
 &nbsp; 
<a href="#Function-and-variable-index-1_vr_letter-D" class="summary-letter"><b>D</b></a>
 &nbsp; 
<a href="#Function-and-variable-index-1_vr_letter-E" class="summary-letter"><b>E</b></a>
 &nbsp; 
<a href="#Function-and-variable-index-1_vr_letter-F" class="summary-letter"><b>F</b></a>
 &nbsp; 
<a href="#Function-and-variable-index-1_vr_letter-G" class="summary-letter"><b>G</b></a>
 &nbsp; 
<a href="#Function-and-variable-index-1_vr_letter-I" class="summary-letter"><b>I</b></a>
 &nbsp; 
<a href="#Function-and-variable-index-1_vr_letter-L" class="summary-letter"><b>L</b></a>
 &nbsp; 
<a href="#Function-and-variable-index-1_vr_letter-M" class="summary-letter"><b>M</b></a>
 &nbsp; 
<a href="#Function-and-variable-index-1_vr_letter-N" class="summary-letter"><b>N</b></a>
 &nbsp; 
<a href="#Function-and-variable-index-1_vr_letter-O" class="summary-letter"><b>O</b></a>
 &nbsp; 
<a href="#Function-and-variable-index-1_vr_letter-P" class="summary-letter"><b>P</b></a>
 &nbsp; 
<a href="#Function-and-variable-index-1_vr_letter-Q" class="summary-letter"><b>Q</b></a>
 &nbsp; 
<a href="#Function-and-variable-index-1_vr_letter-R" class="summary-letter"><b>R</b></a>
 &nbsp; 
<a href="#Function-and-variable-index-1_vr_letter-S" class="summary-letter"><b>S</b></a>
 &nbsp; 
<a href="#Function-and-variable-index-1_vr_letter-T" class="summary-letter"><b>T</b></a>
 &nbsp; 
<a href="#Function-and-variable-index-1_vr_letter-U" class="summary-letter"><b>U</b></a>
 &nbsp; 
<a href="#Function-and-variable-index-1_vr_letter-V" class="summary-letter"><b>V</b></a>
 &nbsp; 
</td></tr></table>

<hr size="6">
<a name="Concept-index"></a>
<table cellpadding="1" cellspacing="1" border="0">
<tr><td valign="middle" align="left">[<a href="#Function-and-variable-index" title="Previous section in reading order"> &lt; </a>]</td>
<td valign="middle" align="left">[ &gt; ]</td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left">[<a href="#Function-and-variable-index" title="Beginning of this chapter or previous chapter"> &lt;&lt; </a>]</td>
<td valign="middle" align="left">[<a href="#Top" title="Up section"> Up </a>]</td>
<td valign="middle" align="left">[ &gt;&gt; ]</td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left">[<a href="#Top" title="Cover (top) of document">Top</a>]</td>
<td valign="middle" align="left">[<a href="#SEC_Contents" title="Table of contents">Contents</a>]</td>
<td valign="middle" align="left">[<a href="#Function-and-variable-index" title="Index">Index</a>]</td>
<td valign="middle" align="left">[<a href="#SEC_About" title="About (help)"> ? </a>]</td>
</tr></table>
<a name="Concept-index-1"></a>
<h1 class="unnumbered">Concept index</h1>

<table><tr><th valign="top">Jump to: &nbsp; </th><td><a href="#Concept-index-1_cp_symbol-1" class="summary-letter"><b>.</b></a>
 &nbsp; 
<a href="#Concept-index-1_cp_symbol-2" class="summary-letter"><b>\</b></a>
 &nbsp; 
<br>
<a href="#Concept-index-1_cp_letter-A" class="summary-letter"><b>A</b></a>
 &nbsp; 
<a href="#Concept-index-1_cp_letter-B" class="summary-letter"><b>B</b></a>
 &nbsp; 
<a href="#Concept-index-1_cp_letter-C" class="summary-letter"><b>C</b></a>
 &nbsp; 
<a href="#Concept-index-1_cp_letter-D" class="summary-letter"><b>D</b></a>
 &nbsp; 
<a href="#Concept-index-1_cp_letter-E" class="summary-letter"><b>E</b></a>
 &nbsp; 
<a href="#Concept-index-1_cp_letter-F" class="summary-letter"><b>F</b></a>
 &nbsp; 
<a href="#Concept-index-1_cp_letter-G" class="summary-letter"><b>G</b></a>
 &nbsp; 
<a href="#Concept-index-1_cp_letter-H" class="summary-letter"><b>H</b></a>
 &nbsp; 
<a href="#Concept-index-1_cp_letter-I" class="summary-letter"><b>I</b></a>
 &nbsp; 
<a href="#Concept-index-1_cp_letter-L" class="summary-letter"><b>L</b></a>
 &nbsp; 
<a href="#Concept-index-1_cp_letter-M" class="summary-letter"><b>M</b></a>
 &nbsp; 
<a href="#Concept-index-1_cp_letter-N" class="summary-letter"><b>N</b></a>
 &nbsp; 
<a href="#Concept-index-1_cp_letter-O" class="summary-letter"><b>O</b></a>
 &nbsp; 
<a href="#Concept-index-1_cp_letter-P" class="summary-letter"><b>P</b></a>
 &nbsp; 
<a href="#Concept-index-1_cp_letter-R" class="summary-letter"><b>R</b></a>
 &nbsp; 
<a href="#Concept-index-1_cp_letter-S" class="summary-letter"><b>S</b></a>
 &nbsp; 
<a href="#Concept-index-1_cp_letter-T" class="summary-letter"><b>T</b></a>
 &nbsp; 
<a href="#Concept-index-1_cp_letter-U" class="summary-letter"><b>U</b></a>
 &nbsp; 
<a href="#Concept-index-1_cp_letter-V" class="summary-letter"><b>V</b></a>
 &nbsp; 
<a href="#Concept-index-1_cp_letter-W" class="summary-letter"><b>W</b></a>
 &nbsp; 
<a href="#Concept-index-1_cp_letter-Z" class="summary-letter"><b>Z</b></a>
 &nbsp; 
</td></tr></table>
<table border="0" class="index-cp">
<tr><td></td><th align="left">Index Entry</th><th align="left"> Section</th></tr>
<tr><td colspan="3"> <hr></td></tr>
<tr><th><a name="Concept-index-1_cp_symbol-1">.</a></th><td></td><td></td></tr>
<tr><td></td><td valign="top"><a href="#index-_002einstall_005fextras-file">.install_extras file</a></td><td valign="top"><a href="#Writing-package-vignettes">1.4 Writing package vignettes</a></td></tr>
<tr><td></td><td valign="top"><a href="#index-_002eRbuildignore-file">.Rbuildignore file</a></td><td valign="top"><a href="#Building-package-tarballs">1.3.2 Building package tarballs</a></td></tr>
<tr><td></td><td valign="top"><a href="#index-_002eRinstignore-file">.Rinstignore file</a></td><td valign="top"><a href="#Package-subdirectories">1.1.3 Package subdirectories</a></td></tr>
<tr><td colspan="3"> <hr></td></tr>
<tr><th><a name="Concept-index-1_cp_symbol-2">\</a></th><td></td><td></td></tr>
<tr><td></td><td valign="top"><a href="#index-_005clinkS4class">\linkS4class</a></td><td valign="top"><a href="#Cross_002dreferences">2.5 Cross-references</a></td></tr>
<tr><td colspan="3"> <hr></td></tr>
<tr><th><a name="Concept-index-1_cp_letter-A">A</a></th><td></td><td></td></tr>
<tr><td></td><td valign="top"><a href="#index-Allocating-storage">Allocating storage</a></td><td valign="top"><a href="#Allocating-storage">5.9.2 Allocating storage</a></td></tr>
<tr><td></td><td valign="top"><a href="#index-Attributes">Attributes</a></td><td valign="top"><a href="#Attributes">5.9.4 Attributes</a></td></tr>
<tr><td colspan="3"> <hr></td></tr>
<tr><th><a name="Concept-index-1_cp_letter-B">B</a></th><td></td><td></td></tr>
<tr><td></td><td valign="top"><a href="#index-Bessel-functions">Bessel functions</a></td><td valign="top"><a href="#Mathematical-functions">6.7.2 Mathematical functions</a></td></tr>
<tr><td></td><td valign="top"><a href="#index-Beta-function">Beta function</a></td><td valign="top"><a href="#Mathematical-functions">6.7.2 Mathematical functions</a></td></tr>
<tr><td></td><td valign="top"><a href="#index-Building-binary-packages">Building binary packages</a></td><td valign="top"><a href="#Building-binary-packages">1.3.3 Building binary packages</a></td></tr>
<tr><td></td><td valign="top"><a href="#index-Building-source-packages">Building source packages</a></td><td valign="top"><a href="#Building-package-tarballs">1.3.2 Building package tarballs</a></td></tr>
<tr><td colspan="3"> <hr></td></tr>
<tr><th><a name="Concept-index-1_cp_letter-C">C</a></th><td></td><td></td></tr>
<tr><td></td><td valign="top"><a href="#index-C_002b_002b-code_002c-interfacing">C++ code, interfacing</a></td><td valign="top"><a href="#Interfacing-C_002b_002b-code">5.6 Interfacing C++ code</a></td></tr>
<tr><td></td><td valign="top"><a href="#index-Calling-C-from-FORTRAN-and-vice-versa">Calling C from FORTRAN and vice versa</a></td><td valign="top"><a href="#Calling-C-from-FORTRAN-and-vice-versa">6.6 Calling C from FORTRAN and vice versa</a></td></tr>
<tr><td></td><td valign="top"><a href="#index-Checking-packages">Checking packages</a></td><td valign="top"><a href="#Checking-packages">1.3.1 Checking packages</a></td></tr>
<tr><td></td><td valign="top"><a href="#index-citation">citation</a></td><td valign="top"><a href="#Package-subdirectories">1.1.3 Package subdirectories</a></td></tr>
<tr><td></td><td valign="top"><a href="#index-citation-1">citation</a></td><td valign="top"><a href="#Supporting-R-function">1.9.4 Supporting R function</a></td></tr>
<tr><td></td><td valign="top"><a href="#index-Classes">Classes</a></td><td valign="top"><a href="#Classes">5.9.5 Classes</a></td></tr>
<tr><td></td><td valign="top"><a href="#index-cleanup-file">cleanup file</a></td><td valign="top"><a href="#Package-structure">1.1 Package structure</a></td></tr>
<tr><td></td><td valign="top"><a href="#index-conditionals">conditionals</a></td><td valign="top"><a href="#Conditional-text">2.11 Conditional text</a></td></tr>
<tr><td></td><td valign="top"><a href="#index-configure-file">configure file</a></td><td valign="top"><a href="#Package-structure">1.1 Package structure</a></td></tr>
<tr><td></td><td valign="top"><a href="#index-Copying-objects">Copying objects</a></td><td valign="top"><a href="#Named-objects-and-copying">5.9.10 Named objects and copying</a></td></tr>
<tr><td></td><td valign="top"><a href="#index-CRAN">CRAN</a></td><td valign="top"><a href="#Submitting-a-package-to-CRAN">1.5 Submitting a package to <acronym>CRAN</acronym></a></td></tr>
<tr><td></td><td valign="top"><a href="#index-CRAN-submission">CRAN submission</a></td><td valign="top"><a href="#Submitting-a-package-to-CRAN">1.5 Submitting a package to <acronym>CRAN</acronym></a></td></tr>
<tr><td></td><td valign="top"><a href="#index-Creating-packages">Creating packages</a></td><td valign="top"><a href="#Creating-R-packages">1. Creating R packages</a></td></tr>
<tr><td></td><td valign="top"><a href="#index-Creating-shared-objects">Creating shared objects</a></td><td valign="top"><a href="#Creating-shared-objects">5.5 Creating shared objects</a></td></tr>
<tr><td></td><td valign="top"><a href="#index-Cross_002dreferences-in-documentation">Cross-references in documentation</a></td><td valign="top"><a href="#Cross_002dreferences">2.5 Cross-references</a></td></tr>
<tr><td></td><td valign="top"><a href="#index-cumulative-hazard">cumulative hazard</a></td><td valign="top"><a href="#Distribution-functions">6.7.1 Distribution functions</a></td></tr>
<tr><td colspan="3"> <hr></td></tr>
<tr><th><a name="Concept-index-1_cp_letter-D">D</a></th><td></td><td></td></tr>
<tr><td></td><td valign="top"><a href="#index-Debugging">Debugging</a></td><td valign="top"><a href="#Debugging-compiled-code">4.4 Debugging compiled code</a></td></tr>
<tr><td></td><td valign="top"><a href="#index-DESCRIPTION-file">DESCRIPTION file</a></td><td valign="top"><a href="#The-DESCRIPTION-file">1.1.1 The &lsquo;<tt>DESCRIPTION</tt>&rsquo; file</a></td></tr>
<tr><td></td><td valign="top"><a href="#index-Details-of-R-types">Details of R types</a></td><td valign="top"><a href="#Details-of-R-types">5.9.3 Details of R types</a></td></tr>
<tr><td></td><td valign="top"><a href="#index-Distribution-functions-from-C">Distribution functions from C</a></td><td valign="top"><a href="#Distribution-functions">6.7.1 Distribution functions</a></td></tr>
<tr><td></td><td valign="top"><a href="#index-Documentation_002c-writing">Documentation, writing</a></td><td valign="top"><a href="#Writing-R-documentation-files">2. Writing R documentation files</a></td></tr>
<tr><td></td><td valign="top"><a href="#index-Dynamic-loading">Dynamic loading</a></td><td valign="top"><a href="#dyn_002eload-and-dyn_002eunload">5.3 <code>dyn.load</code> and <code>dyn.unload</code></a></td></tr>
<tr><td></td><td valign="top"><a href="#index-dynamic-pages">dynamic pages</a></td><td valign="top"><a href="#Dynamic-pages">2.12 Dynamic pages</a></td></tr>
<tr><td colspan="3"> <hr></td></tr>
<tr><th><a name="Concept-index-1_cp_letter-E">E</a></th><td></td><td></td></tr>
<tr><td></td><td valign="top"><a href="#index-Editing-Rd-files">Editing Rd files</a></td><td valign="top"><a href="#Editing-Rd-files">2.16 Editing Rd files</a></td></tr>
<tr><td></td><td valign="top"><a href="#index-encoding">encoding</a></td><td valign="top"><a href="#Encoding">2.14 Encoding</a></td></tr>
<tr><td></td><td valign="top"><a href="#index-Error-handling-from-C">Error handling from C</a></td><td valign="top"><a href="#Error-handling">6.2 Error handling</a></td></tr>
<tr><td></td><td valign="top"><a href="#index-Error-handling-from-FORTRAN">Error handling from FORTRAN</a></td><td valign="top"><a href="#Error-handling-from-FORTRAN">6.2.1 Error handling from FORTRAN</a></td></tr>
<tr><td></td><td valign="top"><a href="#index-Evaluating-R-expressions-from-C">Evaluating R expressions from C</a></td><td valign="top"><a href="#Evaluating-R-expressions-from-C">5.11 Evaluating R expressions from C</a></td></tr>
<tr><td></td><td valign="top"><a href="#index-external-pointer">external pointer</a></td><td valign="top"><a href="#External-pointers-and-weak-references">5.13 External pointers and weak references</a></td></tr>
<tr><td colspan="3"> <hr></td></tr>
<tr><th><a name="Concept-index-1_cp_letter-F">F</a></th><td></td><td></td></tr>
<tr><td></td><td valign="top"><a href="#index-Figures-in-documentation">Figures in documentation</a></td><td valign="top"><a href="#Figures">2.7 Figures</a></td></tr>
<tr><td></td><td valign="top"><a href="#index-finalizer">finalizer</a></td><td valign="top"><a href="#External-pointers-and-weak-references">5.13 External pointers and weak references</a></td></tr>
<tr><td></td><td valign="top"><a href="#index-Finding-variables">Finding variables</a></td><td valign="top"><a href="#Finding-and-setting-variables">5.9.8 Finding and setting variables</a></td></tr>
<tr><td colspan="3"> <hr></td></tr>
<tr><th><a name="Concept-index-1_cp_letter-G">G</a></th><td></td><td></td></tr>
<tr><td></td><td valign="top"><a href="#index-Gamma-function">Gamma function</a></td><td valign="top"><a href="#Mathematical-functions">6.7.2 Mathematical functions</a></td></tr>
<tr><td></td><td valign="top"><a href="#index-Garbage-collection">Garbage collection</a></td><td valign="top"><a href="#Garbage-Collection">5.9.1 Handling the effects of garbage collection</a></td></tr>
<tr><td></td><td valign="top"><a href="#index-Generic-functions">Generic functions</a></td><td valign="top"><a href="#Generic-functions-and-methods">7. Generic functions and methods</a></td></tr>
<tr><td colspan="3"> <hr></td></tr>
<tr><th><a name="Concept-index-1_cp_letter-H">H</a></th><td></td><td></td></tr>
<tr><td></td><td valign="top"><a href="#index-handling-character-data">handling character data</a></td><td valign="top"><a href="#Handling-character-data">5.9.7 Handling character data</a></td></tr>
<tr><td></td><td valign="top"><a href="#index-Handling-lists">Handling lists</a></td><td valign="top"><a href="#Handling-lists">5.9.6 Handling lists</a></td></tr>
<tr><td></td><td valign="top"><a href="#index-Handling-R-objects-in-C">Handling R objects in C</a></td><td valign="top"><a href="#Handling-R-objects-in-C">5.9 Handling R objects in C</a></td></tr>
<tr><td colspan="3"> <hr></td></tr>
<tr><th><a name="Concept-index-1_cp_letter-I">I</a></th><td></td><td></td></tr>
<tr><td></td><td valign="top"><a href="#index-IEEE-special-values">IEEE special values</a></td><td valign="top"><a href="#Missing-and-special-values">5.10.3 Missing and special values</a></td></tr>
<tr><td></td><td valign="top"><a href="#index-IEEE-special-values-1">IEEE special values</a></td><td valign="top"><a href="#Missing-and-IEEE-values">6.4 Missing and <acronym>IEEE</acronym> special values</a></td></tr>
<tr><td></td><td valign="top"><a href="#index-INDEX-file">INDEX file</a></td><td valign="top"><a href="#The-INDEX-file">1.1.2 The &lsquo;<tt>INDEX</tt>&rsquo; file</a></td></tr>
<tr><td></td><td valign="top"><a href="#index-Indices">Indices</a></td><td valign="top"><a href="#Indices">2.9 Indices</a></td></tr>
<tr><td></td><td valign="top"><a href="#index-Inspecting-R-objects-when-debugging">Inspecting R objects when debugging</a></td><td valign="top"><a href="#Inspecting-R-objects">4.4.2 Inspecting R objects when debugging</a></td></tr>
<tr><td></td><td valign="top"><a href="#index-integration">integration</a></td><td valign="top"><a href="#Integration">6.9 Integration</a></td></tr>
<tr><td></td><td valign="top"><a href="#index-Interfaces-to-compiled-code">Interfaces to compiled code</a></td><td valign="top"><a href="#Interface-functions-_002eC-and-_002eFortran">5.2 Interface functions <code>.C</code> and <code>.Fortran</code></a></td></tr>
<tr><td></td><td valign="top"><a href="#index-Interfaces-to-compiled-code-1">Interfaces to compiled code</a></td><td valign="top"><a href="#Interface-functions-_002eCall-and-_002eExternal">5.10 Interface functions <code>.Call</code> and <code>.External</code></a></td></tr>
<tr><td></td><td valign="top"><a href="#index-Interfacing-C_002b_002b-code">Interfacing C++ code</a></td><td valign="top"><a href="#Interfacing-C_002b_002b-code">5.6 Interfacing C++ code</a></td></tr>
<tr><td></td><td valign="top"><a href="#index-Interrupts">Interrupts</a></td><td valign="top"><a href="#Allowing-interrupts">6.12 Allowing interrupts</a></td></tr>
<tr><td colspan="3"> <hr></td></tr>
<tr><th><a name="Concept-index-1_cp_letter-L">L</a></th><td></td><td></td></tr>
<tr><td></td><td valign="top"><a href="#index-LICENCE-file">LICENCE file</a></td><td valign="top"><a href="#Package-structure">1.1 Package structure</a></td></tr>
<tr><td></td><td valign="top"><a href="#index-LICENSE-file">LICENSE file</a></td><td valign="top"><a href="#Package-structure">1.1 Package structure</a></td></tr>
<tr><td></td><td valign="top"><a href="#index-Lists-and-tables-in-documentation">Lists and tables in documentation</a></td><td valign="top"><a href="#Lists-and-tables">2.4 Lists and tables</a></td></tr>
<tr><td colspan="3"> <hr></td></tr>
<tr><th><a name="Concept-index-1_cp_letter-M">M</a></th><td></td><td></td></tr>
<tr><td></td><td valign="top"><a href="#index-Marking-text-in-documentation">Marking text in documentation</a></td><td valign="top"><a href="#Marking-text">2.3 Marking text</a></td></tr>
<tr><td></td><td valign="top"><a href="#index-Mathematics-in-documentation">Mathematics in documentation</a></td><td valign="top"><a href="#Mathematics">2.6 Mathematics</a></td></tr>
<tr><td></td><td valign="top"><a href="#index-Memory-allocation-from-C">Memory allocation from C</a></td><td valign="top"><a href="#Memory-allocation">6.1 Memory allocation</a></td></tr>
<tr><td></td><td valign="top"><a href="#index-Memory-use">Memory use</a></td><td valign="top"><a href="#Profiling-R-code-for-memory-use">3.3 Profiling R code for memory use</a></td></tr>
<tr><td></td><td valign="top"><a href="#index-Method-functions">Method functions</a></td><td valign="top"><a href="#Generic-functions-and-methods">7. Generic functions and methods</a></td></tr>
<tr><td></td><td valign="top"><a href="#index-Missing-values">Missing values</a></td><td valign="top"><a href="#Missing-and-special-values">5.10.3 Missing and special values</a></td></tr>
<tr><td></td><td valign="top"><a href="#index-Missing-values-1">Missing values</a></td><td valign="top"><a href="#Missing-and-IEEE-values">6.4 Missing and <acronym>IEEE</acronym> special values</a></td></tr>
<tr><td colspan="3"> <hr></td></tr>
<tr><th><a name="Concept-index-1_cp_letter-N">N</a></th><td></td><td></td></tr>
<tr><td></td><td valign="top"><a href="#index-namespaces">namespaces</a></td><td valign="top"><a href="#Package-namespaces">1.6 Package namespaces</a></td></tr>
<tr><td></td><td valign="top"><a href="#index-Numerical-analysis-subroutines-from-C">Numerical analysis subroutines from C</a></td><td valign="top"><a href="#Numerical-analysis-subroutines">6.7 Numerical analysis subroutines</a></td></tr>
<tr><td></td><td valign="top"><a href="#index-Numerical-derivatives">Numerical derivatives</a></td><td valign="top"><a href="#Calculating-numerical-derivatives">5.11.2 Calculating numerical derivatives</a></td></tr>
<tr><td colspan="3"> <hr></td></tr>
<tr><th><a name="Concept-index-1_cp_letter-O">O</a></th><td></td><td></td></tr>
<tr><td></td><td valign="top"><a href="#index-OpenMP">OpenMP</a></td><td valign="top"><a href="#OpenMP-support">1.2.1.1 OpenMP support</a></td></tr>
<tr><td></td><td valign="top"><a href="#index-OpenMP-1">OpenMP</a></td><td valign="top"><a href="#Platform-and-version-information">6.13 Platform and version information</a></td></tr>
<tr><td></td><td valign="top"><a href="#index-Operating-system-access">Operating system access</a></td><td valign="top"><a href="#Operating-system-access">5.1 Operating system access</a></td></tr>
<tr><td></td><td valign="top"><a href="#index-optimization">optimization</a></td><td valign="top"><a href="#Optimization">6.8 Optimization</a></td></tr>
<tr><td colspan="3"> <hr></td></tr>
<tr><th><a name="Concept-index-1_cp_letter-P">P</a></th><td></td><td></td></tr>
<tr><td></td><td valign="top"><a href="#index-Package-builder">Package builder</a></td><td valign="top"><a href="#Building-package-tarballs">1.3.2 Building package tarballs</a></td></tr>
<tr><td></td><td valign="top"><a href="#index-Package-bundles">Package bundles</a></td><td valign="top"><a href="#Package-bundles">1.1.4 Package bundles</a></td></tr>
<tr><td></td><td valign="top"><a href="#index-Package-structure">Package structure</a></td><td valign="top"><a href="#Package-structure">1.1 Package structure</a></td></tr>
<tr><td></td><td valign="top"><a href="#index-Package-subdirectories">Package subdirectories</a></td><td valign="top"><a href="#Package-subdirectories">1.1.3 Package subdirectories</a></td></tr>
<tr><td></td><td valign="top"><a href="#index-Packages">Packages</a></td><td valign="top"><a href="#Creating-R-packages">1. Creating R packages</a></td></tr>
<tr><td></td><td valign="top"><a href="#index-Parsing-R-code-from-C">Parsing R code from C</a></td><td valign="top"><a href="#Parsing-R-code-from-C">5.12 Parsing R code from C</a></td></tr>
<tr><td></td><td valign="top"><a href="#index-Platform_002dspecific-documentation">Platform-specific documentation</a></td><td valign="top"><a href="#Platform_002dspecific-sections">2.10 Platform-specific documentation</a></td></tr>
<tr><td></td><td valign="top"><a href="#index-Printing-from-C">Printing from C</a></td><td valign="top"><a href="#Printing">6.5 Printing</a></td></tr>
<tr><td></td><td valign="top"><a href="#index-Printing-from-FORTRAN">Printing from FORTRAN</a></td><td valign="top"><a href="#Printing-from-FORTRAN">6.5.1 Printing from FORTRAN</a></td></tr>
<tr><td></td><td valign="top"><a href="#index-Processing-Rd-format">Processing Rd format</a></td><td valign="top"><a href="#Processing-Rd-format">2.15 Processing Rd format</a></td></tr>
<tr><td></td><td valign="top"><a href="#index-Profiling">Profiling</a></td><td valign="top"><a href="#Profiling-R-code-for-speed">3.2 Profiling R code for speed</a></td></tr>
<tr><td></td><td valign="top"><a href="#index-Profiling-1">Profiling</a></td><td valign="top"><a href="#Profiling-R-code-for-memory-use">3.3 Profiling R code for memory use</a></td></tr>
<tr><td></td><td valign="top"><a href="#index-Profiling-2">Profiling</a></td><td valign="top"><a href="#Profiling-compiled-code">3.4 Profiling compiled code</a></td></tr>
<tr><td colspan="3"> <hr></td></tr>
<tr><th><a name="Concept-index-1_cp_letter-R">R</a></th><td></td><td></td></tr>
<tr><td></td><td valign="top"><a href="#index-Random-numbers-in-C">Random numbers in C</a></td><td valign="top"><a href="#Random-numbers">6.3 Random number generation</a></td></tr>
<tr><td></td><td valign="top"><a href="#index-Random-numbers-in-C-1">Random numbers in C</a></td><td valign="top"><a href="#Distribution-functions">6.7.1 Distribution functions</a></td></tr>
<tr><td></td><td valign="top"><a href="#index-Random-numbers-in-FORTRAN">Random numbers in FORTRAN</a></td><td valign="top"><a href="#Calling-C-from-FORTRAN-and-vice-versa">6.6 Calling C from FORTRAN and vice versa</a></td></tr>
<tr><td></td><td valign="top"><a href="#index-Registering-native-routines">Registering native routines</a></td><td valign="top"><a href="#Registering-native-routines">5.4 Registering native routines</a></td></tr>
<tr><td colspan="3"> <hr></td></tr>
<tr><th><a name="Concept-index-1_cp_letter-S">S</a></th><td></td><td></td></tr>
<tr><td></td><td valign="top"><a href="#index-Setting-variables">Setting variables</a></td><td valign="top"><a href="#Finding-and-setting-variables">5.9.8 Finding and setting variables</a></td></tr>
<tr><td></td><td valign="top"><a href="#index-Sort-functions-from-C">Sort functions from C</a></td><td valign="top"><a href="#Utility-functions">6.10 Utility functions</a></td></tr>
<tr><td></td><td valign="top"><a href="#index-Submitting-to-CRAN">Submitting to CRAN</a></td><td valign="top"><a href="#Submitting-a-package-to-CRAN">1.5 Submitting a package to <acronym>CRAN</acronym></a></td></tr>
<tr><td></td><td valign="top"><a href="#index-Sweave">Sweave</a></td><td valign="top"><a href="#Writing-package-vignettes">1.4 Writing package vignettes</a></td></tr>
<tr><td colspan="3"> <hr></td></tr>
<tr><th><a name="Concept-index-1_cp_letter-T">T</a></th><td></td><td></td></tr>
<tr><td></td><td valign="top"><a href="#index-tarballs">tarballs</a></td><td valign="top"><a href="#Building-package-tarballs">1.3.2 Building package tarballs</a></td></tr>
<tr><td></td><td valign="top"><a href="#index-Tidying-R-code">Tidying R code</a></td><td valign="top"><a href="#Tidying-R-code">3.1 Tidying R code</a></td></tr>
<tr><td colspan="3"> <hr></td></tr>
<tr><th><a name="Concept-index-1_cp_letter-U">U</a></th><td></td><td></td></tr>
<tr><td></td><td valign="top"><a href="#index-user_002ddefined-macros">user-defined macros</a></td><td valign="top"><a href="#User_002ddefined-macros">2.13 User-defined macros</a></td></tr>
<tr><td colspan="3"> <hr></td></tr>
<tr><th><a name="Concept-index-1_cp_letter-V">V</a></th><td></td><td></td></tr>
<tr><td></td><td valign="top"><a href="#index-Version-information-from-C">Version information from C</a></td><td valign="top"><a href="#Platform-and-version-information">6.13 Platform and version information</a></td></tr>
<tr><td></td><td valign="top"><a href="#index-vignettes">vignettes</a></td><td valign="top"><a href="#Writing-package-vignettes">1.4 Writing package vignettes</a></td></tr>
<tr><td></td><td valign="top"><a href="#index-Visibility">Visibility</a></td><td valign="top"><a href="#Controlling-visibility">6.15 Controlling visibility</a></td></tr>
<tr><td colspan="3"> <hr></td></tr>
<tr><th><a name="Concept-index-1_cp_letter-W">W</a></th><td></td><td></td></tr>
<tr><td></td><td valign="top"><a href="#index-weak-reference">weak reference</a></td><td valign="top"><a href="#External-pointers-and-weak-references">5.13 External pointers and weak references</a></td></tr>
<tr><td colspan="3"> <hr></td></tr>
<tr><th><a name="Concept-index-1_cp_letter-Z">Z</a></th><td></td><td></td></tr>
<tr><td></td><td valign="top"><a href="#index-Zero_002dfinding">Zero-finding</a></td><td valign="top"><a href="#Zero_002dfinding">5.11.1 Zero-finding</a></td></tr>
<tr><td colspan="3"> <hr></td></tr>
</table>
<table><tr><th valign="top">Jump to: &nbsp; </th><td><a href="#Concept-index-1_cp_symbol-1" class="summary-letter"><b>.</b></a>
 &nbsp; 
<a href="#Concept-index-1_cp_symbol-2" class="summary-letter"><b>\</b></a>
 &nbsp; 
<br>
<a href="#Concept-index-1_cp_letter-A" class="summary-letter"><b>A</b></a>
 &nbsp; 
<a href="#Concept-index-1_cp_letter-B" class="summary-letter"><b>B</b></a>
 &nbsp; 
<a href="#Concept-index-1_cp_letter-C" class="summary-letter"><b>C</b></a>
 &nbsp; 
<a href="#Concept-index-1_cp_letter-D" class="summary-letter"><b>D</b></a>
 &nbsp; 
<a href="#Concept-index-1_cp_letter-E" class="summary-letter"><b>E</b></a>
 &nbsp; 
<a href="#Concept-index-1_cp_letter-F" class="summary-letter"><b>F</b></a>
 &nbsp; 
<a href="#Concept-index-1_cp_letter-G" class="summary-letter"><b>G</b></a>
 &nbsp; 
<a href="#Concept-index-1_cp_letter-H" class="summary-letter"><b>H</b></a>
 &nbsp; 
<a href="#Concept-index-1_cp_letter-I" class="summary-letter"><b>I</b></a>
 &nbsp; 
<a href="#Concept-index-1_cp_letter-L" class="summary-letter"><b>L</b></a>
 &nbsp; 
<a href="#Concept-index-1_cp_letter-M" class="summary-letter"><b>M</b></a>
 &nbsp; 
<a href="#Concept-index-1_cp_letter-N" class="summary-letter"><b>N</b></a>
 &nbsp; 
<a href="#Concept-index-1_cp_letter-O" class="summary-letter"><b>O</b></a>
 &nbsp; 
<a href="#Concept-index-1_cp_letter-P" class="summary-letter"><b>P</b></a>
 &nbsp; 
<a href="#Concept-index-1_cp_letter-R" class="summary-letter"><b>R</b></a>
 &nbsp; 
<a href="#Concept-index-1_cp_letter-S" class="summary-letter"><b>S</b></a>
 &nbsp; 
<a href="#Concept-index-1_cp_letter-T" class="summary-letter"><b>T</b></a>
 &nbsp; 
<a href="#Concept-index-1_cp_letter-U" class="summary-letter"><b>U</b></a>
 &nbsp; 
<a href="#Concept-index-1_cp_letter-V" class="summary-letter"><b>V</b></a>
 &nbsp; 
<a href="#Concept-index-1_cp_letter-W" class="summary-letter"><b>W</b></a>
 &nbsp; 
<a href="#Concept-index-1_cp_letter-Z" class="summary-letter"><b>Z</b></a>
 &nbsp; 
</td></tr></table>

<hr size="6">
<a name="SEC_Foot"></a>
<table cellpadding="1" cellspacing="1" border="0">
<tr><td valign="middle" align="left">[<a href="#Top" title="Cover (top) of document">Top</a>]</td>
<td valign="middle" align="left">[<a href="#SEC_Contents" title="Table of contents">Contents</a>]</td>
<td valign="middle" align="left">[<a href="#Function-and-variable-index" title="Index">Index</a>]</td>
<td valign="middle" align="left">[<a href="#SEC_About" title="About (help)"> ? </a>]</td>
</tr></table>
<h1>Footnotes</h1>
<h3><a name="FOOT1" href="#DOCF1">(1)</a></h3>
<p>although this is common mis-usage.
It seems to stem from S, whose analogues of R&rsquo;s packages were
officially known as <em>library sections</em> and later as
<em>chapters</em>, but almost always referred to as <em>libraries</em>.
</p><h3><a name="FOOT2" href="#DOCF2">(2)</a></h3>
<p>currently, top-level files
&lsquo;<tt>.Rbuildignore</tt>&rsquo; and &lsquo;<tt>.Rinstignore</tt>&rsquo;, and
&lsquo;<tt>vignettes/.install_extras</tt>&rsquo;.
</p><h3><a name="FOOT3" href="#DOCF3">(3)</a></h3>
<p>false positives are possible, but only a handful have been
seen so far.
</p><h3><a name="FOOT4" href="#DOCF4">(4)</a></h3>
<p>at least if this
is done in a locale which matches the package encoding.
</p><h3><a name="FOOT5" href="#DOCF5">(5)</a></h3>
<p>installation generates an ASCII version in R
2.x.y.
</p><h3><a name="FOOT6" href="#DOCF6">(6)</a></h3>
<p>This includes all packages
directly called by <code>library</code> and <code>require</code> calls, as well as
data obtained <em>via</em> <code>data(theirdata, package = &quot;somepkg&quot;)</code>
calls: <code>R CMD check</code> will warn about all of these.  But there
are subtler uses which it will not detect: e.g. if package A uses
package B and makes use of functionality in package B which uses package
C which package B suggests or enhances, then package C needs to be in
the &lsquo;<samp>Suggests</samp>&rsquo; list for package A.  Nor will undeclared uses in
included files be reported, nor unconditional uses of packages listed
under &lsquo;<samp>Enhances</samp>&rsquo;.
</p><h3><a name="FOOT7" href="#DOCF7">(7)</a></h3>
<p>Extensions
&lsquo;<tt>.S</tt>&rsquo; and &lsquo;<tt>.s</tt>&rsquo; arise from code originally written for S(-PLUS),
but are commonly used for assembler code.  Extension &lsquo;<tt>.q</tt>&rsquo; was used
for S, which at one time was tentatively called QPE.
</p><h3><a name="FOOT8" href="#DOCF8">(8)</a></h3>
<p>This is true for OSes which implement the
&lsquo;<samp>C</samp>&rsquo; locale: Windows&rsquo; idea of the &lsquo;<samp>C</samp>&rsquo; locale uses the WinAnsi
charset.
</p><h3><a name="FOOT9" href="#DOCF9">(9)</a></h3>
<p>the package needs to depend on <code>R (&gt;= 2.10)</code>
</p><h3><a name="FOOT10" href="#DOCF10">(10)</a></h3>
<p>More precisely, they can
contain the English alphanumeric characters and the symbols &lsquo;<samp>$ - _
. + ! ' ( ) , ; &nbsp;= &amp;</samp>&rsquo;.
</p><h3><a name="FOOT11" href="#DOCF11">(11)</a></h3>
<p>Note that Ratfor is not supported.
If you have Ratfor source code, you need to convert it to FORTRAN.  Only
FORTRAN 77 (which we write in upper case) is supported on all platforms,
but most also support Fortran-95 (for which we use title case).  If you
want to ship Ratfor source files, please do so in a subdirectory of
&lsquo;<tt>src</tt>&rsquo; and not in the main subdirectory.
</p><h3><a name="FOOT12" href="#DOCF12">(12)</a></h3>
<p>either or both of which may not be supported on particular
platforms
</p><h3><a name="FOOT13" href="#DOCF13">(13)</a></h3>
<p>Using &lsquo;<tt>.hpp</tt>&rsquo;, although somewhat
popular, is not guaranteed to be portable.
</p><h3><a name="FOOT14" href="#DOCF14">(14)</a></h3>
<p>Currently also &lsquo;<samp>__APPLE_CC__</samp>&rsquo;, but that indicates
a compiler with Apple-specific features, not the OS.
</p><h3><a name="FOOT15" href="#DOCF15">(15)</a></h3>
<p>the POSIX
terminology, called &lsquo;make variables&rsquo; by GNU make.
</p><h3><a name="FOOT16" href="#DOCF16">(16)</a></h3>
<p>case-insensitively on Windows.
</p><h3><a name="FOOT17" href="#DOCF17">(17)</a></h3>
<p>The best way to generate such a
file is to copy the &lsquo;<tt>.Rout</tt>&rsquo; from a successful run of <code>R CMD
check</code>.  If you want to generate it separately, do run R with options
&lsquo;<samp>--vanilla --slave</samp>&rsquo; and with environment variable
<code>LANGUAGE=en</code> set to get messages in English.
</p><h3><a name="FOOT18" href="#DOCF18">(18)</a></h3>
<p>e.g
<a href="http://tools.ietf.org/html/rfc4180">http://tools.ietf.org/html/rfc4180</a>.
</p><h3><a name="FOOT19" href="#DOCF19">(19)</a></h3>
<p>in POSIX parlance: GNU <code>make</code>
calls these &lsquo;make variables&rsquo;.
</p><h3><a name="FOOT20" href="#DOCF20">(20)</a></h3>
<p>at least on Unix-alikes: the Windows build currently
resolves such dependencies to a static FORTRAN library when
&lsquo;<tt>Rblas.dll</tt>&rsquo; is built.
</p><h3><a name="FOOT21" href="#DOCF21">(21)</a></h3>
<p><a href="http://www.openmp.org/">http://www.openmp.org/</a>,
<a href="http://en.wikipedia.org/wiki/OpenMP">http://en.wikipedia.org/wiki/OpenMP</a>,
<a href="https://computing.llnl.gov/tutorials/openMP/">https://computing.llnl.gov/tutorials/openMP/</a>
</p><h3><a name="FOOT22" href="#DOCF22">(22)</a></h3>
<p>But OpenMP support is not available
with the default toolchain used prior to R 2.14.2 on Windows.
</p><h3><a name="FOOT23" href="#DOCF23">(23)</a></h3>
<p>some Windows toolchains have the
typo &lsquo;<samp>_REENTRANCE</samp>&rsquo; instead.
</p><h3><a name="FOOT24" href="#DOCF24">(24)</a></h3>
<p>Cygwin used <code>g77</code> up to 2011, and some pre-built
versions of R for Unix OSes still do.
</p><h3><a name="FOOT25" href="#DOCF25">(25)</a></h3>
<p>On systems which use sub-architectures,
architecture-specific versions such as &lsquo;<tt>~/.R/check.Renviron.i386</tt>&rsquo;
take precedence.
</p><h3><a name="FOOT26" href="#DOCF26">(26)</a></h3>
<p>A suitable <code>file.exe</code> is
part of the Windows toolset.
</p><h3><a name="FOOT27" href="#DOCF27">(27)</a></h3>
<p>An exception is made
for subdirectories stating &lsquo;<samp>win</samp>&rsquo; or &lsquo;<samp>Win</samp>&rsquo;.
</p><h3><a name="FOOT28" href="#DOCF28">(28)</a></h3>
<p>on most other platforms such runtime
libraries are dynamic, but static libraries are currently used on
Windows because the toolchain is not a standard part of the OS.
</p><h3><a name="FOOT29" href="#DOCF29">(29)</a></h3>
<p>or if option &lsquo;<samp>--use-valgrind</samp>&rsquo; is
used or environment variable <code>_R_CHECK_ALWAYS_LOG_VIGNETTE_OUTPUT_</code>
is set to a true value or if there are differences from a target output
file
</p><h3><a name="FOOT30" href="#DOCF30">(30)</a></h3>
<p>Windows users behind proxies may
want to set environment variable <code>R_WIN_INTERNET2</code> to a non-empty
value, e.g. in &lsquo;<tt>~/.R/check_environ</tt>&rsquo;.  Some Windows users may need
to set <code>R_WIN_NO_JUNCTIONS</code> to a non-empty value.
</p><h3><a name="FOOT31" href="#DOCF31">(31)</a></h3>
<p>loading, examples,
tests, vignettes
</p><h3><a name="FOOT32" href="#DOCF32">(32)</a></h3>
<p>case-insensitively on Windows.
</p><h3><a name="FOOT33" href="#DOCF33">(33)</a></h3>
<p>called &lsquo;<tt>CVS</tt>&rsquo; or &lsquo;<tt>.svn</tt>&rsquo; or &lsquo;<tt>.arch-ids</tt>&rsquo; or
&lsquo;<tt>.bzr</tt>&rsquo; or &lsquo;<tt>.git</tt>&rsquo; (but not files called &lsquo;<tt>.git</tt>&rsquo;) or
&lsquo;<tt>.hg</tt>&rsquo;.
</p><h3><a name="FOOT34" href="#DOCF34">(34)</a></h3>
<p>called
&lsquo;<tt>.metadata</tt>&rsquo;.
</p><h3><a name="FOOT35" href="#DOCF35">(35)</a></h3>
<p>and to
avoid problems with case-insensitive file systems, lower-case versions
of all these extensions.
</p><h3><a name="FOOT36" href="#DOCF36">(36)</a></h3>
<p>unless inhibited by using
&lsquo;<samp>BuildVignettes: no</samp>&rsquo; in the &lsquo;<tt>DESCRIPTION</tt>&rsquo; file.
</p><h3><a name="FOOT37" href="#DOCF37">(37)</a></h3>
<p>provided the conditions of the package&rsquo;s licence are
met: many would see these as incompatible with an Open Source licence.
</p><h3><a name="FOOT38" href="#DOCF38">(38)</a></h3>
<p><code>R_HOME/bin</code> is prepended to the
<code>PATH</code> so that references to <code>R</code> or <code>Rscript</code> in the
&lsquo;<tt>Makefile</tt>&rsquo; do make use of the currently running version of R.
</p><h3><a name="FOOT39" href="#DOCF39">(39)</a></h3>
<p>provided the encoding is known: currently if it is
not, it is guessed to be Latin-1.
</p><h3><a name="FOOT40" href="#DOCF40">(40)</a></h3>
<p>provided a
POSIX-compliant <code>du</code> program is found on the system: it is
possible that some other <code>du</code> programs will incorrectly report
double the actual size.  This can be disabled by setting
<code>_R_CHECK_PKG_SIZE_</code> to a false value.
</p><h3><a name="FOOT41" href="#DOCF41">(41)</a></h3>
<p>for Windows users the simplest way may be to open
that URL in Internet Explorer and (depending on the version) follow the
instructions to view it as a folder, then copy the submission to the
folder.
</p><h3><a name="FOOT42" href="#DOCF42">(42)</a></h3>
<p>if their license allows:
this often requires also including the corresponding &lsquo;<tt>.dtx</tt>&rsquo;
file.
</p><h3><a name="FOOT43" href="#DOCF43">(43)</a></h3>
<p>Select
&lsquo;Save as&rsquo;, and select &lsquo;Reduce file size&rsquo; from the &lsquo;Quartz filter&rsquo; menu&rsquo;:
this can be accessed in other ways, for example by Automator.
</p><h3><a name="FOOT44" href="#DOCF44">(44)</a></h3>
<p>they will be called
with two unnamed arguments, in that order.
</p><h3><a name="FOOT45" href="#DOCF45">(45)</a></h3>
<p>NB: this will only be read in all versions of R if
the package contains R code in a &lsquo;<tt>R</tt>&rsquo; directory.
</p><h3><a name="FOOT46" href="#DOCF46">(46)</a></h3>
<p>Note that this is the
basename of the shared object, and the appropriate extension (&lsquo;<tt>.so</tt>&rsquo;
or &lsquo;<tt>.dll</tt>&rsquo;) will be added.
</p><h3><a name="FOOT47" href="#DOCF47">(47)</a></h3>
<p>This defaults to the same
pattern as <code>exportPattern</code>: use something like
<code>exportClassPattern(&quot;^$&quot;)</code> to override this.
</p><h3><a name="FOOT48" href="#DOCF48">(48)</a></h3>
<p>GNU make,
BSD make as in FreeBSD and <code>bsdmake</code> on Darwin, AT&amp;T make as
implemented on Solaris.
</p><h3><a name="FOOT49" href="#DOCF49">(49)</a></h3>
<p>but
note that <code>long long</code> is not a standard C++ type, and C++ compilers
set up for strict checking will reject it.
</p><h3><a name="FOOT50" href="#DOCF50">(50)</a></h3>
<p>Typically on a Unix-alike this is done by telling
<code>fontconfig</code> where to find suitable fonts to select glyphs
from.
</p><h3><a name="FOOT51" href="#DOCF51">(51)</a></h3>
<p>e.g. <code>\alias</code>, <code>\keyword</code> and
<code>\note</code> sections.
</p><h3><a name="FOOT52" href="#DOCF52">(52)</a></h3>
<p>There can be exceptions: for example
&lsquo;<tt>Rd</tt>&rsquo; files are not allowed to start with a dot, and have to be
uniquely named on a case-insensitive file system.
</p><h3><a name="FOOT53" href="#DOCF53">(53)</a></h3>
<p>in the current locale, and with special
treatment for LaTeX special characters and with any
&lsquo;<samp><var>pkgname</var>-package</samp>&rsquo; topic moved to the top of the list.
</p><h3><a name="FOOT54" href="#DOCF54">(54)</a></h3>
<p>Text between or after list items was discarded prior to
R 2.10.0, and is discouraged.
</p><h3><a name="FOOT55" href="#DOCF55">(55)</a></h3>
<p>Currently it is
rendered differently only in HTML conversions, and LaTeX conversion
outside &lsquo;<samp>\usage</samp>&rsquo; and &lsquo;<samp>\examples</samp>&rsquo; environments.
</p><h3><a name="FOOT56" href="#DOCF56">(56)</a></h3>
<p>a common
example in <acronym>CRAN</acronym> packages is <code>\link[mgcv]{gam}</code>.
</p><h3><a name="FOOT57" href="#DOCF57">(57)</a></h3>
<p>There is only a fine
distinction between <code>\dots</code> and <code>\ldots</code>.  It is technically
incorrect to use <code>\ldots</code> in code blocks and <code>tools::checkRd</code>
will warn about this&mdash;on the other hand the current converters treat
them the same way in code blocks, and elsewhere apart from the small
distinction between the two in LaTeX.
</p><h3><a name="FOOT58" href="#DOCF58">(58)</a></h3>
<p>See the
examples section in the file &lsquo;<tt>Paren.Rd</tt>&rsquo; for an example.
</p><h3><a name="FOOT59" href="#DOCF59">(59)</a></h3>
<p>R
2.9.0 added support for UTF-8 Cyrillic characters in LaTeX, but on
some OSes this will need Cyrillic support added to LaTeX, so
environment variable <code>_R_CYRILLIC_TEX_</code> may need to be set to a
non-empty value to enable this.
</p><h3><a name="FOOT60" href="#DOCF60">(60)</a></h3>
<p>R
has to be built to enable this, but the option
&lsquo;<samp>--enable-R-profiling</samp>&rsquo; is the default.
</p><h3><a name="FOOT61" href="#DOCF61">(61)</a></h3>
<p>For Unix-alikes these are intervals of CPU
time, and for Windows of elapsed time.
</p><h3><a name="FOOT62" href="#DOCF62">(62)</a></h3>
<p>With the exceptions of the commands
listed below: an object of such a name can be printed <em>via</em> an
explicit call to <code>print</code>.
</p><h3><a name="FOOT63" href="#DOCF63">(63)</a></h3>
<p>For a long time the compilation
default was 10MB, but this was increased to 64MB for R 2.15.2.
</p><h3><a name="FOOT64" href="#DOCF64">(64)</a></h3>
<p>possibly after some platform-specific
translation, e.g. adding leading or trailing underscores.
</p><h3><a name="FOOT65" href="#DOCF65">(65)</a></h3>
<p>Note that this is then
not checked for over-runs by option <code>CBoundsCheck = TRUE</code>.
</p><h3><a name="FOOT66" href="#DOCF66">(66)</a></h3>
<p>but this is not currently done.
</p><h3><a name="FOOT67" href="#DOCF67">(67)</a></h3>
<p><code>dyld</code> on Mac
OS X, and <code>DYLD_LIBRARY_PATHS</code> below.
</p><h3><a name="FOOT68" href="#DOCF68">(68)</a></h3>
<p> see section <a href="#The-R-API">The R <acronym>API</acronym>: entry points for C code</a>:
note that these are not all part of the API.
</p><h3><a name="FOOT69" href="#DOCF69">(69)</a></h3>
<p>SEXP is an acronym for <em>S</em>imple
<em>EXP</em>ression, common in LISP-like language syntaxes.
</p><h3><a name="FOOT70" href="#DOCF70">(70)</a></h3>
<p>You can assign a <em>copy</em> of the object in the
environment frame <code>rho</code> using <code>defineVar(symbol,
duplicate(value), rho)</code>).
</p><h3><a name="FOOT71" href="#DOCF71">(71)</a></h3>
<p>see section <a href="#Character-encoding-issues">Character encoding issues</a> for why this
might not be what is required.
</p><h3><a name="FOOT72" href="#DOCF72">(72)</a></h3>
<p>This is only guaranteed to show the
current interface: it is liable to change.
</p><h3><a name="FOOT73" href="#DOCF73">(73)</a></h3>
<p>Known problems are redefining
<code>error</code>, <code>length</code>, <code>vector</code> and <code>warning</code>
</p><h3><a name="FOOT74" href="#DOCF74">(74)</a></h3>
<p><a href="http://en.wikipedia.org/wiki/Endianness">http://en.wikipedia.org/wiki/Endianness</a>.
</p><h3><a name="FOOT75" href="#DOCF75">(75)</a></h3>
<p>In the parlance of Mac OS
X this is a <em>dynamic</em> library, and is the normal way to build R
on that platform.
</p><h3><a name="FOOT76" href="#DOCF76">(76)</a></h3>
<p>but these
are not part of the automated test procedures and so little tested.
</p><h3><a name="FOOT77" href="#DOCF77">(77)</a></h3>
<p>at least on platforms where the values are
available, that is having <code>getrlimit</code> and on Linux or having
<code>sysctl</code> supporting <code>KERN_USRSTACK</code>, including FreeBSD and
Mac OS X.
</p><h3><a name="FOOT78" href="#DOCF78">(78)</a></h3>
<p>An
attempt to use only threads in the late 1990s failed to work correctly
under Windows 95, the predominant version of Windows at that time.
</p><hr size="1">
<a name="SEC_Contents"></a>
<table cellpadding="1" cellspacing="1" border="0">
<tr><td valign="middle" align="left">[<a href="#Top" title="Cover (top) of document">Top</a>]</td>
<td valign="middle" align="left">[<a href="#SEC_Contents" title="Table of contents">Contents</a>]</td>
<td valign="middle" align="left">[<a href="#Function-and-variable-index" title="Index">Index</a>]</td>
<td valign="middle" align="left">[<a href="#SEC_About" title="About (help)"> ? </a>]</td>
</tr></table>
<h1>Table of Contents</h1>
<div class="contents">

<ul class="toc">
  <li><a name="toc-Acknowledgements-1" href="#Acknowledgements">Acknowledgements</a></li>
  <li><a name="toc-Creating-R-packages-1" href="#Creating-R-packages">1. Creating R packages</a>
  <ul class="toc">
    <li><a name="toc-Package-structure-1" href="#Package-structure">1.1 Package structure</a>
    <ul class="toc">
      <li><a name="toc-The-DESCRIPTION-file-1" href="#The-DESCRIPTION-file">1.1.1 The &lsquo;<tt>DESCRIPTION</tt>&rsquo; file</a></li>
      <li><a name="toc-The-INDEX-file-1" href="#The-INDEX-file">1.1.2 The &lsquo;<tt>INDEX</tt>&rsquo; file</a></li>
      <li><a name="toc-Package-subdirectories-1" href="#Package-subdirectories">1.1.3 Package subdirectories</a></li>
      <li><a name="toc-Package-bundles-1" href="#Package-bundles">1.1.4 Package bundles</a></li>
      <li><a name="toc-Data-in-packages-1" href="#Data-in-packages">1.1.5 Data in packages</a></li>
      <li><a name="toc-Non_002dR-scripts-in-packages-1" href="#Non_002dR-scripts-in-packages">1.1.6 Non-R scripts in packages</a></li>
    </ul></li>
    <li><a name="toc-Configure-and-cleanup-1" href="#Configure-and-cleanup">1.2 Configure and cleanup</a>
    <ul class="toc">
      <li><a name="toc-Using-Makevars-1" href="#Using-Makevars">1.2.1 Using &lsquo;<tt>Makevars</tt>&rsquo;</a>
      <ul class="toc">
        <li><a name="toc-OpenMP-support-1" href="#OpenMP-support">1.2.1.1 OpenMP support</a></li>
        <li><a name="toc-Using-pthreads-1" href="#Using-pthreads">1.2.1.2 Using pthreads</a></li>
        <li><a name="toc-Compiling-in-sub_002ddirectories-1" href="#Compiling-in-sub_002ddirectories">1.2.1.3 Compiling in sub-directories</a></li>
      </ul></li>
      <li><a name="toc-Configure-example-1" href="#Configure-example">1.2.2 Configure example</a></li>
      <li><a name="toc-Using-F95-code-1" href="#Using-F95-code">1.2.3 Using F95 code</a></li>
    </ul></li>
    <li><a name="toc-Checking-and-building-packages-1" href="#Checking-and-building-packages">1.3 Checking and building packages</a>
    <ul class="toc">
      <li><a name="toc-Checking-packages-1" href="#Checking-packages">1.3.1 Checking packages</a></li>
      <li><a name="toc-Building-package-tarballs-1" href="#Building-package-tarballs">1.3.2 Building package tarballs</a></li>
      <li><a name="toc-Building-binary-packages-1" href="#Building-binary-packages">1.3.3 Building binary packages</a></li>
    </ul></li>
    <li><a name="toc-Writing-package-vignettes-1" href="#Writing-package-vignettes">1.4 Writing package vignettes</a>
    <ul class="toc">
      <li><a name="toc-Encodings-and-vignettes-1" href="#Encodings-and-vignettes">1.4.1 Encodings and vignettes</a></li>
      <li><a name="toc-Non_002dSweave-vignettes-1" href="#Non_002dSweave-vignettes">1.4.2 Non-Sweave vignettes</a></li>
    </ul></li>
    <li><a name="toc-Submitting-a-package-to-CRAN-1" href="#Submitting-a-package-to-CRAN">1.5 Submitting a package to <acronym>CRAN</acronym></a>
    <ul class="toc">
      <li><a name="toc-PDF-size-1" href="#PDF-size">1.5.1 PDF size</a></li>
      <li><a name="toc-Package-timing-1" href="#Package-timing">1.5.2 Package timing</a></li>
      <li><a name="toc-Windows-external-software-1" href="#Windows-external-software">1.5.3 Windows external software</a></li>
    </ul></li>
    <li><a name="toc-Package-namespaces-1" href="#Package-namespaces">1.6 Package namespaces</a>
    <ul class="toc">
      <li><a name="toc-Specifying-imports-and-exports-1" href="#Specifying-imports-and-exports">1.6.1 Specifying imports and exports</a></li>
      <li><a name="toc-Registering-S3-methods-1" href="#Registering-S3-methods">1.6.2 Registering S3 methods</a></li>
      <li><a name="toc-Load-hooks-1" href="#Load-hooks">1.6.3 Load hooks</a></li>
      <li><a name="toc-useDynLib-1" href="#useDynLib">1.6.4 useDynLib</a></li>
      <li><a name="toc-An-example-2" href="#An-example">1.6.5 An example</a></li>
      <li><a name="toc-Namespaces-with-S4-classes-and-methods-1" href="#Namespaces-with-S4-classes-and-methods">1.6.6 Namespaces with S4 classes and methods</a></li>
    </ul></li>
    <li><a name="toc-Writing-portable-packages-1" href="#Writing-portable-packages">1.7 Writing portable packages</a>
    <ul class="toc">
      <li><a name="toc-Encoding-issues-1" href="#Encoding-issues">1.7.1 Encoding issues</a></li>
      <li><a name="toc-Binary-distribution-1" href="#Binary-distribution">1.7.2 Binary distribution</a></li>
    </ul></li>
    <li><a name="toc-Diagnostic-messages-1" href="#Diagnostic-messages">1.8 Diagnostic messages</a></li>
    <li><a name="toc-Internationalization-1" href="#Internationalization">1.9 Internationalization</a>
    <ul class="toc">
      <li><a name="toc-C_002dlevel-messages-1" href="#C_002dlevel-messages">1.9.1 C-level messages</a></li>
      <li><a name="toc-R-messages-1" href="#R-messages">1.9.2 R messages</a></li>
      <li><a name="toc-Installing-translations-1" href="#Installing-translations">1.9.3 Installing translations</a></li>
      <li><a name="toc-Supporting-R-function-1" href="#Supporting-R-function">1.9.4 Supporting R function</a></li>
    </ul></li>
    <li><a name="toc-CITATION-files-1" href="#CITATION-files">1.10 CITATION files</a></li>
    <li><a name="toc-Package-types-1" href="#Package-types">1.11 Package types</a>
    <ul class="toc">
      <li><a name="toc-Frontend-1" href="#Frontend">1.11.1 Frontend</a></li>
    </ul></li>
    <li><a name="toc-Services-1" href="#Services">1.12 Services</a></li>
  </ul></li>
  <li><a name="toc-Writing-R-documentation-files-1" href="#Writing-R-documentation-files">2. Writing R documentation files</a>
  <ul class="toc">
    <li><a name="toc-Rd-format-1" href="#Rd-format">2.1 Rd format</a>
    <ul class="toc">
      <li><a name="toc-Documenting-functions-1" href="#Documenting-functions">2.1.1 Documenting functions</a></li>
      <li><a name="toc-Documenting-data-sets-1" href="#Documenting-data-sets">2.1.2 Documenting data sets</a></li>
      <li><a name="toc-Documenting-S4-classes-and-methods-1" href="#Documenting-S4-classes-and-methods">2.1.3 Documenting S4 classes and methods</a></li>
      <li><a name="toc-Documenting-packages-1" href="#Documenting-packages">2.1.4 Documenting packages</a></li>
    </ul></li>
    <li><a name="toc-Sectioning-1" href="#Sectioning">2.2 Sectioning</a></li>
    <li><a name="toc-Marking-text-1" href="#Marking-text">2.3 Marking text</a></li>
    <li><a name="toc-Lists-and-tables-1" href="#Lists-and-tables">2.4 Lists and tables</a></li>
    <li><a name="toc-Cross_002dreferences-1" href="#Cross_002dreferences">2.5 Cross-references</a></li>
    <li><a name="toc-Mathematics-1" href="#Mathematics">2.6 Mathematics</a></li>
    <li><a name="toc-Figures-1" href="#Figures">2.7 Figures</a></li>
    <li><a name="toc-Insertions-1" href="#Insertions">2.8 Insertions</a></li>
    <li><a name="toc-Indices-1" href="#Indices">2.9 Indices</a></li>
    <li><a name="toc-Platform_002dspecific-documentation" href="#Platform_002dspecific-sections">2.10 Platform-specific documentation</a></li>
    <li><a name="toc-Conditional-text-1" href="#Conditional-text">2.11 Conditional text</a></li>
    <li><a name="toc-Dynamic-pages-1" href="#Dynamic-pages">2.12 Dynamic pages</a></li>
    <li><a name="toc-User_002ddefined-macros-1" href="#User_002ddefined-macros">2.13 User-defined macros</a></li>
    <li><a name="toc-Encoding-1" href="#Encoding">2.14 Encoding</a></li>
    <li><a name="toc-Processing-Rd-format-1" href="#Processing-Rd-format">2.15 Processing Rd format</a></li>
    <li><a name="toc-Editing-Rd-files-1" href="#Editing-Rd-files">2.16 Editing Rd files</a></li>
  </ul></li>
  <li><a name="toc-Tidying-and-profiling-R-code-1" href="#Tidying-and-profiling-R-code">3. Tidying and profiling R code</a>
  <ul class="toc">
    <li><a name="toc-Tidying-R-code-1" href="#Tidying-R-code">3.1 Tidying R code</a></li>
    <li><a name="toc-Profiling-R-code-for-speed-1" href="#Profiling-R-code-for-speed">3.2 Profiling R code for speed</a></li>
    <li><a name="toc-Profiling-R-code-for-memory-use-1" href="#Profiling-R-code-for-memory-use">3.3 Profiling R code for memory use</a>
    <ul class="toc">
      <li><a name="toc-Memory-statistics-from-Rprof-1" href="#Memory-statistics-from-Rprof">3.3.1 Memory statistics from <code>Rprof</code></a></li>
      <li><a name="toc-Tracking-memory-allocations-1" href="#Tracking-memory-allocations">3.3.2 Tracking memory allocations</a></li>
      <li><a name="toc-Tracing-copies-of-an-object-1" href="#Tracing-copies-of-an-object">3.3.3 Tracing copies of an object</a></li>
    </ul></li>
    <li><a name="toc-Profiling-compiled-code-1" href="#Profiling-compiled-code">3.4 Profiling compiled code</a>
    <ul class="toc">
      <li><a name="toc-Linux-1" href="#Linux">3.4.1 Linux</a>
      <ul class="toc">
        <li><a name="toc-sprof" href="#sprof">3.4.1.1 sprof</a></li>
        <li><a name="toc-oprofile" href="#oprofile">3.4.1.2 oprofile</a></li>
      </ul></li>
      <li><a name="toc-Solaris-1" href="#Solaris">3.4.2 Solaris</a></li>
      <li><a name="toc-Mac-OS-X-1" href="#Mac-OS-X">3.4.3 Mac OS X</a></li>
    </ul>
</li>
  </ul></li>
  <li><a name="toc-Debugging-1" href="#Debugging">4. Debugging</a>
  <ul class="toc">
    <li><a name="toc-Browsing-1" href="#Browsing">4.1 Browsing</a></li>
    <li><a name="toc-Debugging-R-code-1" href="#Debugging-R-code">4.2 Debugging R code</a></li>
    <li><a name="toc-Using-gctorture-and-valgrind-1" href="#Using-gctorture-and-valgrind">4.3 Using gctorture and valgrind</a>
    <ul class="toc">
      <li><a name="toc-Using-gctorture-1" href="#Using-gctorture">4.3.1 Using gctorture</a></li>
      <li><a name="toc-Using-valgrind-1" href="#Using-valgrind">4.3.2 Using valgrind</a></li>
    </ul></li>
    <li><a name="toc-Debugging-compiled-code-1" href="#Debugging-compiled-code">4.4 Debugging compiled code</a>
    <ul class="toc">
      <li><a name="toc-Finding-entry-points-in-dynamically-loaded-code" href="#Finding-entry-points">4.4.1 Finding entry points in dynamically loaded code</a></li>
      <li><a name="toc-Inspecting-R-objects-when-debugging" href="#Inspecting-R-objects">4.4.2 Inspecting R objects when debugging</a></li>
    </ul>
</li>
  </ul></li>
  <li><a name="toc-System-and-foreign-language-interfaces-1" href="#System-and-foreign-language-interfaces">5. System and foreign language interfaces</a>
  <ul class="toc">
    <li><a name="toc-Operating-system-access-1" href="#Operating-system-access">5.1 Operating system access</a></li>
    <li><a name="toc-Interface-functions-_002eC-and-_002eFortran-1" href="#Interface-functions-_002eC-and-_002eFortran">5.2 Interface functions <code>.C</code> and <code>.Fortran</code></a></li>
    <li><a name="toc-dyn_002eload-and-dyn_002eunload-1" href="#dyn_002eload-and-dyn_002eunload">5.3 <code>dyn.load</code> and <code>dyn.unload</code></a></li>
    <li><a name="toc-Registering-native-routines-1" href="#Registering-native-routines">5.4 Registering native routines</a>
    <ul class="toc">
      <li><a name="toc-Speed-considerations-1" href="#Speed-considerations">5.4.1 Speed considerations</a></li>
      <li><a name="toc-Linking-to-native-routines-in-other-packages-1" href="#Linking-to-native-routines-in-other-packages">5.4.2 Linking to native routines in other packages</a></li>
    </ul></li>
    <li><a name="toc-Creating-shared-objects-1" href="#Creating-shared-objects">5.5 Creating shared objects</a></li>
    <li><a name="toc-Interfacing-C_002b_002b-code-1" href="#Interfacing-C_002b_002b-code">5.6 Interfacing C++ code</a></li>
    <li><a name="toc-Fortran-I_002fO-1" href="#Fortran-I_002fO">5.7 Fortran I/O</a></li>
    <li><a name="toc-Linking-to-other-packages-1" href="#Linking-to-other-packages">5.8 Linking to other packages</a>
    <ul class="toc">
      <li><a name="toc-Unix_002dalikes-1" href="#Unix_002dalikes">5.8.1 Unix-alikes</a></li>
      <li><a name="toc-Windows-1" href="#Windows">5.8.2 Windows</a></li>
    </ul></li>
    <li><a name="toc-Handling-R-objects-in-C-1" href="#Handling-R-objects-in-C">5.9 Handling R objects in C</a>
    <ul class="toc">
      <li><a name="toc-Handling-the-effects-of-garbage-collection" href="#Garbage-Collection">5.9.1 Handling the effects of garbage collection</a></li>
      <li><a name="toc-Allocating-storage-1" href="#Allocating-storage">5.9.2 Allocating storage</a></li>
      <li><a name="toc-Details-of-R-types-1" href="#Details-of-R-types">5.9.3 Details of R types</a></li>
      <li><a name="toc-Attributes-1" href="#Attributes">5.9.4 Attributes</a></li>
      <li><a name="toc-Classes-1" href="#Classes">5.9.5 Classes</a></li>
      <li><a name="toc-Handling-lists-1" href="#Handling-lists">5.9.6 Handling lists</a></li>
      <li><a name="toc-Handling-character-data-1" href="#Handling-character-data">5.9.7 Handling character data</a></li>
      <li><a name="toc-Finding-and-setting-variables-1" href="#Finding-and-setting-variables">5.9.8 Finding and setting variables</a></li>
      <li><a name="toc-Some-convenience-functions-1" href="#Some-convenience-functions">5.9.9 Some convenience functions</a>
      <ul class="toc">
        <li><a name="toc-Semi_002dinternal-convenience-functions-1" href="#Semi_002dinternal-convenience-functions">5.9.9.1 Semi-internal convenience functions</a></li>
      </ul></li>
      <li><a name="toc-Named-objects-and-copying-1" href="#Named-objects-and-copying">5.9.10 Named objects and copying</a></li>
    </ul></li>
    <li><a name="toc-Interface-functions-_002eCall-and-_002eExternal-1" href="#Interface-functions-_002eCall-and-_002eExternal">5.10 Interface functions <code>.Call</code> and <code>.External</code></a>
    <ul class="toc">
      <li><a name="toc-Calling-_002eCall-1" href="#Calling-_002eCall">5.10.1 Calling <code>.Call</code></a></li>
      <li><a name="toc-Calling-_002eExternal-1" href="#Calling-_002eExternal">5.10.2 Calling <code>.External</code></a></li>
      <li><a name="toc-Missing-and-special-values-1" href="#Missing-and-special-values">5.10.3 Missing and special values</a></li>
    </ul></li>
    <li><a name="toc-Evaluating-R-expressions-from-C-1" href="#Evaluating-R-expressions-from-C">5.11 Evaluating R expressions from C</a>
    <ul class="toc">
      <li><a name="toc-Zero_002dfinding-1" href="#Zero_002dfinding">5.11.1 Zero-finding</a></li>
      <li><a name="toc-Calculating-numerical-derivatives-1" href="#Calculating-numerical-derivatives">5.11.2 Calculating numerical derivatives</a></li>
    </ul></li>
    <li><a name="toc-Parsing-R-code-from-C-1" href="#Parsing-R-code-from-C">5.12 Parsing R code from C</a>
    <ul class="toc">
      <li><a name="toc-Accessing-source-references-1" href="#Accessing-source-references">5.12.1 Accessing source references</a></li>
    </ul></li>
    <li><a name="toc-External-pointers-and-weak-references-1" href="#External-pointers-and-weak-references">5.13 External pointers and weak references</a>
    <ul class="toc">
      <li><a name="toc-An-example-1" href="#An-external-pointer-example">5.13.1 An example</a></li>
    </ul></li>
    <li><a name="toc-Vector-accessor-functions-1" href="#Vector-accessor-functions">5.14 Vector accessor functions</a></li>
    <li><a name="toc-Character-encoding-issues-1" href="#Character-encoding-issues">5.15 Character encoding issues</a></li>
  </ul></li>
  <li><a name="toc-The-R-API_003a-entry-points-for-C-code" href="#The-R-API">6. The R <acronym>API</acronym>: entry points for C code</a>
  <ul class="toc">
    <li><a name="toc-Memory-allocation-1" href="#Memory-allocation">6.1 Memory allocation</a>
    <ul class="toc">
      <li><a name="toc-Transient-storage-allocation" href="#Transient">6.1.1 Transient storage allocation</a></li>
      <li><a name="toc-User_002dcontrolled-memory" href="#User_002dcontrolled">6.1.2 User-controlled memory</a></li>
    </ul></li>
    <li><a name="toc-Error-handling-1" href="#Error-handling">6.2 Error handling</a>
    <ul class="toc">
      <li><a name="toc-Error-handling-from-FORTRAN-1" href="#Error-handling-from-FORTRAN">6.2.1 Error handling from FORTRAN</a></li>
    </ul></li>
    <li><a name="toc-Random-number-generation" href="#Random-numbers">6.3 Random number generation</a></li>
    <li><a name="toc-Missing-and-IEEE-special-values" href="#Missing-and-IEEE-values">6.4 Missing and <acronym>IEEE</acronym> special values</a></li>
    <li><a name="toc-Printing-1" href="#Printing">6.5 Printing</a>
    <ul class="toc">
      <li><a name="toc-Printing-from-FORTRAN-1" href="#Printing-from-FORTRAN">6.5.1 Printing from FORTRAN</a></li>
    </ul></li>
    <li><a name="toc-Calling-C-from-FORTRAN-and-vice-versa-1" href="#Calling-C-from-FORTRAN-and-vice-versa">6.6 Calling C from FORTRAN and vice versa</a></li>
    <li><a name="toc-Numerical-analysis-subroutines-1" href="#Numerical-analysis-subroutines">6.7 Numerical analysis subroutines</a>
    <ul class="toc">
      <li><a name="toc-Distribution-functions-1" href="#Distribution-functions">6.7.1 Distribution functions</a></li>
      <li><a name="toc-Mathematical-functions-1" href="#Mathematical-functions">6.7.2 Mathematical functions</a></li>
      <li><a name="toc-Numerical-Utilities-1" href="#Numerical-Utilities">6.7.3 Numerical Utilities</a></li>
      <li><a name="toc-Mathematical-constants-1" href="#Mathematical-constants">6.7.4 Mathematical constants</a></li>
    </ul></li>
    <li><a name="toc-Optimization-1" href="#Optimization">6.8 Optimization</a></li>
    <li><a name="toc-Integration-1" href="#Integration">6.9 Integration</a></li>
    <li><a name="toc-Utility-functions-1" href="#Utility-functions">6.10 Utility functions</a></li>
    <li><a name="toc-Re_002dencoding-1" href="#Re_002dencoding">6.11 Re-encoding</a></li>
    <li><a name="toc-Allowing-interrupts-1" href="#Allowing-interrupts">6.12 Allowing interrupts</a></li>
    <li><a name="toc-Platform-and-version-information-1" href="#Platform-and-version-information">6.13 Platform and version information</a></li>
    <li><a name="toc-Inlining-C-functions-1" href="#Inlining-C-functions">6.14 Inlining C functions</a></li>
    <li><a name="toc-Controlling-visibility-1" href="#Controlling-visibility">6.15 Controlling visibility</a></li>
    <li><a name="toc-Using-these-functions-in-your-own-C-code" href="#Standalone-Mathlib">6.16 Using these functions in your own C code</a></li>
    <li><a name="toc-Organization-of-header-files-1" href="#Organization-of-header-files">6.17 Organization of header files</a></li>
  </ul></li>
  <li><a name="toc-Generic-functions-and-methods-1" href="#Generic-functions-and-methods">7. Generic functions and methods</a>
  <ul class="toc">
    <li><a name="toc-Adding-new-generics-1" href="#Adding-new-generics">7.1 Adding new generics</a></li>
  </ul></li>
  <li><a name="toc-Linking-GUIs-and-other-front_002dends-to-R-1" href="#Linking-GUIs-and-other-front_002dends-to-R">8. Linking GUIs and other front-ends to R</a>
  <ul class="toc">
    <li><a name="toc-Embedding-R-under-Unix_002dalikes-1" href="#Embedding-R-under-Unix_002dalikes">8.1 Embedding R under Unix-alikes</a>
    <ul class="toc">
      <li><a name="toc-Compiling-against-the-R-library-1" href="#Compiling-against-the-R-library">8.1.1 Compiling against the R library</a></li>
      <li><a name="toc-Setting-R-callbacks-1" href="#Setting-R-callbacks">8.1.2 Setting R callbacks</a></li>
      <li><a name="toc-Registering-symbols-1" href="#Registering-symbols">8.1.3 Registering symbols</a></li>
      <li><a name="toc-Meshing-event-loops-1" href="#Meshing-event-loops">8.1.4 Meshing event loops</a></li>
      <li><a name="toc-Threading-issues-1" href="#Threading-issues">8.1.5 Threading issues</a></li>
    </ul></li>
    <li><a name="toc-Embedding-R-under-Windows-1" href="#Embedding-R-under-Windows">8.2 Embedding R under Windows</a>
    <ul class="toc">
      <li><a name="toc-Using-_0028D_0029COM-1" href="#Using-_0028D_0029COM">8.2.1 Using (D)COM</a></li>
      <li><a name="toc-Calling-R_002edll-directly-1" href="#Calling-R_002edll-directly">8.2.2 Calling R.dll directly</a></li>
      <li><a name="toc-Finding-R_005fHOME-1" href="#Finding-R_005fHOME">8.2.3 Finding R_HOME</a></li>
    </ul>
</li>
  </ul></li>
  <li><a name="toc-Function-and-variable-index-1" href="#Function-and-variable-index">Function and variable index</a></li>
  <li><a name="toc-Concept-index-1" href="#Concept-index">Concept index</a></li>
</ul>
</div>
<hr size="1">
<a name="SEC_About"></a>
<table cellpadding="1" cellspacing="1" border="0">
<tr><td valign="middle" align="left">[<a href="#Top" title="Cover (top) of document">Top</a>]</td>
<td valign="middle" align="left">[<a href="#SEC_Contents" title="Table of contents">Contents</a>]</td>
<td valign="middle" align="left">[<a href="#Function-and-variable-index" title="Index">Index</a>]</td>
<td valign="middle" align="left">[<a href="#SEC_About" title="About (help)"> ? </a>]</td>
</tr></table>
<h1>About This Document</h1>
<p>
  This document was generated by <em>Chel Hee Lee</em> on <em>November 24, 2013</em> using <a href="http://www.nongnu.org/texi2html/"><em>texi2html 1.82</em></a>.
</p>
<p>
  The buttons in the navigation panels have the following meaning:
</p>
<table border="1">
  <tr>
    <th> Button </th>
    <th> Name </th>
    <th> Go to </th>
    <th> From 1.2.3 go to</th>
  </tr>
  <tr>
    <td align="center"> [ &lt; ] </td>
    <td align="center">Back</td>
    <td>Previous section in reading order</td>
    <td>1.2.2</td>
  </tr>
  <tr>
    <td align="center"> [ &gt; ] </td>
    <td align="center">Forward</td>
    <td>Next section in reading order</td>
    <td>1.2.4</td>
  </tr>
  <tr>
    <td align="center"> [ &lt;&lt; ] </td>
    <td align="center">FastBack</td>
    <td>Beginning of this chapter or previous chapter</td>
    <td>1</td>
  </tr>
  <tr>
    <td align="center"> [ Up ] </td>
    <td align="center">Up</td>
    <td>Up section</td>
    <td>1.2</td>
  </tr>
  <tr>
    <td align="center"> [ &gt;&gt; ] </td>
    <td align="center">FastForward</td>
    <td>Next chapter</td>
    <td>2</td>
  </tr>
  <tr>
    <td align="center"> [Top] </td>
    <td align="center">Top</td>
    <td>Cover (top) of document</td>
    <td> &nbsp; </td>
  </tr>
  <tr>
    <td align="center"> [Contents] </td>
    <td align="center">Contents</td>
    <td>Table of contents</td>
    <td> &nbsp; </td>
  </tr>
  <tr>
    <td align="center"> [Index] </td>
    <td align="center">Index</td>
    <td>Index</td>
    <td> &nbsp; </td>
  </tr>
  <tr>
    <td align="center"> [ ? ] </td>
    <td align="center">About</td>
    <td>About (help)</td>
    <td> &nbsp; </td>
  </tr>
</table>

<p>
  where the <strong> Example </strong> assumes that the current position is at <strong> Subsubsection One-Two-Three </strong> of a document of the following structure:
</p>

<ul>
  <li> 1. Section One
    <ul>
      <li>1.1 Subsection One-One
        <ul>
          <li>...</li>
        </ul>
      </li>
      <li>1.2 Subsection One-Two
        <ul>
          <li>1.2.1 Subsubsection One-Two-One</li>
          <li>1.2.2 Subsubsection One-Two-Two</li>
          <li>1.2.3 Subsubsection One-Two-Three &nbsp; &nbsp;
            <strong>&lt;== Current Position </strong></li>
          <li>1.2.4 Subsubsection One-Two-Four</li>
        </ul>
      </li>
      <li>1.3 Subsection One-Three
        <ul>
          <li>...</li>
        </ul>
      </li>
      <li>1.4 Subsection One-Four</li>
    </ul>
  </li>
</ul>

<hr size="1">
<p>
 <font size="-1">
  This document was generated by <em>Chel Hee Lee</em> on <em>November 24, 2013</em> using <a href="http://www.nongnu.org/texi2html/"><em>texi2html 1.82</em></a>.
 </font>
 <br>

</p>
</body>
</html>
